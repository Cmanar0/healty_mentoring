{% extends "dashboard_user/base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_title %}{{ project.title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Layout Grid */
    .roadmap-container {
        display: grid;
        grid-template-columns: 1fr 340px;
        grid-template-areas:
            "top-nav meta-card"
            "main backlog";
        gap: 32px;
        align-items: start;
    }
    
    .roadmap-container .top-nav {
        grid-area: top-nav;
    }
    
    .roadmap-container > main {
        grid-area: main;
        position: relative;
    }
    
    .project-sidebar {
        grid-area: meta-card;
        position: relative;
    }
    
    .project-sidebar-backlog {
        grid-area: backlog;
        position: sticky;
        top: 24px;
        max-height: calc(100vh - 130px);
        display: flex;
        flex-direction: column;
    }
    
    .project-sidebar-backlog .client-backlog-card {
        display: flex;
        flex-direction: column;
        max-height: 100%;
        overflow: hidden;
    }
    
    .project-sidebar-backlog #userActiveBacklogList {
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }
    
    /* Minimalistic scrollbar for backlog list */
    .project-sidebar-backlog #userActiveBacklogList::-webkit-scrollbar {
        width: 6px;
    }
    
    .project-sidebar-backlog #userActiveBacklogList::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .project-sidebar-backlog #userActiveBacklogList::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
    
    .project-sidebar-backlog #userActiveBacklogList::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0, 0, 0, 0.3);
    }
    
    /* Firefox scrollbar */
    .project-sidebar-backlog #userActiveBacklogList {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    @media (max-width: 1024px) {
        .roadmap-container {
            grid-template-columns: 1fr;
            grid-template-areas:
                "top-nav"
                "meta-card"
                "main"
                "backlog";
        }
    }

    .project-sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .project-meta-card {
        background: #1e293b;
        color: white;
        border-radius: 12px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
    }
    
    .meta-bg-icon {
        position: absolute;
        bottom: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.05;
        transform: rotate(-15deg);
    }

    .project-title-lg {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .project-owner-row {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 12px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
    }

    .project-owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
    }

    .project-owner-info {
        flex: 1;
        min-width: 0;
    }

    .project-owner-label {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-bottom: 2px;
    }

    .project-owner-name {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .nav-btn-back {
  display: inline-flex;
  align-items: center;
  gap: 8px;
        color: #64748b;
  text-decoration: none;
        font-weight: 500;
  transition: color 0.2s;
}
    .nav-btn-back:hover { color: #1e293b; }

    /* Document Card Styles */
    .document-card {
        min-height: 248px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        margin-bottom: 24px;
    }

    .doc-header {
        padding: 40px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
    }
    
    .doc-header-left {
        flex: 1;
  display: flex;
  flex-direction: column;
        gap: 40px;
    }
    
    .doc-header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 16px;
    }
    
    .project-info-row {
  display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: flex-start;
    }
    
    .project-info-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .project-info-item .project-info-btn {
        width: auto;
    }
    
    .project-info-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-left: 4px;
    }
    
    .project-info-btn,
    .project-info-link {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
  font-weight: 600;
        color: #111827;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        height: 42px;
        box-sizing: border-box;
    }
    
    .project-info-btn:hover,
    .project-info-link:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        color: #111827;
    }

    .project-info-btn:active,
    .project-info-link:active {
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }
    
    .project-info-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #f1f5f9;
  display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        color: #475569;
        flex-shrink: 0;
        border: 1px solid #e2e8f0;
    }
    
    .project-info-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .project-info-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .project-info-status.completed {
        color: #15803d;
    }
    
    .project-info-status.pending {
        color: #92400e;
    }

    .project-info-btn.target-date-warning {
        background: #fef3c7;
        border-color: #fbbf24;
        width: auto;
        color: #92400e;
    }

    .project-info-btn.target-date-warning:hover {
        background: #fde68a;
        border-color: #f59e0b;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        color: #78350f;
    }

    .project-info-btn.target-date-warning span {
        color: #92400e;
    }

    .project-info-btn.target-date-warning:hover span {
        color: #78350f;
    }

    .project-info-btn.questionnaire-completed {
        background: #dcfce7;
        border-color: #86efac;
        color: #15803d;
    }

    .project-info-btn.questionnaire-completed:hover {
        background: #bbf7d0;
        border-color: #4ade80;
    }

    .project-info-btn.questionnaire-completed .project-info-status {
        color: #15803d;
    }

    .project-info-btn.questionnaire-completed i.fa-edit {
        color: #15803d;
    }

    .doc-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #111827;
        line-height: 1.1;
        margin-bottom: 0;
        letter-spacing: -0.03em;
        flex: 1;
    }

    .doc-body {
        padding: 40px;
        font-size: 1.1rem;
        line-height: 1.8;
  color: #374151;
    }
    
    .doc-body p {
        margin: 0;
    }

    /* Setup Required Card */
    .setup-required-card {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #fbbf24;
        border-radius: 16px;
        padding: 32px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 24px;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
    }

    .setup-required-icon {
        width: 64px;
        height: 64px;
        background: white;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #f59e0b;
        flex-shrink: 0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .setup-required-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .setup-required-content .btn-setup-questionnaire {
        align-self: flex-end;
        margin-top: 16px;
    }

    .setup-required-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #92400e;
        margin: 0 0 8px 0;
    }

    .setup-required-description {
        font-size: 1rem;
        color: #78350f;
        margin: 0 0 20px 0;
        line-height: 1.6;
    }

    .btn-setup-questionnaire {
  display: inline-flex;
  align-items: center;
  gap: 8px;
        background: #f59e0b;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        width: auto;
    }

    .btn-setup-questionnaire:hover {
        background: #d97706;
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
    }

    .btn-setup-questionnaire i {
        font-size: 0.875rem;
        transition: transform 0.2s ease;
    }

    .btn-setup-questionnaire:hover i {
        transform: translateX(2px);
    }

    /* Project Section Styles */
    .project-section {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        padding: 24px;
        margin-bottom: 24px;
    }

    .project-section h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
    }

    .project-placeholder {
        color: #9ca3af;
        font-style: italic;
        padding: 32px;
        text-align: center;
    }

    /* Questionnaire Completed Badge */
    .questionnaire-completed-badge {
  background: #d1fae5;
  color: #065f46;
  padding: 12px 16px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
        margin-top: 16px;
}

    .questionnaire-date {
  font-size: 0.875rem;
  opacity: 0.8;
  margin-left: 8px;
}

    /* Modules Grid */
    .modules-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

    .module-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s;
}

    .module-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #d1d5db;
}

    .module-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

    .module-header i {
  font-size: 1.25rem;
}

    .module-name {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

    .module-description {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.5;
}

    /* Stages List */
    .roadmap-list-section {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: visible;
    }

    .roadmap-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        border-radius: 12px 12px 0 0;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }

    .roadmap-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .roadmap-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    /* List Items (High Density) */
    .stage-row {
        display: flex;
        align-items: stretch;
        gap: 0;
        padding: 0;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.15s ease;
        position: relative;
        background: white;
    }

    .stage-row:last-child {
        border-bottom: none;
    }

    .stage-row:hover {
        background: #f8fafc;
    }
    
    /* Disabled stage styling */
    .stage-row-disabled {
        background: #f9fafb !important;
    }
    
    .stage-row-disabled:hover {
        background: #f3f4f6 !important;
    }
    
    .stage-row-disabled .stage-main-wrapper,
    .stage-row-disabled .stage-drag-section,
    .stage-row-disabled .stage-progress-section {
        opacity: 0.7;
    }
    
    /* Drag Grip Section */
    .stage-drag-section {
        padding: 16px 0px 16px 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: grab;
    }
    
    .stage-row:hover .stage-drag-section .drag-grip {
        opacity: 0.5;
        color: #94a3b8;
    }
    
    .stage-drag-section:active {
        cursor: grabbing;
    }

    .drag-grip {
        cursor: grab;
        color: #e5e7eb;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        opacity: 0;
        user-select: none;
        -webkit-user-select: none;
    }
    .drag-grip:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    .drag-grip:active {
        cursor: grabbing;
    }
    
    /* Stage Main Wrapper (clickable area for stage detail) */
    .stage-main-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
  cursor: pointer;
        transition: background 0.15s ease;
        min-width: 0;
    }
    
    .stage-main-wrapper:hover {
        background: rgba(248, 250, 252, 0.5);
    }
    
    /* Stage Info */
    .stage-main {
        flex: 1;
        min-width: 0;
    }

    .stage-title-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stage-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: #1f2937;
        display: flex;
  align-items: center;
  gap: 8px;
    }

    .stage-meta {
        font-size: 0.8rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Stage Progress Section */
    .stage-progress-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 180px;
        flex-shrink: 0;
    }

    .stage-progress-bar-container {
        width: 100%;
        max-width: 200px;
    }

    .stage-progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .stage-progress-bar {
        width: 100%;
        height: 8px;
        background: #f3f4f6;
        border-radius: 4px;
        overflow: hidden;
    }

    .stage-progress-fill {
        height: 100%;
        background: #10b981;
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .stage-tasks-count {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: #6b7280;
    }

    .stage-tasks-count.no-tasks {
        color: #93c5fd;
    }

    /* Status Indicators */
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    .status-dot.completed {
        background-color: #10b981;
        border: 1px solid #059669;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1);
    }

    .status-dot.pending {
        background-color: #3b82f6;
        border: 1px solid #2563eb;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .status-dot.overdue {
        background-color: #ef4444;
        border: 1px solid #dc2626;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.1);
    }

    .status-dot.created {
        background-color: #fbbf24;
        border: 1px solid #f59e0b;
        box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.1);
    }

    .stages-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 16px;
}

    .stage-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s;
}

    .stage-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

    .stage-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

    .stage-number {
  width: 32px;
  height: 32px;
  background: #10b981;
  color: #ffffff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}

    .stage-content {
  flex: 1;
  min-width: 0;
}

    .stage-title {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin: 0 0 8px 0;
}

    .stage-description {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.5;
}

    .stage-status {
  flex-shrink: 0;
}

    .stage-completed {
  color: #10b981;
  font-weight: 500;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

    .stage-pending {
  color: #f59e0b;
  font-weight: 500;
  font-size: 0.875rem;
}

    .btn-create-stage {
        background: #10b981;
        color: #ffffff;
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
    }

    .btn-create-stage:hover {
        background: #059669;
    }

    /* Questionnaire Modal */
    .questionnaire-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(8px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        padding: 20px;
    }

    .questionnaire-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .questionnaire-modal-content {
        background: white;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
        transform: scale(0.95) translateY(20px);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .questionnaire-modal-overlay.active .questionnaire-modal-content {
        transform: scale(1) translateY(0);
    }

    .questionnaire-modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #f1f5f9;
        border: none;
        color: #64748b;
        font-size: 1.1rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
        z-index: 20;
    }

    .questionnaire-modal-close:hover {
        background: #e2e8f0;
        color: #1e293b;
        transform: rotate(90deg);
    }

    .questionnaire-modal-body {
        padding: 40px;
        overflow-y: auto;
        max-height: calc(100vh - 80px);
    }

    /* Remove card styling from slide questionnaire in modal */
    .questionnaire-modal-body .slide-questionnaire-container {
        background: transparent;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
        max-width: 100%;
        margin: 0;
    }

    @media (max-width: 768px) {
        .setup-required-card {
            flex-direction: column;
            text-align: center;
            padding: 24px;
        }

        .questionnaire-modal-content {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
        }

        .questionnaire-modal-body {
            padding: 24px;
        }
    }

    /* Project Settings Dropdown */
    .project-settings-dropdown-container {
        position: relative;
        z-index: 10;
    }
    
    .project-settings-dropdown-trigger {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 1px solid #e5e7eb;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .project-settings-dropdown-trigger:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #1f2937;
    }
    
    .project-settings-dropdown-trigger i {
        font-size: 1.1rem;
    }
    
    .project-settings-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        min-width: 180px;
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
    }
    
    .project-settings-dropdown-container.active .project-settings-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .project-settings-dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #1e293b;
        text-decoration: none;
        transition: background 0.2s ease;
        border: none;
        background: white;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
    }
    
    .project-settings-dropdown-item.first-item {
        border-radius: 12px 12px 0 0;
    }
    
    .project-settings-dropdown-item.last-item {
        border-radius: 0 0 12px 12px;
    }
    
    .project-settings-dropdown-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .project-settings-dropdown-item.delete-item:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .project-settings-dropdown-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 1.1rem;
        flex-shrink: 0;
    }
    
    .project-settings-dropdown-item:hover i {
        color: inherit;
    }

    /* Target Date Modal Styles */
    .target-date-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .target-date-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .target-date-modal-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 90%;
        min-width: 450px;
        min-height: 350px;
        max-height: 90vh;
        overflow: visible;
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        position: relative;
    }

    .target-date-modal-overlay.active .target-date-modal-container {
        transform: scale(1);
    }

    .target-date-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 0;
        position: relative;
    }

    .target-date-modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .target-date-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(15, 23, 42, 0.1);
        border: 1px solid rgba(15, 23, 42, 0.1);
        color: #64748b;
        font-size: 1rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .target-date-modal-close:hover {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .target-date-modal-body {
        padding: 24px;
        overflow-y: auto;
        overflow-x: visible;
        flex: 1;
        min-height: 200px;
        position: relative;
    }

    .target-date-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        position: relative;
        z-index: 1;
        border-radius: 0 0 16px 16px;
    }

    .target-date-modal-footer .btn-cancel {
        min-width: 100px;
        width: auto;
    }

    .target-date-modal-footer .btn-confirm {
        width: auto;
    }

    .target-date-modal-body .form-group {
        margin-bottom: 20px;
    }

    .target-date-modal-body .form-label {
        display: block;
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }

    .target-date-modal-body .form-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        color: #1e293b;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .target-date-modal-body .form-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .target-date-modal-footer .btn-cancel {
        background: white;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .target-date-modal-footer .btn-cancel:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
    }

    .target-date-modal-footer .btn-confirm {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .target-date-modal-footer .btn-confirm:hover {
        background: #059669;
    }

    .target-date-modal-footer .btn-confirm:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Supervisor Modal Styles */
    .supervisor-modal-content {
        padding: 24px;
    }

    .supervisor-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e2e8f0;
    }

    .supervisor-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .supervisor-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .supervisor-avatar-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #dbeafe;
        color: #1e40af;
        font-size: 2.5rem;
        font-weight: 700;
    }

    .supervisor-details {
        text-align: center;
    }

    .supervisor-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
    }

    .supervisor-email {
        color: #64748b;
        font-size: 0.9rem;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .supervisor-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
    }

    .btn-remove-supervisor {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        width: auto;
    }

    .btn-remove-supervisor:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }

    .btn-remove-supervisor:active {
        transform: translateY(0);
    }

    .btn-remove-supervisor:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .supervisor-view {
        width: 100%;
    }

    .supervisor-confirm-message {
        text-align: center;
        padding: 20px 0;
    }

    .confirm-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: #fef3c7;
        color: #f59e0b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto 16px;
    }

    .confirm-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 12px 0;
    }

    .confirm-text {
        color: #64748b;
        font-size: 0.9rem;
        margin: 0;
        line-height: 1.6;
    }

    .btn-cancel-confirm {
        background: white;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .btn-cancel-confirm:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
    }

    .btn-confirm-remove {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-confirm-remove:hover {
        background: #dc2626;
    }

    .mentor-select-item:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .mentor-select-item:active {
        transform: translateY(0);
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container" style="max-width: 1200px; margin: 0 auto;">
    <div class="roadmap-container">
        <!-- Top Nav -->
        <div class="top-nav" style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center;">
                <a href="{% url 'general:dashboard_user:projects_list' %}" class="nav-btn-back">
                    Projects
                </a>
                <span style="margin: 0 8px; color: #cbd5e1;">/</span>
                <span style="color: #1e293b; font-weight: 600;">{{ project.title }}</span>
            </div>
        </div>
        <!-- Main Content -->
        <main>
            <!-- Project Name, Description -->
            <div class="document-card">
                <div class="doc-header">
                    <div class="doc-header-left">
                        <h1 class="doc-title">{{ project.title }}</h1>
                        <div class="project-info-row">
                            <!-- Project Owner -->
                            {% if project.project_owner %}
                            <div class="project-info-item">
                                <div class="project-info-label">Project Owner</div>
                                <div class="project-info-btn" style="cursor: default;">
                                    {% if project.project_owner.profile_picture %}
                                        <img src="{{ project.project_owner.profile_picture.url }}" alt="{{ project.project_owner.first_name }}" class="project-info-avatar">
                                    {% else %}
                                        <div class="project-info-avatar" style="background: #dbeafe; color: #1e40af;">
                                            {{ project.project_owner.first_name|make_list|first|default:"U" }}
                                        </div>
                                    {% endif %}
                                    <span>{{ project.project_owner.first_name }} {{ project.project_owner.last_name }}</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Project Supervisor -->
                            <div class="project-info-item">
                                <div class="project-info-label">Project Supervisor</div>
                                {% if is_owner %}
                                    {% if project.supervised_by %}
                                    <button type="button" onclick="openSupervisorModal()" class="project-info-btn">
                                        {% if project.supervised_by.profile_picture %}
                                            <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}" class="project-info-avatar">
                                        {% else %}
                                            <div class="project-info-avatar" style="background: #dbeafe; color: #1e40af;">
                                                {{ project.supervised_by.first_name|make_list|first|default:"M" }}
                                            </div>
                                        {% endif %}
                                        <span>{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</span>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% else %}
                                    <button type="button" onclick="openSupervisorModal()" class="project-info-btn" style="background: #fff1f2; border-color: #fecaca; color: #e11d48;">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Unassigned</span>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    {% endif %}
                                {% else %}
                                    {% if project.supervised_by %}
                                    <div class="project-info-btn" style="cursor: default;">
                                        {% if project.supervised_by.profile_picture %}
                                            <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}" class="project-info-avatar">
                                        {% else %}
                                            <div class="project-info-avatar" style="background: #dbeafe; color: #1e40af;">
                                                {{ project.supervised_by.first_name|make_list|first|default:"M" }}
                                            </div>
                                        {% endif %}
                                        <span>{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</span>
                                    </div>
                                    {% else %}
                                    <div class="project-info-btn" style="cursor: default;">
                                        <span style="color: #94a3b8; font-style: italic;">Not assigned</span>
                                    </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <!-- Project Definition -->
                            <div class="project-info-item">
                                <div class="project-info-label">Project Definition</div>
                                <button type="button" onclick="window.openQuestionnaireModal()" class="project-info-btn {% if project.questionnaire_completed %}questionnaire-completed{% else %}target-date-warning{% endif %}">
                                    {% if project.questionnaire_completed %}
                                        <span class="project-info-status completed">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                    {% else %}
                                        <span class="project-info-status pending">
                                            <i class="fas fa-exclamation-triangle"></i> Pending
                                        </span>
                                    {% endif %}
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            
                            <!-- Target Completion Date -->
                            <div class="project-info-item">
                                <div class="project-info-label">Target Date</div>
                                <button type="button" onclick="openTargetDateModal()" class="project-info-btn {% if not project.target_completion_date %}target-date-warning{% endif %}">
                                    {% if project.target_completion_date %}
                                        <i class="far fa-calendar-check" style="color: #6366f1;"></i>
                                        <span>{{ project.target_completion_date|date:"M j, Y" }}</span>
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle" style="color: #92400e;"></i>
                                        <span style="color: #92400e;">Not set</span>
                                    {% endif %}
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {% if is_owner %}
                    <div class="doc-header-right">
                        <div class="project-settings-dropdown-container" id="projectSettingsDropdown">
                            <button class="project-settings-dropdown-trigger" onclick="toggleProjectSettingsDropdown(event)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="project-settings-dropdown-menu" onclick="event.stopPropagation();">
                                <button class="project-settings-dropdown-item first-item" onclick="openProjectSettingsModal(); event.stopPropagation();">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit</span>
                                </button>
                                <button class="project-settings-dropdown-item delete-item last-item" onclick="deleteProject(); event.stopPropagation();">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete Project</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="doc-body">
                    {% if project.description %}
                        {{ project.description|linebreaks }}
                    {% else %}
                        <div style="text-align: center; color: #9ca3af; padding: 20px; font-style: italic;">
                            No description provided.
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if not project.questionnaire_completed %}
                <!-- Modern Setup Required Card -->
                <div class="setup-required-card">
                    <div class="setup-required-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setup-required-content">
                        <h3 class="setup-required-title">Setup Required</h3>
                        <p class="setup-required-description">Complete the project questionnaire to unlock stage management and full project features.</p>
                        <button type="button" class="btn-setup-questionnaire" onclick="window.openQuestionnaireModal()">
                            <i class="fas fa-arrow-right"></i>
                            <span>Start Questionnaire</span>
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Questionnaire Modal -->
            <div id="questionnaireModal" class="questionnaire-modal-overlay" style="display: none;">
                <div class="questionnaire-modal-content">
                    <button class="questionnaire-modal-close" onclick="window.closeQuestionnaireModal()" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="questionnaire-modal-body">
                        {% include "general/reusable/slide_questionnaire.html" with questions=questions answers=answers %}
                    </div>
                </div>
            </div>


            <!-- Waterfall Chart -->
            <div id="waterfallChartContainer" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0 0 20px 0;">
                    <i class="fas fa-chart-line" style="color: #10b981; margin-right: 8px;"></i>
                    Project Timeline
                </h3>
                <div id="waterfallChart" style="min-height: 200px; position: relative;">
                    <!-- Chart will be rendered here by JavaScript -->
                </div>
            </div>

            <div class="roadmap-list-section">
                <div class="roadmap-header">
                    <h2>
                        <i class="fas fa-layer-group" style="color: #9ca3af; font-size: 1rem;"></i>
                        Roadmap Stages
                        <span id="stagesCount" style="font-size: 0.8rem; color: #6b7280; font-weight: 500; margin-left: 8px;">
                            0 Stages
                        </span>
                    </h2>
                    <div class="roadmap-header-actions">
                        {% if is_supervisor %}
                        <button onclick="openCreateStageModal()" class="fab-create">
                            <i class="fas fa-plus"></i> New Stage
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <div id="stagesList">
                    <div style="padding: 48px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>Loading stages...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Info -->
        <aside class="project-sidebar">
            <div class="project-meta-card">
                <!-- Project Completion Circle -->
                <div style="display: flex; flex-direction: column; align-items: center; padding-top: 24px;">
                    <div class="profile-completion-circle" style="position: relative; width: 140px; height: 140px;">
                        <svg width="140" height="140" viewBox="0 0 120 120" style="transform: scale(1.17);">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="rgba(255,255,255,0.2)"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="projectProgressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#ffffff"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: #ffffff; font-size: 1.3rem;">
                            <span id="projectCompletionText">0%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.8); text-align: center;">
                        Completed
                    </p>
                </div>
                
                <div style="position: relative; z-index: 2; width: 100%;">
                    <!-- Modules Section -->
                    {% if active_modules %}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7;">Modules</div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            {% for module_instance in active_modules %}
                                <a href="{% url 'general:dashboard_user:module_detail' project.id module_instance.id %}" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; color: white; transition: all 0.2s; min-height: 48px;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                    {% if module_instance.module.icon %}
                                        <i class="{{ module_instance.module.icon }}" style="font-size: 1.1rem; flex-shrink: 0;"></i>
                                    {% endif %}
                                    <span style="font-size: 0.9rem; font-weight: 500; line-height: 1.4;">{{ module_instance.module.name }}</span>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7;">Modules</div>
                        </div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; font-style: italic; padding: 12px 0;">
                            No modules added yet
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </aside>
        
        <!-- User Active Backlog Card -->
        {% if project.project_owner and is_owner %}
        <aside class="project-sidebar-backlog">
            <div id="userActiveBacklogCard" class="client-backlog-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; padding: 20px 20px 0 20px;">
                    <h3 id="userBacklogTitle" style="font-size: 0.9rem; font-weight: 600; color: #111827; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clipboard-list" style="color: #10b981;"></i>
                        Your Active Backlog
                    </h3>
                    <a href="{% url 'general:dashboard_user:active_backlog' %}" style="font-size: 0.75rem; color: #10b981; text-decoration: none; font-weight: 500;">
                        View All
                    </a>
                </div>
                <div id="userActiveBacklogList" style="display: flex; flex-direction: column; gap: 0; flex: 1; min-height: 0; padding: 0 0 20px 0;">
                    <div style="padding: 16px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 0.85rem;">Loading...</p>
                    </div>
                </div>
            </div>
        </aside>
        {% endif %}
    </div>
</div>

<!-- Target Date Modal -->
<div id="targetDateModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeTargetDateModal()" style="display: none;">
    <div class="target-date-modal-container">
        <div class="target-date-modal-header">
            <h3 id="targetDateModalTitle">Set Target Date</h3>
        </div>
        <button class="target-date-modal-close" onclick="closeTargetDateModal()">
            <i class="fas fa-times"></i>
        </button>
        <form id="targetDateForm" onsubmit="saveTargetDate(event)">
            <div class="target-date-modal-body">
                <div class="form-group">
                    <label class="form-label">Target Completion Date</label>
                    <input type="date" name="target_date" id="targetDateInput" class="form-input" value="{% if project.target_completion_date %}{{ project.target_completion_date|date:'Y-m-d' }}{% endif %}">
                </div>
            </div>
            <div class="target-date-modal-footer">
                <button type="button" class="btn-cancel" onclick="closeTargetDateModal()">Cancel</button>
                <button type="submit" class="btn-confirm" id="targetDateSubmitBtn">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Supervisor Modal -->
{% if is_owner %}
<div id="supervisorModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeSupervisorModal()" style="display: none;">
    <div class="target-date-modal-container">
        <div class="target-date-modal-header">
            <h3 id="supervisorModalTitle">Project Supervisor</h3>
        </div>
        <button class="target-date-modal-close" onclick="closeSupervisorModal()">
            <i class="fas fa-times"></i>
        </button>
        <div class="supervisor-modal-content">
            {% if project.supervised_by %}
            <!-- Normal View -->
            <div id="supervisorInfoView" class="supervisor-view">
                <div class="supervisor-info">
                    <div class="supervisor-avatar-large">
                        {% if project.supervised_by.profile_picture %}
                            <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}">
                        {% else %}
                            <div class="supervisor-avatar-placeholder">
                                {{ project.supervised_by.first_name|make_list|first|default:"M" }}{{ project.supervised_by.last_name|make_list|first|default:"" }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="supervisor-details">
                        <h4 class="supervisor-name">{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</h4>
                        {% if project.supervised_by.user.email %}
                            <p class="supervisor-email">
                                <i class="fas fa-envelope"></i> {{ project.supervised_by.user.email }}
                            </p>
                        {% endif %}
                    </div>
                </div>
                <div class="supervisor-actions">
                    <button type="button" class="btn-remove-supervisor" onclick="showRemoveConfirmation()">
                        <i class="fas fa-user-minus"></i> Remove Supervisor from this project
                    </button>
                </div>
            </div>
            
            <!-- Confirmation View -->
            <div id="supervisorConfirmView" class="supervisor-view" style="display: none;">
                <div class="supervisor-confirm-message">
                    <div class="confirm-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 class="confirm-title">Remove Supervisor?</h4>
                    <p class="confirm-text">Are you sure you want to remove {{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }} as the project supervisor? This action cannot be undone.</p>
                </div>
                <div class="supervisor-actions">
                    <button type="button" class="btn-cancel-confirm" onclick="hideRemoveConfirmation()">
                        Cancel
                    </button>
                    <button type="button" class="btn-confirm-remove" onclick="confirmRemoveSupervisor()">
                        <i class="fas fa-user-minus"></i> Confirm Removal
                    </button>
                </div>
            </div>
            {% else %}
            <!-- Select Mentor View -->
            <div id="supervisorSelectView" class="supervisor-view">
                <div style="margin-bottom: 20px;">
                    <p style="color: #64748b; font-size: 0.9rem; margin: 0 0 16px 0;">Select a mentor from your relationships to assign as project supervisor:</p>
                </div>
                {% if available_mentors %}
                <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                    {% for mentor in available_mentors %}
                    <button type="button" class="mentor-select-item" onclick="selectMentor({{ mentor.id }}, '{{ mentor.first_name }} {{ mentor.last_name }}')" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                        {% if mentor.profile_picture %}
                            <img src="{{ mentor.profile_picture.url }}" alt="{{ mentor.first_name }}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                        {% else %}
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: #dbeafe; color: #1e40af; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem;">
                                {{ mentor.first_name|make_list|first|default:"M" }}{{ mentor.last_name|make_list|first|default:"" }}
                            </div>
                        {% endif %}
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">{{ mentor.first_name }} {{ mentor.last_name }}</div>
                            {% if mentor.user.email %}
                            <div style="font-size: 0.85rem; color: #64748b;">{{ mentor.user.email }}</div>
                            {% endif %}
                        </div>
                        <i class="fas fa-chevron-right" style="color: #94a3b8;"></i>
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                    <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p style="margin: 0; font-size: 0.95rem;">You don't have any mentor relationships yet.</p>
                    <p style="margin: 8px 0 0; font-size: 0.85rem;">Connect with mentors to assign them as project supervisors.</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<script>
    // Calculate and set dynamic offset for main content
    function setMainContentOffset() {
        const metaCard = document.querySelector('.project-sidebar .project-meta-card');
        const mainContent = document.querySelector('.roadmap-container > main');
        
        if (metaCard && mainContent) {
            const metaCardHeight = metaCard.offsetHeight;
            const offset = -(metaCardHeight - 20);
            mainContent.style.top = offset + 'px';
        }
    }
    
document.addEventListener('DOMContentLoaded', function() {
    // Set submit URL for the slide questionnaire
    const form = document.getElementById('slideQuestionnaireForm');
  if (form) {
        form.dataset.submitUrl = '{% url "general:dashboard_user:submit_questionnaire" project.id %}';
    }

    // Questionnaire Modal Functions
    window.openQuestionnaireModal = function() {
        const modal = document.getElementById('questionnaireModal');
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    };

    window.closeQuestionnaireModal = function() {
        const modal = document.getElementById('questionnaireModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };

    // Close modal on overlay click
    const modal = document.getElementById('questionnaireModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeQuestionnaireModal();
            }
        });
    }

    window.openCreateStageModal = function() {
        const modal = document.getElementById('createStageModal');
        if(modal) { 
            modal.style.display = 'flex'; 
            setTimeout(()=>modal.classList.add('active'),10); 
        }
    };

    // Load user's active backlog
    function loadUserActiveBacklog() {
        {% if project.project_owner and is_owner %}
        const container = document.getElementById('userActiveBacklogList');
        
        if (!container) return;
        
        fetch('{% url "general:dashboard_user:get_user_active_backlog_api" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                renderUserActiveBacklog(data.tasks || [], data.total_count || 0);
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                        <p style="margin: 0;">Error loading tasks</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading active backlog:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0;">Error loading tasks</p>
                </div>
            `;
        });
        {% endif %}
    }
    
    // Render user active backlog tasks
    function renderUserActiveBacklog(tasks, totalCount) {
        const container = document.getElementById('userActiveBacklogList');
        if (!container) return;
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                    <i class="fas fa-clipboard-list" style="font-size: 1.5rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0;">No tasks yet</p>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column; gap: 0;">';
        tasks.forEach((task, index) => {
            const completedStyle = task.completed ? 'text-decoration: line-through; color: #94a3b8;' : 'color: #1f2937;';
            const borderStyle = index < tasks.length - 1 ? 'border-bottom: 1px solid #f3f4f6;' : '';
            const descriptionHtml = task.description ? `
                <div style="font-size: 0.75rem; color: #64748b; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${escapeHtml(task.description)}
                </div>
            ` : '';
            
            html += `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; transition: background 0.2s; ${borderStyle}" 
                     onmouseover="this.style.background='#f8fafc'" 
                     onmouseout="this.style.background='transparent'">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} disabled style="width: 16px; height: 16px; cursor: not-allowed; opacity: 0.6;">
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 0.85rem; font-weight: 500; ${completedStyle}">
                            ${escapeHtml(task.title)}
                        </div>
                        ${descriptionHtml}
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Render project completion progress circle
    function renderProjectProgress() {
        const progressCircle = document.getElementById('projectProgressCircle');
        const completionText = document.getElementById('projectCompletionText');
        
        if (!progressCircle || !completionText) return;
        
        const progress = {{ project_progress|default:0 }};
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (progress / 100) * circumference;
        
        // Set color based on percentage
        function getProgressColor(pct) {
            if (pct >= 90) return '#059669'; // Dark green
            if (pct >= 70) return '#10b981'; // Green
            if (pct >= 40) return '#f59e0b'; // Orange
            return '#ef4444'; // Red
        }
        
        const color = getProgressColor(progress);
        progressCircle.style.stroke = color;
        completionText.textContent = progress + '%';
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }

    // Initialize on page load
    loadUserActiveBacklog();
    renderProjectProgress();
    
    // Set offset after a short delay to ensure meta card is rendered
    setTimeout(setMainContentOffset, 100);
    
    // Load stages if questionnaire is completed
    {% if project.questionnaire_completed %}
    const PROJECT_ID = parseInt('{{ project.id }}');
    const STAGE_DETAIL_URL = '{% url "general:dashboard_user:stage_detail" project.id 0 %}'.replace('/0/', '/');
    {% if project.target_completion_date %}
    const TARGET_COMPLETION_DATE = '{{ project.target_completion_date|date:"Y-m-d" }}';
    {% else %}
    const TARGET_COMPLETION_DATE = null;
    {% endif %}
    
    loadStages();
    {% endif %}
    
    // Recalculate offset on window resize
    window.addEventListener('resize', function() {
        setTimeout(setMainContentOffset, 100);
    });

    // Target Date Modal Functions
    window.openTargetDateModal = function() {
        const modal = document.getElementById('targetDateModal');
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    };

    window.closeTargetDateModal = function() {
        const modal = document.getElementById('targetDateModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };

    window.saveTargetDate = function(event) {
        event.preventDefault();
        
        const targetDate = document.getElementById('targetDateInput').value;
        const submitBtn = document.getElementById('targetDateSubmitBtn');
        const originalText = submitBtn.textContent;
        
      submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        fetch('{% url "general:dashboard_user:project_detail" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'update_target_date',
                target_date: targetDate || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeTargetDateModal();
                if (typeof showNotification !== 'undefined') {
                    showNotification('Target date updated successfully', 'success');
                }
                // Reload page to show updated date
                location.reload();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update target date', 'error');
                } else {
                    alert(data.error || 'Failed to update target date');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while updating target date', 'error');
            } else {
                alert('An error occurred while updating target date');
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    };

    // Supervisor Modal Functions
    window.openSupervisorModal = function() {
        const modal = document.getElementById('supervisorModal');
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    };

    window.closeSupervisorModal = function() {
        const modal = document.getElementById('supervisorModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };

    window.showRemoveConfirmation = function() {
        const infoView = document.getElementById('supervisorInfoView');
        const confirmView = document.getElementById('supervisorConfirmView');
        if (infoView && confirmView) {
            infoView.style.display = 'none';
            confirmView.style.display = 'block';
        }
    };

    window.hideRemoveConfirmation = function() {
        const infoView = document.getElementById('supervisorInfoView');
        const confirmView = document.getElementById('supervisorConfirmView');
        if (infoView && confirmView) {
            infoView.style.display = 'block';
            confirmView.style.display = 'none';
        }
    };

    window.confirmRemoveSupervisor = function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        fetch('{% url "general:dashboard_user:project_detail" project.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'remove_supervisor'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (typeof showNotification !== 'undefined') {
                    showNotification('Supervisor removed successfully', 'success');
                }
                // Reload page to show updated state
                location.reload();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to remove supervisor', 'error');
                } else {
                    alert(data.error || 'Failed to remove supervisor');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while removing supervisor', 'error');
            } else {
                alert('An error occurred while removing supervisor');
            }
        });
    };

    // Toggle project settings dropdown
    window.toggleProjectSettingsDropdown = function(event) {
        event.stopPropagation();
        const container = document.getElementById('projectSettingsDropdown');
        if (!container) return;
        
        const isActive = container.classList.contains('active');
        
        // Close all dropdowns
        document.querySelectorAll('.project-settings-dropdown-container').forEach(dropdown => {
            dropdown.classList.remove('active');
        });
        
        if (!isActive) {
            container.classList.add('active');
        }
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.project-settings-dropdown-container')) {
            document.querySelectorAll('.project-settings-dropdown-container').forEach(dropdown => {
                dropdown.classList.remove('active');
            });
        }
    });

    // Open project settings modal
    window.openProjectSettingsModal = function() {
        const modal = document.getElementById('projectSettingsModal');
        const titleInput = document.getElementById('projectTitleInput');
        const descInput = document.getElementById('projectDescriptionInput');
        
        // Close dropdown
        const dropdown = document.getElementById('projectSettingsDropdown');
        if (dropdown) {
            dropdown.classList.remove('active');
        }
        
        // Populate form with current values
        if (titleInput) titleInput.value = '{{ project.title|escapejs }}';
        if (descInput) descInput.value = '{{ project.description|escapejs|default:"" }}';
        
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }
    };

    // Close project settings modal
    window.closeProjectSettingsModal = function() {
        const modal = document.getElementById('projectSettingsModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };

    // Save project settings
    window.saveProjectSettings = function() {
        const btn = document.getElementById('saveProjectBtn');
        const titleInput = document.getElementById('projectTitleInput');
        const descInput = document.getElementById('projectDescriptionInput');
        
        const title = titleInput ? titleInput.value.trim() : '';
        if (!title) {
            alert('Project title is required');
            return;
        }
        
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        fetch('{% url "general:dashboard_user:project_detail" project.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'update',
                title: title,
                description: descInput ? descInput.value.trim() : ''
            })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
                if (typeof showNotification !== 'undefined') {
                    showNotification('Project updated successfully!', 'success');
                }
                window.closeProjectSettingsModal();
                // Reload page to show updated values
                window.location.reload();
        } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update project', 'error');
                } else {
                    alert(data.error || 'Failed to update project');
                }
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Save Changes';
                }
            }
        })
        .catch(error => {
            console.error('Error saving project:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred. Please try again.', 'error');
            } else {
                alert('An error occurred. Please try again.');
            }
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'Save Changes';
            }
        });
    };

    // Delete project
    window.deleteProject = function() {
        // Close dropdown
        const dropdown = document.getElementById('projectSettingsDropdown');
        if (dropdown) {
            dropdown.classList.remove('active');
        }
        
        if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
            return;
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        fetch('{% url "general:dashboard_user:project_detail" project.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'delete'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (typeof showNotification !== 'undefined') {
                    showNotification('Project deleted successfully', 'success');
                }
                // Redirect to projects list
                window.location.href = '{% url "general:dashboard_user:projects_list" %}';
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to delete project', 'error');
                } else {
                    alert(data.error || 'Failed to delete project');
                }
        }
      })
      .catch(error => {
            console.error('Error deleting project:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred. Please try again.', 'error');
            } else {
                alert('An error occurred. Please try again.');
            }
        });
    };

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('projectSettingsModal');
        if (e.target === modal) {
            window.closeProjectSettingsModal();
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('projectSettingsModal');
            if (modal && modal.classList.contains('active')) {
                window.closeProjectSettingsModal();
            }
        }
    });

    {% if project.questionnaire_completed %}
    // Load stages from API
    function loadStages() {
        const apiUrl = '{% url "general:dashboard_user:get_stages_api" project.id %}';
        
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                renderStages(data.stages || []);
            } else {
                const errorMsg = data?.error || 'Unknown error';
                const container = document.getElementById('stagesList');
                if (container) {
                    container.innerHTML = `
                        <div style="padding: 48px; text-align: center; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                            <p>Error loading stages: ${errorMsg}</p>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching stages:', error);
            const container = document.getElementById('stagesList');
            if (container) {
                container.innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Network error: ${error.message}</p>
                    </div>
                `;
            }
        });
    }

    // Render waterfall chart
    function renderWaterfallChart(stages) {
        const container = document.getElementById('waterfallChartContainer');
        const chartEl = document.getElementById('waterfallChart');
        
        window.waterfallChartEl = chartEl;
        
        if (!container || !chartEl) return;
        
        if (!stages || stages.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        // Filter stages with dates
        const stagesWithDates = stages.filter(s => s.start_date && s.end_date);
        
        if (stagesWithDates.length === 0) {
            chartEl.innerHTML = `
                <div style="text-align: center; padding: 32px; color: #9ca3af;">
                    <i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0; font-size: 0.875rem;">Add start and end dates to stages to view timeline</p>
                </div>
            `;
            return;
        }
        
        // Calculate date range
        const dates = stagesWithDates.flatMap(s => [new Date(s.start_date), new Date(s.end_date)]);
        let originalMinDate = new Date(Math.min(...dates));
        let originalMaxDate = new Date(Math.max(...dates));
        
        // If project target date exists and is later than the latest stage end date, extend to include it
        if (TARGET_COMPLETION_DATE) {
            const targetDate = new Date(TARGET_COMPLETION_DATE);
            targetDate.setHours(0, 0, 0, 0);
            if (targetDate > originalMaxDate) {
                originalMaxDate = new Date(targetDate);
            }
        }
        
        const originalRange = originalMaxDate - originalMinDate;
        const paddingPercent = 0.1;
        const paddingMs = originalRange * paddingPercent;
        const minDate = new Date(originalMinDate.getTime() - paddingMs);
        const maxDate = new Date(originalMaxDate.getTime() + paddingMs);
        
        const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
        const totalMonths = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30));
        const totalYears = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 365));
        
        // Determine time unit and interval
        let timeUnit, interval, unitLabel;
        if (totalYears >= 2) {
            timeUnit = 'year';
            interval = Math.max(1, Math.floor(totalYears / 10));
            unitLabel = 'Years';
        } else if (totalMonths >= 2) {
            timeUnit = 'month';
            interval = Math.max(1, Math.floor(totalMonths / 10));
            unitLabel = 'Months';
        } else {
            timeUnit = 'day';
            interval = Math.max(1, Math.floor(totalDays / 10));
            unitLabel = 'Days';
        }
        
        // Generate axis labels
        const axisLabels = [];
        const numLabels = 6;
        for (let i = 0; i <= numLabels; i++) {
            const progress = i / numLabels;
            let labelDate = new Date(originalMinDate.getTime() + (originalMaxDate - originalMinDate) * progress);
            let labelText;
            
            if (timeUnit === 'year') {
                labelText = labelDate.getFullYear().toString();
            } else if (timeUnit === 'month') {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            } else {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            const extendedProgress = ((labelDate - minDate) / (maxDate - minDate)) * 100;
            
            axisLabels.push({
                position: extendedProgress,
                label: labelText
            });
        }
        
        const chartHeight = 80 + (stagesWithDates.length * 50);
        chartEl.style.height = chartHeight + 'px';
        
        // Calculate today's position
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayPosition = today >= minDate && today <= maxDate 
            ? ((today - minDate) / (maxDate - minDate)) * 100 
            : null;
        
        // Calculate target completion date position
        let targetDatePosition = null;
        if (TARGET_COMPLETION_DATE) {
            const targetDate = new Date(TARGET_COMPLETION_DATE);
            targetDate.setHours(0, 0, 0, 0);
            targetDatePosition = targetDate >= minDate && targetDate <= maxDate 
                ? ((targetDate - minDate) / (maxDate - minDate)) * 100 
                : null;
        }
        
        let chartHtml = `
            <div class="waterfall-chart-inner" style="position: relative; height: ${chartHeight}px; padding: 20px 0 60px 0;">
                ${todayPosition !== null ? `
                    <div class="current-time-line" style="position: absolute; left: ${todayPosition}%; top: 0; bottom: 0; width: 2px; background: #3b82f6; z-index: 100; pointer-events: none; transform: translateX(-50%);">
                        <div style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid #3b82f6;"></div>
                    </div>
                ` : ''}
                ${targetDatePosition !== null ? `
                    <div class="target-date-line" style="position: absolute; left: ${targetDatePosition}%; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 100; pointer-events: none; transform: translateX(-50%);">
                        <div style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid #ef4444;"></div>
                    </div>
                ` : ''}
                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; border-top: 2px solid #e5e7eb;">
                    ${axisLabels.map(label => `
                        <div style="position: absolute; left: ${label.position}%; transform: translateX(-50%); top: 8px;">
                            <div style="width: 2px; height: 8px; background: #9ca3af; margin: 0 auto;"></div>
                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px; white-space: nowrap;">${label.label}</div>
                        </div>
                    `).join('')}
                    ${todayPosition !== null ? `
                        <div style="position: absolute; left: ${todayPosition}%; transform: translateX(-50%); top: -18px;">
                            <div style="width: 2px; background: #3b82f6; margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: #3b82f6; margin-bottom: 12px; white-space: nowrap; font-weight: 600;">Today</div>
                        </div>
                    ` : ''}
                    ${targetDatePosition !== null ? `
                        <div style="position: absolute; left: ${targetDatePosition}%; transform: translateX(-50%); top: -18px;">
                            <div style="width: 2px; background: #ef4444; margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: #ef4444; margin-bottom: 12px; white-space: nowrap; font-weight: 600;">Target Date</div>
                        </div>
                    ` : ''}
                    <div style="position: absolute; top: -20px; left: 0; font-size: 0.7rem; color: #9ca3af; font-weight: 500;">${unitLabel}</div>
                </div>
        `;
        
        stagesWithDates.forEach((stage, index) => {
            const startDate = new Date(stage.start_date);
            const endDate = new Date(stage.end_date);
            const daysFromStart = Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const leftPercent = (daysFromStart / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            const top = 20 + (index * 50);
            
            const isDisabled = stage.is_disabled || false;
            let color = '#3b82f6';
            const progressStatus = stage.progress_status || (stage.is_completed ? 'completed' : 'in_progress');
            if (!isDisabled) {
                switch(progressStatus) {
                    case 'completed':
                        color = '#10b981';
                        break;
                    case 'overdue':
                        color = '#ef4444';
                        break;
                    case 'in_progress':
                        color = '#3b82f6';
                        break;
                    case 'created':
                        color = '#fbbf24';
                        break;
                }
            }
            
            const totalTasks = stage.tasks_total || 0;
            const completedTasks = stage.tasks_completed || 0;
            const taskProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            let barStyle = '';
            let progressBarHtml = '';
            
            if (isDisabled) {
                barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; opacity: 0.7;`;
            } else if (progressStatus === 'in_progress') {
                if (totalTasks > 0) {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #3b82f6; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;`;
                }
            } else if (progressStatus === 'overdue') {
                if (totalTasks > 0) {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #ef4444; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;`;
                }
            } else if (progressStatus === 'created') {
                if (totalTasks > 0 && completedTasks > 0) {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(251, 191, 36, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #fbbf24; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(251, 191, 36, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;`;
                }
            } else {
                barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: ${color}; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;`;
            }
            
            let textColor = 'white';
            let textBackground = '';
            let textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            
            if (isDisabled) {
                textColor = '#6b7280';
                textShadow = 'none';
            } else if (progressStatus === 'in_progress' || progressStatus === 'overdue' || progressStatus === 'created') {
                textColor = '#1e293b';
                textBackground = 'background: rgba(255, 255, 255, 0.85); padding: 2px 8px; border-radius: 4px;';
                textShadow = 'none';
            }
            
            chartHtml += `
                <div 
                    class="waterfall-stage-bar" 
                    data-stage-id="${stage.id}"
                    data-start-date="${stage.start_date}"
                    data-end-date="${stage.end_date}"
                    style="${barStyle}"
                    title="${stage.title}"
                    ondblclick="window.location.href='${STAGE_DETAIL_URL}${stage.id}/';"
                >
                    ${progressBarHtml}
                    <span style="font-size: 0.75rem; color: ${textColor}; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; text-align: center; pointer-events: none; position: relative; z-index: 2; text-shadow: ${textShadow}; ${textBackground}">${escapeHtml(stage.title)}</span>
                </div>
            `;
        });
        
        chartHtml += '</div>';
        chartEl.innerHTML = chartHtml;
    }

    // Render stages from API data
    function renderStages(stages) {
        const container = document.getElementById('stagesList');
        const countEl = document.getElementById('stagesCount');
        
        if (!container) return;
        
        // Render charts and progress
        renderWaterfallChart(stages);
        renderProjectProgress();
        
        if (!stages || stages.length === 0) {
            container.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #9ca3af;">
                    <i class="fas fa-stream" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>No stages defined yet.</p>
                </div>
            `;
            if (countEl) {
                countEl.textContent = '0 Stages';
            }
            return;
        }
        
        if (countEl) {
            countEl.textContent = `${stages.length} Stage${stages.length !== 1 ? 's' : ''}`;
        }
        
        container.innerHTML = stages.map(stage => {
            let statusDot = '';
            let titleClass = '';
            let titleText = stage.title;
            const isDisabled = stage.is_disabled || false;
            let rowClass = 'stage-row';
            
            if (isDisabled) {
                rowClass = 'stage-row stage-row-disabled';
            }
            
            const progressStatus = stage.progress_status || (stage.is_completed ? 'completed' : 'in_progress');
            let progressColor = '#e5e7eb';
            
            if (isDisabled) {
                statusDot = '<span class="status-dot" style="background-color: #9ca3af; border: 1px solid #d1d5db; box-shadow: none;" title="Disabled"></span>';
                progressColor = '#9ca3af';
                titleClass = 'style="color: #6b7280; opacity: 0.7;"';
            } else {
                switch(progressStatus) {
                    case 'completed':
                        statusDot = '<span class="status-dot completed" title="Completed"></span>';
                        progressColor = '#10b981';
                        titleClass = 'style="text-decoration: line-through; color: #6b7280;"';
                        break;
                    case 'overdue':
                        statusDot = '<span class="status-dot overdue" title="Overdue"></span>';
                        progressColor = '#ef4444';
                        break;
                    case 'in_progress':
                        statusDot = '<span class="status-dot pending" title="In Progress"></span>';
                        progressColor = '#3b82f6';
                        break;
                    case 'created':
                    default:
                        statusDot = '<span class="status-dot created" title="Created"></span>';
                        progressColor = '#fbbf24';
                        break;
                }
            }
            
            const totalTasks = stage.tasks_total || 0;
            const completedTasks = stage.tasks_completed || 0;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : (progressStatus === 'completed' ? 100 : 0);
            
            if (isDisabled) {
                progressColor = '#9ca3af';
            } else if (progress === 0 && progressStatus !== 'completed') {
                progressColor = '#e5e7eb';
            } else if (progressStatus === 'completed') {
                progressColor = '#10b981';
            } else if (progressStatus === 'overdue') {
                progressColor = '#ef4444';
            } else if (progressStatus === 'in_progress') {
                progressColor = '#3b82f6';
            } else if (progressStatus === 'created') {
                progressColor = '#fbbf24';
            }
            
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };
            
            const startDateDisplay = stage.start_date ? formatDate(stage.start_date) : null;
            const endDateDisplay = stage.end_date ? formatDate(stage.end_date) : null;
            
            let dateRangeHtml = '';
            if (startDateDisplay && endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> ${startDateDisplay} - ${endDateDisplay}</div>`;
            } else if (startDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Starts ${startDateDisplay}</div>`;
            } else if (endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Ends ${endDateDisplay}</div>`;
            }
            
            return `
                <div class="${rowClass}" data-stage-id="${stage.id}">
                    <div class="stage-drag-section">
                        <div class="drag-grip">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                    </div>
                    <div class="stage-main-wrapper" onclick="window.location.href='${STAGE_DETAIL_URL}${stage.id}/';">
                        <div class="stage-main">
                            <div class="stage-title-meta">
                                <div class="stage-title">
                                    ${statusDot}
                                    <span ${titleClass}>${escapeHtml(titleText)}</span>
                                </div>
                                ${dateRangeHtml}
                            </div>
                        </div>
                        <div class="stage-progress-section">
                            <div class="stage-progress-bar-container">
                                <div class="stage-progress-label">
                                    <span>Progress</span>
                                    <span style="font-weight: 500;">${progress}%</span>
                                </div>
                                <div class="stage-progress-bar">
                                    <div class="stage-progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                                </div>
                            </div>
                            <div class="stage-tasks-count ${totalTasks === 0 ? 'no-tasks' : ''}">
                                ${totalTasks === 0 
                                    ? '<span style="color: #93c5fd;">no tasks yet</span>'
                                    : `<i class="fas fa-tasks"></i><span>${completedTasks}/${totalTasks}</span>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    {% endif %}
});
</script>

{% if is_owner %}
<!-- Project Settings Modal -->
<div id="projectSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Project Settings</h2>
            <button class="modal-close" onclick="window.closeProjectSettingsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="projectSettingsForm">
                {% csrf_token %}
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Project Title -->
                    <div>
                        <label for="projectTitleInput" style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                            Project Title <span style="color: #ef4444;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="projectTitleInput" 
                            name="title" 
                            required
                            style="width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; font-family: 'Inter', -apple-system, sans-serif; color: #1e293b; transition: all 0.2s ease; box-sizing: border-box; background: #fcfcfd;"
                            onfocus="this.style.borderColor='#111827'; this.style.background='#ffffff'; this.style.boxShadow='0 0 0 4px rgba(17, 24, 39, 0.05)';"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.background='#fcfcfd'; this.style.boxShadow='none';"
                        >
                    </div>
                    
                    <!-- Project Description -->
                    <div>
                        <label for="projectDescriptionInput" style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                            Description
                        </label>
                        <textarea 
                            id="projectDescriptionInput" 
                            name="description" 
                            rows="6"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; font-family: 'Inter', -apple-system, sans-serif; color: #1e293b; transition: all 0.2s ease; box-sizing: border-box; background: #fcfcfd; resize: vertical; line-height: 1.6;"
                            onfocus="this.style.borderColor='#111827'; this.style.background='#ffffff'; this.style.boxShadow='0 0 0 4px rgba(17, 24, 39, 0.05)';"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.background='#fcfcfd'; this.style.boxShadow='none';"
                        ></textarea>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid #e5e7eb;">
            <button type="button" onclick="window.closeProjectSettingsModal()" style="padding: 10px 20px; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                Cancel
            </button>
            <button type="button" onclick="window.saveProjectSettings()" id="saveProjectBtn" style="padding: 10px 20px; border: none; background: #111827; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                Save Changes
            </button>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-overlay.active {
    opacity: 1;
}

.modal-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.95);
    transition: transform 0.3s ease;
}

.modal-overlay.active .modal-container {
    transform: scale(1);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
}

.modal-close {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: transparent;
    color: #6b7280;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.modal-close:hover {
    background: #f3f4f6;
    color: #111827;
}

.modal-body {
    padding: 24px;
}
</style>
{% endif %}

{% include 'dashboard_user/projects/modals/create_stage_modal.html' %}
{% endblock %}
