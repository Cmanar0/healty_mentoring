{% extends "base.html" %}
{% load static %}

{% block title %}{% block page_title %}User Dashboard{% endblock %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block navbar %}
<header class="dashboard-header">
  <nav class="dashboard-top-nav">
    <div class="dashboard-nav-left">
      <button class="hamburger-toggle" id="hamburgerToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="{% url 'web:landing' %}" class="dashboard-logo-link">
        <img src="{% static 'images/logo.png' %}" alt="logo" class="logo">
      </a>
    </div>
    <div class="dashboard-top-actions">
      {% if user.is_authenticated and user.profile.first_name and user.profile.last_name %}
        <div class="dashboard-top-actions-group">
          <!-- Notification Bell -->
          <div class="notification-dropdown">
            <button class="notification-bell" id="notificationBell" aria-label="Notifications">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">5</span>
            </button>
            <div class="notification-menu" id="notificationMenu">
            <div class="notification-menu-header">
              <h3>Notifications</h3>
              <button class="mark-all-read-btn" style="width: auto;" type="button">Mark all as read</button>
            </div>
            <div class="notification-list">
              <div class="notification-item unread">
                <div class="notification-icon">
                  <i class="fas fa-calendar-check"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">New session scheduled</p>
                  <p class="notification-time">2 minutes ago</p>
                </div>
              </div>
              <div class="notification-item unread">
                <div class="notification-icon">
                  <i class="fas fa-user-plus"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">Mentor accepted your request</p>
                  <p class="notification-time">15 minutes ago</p>
                </div>
              </div>
              <div class="notification-item">
                <div class="notification-icon">
                  <i class="fas fa-comment"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">New message from mentor</p>
                  <p class="notification-time">1 hour ago</p>
                </div>
              </div>
              <div class="notification-item unread">
                <div class="notification-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">Task completed</p>
                  <p class="notification-time">2 hours ago</p>
                </div>
              </div>
              <div class="notification-item">
                <div class="notification-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">New project document</p>
                  <p class="notification-time">3 hours ago</p>
                </div>
              </div>
              <div class="notification-item unread">
                <div class="notification-icon">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">Session reminder</p>
                  <p class="notification-time">5 hours ago</p>
                </div>
              </div>
              <div class="notification-item">
                <div class="notification-icon">
                  <i class="fas fa-bullhorn"></i>
                </div>
                <div class="notification-content">
                  <p class="notification-title">Platform update</p>
                  <p class="notification-time">1 day ago</p>
                </div>
              </div>
            </div>
            <div class="notification-footer">
              <a href="#" class="view-all-notifications">View all</a>
            </div>
          </div>
        </div>
          <div class="user-profile-dropdown">
          <button class="user-profile-trigger" id="userProfileTrigger">
            <span class="user-name">{{ user.profile.first_name }} {{ user.profile.last_name }}</span>
            <div class="user-avatar">
              {% if user.profile.profile_picture %}
                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.first_name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
              {% else %}
                <div class="avatar-placeholder">
                  <i class="fas fa-user"></i>
                </div>
              {% endif %}
            </div>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="/dashboard/user/account/" class="dropdown-item">
              <i class="fas fa-user"></i>
              <span>Account</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-credit-card"></i>
              <span>Billings</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-headset"></i>
              <span>Support</span>
            </a>
            <div class="dropdown-divider"></div>
            <form action="{% url 'accounts:logout' %}" method="post" class="dropdown-item-form">
          {% csrf_token %}
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </button>
        </form>
          </div>
        </div>
      {% endif %}
    </div>
  </nav>
</header>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
  <!-- Left Sidebar -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <nav class="sidebar-nav">
      <ul class="sidebar-menu">
        <li>
          <a href="/dashboard/user/" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" title="Dashboard">
            <i class="fas fa-home"></i>
            <span class="sidebar-text">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="{% url 'web:mentors' %}" class="sidebar-link" title="Find Mentors">
            <i class="fas fa-search"></i>
            <span class="sidebar-text">Find Mentors</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/user/my-sessions/" class="sidebar-link {% if request.resolver_match.url_name == 'my_sessions' %}active{% endif %}" title="My Sessions">
            <i class="fas fa-calendar"></i>
            <span class="sidebar-text">My Sessions</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main" id="dashboardMain">
    {% block dashboard_content %}{% endblock %}
  </main>
</div>

<!-- Tutorial Manual Overlay -->
<div id="tutorialOverlay" class="tutorial-overlay" style="display: none;">
  <div class="tutorial-bubble" id="tutorialBubble">
    <button type="button" class="tutorial-close" id="tutorialClose">
      <i class="fas fa-times"></i>
    </button>
    <h3 class="tutorial-title" id="tutorialTitle"></h3>
    <p class="tutorial-text" id="tutorialText"></p>
  </div>
</div>

<!-- Manuals Data (JSON) -->
{{ user.profile.manuals|json_script:"manualsData" }}
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
:root {
  --primary: #10b981;
  --text-dark: #1e293b;
  --text-light: #94a3b8;
}

/* Hamburger hover - green bars, no background */
.hamburger-toggle:hover {
  background: transparent;
}

.hamburger-toggle:hover span {
  background: var(--primary);
}

/* User Profile Dropdown */
.user-profile-dropdown {
  position: relative;
}

.user-profile-trigger {
  display: flex;
  align-items: center;
  gap: 12px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  transition: none;
}

.user-profile-trigger:hover {
  background: transparent;
}

.user-profile-trigger:hover .user-name {
  color: var(--primary);
}

.user-name {
  font-weight: 500;
  color: var(--text-dark);
  font-size: 0.95rem;
  transition: color 0.2s ease;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 2px solid var(--primary);
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 0.9rem;
}

.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 200px;
  padding: 0;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
}

.user-profile-dropdown.active .user-dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.dropdown-item,
.dropdown-item-form {
  display: block;
  width: 100%;
  text-align: left;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: var(--text-dark);
  text-decoration: none;
  transition: background 0.2s ease;
  border: none;
  background: transparent;
  width: 100%;
  cursor: pointer;
  font-size: 0.95rem;
}

/* First button - rounded top corners */
.dropdown-item:first-child {
  border-radius: 12px 12px 0 0;
}

.dropdown-item:hover {
  background: rgba(16, 185, 129, 0.1);
  color: var(--primary);
}

/* First button hover - maintain top rounded corners */
.dropdown-item:first-child:hover {
  border-radius: 12px 12px 0 0;
}

.dropdown-item i {
  width: 20px;
  text-align: center;
  color: var(--text-light);
}

.dropdown-item:hover i {
  color: var(--primary);
}

.dropdown-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
}

.logout-item {
  margin-top: 0;
  border-radius: 0 0 12px 12px;
}

.logout-item:hover {
  border-radius: 0 0 12px 12px;
}

.logout-item i {
  color: #ef4444;
}

.logout-item:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

.logout-item:hover i {
  color: #ef4444;
}

/* Dashboard Top Actions Group */
.dashboard-top-actions-group {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Dashboard Top Actions Group */
.dashboard-top-actions-group {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Notification Bell */
.notification-dropdown {
  position: relative;
}

.notification-bell {
  position: relative;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--text-dark);
  font-size: 1.2rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
}

.notification-bell:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--primary);
}

.notification-bell i {
  display: block;
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
}

.notification-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  width: 380px;
  max-width: 90vw;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  height: 500px;
}

.notification-dropdown.active .notification-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.notification-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.notification-menu-header h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-dark);
}

.mark-all-read-btn {
  background: transparent;
  border: none;
  color: var(--primary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.mark-all-read-btn:hover {
  background: rgba(16, 185, 129, 0.1);
}

.notification-list {
  flex: 1;
  overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
  width: 6px;
}

.notification-list::-webkit-scrollbar-track {
  background: transparent;
}

.notification-list::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
}

.notification-item {
  display: flex;
  gap: 12px;
  padding: 12px 20px;
  transition: background 0.2s ease;
  cursor: pointer;
  border-left: 3px solid transparent;
}

.notification-item:hover {
  background: rgba(0, 0, 0, 0.03);
}

.notification-item.unread {
  background: rgba(16, 185, 129, 0.05);
  border-left-color: var(--primary);
}

.notification-item.unread:hover {
  background: rgba(16, 185, 129, 0.08);
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(16, 185, 129, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: var(--primary);
  font-size: 0.9rem;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-title {
  margin: 0 0 4px 0;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-dark);
  line-height: 1.4;
}

.notification-time {
  margin: 0;
  font-size: 0.8rem;
  color: var(--text-light);
}

.notification-footer {
  padding: 12px 20px;
  border-top: 1px solid rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.view-all-notifications {
  color: var(--primary);
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  transition: color 0.2s ease;
}

.view-all-notifications:hover {
  color: var(--dash-primary-hover);
  text-decoration: underline;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const hamburgerToggle = document.getElementById('hamburgerToggle');
  const sidebar = document.getElementById('dashboardSidebar');
  const dashboardLayout = document.querySelector('.dashboard-layout');

  if (hamburgerToggle && sidebar && dashboardLayout) {
    // Check if sidebar should start collapsed (from localStorage)
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      dashboardLayout.classList.add('sidebar-collapsed');
      hamburgerToggle.classList.add('active');
    }

    hamburgerToggle.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      dashboardLayout.classList.toggle('sidebar-collapsed');
      hamburgerToggle.classList.toggle('active');
      
      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });

    // Close sidebar when clicking outside on mobile
    if (window.innerWidth <= 768) {
      document.addEventListener('click', function(event) {
        if (!sidebar.contains(event.target) && !hamburgerToggle.contains(event.target)) {
          sidebar.classList.remove('open');
          hamburgerToggle.classList.remove('active');
        }
      });
    }
  }

  // Notification Bell Dropdown
  const notificationBell = document.getElementById('notificationBell');
  const notificationMenu = document.getElementById('notificationMenu');
  const notificationDropdown = document.querySelector('.notification-dropdown');

  if (notificationBell && notificationMenu) {
    notificationBell.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationDropdown.classList.toggle('active');
      // Close user profile dropdown if open
      if (userProfileDropdown) {
        userProfileDropdown.classList.remove('active');
      }
    });

    // Mark all as read button
    const markAllReadBtn = document.querySelector('.mark-all-read-btn');
    if (markAllReadBtn) {
      markAllReadBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const unreadItems = notificationMenu.querySelectorAll('.notification-item.unread');
        unreadItems.forEach(item => {
          item.classList.remove('unread');
        });
        // Update badge count (mockup - set to 0)
        const badge = notificationBell.querySelector('.notification-badge');
        if (badge) {
          badge.textContent = '0';
          badge.style.display = 'none';
        }
      });
    }
  }

  // User Profile Dropdown
  const userProfileTrigger = document.getElementById('userProfileTrigger');
  const userDropdownMenu = document.getElementById('userDropdownMenu');
  const userProfileDropdown = document.querySelector('.user-profile-dropdown');

  if (userProfileTrigger && userDropdownMenu) {
    userProfileTrigger.addEventListener('click', function(e) {
      e.stopPropagation();
      userProfileDropdown.classList.toggle('active');
      // Close notification dropdown if open
      if (notificationDropdown) {
        notificationDropdown.classList.remove('active');
      }
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (userProfileDropdown && !userProfileDropdown.contains(event.target)) {
      userProfileDropdown.classList.remove('active');
    }
    if (notificationDropdown && !notificationDropdown.contains(event.target)) {
      notificationDropdown.classList.remove('active');
    }
  });

  // Tutorial Manual System
  // Tutorial Manual System
  let manuals = [];
  let currentManualIndex = 0;
  
  try {
    const manualsDataElement = document.getElementById('manualsData');
    if (manualsDataElement) {
      manuals = JSON.parse(manualsDataElement.textContent);
      // Filter out displayed manuals
      manuals = manuals.filter(m => !m.displayed);
      console.log('Loaded manuals:', manuals);
    }
  } catch (error) {
    console.error('Error parsing manuals data:', error);
  }

  function showTutorialManual(manual) {
    console.log('Showing tutorial manual:', manual);
    const overlay = document.getElementById('tutorialOverlay');
    const bubble = document.getElementById('tutorialBubble');
    const title = document.getElementById('tutorialTitle');
    const text = document.getElementById('tutorialText');
    
    if (!overlay || !bubble || !title || !text) {
      console.error('Tutorial elements not found');
      return;
    }

    // Find target element by ID (manual.id now refers to DOM element ID)
    let targetElement = document.getElementById(manual.id);
    
    if (!targetElement) {
      console.warn('Target element not found for ID:', manual.id);
      console.warn('Skipping this manual (will try again next time)');
      // Skip this manual and show next one WITHOUT marking as displayed
      // This way it won't be removed if the element doesn't exist yet
      currentManualIndex++;
      if (currentManualIndex < manuals.length) {
        setTimeout(() => {
          showTutorialManual(manuals[currentManualIndex]);
        }, 300);
      }
      return;
    }
    
    console.log('Target element found:', targetElement);

    // Add highlight class to target element to prevent blur
    targetElement.classList.add('tutorial-highlight');

    // Set content
    title.textContent = manual.title;
    text.textContent = manual.text;

    // Show overlay
    overlay.style.display = 'block';
    setTimeout(() => {
      overlay.classList.add('active');
    }, 10);

    // Position bubble using coordinates from manual.position
    positionBubbleByCoordinates(targetElement, bubble, manual.position);
  }

  function positionBubbleByCoordinates(targetElement, bubble, position) {
    const rect = targetElement.getBoundingClientRect();
    const bubbleRect = bubble.getBoundingClientRect();
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;

    let top, left;

    // position can be an object with x, y offsets or a string like "top", "bottom", etc.
    if (typeof position === 'object' && position.x !== undefined && position.y !== undefined) {
      // Use coordinates relative to target element
      top = rect.top + scrollY + position.y;
      left = rect.left + scrollX + position.x;
    } else if (typeof position === 'string') {
      // Fallback to string-based positioning for backward compatibility
      switch(position) {
        case 'top':
          top = rect.top + scrollY - bubbleRect.height - 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
          break;
        case 'bottom':
          top = rect.bottom + scrollY + 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
          break;
        case 'left':
          top = rect.top + scrollY + (rect.height / 2) - (bubbleRect.height / 2);
          left = rect.left + scrollX - bubbleRect.width - 16;
          break;
        case 'right':
          top = rect.top + scrollY + (rect.height / 2) - (bubbleRect.height / 2);
          left = rect.right + scrollX + 16;
          break;
        default:
          top = rect.bottom + scrollY + 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
      }
    } else {
      // Default: bottom center
      top = rect.bottom + scrollY + 16;
      left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
    }

    // Keep bubble within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (left < 20) left = 20;
    if (left + bubbleRect.width > viewportWidth - 20) {
      left = viewportWidth - bubbleRect.width - 20;
    }
    if (top < 20) top = 20;
    if (top + bubbleRect.height > viewportHeight - 20) {
      top = viewportHeight - bubbleRect.height - 20;
    }

    bubble.style.top = top + 'px';
    bubble.style.left = left + 'px';
  }

  function closeTutorial() {
    const overlay = document.getElementById('tutorialOverlay');
    overlay.classList.remove('active');
    
    // Remove highlight class from all elements
    document.querySelectorAll('.tutorial-highlight').forEach(el => {
      el.classList.remove('tutorial-highlight');
    });
    
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);

    // Mark current manual as displayed
    if (manuals[currentManualIndex]) {
      markManualAsDisplayed(manuals[currentManualIndex].id);
    }
  }

  function markManualAsDisplayed(manualId) {
    fetch('{% url "general:mark_manual_displayed" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ manual_id: manualId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show next manual if available
        currentManualIndex++;
        if (currentManualIndex < manuals.length) {
          setTimeout(() => {
            showTutorialManual(manuals[currentManualIndex]);
          }, 300);
        }
      }
    })
    .catch(error => {
      console.error('Error marking manual as displayed:', error);
    });
  }

  // Initialize tutorial on page load
  function initTutorial() {
    if (manuals && manuals.length > 0) {
      console.log('Initializing tutorial with', manuals.length, 'manuals');
      // Wait for page to fully load and DOM to be ready
      setTimeout(() => {
        showTutorialManual(manuals[0]);
      }, 1000);
    } else {
      console.log('No manuals to display');
    }
  }

  // Wait for DOM to be fully loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTutorial);
  } else {
    // DOM is already loaded
    window.addEventListener('load', initTutorial);
  }

  // Close tutorial handlers
  const tutorialClose = document.getElementById('tutorialClose');
  const tutorialOverlay = document.getElementById('tutorialOverlay');

  if (tutorialClose) {
    tutorialClose.addEventListener('click', closeTutorial);
  }

  if (tutorialOverlay) {
    tutorialOverlay.addEventListener('click', function(e) {
      if (e.target === tutorialOverlay) {
        closeTutorial();
      }
    });
  }
});
</script>

<!-- Include invitation popup -->
{% include "accounts/invitation_popup.html" %}

{% endblock %}
