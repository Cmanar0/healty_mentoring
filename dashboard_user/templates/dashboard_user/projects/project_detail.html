{% extends "dashboard_user/base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_title %}{{ project.title }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
<style>
    /* Layout Grid */
    .roadmap-container {
        display: grid;
        grid-template-columns: 1fr 340px;
        grid-template-areas:
            "doc-header meta-card"
            "main backlog";
        gap: 32px;
        align-items: start;
        grid-auto-rows: min-content;
        position: relative;
    }
    
    /* Keep normal page appearance even when stage tasks are open */
    .roadmap-container > main {
        position: relative;
    }
    
    .roadmap-container .doc-header-section {
        grid-area: doc-header;
    }
    
    .roadmap-container > main {
        grid-area: main;
        position: relative;
        align-self: start;
    }
    
    .project-sidebar {
        grid-area: meta-card;
        position: relative;
    }
    
    .project-sidebar-backlog {
        grid-area: backlog;
        align-self: start;
        max-height: calc(100vh - 130px);
        display: flex;
        flex-direction: column;
        height: fit-content;
        position: sticky;
        top: 24px;
    }
    
    
    .roadmap-notes-section {
        width: 100%;
        position: relative;
        z-index: 10;
        background: white;
        margin-top: 32px;
    }
    
    
    /* Constrain sticky sidebar to its grid row */
    .roadmap-container::after {
        content: '';
        grid-column: 1 / -1;
        grid-row: backlog;
        height: 1px;
        visibility: hidden;
    }
    
    .project-sidebar-backlog .client-backlog-card {
        display: flex;
        flex-direction: column;
        max-height: 100%;
        overflow: hidden;
        background: #ffffff !important;
        position: relative;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    
    .project-sidebar-backlog .client-backlog-card > * {
        position: relative;
        z-index: 1;
    }

    /* Pulsing Life for Header Icon */
    .active-backlog-title i {
        animation: iconPulse 3s ease-in-out infinite;
    }

    @keyframes iconPulse {
        0%, 100% { transform: scale(1); opacity: 0.8; }
        50% { transform: scale(1.2); opacity: 1; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    }
    
    .project-sidebar-backlog #clientActiveBacklogList {
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        min-height: 0;
        padding-right: 0;
    }
    
    /* Minimalistic overlay scrollbar for backlog list - overlays on top */
    .project-sidebar-backlog #clientActiveBacklogList::-webkit-scrollbar {
        width: 8px;
    }
    
    .project-sidebar-backlog #clientActiveBacklogList::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .project-sidebar-backlog #clientActiveBacklogList::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    
    .project-sidebar-backlog #clientActiveBacklogList::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0, 0, 0, 0.3);
    }
    
    /* Firefox scrollbar */
    .project-sidebar-backlog #clientActiveBacklogList {
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    /* Ensure task items extend to full width */
    .project-sidebar-backlog .active-backlog-task-item {
        width: 100%;
        margin-right: 0;
    }
    
    /* Active Backlog Header */
    .active-backlog-header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .active-backlog-header-container:hover {
        background: #f9fafb;
    }
    
    .active-backlog-title {
        flex: 1;
        min-width: 0; /* Allow text to shrink */
    }
    
    .active-backlog-create-btn {
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    .active-backlog-create-btn:hover {
        background: #374151 !important;
        color: #ffffff !important;
    }
    
    /* When content doesn't fit, switch to column layout */
    @media (max-width: 400px) {
        .active-backlog-header-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .active-backlog-create-btn {
            width: 100%;
            justify-content: center;
        }
    }
    
    /* Use column layout if title is too long (using container query simulation) */
    .active-backlog-header-container.column-layout {
        flex-direction: column;
        align-items: stretch;
    }
    
    .active-backlog-header-container.column-layout .active-backlog-create-btn {
        width: 100%;
        justify-content: center;
    }
    
    /* Active Backlog Modern Card Styles */
    .active-backlog-task-item {
        display: flex;
        flex-direction: column;
        background: #fafafa;
        border-bottom: 1px solid #e5e7eb;
        border-radius: 0;
        margin-bottom: 0;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .active-backlog-task-item:hover {
        background: #ffffff;
        z-index: 1;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-bottom-color: #d1d5db;
    }
    
    .active-backlog-task-item.completed {
        opacity: 0.5;
        background: #f9fafb;
    }
    
    /* Removed left border - using priority tag instead */
    
    .active-backlog-task-header {
        display: flex;
        align-items: stretch;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .active-backlog-task-activate {
        display: flex;
        align-items: stretch;
        justify-content: center;
        flex-shrink: 0;
        width: 0;
        border-right: none;
        background: #f3f4f6;
        overflow: hidden;
        transition: width 0.3s ease, border-right 0.3s ease;
    }
    
    .active-backlog-task-item:hover .active-backlog-task-activate {
        width: 55px;
        border-right: 1px solid #e5e7eb;
    }
    
    .active-backlog-task-activate.hidden {
        display: none;
    }
    
    .active-backlog-task-activate-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        transition: all 0.2s;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        position: relative;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
    }
    
    .active-backlog-task-item:hover .active-backlog-task-activate-btn {
        opacity: 1;
    }
    
    .active-backlog-task-activate-btn:hover {
        background: #fee2e2;
        color: #ef4444;
        border-radius: 0;
    }
    
    .active-backlog-task-activate-btn .deactivate-popover {
        position: absolute;
        bottom: calc(100% + 6px);
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s ease-in-out;
        z-index: 1001;
        visibility: hidden;
    }
    
    .active-backlog-task-activate-btn .deactivate-popover::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: #111827;
    }
    
    .active-backlog-task-activate-btn:hover .deactivate-popover {
        opacity: 1;
        pointer-events: auto;
        visibility: visible;
    }
    
    .active-backlog-task-activate {
        overflow: visible;
    }
    
    .deactivate-icon-stack {
        position: relative;
        display: inline-flex;
        align-items: center;
        margin-right: 10px;
        justify-content: center;
    }
    
    .active-backlog-task-content {
        flex: 1;
        padding: 16px;
        min-width: 0;
        cursor: pointer;
        height: auto;
        max-height: 135px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        overflow: hidden;
    }
    
    .active-backlog-task-content.has-no-activate-btn {
        background: transparent;
        transition: background 0.2s;
    }
    
    .active-backlog-task-content.has-no-activate-btn:hover {
        background: transparent;
    }
    
    .active-backlog-task-title.single-line {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .active-backlog-task-type-badge {
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        color: #6b7280;
        margin-bottom: 4px;
        display: block;
    }
    
    .active-backlog-task-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
        line-height: 1.4;
    }
    
    .active-backlog-task-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
    }
    
    .active-backlog-task-title-text {
        flex: 1;
        min-width: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: #111827;
        line-height: 1.4;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        max-height: 20px;
    }
    
    .active-backlog-task-deadline {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75rem;
        color: #6b7280;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .active-backlog-task-deadline.overdue {
        color: #ef4444;
        position: relative;
    }
    
    .active-backlog-task-deadline.overdue .overdue-popover {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0s;
        margin-top: 6px;
        z-index: 1000;
    }
    
    .active-backlog-task-deadline.overdue .overdue-popover::after {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-bottom-color: #111827;
    }
    
    .active-backlog-task-deadline.overdue:hover .overdue-popover {
        opacity: 1;
        transition: opacity 0s;
    }
    
    .active-backlog-task-content {
        cursor: pointer;
    }
    
    .active-backlog-task-description {
        font-size: 0.8rem;
        color: #4b5563;
        line-height: 1.5;
        margin-bottom: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        flex-shrink: 0;
        max-height: 20px;
    }
    
    .active-backlog-task-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: #fcfcfd;
        border-top: 1px solid #f3f4f6;
    }
    
    .active-backlog-done-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #a7f3d0;
        background: #ecfdf5;
        color: #047857;
    }
    
    .active-backlog-done-btn:hover {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }
    
    .active-backlog-done-btn.checked {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }
    
    .active-backlog-section-header {
        font-size: 1rem;
        font-weight: 600;
        color: #92a2b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 32px ;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
    }
    
    .active-backlog-section-header::before {
        content: '';
        flex: 1;
        height: 1px;
        background: #e5e7eb;
    }
    
    .active-backlog-section-header::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e5e7eb;
    }
    
    
    .roadmap-notes-section {
        width: 100%;
    }
    
    @media (max-width: 1024px) {
        .roadmap-container {
            grid-template-columns: 1fr;
            grid-template-areas:
                "top-nav"
                "meta-card"
                "main"
                "backlog"
                "notes";
        }
    }

    .nav-btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    .nav-btn-back:hover { color: #1e293b; }

    /* Target Date Modal Styles */
    .target-date-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .target-date-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .target-date-modal-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 90%;
        min-width: 450px;
        min-height: 350px;
        max-height: 90vh;
        overflow: visible;
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        position: relative;
    }

    .target-date-modal-overlay.active .target-date-modal-container {
        transform: scale(1);
    }

    .target-date-modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 0;
        position: relative;
    }

    .target-date-modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .target-date-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(15, 23, 42, 0.1);
        border: 1px solid rgba(15, 23, 42, 0.1);
        color: #64748b;
        font-size: 1rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .target-date-modal-close:hover {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .target-date-modal-body {
        padding: 24px;
        overflow-y: auto;
        overflow-x: visible;
        flex: 1;
        min-height: 200px;
        position: relative;
    }

    .target-date-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        position: relative;
        z-index: 1;
        border-radius: 0 0 16px 16px;
    }

    .target-date-modal-footer .btn-cancel {
        min-width: 100px;
        width: auto;
    }

    .target-date-modal-footer .btn-confirm {
        width: auto;
    }

    .target-date-modal-body .form-group {
        margin-bottom: 20px;
    }

    .target-date-modal-body .form-label {
        display: block;
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }

    .target-date-modal-body .form-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        color: #1e293b;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .target-date-modal-body .form-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .target-date-modal-footer .btn-cancel {
        background: white;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .target-date-modal-footer .btn-cancel:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
    }

    .target-date-modal-footer .btn-confirm {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .target-date-modal-footer .btn-confirm:hover {
        background: #059669;
    }

    .target-date-modal-footer .btn-confirm:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .target-date-modal-footer .btn-danger {
        background: #ef4444;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .target-date-modal-footer .btn-danger:hover {
        background: #dc2626;
    }

    .target-date-modal-footer .btn-danger:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .delete-confirm-message {
        margin: 0;
        color: #334155;
        line-height: 1.5;
    }

    /* Supervisor Modal Styles */
    .supervisor-modal-content {
        padding: 24px;
    }

    .supervisor-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid #e2e8f0;
    }

    .supervisor-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid #e2e8f0;
    }

    .supervisor-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .supervisor-avatar-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: #475569;
        background: #dbeafe;
    }

    .supervisor-details {
        text-align: center;
        width: 100%;
    }

    .supervisor-name {
        margin: 0 0 12px 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .supervisor-email {
        margin: 0 0 16px 0;
        font-size: 0.95rem;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .supervisor-email i {
        font-size: 0.85rem;
        color: #94a3b8;
    }

    .supervisor-bio {
        margin: 0;
        font-size: 0.9rem;
        color: #475569;
        line-height: 1.6;
        max-width: 400px;
        margin: 0 auto;
    }

    .supervisor-actions {
        display: flex;
        justify-content: center;
        gap: 12px;
    }

    .btn-remove-supervisor {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        width: auto;
    }

    .btn-remove-supervisor:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }

    .btn-remove-supervisor:active {
        transform: translateY(0);
    }

    .btn-remove-supervisor:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .supervisor-view {
        width: 100%;
    }

    .supervisor-confirm-message {
        text-align: center;
        padding: 20px 0;
    }

    .confirm-icon {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: #fef3c7;
        color: #f59e0b;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 2rem;
    }

    .confirm-title {
        margin: 0 0 12px 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .confirm-text {
        margin: 0;
        font-size: 0.95rem;
        color: #64748b;
        line-height: 1.6;
        max-width: 400px;
        margin: 0 auto;
    }

    .btn-cancel-confirm {
        background: white;
        color: #64748b;
        border: 1px solid #e2e8f0;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        min-width: 100px;
        width: auto;
    }

    .btn-cancel-confirm:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
        color: #475569;
    }

    .btn-confirm-remove {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
        width: auto;
    }

    .btn-confirm-remove:hover {
        background: #dc2626;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }

    .btn-confirm-remove:active {
        transform: translateY(0);
    }

    .btn-confirm-remove:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    /* Document Card Styles (matching stage detail page) */
    .document-card {
        min-height: 248px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .doc-header {
        padding: 40px;
        border-bottom: 1px solid #e5e7eb;
        background: #fafafa;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 24px;
    }
    
    .doc-header-left {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 40px;
    }
    
    .doc-header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 16px;
    }
    
    .project-info-row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: flex-start;
    }
    
    .project-info-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .project-info-label {
        font-size: 0.7rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-left: 4px;
    }
    
    .project-info-btn,
    .project-info-link {
        display: flex;
        align-items: center;
        gap: 10px;
        background: white;
        border: 1px solid #e5e7eb;
        padding: 8px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #111827;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        height: 42px;
        box-sizing: border-box;
    }
    
    .project-info-btn:hover,
    .project-info-link:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        color: #111827;
    }

    .project-info-btn:active,
    .project-info-link:active {
        transform: translateY(0);
    }
    
    .project-info-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #f1f5f9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        color: #475569;
        flex-shrink: 0;
        border: 1px solid #e2e8f0;
    }
    
    .project-info-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .project-info-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .project-info-status.completed {
        color: #15803d;
    }
    
    .project-info-status.pending {
        color: #92400e;
    }

    .project-info-btn.questionnaire-completed {
        background: #dcfce7;
        border-color: #86efac;
        color: #15803d;
    }

    .project-info-btn.questionnaire-completed:hover {
        background: #bbf7d0;
        border-color: #4ade80;
    }

    .project-info-btn.questionnaire-completed .project-info-status {
        color: #15803d;
    }

    .project-info-btn.questionnaire-completed i.fa-edit {
        color: #15803d;
    }

    .project-info-btn i.fa-edit,
    .project-info-btn i.fa-calendar-plus {
        font-size: 0.85rem;
        color: #94a3b8;
        margin-left: 4px;
        transition: color 0.2s;
    }

    .project-info-btn:hover i.fa-edit {
        color: #6366f1;
    }

    .project-info-btn.target-date-warning {
        background: #fef3c7;
        border-color: #fde68a;
    }

    .project-info-btn.target-date-warning:hover {
        background: #fde68a;
        border-color: #fbbf24;
    }
    
    .project-settings-dropdown-container {
        position: relative;
        z-index: 10;
    }
    
    .project-settings-dropdown-trigger {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 1px solid #e5e7eb;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .project-settings-dropdown-trigger:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #1f2937;
    }
    
    .project-settings-dropdown-trigger i {
        font-size: 1.1rem;
    }
    
    .project-settings-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        min-width: 180px;
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
    }
    
    .project-settings-dropdown-container.active .project-settings-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .project-settings-dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #1e293b;
        text-decoration: none;
        transition: background 0.2s ease;
        border: none;
        background: white;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
    }
    
    .project-settings-dropdown-item.first-item {
        border-radius: 12px 12px 0 0;
    }
    
    .project-settings-dropdown-item.last-item {
        border-radius: 0 0 12px 12px;
    }
    
    .project-settings-dropdown-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    
    .project-settings-dropdown-item.delete-item:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .project-settings-dropdown-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 1.1rem;
        flex-shrink: 0;
    }
    
    .project-settings-dropdown-item:hover i {
        color: inherit;
    }

    .doc-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #111827;
        line-height: 1.1;
        margin-bottom: 0;
        letter-spacing: -0.03em;
        flex: 1;
    }

    .project-owner-header {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 16px;
        align-items: center;
        flex-shrink: 0;
        cursor: pointer;
        transition: opacity 0.2s;
        border-radius: 8px;
        padding: 8px;
        margin: -8px;
    }

    .project-owner-header:hover {
        background: rgba(0, 0, 0, 0.02);
        opacity: 0.8;
    }

    .project-owner-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .project-owner-name {
        font-size: 1rem;
        font-weight: 600;
        color: #111827;
        text-decoration: none;
        transition: opacity 0.2s;
        pointer-events: none;
    }

    .project-owner-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .project-owner-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        flex-shrink: 0;
    }

    .project-owner-unassigned {
        color: #ef4444;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    /* Email Input with Suggestions Styles (for assign owner modal) */
    .schedule-session-input-wrap {
        position: relative;
    }

    .schedule-session-input {
        height: 40px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        padding: 0 12px;
        font-size: 0.95rem;
        color: #0f172a;
        background: #ffffff;
        width: 100%;
    }

    .schedule-session-input:focus {
        outline: none;
        border-color: #94a3b8;
        box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.25);
    }

    .schedule-session-suggestions {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 6px);
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        overflow: hidden;
        z-index: 10001;
        max-height: 240px;
        overflow-y: auto;
    }

    .schedule-session-suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .schedule-session-suggestion-item:hover {
        background: #f8fafc;
    }

    .schedule-session-suggestion-name {
        font-weight: 800;
        color: #0f172a;
        font-size: 0.9rem;
    }

    .schedule-session-suggestion-email {
        color: #64748b;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.82rem;
    }

    .schedule-session-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #334155;
        margin-bottom: 8px;
        display: block;
    }

    .doc-body {
        padding: 40px;
        font-size: 1.1rem;
        line-height: 1.8;
        color: #374151;
    }
    
    .doc-body p {
        margin: 0;
    }

    /* Primary Content Area */
    .roadmap-list-section {
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        border: none;
        overflow: visible; /* Changed from hidden to allow dropdowns to show */
    }

    .roadmap-header {
        padding: 20px 0 20px 24px;
        border-bottom: none;
        border-radius: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: transparent;
    }

    .roadmap-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .roadmap-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    /* Stages List Container */
    #stagesList {
        border-radius: 0;
        overflow: visible;
        background: transparent;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    /* List Items (High Density) */
    .stage-row {
        display: flex;
        flex-direction: column;
        gap: 0;
        padding: 0;
        border-bottom: none;
        transition: background 0.15s ease;
        position: relative;
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: none;
        overflow: hidden;
    }
    
    /* Border colors based on progress status */
    .stage-row.progress-completed {
        border-left: 4px solid #10b981; /* Matches status-tag.completed background */
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stage-row.progress-overdue {
        border-left: 4px solid #ef4444; /* Matches status-tag.overdue background */
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stage-row.progress-in_progress {
        border-left: 4px solid #3b82f6; /* Matches status-tag.pending background */
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stage-row.progress-created {
        border-left: 4px solid #fbbf24; /* Matches status-tag.created background */
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stage-row.progress-disabled {
        border-left: 4px solid #6b7280; /* Matches status-tag.disabled background */
        border-top: 1px solid #e5e7eb;
        border-right: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .stage-row-content {
        display: flex;
        flex-direction: column;
        gap: 0;
        border-radius: 0;
        overflow: hidden;
    }
    
    .stage-content-wrapper {
        display: flex;
        align-items: stretch;
        gap: 0;
        background: white;
        border-radius: 12px 12px 0 0;
    }
    
    /* Removed background colors - using only left border for progress status */
    
    .stage-task-input-section {
        width: 100%;
        background: #f9fafb;
        border-top: 1px solid #f3f4f6;
        border-radius: 0;
    }
    
    .stage-task-input-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 24px 24px 12px 24px;
        background: #f9fafb;
    }
    
    .stage-task-input-row {
        display: flex;
        gap: 16px;
        align-items: center;
    }
    
    .stage-task-input-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
    }
    
    .stage-task-input {
        flex: 1;
        padding: 8px 32px 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
        margin-bottom: 0;
        height: 42px;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .stage-task-input-clear {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        opacity: 0;
        transition: opacity 0.2s, color 0.2s;
        pointer-events: none;
    }
    
    .stage-task-input-clear.show {
        opacity: 1;
        pointer-events: auto;
    }
    
    .stage-task-input-clear:hover {
        color: #374151;
    }
    
    .stage-task-input-clear i {
        font-size: 0.875rem;
        margin: 0;
    }
    
    .stage-task-buttons-wrapper {
        display: flex;
        gap: 16px;
        align-items: center;
        width: 320px;
        flex-shrink: 0;
    }
    
    .stage-task-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .stage-task-input::placeholder {
        color: #9ca3af;
    }
    
    .stage-task-description-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
    }
    
    .stage-task-description {
        flex: 1;
        padding: 0;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        font-family: inherit;
        resize: none;
        height: 0;
        transition: border-color 0.2s, opacity 0.2s, max-height 0.2s, padding 0.2s, height 0.2s;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        margin: 0;
        border-width: 0;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .stage-task-priority-tags-wrapper {
        width: 320px;
        flex-shrink: 0;
        padding: 0 8px;
    }
    
    .stage-task-description.show {
        opacity: 1;
        max-height: 80px;
        height: 80px;
        margin-top: 0;
        padding: 8px 12px;
        border-width: 1px;
    }
    
    .stage-task-description:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .stage-task-description::placeholder {
        color: #9ca3af;
    }
    
    .stage-task-priority-tags {
        display: flex;
        flex-direction: row;
        gap: 6px;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.2s, max-height 0.2s;
        width: 100%;
        flex-wrap: nowrap;
    }
    
    .stage-task-priority-tags.show {
        opacity: 1;
        max-height: 80px;
        padding: 8px;
    }
    
    .priority-tag {
        flex: 1;
        padding: 6px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        white-space: nowrap;
        text-align: center;
        min-width: 0;
    }
    
    /* Priority tag in active backlog should not take full width */
    .active-backlog-task-content .priority-tag {
        flex: 0 0 auto;
    }
    
    .priority-tag.priority-low {
        background-color: #f3f4f6;
        color: #6b7280;
        border-color: #e5e7eb;
    }
    
    .priority-tag.priority-medium {
        background-color: #dbeafe;
        color: #1e40af;
        border-color: #bfdbfe;
    }
    
    .priority-tag.priority-high {
        background-color: #fef3c7;
        color: #92400e;
        border-color: #fde68a;
    }
    
    .priority-tag.priority-urgent {
        background-color: #fee2e2;
        color: #991b1b;
        border-color: #fecaca;
    }
    
    .priority-tag.selected {
        font-weight: 600;
        box-shadow: 0 0 0 2px currentColor;
    }
    
    .priority-tag:hover {
        opacity: 0.8;
        transform: scale(1.05);
    }
    
    .btn-add-task:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .stage-row .stage-tasks-section {
        border-radius: 0;
    }
    
    .stage-row .stage-tasks-section.expanded {
        border-radius: 0 0 12px 12px;
    }

    /* When stage is open, apply hover background colors */
    .stage-row:has(.stage-tasks-section.expanded) .stage-content-wrapper {
        background: #f3f4f6;
    }
    
    /* Removed expanded state background colors - using only left border for progress status */

    .stage-row:hover .stage-content-wrapper,
    .stage-row:hover .stage-task-input-section,
    .stage-row:hover .stage-tasks-section {
        background: #f3f4f6;
    }
    
    /* Removed yellow hover background for created status - uses same hover as other statuses */
    
    .stage-row:hover .stage-content-wrapper.progress-disabled {
        background: #e5e7eb;
    }
    
    /* Disabled stage styling - only apply to content, NOT the row itself or dropdown */
    .stage-row-disabled {
        background: #f9fafb !important;
    }
    
    .stage-row-disabled:hover {
        background: #f3f4f6 !important;
    }
    
    /* Apply opacity only to content sections, leaving dropdown completely untouched */
    .stage-row-disabled .stage-main-wrapper,
    .stage-row-disabled .stage-drag-section,
    .stage-row-disabled .stage-progress-section {
        opacity: 0.7;
    }
    
    /* Drag Grip Section */
    .stage-drag-section {
        padding: 16px 0px 16px 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: grab;
        border-radius: 12px 0 0 0;
    }
    
    .stage-row:hover .stage-drag-section .drag-grip {
        opacity: 0.5;
        color: #64748b;
    }
    
    .stage-drag-section:active {
        cursor: grabbing;
    }

    /* Drag Handle */
    .drag-grip {
        cursor: grab;
        color: #64748b;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        opacity: 0; /* Hidden by default for clean look */
        user-select: none;
        -webkit-user-select: none;
    }
    .drag-grip:hover {
        color: #1f2937;
    }
    .drag-grip:active {
        cursor: grabbing;
    }
    
    /* Stage Main Wrapper (clickable area for stage detail) */
    .stage-main-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        cursor: pointer;
        transition: background 0.15s ease;
        min-width: 0; /* Allows text truncation */
        border-radius: 0;
    }
    
    
    /* Row Actions Section */
    .row-actions-section {
        padding: 16px 12px 16px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border-radius: 0 12px 0 0;
    }
    
    .stage-row:hover .row-actions-section .row-actions,
    .stage-row .row-actions-section .row-actions:has(.dropdown-menu.show) {
        opacity: 1;
    }
    
    /* Sortable styles */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6;
    }
    
    .sortable-drag {
        opacity: 0.8;
    }

    /* Stage Info */
    .stage-main {
        flex: 1;
        min-width: 0; /* Allows text truncation */
    }

    .stage-title-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stage-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stage-meta {
        font-size: 0.8rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Stage Progress Section */
    .stage-progress-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 180px;
        flex-shrink: 0;
    }

    .stage-progress-bar-container {
        width: 100%;
        max-width: 200px;
    }

    .stage-progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .stage-progress-bar {
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        overflow: hidden;
        position: relative;
    }

    .stage-progress-fill {
        height: 100%;
        transition: width 0.3s ease-out;
        border-radius: 3px;
        position: relative;
    }

    .stage-tasks-count {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .stage-tasks-count i {
        font-size: 0.85rem;
        color: #6b7280;
        color: #000000;
    }

    .stage-tasks-count.no-tasks {
        color: #6b7280;
    }

    .stage-tasks-count.no-tasks i {
        color: #6b7280;
    }

    /* Status Tags */
    .status-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .status-tag.completed { background-color: #10b981; color: white; }
    .status-tag.pending { background-color: #3b82f6; color: white; }
    .status-tag.created { background-color: #fbbf24; color: white; }
    .status-tag.overdue { background-color: #ef4444; color: white; }
    .status-tag.disabled { background-color: #6b7280; color: white; }
    
    /* Expandable Task Section */
    .stage-tasks-section {
        width: 100%;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.1s ease-out, padding 0.1s ease-out, margin 0.1s ease-out;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        padding: 0;
        margin: 0;
        border-radius: 0;
    }
    
    .stage-tasks-section.expanded {
        max-height: 2000px;
        padding: 0;
        margin: 0;
        border-radius: 0 0 12px 12px;
    }
    
    .stage-tasks-header {
        padding: 14px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .stage-tasks-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .stage-tasks-select-all-checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        position: relative;
        margin-left: 20px;
        flex-shrink: 0;
    }
    
    .stage-tasks-select-all-checkbox.checked {
        background: #10b981;
        border-color: #10b981;
    }
    
    .stage-tasks-select-all-checkbox.checked::after {
        content: 'âœ“';
        color: white;
        font-size: 14px;
        font-weight: bold;
        line-height: 1;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .stage-tasks-header-actions {
        display: flex;
        flex-direction: row;
        gap: 8px;
        align-items: center;
    }
    
    .btn-sort-tasks {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        color: #64748b;
        font-size: 0.875rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 32px;
    }
    
    .btn-sort-tasks:hover {
        background: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }
    
    .btn-sort-tasks.active {
        background: #f1f5f9;
    }
    
    .btn-sort-tasks:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f9fafb;
        border-color: #e5e7eb;
        color: #9ca3af;
    }
    
    .btn-sort-tasks:disabled:hover {
        background: #f9fafb;
        border-color: #e5e7eb;
        color: #9ca3af;
        border-color: #3b82f6;
        color: #3b82f6;
    }
    
    .stage-tasks-actions-select {
        position: relative;
    }
    
    .custom-select-trigger-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: auto;
        min-width: 120px;
        padding: 6px 16px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        color: #1e293b;
        font-size: 0.875rem;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 32px;
    }
    
    .custom-select-trigger-actions:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        border-color: #e5e7eb;
    }
    
    .custom-select-trigger-actions:not(:disabled):hover {
        border-color: #d1d5db;
    }
    
    .custom-select-trigger-actions i {
        color: #64748b;
        font-size: 0.75rem;
        transition: transform 0.2s ease;
        margin-left: 8px;
    }
    
    .stage-tasks-actions-select.active .custom-select-trigger-actions i {
        transform: rotate(180deg);
    }
    
    .custom-select-menu-actions {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 10005;
        min-width: 160px;
    }
    
    .stage-tasks-actions-select.active .custom-select-menu-actions {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .custom-select-item-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #1e293b;
        text-decoration: none;
        transition: background 0.2s ease;
        border: none;
        background: transparent;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
    }
    
    .custom-select-item-actions.first-item {
        border-radius: 12px 12px 0 0;
    }
    
    .custom-select-item-actions.last-item {
        border-radius: 0 0 12px 12px;
    }
    
    .custom-select-item-actions:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }
    
    .custom-select-item-actions.first-item.last-item {
        border-radius: 12px;
    }
    
    .custom-select-item-actions.first-item.last-item:hover {
        border-radius: 12px;
    }
    
    .custom-select-item-actions.first-item:hover {
        border-radius: 12px 12px 0 0;
    }
    
    .custom-select-item-actions.last-item:hover {
        border-radius: 0 0 12px 12px;
    }
    
    .custom-select-item-actions i {
        width: 16px;
        color: inherit;
    }
    
    .stage-tasks-list {
        display: flex;
        flex-direction: column;
        gap: 0;
    }
    
    .stage-task-item {
        display: flex;
        align-items: stretch;
        gap: 0;
        padding: 0;
        background: white;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.15s ease;
    }
    
    .stage-task-item:hover {
        background: #f9fafb;
    }
    
    .stage-task-item.completed {
        background: white;
        border-left: 3px solid #10b981;
    }
    
    .stage-task-item.completed:hover {
        background: #f9fafb;
    }
    
    .stage-task-drag-handle {
        padding: 8px 8px 8px 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: grab;
        color: #64748b;
        flex-shrink: 0;
        width: 48px;
        opacity: 0;
        transition: all 0.2s;
        border-radius: 4px;
        user-select: none;
        -webkit-user-select: none;
    }
    
    .stage-task-item:hover .stage-task-drag-handle {
        opacity: 1;
    }
    
    .stage-task-drag-handle:hover {
        background: #f1f5f9;
        color: #1f2937;
    }
    
    .stage-task-drag-handle:active {
        cursor: grabbing;
    }
    
    .stage-task-drag-handle i {
        font-size: 0.875rem;
    }
    
    .stage-task-checkbox-container {
        padding: 12px 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        width: 40px;
    }
    
    .stage-task-checkbox {
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        position: relative;
    }
    
    .stage-task-checkbox.checked {
        background: #10b981;
        border-color: #10b981;
    }
    
    .stage-task-checkbox.checked::after {
        content: 'âœ“';
        color: white;
        font-size: 14px;
        font-weight: bold;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        line-height: 1;
    }
    
    .stage-task-content {
        flex: 1;
        padding: 12px 0;
        min-width: 0;
        cursor: pointer;
    }
    
    .stage-task-content:hover .stage-task-title {
        color: #111827;
    }
    
    .stage-task-title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
    }
    
    .stage-task-title-row .stage-task-title {
        flex: 1;
        min-width: 0;
        margin-bottom: 0;
    }
    
    .stage-task-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
    }
    
    .stage-task-item.completed .stage-task-title {
        text-decoration: line-through;
        color: #6b7280;
    }
    
    .stage-task-item.completed .stage-task-description-text {
        color: #9ca3af;
    }
    
    .stage-task-description-text {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 4px;
        line-height: 1.4;
    }
    
    .stage-task-priority-display {
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: pointer;
        width: 100px;
    }
    
    
    .stage-task-activate {
        padding: 0;
        display: flex;
        align-items: stretch;
        justify-content: center;
        flex-shrink: 0;
        width: 120px;
    }
    
    .stage-task-activate-btn {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.75rem;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 0;
        transition: all 0.2s;
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        position: relative;
    }
    
    .stage-task-activate-btn:hover {
        background: #f3f4f6;
        color: #374151;
    }
    
    /* Change "Not Active" button to "Activate" on hover */
    .stage-task-activate-btn:not(.active):not(.completed):not(.archived):hover {
        background: #d1fae5;
        color: #047857;
        font-weight: 700;
        animation: none !important;
        padding-left: 20px;
    }
    
    .stage-task-activate-btn.active {
        color: #10b981;
    }
    
    .stage-task-activate-btn.active:hover {
        background: #fee2e2;
        color: #ef4444;
        font-weight: 700;
        padding-left: 12px;
    }
    
    .stage-task-activate-btn.completed {
        color: #059669;
        font-weight: 700;
        position: relative;
    }
    
    .stage-task-activate-btn.completed:hover {
        color: #ffffff;
        background: #6b7280;
        font-weight: 700;
    }
    
    .stage-task-activate-btn.archived {
        color: #6b7280;
        font-style: italic;
    }
    
    .stage-task-activate-btn.archived:hover {
        color: #4b5563;
    }
    
    /* Disable hover effects for archived buttons in history view */
    .stage-tasks-list[data-filter="history"] .stage-task-activate-btn.archived {
        cursor: default;
    }
    
    .stage-tasks-list[data-filter="history"] .stage-task-activate-btn.archived:hover {
        background: none;
        color: #6b7280;
    }
    
    /* Calmer blinking animation for activate button on task row hover - exactly 3 blinks */
    @keyframes blink-attention {
        0%, 11%, 22%, 33.33%, 44%, 55%, 66.66%, 77%, 88%, 100% { background-color: transparent; }
        5.5%, 27.5%, 49.5% { background-color: rgba(209, 213, 219, 0.3); }
    }
    
    .stage-task-item:hover .stage-task-activate-btn:not(.archived):not(.active):not(.completed):not(:hover) {
        animation: blink-attention 2s ease-in-out;
        animation-iteration-count: 1;
    }
    
    /* Stop blinking when hovering directly on button */
    .stage-task-activate-btn:not(.archived):not(.active):not(.completed):hover {
        animation: none !important;
    }
    
    /* Disable blinking in history view */
    .stage-tasks-list[data-filter="history"] .stage-task-item:hover .stage-task-activate-btn {
        animation: none;
    }
    
    .task-filter-select {
        padding: 6px 28px 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background: white;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        outline: none;
        transition: all 0.2s;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
        min-width: 120px;
        max-width: 110px;
        height: 32px;
        margin-bottom: 0;
    }
    
    .task-filter-select:hover {
        background-color: #f9fafb;
        border-color: #d1d5db;
        color: #374151;
    }
    
    .task-filter-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        background-color: white;
    }
    
    .task-filter-select option {
        padding: 8px 12px;
        font-size: 0.875rem;
    }
    
    .review-completed-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151;
        transition: all 0.2s;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .review-completed-badge:hover {
        background: #f9fafb;
        border-color: #d1d5db;
    }
    
    .review-completed-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: #ef4444;
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .to-be-reviewed-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        color: #374151;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .to-be-reviewed-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        background: #ef4444;
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        line-height: 1;
    }
    
    .stage-task-item.archived {
        opacity: 0.6;
    }
    
    .stage-task-item.fade-out {
        opacity: 0;
        transform: translateX(-20px);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        pointer-events: none;
    }
    
    .stage-task-item.fade-in {
        opacity: 0;
        transform: translateX(20px);
        animation: fadeInSlide 0.4s ease-out forwards;
    }
    
    .active-backlog-task-item.fade-out {
        opacity: 0;
        transform: translateX(-20px);
        transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        pointer-events: none;
    }
    
    .active-backlog-task-item.fade-in {
        opacity: 0;
        transform: translateX(20px);
        animation: fadeInSlide 0.4s ease-out forwards;
    }
    
    @keyframes fadeInSlide {
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .stage-task-actions {
        padding: 0 12px 0 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        width: 52px;
    }
    
    .stage-task-delete-btn {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        user-select: none;
        -webkit-user-select: none;
    }
    
    .stage-task-item:hover .stage-task-delete-btn {
        opacity: 1;
    }
    
    .stage-task-delete-btn:hover {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .stage-tasks-empty {
        text-align: center;
        padding: 32px;
        color: #64748b;
    }
    
    .stage-tasks-empty-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 16px;
    }
    
    .btn-create-task, .btn-ai-generate {
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        font-size: 0.875rem;
        height: 40px;
        width: auto;
        white-space: nowrap;
    }
    
    .btn-create-task {
        background: #3b82f6;
        color: white;
        padding: 10px 18px;
    }
    
    .btn-create-task:hover {
        background: #2563eb;
    }
    
    .btn-ai-generate {
        background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #ec4899 100%);
        color: white;
        padding: 10px 36px;
        box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
    }
    
    .btn-ai-generate::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    
    .btn-ai-generate:hover:not(:disabled) {
        background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 50%, #db2777 100%);
        box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
    }
    
    .btn-ai-generate:hover:not(:disabled)::before {
        left: 100%;
    }
    
    .btn-ai-generate:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: linear-gradient(135deg, #94a3b8 0%, #94a3b8 50%, #94a3b8 100%);
        box-shadow: none;
    }
    
    .btn-ai-generate:disabled::before {
        display: none;
    }
    
    .btn-ai-generate i,
    .btn-create-task i {
        font-size: 0.9em;
        display: inline-block;
    }

    /* Actions */
    .row-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
        position: relative;
        flex-shrink: 0;
    }
    
    /* Keep row actions visible when dropdown is active */
    .stage-row .row-actions.has-active-dropdown,
    .stage-row:hover .row-actions,
    .stage-row .row-actions:has(.dropdown-menu.show) {
        opacity: 1;
    }

    .action-icon-btn {
        padding: 6px;
        border-radius: 6px;
        color: #64748b;
        border: none;
        background: transparent;
        cursor: pointer;
    }
    .action-icon-btn:hover {
        background: #f1f5f9;
        color: #1f2937;
    }
    .action-icon-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Stage actions dropdown: same structure as upcoming sessions, option styling (red delete, roundness) */
    .stage-actions-menu .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #1e293b;
        border: none;
        background: transparent;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
        transition: background 0.2s ease;
    }

    .stage-actions-menu .dropdown-item.first-item {
        border-radius: 12px 12px 0 0;
    }

    .stage-actions-menu .dropdown-item.last-item {
        border-radius: 0 0 12px 12px;
    }

    .stage-actions-menu .dropdown-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .stage-actions-menu .dropdown-item.first-item:hover {
        border-radius: 12px 12px 0 0;
    }

    .stage-actions-menu .dropdown-item.last-item:hover {
        border-radius: 0 0 12px 12px;
    }

    .stage-actions-menu .dropdown-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .stage-actions-menu .dropdown-item:hover i {
        color: #10b981;
    }

    .stage-actions-menu .dropdown-item.delete-item:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .stage-actions-menu .dropdown-item.delete-item:hover i {
        color: #ef4444;
    }

    /* Sidebar */
    .project-sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .project-meta-card {
        background: #1e293b;
        color: white;
        border-radius: 12px;
        padding: 24px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 24px;
    }
    
    .meta-bg-icon {
        position: absolute;
        bottom: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.05;
        transform: rotate(-15deg);
    }

    .project-title-lg {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .project-owner-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
    }

    /* Stats Grid */
    .mini-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .stat-box {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .stat-val { font-size: 1.25rem; font-weight: 700; color: #111827; }
    .stat-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Floating Action Button (Optional usage) */
    .fab-create {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.875rem;
        height: 40px;
        white-space: nowrap;
        transition: background 0.2s;
    }
    .fab-create:hover { background: #2563eb; }

    /* AI Button styling is now global in dashboard.css */
</style>
{% endblock %}

{% block dashboard_content %}
{% include 'dashboard_user/projects/modals/create_stage_modal.html' %}
{% include 'dashboard_user/projects/modals/manage_modules_modal.html' %}
{% include 'dashboard_user/popups/create_active_backlog_task_modal.html' %}

<!-- Project Settings Modal -->
<div id="projectSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-container" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Project Settings</h2>
            <button class="modal-close" onclick="window.closeProjectSettingsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form id="projectSettingsForm">
                {% csrf_token %}
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Project Title -->
                    <div>
                        <label for="projectTitleInput" style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                            Project Title <span style="color: #ef4444;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="projectTitleInput" 
                            name="title" 
                            required
                            value="{{ project.title }}"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; font-family: 'Inter', -apple-system, sans-serif; color: #1e293b; transition: all 0.2s ease; box-sizing: border-box; background: #fcfcfd;"
                            onfocus="this.style.borderColor='#111827'; this.style.background='#ffffff'; this.style.boxShadow='0 0 0 4px rgba(17, 24, 39, 0.05)';"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.background='#fcfcfd'; this.style.boxShadow='none';"
                        >
                    </div>
                    
                    <!-- Project Description -->
                    <div>
                        <label for="projectDescriptionInput" style="display: block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">
                            Description
                        </label>
                        <textarea 
                            id="projectDescriptionInput" 
                            name="description" 
                            rows="6"
                            style="width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; font-family: 'Inter', -apple-system, sans-serif; color: #1e293b; transition: all 0.2s ease; box-sizing: border-box; background: #fcfcfd; resize: vertical; line-height: 1.6;"
                            onfocus="this.style.borderColor='#111827'; this.style.background='#ffffff'; this.style.boxShadow='0 0 0 4px rgba(17, 24, 39, 0.05)';"
                            onblur="this.style.borderColor='#e5e7eb'; this.style.background='#fcfcfd'; this.style.boxShadow='none';"
                        >{{ project.description|default:'' }}</textarea>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid #e5e7eb;">
            <button type="button" onclick="window.closeProjectSettingsModal()" style="padding: 10px 20px; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                Cancel
            </button>
            <button type="button" onclick="saveProjectSettings()" style="padding: 10px 20px; background: #111827; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                Save Changes
            </button>
        </div>
    </div>
</div>

<script>
    window.openProjectSettingsModal = function() {
        const modal = document.getElementById('projectSettingsModal');
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    };
    
    window.closeProjectSettingsModal = function() {
        const modal = document.getElementById('projectSettingsModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };
    
    function saveProjectSettings() {
        const title = document.getElementById('projectTitleInput').value.trim();
        const description = document.getElementById('projectDescriptionInput').value.trim();
        
        if (!title) {
            if (typeof showNotification !== 'undefined') {
                showNotification('Project title is required', 'error');
            } else {
                alert('Project title is required');
            }
            return;
        }
        
        fetch('{% url "general:dashboard_user:project_detail" project.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'update',
                title: title,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.closeProjectSettingsModal();
                // Reload page to show updated data
                window.location.reload();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update project', 'error');
                } else {
                    alert(data.error || 'Failed to update project');
                }
            }
        })
        .catch(error => {
            console.error('Error updating project:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred. Please try again.', 'error');
            } else {
                alert('An error occurred. Please try again.');
            }
        });
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('projectSettingsModal');
        if (e.target === modal) {
            window.closeProjectSettingsModal();
        }
    });
    
    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('projectSettingsModal');
            if (modal && modal.classList.contains('active')) {
                window.closeProjectSettingsModal();
            }
        }
    });
</script>

<script>
    // Check if user has subscription access to AI features
    function checkAISubscription() {
        {% if user.user_profile %}
        const subscription = '{{ user.user_profile.subscription|default:"FREE" }}';
        {% else %}
        const subscription = 'FREE';
        {% endif %}
        return subscription !== 'FREE';
    }
    
    // Show toast notification for FREE subscription users
    function showFreeSubscriptionToast() {
        if (typeof showNotification !== 'undefined') {
            showNotification('AI tools are not available in free subscription', 'error');
        } else {
            alert('AI tools are not available in free subscription');
        }
    }

    // Define modal functions early so they're available for onclick handlers
    // Assign Project Owner Modal Functions - Make them globally accessible early
    window.openAssignProjectOwnerModal = function() {
        var modal = document.getElementById('assignProjectOwnerModal');
        var emailInput = document.getElementById('assignOwnerEmailInput');
        var assignBtn = document.getElementById('assignOwnerBtn');
        
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(function() {
                modal.classList.add('active');
            }, 10);
            if (emailInput) {
                emailInput.value = '';
                emailInput.focus();
            }
            if (assignBtn) assignBtn.disabled = true;
        }
    };
    
    window.closeAssignProjectOwnerModal = function() {
        var modal = document.getElementById('assignProjectOwnerModal');
        var emailInput = document.getElementById('assignOwnerEmailInput');
        var suggestions = document.getElementById('assignOwnerEmailSuggestions');
        
        if (modal) {
            modal.classList.remove('active');
            setTimeout(function() {
                modal.style.display = 'none';
            }, 300);
        }
        if (emailInput) emailInput.value = '';
        if (suggestions) {
            suggestions.hidden = true;
            suggestions.innerHTML = '';
        }
    };
    
    // Define questionnaire modal functions early so they're available for onclick handlers
    window.openQuestionnaireModal = function() {
        console.log('openQuestionnaireModal called');
        const modal = document.getElementById('questionnaireModal');
        console.log('Modal element:', modal);
        if (modal) {
            console.log('Adding active class to modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('Modal classes:', modal.className);
            
            // Reload server-side answers when reopening (prioritize server answers over localStorage)
            const form = document.getElementById('slideQuestionnaireForm');
            if (form) {
                // Clear localStorage to prevent it from overriding server-side answers
                localStorage.removeItem('slideQuestionnaireAnswers');
                
                // Force reload all input values from their current HTML values (template values)
                // This ensures we get the fresh values that were rendered from the server
                // For date inputs specifically, we need to ensure the value is set correctly
                const dateInputs = form.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    // The template should have set the value, but we can verify it's there
                    // If the value is empty but the data attribute has a value, use that
                    if (!input.value && input.hasAttribute('data-initial-value')) {
                        input.value = input.getAttribute('data-initial-value');
                    }
                });
                
                // Load multiselect answers from data attributes (server-side)
                const multiselectWrappers = form.querySelectorAll('.multiselect-wrapper[data-answer-value]');
                multiselectWrappers.forEach(wrapper => {
                    const answerValue = wrapper.dataset.answerValue;
                    if (answerValue) {
                        const values = answerValue.split(',').map(v => v.trim());
                        const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = values.includes(checkbox.value);
                        });
                    } else {
                        // Clear checkboxes if no answer
                        wrapper.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    }
                });
                
                // IMPORTANT: The template already sets the values in the HTML via the get_item filter
                // But loadAnswers() might override them with localStorage. We need to ensure template values win.
                
                // First, explicitly set all input values from their current HTML values (which come from template)
                // This ensures we're using the server-side values that were just rendered
                const allInputs = form.querySelectorAll('input[type="text"], input[type="date"], input[type="number"], textarea, select');
                allInputs.forEach(input => {
                    // The value attribute is already set by the template, so input.value should be correct
                    // But we can also check data-initial-value as backup
                    if (input.hasAttribute('data-initial-value')) {
                        const initialValue = input.getAttribute('data-initial-value');
                        if (initialValue && (!input.value || input.value.trim() === '')) {
                            input.value = initialValue;
                        }
                    }
                    // Log to debug
                    console.log(`Input ${input.name}: value="${input.value}", data-initial-value="${input.getAttribute('data-initial-value') || ''}"`);
                });
                
                // Call loadAnswers with prioritizeServerAnswers=true to skip localStorage
                // This will only load multiselect from template and skip localStorage entirely
                if (typeof loadAnswers === 'function') {
                    loadAnswers(true);
                } else {
                    // Fallback: manually load multiselect if loadAnswers doesn't exist
                    const multiselectWrappers = form.querySelectorAll('.multiselect-wrapper[data-answer-value]');
                    multiselectWrappers.forEach(wrapper => {
                        const answerValue = wrapper.dataset.answerValue;
                        if (answerValue) {
                            const values = answerValue.split(',').map(v => v.trim());
                            const checkboxes = wrapper.querySelectorAll('input[type="checkbox"]');
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = values.includes(checkbox.value);
                            });
                        }
                    });
                }
                
                // Reset to first slide when reopening
                const slides = form.querySelectorAll('.question-slide');
                if (slides.length > 0) {
                    slides.forEach((slide, index) => {
                        slide.classList.remove('active');
                        if (index === 0) {
                            slide.classList.add('active');
                        }
                    });
                    
                    // Update progress indicator
                    const progressFill = document.getElementById('progressFill');
                    const currentSlideSpan = document.getElementById('currentSlide');
                    if (progressFill && currentSlideSpan) {
                        progressFill.style.width = ((1 / slides.length) * 100) + '%';
                        currentSlideSpan.textContent = '1';
                    }
                    
                    // Update navigation buttons
                    const prevBtn = document.querySelector('.btn-nav.prev');
                    const nextBtn = document.querySelector('.btn-nav.next');
                    if (prevBtn) prevBtn.style.display = 'none';
                    if (nextBtn) nextBtn.style.display = 'flex';
                }
            }
        }
    };

    window.closeQuestionnaireModal = function() {
        const modal = document.getElementById('questionnaireModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };
</script>

<!-- Assign Project Owner Modal -->
<div id="assignProjectOwnerModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeAssignProjectOwnerModal()" style="display: none;">
    <div class="target-date-modal-container">
        <div class="target-date-modal-header">
            <h3>Assign Project Owner</h3>
            <button type="button" class="target-date-modal-close" onclick="closeAssignProjectOwnerModal()" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="target-date-modal-body">
            <label class="schedule-session-label" for="assignOwnerEmailInput">Client email</label>
            <div class="schedule-session-input-wrap">
                <input
                    id="assignOwnerEmailInput"
                    class="schedule-session-input"
                    type="text"
                    placeholder="Search client by name or email"
                    name="assign_owner_email"
                    autocomplete="new-password"
                    autocapitalize="off"
                    autocorrect="off"
                    spellcheck="false"
                    inputmode="email"
                />
                <div id="assignOwnerEmailSuggestions" class="schedule-session-suggestions" hidden></div>
            </div>
        </div>
        <div class="target-date-modal-footer">
            <button type="button" class="btn-cancel" onclick="closeAssignProjectOwnerModal()" style="min-width: 100px;">Cancel</button>
            <button type="button" class="btn-confirm" id="assignOwnerBtn" onclick="assignProjectOwner()" disabled style="width: auto;">Assign Project</button>
        </div>
    </div>
</div>

<!-- Target Date Modal -->
<!-- Supervisor Modal -->
<div id="supervisorModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeSupervisorModal()" style="display: none;">
    <div class="target-date-modal-container">
        <div class="target-date-modal-header">
            <h3 id="supervisorModalTitle">Project Supervisor</h3>
        </div>
        <button class="target-date-modal-close" onclick="closeSupervisorModal()">
            <i class="fas fa-times"></i>
        </button>
        <div class="supervisor-modal-content">
            {% if project.supervised_by %}
                <!-- Normal View -->
                <div id="supervisorInfoView" class="supervisor-view">
                    <div class="supervisor-info">
                        <div class="supervisor-avatar-large">
                            {% if project.supervised_by.profile_picture %}
                                <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}">
                            {% else %}
                                <div class="supervisor-avatar-placeholder">
                                    {{ project.supervised_by.first_name|make_list|first|default:"M" }}{{ project.supervised_by.last_name|make_list|first|default:"" }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="supervisor-details">
                            <h4 class="supervisor-name">{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</h4>
                            {% if project.supervised_by.user.email %}
                                <p class="supervisor-email">
                                    <i class="fas fa-envelope"></i> {{ project.supervised_by.user.email }}
                                </p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="supervisor-actions">
                        {% if is_owner %}
                            <button type="button" class="btn-remove-supervisor" onclick="showRemoveConfirmation()">
                                <i class="fas fa-user-minus"></i> Remove Supervisor from this project
                            </button>
                        {% elif is_supervisor %}
                            <button type="button" class="btn-remove-supervisor" onclick="showRemoveConfirmation()">
                                <i class="fas fa-user-minus"></i> Remove myself as Supervisor from this project
                            </button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Confirmation View -->
                <div id="supervisorConfirmView" class="supervisor-view" style="display: none;">
                    <div class="supervisor-confirm-message">
                        <div class="confirm-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        {% if is_owner %}
                            <h4 class="confirm-title">Remove Supervisor?</h4>
                            <p class="confirm-text">Are you sure you want to remove {{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }} as the project supervisor? This action cannot be undone.</p>
                        {% else %}
                            <h4 class="confirm-title">Remove yourself as Supervisor?</h4>
                            <p class="confirm-text">Are you sure you want to remove yourself as the project supervisor? This action cannot be undone.</p>
                        {% endif %}
                    </div>
                    <div class="supervisor-actions">
                        <button type="button" class="btn-cancel-confirm" onclick="hideRemoveConfirmation()">
                            Cancel
                        </button>
                        <button type="button" class="btn-confirm-remove" onclick="confirmRemoveSupervisor()">
                            <i class="fas fa-user-minus"></i> Confirm Removal
                        </button>
                    </div>
                </div>
            {% else %}
                {% if is_owner %}
                    <!-- Select Mentor View -->
                    <div id="supervisorSelectView" class="supervisor-view">
                        <div style="margin-bottom: 20px;">
                            <p style="color: #64748b; font-size: 0.9rem; margin: 0 0 16px 0;">Select a mentor from your relationships to assign as project supervisor:</p>
                        </div>
                        {% if available_mentors %}
                        <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                            {% for mentor in available_mentors %}
                            <button type="button" class="mentor-select-item" onclick="selectMentor({{ mentor.id }}, '{{ mentor.first_name }} {{ mentor.last_name }}')" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left; width: 100%;">
                                {% if mentor.profile_picture %}
                                    <img src="{{ mentor.profile_picture.url }}" alt="{{ mentor.first_name }}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                    <div style="width: 48px; height: 48px; border-radius: 50%; background: #dbeafe; color: #1e40af; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem;">
                                        {{ mentor.first_name|make_list|first|default:"M" }}{{ mentor.last_name|make_list|first|default:"" }}
                                    </div>
                                {% endif %}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">{{ mentor.first_name }} {{ mentor.last_name }}</div>
                                    {% if mentor.user.email %}
                                    <div style="font-size: 0.85rem; color: #64748b;">{{ mentor.user.email }}</div>
                                    {% endif %}
                                </div>
                                <i class="fas fa-chevron-right" style="color: #94a3b8;"></i>
                            </button>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                            <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p style="margin: 0; font-size: 0.95rem;">You don't have any mentor relationships yet.</p>
                            <p style="margin: 8px 0 0; font-size: 0.85rem;">Connect with mentors to assign them as project supervisors.</p>
                        </div>
                        {% endif %}
                    </div>
                {% else %}
                    <p style="color: #94a3b8; text-align: center; padding: 20px;">No supervisor assigned</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<div id="targetDateModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeTargetDateModal()" style="display: none;">
    <div class="target-date-modal-container">
        <div class="target-date-modal-header">
            <h3 id="targetDateModalTitle">Set Target Date</h3>
        </div>
        <button class="target-date-modal-close" onclick="closeTargetDateModal()">
            <i class="fas fa-times"></i>
        </button>
        <form id="targetDateForm" onsubmit="saveTargetDate(event)">
            <div class="target-date-modal-body">
                <div class="form-group">
                    <label class="form-label">Target Completion Date</label>
                    <input type="date" name="target_date" id="targetDateInput" class="form-input" value="{% if project.target_completion_date %}{{ project.target_completion_date|date:'Y-m-d' }}{% endif %}">
                </div>
            </div>
            <div class="target-date-modal-footer">
                <button type="button" class="btn-cancel" onclick="closeTargetDateModal()">Cancel</button>
                <button type="submit" class="btn-confirm" id="targetDateSubmitBtn">Save</button>
            </div>
        </form>
    </div>
</div>

<div id="deleteConfirmModal" class="target-date-modal-overlay" onclick="if(event.target === this) closeDeleteConfirmModal()" style="display: none;">
    <div class="target-date-modal-container" style="max-width: 460px; min-width: 420px; min-height: auto;">
        <div class="target-date-modal-header">
            <h3 id="deleteConfirmModalTitle">Confirm Delete</h3>
        </div>
        <button class="target-date-modal-close" onclick="closeDeleteConfirmModal()">
            <i class="fas fa-times"></i>
        </button>
        <div class="target-date-modal-body">
            <p id="deleteConfirmModalMessage" class="delete-confirm-message">Are you sure you want to delete this item?</p>
        </div>
        <div class="target-date-modal-footer">
            <button type="button" class="btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
            <button type="button" class="btn-danger" id="deleteConfirmModalBtn" onclick="confirmDeleteConfirmModal()">Delete</button>
        </div>
    </div>
</div>

<div class="dashboard-content-container" style="max-width: 1200px; margin: 0 auto;">
    <div class="roadmap-container">
        <!-- Doc Header Section (Top Left) -->
        <div class="doc-header-section">
            <!-- Top Nav -->
            <div class="top-nav" style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center;">
                    <a href="{% url 'general:dashboard_user:projects_list' %}" class="nav-btn-back">
                        Projects
                    </a>
                    <span style="margin: 0 8px; color: #cbd5e1;">/</span>
                    <span style="color: #1e293b; font-weight: 600;">{{ project.title }}</span>
                </div>
            </div>
            <!-- Project Name, Description -->
            <div class="document-card">
                <div class="doc-header">
                    <div class="doc-header-left">
                        <h1 class="doc-title">{{ project.title }}</h1>
                        <div class="project-info-row">
                            <!-- Project Owner (for users, show "You" or their name) -->
                            {% if is_owner %}
                            <div class="project-info-item">
                                <div class="project-info-label">Project Owner</div>
                                <div class="project-info-btn" style="cursor: default; background: transparent; border: none; padding: 0;">
                                    {% if project.project_owner.profile_picture %}
                                        <img src="{{ project.project_owner.profile_picture.url }}" alt="{{ project.project_owner.first_name }}" class="project-info-avatar" style="width: 24px; height: 24px;">
                                    {% else %}
                                        <div class="project-info-avatar">
                                            {{ project.project_owner.first_name|make_list|first|default:"U" }}
                                        </div>
                                    {% endif %}
                                    <span>You</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Project Supervisor -->
                            <div class="project-info-item">
                                <div class="project-info-label">Project Supervisor</div>
                                {% if project.supervised_by %}
                                    {% if is_owner %}
                                        <button type="button" onclick="openSupervisorModal()" class="project-info-btn">
                                            {% if project.supervised_by.profile_picture %}
                                                <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}" class="project-info-avatar" style="width: 24px; height: 24px;">
                                            {% else %}
                                                <div class="project-info-avatar" style="background: #dbeafe; color: #1e40af;">
                                                    {{ project.supervised_by.first_name|make_list|first|default:"M" }}
                                                </div>
                                            {% endif %}
                                            <span>{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</span>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    {% else %}
                                        <div class="project-info-btn" style="cursor: default; background: transparent; border: none; padding: 0;">
                                            {% if project.supervised_by.profile_picture %}
                                                <img src="{{ project.supervised_by.profile_picture.url }}" alt="{{ project.supervised_by.first_name }}" class="project-info-avatar" style="width: 24px; height: 24px;">
                                            {% else %}
                                                <div class="project-info-avatar" style="background: #dbeafe; color: #1e40af;">
                                                    {{ project.supervised_by.first_name|make_list|first|default:"M" }}
                                                </div>
                                            {% endif %}
                                            <span>{{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}</span>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    {% if is_owner %}
                                        <button type="button" onclick="openSupervisorModal()" class="project-info-btn" style="background: #f0f9ff; border-color: #bae6fd; color: #0369a1;">
                                            <i class="fas fa-user-plus"></i>
                                            <span>Assign Supervisor</span>
                                        </button>
                                    {% else %}
                                        <div class="project-info-btn" style="cursor: default;">
                                            <span style="color: #94a3b8; font-style: italic;">Not assigned</span>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            <!-- Project Definition -->
                            <div class="project-info-item">
                                <div class="project-info-label">Project Definition</div>
                                <button type="button" onclick="window.openQuestionnaireModal()" class="project-info-btn {% if project.questionnaire_completed %}questionnaire-completed{% else %}target-date-warning{% endif %}">
                                    {% if project.questionnaire_completed %}
                                        <span class="project-info-status completed">
                                            <i class="fas fa-check-circle"></i> Completed
                                        </span>
                                    {% else %}
                                        <span class="project-info-status pending">
                                            <i class="fas fa-exclamation-triangle"></i> Pending
                                        </span>
                                    {% endif %}
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            
                            <!-- Target Completion Date -->
                            <div class="project-info-item">
                                <div class="project-info-label">Target Date</div>
                                <button type="button" onclick="openTargetDateModal()" class="project-info-btn {% if not project.target_completion_date %}target-date-warning{% endif %}">
                                    {% if project.target_completion_date %}
                                        <i class="far fa-calendar-check" style="color: #6366f1;"></i>
                                        <span>{{ project.target_completion_date|date:"M j, Y" }}</span>
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle" style="color: #92400e;"></i>
                                        <span style="color: #92400e;">Not set</span>
                                    {% endif %}
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="doc-header-right">
                        <div class="project-settings-dropdown-container" id="projectSettingsDropdown">
                            <button class="project-settings-dropdown-trigger" onclick="toggleProjectSettingsDropdown(event)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="project-settings-dropdown-menu" onclick="event.stopPropagation();">
                                <!-- Users can always edit project name and description via modal -->
                                <button class="project-settings-dropdown-item first-item" onclick="openProjectSettingsModal(); event.stopPropagation();">
                                    <i class="fas fa-edit"></i>
                                    <span>Edit Project</span>
                                </button>
                                {% if not project.supervised_by %}
                                    <!-- Only show delete if project is not supervised -->
                                    <button class="project-settings-dropdown-item delete-item last-item" onclick="deleteProject(); event.stopPropagation();">
                                        <i class="fas fa-trash"></i>
                                        <span>Delete Project</span>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="doc-body">
                    {% if project.description %}
                        {{ project.description|linebreaks }}
                    {% else %}
                        <div style="text-align: center; padding: 32px; display: flex; flex-direction: column; align-items: center; gap: 16px;">
                            <div style="color: #9ca3af; font-style: italic; margin-bottom: 8px;">
                                No description provided.
                            </div>
                            {% if not project.project_owner %}
                                <button type="button" onclick="openProjectSettingsModal()" style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px 0 rgba(99, 102, 241, 0.2); width: auto; margin: 0 auto;" onmouseover="this.style.background='linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%)'; this.style.boxShadow='0 4px 12px 0 rgba(99, 102, 241, 0.3)'; this.style.transform='translateY(-1px)';" onmouseout="this.style.background='linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)'; this.style.boxShadow='0 2px 4px 0 rgba(99, 102, 241, 0.2)'; this.style.transform='translateY(0)';">
                                    <i class="fas fa-edit"></i>
                                    <span>Add Description</span>
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% if not project.questionnaire_completed %}
                <!-- Modern Setup Required Card -->
                <div class="setup-required-card">
                    <div class="setup-required-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setup-required-content">
                        <h3 class="setup-required-title">Setup Required</h3>
                        <p class="setup-required-description">Complete the project questionnaire to unlock stage management and full project features.</p>
                        <button type="button" class="btn-setup-questionnaire" onclick="window.openQuestionnaireModal()">
                            <i class="fas fa-arrow-right"></i>
                            <span>Start Questionnaire</span>
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Questionnaire Modal (always available for viewing/editing) -->
            <div id="questionnaireModal" class="questionnaire-modal-overlay">
                <div class="questionnaire-modal-content">
                    <button class="questionnaire-modal-close" onclick="window.closeQuestionnaireModal()" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="questionnaire-modal-body">
                        {% include "general/reusable/slide_questionnaire.html" with questions=questions answers=answers %}
                    </div>
                </div>
            </div>

                <script>
                    // Functions are already defined in the earlier script block

                    // Set submit URL for the slide questionnaire
                    document.addEventListener('DOMContentLoaded', function() {
                        const form = document.getElementById('slideQuestionnaireForm');
                        if (form) {
                            form.dataset.submitUrl = '{% url "general:dashboard_user:submit_questionnaire" project.id %}';
                        }
                    });

                    // Close modal on overlay click (wait for DOM)
                    document.addEventListener('DOMContentLoaded', function() {
                        const modal = document.getElementById('questionnaireModal');
                        if (modal) {
                            modal.addEventListener('click', function(e) {
                                if (e.target === this) {
                                    window.closeQuestionnaireModal();
                                }
                            });
                        }
                    });

                    // Close modal on Escape key
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            window.closeQuestionnaireModal();
                        }
                    });
                </script>

                <style>
                    /* Modern Setup Required Card */
                    .setup-required-card {
                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                        border: 1px solid #fbbf24;
                        border-radius: 16px;
                        padding: 32px;
                        margin-bottom: 24px;
                        display: flex;
                        align-items: center;
                        gap: 24px;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                        transition: box-shadow 0.3s ease;
                    }

                    .setup-required-card:hover {
                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    }

                    .setup-required-icon {
                        width: 64px;
                        height: 64px;
                        background: white;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    }

                    .setup-required-icon i {
                        font-size: 28px;
                        color: #f59e0b;
                    }

                    .setup-required-content {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        align-items: flex-end;
                    }

                    .setup-required-title {
                        margin: 0 0 8px 0;
                        font-size: 1.25rem;
                        font-weight: 700;
                        color: #92400e;
                        letter-spacing: -0.02em;
                        width: 100%;
                    }

                    .setup-required-description {
                        margin: 0 0 20px 0;
                        color: #b45309;
                        font-size: 0.95rem;
                        line-height: 1.6;
                        width: 100%;
                    }

                    .btn-setup-questionnaire {
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                        background: #f59e0b;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 0.95rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: background 0.2s ease, box-shadow 0.2s ease;
                        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
                        width: auto;
                    }

                    .btn-setup-questionnaire:hover {
                        background: #d97706;
                        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
                    }

                    .btn-setup-questionnaire i {
                        font-size: 0.875rem;
                        transition: transform 0.2s ease;
                    }

                    .btn-setup-questionnaire:hover i {
                        transform: translateX(2px);
                    }

                    /* Questionnaire Modal */
                    .questionnaire-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(15, 23, 42, 0.6);
                        backdrop-filter: blur(8px);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        opacity: 0;
                        visibility: hidden;
                        transition: opacity 0.3s ease, visibility 0.3s ease;
                        padding: 20px;
                    }

                    .questionnaire-modal-overlay.active {
                        opacity: 1;
                        visibility: visible;
                    }

                    .questionnaire-modal-content {
                        background: white;
                        border-radius: 20px;
                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                        max-width: 800px;
                        width: 100%;
                        max-height: 90vh;
                        overflow: hidden;
                        position: relative;
                        display: flex;
                        flex-direction: column;
                        transform: scale(0.95) translateY(20px);
                        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                    }

                    .questionnaire-modal-overlay.active .questionnaire-modal-content {
                        transform: scale(1) translateY(0);
                    }

                    .questionnaire-modal-close {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #f1f5f9;
                        border: none;
                        color: #64748b;
                        font-size: 1.1rem;
                        cursor: pointer;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: all 0.2s ease;
                        z-index: 20;
                    }

                    .questionnaire-modal-close:hover {
                        background: #e2e8f0;
                        color: #1e293b;
                        transform: rotate(90deg);
                    }

                    .questionnaire-modal-body {
                        padding: 40px;
                        overflow-y: auto;
                        max-height: calc(100vh - 80px);
                    }

                    /* Remove card styling from slide questionnaire in modal */
                    .questionnaire-modal-body .slide-questionnaire-container {
                        background: transparent;
                        border-radius: 0;
                        padding: 0;
                        box-shadow: none;
                        max-width: 100%;
                        margin: 0;
                    }

                    @media (max-width: 768px) {
                        .setup-required-card {
                            flex-direction: column;
                            text-align: center;
                            padding: 24px;
                        }

                        .questionnaire-modal-content {
                            max-width: 100%;
                            max-height: 100vh;
                            border-radius: 0;
                        }

                        .questionnaire-modal-body {
                            padding: 24px;
                        }
                    }
                    
                    /* Notes Section Styles */
                    .notes-section {
                        padding: 40px;
                        background: #ffffff;
                    }
                    
                    .section-heading-minimal {
                        font-size: 0.9rem;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                        color: #94a3b8;
                        font-weight: 700;
                        margin-bottom: 24px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .note-composer {
                        background: #f8fafc;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 24px;
                        margin-bottom: 32px;
                    }
                    
                    .note-composer textarea {
                        width: 100%;
                        border: none;
                        background: transparent;
                        resize: vertical;
                        min-height: 80px;
                        font-size: 1rem;
                        outline: none;
                        color: #1f2937;
                        margin-bottom: 12px;
                        font-family: inherit;
                    }

                    .note-item {
                        margin-bottom: 32px;
                        display: grid;
                        grid-template-columns: 48px 1fr;
                        gap: 16px;
                    }
                    
                    .note-avatar {
                        width: 48px;
                        height: 48px;
                        border-radius: 50%;
                        background: #e2e8f0;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 600;
                        color: #64748b;
                        flex-shrink: 0;
                    }
                    
                    .note-header {
                        margin-bottom: 8px;
                        display: flex;
                        align-items: baseline;
                        gap: 10px;
                        flex-wrap: wrap;
                    }
                    
                    .note-author {
                        font-weight: 700;
                        color: #111827;
                        font-size: 0.95rem;
                    }
                    
                    .note-time {
                        font-size: 0.8rem;
                        color: #9ca3af;
                    }
                    
                    .note-role-badge {
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f1f5f9;
                        color: #64748b;
                        border-radius: 12px;
                        text-transform: uppercase;
                        font-weight: 600;
                    }
                </style>
        </div>
        
        <!-- Main List -->
        <main>
            <!-- Waterfall Chart -->
            <div id="waterfallChartContainer" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0 0 20px 0;">
                    <i class="fas fa-chart-line" style="color: #10b981; margin-right: 8px;"></i>
                    Project Timeline
                </h3>
                <div id="waterfallChart" style="min-height: 200px; position: relative;">
                    <!-- Chart will be rendered here by JavaScript -->
                </div>
            </div>

            <div class="roadmap-list-section">
                <div class="roadmap-header">
                    <h2>
                        <i class="fas fa-layer-group" style="color: #9ca3af; font-size: 1rem;"></i>
                        Roadmap Stages
                        <span id="stagesCount" style="font-size: 0.8rem; color: #6b7280; font-weight: 500; margin-left: 8px;">
                            0 Stages
                        </span>
                    </h2>
                    <div class="roadmap-header-actions">
                        <button onclick="if(typeof debugStagesLoading === 'function') { debugStagesLoading(); } else { console.log('Debug function not available'); }" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; color: #6b7280; font-size: 0.75rem; cursor: pointer; margin-right: 8px;" title="Debug stages loading">
                            <i class="fas fa-bug"></i> Debug
                        </button>
                        <button onclick="if(typeof loadStages === 'function') { loadStages(); } else { console.error('loadStages not available'); }" style="padding: 8px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; color: #6b7280; font-size: 0.75rem; cursor: pointer; margin-right: 8px;" title="Manually reload stages">
                            <i class="fas fa-sync"></i> Reload
                        </button>
                        <button onclick="generateStagesAI()" id="generateStagesBtn" class="btn-ai-magic" title="Auto-Generate Stages with AI">
                            <i class="fas fa-wand-magic-sparkles"></i> <span id="generateStagesBtnText">Generate Stages with AI</span>
                        </button>
                        <button onclick="openCreateStageModal()" class="fab-create">
                            <i class="fas fa-plus"></i> New Stage
                        </button>
                    </div>
                </div>
                
                <div id="stagesList">
                    <div style="padding: 48px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>Loading stages...</p>
                    </div>
                </div>
            </div>
            
        </main>

        <!-- Sidebar Info -->
        <aside class="project-sidebar">
            <div class="project-meta-card">
                <!-- Project Completion Circle -->
                <div style="display: flex; flex-direction: column; align-items: center; padding-top: 24px;">
                    <div class="profile-completion-circle" style="position: relative; width: 140px; height: 140px;">
                        <svg width="140" height="140" viewBox="0 0 120 120" style="transform: scale(1.17);">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="rgba(255,255,255,0.2)"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="projectProgressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#ffffff"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: #ffffff; font-size: 1.3rem;">
                            <span id="projectCompletionText">0%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.8); text-align: center;">
                        Completed
                    </p>
                </div>
                
                <div style="position: relative; z-index: 2; width: 100%;">
                    <!-- Modules Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7;">Modules</div>
                            <button onclick="openManageModulesModal()" style="width: auto; height: 40px; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                <i class="fas fa-cog" style="margin-right: 4px;"></i> Manage
                            </button>
                        </div>
                        {% if active_modules %}
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            {% for module_instance in active_modules %}
                                <a href="{% url 'general:dashboard_user:module_detail' project.id module_instance.id %}" style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; color: white; transition: all 0.2s; min-height: 48px;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                    {% if module_instance.module.icon %}
                                        <i class="{{ module_instance.module.icon }}" style="font-size: 1.1rem; flex-shrink: 0;"></i>
                                    {% endif %}
                                    <span style="font-size: 0.9rem; font-weight: 500; line-height: 1.4;">{{ module_instance.module.name }}</span>
                                </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; font-style: italic; padding: 12px 0;">
                            No modules added yet
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

        </aside>
        
        <!-- Your Active Backlog Card -->
        <aside class="project-sidebar-backlog">
            <div id="userActiveBacklogCard" class="client-backlog-card" style="background: white !important; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 100%;">
                <div class="active-backlog-header-container" style="flex-shrink: 0; padding: 20px 20px 20px 20px;">
                    <h3 id="userBacklogTitle" class="active-backlog-title" style="font-size: 0.9rem; font-weight: 600; color: #1f2937; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clipboard-list" style="color: #10b981;"></i>
                        Your Backlog
                    </h3>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="backlog-sort-buttons" style="display: flex; gap: 4px;">
                            <button class="backlog-sort-btn" data-sort="priority" onclick="toggleProjectBacklogSort('priority')" title="Sort by Priority">
                                <i class="fas fa-sort-amount-down"></i>
                            </button>
                            <button class="backlog-sort-btn" data-sort="date" onclick="toggleProjectBacklogSort('date')" title="Sort by Date">
                                <i class="fas fa-calendar-alt"></i>
                            </button>
                        </div>
                        <button onclick="openCreateActiveBacklogTaskModal()" class="active-backlog-create-btn" style="font-size: 1.2rem; color: #ffffff; background: #111827; border: none; cursor: pointer; font-weight: 700; padding: 8px 16px; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; width: 40px; height: 40px;">
                            +
                        </button>
                    </div>
                </div>
                <div id="userActiveBacklogList" style="display: flex; flex-direction: column; gap: 0; flex: 1; min-height: 0; padding: 0; overflow-x: hidden;">
                    <div style="padding: 16px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 0.85rem;">Loading...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Project Notes Section - Full Width (Outside Grid) -->
    <div class="roadmap-notes-section">
            <div class="document-card" style="min-height: auto;">
                <div class="notes-section">
                    <div class="section-heading-minimal">
                        <i class="far fa-comments"></i> Project Notes & Updates
                    </div>
                    
                    <form method="POST" action="{% url 'general:dashboard_user:create_project_note' project.id %}" class="note-composer" id="projectNoteForm">
                        {% csrf_token %}
                        <textarea name="note_text" id="projectNoteText" placeholder="Add an update, observation, or note about this project..." required></textarea>
                        <div style="display: flex; justify-content: flex-end;">
                            <button type="submit" class="btn btn-primary" id="projectNoteSubmitBtn" style="padding: 12px 24px; font-size: 1rem;">
                                Post Update
                            </button>
                        </div>
                    </form>

                    <div class="notes-feed" id="projectNotesFeed">
                        {% for note in project_notes %}
                            <div class="note-item">
                                <div class="note-avatar">
                                    {% if note.author %}
                                        {{ note.author.first_name|first|default:"U" }}
                                    {% else %}
                                        {{ note.author_name|first|default:"U" }}
                                    {% endif %}
                                </div>
                                <div class="note-box">
                                    <div class="note-header">
                                        <span class="note-author">{{ note.author_name|default:"Unknown" }}</span>
                                        {% if note.author_role %}
                                            <span class="note-role-badge">{{ note.author_role }}</span>
                                        {% endif %}
                                        <span class="note-time">{{ note.created_at|date:"M d, H:i" }}</span>
                                    </div>
                                    <div style="color: #4b5563; line-height: 1.6;">{{ note.text|linebreaksbr }}</div>
                                </div>
                            </div>
                        {% empty %}
                            <div style="text-align: center; padding: 32px; color: #cbd5e1; border: 2px dashed #f1f5f9; border-radius: 12px;">
                                <i class="far fa-comment-dots" style="font-size: 2rem; margin-bottom: 12px;"></i>
                                <p>No updates yet.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    console.log('=== Stages script block STARTING ===');
    console.log('Script execution time:', new Date().toISOString());
    
    // Define debug function immediately so it's available early
    // Also make it available via a simpler name
    window.debugStages = function() {
        if (typeof window.debugStagesLoading === 'function') {
            return window.debugStagesLoading();
        } else {
            console.error('debugStagesLoading not yet defined');
        }
    };
    
    window.debugStagesLoading = function() {
        console.log('=== DEBUG: Stages Loading ===');
        console.log('1. Checking DOM elements:');
        const stagesList = document.getElementById('stagesList');
        console.log('   - stagesList:', stagesList ? 'FOUND' : 'NOT FOUND');
        console.log('   - stagesList element:', stagesList);
        
        console.log('2. Checking functions:');
        console.log('   - loadStages:', typeof loadStages === 'function' ? 'DEFINED' : 'NOT DEFINED');
        console.log('   - renderStages:', typeof renderStages === 'function' ? 'DEFINED' : 'NOT DEFINED');
        
        console.log('3. Checking API URL:');
        const apiUrl = '{% url "general:dashboard_user:get_stages_api" project.id %}';
        console.log('   - API URL:', apiUrl);
        console.log('   - Full URL:', window.location.origin + apiUrl);
        
        console.log('4. Testing fetch manually:');
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('   - Response status:', response.status);
            console.log('   - Response ok:', response.ok);
            console.log('   - Response headers:', Object.fromEntries(response.headers.entries()));
            return response.text();
        })
        .then(text => {
            console.log('   - Response text (first 500 chars):', text.substring(0, 500));
            try {
                const json = JSON.parse(text);
                console.log('   - Parsed JSON:', json);
            } catch (e) {
                console.error('   - Failed to parse as JSON:', e);
            }
        })
        .catch(error => {
            console.error('   - Fetch error:', error);
        });
        
        console.log('5. Current page state:');
        console.log('   - Document ready state:', document.readyState);
        console.log('   - Window location:', window.location.href);
        console.log('   - Project ID:', PROJECT_ID);
        
        console.log('=== END DEBUG ===');
    };
    
    console.log('Debug function defined. Call debugStagesLoading() to debug.');
    
    const PROJECT_ID = parseInt('{{ project.id }}');
    const STAGE_DETAIL_URL = '{% url "general:dashboard_user:stage_detail" project.id 0 %}'.replace('/0/', '/');
    const CLIENT_ID = {% if project.project_owner %}{{ project.project_owner.id }}{% else %}null{% endif %};
    var TARGET_COMPLETION_DATE = {% if project.target_completion_date %}'{{ project.target_completion_date|date:"Y-m-d" }}'{% else %}null{% endif %};
    let sortableInstance = null;
    
    console.log('PROJECT_ID:', PROJECT_ID);
    console.log('STAGE_DETAIL_URL:', STAGE_DETAIL_URL);
    console.log('TARGET_COMPLETION_DATE:', TARGET_COMPLETION_DATE);
    
    // Set roadmap container max-height based on tallest column
    window.setRoadmapContainerMaxHeight = function() {
        const roadmapContainer = document.querySelector('.roadmap-container');
        if (!roadmapContainer) return;
        
        // Get elements for column 1 (doc-header-section + main)
        const docHeaderSection = roadmapContainer.querySelector('.doc-header-section');
        const mainContent = roadmapContainer.querySelector('main');
        
        // Get elements for column 2 (project-sidebar + project-sidebar-backlog)
        const projectSidebar = roadmapContainer.querySelector('.project-sidebar');
        const projectSidebarBacklog = roadmapContainer.querySelector('.project-sidebar-backlog');
        
        // Calculate column heights
        let column1Height = 0;
        if (docHeaderSection) column1Height += docHeaderSection.offsetHeight;
        if (mainContent) {
            // Account for any top offset applied to main content
            const mainTop = parseFloat(mainContent.style.top) || 0;
            column1Height += mainContent.offsetHeight;
            // If main has negative top offset, it overlaps with doc-header, so subtract the overlap
            if (mainTop < 0) {
                column1Height += mainTop; // Subtract the overlap (mainTop is negative, so this reduces height)
            } else {
                // If no overlap, add the gap between doc-header and main
                const gap = 32;
                column1Height += gap;
            }
        }
        
        let column2Height = 0;
        if (projectSidebar) column2Height += projectSidebar.offsetHeight;
        if (projectSidebarBacklog) column2Height += projectSidebarBacklog.offsetHeight;
        
        // Add gap between rows (32px gap) for column 2
        const gap = 32;
        if (projectSidebar && projectSidebarBacklog) column2Height += gap;
        
        // Use the taller column
        const maxHeight = Math.max(column1Height, column2Height);
        
        // Set max-height on container, but ensure it's at least the current scrollHeight
        // to prevent clipping when content expands
        const currentScrollHeight = roadmapContainer.scrollHeight;
        const finalMaxHeight = Math.max(maxHeight, currentScrollHeight);
        
        // Set max-height on container
        roadmapContainer.style.maxHeight = finalMaxHeight + 'px';
    };
    
    // Update max-height on load and resize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setRoadmapContainerMaxHeight();
        });
    } else {
        setRoadmapContainerMaxHeight();
    }
    
    window.addEventListener('resize', setRoadmapContainerMaxHeight);
    
    // MutationObserver for content changes is set up later in the script to handle both max-height and offset recalculation
    
    // Render waterfall chart
    function renderWaterfallChart(stages) {
        const container = document.getElementById('waterfallChartContainer');
        const chartEl = document.getElementById('waterfallChart');
        
        // Store reference for drag handlers
        window.waterfallChartEl = chartEl;
        
        if (!container || !chartEl) return;
        
        if (!stages || stages.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        // Filter stages with dates
        const stagesWithDates = stages.filter(s => s.start_date && s.end_date);
        
        if (stagesWithDates.length === 0) {
            chartEl.innerHTML = `
                <div style="text-align: center; padding: 32px; color: #9ca3af;">
                    <i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0; font-size: 0.875rem;">Add start and end dates to stages to view timeline</p>
                </div>
            `;
            return;
        }
        
        // Calculate date range
        const dates = stagesWithDates.flatMap(s => [new Date(s.start_date), new Date(s.end_date)]);
        let originalMinDate = new Date(Math.min(...dates));
        let originalMaxDate = new Date(Math.max(...dates));
        
        // If project target date exists and is later than the latest stage end date, extend to include it
        {% if project.target_completion_date %}
        if (TARGET_COMPLETION_DATE) {
            const targetDate = new Date(TARGET_COMPLETION_DATE);
            targetDate.setHours(0, 0, 0, 0);
            if (targetDate > originalMaxDate) {
                originalMaxDate = new Date(targetDate);
            }
        }
        {% endif %}
        
        const originalRange = originalMaxDate - originalMinDate;
        
        // Extend the range by 10% on each side to allow dragging beyond boundaries
        const paddingPercent = 0.1; // 10% padding on each side
        const paddingMs = originalRange * paddingPercent;
        const minDate = new Date(originalMinDate.getTime() - paddingMs);
        const maxDate = new Date(originalMaxDate.getTime() + paddingMs);
        
        const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
        const totalMonths = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30));
        const totalYears = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 365));
        
        // Determine time unit and interval
        let timeUnit, interval, unitLabel;
        if (totalYears >= 2) {
            timeUnit = 'year';
            interval = Math.max(1, Math.floor(totalYears / 10));
            unitLabel = 'Years';
        } else if (totalMonths >= 2) {
            timeUnit = 'month';
            interval = Math.max(1, Math.floor(totalMonths / 10));
            unitLabel = 'Months';
        } else {
            timeUnit = 'day';
            interval = Math.max(1, Math.floor(totalDays / 10));
            unitLabel = 'Days';
        }
        
        // Generate axis labels (use original date range for labels, but position them on extended range)
        const axisLabels = [];
        const numLabels = 6; // Show 6 labels on the axis
        for (let i = 0; i <= numLabels; i++) {
            const progress = i / numLabels;
            // Calculate label date based on original range
            let labelDate = new Date(originalMinDate.getTime() + (originalMaxDate - originalMinDate) * progress);
            let labelText;
            
            if (timeUnit === 'year') {
                labelText = labelDate.getFullYear().toString();
            } else if (timeUnit === 'month') {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            } else {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Calculate position on extended range
            const extendedProgress = ((labelDate - minDate) / (maxDate - minDate)) * 100;
            
            axisLabels.push({
                position: extendedProgress,
                label: labelText
            });
        }
        
        const chartHeight = 80 + (stagesWithDates.length * 50);
        chartEl.style.height = chartHeight + 'px';
        
        // Calculate today's position (on extended range)
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset to start of day for accurate comparison
        const todayPosition = today >= minDate && today <= maxDate 
            ? ((today - minDate) / (maxDate - minDate)) * 100 
            : null;
        
        // Calculate target completion date position (on extended range)
        let targetDatePosition = null;
        {% if project.target_completion_date %}
        if (TARGET_COMPLETION_DATE) {
            const targetDate = new Date(TARGET_COMPLETION_DATE);
            targetDate.setHours(0, 0, 0, 0); // Reset to start of day for accurate comparison
            targetDatePosition = targetDate >= minDate && targetDate <= maxDate 
                ? ((targetDate - minDate) / (maxDate - minDate)) * 100 
                : null;
        }
        {% endif %}
        
        let chartHtml = `
            <div class="waterfall-chart-inner" style="position: relative; height: ${chartHeight}px; padding: 20px 0 60px 0;">
                ${todayPosition !== null ? `
                    <!-- Today indicator line (blue) -->
                    <div class="current-time-line" style="position: absolute; left: ${todayPosition}%; top: 0; bottom: 0; width: 2px; background: #3b82f6; z-index: 100; pointer-events: none; transform: translateX(-50%);">
                        <div style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid #3b82f6;"></div>
                    </div>
                ` : ''}
                ${targetDatePosition !== null ? `
                    <!-- Target completion date indicator line (red) -->
                    <div class="target-date-line" style="position: absolute; left: ${targetDatePosition}%; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 100; pointer-events: none; transform: translateX(-50%);">
                        <div style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 6px solid #ef4444;"></div>
                    </div>
                ` : ''}
                <!-- Timeline axis -->
                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; border-top: 2px solid #e5e7eb;">
                    ${axisLabels.map(label => `
                        <div style="position: absolute; left: ${label.position}%; transform: translateX(-50%); top: 8px;">
                            <div style="width: 2px; height: 8px; background: #9ca3af; margin: 0 auto;"></div>
                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px; white-space: nowrap;">${label.label}</div>
                        </div>
                    `).join('')}
                    ${todayPosition !== null ? `
                        <div style="position: absolute; left: ${todayPosition}%; transform: translateX(-50%); top: -18px;">
                            <div style="width: 2px; background: #3b82f6; margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: #3b82f6; margin-bottom: 12px; white-space: nowrap; font-weight: 600;">Today</div>
                        </div>
                    ` : ''}
                    ${targetDatePosition !== null ? `
                        <div style="position: absolute; left: ${targetDatePosition}%; transform: translateX(-50%); top: -18px;">
                            <div style="width: 2px; background: #ef4444; margin: 0 auto;"></div>
                            <div style="font-size: 0.65rem; color: #ef4444; margin-bottom: 12px; white-space: nowrap; font-weight: 600;">Target Date</div>
                        </div>
                    ` : ''}
                    <div style="position: absolute; top: -20px; left: 0; font-size: 0.7rem; color: #9ca3af; font-weight: 500;">${unitLabel}</div>
                </div>
        `;
        
        stagesWithDates.forEach((stage, index) => {
            const startDate = new Date(stage.start_date);
            const endDate = new Date(stage.end_date);
            const daysFromStart = Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const leftPercent = (daysFromStart / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            const top = 20 + (index * 50);
            
            // Check if stage is disabled first - disabled stages get grey styling
            const isDisabled = stage.is_disabled || false;
            
            // Determine color based on progress_status (only if not disabled)
            let color = '#3b82f6'; // default blue
            const progressStatus = stage.progress_status || (stage.is_completed ? 'completed' : 'in_progress');
            if (!isDisabled) {
                switch(progressStatus) {
                    case 'completed':
                        color = '#10b981'; // green
                        break;
                    case 'overdue':
                        color = '#ef4444'; // red
                        break;
                    case 'in_progress':
                        color = '#3b82f6'; // blue
                        break;
                    case 'created':
                        color = '#fbbf24'; // yellow
                        break;
                }
            }
            
            // Calculate task progress for stages
            const totalTasks = stage.tasks_total || 0;
            const completedTasks = stage.tasks_completed || 0;
            const taskProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            // Create progress bar effect for in_progress, overdue, and created stages
            let barStyle = '';
            let progressBarHtml = '';
            
            if (isDisabled) {
                // Disabled stage - grey styling
                barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: move; opacity: 0.7;`;
            } else if (progressStatus === 'in_progress') {
                if (totalTasks > 0) {
                    // Transparent blue background with solid blue progress fill (has tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #3b82f6; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    // Transparent blue background only (no tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(59, 130, 246, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move;`;
                }
            } else if (progressStatus === 'overdue') {
                if (totalTasks > 0) {
                    // Transparent red background with solid red progress fill (has tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #ef4444; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    // Transparent red background only (no tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(239, 68, 68, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move;`;
                }
            } else if (progressStatus === 'created') {
                if (totalTasks > 0 && completedTasks > 0) {
                    // Transparent yellow background with solid yellow progress fill (has completed tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(251, 191, 36, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move; overflow: hidden;`;
                    progressBarHtml = `<div style="position: absolute; left: 0; top: 0; bottom: 0; width: ${taskProgress}%; background: #fbbf24; border-radius: 4px 0 0 4px; z-index: 1;"></div>`;
                } else {
                    // Transparent yellow background only (no tasks or no completed tasks)
                    barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: rgba(251, 191, 36, 0.2); border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move;`;
                }
            } else {
                // Solid color for completed status
                barStyle = `position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: ${color}; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move;`;
            }
            
            // Determine text styling based on progress status or disabled state
            let textColor = 'white';
            let textBackground = '';
            let textShadow = '0 1px 2px rgba(0,0,0,0.3)';
            
            if (isDisabled) {
                // Disabled stage - grey text
                textColor = '#6b7280';
                textBackground = '';
                textShadow = 'none';
            } else if (progressStatus === 'in_progress' || progressStatus === 'overdue' || progressStatus === 'created') {
                // Light backgrounds - use dark text with semi-transparent background for readability
                textColor = '#1e293b';
                textBackground = 'background: rgba(255, 255, 255, 0.85); padding: 2px 8px; border-radius: 4px;';
                textShadow = 'none';
            }
            
            chartHtml += `
                <div 
                    class="waterfall-stage-bar" 
                    data-stage-id="${stage.id}"
                    data-start-date="${stage.start_date}"
                    data-end-date="${stage.end_date}"
                    style="${barStyle}"
                    title="${stage.title}"
                >
                    ${progressBarHtml}
                    <div class="waterfall-resize-handle waterfall-resize-left" style="position: absolute; left: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); border-radius: 4px 0 0 4px; z-index: 3;"></div>
                    <span style="font-size: 0.75rem; color: ${textColor}; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; text-align: center; pointer-events: none; position: relative; z-index: 2; text-shadow: ${textShadow}; ${textBackground}">${stage.title}</span>
                    <div class="waterfall-resize-handle waterfall-resize-right" style="position: absolute; right: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); border-radius: 0 4px 4px 0; z-index: 3;"></div>
                </div>
            `;
        });
        
        chartHtml += '</div>';
        chartEl.innerHTML = chartHtml;
        
        // Initialize drag handlers for waterfall bars
        // Pass all stages (not just those with dates) for reordering
        initWaterfallDragHandlers(stages, minDate, maxDate, totalDays);
        
        // Recalculate positions after rendering chart
        setTimeout(() => {
            setRoadmapContainerMaxHeight();
            setMainContentOffset();
        }, 100);
    }
    
    // Initialize drag handlers for waterfall chart bars
    function initWaterfallDragHandlers(stages, minDate, maxDate, totalDays) {
        const chartEl = window.waterfallChartEl;
        if (!chartEl) return;
        
        const bars = chartEl.querySelectorAll('.waterfall-stage-bar');
        let isDragging = false;
        let dragType = null; // 'move', 'resize-left', 'resize-right', 'move-and-reorder'
        let currentBar = null;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let startWidth = 0;
        let startDate = null;
        let endDate = null;
        let startIndex = 0;
        let handleMouseMove = null;
        let handleMouseUp = null;
        let dragThreshold = 5; // pixels to move before starting drag
        let hasMovedHorizontally = false;
        let hasMovedVertically = false;
        
        bars.forEach((bar, index) => {
            const resizeLeft = bar.querySelector('.waterfall-resize-left');
            const resizeRight = bar.querySelector('.waterfall-resize-right');
            
            // Move entire bar (can be horizontal and/or vertical simultaneously)
            bar.addEventListener('mousedown', function(e) {
                if (e.target === resizeLeft || e.target === resizeRight) return;
                isDragging = true;
                dragType = null; // Will be determined after threshold
                currentBar = bar;
                startX = e.clientX;
                startY = e.clientY;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startTop = rect.top - chartRect.top;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                startIndex = index;
                hasMovedHorizontally = false;
                hasMovedVertically = false;
                bar.style.cursor = 'grabbing';
                bar.style.zIndex = '1000';
                bar.style.opacity = '0.7';
                e.preventDefault();
            });
            
            // Resize left edge
            resizeLeft.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragType = 'resize-left';
                currentBar = bar;
                startX = e.clientX;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                e.stopPropagation();
                e.preventDefault();
            });
            
            // Resize right edge
            resizeRight.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragType = 'resize-right';
                currentBar = bar;
                startX = e.clientX;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                e.stopPropagation();
                e.preventDefault();
            });
        });
        
        // Create or update date popover
        let datePopover = null;
        function showDatePopover(x, y, dateStr, label) {
            if (!datePopover) {
                datePopover = document.createElement('div');
                datePopover.id = 'waterfallDatePopover';
                datePopover.style.cssText = 'position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; z-index: 10001; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); white-space: nowrap; display: none;';
                document.body.appendChild(datePopover);
            }
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            datePopover.textContent = `${label}: ${formattedDate}`;
            datePopover.style.display = 'block';
            
            // Position popover above the cursor/bar edge
            // First get the popover width to center it properly
            const popoverWidth = datePopover.offsetWidth || 150; // fallback width
            datePopover.style.left = (x - popoverWidth / 2) + 'px';
            datePopover.style.top = (y - 40) + 'px';
        }
        
        function hideDatePopover() {
            if (datePopover) {
                datePopover.style.display = 'none';
            }
        }
        
        // Create placeholder indicator for reordering
        let placeholderLine = null;
        function showReorderPlaceholder(y) {
            // Find the inner chart container where bars are positioned
            const chartInner = chartEl.querySelector('.waterfall-chart-inner');
            if (!chartInner) return;
            
            if (!placeholderLine) {
                placeholderLine = document.createElement('div');
                placeholderLine.id = 'waterfallReorderPlaceholder';
                placeholderLine.style.cssText = 'position: absolute; left: 0; right: 0; height: 2px; background: #cbd5e1; z-index: 999; pointer-events: none;';
                chartInner.appendChild(placeholderLine);
            }
            // y is already relative to the inner container (accounts for 20px top padding)
            placeholderLine.style.top = y + 'px';
            placeholderLine.style.display = 'block';
        }
        
        function hideReorderPlaceholder() {
            if (placeholderLine) {
                placeholderLine.style.display = 'none';
            }
        }
        
        // Mouse move handler
        handleMouseMove = function(e) {
            if (!isDragging || !currentBar) return;
            
            const chartRect = chartEl.getBoundingClientRect();
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const deltaPercent = (deltaX / chartRect.width) * 100;
            
            // Determine drag type if not yet determined (for resize handles, this is already set)
            if (!dragType) {
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);
                
                if (absDeltaX < dragThreshold && absDeltaY < dragThreshold) {
                    return; // Wait for threshold
                }
                
                // For main bar drag, allow simultaneous horizontal and vertical movement
                dragType = 'move-and-reorder';
            }
            
            if (dragType === 'move-and-reorder') {
                // Handle both horizontal (date) and vertical (reorder) movement simultaneously
                const currentY = e.clientY - chartRect.top;
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                
                // Vertical reordering
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentY - 20) / barSpacing)));
                
                // Only show placeholder if order would actually change
                if (newIndex !== startIndex) {
                    hasMovedVertically = true;
                    // Determine if dragging up or down from original position
                    const isDraggingDown = newIndex > startIndex;
                    
                    // Show placeholder at target position
                    let targetY;
                    if (isDraggingDown) {
                        targetY = 20 + (newIndex * barSpacing) + barHeight + 2;
                    } else {
                        targetY = 20 + (newIndex * barSpacing);
                    }
                    showReorderPlaceholder(targetY);
                } else {
                    hideReorderPlaceholder();
                }
                
                // Horizontal date movement
                const absDeltaX = Math.abs(deltaX);
                if (absDeltaX >= dragThreshold) {
                    hasMovedHorizontally = true;
                    const newLeft = Math.max(0, Math.min(100 - startWidth, startLeft + deltaPercent));
                    const newStartDate = new Date(minDate.getTime() + ((newLeft / 100) * totalDays) * 24 * 60 * 60 * 1000);
                    const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
                    const newEndDate = new Date(newStartDate.getTime() + duration * 24 * 60 * 60 * 1000);
                    
                    currentBar.style.left = newLeft + '%';
                    currentBar.dataset.startDate = newStartDate.toISOString().split('T')[0];
                    currentBar.dataset.endDate = newEndDate.toISOString().split('T')[0];
                    
                    // Show popover for dates
                    const barRect = currentBar.getBoundingClientRect();
                    showDatePopover(e.clientX, barRect.top, newStartDate.toISOString().split('T')[0], 'Start');
                }
                
                // Update visual position (both horizontal and vertical)
                currentBar.style.top = (currentY - barHeight / 2) + 'px';
                if (!hasMovedHorizontally) {
                    // Keep original horizontal position if not moved horizontally
                    currentBar.style.left = startLeft + '%';
                }
                currentBar.style.width = startWidth + '%';
            } else if (dragType === 'reorder') {
                // Vertical reordering only (legacy support)
                const currentY = e.clientY - chartRect.top;
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentY - 20) / barSpacing)));
                
                if (newIndex !== startIndex) {
                    hasMovedVertically = true;
                    const isDraggingDown = newIndex > startIndex;
                    let targetY;
                    if (isDraggingDown) {
                        targetY = 20 + (newIndex * barSpacing) + barHeight + 2;
                    } else {
                        targetY = 20 + (newIndex * barSpacing);
                    }
                    showReorderPlaceholder(targetY);
                } else {
                    hideReorderPlaceholder();
                }
                
                currentBar.style.top = (currentY - barHeight / 2) + 'px';
                currentBar.style.left = startLeft + '%';
                currentBar.style.width = startWidth + '%';
            } else if (dragType === 'move') {
                // Horizontal movement only (legacy support)
                hasMovedHorizontally = true;
                const newLeft = Math.max(0, Math.min(100 - startWidth, startLeft + deltaPercent));
                const newStartDate = new Date(minDate.getTime() + ((newLeft / 100) * totalDays) * 24 * 60 * 60 * 1000);
                const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
                const newEndDate = new Date(newStartDate.getTime() + duration * 24 * 60 * 60 * 1000);
                
                currentBar.style.left = newLeft + '%';
                currentBar.dataset.startDate = newStartDate.toISOString().split('T')[0];
                currentBar.dataset.endDate = newEndDate.toISOString().split('T')[0];
                
                const barRect = currentBar.getBoundingClientRect();
                showDatePopover(e.clientX, barRect.top, newStartDate.toISOString().split('T')[0], 'Start');
            } else if (dragType === 'resize-left') {
                // Resize from left - allow dragging beyond original boundaries
                const newLeft = Math.max(0, Math.min(startLeft + startWidth - 1, startLeft + deltaPercent));
                const newWidth = startWidth - (newLeft - startLeft);
                const newStartDate = new Date(minDate.getTime() + ((newLeft / 100) * totalDays) * 24 * 60 * 60 * 1000);
                
                if (newWidth > 0 && newStartDate < endDate) {
                    currentBar.style.left = newLeft + '%';
                    currentBar.style.width = newWidth + '%';
                    currentBar.dataset.startDate = newStartDate.toISOString().split('T')[0];
                    
                    // Show popover for start date at the left edge
                    showDatePopover(e.clientX, e.clientY, newStartDate.toISOString().split('T')[0], 'Start');
                }
            } else if (dragType === 'resize-right') {
                // Resize from right - allow dragging beyond original boundaries
                const newWidth = Math.max(1, Math.min(100 - startLeft, startWidth + deltaPercent));
                const newEndDate = new Date(minDate.getTime() + ((startLeft + newWidth) / 100) * totalDays * 24 * 60 * 60 * 1000);
                
                if (newEndDate > startDate) {
                    currentBar.style.width = newWidth + '%';
                    currentBar.dataset.endDate = newEndDate.toISOString().split('T')[0];
                    
                    // Show popover for end date at the right edge
                    showDatePopover(e.clientX, e.clientY, newEndDate.toISOString().split('T')[0], 'End');
                }
            }
        };
        
        // Mouse up handler - save changes
        handleMouseUp = function(e) {
            if (!isDragging || !currentBar) return;
            
            // Hide placeholders
            hideDatePopover();
            hideReorderPlaceholder();
            
            const stageId = currentBar.dataset.stageId;
            
            // Handle simultaneous move-and-reorder
            if (dragType === 'move-and-reorder') {
                const chartRect = chartEl.getBoundingClientRect();
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                
                // Use the bar's current visual position to determine new index
                const currentBarTop = parseFloat(currentBar.style.top) || startTop;
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentBarTop - 20 + barHeight / 2) / barSpacing)));
                
                const oldStartDate = startDate.toISOString().split('T')[0];
                const oldEndDate = endDate.toISOString().split('T')[0];
                const newStartDate = currentBar.dataset.startDate;
                const newEndDate = currentBar.dataset.endDate;
                
                // Track what needs to be updated
                const needsReorder = hasMovedVertically && newIndex !== startIndex;
                const needsDateUpdate = hasMovedHorizontally && (newStartDate !== oldStartDate || newEndDate !== oldEndDate);
                
                // Update reorder if needed
                if (needsReorder) {
                    const baseOrder = PROJECT_ID * 1000;
                    const orders = [];
                    const otherBars = allBars.filter(bar => bar !== currentBar);
                    otherBars.sort((a, b) => {
                        const aOrder = parseFloat(a.dataset.order) || 0;
                        const bOrder = parseFloat(b.dataset.order) || 0;
                        return aOrder - bOrder;
                    });
                    otherBars.splice(newIndex, 0, currentBar);
                    otherBars.forEach((bar, index) => {
                        orders.push({
                            stage_id: parseInt(bar.dataset.stageId),
                            order: baseOrder + index + 1
                        });
                    });
                    
                    fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/reorder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // If also updating dates, do that next; otherwise reload
                            if (needsDateUpdate) {
                                updateStageDates();
                            } else {
                                if (typeof showNotification !== 'undefined') {
                                    showNotification('Stage order updated', 'success');
                                }
                                loadStages();
                            }
                        } else {
                            console.error('Failed to reorder stages:', data.error);
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Failed to reorder stages', 'error');
                            }
                            loadStages();
                        }
                    })
                    .catch(error => {
                        console.error('Error reordering stages:', error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Error reordering stages', 'error');
                        }
                        loadStages();
                    });
                }
                
                // Update dates if needed
                const updateStageDates = () => {
                    const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    };
                    
                    fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/update-dates/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            start_date: newStartDate,
                            end_date: newEndDate
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let message = '';
                            if (needsReorder && needsDateUpdate) {
                                message = `Stage order and dates updated: ${formatDate(newStartDate)} - ${formatDate(newEndDate)}`;
                            } else if (needsDateUpdate) {
                                message = `Stage dates updated: ${formatDate(newStartDate)} - ${formatDate(newEndDate)}`;
                            } else if (needsReorder) {
                                message = 'Stage order updated';
                            }
                            
                            if (message && typeof showNotification !== 'undefined') {
                                showNotification(message, 'success');
                            }
                            loadStages();
                        } else {
                            console.error('Failed to update stage dates:', data.error);
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Failed to update stage dates', 'error');
                            }
                            loadStages();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating stage dates:', error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Error updating stage dates', 'error');
                        }
                        loadStages();
                    });
                };
                
                // If only date update needed (no reorder), do it directly
                if (needsDateUpdate && !needsReorder) {
                    updateStageDates();
                } else if (!needsReorder && !needsDateUpdate) {
                    // No changes, just restore
                    loadStages();
                }
            } else if (dragType === 'reorder') {
                // Handle reordering only
                const chartRect = chartEl.getBoundingClientRect();
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                
                const currentBarTop = parseFloat(currentBar.style.top) || startTop;
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentBarTop - 20 + barHeight / 2) / barSpacing)));
                
                if (newIndex !== startIndex) {
                    const baseOrder = PROJECT_ID * 1000;
                    const orders = [];
                    const otherBars = allBars.filter(bar => bar !== currentBar);
                    otherBars.sort((a, b) => {
                        const aOrder = parseFloat(a.dataset.order) || 0;
                        const bOrder = parseFloat(b.dataset.order) || 0;
                        return aOrder - bOrder;
                    });
                    otherBars.splice(newIndex, 0, currentBar);
                    otherBars.forEach((bar, index) => {
                        orders.push({
                            stage_id: parseInt(bar.dataset.stageId),
                            order: baseOrder + index + 1
                        });
                    });
                    
                    fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/reorder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Stage order updated', 'success');
                            }
                            loadStages();
                        } else {
                            console.error('Failed to reorder stages:', data.error);
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Failed to reorder stages', 'error');
                            }
                            loadStages();
                        }
                    })
                    .catch(error => {
                        console.error('Error reordering stages:', error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Error reordering stages', 'error');
                        }
                        loadStages();
                    });
                } else {
                    loadStages();
                }
            } else {
                // Handle date updates only (move or resize)
                const oldStartDate = startDate.toISOString().split('T')[0];
                const oldEndDate = endDate.toISOString().split('T')[0];
                const newStartDate = currentBar.dataset.startDate;
                const newEndDate = currentBar.dataset.endDate;
                
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                };
                
                let notificationMessage = '';
                if (dragType === 'resize-left' && newStartDate !== oldStartDate) {
                    notificationMessage = `Start date updated to ${formatDate(newStartDate)}`;
                } else if (dragType === 'resize-right' && newEndDate !== oldEndDate) {
                    notificationMessage = `End date updated to ${formatDate(newEndDate)}`;
                } else if (dragType === 'move' && (newStartDate !== oldStartDate || newEndDate !== oldEndDate)) {
                    notificationMessage = `Stage dates updated: ${formatDate(newStartDate)} - ${formatDate(newEndDate)}`;
                }
                
                fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/update-dates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        start_date: newStartDate,
                        end_date: newEndDate
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (notificationMessage && typeof showNotification !== 'undefined') {
                            showNotification(notificationMessage, 'success');
                        }
                        loadStages();
                    } else {
                        console.error('Failed to update stage dates:', data.error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Failed to update stage dates', 'error');
                        }
                        loadStages();
                    }
                })
                .catch(error => {
                    console.error('Error updating stage dates:', error);
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Error updating stage dates', 'error');
                    }
                    loadStages();
                });
            }
            
            // Reset
            isDragging = false;
            dragType = null;
            if (currentBar) {
                currentBar.style.cursor = 'move';
                currentBar.style.zIndex = '';
                currentBar.style.opacity = '';
            }
            currentBar = null;
            
            // Remove event listeners
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
    
    // Render project completion progress circle
    function renderProjectProgress(stages) {
        const progressCircle = document.getElementById('projectProgressCircle');
        const completionText = document.getElementById('projectCompletionText');
        
        if (!progressCircle || !completionText) return;
        
        if (!stages || stages.length === 0) {
            completionText.textContent = '0%';
            progressCircle.style.strokeDashoffset = '326.73';
            progressCircle.style.stroke = '#e5e7eb';
            return;
        }
        
        // Calculate completion based on tasks across all stages (exclude disabled stages)
        let totalTasks = 0;
        let completedTasks = 0;
        
        stages.forEach(stage => {
            // Skip disabled stages in completion calculation
            if (stage.is_disabled) {
                return;
            }
            const stageTotal = stage.tasks_total || 0;
            const stageCompleted = stage.tasks_completed || 0;
            totalTasks += stageTotal;
            completedTasks += stageCompleted;
        });
        
        // Calculate percentage
        const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        function getProgressColor(pct) {
            if (pct >= 90) return '#059669'; // Dark green
            if (pct >= 70) return '#10b981'; // Green
            if (pct >= 40) return '#f59e0b'; // Orange
            return '#ef4444'; // Red
        }
        
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        completionText.textContent = percentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }
    
    // Render stages from API data
    function renderStages(stages) {
        console.log('=== renderStages() called ===');
        console.log('Stages parameter:', stages);
        console.log('Stages type:', typeof stages);
        console.log('Stages is array:', Array.isArray(stages));
        console.log('Stages length:', stages?.length || 0);
        
        const container = document.getElementById('stagesList');
        const countEl = document.getElementById('stagesCount');
        
        console.log('Container element:', container);
        console.log('Count element:', countEl);
        
        if (!container) {
            console.error('ERROR: stagesList container not found!');
            console.error('Available elements with "stage" in id:', Array.from(document.querySelectorAll('[id*="stage"]')).map(el => el.id));
            console.error('Document body:', document.body);
            return;
        }
        
        console.log('Container found! Starting to render', stages?.length || 0, 'stages');
        
        if (!countEl) {
            console.error('stagesCount element not found!');
        }
        
        // Render charts and progress
        renderWaterfallChart(stages);
        renderProjectProgress(stages);
        
        if (!stages || stages.length === 0) {
            console.log('No stages to render');
            container.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #9ca3af;">
                    <i class="fas fa-stream" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>No stages defined yet.</p>
                </div>
            `;
            if (countEl) {
                countEl.textContent = '0 Stages';
            }
            // Update AI Generate button text when no stages
            const generateStagesBtnText = document.getElementById('generateStagesBtnText');
            if (generateStagesBtnText) {
                generateStagesBtnText.textContent = 'Generate Stages with AI';
            }
            return;
        }
        
        console.log(`Rendering ${stages.length} stages`);
        if (countEl) {
            countEl.textContent = `${stages.length} Stage${stages.length !== 1 ? 's' : ''}`;
        }
        
        // Update AI Generate button text based on whether stages exist
        const generateStagesBtnText = document.getElementById('generateStagesBtnText');
        if (generateStagesBtnText) {
            generateStagesBtnText.textContent = stages.length > 0 ? 'Optimize Stages with AI' : 'Generate Stages with AI';
        }
        
        container.innerHTML = stages.map(stage => {
            let statusTag = '';
            let titleClass = '';
            let titleText = stage.title;
            const isDisabled = stage.is_disabled || false;
            const progressStatus = stage.progress_status || (stage.is_completed ? 'completed' : 'in_progress');
            let rowClass = 'stage-row';
            
            // Add progress status class for border color
            if (isDisabled) {
                rowClass = 'stage-row stage-row-disabled progress-disabled';
            } else {
                rowClass = `stage-row progress-${progressStatus}`;
            }
            
            // Determine status tag and colors based on progress_status (or disabled)
            // Note: progressStatus is already defined above
            let progressColor = '#e5e7eb';
            let statusTitle = '';
            
            if (isDisabled) {
                // Disabled stage styling
                statusTag = '<span class="status-tag disabled">Disabled</span>';
                progressColor = '#6b7280'; // Darker grey for better contrast
                statusTitle = 'Disabled';
                titleClass = 'style="color: #6b7280; opacity: 0.7;"';
            } else {
                switch(progressStatus) {
                    case 'completed':
                        statusTag = '<span class="status-tag completed">Completed</span>';
                        progressColor = '#10b981'; // Matches status-tag.completed background
                        statusTitle = 'Completed';
                        titleClass = 'style="text-decoration: line-through; color: #6b7280;"';
                        break;
                    case 'overdue':
                        statusTag = '<span class="status-tag overdue">Overdue</span>';
                        progressColor = '#ef4444'; // Matches status-tag.overdue background
                        statusTitle = 'Overdue';
                        break;
                    case 'in_progress':
                        statusTag = '<span class="status-tag pending">In Progress</span>';
                        progressColor = '#3b82f6'; // Matches status-tag.pending background
                        statusTitle = 'In Progress';
                        break;
                    case 'created':
                    default:
                        statusTag = '<span class="status-tag created">Created</span>';
                        progressColor = '#fbbf24'; // Matches status-tag.created background
                        statusTitle = 'Created';
                        break;
                }
            }
            
            // Calculate progress based on tasks
            const totalTasks = stage.tasks_total || 0;
            const completedTasks = stage.tasks_completed || 0;
            // Count of tasks with status='completed' for "To be Reviewed" badge (excludes archived)
            const completedStatusTasks = stage.tasks_completed_status || 0;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : (progressStatus === 'completed' ? 100 : 0);
            
            // Override progress color if progress is 0 (no tasks) or use status-based color
            // Using status tag colors for consistency
            if (isDisabled) {
                progressColor = '#6b7280'; // Matches status-tag.disabled background
            } else if (progress === 0 && progressStatus !== 'completed') {
                progressColor = '#d1d5db';
            } else if (progressStatus === 'completed') {
                progressColor = '#10b981'; // Matches status-tag.completed background
            } else if (progressStatus === 'overdue') {
                progressColor = '#ef4444'; // Matches status-tag.overdue background
            } else if (progressStatus === 'in_progress') {
                progressColor = '#3b82f6'; // Matches status-tag.pending background
            } else if (progressStatus === 'created') {
                progressColor = '#fbbf24'; // Matches status-tag.created background
            }
            
            // Format dates for display
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };
            
            const startDateDisplay = stage.start_date ? formatDate(stage.start_date) : null;
            const endDateDisplay = stage.end_date ? formatDate(stage.end_date) : null;
            
            let dateRangeHtml = '';
            if (startDateDisplay && endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> ${startDateDisplay} - ${endDateDisplay}</div>`;
            } else if (startDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Starts ${startDateDisplay}</div>`;
            } else if (endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Ends ${endDateDisplay}</div>`;
            }
            
            // Build the main content wrapper
            const mainContentHtml = `
                <div class="stage-content-wrapper progress-${isDisabled ? 'disabled' : progressStatus}">
                        <div class="stage-drag-section">
                            <div class="drag-grip">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        </div>
                        <div class="stage-main-wrapper" onclick="toggleStageTasks(${stage.id}, event);">
                            <div class="stage-main">
                                <div class="stage-title-meta">
                                    <div class="stage-title">
                                        ${statusTag}
                                        <span ${titleClass}>${titleText}</span>
                                        ${completedStatusTasks > 0 ? `
                                            <div class="to-be-reviewed-badge" title="To be Reviewed">
                                                To be Reviewed
                                                <span class="to-be-reviewed-count">${completedStatusTasks}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${dateRangeHtml}
                                </div>
                            </div>
                            <div class="stage-progress-section">
                                <div class="stage-progress-bar-container">
                                    <div class="stage-progress-label">
                                        <span>Progress</span>
                                        <span style="font-weight: 500; color: #6b7280;">${progress}%</span>
                                    </div>
                                    <div class="stage-progress-bar">
                                        <div class="stage-progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                                    </div>
                                </div>
                                <div class="stage-tasks-count ${totalTasks === 0 ? 'no-tasks' : ''}">
                                    ${totalTasks === 0 
                                        ? '<span style="color: #6b7280;">no tasks yet</span>'
                                        : `<i class="fas fa-tasks"></i><span>${completedTasks}/${totalTasks}</span>`
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="row-actions-section" onclick="event.stopPropagation();">
                            <div class="row-actions" id="rowActions_${stage.id}">
                                <div class="dropdown">
                                    <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <div class="dropdown-menu stage-actions-menu" onclick="event.stopPropagation();">
                                        <button type="button" class="dropdown-item stage-action-item first-item" onclick="editStage(${stage.id}); event.stopPropagation();">
                                            <i class="fas fa-edit"></i>
                                            <span>Edit</span>
                                        </button>
                                        <button type="button" class="dropdown-item stage-action-item delete-item last-item" onclick="deleteStage(${stage.id}); event.stopPropagation();">
                                            <i class="fas fa-trash"></i>
                                            <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            `;
            
            // Build task input section (shown for all stages when expanded)
            const taskInputSectionHtml = `
                <div class="stage-task-input-section" id="stageButtons_${stage.id}" style="display: none;">
                    <div class="stage-task-input-container">
                        <div class="stage-task-input-row">
                            <div class="stage-task-input-wrapper">
                                <input 
                                    type="text" 
                                    class="stage-task-input" 
                                    id="stageTaskInput_${stage.id}"
                                    placeholder="Enter task name..."
                                    onkeyup="handleTaskInputChange(${stage.id}, event)"
                                    onkeydown="handleTaskInputKeydown(${stage.id}, event)"
                                />
                                <button 
                                    type="button"
                                    class="stage-task-input-clear" 
                                    id="stageTaskInputClear_${stage.id}"
                                    onclick="clearTaskInput(${stage.id})"
                                    aria-label="Clear input"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="stage-task-buttons-wrapper">
                                <button 
                                    class="btn-create-task btn-add-task" 
                                    id="btnAddTask_${stage.id}"
                                    onclick="createTaskFromInput(${stage.id})" 
                                    disabled
                                    style="padding: 8px 16px; font-size: 0.875rem; white-space: nowrap;"
                                >
                                    <i class="fas fa-plus"></i> Add Task
                                </button>
                                <button 
                                    class="btn-ai-generate" 
                                    id="btnAiGenerate_${stage.id}"
                                    onclick="generateTasksAI(${stage.id})" 
                                    style="padding: 10px 36px; font-size: 0.875rem; white-space: nowrap;"
                                >
                                    <i class="fas fa-magic"></i> Optimize Tasks with AI
                                </button>
                            </div>
                        </div>
                        <div class="stage-task-description-row">
                            <textarea 
                                class="stage-task-description" 
                                id="stageTaskDescription_${stage.id}"
                                placeholder="Add description (optional)..."
                                rows="3"
                            ></textarea>
                            <div class="stage-task-priority-tags-wrapper">
                                <div class="stage-task-priority-tags" id="stageTaskPriorityTags_${stage.id}">
                                    <div class="priority-tag priority-low" data-priority="low" onclick="selectPriority(${stage.id}, 'low')">Low</div>
                                    <div class="priority-tag priority-medium selected" data-priority="medium" onclick="selectPriority(${stage.id}, 'medium')">Medium</div>
                                    <div class="priority-tag priority-high" data-priority="high" onclick="selectPriority(${stage.id}, 'high')">High</div>
                                    <div class="priority-tag priority-urgent" data-priority="urgent" onclick="selectPriority(${stage.id}, 'urgent')">Urgent</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return `
                <div class="${rowClass}" data-stage-id="${stage.id}">
                    <div class="stage-row-content">
                        ${mainContentHtml}
                        ${taskInputSectionHtml}
                    </div>
                    <div class="stage-tasks-section" id="stageTasks_${stage.id}" data-stage-id="${stage.id}">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            `;
        }).join('');
        
        // Initialize SortableJS after rendering
        initSortable();
        
        // Recalculate positions after rendering
        setTimeout(() => {
            setRoadmapContainerMaxHeight();
            setMainContentOffset();
        }, 100);
    }
    
    // Initialize SortableJS
    function initSortable() {
        const el = document.getElementById('stagesList');
        if (!el) return;
        
        // Destroy existing instance if any
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        // Wait for Sortable to be loaded
        if (typeof Sortable === 'undefined') {
            setTimeout(initSortable, 100);
            return;
        }
        
        sortableInstance = new Sortable(el, {
            animation: 150,
            handle: '.stage-drag-section',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            forceFallback: false,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            onStart: function(evt) {
                evt.item.style.opacity = '0.5';
            },
            onEnd: function(evt) {
                evt.item.style.opacity = '1';
                
                if (evt.newIndex === evt.oldIndex) return;
                
                const orders = [];
                const baseOrder = PROJECT_ID * 1000;
                
                el.querySelectorAll('.stage-row').forEach((row, index) => {
                    orders.push({
                        stage_id: parseInt(row.dataset.stageId),
                        order: baseOrder + index + 1
                    });
                });
                
                fetch('{% url "general:dashboard_user:reorder_stages" project.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ orders: orders })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to reorder stages:', data.error);
                        // Reload stages to restore correct order
                        loadStages();
                    } else {
                        // Re-render waterfall chart after successful reorder
                        loadStages();
                    }
                })
                .catch(error => {
                    console.error('Error reordering stages:', error);
                    loadStages();
                });
            }
        });
    }
    
    // Load stages from API
    function loadStages() {
        console.log('=== loadStages() called ===');
        const apiUrl = '{% url "general:dashboard_user:get_stages_api" project.id %}';
        console.log('API URL:', apiUrl);
        console.log('Full URL will be:', window.location.origin + apiUrl);
        
        // Verify URL is not empty
        if (!apiUrl || apiUrl.includes('None') || apiUrl.includes('undefined')) {
            console.error('Invalid API URL:', apiUrl);
            const stagesList = document.getElementById('stagesList');
            if (stagesList) {
                stagesList.innerHTML = `
                    <div style="padding: 48px 24px; text-align: center; background: #fee2e2; border-radius: 12px; margin: 16px 0; border: 1px solid #fecaca;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 28px; color: #dc2626; margin-bottom: 12px;"></i>
                        <p style="margin: 0 0 8px; color: #991b1b; font-weight: 500;">Configuration Error</p>
                        <p style="margin: 0 0 16px; font-size: 0.875rem; color: #7f1d1d;">Invalid API URL: ${apiUrl}</p>
                    </div>
                `;
            }
            return;
        }
        
        // Show loading state
        const stagesList = document.getElementById('stagesList');
        if (stagesList) {
            stagesList.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #9ca3af;">
                    <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>Loading stages...</p>
                </div>
            `;
        }
        
        // Save which stages have expanded task sections before reloading
        const expandedStages = [];
        document.querySelectorAll('.stage-tasks-section.expanded').forEach(section => {
            const stageId = section.id.replace('stageTasks_', '');
            if (stageId) {
                expandedStages.push(stageId);
            }
        });
        
        // Add timeout to fetch
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Request timeout after 10 seconds')), 10000);
        });
        
        const fetchPromise = fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        });
        
        Promise.race([fetchPromise, timeoutPromise])
            .then(response => {
                console.log('Response received, status:', response.status);
                console.log('Response headers:', response.headers);
                console.log('Response content-type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('API Error Response (status ' + response.status + '):', text.substring(0, 500));
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text.substring(0, 200)}`);
                    });
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Response is not JSON. Content-Type:', contentType);
                        console.error('Response body:', text.substring(0, 500));
                        throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 200)}`);
                    });
                }
                
                return response.json().catch(err => {
                    console.error('JSON parse error:', err);
                    return response.text().then(text => {
                        console.error('Response text that failed to parse:', text.substring(0, 500));
                        throw new Error(`Failed to parse JSON: ${err.message}. Response: ${text.substring(0, 200)}`);
                    });
                });
            })
            .then(data => {
                console.log('=== Stages API Response ===');
                console.log('Full response:', data);
                console.log('Success:', data?.success);
                console.log('Stages count:', data?.stages?.length || 0);
                console.log('Stages data:', data?.stages);
                
                if (data && data.success) {
                    console.log('API call successful! Rendering stages...');
                    console.log('Calling renderStages with:', data.stages);
                    renderStages(data.stages || []);
                    
                    // Restore expanded state for stages that were expanded before reload
                    if (expandedStages.length > 0) {
                        setTimeout(() => {
                            expandedStages.forEach(stageId => {
                                const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                                if (tasksSection && !tasksSection.classList.contains('expanded')) {
                                    // Expand the section
                                    tasksSection.classList.add('expanded');
                                    
                                    // Load tasks if not already loaded
                                    if (!tasksSection.dataset.loaded) {
                                        loadStageTasks(stageId);
                                    } else {
                                        // Just show the input section if tasks are already loaded
                                        const buttonsSection = document.getElementById(`stageButtons_${stageId}`);
                                        if (buttonsSection) {
                                            buttonsSection.style.display = 'block';
                                        }
                                    }
                                    
                                    // Update overlay state
                                    updateTasksOverlay();
                                }
                            });
                        }, 50);
                    }
                    
                    // Check header layout after rendering
                    setTimeout(() => {
                        const headerContainer = document.querySelector('.active-backlog-header-container');
                        if (headerContainer) {
                            const title = document.getElementById('clientBacklogTitle');
                            const button = document.querySelector('.active-backlog-create-btn');
                            if (title && button) {
                                const titleWidth = title.offsetWidth;
                                const buttonWidth = button.offsetWidth;
                                const containerWidth = headerContainer.offsetWidth;
                                
                                if (titleWidth + buttonWidth + 12 > containerWidth) {
                                    headerContainer.classList.add('column-layout');
                                } else {
                                    headerContainer.classList.remove('column-layout');
                                }
                            }
                        }
                    }, 100);
                    
                    // Recalculate positions after loading stages
                    setTimeout(() => {
                        setRoadmapContainerMaxHeight();
                        setMainContentOffset();
                    }, 150);
                } else {
                    console.error('Failed to load stages:', data?.error || 'Unknown error');
                    const errorMsg = data?.error || 'Unknown error';
                    var sl = document.getElementById('stagesList');
                    if (sl) {
                        sl.innerHTML = `
                            <div class="stages-load-error-state" style="padding: 48px 24px; text-align: center; background: #f8fafc; border-radius: 12px; margin: 16px 0; border: 1px solid #e2e8f0;">
                                <i class="fas fa-info-circle" style="font-size: 28px; color: #94a3b8; margin-bottom: 12px;"></i>
                                <p style="margin: 0 0 16px; color: #475569;">${errorMsg}</p>
                                <button type="button" onclick="if (typeof loadStages === 'function') loadStages();" class="btn-primary" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--dash-primary); color: white; font-weight: 500; cursor: pointer;"><i class="fas fa-redo" style="margin-right: 6px;"></i> Retry</button>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching stages:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                var stagesList = document.getElementById('stagesList');
                if (stagesList) {
                    var isTimeout = error.message && error.message.includes('timeout');
                    var isConnectionError = (error.message || '').toLowerCase().indexOf('fetch') !== -1 || 
                                          (error.message || '').toLowerCase().indexOf('network') !== -1 ||
                                          (error.message || '').toLowerCase().indexOf('timeout') !== -1;
                    var errorMessage = isTimeout ? 'Request timed out. The server may be slow or unresponsive.' :
                                          isConnectionError ? 'Connection was reset or interrupted. Check that the server is running and try again.' : 
                                          (error.message || 'Something went wrong.');
                    
                    stagesList.innerHTML = `
                        <div class="stages-load-error-state" style="padding: 48px 24px; text-align: center; background: #f8fafc; border-radius: 12px; margin: 16px 0; border: 1px solid #e2e8f0;">
                            <i class="fas fa-cloud-showers-heavy" style="font-size: 28px; color: #94a3b8; margin-bottom: 12px;"></i>
                            <p style="margin: 0 0 8px; color: #475569; font-weight: 500;">Couldn't load stages</p>
                            <p style="margin: 0 0 16px; font-size: 0.875rem; color: #64748b;">${errorMessage}</p>
                            <p style="margin: 0 0 16px; font-size: 0.75rem; color: #94a3b8; font-family: monospace;">${error.message || 'Unknown error'}</p>
                            <button type="button" onclick="if (typeof loadStages === 'function') loadStages();" class="btn-primary" style="padding: 10px 20px; border-radius: 8px; border: none; background: var(--dash-primary); color: white; font-weight: 500; cursor: pointer;">
                                <i class="fas fa-redo" style="margin-right: 6px;"></i> Retry
                            </button>
                        </div>
                    `;
                }
            });
    }
    
    
    // Backlog state variables
    let projectBacklogTasks = [];
    let projectBacklogSort = null;

    // Load user's active backlog
    function loadUserActiveBacklog() {
        const container = document.getElementById('userActiveBacklogList');
        
        if (!container) return;
        
        fetch('{% url "general:dashboard_user:get_user_active_backlog_api" %}?filter=todo', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                projectBacklogTasks = data.tasks || [];
                projectBacklogSort = null;
                document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
                applyProjectBacklogSort();
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                        <p style="margin: 0;">Error loading tasks</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading active backlog:', error);
            container.innerHTML = `
                <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0;">Error loading tasks</p>
                </div>
            `;
        });
    }

    // Toggle project backlog sort
    window.toggleProjectBacklogSort = function(sortType) {
        const btn = event.target.closest('.backlog-sort-btn');
        if (!btn) return;
        
        // If clicking the same button, toggle it off
        if (projectBacklogSort === sortType) {
            projectBacklogSort = null;
            btn.classList.remove('active');
        } else {
            // Remove active from all buttons
            document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
            // Set new sort
            projectBacklogSort = sortType;
            btn.classList.add('active');
        }
        
        // Apply sort
        applyProjectBacklogSort();
    };

    // Apply sorting to project backlog tasks
    function applyProjectBacklogSort() {
        let sortedTasks = [...projectBacklogTasks];
        
        if (projectBacklogSort === 'priority') {
            // Sort by priority: urgent > high > medium > low
            const priorityOrder = { 'urgent': 4, 'high': 3, 'medium': 2, 'low': 1 };
            sortedTasks.sort((a, b) => {
                const aPriority = priorityOrder[a.priority || 'medium'] || 2;
                const bPriority = priorityOrder[b.priority || 'medium'] || 2;
                return bPriority - aPriority; // Highest priority first
            });
        } else if (projectBacklogSort === 'date') {
            // Sort by deadline: earliest first (null deadlines go to end)
            sortedTasks.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return 1; // No deadline goes to end
                if (!b.deadline) return -1; // No deadline goes to end
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return dateA - dateB; // Earliest first
            });
        }
        // If projectBacklogSort is null, use original order
        
        renderUserActiveBacklog(sortedTasks);
    }
    
    // Render user active backlog tasks using same styling as dashboard/active_backlog
    function renderUserActiveBacklog(tasks) {
        const container = document.getElementById('userActiveBacklogList');
        if (!container) return;
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 32px 16px; color: #9ca3af; font-size: 0.85rem;">
                    <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.2;"></i>
                    <p style="margin: 0; font-weight: 500;">No tasks to do</p>
                </div>
            `;
            return;
        }
        
        let html = '<div style="display: flex; flex-direction: column;">';
        tasks.forEach(task => {
            const priority = task.priority || 'medium';
            const priorityLabel = priority.charAt(0).toUpperCase() + priority.slice(1);
            const priorityClass = `priority-${priority}`;
            
            // Format deadline date and check if overdue
            let deadlineHtml = '';
            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                deadlineDate.setHours(0, 0, 0, 0);
                const isOverdue = deadlineDate < today && !task.completed;
                
                const formattedDate = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const overdueClass = isOverdue ? 'overdue' : '';
                
                deadlineHtml = `
                    <div class="active-backlog-task-deadline ${overdueClass}">
                        <i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i>
                        <span>${formattedDate}</span>
                    </div>
                `;
            }
            
            const descriptionHtml = task.description ? `
                <div class="active-backlog-task-description" style="margin-bottom: 8px;">${escapeHtml(task.description)}</div>
            ` : '';
            
            const escapedTitle = (task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
            const escapedDescription = (task.description || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
            
            const hasStage = task.has_stage || false;
            
            const deactivateIcon = `
                <div class="deactivate-icon-stack">
                    <i class="fas fa-list" style="font-size: 0.7rem; position: absolute; left: 2px;"></i>
                    <i class="fas fa-chevron-left" style="font-size: 0.5rem; position: absolute; left: -8px;"></i>
                </div>
                <span class="deactivate-popover">Deactivate</span>
            `;

            // Project/stage source row as clickable tags
            let sourceRowHtml = '';
            if (task.has_stage && task.project_id) {
                const projectUrl = `/dashboard/user/projects/${task.project_id}/`;
                const stageUrl = task.stage_id ? `/dashboard/user/projects/${task.project_id}/stages/${task.stage_id}/` : projectUrl;
                
                sourceRowHtml = '<div class="active-backlog-task-source-row">';
                if (task.project_title) {
                    sourceRowHtml += `<a href="${projectUrl}" class="active-backlog-task-source-tag" onclick="event.stopPropagation();">
                        <i class="fas fa-project-diagram"></i>
                        <span>${escapeHtml(task.project_title)}</span>
                    </a>`;
                }
                if (task.stage_title && task.stage_id) {
                    sourceRowHtml += `<a href="${stageUrl}" class="active-backlog-task-source-tag" onclick="event.stopPropagation();">
                        <i class="fas fa-layer-group"></i>
                        <span>${escapeHtml(task.stage_title)}</span>
                    </a>`;
                }
                sourceRowHtml += '</div>';
            }
            
            html += `
                <div class="active-backlog-task-item ${task.completed ? 'completed' : ''}" 
                     data-task-id="${task.id}" 
                     data-has-stage="${hasStage}"
                     data-stage-id="${task.stage_id || ''}"
                     data-project-id="${task.project_id || ''}"
                     data-priority="${priority}">
                    <div class="active-backlog-task-header" style="border-bottom: none;">
                        <div class="active-backlog-task-activate ${hasStage ? '' : 'hidden'}">
                            <button class="active-backlog-task-activate-btn" 
                                    data-task-id="${task.id}"
                                    data-stage-id="${task.stage_id || ''}"
                                    data-project-id="${task.project_id || ''}"
                                    onmouseover="updateProjectBacklogActivateButton(this, true)"
                                    onmouseout="updateProjectBacklogActivateButton(this, false)"
                                    onclick="deactivateProjectBacklogTask(${task.id}, ${task.stage_id || 'null'}, ${task.project_id || 'null'}, event)">
                                ${deactivateIcon}
                            </button>
                        </div>
                        <div class="active-backlog-task-content ${hasStage ? '' : 'has-no-activate-btn'}" onclick="editProjectBacklogTask(${task.id}, '${escapedTitle}', '${escapedDescription}', '${task.deadline || ''}', '${task.priority || 'medium'}', event)">
                            <div class="active-backlog-task-title-row">
                                <div class="active-backlog-task-title-text">${escapeHtml(task.title)}</div>
                                ${deadlineHtml}
                            </div>
                            ${sourceRowHtml}
                            ${descriptionHtml}
                            
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                                <span class="priority-tag ${priorityClass}">${priorityLabel}</span>
                                <div class="active-backlog-done-btn ${task.completed ? 'checked' : ''}" 
                                     onclick="toggleProjectBacklogTaskComplete(${task.id}, ${task.stage_id || 'null'}, ${task.project_id || 'null'}, ${task.has_stage}, event)">
                                    <i class="fas fa-check"></i> Mark Done
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Update project backlog activate button on hover
    window.updateProjectBacklogActivateButton = function(button, isHover) {
        if (isHover) {
            button.style.color = '#ef4444'; // Red on hover
        } else {
            button.style.color = '#9ca3af'; // Grey by default
        }
    };

    // Deactivate project backlog task
    window.deactivateProjectBacklogTask = function(taskId, stageId, projectId, event) {
        event.stopPropagation();
        
        if (!stageId || !projectId) {
            if (typeof showNotification !== 'undefined') {
                showNotification('Cannot deactivate task created directly in active backlog', 'error');
            } else {
                alert('Cannot deactivate task created directly in active backlog');
            }
            return;
        }
        
        const button = event.target.closest('.active-backlog-task-activate-btn');
        if (!button) return;
        
        button.disabled = true;
        
        fetch(`/dashboard/user/active-backlog/tasks/${taskId}/deactivate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            button.disabled = false;
            if (data.success) {
                // Remove task from backlog with fade-out animation
                const taskItem = button.closest('.active-backlog-task-item');
                if (taskItem) {
                    taskItem.classList.add('fade-out');
                    setTimeout(() => {
                        taskItem.remove();
                        // Reload backlog to update count
                        loadUserActiveBacklog();
                    }, 400);
                }
                
                if (typeof showNotification !== 'undefined') {
                    showNotification('Task deactivated successfully', 'success');
                }
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to deactivate task', 'error');
                } else {
                    alert(data.error || 'Failed to deactivate task');
                }
            }
        })
        .catch(error => {
            console.error('Error deactivating task:', error);
            button.disabled = false;
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while deactivating the task.', 'error');
            } else {
                alert('An error occurred while deactivating the task.');
            }
        });
    };

    // Edit project backlog task
    window.editProjectBacklogTask = function(taskId, title, description, deadline, priority, event) {
        event.stopPropagation();
        if (typeof openCreateActiveBacklogTaskModal === 'function') {
            openCreateActiveBacklogTaskModal(taskId, title, description, deadline, priority);
        }
    };

    // Toggle project backlog task completion
    window.toggleProjectBacklogTaskComplete = function(taskId, stageId, projectId, hasStage, event) {
        event.stopPropagation();
        
        const taskItem = event.target.closest('.active-backlog-task-item');
        const isCompleted = taskItem && taskItem.classList.contains('completed');
        const newCompleted = !isCompleted;
        
        const endpoint = `{% url "general:dashboard_user:toggle_active_backlog_task_complete" 0 %}`.replace('0', taskId);
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                completed: newCompleted
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Reload backlog to update UI
                loadUserActiveBacklog();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update task', 'error');
                } else {
                    alert(data.error || 'Failed to update task');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling task:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while updating the task.', 'error');
            } else {
                alert('An error occurred while updating the task.');
            }
        });
    };
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Helper to render a single task card
    function renderBacklogTaskCard(task, clientId) {
        const completedClass = task.completed ? 'completed' : '';
        const hasStage = task.has_stage === true;
        const fadeInClass = 'fade-in';
        const descriptionHtml = task.description ? `
            <div class="active-backlog-task-description" style="margin-bottom: 8px;">${escapeHtml(task.description)}</div>
        ` : '';
        
        const deactivateIcon = `
            <div class="deactivate-icon-stack">
                <i class="fas fa-list" style="font-size: 0.7rem; position: absolute; left: 2px;"></i>
                <i class="fas fa-chevron-left" style="font-size: 0.5rem; position: absolute; left: -8px;"></i>
                    </div>
            <span class="deactivate-popover">Deactivate</span>
        `;
        
        // Format deadline date and check if overdue
        let deadlineHtml = '';
        if (task.deadline) {
            const deadlineDate = new Date(task.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            deadlineDate.setHours(0, 0, 0, 0);
            const isOverdue = deadlineDate < today;
            
            const formattedDate = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const overdueClass = isOverdue ? 'overdue' : '';
            const overduePopover = isOverdue ? '<span class="overdue-popover">Overdue</span>' : '';
            
            deadlineHtml = `
                <div class="active-backlog-task-deadline ${overdueClass}">
                    <i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i>
                    <span>${formattedDate}</span>
                    ${overduePopover}
                </div>
            `;
        }
        
        const priority = task.priority || 'medium';
        const priorityLabel = priority.charAt(0).toUpperCase() + priority.slice(1);
        const priorityClass = `priority-${priority}`;
        
        // Escape single quotes in title and description for onclick handler
        const escapedTitle = (task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        const escapedDescription = (task.description || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        
        return `
            <div class="active-backlog-task-item ${completedClass} ${fadeInClass}" 
                 data-task-id="${task.id}" 
                 data-has-stage="${hasStage}" 
                 data-stage-id="${task.stage_id || ''}" 
                 data-project-id="${task.project_id || ''}"
                 data-priority="${priority}">
                <div class="active-backlog-task-header" style="border-bottom: none;">
                    <div class="active-backlog-task-activate ${hasStage ? '' : 'hidden'}">
                        <button class="active-backlog-task-activate-btn" 
                                data-task-id="${task.id}"
                                data-stage-id="${task.stage_id || ''}"
                                data-project-id="${task.project_id || ''}"
                                onmouseover="updateActiveBacklogActivateButton(this, true)"
                                onmouseout="updateActiveBacklogActivateButton(this, false)"
                                onclick="deactivateActiveBacklogTask(${task.id}, ${task.stage_id || 'null'}, ${task.project_id || 'null'}, event)">
                            ${deactivateIcon}
                        </button>
                    </div>
                    <div class="active-backlog-task-content ${hasStage ? '' : 'has-no-activate-btn'}" onclick="editActiveBacklogTask(${task.id}, '${escapedTitle}', '${escapedDescription}', '${task.deadline || ''}', '${task.priority || 'medium'}', ${clientId || 'null'}, event)">
                        <div class="active-backlog-task-title-row">
                            <div class="active-backlog-task-title-text ${!hasStage ? 'single-line' : ''}">${escapeHtml(task.title)}</div>
                            ${deadlineHtml}
                        </div>
                        ${descriptionHtml}
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <span class="priority-tag ${priorityClass}">${priorityLabel}</span>
                            <div class="active-backlog-done-btn ${task.completed ? 'checked' : ''}" 
                                 onclick="toggleActiveBacklogTaskComplete(${task.id}, ${task.stage_id || 'null'}, ${task.project_id || 'null'}, ${task.has_stage}, event)">
                                <i class="fas fa-check"></i> Mark Done
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Edit active backlog task
    window.editActiveBacklogTask = function(taskId, title, description, deadline, priority, clientId, event) {
        event.stopPropagation();
        if (typeof openCreateActiveBacklogTaskModal === 'function') {
            openCreateActiveBacklogTaskModal(taskId, title, description, deadline, priority, null, null, clientId);
        }
    };
    
    // Update active backlog activate button on hover
    window.updateActiveBacklogActivateButton = function(button, isHover) {
        // We always show the grey-themed deactivate icon now, but we can change color on hover
        const stack = button.querySelector('.deactivate-icon-stack');
        if (!stack) return;
        
        if (isHover) {
            button.style.color = '#ef4444'; // Red on hover
        } else {
            button.style.color = '#9ca3af'; // Grey by default
        }
    };
    
    // Deactivate task from active backlog
    window.deactivateActiveBacklogTask = function(taskId, stageId, projectId, event) {
        event.stopPropagation();
        
        if (!stageId || !projectId) {
            if (typeof showNotification !== 'undefined') {
                showNotification('Cannot deactivate task created directly in active backlog', 'error');
            } else {
                alert('Cannot deactivate task created directly in active backlog');
            }
            return;
        }
        
        const button = event.target.closest('.active-backlog-task-activate-btn');
        if (!button) return;
        
        button.disabled = true;
        
        fetch(`/dashboard/user/projects/${projectId}/stages/${stageId}/tasks/${taskId}/toggle-activate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activate: false
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            button.disabled = false;
            if (data.success) {
                // Remove task from active backlog with fade-out animation
                const taskItem = button.closest('.active-backlog-task-item');
                if (taskItem) {
                    taskItem.classList.add('fade-out');
                    setTimeout(() => {
                        taskItem.remove();
                        // Reload active backlog to update count
                        loadUserActiveBacklog();
                        // Reload stage tasks only if the stage is currently open/expanded
                        if (stageId && projectId) {
                            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                            if (tasksSection && tasksSection.classList.contains('expanded')) {
                                loadStageTasks(stageId);
                            }
                        }
                    }, 400);
                }
                
                if (typeof showNotification !== 'undefined') {
                    showNotification('Task deactivated successfully', 'success');
                }
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to deactivate task', 'error');
                } else {
                    alert(data.error || 'Failed to deactivate task');
                }
            }
        })
        .catch(error => {
            console.error('Error deactivating task:', error);
            button.disabled = false;
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    };
    
    // Toggle active backlog task completion
    window.toggleActiveBacklogTaskComplete = function(taskId, stageId, projectId, hasStage, event) {
        event.stopPropagation();
        
        const completeBtn = event.target.closest('.active-backlog-done-btn');
        if (!completeBtn) return;
        
        const isCompleted = completeBtn.classList.contains('checked');
        const newCompleted = !isCompleted;
        
        // Update UI immediately
        if (newCompleted) {
            completeBtn.classList.add('checked');
        } else {
            completeBtn.classList.remove('checked');
        }
        
        // Determine endpoint based on whether task has stage
        let endpoint;
        if (hasStage && stageId && projectId) {
            // Task from stage - use mentor endpoint
            endpoint = `/dashboard/user/projects/${projectId}/stages/${stageId}/tasks/${taskId}/toggle-complete/`;
        } else {
            // Task created directly in active backlog - use mentor endpoint for client active backlog
            {% if project.project_owner %}
            const clientId = {{ project.project_owner.id }};
            endpoint = `/dashboard/user/clients/${clientId}/active-backlog/tasks/${taskId}/toggle-complete/`;
            {% else %}
            if (typeof showNotification !== 'undefined') {
                showNotification('Cannot complete task: no client assigned', 'error');
            }
            return;
            {% endif %}
        }
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                completed: newCompleted
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const taskItem = completeBtn.closest('.active-backlog-task-item');
                if (taskItem) {
                    if (newCompleted) {
                        taskItem.classList.add('completed');
                        // Remove task from active backlog (for both stage-linked and general tasks)
                        taskItem.classList.add('fade-out');
                        setTimeout(() => {
                            taskItem.remove();
                            loadUserActiveBacklog();
                            // Reload stage and its tasks if the stage is currently open/expanded (only for stage-linked tasks)
                            if (hasStage && stageId && projectId) {
                                const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                                if (tasksSection && tasksSection.classList.contains('expanded')) {
                                    // Reload the entire stage to get updated data
                                    loadStageTasks(stageId);
                                    // Also reload stages to update stage completion status and progress
                                    loadStages();
                                }
                            }
                        }, 400);
                    } else {
                        taskItem.classList.remove('completed');
                        // Reload stage tasks if the stage is currently open/expanded
                        if (hasStage && stageId && projectId) {
                            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                            if (tasksSection && tasksSection.classList.contains('expanded')) {
                                loadStageTasks(stageId);
                            }
                        }
                    }
                }
            } else {
                // Revert UI change
                if (newCompleted) {
                    completeBtn.classList.remove('checked');
                } else {
                    completeBtn.classList.add('checked');
                }
                
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update task', 'error');
                } else {
                    alert(data.error || 'Failed to update task');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling task completion:', error);
            // Revert UI change
            if (newCompleted) {
                completeBtn.classList.remove('checked');
            } else {
                completeBtn.classList.add('checked');
            }
            
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    };
    
    // Toggle active backlog task dropdown
    window.toggleActiveBacklogTaskDropdown = function(taskId, event) {
        event.stopPropagation();
        // TODO: Implement dropdown menu for active backlog tasks
        console.log('Toggle dropdown for active backlog task:', taskId);
    };
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Calculate and set dynamic offset for main content
    function setMainContentOffset() {
        const docHeaderSection = document.querySelector('.doc-header-section');
        const metaCard = document.querySelector('.project-sidebar .project-meta-card');
        const mainContent = document.querySelector('.roadmap-container > main');
        
        if (docHeaderSection && metaCard && mainContent) {
            const docHeaderHeight = docHeaderSection.offsetHeight;
            const metaCardHeight = metaCard.offsetHeight;
            
            // Calculate the difference - if meta card is taller, we need to offset main content up
            // to align the bottom of main with the bottom of meta card
            const heightDiff = metaCardHeight - docHeaderHeight;
            
            // Only apply offset if meta card is significantly taller (more than 10px)
            // This prevents the chart from covering the header card
            if (heightDiff > 10) {
                // Offset by the difference minus a small buffer (20px) to leave some space
                // Then subtract additional 16px (10px + 6px) as requested
                const offset = -(heightDiff - 20) - 16;
                mainContent.style.top = offset + 'px';
            } else {
                // Heights are similar or doc-header is taller, apply small offset anyway
                const offset = -16;
                mainContent.style.top = offset + 'px';
            }
        }
    }
    
    // Debug helper function (already defined at top, but keeping here for reference)
    // Function is defined at the very beginning of the script block
    
    // Initialize when DOM is ready
    function initializePage() {
        console.log('=== Initializing page ===');
        console.log('Document ready state:', document.readyState);
        console.log('Current URL:', window.location.href);
        
        // Check if required elements exist
        const stagesList = document.getElementById('stagesList');
        if (!stagesList) {
            console.error('stagesList element not found! Waiting and retrying...');
            console.log('Available elements with "stage" in id:', Array.from(document.querySelectorAll('[id*="stage"]')).map(el => el.id));
            setTimeout(initializePage, 200);
            return;
        }
        
        console.log('stagesList element found:', stagesList);
        console.log('stagesList parent:', stagesList.parentElement);
        
        try {
            console.log('Calling loadStages()...');
            if (typeof loadStages === 'function') {
                loadStages();
            } else {
                console.error('loadStages is not defined!');
                console.log('Available functions:', Object.keys(window).filter(key => typeof window[key] === 'function' && key.includes('stage')));
            }
            
            if (typeof loadUserActiveBacklog === 'function') {
                console.log('Calling loadUserActiveBacklog()...');
                loadUserActiveBacklog();
            } else {
                console.warn('loadUserActiveBacklog is not defined');
            }
            
            // Set offset and recalculate height after a short delay to ensure meta card is rendered
            setTimeout(function() {
                setMainContentOffset();
                setRoadmapContainerMaxHeight();
            }, 100);
        } catch (error) {
            console.error('Error initializing page:', error);
            console.error('Error name:', error.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
        }
    }
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        console.log('DOM is loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            setTimeout(initializePage, 100);
        });
    } else {
        console.log('DOM already ready, initializing...');
        // DOM is already ready, but wait a bit to ensure all elements are rendered
        setTimeout(initializePage, 200);
    }
    
    // Recalculate offset and height on window resize
    window.addEventListener('resize', function() {
        setTimeout(function() {
            setMainContentOffset();
            setRoadmapContainerMaxHeight();
        }, 100);
    });
    
    // Also recalculate when content changes (via MutationObserver)
    // Set up MutationObserver to watch for DOM changes and recalculate both position and height
    (function() {
        const roadmapContainerEl = document.querySelector('.roadmap-container');
        if (roadmapContainerEl) {
            const observer = new MutationObserver(function(mutations) {
                // Debounce recalculation to avoid excessive calls
                clearTimeout(observer._recalcTimeout);
                observer._recalcTimeout = setTimeout(function() {
                    // Call setMainContentOffset first, then setRoadmapContainerMaxHeight
                    // so max-height calculation accounts for the offset
                    setMainContentOffset();
                    setRoadmapContainerMaxHeight();
                }, 150);
            });
            
            observer.observe(roadmapContainerEl, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['style', 'class']
            });
        }
    })();
    
    // Make debug function available globally
    console.log('Debug function available: Call debugStagesLoading() in console to debug');

    // Modal Helpers
    window.openCreateStageModal = function() {
        // Check if questionnaire is completed
        {% if not project.questionnaire_completed %}
        if (typeof showNotification !== 'undefined') {
            showNotification('Please complete the project questionnaire before creating stages. Click "Start Questionnaire" to begin.', 'warning');
        } else {
            alert('Please complete the project questionnaire before creating stages.');
        }
        return;
        {% endif %}
        
        const modal = document.getElementById('createStageModal');
        if(modal) { modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('active'),10); }
    };
    
    window.generateStagesAI = function() {
        // Check subscription first
        if (!checkAISubscription()) {
            showFreeSubscriptionToast();
            return;
        }
        
        // Check if questionnaire is completed
        {% if not project.questionnaire_completed %}
        if (typeof showNotification !== 'undefined') {
            showNotification('Please complete the project questionnaire before generating stages. Click "Start Questionnaire" to begin.', 'warning');
        } else {
            alert('Please complete the project questionnaire before generating stages.');
        }
        return;
        {% endif %}
        
        const btn = document.getElementById('generateStagesBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Generating...';
        btn.disabled = true;
        btn.style.opacity = '0.7';
        function restoreBtn() {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
        }
        
        return fetch('{% url "general:dashboard_user:generate_stages_ai" project.id %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(function(response) {
            if (!response || !response.json) return;
            return response.json().then(function(data) {
                if (data.success) {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Stages generated successfully!', 'success');
                    }
                    loadStages();
                } else {
                    if (typeof showNotification !== 'undefined') {
                        showNotification(data.error || 'Failed to generate stages', 'error');
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error occurred'));
                    }
                }
                restoreBtn();
            });
        })
        .catch(function(err) {
            console.error('Error:', err);
            restoreBtn();
            if (typeof showNotification !== 'undefined') {
                showNotification('A network error occurred. Please try again.', 'error');
            }
        });
    };
    
    let pendingDeleteAction = null;

    window.openDeleteConfirmModal = function(opts) {
        const overlay = document.getElementById('deleteConfirmModal');
        const titleEl = document.getElementById('deleteConfirmModalTitle');
        const messageEl = document.getElementById('deleteConfirmModalMessage');
        const confirmBtn = document.getElementById('deleteConfirmModalBtn');
        if (!overlay || !titleEl || !messageEl || !confirmBtn) return;

        const cfg = opts || {};
        pendingDeleteAction = typeof cfg.onConfirm === 'function' ? cfg.onConfirm : null;
        titleEl.textContent = cfg.title || 'Confirm Delete';
        messageEl.textContent = cfg.message || 'Are you sure you want to delete this item?';
        confirmBtn.textContent = cfg.confirmText || 'Delete';
        confirmBtn.disabled = false;

        overlay.style.display = 'flex';
        requestAnimationFrame(() => overlay.classList.add('active'));
    };

    window.closeDeleteConfirmModal = function() {
        const overlay = document.getElementById('deleteConfirmModal');
        if (!overlay) return;
        overlay.classList.remove('active');
        setTimeout(() => {
            overlay.style.display = 'none';
            pendingDeleteAction = null;
        }, 250);
    };

    window.confirmDeleteConfirmModal = function() {
        const confirmBtn = document.getElementById('deleteConfirmModalBtn');
        if (confirmBtn) confirmBtn.disabled = true;
        if (pendingDeleteAction) {
            pendingDeleteAction();
        } else {
            closeDeleteConfirmModal();
        }
    };

    window.deleteStage = function(id) {
        openDeleteConfirmModal({
            title: 'Delete Stage',
            message: 'Are you sure you want to delete this stage?',
            confirmText: 'Delete Stage',
            onConfirm: function() {
                fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${id}/delete/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                })
                .then(() => {
                    closeDeleteConfirmModal();
                    loadStages();
                })
                .catch(() => {
                    closeDeleteConfirmModal();
                });
            }
        });
    };
    
    // Toggle stage tasks section
    // Check if any stage tasks are open and update overlay
    function updateTasksOverlay() {
        const roadmapContainer = document.querySelector('.roadmap-container');
        if (!roadmapContainer) return;
        
        // Check if any stage tasks section is expanded
        const expandedTasks = roadmapContainer.querySelectorAll('.stage-tasks-section.expanded');
        const hasOpenTasks = expandedTasks.length > 0;
        
        // Add or remove class to show/hide overlay
        if (hasOpenTasks) {
            roadmapContainer.classList.add('has-open-tasks');
        } else {
            roadmapContainer.classList.remove('has-open-tasks');
        }
    }
    
    // Scroll to stage row when opened (safe version with error handling)
    function scrollToStage(stageId) {
        try {
            console.log('scrollToStage called for stageId:', stageId);
            
            // Try multiple ways to find the stage row
            let stageRow = null;
            let tasksSection = document.getElementById(`stageTasks_${stageId}`);
            
            if (tasksSection) {
                // Try closest parent with class stage-row
                stageRow = tasksSection.closest('.stage-row');
                
                // If not found, try parent element
                if (!stageRow) {
                    stageRow = tasksSection.parentElement;
                }
                
                // If still not found, try finding by data attribute
                if (!stageRow) {
                    stageRow = document.querySelector(`[data-stage-id="${stageId}"]`);
                }
            }
            
            // Last resort: find by stage ID in the stage row
            if (!stageRow) {
                const allStageRows = document.querySelectorAll('.stage-row');
                for (const row of allStageRows) {
                    const rowTasksSection = row.querySelector(`#stageTasks_${stageId}`);
                    if (rowTasksSection) {
                        stageRow = row;
                        break;
                    }
                }
            }
            
            if (!stageRow) {
                console.warn('scrollToStage: stageRow not found for stageId:', stageId);
                return;
            }
            
            console.log('scrollToStage: Found stageRow:', stageRow);
            
            // Scroll immediately - the stage row already exists in the DOM
            // Use requestAnimationFrame to ensure DOM has updated after class addition
            requestAnimationFrame(() => {
                try {
                    // Verify stageRow is still in DOM
                    if (!document.body.contains(stageRow)) {
                        return;
                    }
                    
                    // Calculate scroll position to place stage in upper half of viewport
                    const rowRect = stageRow.getBoundingClientRect();
                    const scrollY = window.scrollY || window.pageYOffset;
                    const viewportHeight = window.innerHeight;
                    
                    // Position in upper half (approximately 25% from top of viewport)
                    const targetOffset = viewportHeight * 0.25; // 25% from top
                    const targetScroll = scrollY + rowRect.top - targetOffset;
                    
                    // Ensure target is within valid scroll range
                    const maxScroll = Math.max(0, document.documentElement.scrollHeight - viewportHeight);
                    const finalScroll = Math.max(0, Math.min(targetScroll, maxScroll));
                    
                    // Only scroll if the target is different from current position
                    if (Math.abs(finalScroll - scrollY) > 10) {
                        window.scrollTo({
                            top: finalScroll,
                            behavior: 'smooth'
                        });
                    } else {
                        // Fallback to scrollIntoView if calculation results in same position
                        stageRow.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                } catch (error) {
                    console.error('scrollToStage: Error during scroll:', error);
                    
                    // Fallback to scrollIntoView if manual calculation fails
                    try {
                        stageRow.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    } catch (fallbackError) {
                        console.error('scrollToStage: Fallback also failed:', fallbackError);
                    }
                }
            });
        } catch (error) {
            console.error('scrollToStage: Error:', error);
        }
    }
    
    // Collapse all open stage task lists
    function collapseAllStageTasks() {
        const roadmapContainer = document.querySelector('.roadmap-container');
        if (!roadmapContainer) return;
        
        // Find all expanded task sections
        const expandedTasks = roadmapContainer.querySelectorAll('.stage-tasks-section.expanded');
        
        // Collapse each one and hide input sections
        expandedTasks.forEach(taskSection => {
            taskSection.classList.remove('expanded');
            
            // Find the stage row and get stage ID
            const stageRow = taskSection.closest('.stage-row');
            if (stageRow) {
                const stageId = stageRow.getAttribute('data-stage-id');
                if (stageId) {
                    const buttonsSection = document.getElementById(`stageButtons_${stageId}`);
                    if (buttonsSection) {
                        buttonsSection.style.display = 'none';
                    }
                }
            }
        });
        
        // Also hide all visible input sections (in case they're still visible)
        const allInputSections = roadmapContainer.querySelectorAll('.stage-task-input-section');
        allInputSections.forEach(inputSection => {
            const currentDisplay = window.getComputedStyle(inputSection).display;
            if (currentDisplay !== 'none') {
                inputSection.style.display = 'none';
            }
        });
        
        // Update overlay state
        updateTasksOverlay();
        
        // Update max-height after collapse animation completes (0.1s transition)
        setTimeout(() => {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    setRoadmapContainerMaxHeight();
                    setMainContentOffset();
                });
            });
        }, 150); // Wait for 0.1s transition + 50ms buffer
    }
    
    // Stages stay open until user manually collapses them.
    
    window.toggleStageTasks = function(stageId, event) {
        // Don't toggle if clicking on actions or dropdown
        if (event && (event.target.closest('.row-actions-section') || event.target.closest('.dropdown'))) {
            return;
        }
        
        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
        if (!tasksSection) return;
        
        const isExpanded = tasksSection.classList.contains('expanded');
        
        if (isExpanded) {
            // Collapse
            tasksSection.classList.remove('expanded');
            // Hide buttons section
            const buttonsSection = document.getElementById(`stageButtons_${stageId}`);
            if (buttonsSection) {
                buttonsSection.style.display = 'none';
            }
            // Update overlay state
            updateTasksOverlay();
            // Update max-height after collapse animation completes (0.1s transition)
            setTimeout(() => {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        setRoadmapContainerMaxHeight();
                        setMainContentOffset();
                    });
                });
            }, 150); // Wait for 0.1s transition + 50ms buffer
        } else {
            // Expand
            tasksSection.classList.add('expanded');
            // Load tasks if not already loaded
            const needsLoading = !tasksSection.dataset.loaded;
            if (needsLoading) {
                loadStageTasks(stageId);
            } else {
                // Show task input section for all stages (with or without tasks)
                const buttonsSection = document.getElementById(`stageButtons_${stageId}`);
                if (buttonsSection) {
                    buttonsSection.style.display = 'block';
                    // Focus the input field
                    const taskInput = document.getElementById(`stageTaskInput_${stageId}`);
                    if (taskInput) {
                        setTimeout(() => taskInput.focus(), 100);
                    }
                }
            }
            // Update overlay state
            updateTasksOverlay();
            // Update max-height after DOM updates
            // Use multiple requestAnimationFrame calls and a timeout to ensure content is fully rendered
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    setMainContentOffset();
                    setRoadmapContainerMaxHeight();
                    // Also recalculate after tasks load (if loading) or after a delay
                    if (needsLoading) {
                        // Will be recalculated in loadStageTasks -> renderStageTasks
                    } else {
                        setTimeout(() => {
                            setMainContentOffset();
                            setRoadmapContainerMaxHeight();
                        }, 200);
                    }
                });
            });
        }
    };
    
    // Load tasks for a stage
    function loadStageTasks(stageId) {
        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
        if (!tasksSection) return;
        
        tasksSection.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #9ca3af;">
                <i class="fas fa-spinner fa-spin" style="font-size: 1rem; margin-bottom: 8px;"></i>
                <p style="margin: 0; font-size: 0.875rem;">Loading tasks...</p>
            </div>
        `;
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('API Error Response:', text);
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text.substring(0, 200)}`);
                });
            }
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return response.text().then(text => {
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned non-JSON response');
                });
            }
        })
        .then(data => {
            if (data && data.success) {
                const tasks = data.tasks || [];
                
                // Check if this is the first load and if there are completed tasks
                const filterSelect = document.getElementById(`taskFilter_${stageId}`);
                const isFirstLoad = !filterSelect;
                
                if (isFirstLoad) {
                    // Check if there are any completed tasks
                    const completedTasks = tasks.filter(t => t.completed === true && t.status !== 'archived');
                    if (completedTasks.length > 0) {
                        // Set a flag to use 'completed' as default filter
                        tasksSection.dataset.defaultFilter = 'completed';
                    }
                }
                
                renderStageTasks(stageId, tasks);
                tasksSection.dataset.loaded = 'true';
                
                // Save DB order after rendering (tasks come from API in DB order)
                saveDBOrder(stageId);
                
                // Initialize sortable for tasks
                initTaskSortable(stageId);
                
                // Update max-height after tasks are rendered and DOM is updated
                // Use multiple requestAnimationFrame calls to ensure content is fully rendered
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        setMainContentOffset();
                        setRoadmapContainerMaxHeight();
                        // Also recalculate after a short delay to account for any animations/transitions
                        setTimeout(() => {
                            setMainContentOffset();
                            setRoadmapContainerMaxHeight();
                        }, 200);
                    });
                });
            } else {
                tasksSection.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px;"></i>
                        <p style="margin: 0; font-size: 0.875rem;">Error loading tasks: ${data.error || 'Unknown error'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading tasks:', error);
            tasksSection.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px;"></i>
                    <p style="margin: 0; font-size: 0.875rem;">Error loading tasks: ${error.message || 'Network error'}</p>
                </div>
            `;
            tasksSection.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #ef4444;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px;"></i>
                    <p style="margin: 0; font-size: 0.875rem;">Error loading tasks</p>
                </div>
            `;
        });
    }
    
    // Render tasks for a stage
    function renderStageTasks(stageId, tasks) {
        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
        if (!tasksSection) return;
        
        // Show task input section in stage-row-content (for all stages, with or without tasks)
        const buttonsSection = document.getElementById(`stageButtons_${stageId}`);
        if (buttonsSection) {
            buttonsSection.style.display = 'block';
            // Focus the input field
            const taskInput = document.getElementById(`stageTaskInput_${stageId}`);
            if (taskInput) {
                setTimeout(() => taskInput.focus(), 100);
            }
        }
        
        // Get current filter value
        const filterSelect = document.getElementById(`taskFilter_${stageId}`);
        let currentFilter = filterSelect ? filterSelect.value : 'all';
        
        // If this is the first load and there are completed tasks, use 'completed' as default
        if (!filterSelect && tasksSection && tasksSection.dataset.defaultFilter === 'completed') {
            currentFilter = 'completed';
        }
        
        // Filter tasks based on selection
        let filteredTasks = tasks;
        let filteredCount = tasks.length;
        
        // Count completed tasks for badge
        const completedTasks = tasks.filter(t => t.completed === true && t.status !== 'archived');
        const completedCount = completedTasks.length;
        
        if (currentFilter === 'active') {
            filteredTasks = tasks.filter(t => t.status === 'active' && !t.completed && t.status !== 'archived');
            filteredCount = filteredTasks.length;
        } else if (currentFilter === 'not_active') {
            filteredTasks = tasks.filter(t => t.status !== 'active' && !t.completed && t.status !== 'archived');
            filteredCount = filteredTasks.length;
        } else if (currentFilter === 'completed') {
            // Show all completed tasks from the stage
            filteredTasks = tasks.filter(t => t.completed === true && t.status !== 'archived');
            filteredCount = filteredTasks.length;
        } else if (currentFilter === 'history') {
            // Show archived tasks
            filteredTasks = tasks.filter(t => t.status === 'archived');
            filteredCount = filteredTasks.length;
        } else if (currentFilter === 'all') {
            // Exclude archived tasks from "All" view
            filteredTasks = tasks.filter(t => t.status !== 'archived');
            filteredCount = filteredTasks.length;
        }
        
        // Always show the header with sorting buttons and actions, even when there are no tasks
        let html = `
            <div class="stage-tasks-header">
                <div class="stage-tasks-title">
                    <div class="stage-tasks-select-all-checkbox" id="selectAllTasks_${stageId}" onclick="toggleSelectAllTasks(${stageId}, event)"></div>
                    Tasks (${filteredCount}${currentFilter !== 'all' ? ` / ${tasks.length}` : ''})
                    <div class="stage-tasks-filter" style="margin-left: 12px; display: inline-flex; align-items: center; gap: 8px;">
                        <select class="task-filter-select" id="taskFilter_${stageId}" onchange="filterStageTasks(${stageId}, this.value)">
                            <option value="all" ${currentFilter === 'all' ? 'selected' : ''}>All</option>
                            <option value="active" ${currentFilter === 'active' ? 'selected' : ''}>Active</option>
                            <option value="not_active" ${currentFilter === 'not_active' && (!filterSelect || tasksSection.dataset.defaultFilter !== 'completed') ? 'selected' : ''}>Not Active</option>
                            <option value="completed" ${currentFilter === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="history" ${currentFilter === 'history' ? 'selected' : ''}>History</option>
                        </select>
                        ${completedCount > 0 ? `
                            <div class="review-completed-badge" onclick="filterStageTasksToCompleted(${stageId})" style="cursor: pointer;" title="Review Completed Tasks">
                                Review Completed Tasks
                                <span class="review-completed-count">${completedCount}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="stage-tasks-header-actions">
                    <button class="btn-sort-tasks" id="btnSortHigh_${stageId}" onclick="togglePrioritySort(${stageId}, 'high')" title="Sort Priority High to Low" ${tasks.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-sort-amount-down"></i>
                    </button>
                    <button class="btn-sort-tasks" id="btnSortLow_${stageId}" onclick="togglePrioritySort(${stageId}, 'low')" title="Sort Priority Low to High" ${tasks.length === 0 ? 'disabled' : ''}>
                        <i class="fas fa-sort-amount-up"></i>
                    </button>
                    <div class="stage-tasks-actions-select" id="actionsSelect_${stageId}">
                        <button class="custom-select-trigger-actions" id="btnActionsTasks_${stageId}" onclick="toggleTasksActionsDropdown(${stageId}, event)" disabled>
                            Actions <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="custom-select-menu-actions" id="tasksActionsMenu_${stageId}">
                            <button class="custom-select-item-actions first-item" onclick="activateSelectedTasks(${stageId})">
                                <i class="fas fa-check-circle"></i> <span>Activate</span>
                            </button>
                            <button class="custom-select-item-actions last-item" onclick="deleteSelectedTasks(${stageId})">
                                <i class="fas fa-trash"></i> <span>Delete</span>
                    </button>
                </div>
            </div>
                </div>
            </div>
            <div class="stage-tasks-list" id="stageTasksList_${stageId}" data-filter="${currentFilter}">
        `;
        
        if (filteredTasks.length === 0) {
            let emptyMessage = 'No tasks yet';
            if (currentFilter === 'active') {
                emptyMessage = 'No active tasks';
            } else if (currentFilter === 'not_active') {
                emptyMessage = 'No inactive tasks';
            } else if (currentFilter === 'completed') {
                emptyMessage = 'No completed tasks';
            } else if (currentFilter === 'history') {
                emptyMessage = 'No archived tasks';
            }
            html += `
                <div class="stage-tasks-empty" style="padding: 20px; text-align: center; color: #9ca3af;">
                    <p style="margin: 0; font-size: 0.875rem;">${emptyMessage}</p>
                </div>
            `;
        }
        
        // Reverse tasks array to show newest tasks at the top
        const reversedTasks = [...filteredTasks].reverse();
        reversedTasks.forEach((task, index) => {
            const completedClass = task.completed ? 'completed' : '';
            const isActive = task.status === 'active';
            const isCompleted = task.completed === true;
            const isArchived = task.status === 'archived';
            const priorityClass = `priority-${task.priority || 'medium'}`;
            const statusClass = `status-${task.status || 'pending'}`;
            const priorityLabel = (task.priority || 'medium').charAt(0).toUpperCase() + (task.priority || 'medium').slice(1);
            const statusLabel = (task.status || 'pending').replace('_', ' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
            
            // Determine button text, icon, and state
            let buttonText = 'Not Active';
            let buttonIcon = '<i class="fas fa-pause"></i>';
            let buttonClass = '';
            let buttonDataState = 'false';
            let buttonDataCompleted = 'false';
            
            if (isArchived) {
                buttonText = 'Archived';
                buttonIcon = '<i class="fas fa-archive"></i>';
                buttonClass = 'archived';
                buttonDataState = 'archived';
            } else if (isCompleted) {
                buttonText = 'Completed';
                buttonIcon = '<i class="fas fa-check-circle"></i>';
                buttonClass = 'completed';
                buttonDataState = 'completed';
                buttonDataCompleted = 'true';
            } else if (isActive) {
                buttonText = 'Active';
                buttonIcon = '<i class="fas fa-play"></i>';
                buttonClass = 'active';
                buttonDataState = 'true';
            }
            
            // Deadline in top right (same as active backlog)
            let stageDeadlineHtml = '';
            if (task.deadline) {
                const deadlineDate = new Date(task.deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                deadlineDate.setHours(0, 0, 0, 0);
                const isOverdue = deadlineDate < today;
                const formattedDate = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const overdueClass = isOverdue ? 'overdue' : '';
                const overduePopover = isOverdue ? '<span class="overdue-popover">Overdue</span>' : '';
                stageDeadlineHtml = `
                    <div class="active-backlog-task-deadline ${overdueClass}">
                        <i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i>
                        <span>${formattedDate}</span>
                        ${overduePopover}
                    </div>
                `;
            }
            
            html += `
                <div class="stage-task-item fade-in ${completedClass} ${isArchived ? 'archived' : ''}" data-task-id="${task.id}" data-priority="${task.priority || 'medium'}" data-status="${task.status || 'pending'}">
                    <div class="stage-task-drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    <div class="stage-task-checkbox-container">
                        <div class="stage-task-checkbox" onclick="toggleTaskSelection(${task.id}, ${stageId}, event)"></div>
                    </div>
                    <div class="stage-task-content" onclick="openCreateActiveBacklogTaskModal(${task.id}, '${(task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ')}', '${(task.description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${task.deadline || ''}', '${task.priority || 'medium'}', PROJECT_ID, ${stageId}, CLIENT_ID, '${task.status || 'pending'}')">
                        <div class="stage-task-title-row">
                            <div class="stage-task-title">${escapeHtml(task.title)}</div>
                            ${stageDeadlineHtml}
                        </div>
                        ${task.description ? `<div class="stage-task-description-text">${escapeHtml(task.description)}</div>` : ''}
                    </div>
                    <div class="stage-task-priority-display" onclick="openCreateActiveBacklogTaskModal(${task.id}, '${(task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ')}', '${(task.description || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${task.deadline || ''}', '${task.priority || 'medium'}', PROJECT_ID, ${stageId}, CLIENT_ID, '${task.status || 'pending'}')">
                        <span class="priority-tag ${priorityClass}">${priorityLabel}</span>
                    </div>
                    <div class="stage-task-activate">
                        <button class="stage-task-activate-btn ${buttonClass}" 
                                data-task-id="${task.id}"
                                data-is-active="${buttonDataState}"
                                data-is-completed="${buttonDataCompleted}"
                                data-is-archived="${isArchived ? 'true' : 'false'}"
                                onmouseenter="updateActivateButton(this, ${isCompleted ? true : (!isArchived ? true : false)}, ${isCompleted}, ${isArchived})"
                                onmouseleave="updateActivateButton(this, ${isActive ? false : false}, ${isCompleted}, ${isArchived})"
                                onclick="${isArchived ? 'return false;' : isCompleted ? `archiveTask(${task.id}, ${stageId}, event)` : `toggleTaskActivation(${task.id}, ${stageId}, event)`}">
                            <span class="button-text">${buttonIcon}<span style="margin-left: 6px;">${buttonText}</span></span>
                        </button>
                    </div>
                    <div class="stage-task-actions">
                        <button class="stage-task-delete-btn" onclick="deleteTask(${task.id}, ${stageId}, event)" title="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        html += `
            </div>
        `;
        
        tasksSection.innerHTML = html;
        
        // Save DB order after rendering (tasks come from API in DB order)
        saveDBOrder(stageId);
        
        // Initialize sortable for tasks
        initTaskSortable(stageId);
        
        // Update max-height after tasks are rendered
        setTimeout(() => {
            setRoadmapContainerMaxHeight();
        }, 100);
    }
    
    // Toggle task selection (checkbox only, no API call)
    window.toggleTaskSelection = function(taskId, stageId, event) {
        event.stopPropagation();
        
        const checkbox = event.target;
        const isChecked = checkbox.classList.contains('checked');
        
        if (isChecked) {
            checkbox.classList.remove('checked');
        } else {
            checkbox.classList.add('checked');
        }
        
        // Update actions button state
        updateTasksActionsButton(stageId);
    }
    
    // Toggle select all tasks
    window.toggleSelectAllTasks = function(stageId, event) {
        event.stopPropagation();
        
        const selectAllCheckbox = document.getElementById(`selectAllTasks_${stageId}`);
        if (!selectAllCheckbox) return;
        
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const allCheckboxes = tasksList.querySelectorAll('.stage-task-checkbox');
        const isChecked = selectAllCheckbox.classList.contains('checked');
        
        // Toggle all task checkboxes
        allCheckboxes.forEach(checkbox => {
            if (isChecked) {
                checkbox.classList.remove('checked');
            } else {
                checkbox.classList.add('checked');
            }
        });
        
        // Toggle select all checkbox
        if (isChecked) {
            selectAllCheckbox.classList.remove('checked');
        } else {
            selectAllCheckbox.classList.add('checked');
        }
        
        // Update actions button state
        updateTasksActionsButton(stageId);
    }
    
    // Update select all checkbox state based on individual task checkboxes
    function updateSelectAllCheckbox(stageId) {
        const selectAllCheckbox = document.getElementById(`selectAllTasks_${stageId}`);
        if (!selectAllCheckbox) return;
        
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const allCheckboxes = tasksList.querySelectorAll('.stage-task-checkbox');
        const checkedBoxes = tasksList.querySelectorAll('.stage-task-checkbox.checked');
        
        if (allCheckboxes.length === 0) {
            selectAllCheckbox.classList.remove('checked');
            return;
        }
        
        // If all tasks are checked, check the select all checkbox
        if (checkedBoxes.length === allCheckboxes.length) {
            selectAllCheckbox.classList.add('checked');
        } else {
            selectAllCheckbox.classList.remove('checked');
        }
    }
    
    // Update tasks actions button based on selected tasks
    function updateTasksActionsButton(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const checkedBoxes = tasksList.querySelectorAll('.stage-task-checkbox.checked');
        const actionsBtn = document.getElementById(`btnActionsTasks_${stageId}`);
        
        if (actionsBtn) {
            actionsBtn.disabled = checkedBoxes.length === 0;
        }
        
        // Update select all checkbox state
        updateSelectAllCheckbox(stageId);
    }
    
    // Store DB order (persistent) and display order (temporary for sorting)
    let taskDBOrder = {};  // DB order - persisted in database
    let taskSortMode = {}; // Current sort mode: 'high', 'low', or null
    
    // Save DB order from current DOM state (used when loading tasks or after drag-and-drop)
    function saveDBOrder(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const tasks = Array.from(tasksList.querySelectorAll('.stage-task-item'));
        taskDBOrder[stageId] = tasks.map(task => parseInt(task.dataset.taskId));
    }
    
    // Restore DB order (from database)
    function restoreDBOrder(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList || !taskDBOrder[stageId]) return;
        
        const tasks = Array.from(tasksList.querySelectorAll('.stage-task-item'));
        const orderMap = {};
        tasks.forEach(task => {
            orderMap[parseInt(task.dataset.taskId)] = task;
        });
        
        // Re-append in DB order
        taskDBOrder[stageId].forEach(taskId => {
            if (orderMap[taskId]) {
                tasksList.appendChild(orderMap[taskId]);
            }
        });
    }
    
    // Sort tasks by priority (temporary display order, doesn't affect DB order)
    function sortTasksByPriority(stageId, direction) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const tasks = Array.from(tasksList.querySelectorAll('.stage-task-item'));
        
        tasks.sort((a, b) => {
            const priorityOrder = { 'urgent': 4, 'high': 3, 'medium': 2, 'low': 1 };
            
            // Get priority from data attribute or priority-tag class
            const aTaskId = parseInt(a.dataset.taskId);
            const bTaskId = parseInt(b.dataset.taskId);
            
            // Try to get priority from data attribute first (more reliable)
            let aPriority = a.dataset.priority || 'medium';
            let bPriority = b.dataset.priority || 'medium';
            
            // Fallback to reading from DOM if data attribute not set
            if (!a.dataset.priority) {
                const aPriorityTag = a.querySelector('.stage-task-priority-display .priority-tag');
                if (aPriorityTag) {
                    const aClass = Array.from(aPriorityTag.classList).find(c => c.startsWith('priority-'));
                    if (aClass) {
                        aPriority = aClass.replace('priority-', '');
                    }
                }
            }
            
            if (!b.dataset.priority) {
                const bPriorityTag = b.querySelector('.stage-task-priority-display .priority-tag');
                if (bPriorityTag) {
                    const bClass = Array.from(bPriorityTag.classList).find(c => c.startsWith('priority-'));
                    if (bClass) {
                        bPriority = bClass.replace('priority-', '');
                    }
                }
            }
            
            const aValue = priorityOrder[aPriority] || 2;
            const bValue = priorityOrder[bPriority] || 2;
            
            if (direction === 'high') {
                return bValue - aValue; // High to Low
            } else {
                return aValue - bValue; // Low to High
            }
        });
        
        // Re-append sorted tasks
        tasks.forEach(task => tasksList.appendChild(task));
    }
    
    // Toggle priority sorting (high, low, or off)
    window.togglePrioritySort = function(stageId, direction) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const btnHigh = document.getElementById(`btnSortHigh_${stageId}`);
        const btnLow = document.getElementById(`btnSortLow_${stageId}`);
        const currentMode = taskSortMode[stageId];
        
        // If clicking the same button, turn off sorting
        if (currentMode === direction) {
            // Restore DB order
            restoreDBOrder(stageId);
            taskSortMode[stageId] = null;
            btnHigh?.classList.remove('active');
            btnLow?.classList.remove('active');
        } else {
            // Save current DB order before applying sort (if not already saved)
            if (!taskDBOrder[stageId]) {
                saveDBOrder(stageId);
            }
            
            // Apply new sort (temporary display order)
            sortTasksByPriority(stageId, direction);
            taskSortMode[stageId] = direction;
            
            // Update button states
            btnHigh?.classList.toggle('active', direction === 'high');
            btnLow?.classList.toggle('active', direction === 'low');
        }
        
        // Reinitialize sortable after reordering
        initTaskSortable(stageId);
    }
    
    // Toggle tasks actions dropdown
    window.toggleTasksActionsDropdown = function(stageId, event) {
        event.stopPropagation();
        const selectContainer = document.getElementById(`actionsSelect_${stageId}`);
        if (selectContainer) {
            selectContainer.classList.toggle('active');
        }
    }
    
    // Activate selected tasks
    window.activateSelectedTasks = function(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const checkedBoxes = tasksList.querySelectorAll('.stage-task-checkbox.checked');
        const taskIds = Array.from(checkedBoxes).map(cb => {
            const taskItem = cb.closest('.stage-task-item');
            return taskItem ? taskItem.dataset.taskId : null;
        }).filter(id => id !== null);
        
        if (taskIds.length === 0) return;
        
        // Close dropdown
        const selectContainer = document.getElementById(`actionsSelect_${stageId}`);
        if (selectContainer) selectContainer.classList.remove('active');
        
        // Activate each task
        taskIds.forEach(taskId => {
            const taskItem = tasksList.querySelector(`[data-task-id="${taskId}"]`);
            if (taskItem) {
                const activateBtn = taskItem.querySelector('.stage-task-activate-btn');
                if (activateBtn && activateBtn.dataset.isActive !== 'true') {
                    activateBtn.click();
                }
            }
        });
        
        // Clear selections
        checkedBoxes.forEach(cb => cb.classList.remove('checked'));
        updateTasksActionsButton(stageId);
    }
    
    // Delete selected tasks
    window.deleteSelectedTasks = function(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const checkedBoxes = tasksList.querySelectorAll('.stage-task-checkbox.checked');
        const taskIds = Array.from(checkedBoxes).map(cb => {
            const taskItem = cb.closest('.stage-task-item');
            return taskItem ? taskItem.dataset.taskId : null;
        }).filter(id => id !== null);
        
        if (taskIds.length === 0) return;
        
        openDeleteConfirmModal({
            title: 'Delete Tasks',
            message: `Are you sure you want to delete ${taskIds.length} task(s)?`,
            confirmText: 'Delete Tasks',
            onConfirm: function() {
        
        // Close dropdown
        const selectContainer = document.getElementById(`actionsSelect_${stageId}`);
        if (selectContainer) selectContainer.classList.remove('active');
        
        // Delete tasks
        Promise.all(taskIds.map(taskId => 
            fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        )).then(responses => {
            // Check if all deletions were successful
            const allSuccessful = responses.every(response => response.ok);
            if (!allSuccessful) {
                console.error('Some tasks failed to delete');
                if (typeof showNotification !== 'undefined') {
                    showNotification('Some tasks failed to delete', 'error');
                }
            }
            
            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
            if (!tasksSection) return;
            
            // Remove deleted tasks from DOM with fade-out animation
            taskIds.forEach((taskId, index) => {
                const taskElement = tasksList.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('fade-out');
                    setTimeout(() => {
                    taskElement.remove();
                    }, 400 + (index * 50)); // Stagger deletions slightly
                }
            });
            
            // Update task count
            const tasksHeader = tasksSection.querySelector('.stage-tasks-title');
            if (tasksHeader) {
                const remainingTasks = tasksList.querySelectorAll('.stage-task-item').length;
                if (remainingTasks === 0) {
                    // Show empty state but keep header structure
                    const tasksListEl = tasksSection.querySelector('.stage-tasks-list');
                    if (tasksListEl) {
                        tasksListEl.innerHTML = `
                            <div class="stage-tasks-empty">
                                <p style="margin: 0 0 8px 0; font-size: 0.875rem;">No tasks yet</p>
                            </div>
                        `;
                    }
                    tasksHeader.textContent = `Tasks (0)`;
                } else {
                    tasksHeader.textContent = `Tasks (${remainingTasks})`;
                }
            }
            
            // Update progress bar and stage counts
            const stageRow = document.querySelector(`[data-stage-id="${stageId}"]`);
            if (stageRow) {
                const progressBar = stageRow.querySelector('.stage-progress-fill');
                const progressLabel = stageRow.querySelector('.stage-progress-label span:last-child');
                const tasksCount = stageRow.querySelector('.stage-tasks-count');
                
                if (progressBar && progressLabel && tasksCount) {
                    const completedTasks = tasksList.querySelectorAll('.stage-task-item.completed').length;
                    const totalTasks = tasksList.querySelectorAll('.stage-task-item').length;
                    const newProgress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                    
                    progressBar.style.width = `${newProgress}%`;
                    progressLabel.textContent = `${newProgress}%`;
                    tasksCount.innerHTML = `<i class="fas fa-tasks"></i><span>${completedTasks}/${totalTasks}</span>`;
                }
            }
            
            // Update actions button state
            updateTasksActionsButton(stageId);
            
            // Update DB order after deletion
            saveDBOrder(stageId);
            
            // Reload stages to update overall progress (but keep stage expanded)
            const wasExpanded = tasksSection.classList.contains('expanded');
            if (wasExpanded) {
                // Just reload tasks without collapsing
                tasksSection.dataset.loaded = 'false';
                loadStageTasks(stageId);
            }
            
            // Update stages list without collapsing
            const stagesList = document.getElementById('stagesList');
            if (stagesList) {
                // Update the stage row progress without full reload
                // This is a lightweight update
            }
            
            if (typeof showNotification !== 'undefined') {
                showNotification(`${taskIds.length} task(s) deleted successfully`, 'success');
            }
            closeDeleteConfirmModal();
        }).catch(error => {
            console.error('Error deleting tasks:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while deleting tasks', 'error');
            }
            closeDeleteConfirmModal();
        });
            }
        });
    }
    
    // Update task order in database
    function updateTaskOrderInDB(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        const orders = [];
        tasksList.querySelectorAll('.stage-task-item').forEach((row, index) => {
            orders.push({
                task_id: parseInt(row.dataset.taskId),
                order: index + 1
            });
        });
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/reorder/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ orders: orders })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                console.error('Failed to reorder tasks:', data.error);
                // Reload tasks to restore correct order
                const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                if (tasksSection) {
                    tasksSection.dataset.loaded = 'false';
                    loadStageTasks(stageId);
                }
            } else {
                // Update original order after successful DB update
                saveOriginalTaskOrder(stageId);
            }
        })
        .catch(error => {
            console.error('Error reordering tasks:', error);
            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
            if (tasksSection) {
                tasksSection.dataset.loaded = 'false';
                loadStageTasks(stageId);
            }
        });
    }
    
    // Initialize SortableJS for tasks
    let taskSortableInstances = {};
    function initTaskSortable(stageId) {
        const tasksList = document.getElementById(`stageTasksList_${stageId}`);
        if (!tasksList) return;
        
        // Destroy existing instance if any
        if (taskSortableInstances[stageId]) {
            taskSortableInstances[stageId].destroy();
        }
        
        // Wait for Sortable to be loaded
        if (typeof Sortable === 'undefined') {
            setTimeout(() => initTaskSortable(stageId), 100);
            return;
        }
        
        taskSortableInstances[stageId] = new Sortable(tasksList, {
            animation: 150,
            handle: '.stage-task-drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            forceFallback: false,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            onStart: function(evt) {
                evt.item.style.opacity = '0.5';
            },
            onEnd: function(evt) {
                evt.item.style.opacity = '1';
                if (evt.newIndex === evt.oldIndex) return;
                
                // Check if sort is active
                const currentSortMode = taskSortMode[stageId];
                const draggedTaskId = parseInt(evt.item.dataset.taskId);
                
                if (currentSortMode) {
                    // Sort is active - need to restore DB order first to calculate correct new DB order
                    restoreDBOrder(stageId);
                    
                    // Get the new position in DB order
                    const tasks = Array.from(tasksList.querySelectorAll('.stage-task-item'));
                    const newIndex = tasks.findIndex(t => parseInt(t.dataset.taskId) === draggedTaskId);
                    
                    // Calculate new DB order based on the drag position in DB order
                    const currentDBOrder = [...taskDBOrder[stageId]];
                    const oldIndexInDB = currentDBOrder.indexOf(draggedTaskId);
                    
                    // Remove from old position
                    currentDBOrder.splice(oldIndexInDB, 1);
                    // Insert at new position
                    currentDBOrder.splice(newIndex, 0, draggedTaskId);
                    
                    // Update DB order in memory
                    taskDBOrder[stageId] = currentDBOrder;
                    
                    // Restore DB order temporarily
                    restoreDBOrder(stageId);
                    
                    // Send new order to backend
                    const orders = [];
                    currentDBOrder.forEach((taskId, index) => {
                        orders.push({
                            task_id: taskId,
                            order: index + 1
                        });
                    });
                    
                    fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/reorder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            console.error('Failed to reorder tasks:', data.error);
                            // Reload tasks to restore correct order
                            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                            if (tasksSection) {
                                tasksSection.dataset.loaded = 'false';
                                loadStageTasks(stageId);
                            }
                        } else {
                            // Update DB order in memory after successful save
                            saveDBOrder(stageId);
                            // Reapply sort after DB update
                            sortTasksByPriority(stageId, currentSortMode);
                        }
                    })
                    .catch(error => {
                        console.error('Error reordering tasks:', error);
                        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                        if (tasksSection) {
                            tasksSection.dataset.loaded = 'false';
                            loadStageTasks(stageId);
                        }
                    });
                } else {
                    // No sort active - directly update DB order based on current DOM position
                    const orders = [];
                    tasksList.querySelectorAll('.stage-task-item').forEach((row, index) => {
                        orders.push({
                            task_id: parseInt(row.dataset.taskId),
                            order: index + 1
                        });
                    });
                    
                    // Update DB order in memory
                    taskDBOrder[stageId] = orders.map(o => o.task_id);
                    
                    fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/reorder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            console.error('Failed to reorder tasks:', data.error);
                            // Reload tasks to restore correct order
                            const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                            if (tasksSection) {
                                tasksSection.dataset.loaded = 'false';
                                loadStageTasks(stageId);
                            }
                        } else {
                            // Update DB order in memory after successful save
                            saveDBOrder(stageId);
                        }
                    })
                    .catch(error => {
                        console.error('Error reordering tasks:', error);
                        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                        if (tasksSection) {
                            tasksSection.dataset.loaded = 'false';
                            loadStageTasks(stageId);
                        }
                    });
                }
            }
        });
    }
    
    // Create task
    // Handle task input change - enable/disable Add Task button and show/hide description
    window.handleTaskInputChange = function(stageId, event) {
        const input = document.getElementById(`stageTaskInput_${stageId}`);
        const addBtn = document.getElementById(`btnAddTask_${stageId}`);
        const description = document.getElementById(`stageTaskDescription_${stageId}`);
        const priorityTags = document.getElementById(`stageTaskPriorityTags_${stageId}`);
        const aiBtn = document.getElementById(`btnAiGenerate_${stageId}`);
        const clearBtn = document.getElementById(`stageTaskInputClear_${stageId}`);
        
        if (input && addBtn) {
            const hasText = input.value.trim().length > 0;
            addBtn.disabled = !hasText;
            
            // Show/hide clear button
            if (clearBtn) {
                if (hasText) {
                    clearBtn.classList.add('show');
                } else {
                    clearBtn.classList.remove('show');
                }
            }
            
            // Disable AI button when Add Task is enabled, and vice versa
            if (aiBtn) {
                aiBtn.disabled = hasText;
            }
            
            // Show/hide description textarea and priority tags
            if (description && priorityTags) {
                if (hasText) {
                    description.classList.add('show');
                    priorityTags.classList.add('show');
                } else {
                    description.classList.remove('show');
                    description.value = ''; // Clear description when input is cleared
                    priorityTags.classList.remove('show');
                }
            }
        }
    };
    
    // Clear task input
    window.clearTaskInput = function(stageId) {
        const input = document.getElementById(`stageTaskInput_${stageId}`);
        if (input) {
            input.value = '';
            input.focus();
            // Trigger the change handler to update button states
            handleTaskInputChange(stageId, null);
        }
    };
    
    // Handle priority selection
    window.selectPriority = function(stageId, priority) {
        const priorityTags = document.getElementById(`stageTaskPriorityTags_${stageId}`);
        if (!priorityTags) return;
        
        // Remove selected class from all tags
        priorityTags.querySelectorAll('.priority-tag').forEach(tag => {
            tag.classList.remove('selected');
        });
        
        // Add selected class to clicked tag
        const selectedTag = priorityTags.querySelector(`[data-priority="${priority}"]`);
        if (selectedTag) {
            selectedTag.classList.add('selected');
        }
    };
    
    // Handle Enter key press in task input
    window.handleTaskInputKeydown = function(stageId, event) {
        if (event.key === 'Enter' || event.keyCode === 13) {
            event.preventDefault();
            const addBtn = document.getElementById(`btnAddTask_${stageId}`);
            if (addBtn && !addBtn.disabled) {
                createTaskFromInput(stageId);
            }
        }
    };
    
    // Create task from input field
    window.createTaskFromInput = function(stageId) {
        const input = document.getElementById(`stageTaskInput_${stageId}`);
        if (!input) return;
        
        const title = input.value.trim();
        if (!title) {
            return;
        }
        
        const description = document.getElementById(`stageTaskDescription_${stageId}`);
        const descriptionText = description ? description.value.trim() : '';
        const priorityTags = document.getElementById(`stageTaskPriorityTags_${stageId}`);
        let priority = 'medium'; // Default priority
        
        // Get priority from selected tag (works even if tags are hidden)
        if (priorityTags) {
            const selectedPriorityTag = priorityTags.querySelector('.priority-tag.selected');
            if (selectedPriorityTag && selectedPriorityTag.dataset.priority) {
                priority = selectedPriorityTag.dataset.priority;
            } else {
                // If no tag is selected, find and select medium by default
                const mediumTag = priorityTags.querySelector('[data-priority="medium"]');
                if (mediumTag) {
                    // Remove selected from all tags first
                    priorityTags.querySelectorAll('.priority-tag').forEach(tag => {
                        tag.classList.remove('selected');
                    });
                    mediumTag.classList.add('selected');
                    priority = 'medium';
                }
            }
        }
        
        // Validate priority value (must be one of the valid choices)
        const validPriorities = ['low', 'medium', 'high', 'urgent'];
        if (!validPriorities.includes(priority)) {
            console.warn(`Invalid priority "${priority}", defaulting to "medium"`);
            priority = 'medium';
        }
        
        console.log('Creating task with priority:', priority); // Debug log
        
        const addBtn = document.getElementById(`btnAddTask_${stageId}`);
        
        // Disable button and inputs while creating
        if (addBtn) addBtn.disabled = true;
        input.disabled = true;
        if (description) description.disabled = true;
        if (priorityTags) {
            priorityTags.querySelectorAll('.priority-tag').forEach(tag => {
                tag.style.pointerEvents = 'none';
            });
        }
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/create/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: title,
                description: descriptionText,
                priority: priority
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.task_id) {
                // Clear inputs only after successful creation
                input.value = '';
                if (description) description.value = '';
                
                // Re-enable inputs
                input.disabled = false;
                if (addBtn) addBtn.disabled = true;
                const aiBtn = document.getElementById(`btnAiGenerate_${stageId}`);
                if (aiBtn) aiBtn.disabled = false;
                if (description) {
                    description.disabled = false;
                    description.classList.remove('show');
                }
                if (priorityTags) {
                    priorityTags.classList.remove('show');
                    priorityTags.querySelectorAll('.priority-tag').forEach(tag => {
                        tag.classList.remove('selected');
                        tag.style.pointerEvents = '';
                    });
                    // Reset to medium priority
                    const mediumTag = priorityTags.querySelector('[data-priority="medium"]');
                    if (mediumTag) mediumTag.classList.add('selected');
                }
                // Declare tasksSection once at the start of the success block
                const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                const tasksList = tasksSection ? tasksSection.querySelector('.stage-tasks-list') : null;
                const tasksHeader = tasksSection ? tasksSection.querySelector('.stage-tasks-title') : null;
                const isEmptyState = tasksSection ? tasksSection.querySelector('.stage-tasks-empty') : null;
                
                // Remove empty state if it exists
                if (isEmptyState) {
                    isEmptyState.remove();
                }
                
                // Create tasks header and list if they don't exist
                if (!tasksList || !tasksHeader) {
                    tasksSection.innerHTML = `
                        <div class="stage-tasks-header">
                            <div class="stage-tasks-title">
                                <div class="stage-tasks-select-all-checkbox" id="selectAllTasks_${stageId}" onclick="toggleSelectAllTasks(${stageId}, event)"></div>
                                Tasks (1)
                            </div>
                            <div class="stage-tasks-header-actions">
                                <button class="btn-sort-tasks" id="btnSortHigh_${stageId}" onclick="togglePrioritySort(${stageId}, 'high')" title="Sort Priority High to Low">
                                    <i class="fas fa-sort-amount-down"></i>
                                </button>
                                <button class="btn-sort-tasks" id="btnSortLow_${stageId}" onclick="togglePrioritySort(${stageId}, 'low')" title="Sort Priority Low to High">
                                    <i class="fas fa-sort-amount-up"></i>
                                </button>
                                <div class="stage-tasks-actions-select" id="actionsSelect_${stageId}">
                                    <button class="custom-select-trigger-actions" id="btnActionsTasks_${stageId}" onclick="toggleTasksActionsDropdown(${stageId}, event)" disabled>
                                        Actions <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="custom-select-menu-actions" id="tasksActionsMenu_${stageId}">
                                        <button class="custom-select-item-actions first-item" onclick="activateSelectedTasks(${stageId})">
                                            <i class="fas fa-check-circle"></i> <span>Activate</span>
                                        </button>
                                        <button class="custom-select-item-actions last-item" onclick="deleteSelectedTasks(${stageId})">
                                            <i class="fas fa-trash"></i> <span>Delete</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="stage-tasks-list" id="stageTasksList_${stageId}" data-filter="all"></div>
                    `;
                }
                
                // Get the tasks list (might have been just created)
                const currentTasksList = tasksSection.querySelector('.stage-tasks-list');
                const currentTasksHeader = tasksSection.querySelector('.stage-tasks-title');
                
                // Enable sort buttons if they exist
                const sortHighBtn = document.getElementById(`btnSortHigh_${stageId}`);
                const sortLowBtn = document.getElementById(`btnSortLow_${stageId}`);
                if (sortHighBtn) sortHighBtn.disabled = false;
                if (sortLowBtn) sortLowBtn.disabled = false;
                
                if (currentTasksList && currentTasksHeader) {
                    // Create new task element using the title from input
                    const priorityLabel = priority.charAt(0).toUpperCase() + priority.slice(1);
                    const newTaskHtml = `
                        <div class="stage-task-item" data-task-id="${data.task_id}" data-priority="${priority}" style="opacity: 0; transform: translateY(-10px);">
                            <div class="stage-task-drag-handle">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="stage-task-checkbox-container">
                                <div class="stage-task-checkbox" onclick="toggleTaskSelection(${data.task_id}, ${stageId}, event)"></div>
                            </div>
                            <div class="stage-task-content">
                                <div class="stage-task-title-row">
                                    <div class="stage-task-title">${escapeHtml(title)}</div>
                                    ${(data.deadline && data.deadline !== '') ? `<div class="active-backlog-task-deadline"><i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i><span>${new Date(data.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span></div>` : ''}
                                </div>
                                ${descriptionText ? `<div class="stage-task-description-text">${escapeHtml(descriptionText)}</div>` : ''}
                            </div>
                            <div class="stage-task-priority-display" onclick="openCreateActiveBacklogTaskModal(${data.task_id}, '${(title || '').replace(/'/g, "\\'").replace(/\n/g, ' ')}', '${(descriptionText || '').replace(/'/g, "\\'").replace(/\n/g, '\\n')}', '${data.deadline || ''}', '${priority}', PROJECT_ID, ${stageId}, CLIENT_ID)">
                                <span class="priority-tag priority-${priority}">${priorityLabel}</span>
                            </div>
                            <div class="stage-task-activate">
                                <button class="stage-task-activate-btn" 
                                        data-task-id="${data.task_id}"
                                        data-is-active="false"
                                        data-is-completed="false"
                                        data-is-archived="false"
                                        onmouseover="updateActivateButton(this, true, false, false)"
                                        onmouseout="updateActivateButton(this, false, false, false)"
                                        onclick="toggleTaskActivation(${data.task_id}, ${stageId}, event)">
                                    <span class="button-text"><i class="fas fa-pause"></i> Not Active</span>
                                </button>
                            </div>
                            <div class="stage-task-actions">
                                <button class="stage-task-dropdown-trigger" onclick="toggleTaskDropdown(${data.task_id}, event)">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Insert at the top of the list
                    currentTasksList.insertAdjacentHTML('afterbegin', newTaskHtml);
                    
                    // Update task count
                    const currentCount = parseInt(currentTasksHeader.textContent.match(/\d+/)?.[0] || '0');
                    currentTasksHeader.textContent = `Tasks (${currentCount + 1})`;
                    
                    // Add fade-in animation to new task
                    const newTaskElement = currentTasksList.querySelector(`[data-task-id="${data.task_id}"]`);
                    if (newTaskElement) {
                        newTaskElement.classList.add('fade-in');
                    }
                    
                    // Update max-height smoothly
                setTimeout(() => {
                    setRoadmapContainerMaxHeight();
                    }, 50);
                    
                    // Update progress bar directly without reloading stages
                    const stageRow = document.querySelector(`[data-stage-id="${stageId}"]`);
                    if (stageRow) {
                        const progressBar = stageRow.querySelector('.stage-progress-fill');
                        const progressLabel = stageRow.querySelector('.stage-progress-label span:last-child');
                        const tasksCount = stageRow.querySelector('.stage-tasks-count');
                        
                        if (progressBar && progressLabel && tasksCount) {
                            // Get current counts
                            const currentCountText = tasksCount.textContent.trim();
                            const match = currentCountText.match(/(\d+)\/(\d+)/);
                            if (match) {
                                const completed = parseInt(match[1]);
                                const total = parseInt(match[2]) + 1; // Add 1 for new task
                                const newProgress = Math.round((completed / total) * 100);
                                
                                // Update progress bar
                                progressBar.style.width = `${newProgress}%`;
                                progressLabel.textContent = `${newProgress}%`;
                                
                                // Update tasks count
                                tasksCount.innerHTML = `<i class="fas fa-tasks"></i><span>${completed}/${total}</span>`;
                            } else if (currentCountText.includes('no tasks')) {
                                // If it was "no tasks yet", update to show 0/1
                                const newProgress = 0;
                                progressBar.style.width = `${newProgress}%`;
                                progressLabel.textContent = `${newProgress}%`;
                                tasksCount.innerHTML = `<i class="fas fa-tasks"></i><span>0/1</span>`;
                            }
                        }
                    }
            } else {
                    // Fallback: reload tasks from server to ensure consistency
                    const fallbackTasksSection = document.getElementById(`stageTasks_${stageId}`);
                    if (fallbackTasksSection) {
                        fallbackTasksSection.dataset.loaded = 'false';
                        loadStageTasks(stageId);
                    }
                }
                
                // Save DB order after task creation
                saveDBOrder(stageId);
                
                // Initialize sortable for the new task
                initTaskSortable(stageId);
                
                // Reload stages to update completion status if stage was completed before
                // Check if the stage is currently open/expanded
                // Get tasksSection again to check if stage is expanded (works for both success paths)
                const checkTasksSection = document.getElementById(`stageTasks_${stageId}`);
                if (checkTasksSection && checkTasksSection.classList.contains('expanded')) {
                    // Reload all stages to update completion status
                    if (typeof loadStages === 'function') {
                        loadStages();
                    }
                }
                
                if (typeof showNotification !== 'undefined') {
                    showNotification('Task created successfully', 'success');
                }
                } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to create task', 'error');
                } else {
                    alert(data.error || 'Failed to create task');
                }
            }
        })
        .catch(error => {
            console.error('Error creating task:', error);
            input.disabled = false;
            if (addBtn) addBtn.disabled = false;
            const description = document.getElementById(`stageTaskDescription_${stageId}`);
            if (description) description.disabled = false;
            const priorityTags = document.getElementById(`stageTaskPriorityTags_${stageId}`);
            if (priorityTags) {
                priorityTags.querySelectorAll('.priority-tag').forEach(tag => {
                    tag.style.pointerEvents = '';
                });
            }
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    };
    
    // Keep the old createTask function for backward compatibility (used in empty state)
    window.createTask = function(stageId) {
        const title = prompt('Enter task title:');
        if (!title || !title.trim()) {
            return;
        }
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/create/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: title.trim(),
                description: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Preserve expanded state - keep this stage open
                const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                const wasExpanded = tasksSection && tasksSection.classList.contains('expanded');
                
                // Reload stages to update progress
                loadStages();
                
                // After stages reload, re-expand and reload tasks for this stage
                setTimeout(() => {
                    const newTasksSection = document.getElementById(`stageTasks_${stageId}`);
                    if (newTasksSection && wasExpanded) {
                        newTasksSection.classList.add('expanded');
                        newTasksSection.dataset.loaded = 'false';
                        loadStageTasks(stageId);
                    }
                    
                    // Update overlay and max-height
                    updateTasksOverlay();
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            setRoadmapContainerMaxHeight();
                        });
                    });
                }, 100);
                
                if (typeof showNotification !== 'undefined') {
                    showNotification('Task created successfully', 'success');
                } else {
                    alert('Task created successfully');
                }
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to create task', 'error');
                } else {
                    alert(data.error || 'Failed to create task');
                }
            }
        })
        .catch(error => {
            console.error('Error creating task:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    }
    
    // Generate tasks with AI
    window.generateTasksAI = function(stageId) {
        // Check subscription first
        if (!checkAISubscription()) {
            showFreeSubscriptionToast();
            return;
        }
        
        const aiBtn = document.getElementById('btnAiGenerate_' + stageId);
        if (aiBtn && aiBtn.disabled) {
            return;
        }
        const originalContent = aiBtn.innerHTML;
        aiBtn.disabled = true;
        aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        function restoreBtn() {
            aiBtn.disabled = false;
            aiBtn.innerHTML = originalContent;
        }
        
        return fetch('/dashboard/user/projects/' + PROJECT_ID + '/stages/' + stageId + '/tasks/generate-ai/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            if (!response || !response.json) return;
            return response.json().then(function(data) {
                if (data.success) {
                    if (typeof loadStageTasks === 'function') {
                        loadStageTasks(stageId);
                    }
                    if (typeof loadStages === 'function') {
                        loadStages();
                    }
                    if (typeof showNotification !== 'undefined') {
                        showNotification(data.message || 'Tasks generated successfully!', 'success');
                    }
                } else {
                    if (typeof showNotification !== 'undefined') {
                        showNotification(data.error || 'Failed to generate tasks', 'error');
                    } else {
                        alert(data.error || 'Failed to generate tasks');
                    }
                }
                restoreBtn();
            });
        })
        .catch(function(err) {
            if (err === 'no_coins') return;
            console.error('Error generating tasks:', err);
            restoreBtn();
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Update activate button text on hover
    window.updateActivateButton = function(button, showActivate, isCompleted, isArchived) {
        const isActive = button.dataset.isActive === 'true';
        const isCompletedState = button.dataset.isCompleted === 'true' || isCompleted === true;
        const isArchivedState = button.dataset.isArchived === 'true' || isArchived === true;
        
        if (isArchivedState) {
            // Archived tasks - no hover change
            button.textContent = 'Archived';
            return;
        }
        
        if (isCompletedState) {
            // Completed tasks - show "Archive" with icon on hover, "Completed" with icon by default
            if (showActivate) {
                button.innerHTML = '<i class="fas fa-archive"></i> Archive';
            } else {
                button.innerHTML = '<i class="fas fa-check-circle"></i> Completed';
            }
        } else if (showActivate && !isActive) {
            // Show "Activate" with icon on hover (icon to the right of text)
            button.innerHTML = 'Activate <div class="deactivate-icon-stack" style="position: relative; display: inline-flex; align-items: center; margin-left: 4px; width: 24px;"><i class="fas fa-list" style="font-size: 0.7rem; position: absolute; left: 2px; color: #047857;"></i><i class="fas fa-chevron-right" style="font-size: 0.5rem; position: absolute; left: 17px; top: -4px; color: #047857;"></i></div>';
        } else if (!showActivate && !isActive) {
            // Restore original "Not Active" text with icon
            button.innerHTML = '<span class="button-text"><i class="fas fa-pause"></i><span style="margin-left: 6px;">Not Active</span></span>';
        } else if (isActive) {
            if (showActivate) {
                // Show "Deactivate" with icon on hover (icon to the left of text, same as active backlog)
                button.innerHTML = '<div class="deactivate-icon-stack" style="position: relative; display: inline-flex; align-items: center; margin-right: 16px;"><i class="fas fa-list" style="font-size: 0.7rem; position: absolute; left: 2px; color: #ef4444;"></i><i class="fas fa-chevron-left" style="font-size: 0.5rem; position: absolute; left: -8px; color: #ef4444;"></i></div> Deactivate';
            } else {
                // Show "Active" with icon when not hovering
                button.innerHTML = '<span class="button-text"><i class="fas fa-play"></i><span style="margin-left: 6px;">Active</span></span>';
            }
        }
    };
    
    // Toggle task activation (assign to client active backlog)
    window.toggleTaskActivation = function(taskId, stageId, event) {
        event.stopPropagation();
        
        const button = event.target.closest('.stage-task-activate-btn');
        if (!button) return;
        
        const taskItem = button.closest('.stage-task-item');
        if (!taskItem) return;
        
        const isActive = button.dataset.isActive === 'true';
        const newState = !isActive;
        
        // Get current filter
        const filterSelect = document.getElementById(`taskFilter_${stageId}`);
        const currentFilter = filterSelect ? filterSelect.value : 'all';
        
        // Disable button during request
        button.disabled = true;
        const originalText = button.textContent;
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/${taskId}/toggle-activate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activate: newState
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            button.disabled = false;
            if (data.success) {
                // Update button state
                button.dataset.isActive = newState.toString();
                button.textContent = newState ? 'Active' : 'Not Active';
            button.dataset.isCompleted = 'false';
                if (newState) {
                    button.classList.add('active');
                button.classList.remove('completed');
                taskItem.setAttribute('data-status', 'active');
                } else {
                    button.classList.remove('active');
                taskItem.setAttribute('data-status', 'pending');
            }
                
                // If activating and filter is "Not Active", animate removal
                if (newState && currentFilter === 'not_active') {
                    taskItem.classList.add('fade-out');
                    setTimeout(() => {
                        taskItem.remove();
                        // Reload tasks to update count properly
                        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    renderStageTasks(stageId, data.tasks || []);
                                }
                            });
                    }, 400);
                } else if (!newState && currentFilter === 'active') {
                    // If deactivating and filter is "Active", animate removal
                    taskItem.classList.add('fade-out');
                    setTimeout(() => {
                        taskItem.remove();
                        // Reload tasks to update count properly
                        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    renderStageTasks(stageId, data.tasks || []);
                                }
                            });
                    }, 400);
                } else {
                    // If filter is "All", just update the task count without removing
                    const tasksList = document.getElementById(`stageTasksList_${stageId}`);
                    if (tasksList) {
                        const allTasks = tasksList.querySelectorAll('.stage-task-item:not(.fade-out)').length;
                        const tasksHeader = document.querySelector(`#stageTasks_${stageId} .stage-tasks-title`);
                        if (tasksHeader) {
                            const filterSelect = document.getElementById(`taskFilter_${stageId}`);
                            const currentFilter = filterSelect ? filterSelect.value : 'not_active';
                            let filteredCount = allTasks;
                            if (currentFilter === 'active') {
                                filteredCount = Array.from(tasksList.querySelectorAll('.stage-task-item:not(.fade-out)')).filter(item => item.querySelector('.stage-task-activate-btn')?.dataset.isActive === 'true').length;
                            } else if (currentFilter === 'not_active') {
                                filteredCount = Array.from(tasksList.querySelectorAll('.stage-task-item:not(.fade-out)')).filter(item => item.querySelector('.stage-task-activate-btn')?.dataset.isActive !== 'true').length;
                            }
                            tasksHeader.innerHTML = tasksHeader.innerHTML.replace(/Tasks \(\d+.*?\)/, `Tasks (${filteredCount}${currentFilter !== 'all' ? ` / ${allTasks}` : ''})`);
                        }
                    }
                }
                
                // Reload active backlog when activating or deactivating
                loadUserActiveBacklog();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update task activation', 'error');
                } else {
                    alert(data.error || 'Failed to update task activation');
                }
            }
        })
        .catch(error => {
            console.error('Error toggling task activation:', error);
            button.disabled = false;
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    };
    
    // Show completed tasks for a project
    window.showCompletedTasks = function(projectId) {
        // Find the first stage with completed tasks and switch to completed view
        const roadmapContainer = document.querySelector('.roadmap-container');
        if (!roadmapContainer) return;
        
        // Find all stages in the project
        const stages = roadmapContainer.querySelectorAll('.stage-row');
        let foundStage = null;
        let checkedStages = 0;
        const totalStages = stages.length;
        
        // Check each stage for completed tasks
        stages.forEach(stageRow => {
            const stageId = stageRow.dataset.stageId;
            if (!stageId) {
                checkedStages++;
                return;
            }
            
            // Fetch tasks for this stage to check for completed ones
            fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                .then(response => response.json())
                .then(data => {
                    checkedStages++;
                    if (data.success && !foundStage) {
                        const completedTasks = (data.tasks || []).filter(t => t.completed === true && t.status !== 'archived');
                        if (completedTasks.length > 0) {
                            foundStage = stageId;
                            
                            // Expand the stage if not expanded
                            const tasksSection = document.getElementById(`stageTasks_${foundStage}`);
                            if (tasksSection && !tasksSection.classList.contains('expanded')) {
                                toggleStageTasks(foundStage, { stopPropagation: () => {} });
                            }
                            
                            // Set filter to completed
                            setTimeout(() => {
                                const filterSelect = document.getElementById(`taskFilter_${foundStage}`);
                                if (filterSelect) {
                                    filterSelect.value = 'completed';
                                    filterStageTasks(foundStage, 'completed');
                                }
                            }, 300);
                        }
                    }
                    
                    // If we've checked all stages and found nothing
                    if (checkedStages === totalStages && !foundStage) {
                        if (typeof showNotification !== 'undefined') {
                            showNotification('No completed tasks found', 'info');
                        }
                    }
                })
                .catch(error => {
                    checkedStages++;
                    console.error('Error checking stage for completed tasks:', error);
                    if (checkedStages === totalStages && !foundStage) {
                        if (typeof showNotification !== 'undefined') {
                            showNotification('No completed tasks found', 'info');
                        }
                    }
                });
        });
    };
    
    // Filter stage tasks to completed view
    window.filterStageTasksToCompleted = function(stageId) {
        // Expand the stage if not expanded
        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
        if (tasksSection && !tasksSection.classList.contains('expanded')) {
            toggleStageTasks(stageId, { stopPropagation: () => {} });
            // Wait for expansion, then set filter
            setTimeout(() => {
                const filterSelect = document.getElementById(`taskFilter_${stageId}`);
                if (filterSelect) {
                    filterSelect.value = 'completed';
                    filterStageTasks(stageId, 'completed');
                }
            }, 300);
        } else {
            // Stage already expanded, just set filter
            const filterSelect = document.getElementById(`taskFilter_${stageId}`);
            if (filterSelect) {
                filterSelect.value = 'completed';
                filterStageTasks(stageId, 'completed');
            }
        }
    };
    
    // Filter stage tasks
    window.filterStageTasks = function(stageId, filterValue) {
        // Reload tasks with filter applied
        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
        if (tasksSection && tasksSection.dataset.loaded === 'true') {
            // Re-fetch tasks and re-render with filter
            fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        renderStageTasks(stageId, data.tasks || []);
                    }
                })
                .catch(error => {
                    console.error('Error filtering tasks:', error);
                });
        }
    };
    
    // Archive a completed task
    window.archiveTask = function(taskId, stageId, event) {
        event.stopPropagation();
        
        const button = event.target.closest('.stage-task-activate-btn');
        if (!button) return;
        
        button.disabled = true;
        const originalText = button.textContent;
        
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/${taskId}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            button.disabled = false;
            if (data.success) {
                // Fade out the task before reloading
                const taskItem = button.closest('.stage-task-item');
                if (taskItem) {
                    taskItem.classList.add('fade-out');
                    setTimeout(() => {
                        // Reload tasks to reflect archive status
                        const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                        if (tasksSection && tasksSection.dataset.loaded === 'true') {
                            fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        renderStageTasks(stageId, data.tasks || []);
                                    }
                                });
                        }
                    }, 400);
                } else {
                    // Fallback if task item not found
                    const tasksSection = document.getElementById(`stageTasks_${stageId}`);
                    if (tasksSection && tasksSection.dataset.loaded === 'true') {
                        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/api/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    renderStageTasks(stageId, data.tasks || []);
                                }
                            });
                    }
                }
                
                // Reload stages to update "To be Reviewed" badge count
                if (typeof loadStages === 'function') {
                    loadStages();
                }
                
                if (typeof showNotification !== 'undefined') {
                    showNotification('Task archived successfully', 'success');
                }
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to archive task', 'error');
                } else {
                    alert(data.error || 'Failed to archive task');
                }
            }
        })
        .catch(error => {
            console.error('Error archiving task:', error);
            button.disabled = false;
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred', 'error');
            } else {
                alert('An error occurred');
            }
        });
    };
    
    // Toggle task dropdown menu
    window.deleteTask = function(taskId, stageId, event) {
        if (event) {
            event.stopPropagation();
        }
        
        openDeleteConfirmModal({
            title: 'Delete Task',
            message: 'Are you sure you want to delete this task?',
            confirmText: 'Delete Task',
            onConfirm: function() {
                fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/${stageId}/tasks/${taskId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Find and remove the task element with fade-out animation
                        const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
                        if (taskItem) {
                            taskItem.classList.add('fade-out');
                            setTimeout(() => {
                                taskItem.remove();
                                // Reload stage tasks to update counts
                                loadStageTasks(stageId);
                            }, 300);
                        }
                        
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Task deleted successfully', 'success');
                        }
                        closeDeleteConfirmModal();
                    } else {
                        throw new Error('Failed to delete task');
                    }
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    if (typeof showNotification !== 'undefined') {
                        showNotification('An error occurred while deleting the task', 'error');
                    } else {
                        alert('An error occurred while deleting the task');
                    }
                    closeDeleteConfirmModal();
                });
            }
        });
    };

    // Return all scrollable ancestors of el (attach to every scroll that might move the trigger)
    // Close tasks actions menus when clicking outside (stage row dropdowns use base template toggleDropdown)
    document.addEventListener('click', function(event) {
        if (event.target.closest('.stage-tasks-actions-select')) {
            return;
        }
        document.querySelectorAll('.tasks-actions-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    });

    // Edit stage - open modal with stage data
    window.editStage = function(stageId) {
        // Close dropdown (same as upcoming sessions - uses .dropdown and clearSessionDropdownFixed from base)
        const rowActions = document.getElementById('rowActions_' + stageId);
        if (rowActions) {
            const menu = rowActions.querySelector('.dropdown-menu.show');
            if (menu) {
                menu.classList.remove('show');
                if (typeof clearSessionDropdownFixed === 'function') clearSessionDropdownFixed(menu);
            }
        }

        // Fetch stage data
        fetch(`/dashboard/user/projects/${PROJECT_ID}/stages/api/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                const stage = data.stages.find(s => s.id === stageId);
                if (stage) {
                    // Open modal with stage data
                    if (typeof openCreateStageModalForEdit !== 'undefined') {
                        openCreateStageModalForEdit(stage);
                    } else {
                        // Fallback: open modal and populate manually
                        openCreateStageModal();
                        setTimeout(() => {
                            document.getElementById('stageTitleInput').value = stage.title;
                            document.getElementById('stageDescriptionInput').value = stage.description || '';
                            if (stage.start_date) {
                                document.getElementById('stageStartDateInput').value = stage.start_date;
                            }
                            if (stage.end_date) {
                                document.getElementById('stageEndDateInput').value = stage.end_date;
                            }
                            document.getElementById('editingStageId').value = stageId;
                            document.getElementById('createStageModalTitle').textContent = 'Edit Stage';
                            document.getElementById('createStageBtn').textContent = 'Update Stage';
                        }, 100);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching stage data:', error);
            alert('Failed to load stage data. Please try again.');
        });
    };

    // Assign Project Owner Modal Functions - Make them globally accessible
    window.openAssignProjectOwnerModal = function() {
        const modal = document.getElementById('assignProjectOwnerModal');
        const emailInput = document.getElementById('assignOwnerEmailInput');
        const assignBtn = document.getElementById('assignOwnerBtn');
        
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(function() {
                modal.classList.add('active');
            }, 10);
            if (emailInput) {
                emailInput.value = '';
                emailInput.focus();
            }
            if (assignBtn) assignBtn.disabled = true;
        }
    };
    
    window.closeAssignProjectOwnerModal = function() {
        const modal = document.getElementById('assignProjectOwnerModal');
        const emailInput = document.getElementById('assignOwnerEmailInput');
        const suggestions = document.getElementById('assignOwnerEmailSuggestions');
        
        if (modal) {
            modal.classList.remove('active');
            setTimeout(function() {
                modal.style.display = 'none';
            }, 300);
        }
        if (emailInput) emailInput.value = '';
        if (suggestions) {
            suggestions.hidden = true;
            suggestions.innerHTML = '';
        }
    };
    
    window.assignProjectOwner = function() {
        const emailInput = document.getElementById('assignOwnerEmailInput');
        const assignBtn = document.getElementById('assignOwnerBtn');
        const email = emailInput ? emailInput.value.trim() : '';
        
        if (!email) {
            if (typeof showNotification === 'function') {
                showNotification('error', 'Please enter a client email address.');
            }
            return;
        }
        
        if (assignBtn) {
            assignBtn.disabled = true;
            assignBtn.textContent = 'Assigning...';
        }
        
        const projectId = {{ project.id }};
        const url = '/dashboard/user/projects/' + projectId + '/assign-owner/';
        
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ email: email })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                if (typeof showNotification === 'function') {
                    showNotification('success', data.message || 'Project assigned successfully!');
                }
                window.closeAssignProjectOwnerModal();
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification('error', data.error || 'Failed to assign project.');
                }
                if (assignBtn) {
                    assignBtn.disabled = false;
                    assignBtn.textContent = 'Assign Project';
                }
            }
        })
        .catch(function(error) {
            console.error('Error assigning project owner:', error);
            if (typeof showNotification === 'function') {
                showNotification('error', 'An error occurred. Please try again.');
            }
            if (assignBtn) {
                assignBtn.disabled = false;
                assignBtn.textContent = 'Assign Project';
            }
        });
    };
    
    // Setup email input with suggestions for assign owner modal
    // NOTE: Users don't assign project owners (they ARE the owners), so this functionality is not needed
    // The assignProjectOwnerModal exists in the template but is never shown for users
    // If needed in the future, uncomment and add client_suggestions URL

    // Supervisor Modal Functions - Make them globally accessible
    window.openSupervisorModal = function() {
        const modal = document.getElementById('supervisorModal');
        if (modal) {
            // Reset to info view when opening
            const infoView = document.getElementById('supervisorInfoView');
            const confirmView = document.getElementById('supervisorConfirmView');
            if (infoView && confirmView) {
                infoView.style.display = 'block';
                confirmView.style.display = 'none';
            }
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    }

    window.openSupervisorModalWithConfirmation = function() {
        const modal = document.getElementById('supervisorModal');
        if (modal) {
            // Show confirmation view immediately
            const infoView = document.getElementById('supervisorInfoView');
            const confirmView = document.getElementById('supervisorConfirmView');
            if (infoView && confirmView) {
                infoView.style.display = 'none';
                confirmView.style.display = 'block';
            }
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
        // Close the dropdown menu
        const dropdown = document.getElementById('projectSettingsDropdown');
        if (dropdown) {
            dropdown.classList.remove('active');
        }
    }

    window.closeSupervisorModal = function() {
        const modal = document.getElementById('supervisorModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    }

    window.showRemoveConfirmation = function() {
        const infoView = document.getElementById('supervisorInfoView');
        const confirmView = document.getElementById('supervisorConfirmView');
        if (infoView && confirmView) {
            infoView.style.display = 'none';
            confirmView.style.display = 'block';
        }
    }

    window.hideRemoveConfirmation = function() {
        const infoView = document.getElementById('supervisorInfoView');
        const confirmView = document.getElementById('supervisorConfirmView');
        if (infoView && confirmView) {
            infoView.style.display = 'block';
            confirmView.style.display = 'none';
        }
    }

    window.confirmRemoveSupervisor = function() {
        const btn = document.querySelector('.btn-confirm-remove');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
        }

        fetch(`/dashboard/user/projects/${PROJECT_ID}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ action: 'remove_supervisor' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.closeSupervisorModal();
                
                // Show notification
                {% if is_owner %}
                showNotification('Supervisor removed successfully', 'success');
                {% else %}
                let message = 'Successfully removed yourself from the project';
                if (data.project_title) {
                    message += ` "${data.project_title}"`;
                }
                if (data.client_name) {
                    message += ` owned by ${data.client_name}`;
                }
                showNotification(message, 'success');
                
                // Redirect to projects list after a short delay (only for mentors)
                setTimeout(() => {
                    window.location.href = '{% url "general:dashboard_user:projects_list" %}';
                }, 1000);
                return;
                {% endif %}
                
                // Reload page for owners
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.error || 'Failed to remove supervisor', 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-user-minus"></i> Confirm Removal';
                }
            }
        })
        .catch(error => {
            console.error('Error removing supervisor:', error);
            showNotification('An error occurred while removing the supervisor', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-minus"></i> Confirm Removal';
            }
        });
    }
    
    // Select mentor function for assigning supervisor
    window.selectMentor = function(mentorId, mentorName) {
        const projectId = {{ project.id }};
        const btn = event.target.closest('.mentor-select-item');
        if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
        }
        
        fetch(`/dashboard/user/projects/${projectId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ 
                action: 'assign_supervisor',
                mentor_id: mentorId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Supervisor "${mentorName}" assigned successfully`, 'success');
                window.closeSupervisorModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.error || 'Failed to assign supervisor', 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        })
        .catch(error => {
            console.error('Error assigning supervisor:', error);
            showNotification('An error occurred while assigning the supervisor', 'error');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
    }

    // Target Date Modal Functions
    function openTargetDateModal() {
        const modal = document.getElementById('targetDateModal');
        if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
    }

    function closeTargetDateModal() {
        const modal = document.getElementById('targetDateModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    }

    function saveTargetDate(event) {
        event.preventDefault();
        
        const targetDate = document.getElementById('targetDateInput').value;
        const submitBtn = document.getElementById('targetDateSubmitBtn');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving...';

        fetch(`/dashboard/user/projects/${PROJECT_ID}/update-target-date/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ target_date: targetDate || null })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeTargetDateModal();
                if (typeof showNotification !== 'undefined') {
                    showNotification('Target date updated successfully', 'success');
                }
                // Reload page to show updated date
                location.reload();
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to update target date', 'error');
                } else {
                    alert(data.error || 'Failed to update target date');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while updating target date', 'error');
            } else {
                alert('An error occurred while updating target date');
            }
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const targetDateModal = document.getElementById('targetDateModal');
            if (targetDateModal && targetDateModal.classList.contains('active')) {
                closeTargetDateModal();
            }
            
            const supervisorModal = document.getElementById('supervisorModal');
            if (supervisorModal && supervisorModal.classList.contains('active')) {
                closeSupervisorModal();
            }
        }
    });
    
    // Handle project note form submission
    const projectNoteForm = document.getElementById('projectNoteForm');
    if (projectNoteForm) {
        projectNoteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const textarea = document.getElementById('projectNoteText');
            const submitBtn = document.getElementById('projectNoteSubmitBtn');
            const notesFeed = document.getElementById('projectNotesFeed');
            
            if (!textarea || !textarea.value.trim()) {
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
            
            // Get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            fetch('{% url "general:dashboard_user:create_project_note" project.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    note_text: textarea.value.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                // Always reset button state first
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
                if (data.success) {
                    // Clear textarea
                    textarea.value = '';
                    
                    // Add note to feed (prepend to top)
                    const note = data.note;
                    const noteHtml = `
                        <div class="note-item">
                            <div class="note-avatar">
                                ${note.author_name ? note.author_name.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div class="note-box">
                                <div class="note-header">
                                    <span class="note-author">${escapeHtml(note.author_name || 'Unknown')}</span>
                                    ${note.author_role ? `<span class="note-role-badge">${note.author_role}</span>` : ''}
                                    <span class="note-time">${note.created_at}</span>
                                </div>
                                <div style="color: #4b5563; line-height: 1.6;">${escapeHtml(note.text).replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    `;
                    
                    // Remove empty message if exists
                    const emptyMsg = notesFeed.querySelector('div[style*="text-align: center"]');
                    if (emptyMsg) {
                        emptyMsg.remove();
                    }
                    
                    // Prepend new note
                    notesFeed.insertAdjacentHTML('afterbegin', noteHtml);
                    
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Note added successfully', 'success');
                    }
                } else {
                    if (typeof showNotification !== 'undefined') {
                        showNotification(data.error || 'Failed to add note', 'error');
                    } else {
                        alert(data.error || 'Failed to add note');
                    }
                }
            })
            .catch(error => {
                console.error('Error adding note:', error);
                if (typeof showNotification !== 'undefined') {
                    showNotification('An error occurred', 'error');
                } else {
                    alert('An error occurred');
                }
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
</script>
{% endblock %}
