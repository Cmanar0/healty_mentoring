{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Mentor Dashboard{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <!-- PART 1: Actionable Items -->
    <div class="dashboard-part">
        <div class="dashboard-main-flex">
            
            <!-- Left Column (2/3) -->
            <div class="dashboard-col-left">
                <!-- Split Stats Cards -->
                <div class="dashboard-stats-split">
                    <!-- Next Step Card (click opens modal with subtasks) -->
                    <div class="dashboard-card stats-card-half next-step-card">
                        <div class="next-step-content">
                            {% if current_guide_item %}
                                {% if current_guide_item.claim_ready %}
                                <div class="next-step-claim-card-clickable" id="nextStepClaimCard" role="button" tabindex="0" title="Click to claim your AI coins">
                                    <div class="next-step-card-inner next-step-card-claim">
                                        <div class="next-step-card-left next-step-claim-left">
                                            <h3 class="next-step-card-title next-step-claim-title">Congratulations!</h3>
                                            <div class="next-step-claim-text-block">
                                                <p class="next-step-claim-text">You completed <strong>{{ current_guide_item.guide.name }}</strong></p>
                                                <button type="button" class="next-step-claim-now-btn" id="nextStepClaimBtn">Claim your AI coins</button>
                                            </div>
                                        </div>
                                        <div class="next-step-card-right">
                                            <img src="{% static 'images/guide_2.png' %}" alt="Celebration" loading="lazy">
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="next-step-card-clickable" id="nextStepCard" role="button" tabindex="0" title="Click to view details">
                                    <div class="next-step-card-inner">
                                        <div class="next-step-card-left">
                                            <h3 class="next-step-card-title">Next step</h3>
                                            <div class="next-step-card-middle">
                                                <h4 class="next-step-guide-title">{{ current_guide_item.guide.name }}</h4>
                                                {% if current_guide_item.guide.subtitle %}<p class="next-step-guide-subtitle">{{ current_guide_item.guide.subtitle }}</p>{% endif %}
                                                {% if current_guide_item.guide.description %}<p class="next-step-guide-desc">{{ current_guide_item.guide.description }}</p>{% endif %}
                                            </div>
                                            <p class="next-step-view-subtasks">
                                                <span class="next-step-view-subtasks-label">View subtasks</span>
                                                <span class="next-step-subtasks-count">{{ current_guide_item.step_completed_ids|length }}/{{ current_guide_item.steps|length }} completed</span>
                                            </p>
                                        </div>
                                        <div class="next-step-card-right">
                                            {% if current_guide_item.image_url %}
                                                <img src="{{ current_guide_item.image_url }}" alt="{{ current_guide_item.guide.name }}" loading="lazy">
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="next-step-all-done">
                                    <i class="fas fa-check-circle"></i>
                                    <span>All steps completed</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Next Step Modal (two columns: left = title/description/video, right = subtasks) -->
                    {% if current_guide_item %}
                    <div class="next-step-modal-overlay" id="nextStepModal" aria-hidden="true" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; padding: 24px;" data-guide-id="{{ current_guide_item.guide.id }}" data-step-ids="{% for step in current_guide_item.steps %}{{ step.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <div class="next-step-modal" role="dialog" aria-labelledby="nextStepModalTitle">
                            <div class="next-step-modal-header">
                                <button type="button" class="next-step-modal-close" id="nextStepModalClose" aria-label="Close"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="next-step-modal-body">
                                <div class="next-step-modal-left">
                                    <div class="next-step-modal-title-row">
                                        <h3 id="nextStepModalTitle" class="next-step-modal-title">{{ current_guide_item.guide.name }}</h3>
                                        <span class="next-step-modal-coins" title="Earn when you complete this guide">{{ current_guide_item.guide.ai_coins }} <i class="fas fa-coins"></i></span>
                                    </div>
                                    <p class="next-step-modal-coins-hint">Earn these AI coins when you complete this guide and each subtask.</p>
                                    {% if current_guide_item.guide.subtitle %}<p class="next-step-modal-subtitle">{{ current_guide_item.guide.subtitle }}</p>{% endif %}
                                    {% if current_guide_item.guide.description %}<div class="next-step-modal-desc">{{ current_guide_item.guide.description }}</div>{% endif %}
                                    {% if current_guide_item.guide.youtube_url %}
                                        <div class="next-step-modal-video" data-youtube-url="{{ current_guide_item.guide.youtube_url }}">
                                            <iframe id="nextStepGuideVideoIframe" src="" title="Guide video" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="next-step-modal-right">
                                    <h4 class="next-step-modal-subtasks-title">Subtasks</h4>
                                    <p class="next-step-modal-earn-hint">Complete each item to earn the AI coins shown.</p>
                                    <ul class="next-step-modal-list">
                                        {% for step in current_guide_item.steps %}
                                        <li class="next-step-modal-item {% if step.id in current_guide_item.step_completed_ids %}completed{% endif %}">
                                            {% if step.url %}
                                            <a href="{{ step.url }}{% if step.action_id %}?action_id={{ step.action_id }}{% endif %}" class="next-step-modal-item-row">
                                            {% else %}
                                            <div class="next-step-modal-item-row next-step-modal-item-row--no-link">
                                            {% endif %}
                                                <span class="next-step-modal-item-num">{{ forloop.counter }}</span>
                                                <span class="next-step-modal-item-name">{{ step.name }}</span>
                                                <span class="next-step-modal-item-coins" title="AI coins">{{ step.ai_coins }} <i class="fas fa-coins"></i></span>
                                                {% if step.youtube_url %}<span class="next-step-modal-youtube-icon" role="button" tabindex="0" title="Watch video" data-youtube-url="{{ step.youtube_url }}" onclick="event.preventDefault(); event.stopPropagation(); window.open(this.dataset.youtubeUrl)" onkeydown="if(event.key==='Enter'){ event.preventDefault(); event.stopPropagation(); window.open(this.dataset.youtubeUrl); }"><i class="fab fa-youtube"></i></span>{% endif %}
                                                <span class="next-step-modal-item-action">{% if step.url %}{{ step.button_name }} <i class="fas fa-chevron-right"></i>{% else %}{{ step.button_name }}{% endif %}</span>
                                            {% if step.url %}
                                            </a>
                                            {% else %}
                                            </div>
                                            {% endif %}
                                        </li>
                                        {% empty %}
                                        <li class="next-step-modal-item next-step-modal-item-empty">No subtasks for this guide.</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Claim AI coins modal (when all subtasks done, before claiming main guide) -->
                    {% if current_guide_item and current_guide_item.claim_ready %}
                    <div class="next-step-claim-modal-overlay" id="nextStepClaimModal" aria-hidden="true" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; padding: 24px;" data-claim-url="{% url 'general:dashboard_mentor:claim_guide_coins' %}">
                        <div class="next-step-claim-modal">
                            <div class="next-step-claim-modal-header">
                                <h3>Claim your AI coins</h3>
                                <button type="button" class="next-step-modal-close" id="nextStepClaimModalClose" aria-label="Close"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="next-step-claim-modal-body">
                                <p class="next-step-claim-modal-intro">You completed <strong>{{ current_guide_item.guide.name }}</strong>. Here’s your reward:</p>
                                <div class="next-step-modal-coins-summary">
                                    <table class="next-step-modal-coins-table">
                                        {% for row in current_guide_item.coins_breakdown %}
                                        <tr class="next-step-modal-coins-{{ row.type }}-row">
                                            <td class="next-step-modal-coins-label">
                                                <span class="next-step-modal-coins-row-type">{% if row.type == 'main' %}Main guide{% else %}Subtask {{ forloop.counter0 }}{% endif %}</span>
                                                <span class="next-step-modal-coins-row-name">{{ row.label }}</span>
                                            </td>
                                            <td class="next-step-modal-coins-amount">{{ row.amount }} <i class="fas fa-coins"></i></td>
                                        </tr>
                                        {% endfor %}
                                        <tr class="next-step-modal-coins-total-row">
                                            <td class="next-step-modal-coins-label">Total</td>
                                            <td class="next-step-modal-coins-amount">{{ current_guide_item.total_ai_coins }} <i class="fas fa-coins"></i></td>
                                        </tr>
                                    </table>
                                </div>
                                <button type="button" class="next-step-claim-now-btn" id="nextStepClaimNowBtn" data-guide-id="{{ current_guide_item.guide.id }}">Accept Reward</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Earnings Card -->
                    <div class="dashboard-card stats-card-half" id="statsCard">
                        <div class="card-header">
                            <h3 class="card-title">Earnings</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <a href="{% url 'general:dashboard_mentor:earnings' %}" class="btn-all-stats">
                                    View earnings
                                </a>
                                <div class="stats-period-dropdown">
                                    <button class="stats-period-trigger" id="statsPeriodTrigger">
                                        <span class="period-label">This Week</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div class="stats-period-menu" id="statsPeriodMenu">
                                        <button class="stats-period-item" data-period="today">Today</button>
                                        <button class="stats-period-item active" data-period="this_week">This Week</button>
                                        <button class="stats-period-item" data-period="this_month">This Month</button>
                                        <button class="stats-period-item" data-period="last_month">Last Month</button>
                                        <button class="stats-period-item" data-period="all">All Time</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid-compact stats-grid-two-by-two">
                            <div class="stat-mini" style="background: #f0fdf4; border-color: #bbf7d0;" data-earnings-link role="button" tabindex="0" title="Open earnings page">
                                <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.12); color: #15803d;">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="stat-mini-content">
                                    <span class="stat-mini-value" id="statsConfirmedValue" data-cents="{{ financial_stats.confirmed_cents|default:0 }}"></span>
                                    <span class="stat-mini-label">Confirmed Sessions</span>
                                </div>
                            </div>

                            <div class="stat-mini" style="background: #fff7ed; border-color: #fed7aa;" data-earnings-link role="button" tabindex="0" title="Open earnings page">
                                <div class="stat-mini-icon" style="background: rgba(249, 115, 22, 0.12); color: #c2410c;">
                                    <i class="fas fa-hourglass-half"></i>
                                </div>
                                <div class="stat-mini-content">
                                    <span class="stat-mini-value" id="statsCompletedPendingValue" data-cents="{{ financial_stats.completed_pending_cents|default:0 }}"></span>
                                    <span class="stat-mini-label">Completed (Pending)</span>
                                </div>
                            </div>

                            <div class="stat-mini" style="background: #f0f9ff; border-color: #bae6fd;" data-earnings-link role="button" tabindex="0" title="Open earnings page">
                                <div class="stat-mini-icon" style="background: rgba(14, 165, 233, 0.12); color: #0284c7;">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="stat-mini-content">
                                    <span class="stat-mini-value" id="statsPayoutAvailableValue" data-cents="{{ financial_stats.payout_available_cents|default:0 }}"></span>
                                    <span class="stat-mini-label">Available for Payout</span>
                                </div>
                            </div>

                            <div class="stat-mini" style="background: #ecfeff; border-color: #99f6e4;" data-earnings-link role="button" tabindex="0" title="Open earnings page">
                                <div class="stat-mini-icon" style="background: rgba(13, 148, 136, 0.12); color: #0f766e;">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-mini-content">
                                    <span class="stat-mini-value" id="statsPaidOutValue" data-cents="{{ financial_stats.paid_out_cents|default:0 }}"></span>
                                    <span class="stat-mini-label">Paid Out</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Sessions Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card">
                    <div class="card-header" style="align-items: flex-start;">
                        <h3 class="card-title">Upcoming Sessions</h3>
                        <div style="display: flex; gap: 16px; align-items: center; white-space: nowrap;">
                            <button class="btn-link" data-open-mentor-calendar data-mentor-calendar-initial-mode="sessions" style="background: none; border: none; padding: 0; cursor: pointer; font-family: inherit; font-size: inherit;">View Calendar</button>
                            <a href="http://localhost:8000/dashboard/mentor/my-sessions/" class="btn-link" style="color: var(--dash-text-muted);">View All Sessions</a>
                        </div>
                    </div>
                    
                    <style>
                      .first-session-tag {
                        display: inline-block;
                        background: #ef4444;
                        color: #ffffff;
                        font-size: 10px;
                        font-weight: 700;
                        padding: 2px 5px;
                        border-radius: 3px;
                        margin-left: 6px;
                        line-height: 1.2;
                        vertical-align: middle;
                      }
                    </style>
                    
                    <div class="session-timeline-container scrollable-content" id="dashboardUpcomingSessions" data-mentor-timezone="{{ mentor_timezone|default:'UTC' }}">
                        {% if upcoming_sessions %}
                            {% for session in upcoming_sessions %}
                                <div class="session-item status-{{ session.status }}" data-session-id="{{ session.id }}" data-clickable-session data-start="{{ session.start_datetime|date:'c' }}" data-end="{{ session.end_datetime|date:'c' }}">
                                    <div class="session-left">
                                        <div class="session-date">
                                            <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                                            <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
                                        </div>
                                        <div class="session-info">
                                            <h4 class="session-title">Session with {{ session.client_name }}{% if session.is_first_session %} <span class="first-session-tag">1st</span>{% endif %}</h4>
                                            <div class="session-meta-row">
                                                <span class="session-time">
                                                    <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                                                </span>
                                                <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                                                    {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="session-right">
                                        <div class="dropdown">
                                            <button class="session-action-btn" onclick="toggleDropdown(this)">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
                                                <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal({{ session.id }});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
                                                <button type="button" class="dropdown-item" onclick="if (typeof openSessionSettingsForSessionId === 'function') openSessionSettingsForSessionId({{ session.id }});"><i class="fas fa-edit"></i><span>Edit Session</span></button>
                                                <button type="button" class="dropdown-item delete-item last-item" onclick="if (typeof openCancelSessionModal === 'function') openCancelSessionModal({{ session.id }});"><i class="fas fa-trash"></i><span>Delete</span></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            {% if has_more_sessions %}
                                <div class="session-item session-item-view-all" style="border-left: none; padding: 16px; text-align: center;">
                                    <a href="{% url 'general:dashboard_mentor:my_sessions' %}" class="btn-link" style="color: var(--dash-text-muted); font-weight: 500;">View all upcoming sessions</a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
                                <p>No upcoming sessions</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column (1/3) -->
            <div class="dashboard-col-right">
                <!-- Create New Section -->
                <div class="create-new-section" id="createNewSection">
                    <h3 class="create-new-title">Create new</h3>
                    <div class="create-new-grid">
                        <button class="create-new-btn btn-session" data-open-mentor-calendar data-mentor-calendar-initial-mode="sessions">
                            <div class="create-icon"><i class="fas fa-calendar-plus"></i></div>
                            <span class="create-label">Session</span>
                        </button>
                        <button class="create-new-btn btn-user" onclick="openInviteClientModal()">
                            <div class="create-icon"><i class="fas fa-user-plus"></i></div>
                            <span class="create-label">User</span>
                        </button>
                        <button class="create-new-btn btn-project" onclick="openCreateProjectModal()">
                            <div class="create-icon"><i class="fas fa-project-diagram"></i></div>
                            <span class="create-label">Project</span>
                        </button>
                        <button class="create-new-btn btn-marketing">
                            <div class="create-icon"><i class="fas fa-bullhorn"></i></div>
                            <span class="create-label">Marketing</span>
                        </button>
                        <a href="{% url 'general:dashboard_mentor:blog_create' %}" class="create-new-btn btn-blog">
                            <div class="create-icon"><i class="fas fa-pen-nib"></i></div>
                            <span class="create-label">Blog Post</span>
                        </a>
                    </div>
                </div>

                <!-- Your Backlog Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card" id="backlogCard" style="max-height: 530px; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3 class="card-title">Your backlog</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="backlog-sort-buttons" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.8rem; color: #6b7280; font-weight: 500;">Sort by:</span>
                                <button class="backlog-sort-btn" data-sort="priority" onclick="toggleBacklogSort('priority')" title="Sort by priority">
                                    <i class="fas fa-sort-amount-down"></i>
                                </button>
                                <button class="backlog-sort-btn" data-sort="date" onclick="toggleBacklogSort('date')" title="Sort by date">
                                    <i class="fas fa-calendar-alt"></i>
                                </button>
                            </div>
                            <a href="{% url 'general:dashboard_mentor:mentor_backlog' %}" class="btn-link btn-fixed-width">View All</a>
                        </div>
                    </div>

                    <div class="scrollable-content" id="dashboardBacklogList" style="flex: 1; min-height: 0; overflow-y: auto; padding-right: 0;">
                        <!-- Tasks will be loaded dynamically via JavaScript -->
                        <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                            <i class="fas fa-spinner fa-spin"></i> Loading tasks...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- PART 2: Education & Platform Usage -->
    <div class="dashboard-part">
        <div class="dashboard-grid">
            <!-- Promotion Education (Col 6) -->
            <div class="dashboard-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title">Get more clients with Healthy Mentoring</h3>
                </div>
                <div class="education-content">
                    <p>
                        Use your profile and content to position yourself for the right mentees.
                    </p>
                    <ul class="education-list">
                        <li>Keep your bio and expertise areas up to date.</li>
                        <li>Tag your profile with the topics you really want to work on.</li>
                        <li>Publish short blog posts to share your perspective and build trust.</li>
                        <li>Offer a limited number of free intro sessions to new clients.</li>
                    </ul>
                    <button class="btn btn-outline btn-sm" type="button">
                        Learn how to optimise your profile
                    </button>
                </div>
        </div>
        
            <!-- Platform Education (Col 6) -->
            <div class="dashboard-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title">Master our tools to provide the best value to your clients</h3>
                </div>
                <div class="education-content">
                    <p>
                        Understanding our tools will make you more efficient and professional.
                    </p>
                    <ul class="education-list">
                        <li>Use sessions to track goals, notes and agreed action items.</li>
                        <li>Group projects by client to see their full journey in one place.</li>
                        <li>Review your stats regularly to adjust capacity and pricing.</li>
                        <li>Turn on notifications so you never miss an upcoming session.</li>
                    </ul>
                    <button class="btn btn-outline btn-sm" type="button">
                        View mentor guide
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-stats-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
}

@media (max-width: 768px) {
    .dashboard-stats-split {
        grid-template-columns: 1fr;
    }
}

.stats-card-half {
    min-height: auto;
}

.stats-card-half .stats-grid-compact {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.stats-card-half .stat-card-compact,
.stats-card-half .stat-mini {
    width: 100%;
    margin: 0;
}

.stats-grid-two-by-two {
    display: grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

[data-earnings-link] {
    cursor: pointer;
}

.btn-all-stats {
    background: transparent;
    border: 1px solid #e5e7eb;
    color: #64748b;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
}

.btn-all-stats:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    color: #1e293b;
}

/* Next step card: 0 padding on card, content fills full height; two columns; "Next step:" + title + real button */
.next-step-card {
    padding: 0 !important;
    display: flex;
    flex-direction: column;
    min-height: 0;
}
.next-step-card .next-step-content {
    padding: 0;
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
}
.next-step-card-clickable {
    cursor: pointer;
    flex: 1;
    min-height: 0;
    display: flex;
}
.next-step-card-clickable:hover { background: #f9fafb; }
.next-step-card-inner {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: 0;
    flex: 1;
    min-height: 0;
}
.next-step-card-left {
    flex: 1;
    min-width: 0;
    padding: 16px 18px;
    display: flex;
    flex-direction: column;
    gap: 0;
    min-height: 0;
}
.next-step-card-title {
    margin: 0 0 10px 0;
    font-family: 'Outfit', sans-serif;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dash-text-main);
    flex-shrink: 0;
}
.next-step-card-middle {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 4px;
}
.next-step-guide-title {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 700;
    color: #111827;
    line-height: 1.35;
    letter-spacing: -0.01em;
}
.next-step-guide-subtitle {
    margin: 0;
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}
.next-step-guide-desc {
    margin: 4px 0 0 0;
    font-size: 0.8125rem;
    color: #6b7280;
    line-height: 1.4;
}
.next-step-view-subtasks {
    margin: 12px 0 0 0;
    align-self: flex-start;
    flex-shrink: 0;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}
.next-step-view-subtasks-label {
    color: var(--dash-primary, #10b981);
    font-weight: 600;
    cursor: pointer;
    transition: color 0.2s;
}
.next-step-card-clickable:hover .next-step-view-subtasks-label {
    color: #059669;
    text-decoration: underline;
}
.next-step-subtasks-count {
    font-size: 0.8rem;
    font-weight: 500;
    color: #6b7280;
    background: #f3f4f6;
    padding: 3px 8px;
    border-radius: 6px;
}
/* Claim card button (still a button) */
.next-step-view-btn {
    margin-top: auto;
    align-self: flex-start;
    flex-shrink: 0;
    padding: 8px 14px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #fff;
    background: var(--dash-primary, #10b981);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}
.next-step-view-btn:hover { background: #059669; }
.next-step-card-right {
    width: 200px;
    flex-shrink: 0;
    padding: 16px 20px 0 0;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    min-height: 140px;
}
.next-step-card-right img {
    height: 100%;
    width: auto;
    max-width: 100%;
    object-fit: contain;
    object-position: bottom;
    border-radius: 0 8px 8px 0;
}
.next-step-all-done {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #10b981;
    font-size: 0.95rem;
}
.next-step-all-done i { font-size: 1.1rem; }

.next-step-card-claim .next-step-claim-text { margin: 0; font-size: 0.95rem; color: #374151; }

/* Congratulations card: clickable, celebrating style, centered button, always guide_2.png */
.next-step-claim-card-clickable {
    cursor: pointer;
    flex: 1;
    min-height: 0;
    display: flex;
    border-radius: 12px;
    overflow: hidden;
}
.next-step-claim-card-clickable:hover { opacity: 0.98; }
.next-step-claim-card-clickable .next-step-card-inner {
    width: 100%;
}
.next-step-claim-left {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}
.next-step-claim-title { color: #065f46; margin-bottom: 4px; }
.next-step-claim-text-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}
.next-step-claim-text-block .next-step-claim-text { margin: 0 0 12px 0; }
.next-step-claim-text-block .next-step-claim-now-btn { margin-top: 0; }

/* Navbar AI coins highlight after claim (smooth blink) */
@keyframes navbar-ai-coins-blink {
    0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
    25% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0.35); }
    50% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
    75% { box-shadow: 0 0 0 6px rgba(234, 179, 8, 0.25); }
}
.navbar-ai-coins-highlight {
    animation: navbar-ai-coins-blink 1.2s ease-in-out 2;
}

/* Claim AI coins modal */
.next-step-claim-modal-overlay { display: none; }
.next-step-claim-modal-overlay[aria-hidden="false"] { display: flex !important; }
.next-step-claim-modal {
    background: #fff;
    border-radius: 12px;
    width: 96vw;
    max-width: 480px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    position: relative;
}
.next-step-claim-modal-header {
    flex-shrink: 0;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #e5e7eb;
}
.next-step-claim-modal-header h3 { margin: 0; font-size: 1.15rem; font-weight: 600; color: #111827; }
.next-step-claim-modal-body {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}
.next-step-claim-modal-intro { margin: 0; font-size: 0.9rem; color: #6b7280; }
.next-step-claim-modal-body .next-step-modal-coins-summary { margin: 0; }
.next-step-claim-now-btn {
    margin-top: 8px;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}
.next-step-claim-now-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 60%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
    transition: none;
}
.next-step-claim-now-btn:hover {
    color: #fff;
    background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
}
.next-step-claim-now-btn:hover::after {
    animation: next-step-claim-btn-shine 0.6s ease-in-out;
}
@keyframes next-step-claim-btn-shine {
    0% { left: -100%; }
    100% { left: 150%; }
}
.next-step-claim-now-btn:disabled { opacity: 0.7; cursor: not-allowed; }
.next-step-claim-now-btn:disabled:hover::after { animation: none; }

/* Next step modal: bigger; two columns; left = title, subtitle, description, video (max space); right = subtasks; close btn like other modals */
.next-step-modal-overlay { display: none; }
.next-step-modal-overlay[aria-hidden="false"] { display: flex !important; }
.next-step-modal {
    background: #fff;
    border-radius: 12px;
    width: 96vw;
    max-width: 1600px;
    height: 88vh;
    max-height: 88vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    position: relative;
}
.next-step-modal-header {
    flex-shrink: 0;
    padding: 0;
    display: flex;
    justify-content: flex-end;
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10;
}
.next-step-modal-close {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    font-size: 1rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0;
    line-height: 1;
}
.next-step-modal-close:hover {
    background: #ef4444;
    border-color: #ef4444;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
}
.next-step-modal-body {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
    padding: 24px;
    overflow: hidden;
    min-height: 0;
    flex: 1;
}
.next-step-modal-left {
    overflow-y: auto;
    min-width: 0;
    display: flex;
    flex-direction: column;
    min-height: 0;
}
.next-step-modal-title-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 4px;
}
.next-step-modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
}
.next-step-modal-coins {
    font-size: 0.85rem;
    color: #6b7280;
}
.next-step-modal-coins i { color: #eab308; }
.next-step-modal-coins-hint {
    margin: 0 0 12px 0;
    font-size: 0.8rem;
    color: #6b7280;
    line-height: 1.4;
}
.next-step-modal-subtitle {
    margin: 0 0 12px;
    font-size: 0.9rem;
    color: #6b7280;
}
.next-step-modal-desc {
    font-size: 0.875rem;
    color: #374151;
    line-height: 1.5;
    margin-bottom: 12px;
    flex-shrink: 0;
}
.next-step-modal-video {
    position: relative;
    width: 100%;
    flex: 1;
    min-height: 200px;
    overflow: hidden;
    border-radius: 8px;
    background: #000;
}
.next-step-modal-video iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}
.next-step-modal-right {
    display: flex;
    flex-direction: column;
    min-height: 0;
    min-width: 0;
    border-left: 1px solid #e5e7eb;
    padding-left: 24px;
}
.next-step-modal-right .next-step-modal-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
}
.next-step-modal-coins-summary {
    margin-top: auto;
    flex-shrink: 0;
}
.next-step-modal-subtasks-title {
    margin: 0 0 4px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
}
.next-step-modal-earn-hint {
    margin: 0 0 12px 0;
    font-size: 0.8rem;
    color: #6b7280;
    line-height: 1.4;
}
.next-step-modal-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.next-step-modal-item {
    list-style: none;
}
.next-step-modal-item-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 10px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    font-size: 0.9rem;
    color: #374151;
    text-decoration: none;
    transition: background 0.2s, border-color 0.2s, box-shadow 0.2s;
}
a.next-step-modal-item-row:hover {
    background: #f1f5f9;
    border-color: var(--dash-primary, #10b981);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
}
.next-step-modal-item-row--no-link {
    cursor: default;
}
.next-step-modal-item.completed .next-step-modal-item-row {
    background: #f0fdf4;
    border-color: #bbf7d0;
}
.next-step-modal-item.completed .next-step-modal-item-num {
    background: #10b981;
    color: #fff;
}
.next-step-modal-item-num {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: #e2e8f0;
    color: #475569;
    font-weight: 600;
    font-size: 0.85rem;
}
a.next-step-modal-item-row:hover .next-step-modal-item-num {
    background: var(--dash-primary, #10b981);
    color: #fff;
}
.next-step-modal-item-name {
    flex: 1;
    min-width: 0;
    font-weight: 500;
}
.next-step-modal-item.completed .next-step-modal-item-name {
    text-decoration: line-through;
    color: #94a3b8;
}
.next-step-modal-item-coins {
    font-size: 0.8rem;
    color: #6b7280;
}
.next-step-modal-item-coins i { color: #eab308; }
.next-step-modal-item-action {
    font-size: 0.8rem;
    color: var(--dash-primary, #10b981);
    font-weight: 500;
}
.next-step-modal-item-action i.fa-chevron-right {
    font-size: 0.7rem;
    margin-left: 2px;
}
.next-step-modal-youtube-icon {
    color: #ff0000;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
}
.next-step-modal-youtube-icon:hover {
    color: #cc0000;
    background: rgba(255, 0, 0, 0.08);
}
.next-step-modal-item-empty {
    color: #6b7280;
    font-size: 0.875rem;
    padding: 14px 16px;
}
.next-step-modal-coins-summary {
    padding: 16px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
}
.next-step-modal-coins-summary-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin-bottom: 12px;
}
.next-step-modal-coins-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}
.next-step-modal-coins-table td {
    padding: 6px 0;
    vertical-align: top;
}
.next-step-modal-coins-label {
    color: #475569;
    display: flex;
    flex-direction: column;
    gap: 2px;
}
.next-step-modal-coins-row-type {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #64748b;
}
.next-step-modal-coins-main-row .next-step-modal-coins-row-type {
    color: var(--dash-primary, #10b981);
}
.next-step-modal-coins-row-name {
    font-size: 0.875rem;
    color: #0f172a;
    font-weight: 500;
}
.next-step-modal-coins-main-row {
    border-left: 3px solid var(--dash-primary, #10b981);
}
.next-step-modal-coins-main-row .next-step-modal-coins-label {
    padding-left: 10px;
}
.next-step-modal-coins-subtask-row .next-step-modal-coins-label {
    padding-left: 6px;
}
.next-step-modal-coins-subtask-row .next-step-modal-coins-row-name {
    font-size: 0.8125rem;
    color: #475569;
}
.next-step-modal-coins-amount {
    text-align: right;
    white-space: nowrap;
    color: #0f172a;
    font-weight: 500;
}
.next-step-modal-coins-amount i { color: #eab308; }
.next-step-modal-coins-total-row td {
    padding-top: 12px;
    border-top: 2px solid #e2e8f0;
    font-weight: 600;
    color: #0f172a;
}
.next-step-modal-coins-total-row .next-step-modal-coins-amount {
    font-weight: 700;
}
@media (max-width: 640px) {
    .next-step-modal-body { grid-template-columns: 1fr; }
    .next-step-modal-right { border-left: none; padding-left: 0; padding-top: 16px; border-top: 1px solid #e5e7eb; }
}
</style>

<!-- Page-specific JS: stats dropdown + next step modal -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // After claim reward reload: show toast and highlight navbar AI coins
    try {
        var claimToast = sessionStorage.getItem('mentor_claim_toast');
        if (claimToast) {
            sessionStorage.removeItem('mentor_claim_toast');
            var data = JSON.parse(claimToast);
            var coins = data && data.coins != null ? data.coins : 0;
            if (typeof showNotification === 'function' && coins) {
                showNotification('Successfully claimed ' + coins + ' AI coins!', 'success');
            }
            var navbarCoins = document.getElementById('navbarAiCoins');
            if (navbarCoins) {
                navbarCoins.classList.add('navbar-ai-coins-highlight');
                setTimeout(function() { navbarCoins.classList.remove('navbar-ai-coins-highlight'); }, 3000);
            }
        }
    } catch (e) {}

    // Next step card: open modal on click
    const nextStepCard = document.getElementById('nextStepCard');
    const nextStepModal = document.getElementById('nextStepModal');
    const nextStepModalClose = document.getElementById('nextStepModalClose');
    if (nextStepCard && nextStepModal) {
        function extractYouTubeVideoId(url) {
            if (!url) return null;
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }
        nextStepCard.addEventListener('click', function() {
            nextStepModal.setAttribute('aria-hidden', 'false');
            nextStepModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            var guideId = nextStepModal.getAttribute('data-guide-id');
            var stepIdsStr = nextStepModal.getAttribute('data-step-ids');
            var stepIds = stepIdsStr ? stepIdsStr.split(',').filter(Boolean) : [];
            console.log('Next step modal opened – guide id:', guideId, 'subtask ids:', stepIds);
            var videoWrap = nextStepModal.querySelector('.next-step-modal-video');
            var iframe = document.getElementById('nextStepGuideVideoIframe');
            if (videoWrap && iframe) {
                var youtubeUrl = videoWrap.getAttribute('data-youtube-url');
                var videoId = extractYouTubeVideoId(youtubeUrl);
                if (videoId) {
                    iframe.src = 'https://www.youtube-nocookie.com/embed/' + videoId + '?rel=0';
                } else {
                    iframe.src = '';
                }
            }
        });
        function closeNextStepModal() {
            nextStepModal.setAttribute('aria-hidden', 'true');
            nextStepModal.style.display = 'none';
            document.body.style.overflow = '';
            var iframe = document.getElementById('nextStepGuideVideoIframe');
            if (iframe) iframe.src = '';
        }
        if (nextStepModalClose) nextStepModalClose.addEventListener('click', closeNextStepModal);
        nextStepModal.addEventListener('click', function(e) {
            if (e.target === nextStepModal) closeNextStepModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && nextStepModal.getAttribute('aria-hidden') === 'false') closeNextStepModal();
        });
    }

    // Claim AI coins modal: open on card or button click, close, and Claim Now
    const nextStepClaimCard = document.getElementById('nextStepClaimCard');
    const nextStepClaimBtn = document.getElementById('nextStepClaimBtn');
    const nextStepClaimModal = document.getElementById('nextStepClaimModal');
    const nextStepClaimModalClose = document.getElementById('nextStepClaimModalClose');
    const nextStepClaimNowBtn = document.getElementById('nextStepClaimNowBtn');
    function openClaimModal() {
        if (nextStepClaimModal) {
            nextStepClaimModal.setAttribute('aria-hidden', 'false');
            nextStepClaimModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }
    if (nextStepClaimModal) {
        if (nextStepClaimCard) {
            nextStepClaimCard.addEventListener('click', openClaimModal);
            nextStepClaimCard.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openClaimModal(); } });
        }
        if (nextStepClaimBtn) nextStepClaimBtn.addEventListener('click', function(e) { e.stopPropagation(); openClaimModal(); });
        function closeClaimModal() {
            nextStepClaimModal.setAttribute('aria-hidden', 'true');
            nextStepClaimModal.style.display = 'none';
            document.body.style.overflow = '';
        }
        if (nextStepClaimModalClose) nextStepClaimModalClose.addEventListener('click', closeClaimModal);
        nextStepClaimModal.addEventListener('click', function(e) {
            if (e.target === nextStepClaimModal) closeClaimModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && nextStepClaimModal.getAttribute('aria-hidden') === 'false') closeClaimModal();
        });
        if (nextStepClaimNowBtn) {
            nextStepClaimNowBtn.addEventListener('click', function() {
                var guideId = nextStepClaimNowBtn.getAttribute('data-guide-id');
                var claimUrl = nextStepClaimModal.getAttribute('data-claim-url');
                if (!guideId || !claimUrl) return;
                var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                var csrf = csrfInput ? csrfInput.value : (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];
                if (!csrf) return;
                nextStepClaimNowBtn.disabled = true;
                nextStepClaimNowBtn.textContent = 'Claiming…';
                var formData = new FormData();
                formData.append('guide_id', guideId);
                formData.append('csrfmiddlewaretoken', csrf);
                fetch(claimUrl, { method: 'POST', body: formData, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function(r) { return r.json().then(function(data) { return { ok: r.ok, data: data }; }); })
                    .then(function(result) {
                        nextStepClaimNowBtn.disabled = false;
                        nextStepClaimNowBtn.textContent = 'Accept Reward';
                        if (result.ok && result.data.success) {
                            try {
                                sessionStorage.setItem('mentor_claim_toast', JSON.stringify({ coins: result.data.coins_added }));
                            } catch (e) {}
                            closeClaimModal();
                            window.location.reload();
                        } else {
                            if (typeof showNotification === 'function') {
                                showNotification(result.data.error || 'Could not claim coins', 'error');
                            }
                        }
                    })
                    .catch(function() {
                        nextStepClaimNowBtn.disabled = false;
                        nextStepClaimNowBtn.textContent = 'Accept Reward';
                        if (typeof showNotification === 'function') showNotification('Request failed', 'error');
                    });
            });
        }
    }

    // Earnings card click-through
    const earningsUrl = '{% url "general:dashboard_mentor:earnings" %}';
    document.querySelectorAll('[data-earnings-link]').forEach(function(el) {
        el.addEventListener('click', function() {
            window.location.href = earningsUrl;
        });
        el.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                window.location.href = earningsUrl;
            }
        });
    });

    // Stats Period Dropdown + financial buckets
    const statsPeriodTrigger = document.getElementById('statsPeriodTrigger');
    const statsPeriodMenu = document.getElementById('statsPeriodMenu');
    const statsPeriodDropdown = document.querySelector('.stats-period-dropdown');
    const statsCompletedPendingValue = document.getElementById('statsCompletedPendingValue');
    const statsConfirmedValue = document.getElementById('statsConfirmedValue');
    const statsPayoutAvailableValue = document.getElementById('statsPayoutAvailableValue');
    const statsPaidOutValue = document.getElementById('statsPaidOutValue');
    const DASHBOARD_FINANCIAL_STATS_URL = '{% url "general:dashboard_mentor:dashboard_financial_stats" %}';

    function formatMoneyFromCents(cents) {
        const dollars = (Number(cents || 0) / 100);
        return '$' + dollars.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function setStatsValues(confirmed, cPending, pAvailable, pOut) {
        if (statsConfirmedValue) statsConfirmedValue.textContent = formatMoneyFromCents(confirmed);
        if (statsCompletedPendingValue) statsCompletedPendingValue.textContent = formatMoneyFromCents(cPending);
        if (statsPayoutAvailableValue) statsPayoutAvailableValue.textContent = formatMoneyFromCents(pAvailable);
        if (statsPaidOutValue) statsPaidOutValue.textContent = formatMoneyFromCents(pOut);
    }
    // Initial values from server-rendered data attributes
    setStatsValues(
        statsConfirmedValue ? statsConfirmedValue.getAttribute('data-cents') : 0,
        statsCompletedPendingValue ? statsCompletedPendingValue.getAttribute('data-cents') : 0,
        statsPayoutAvailableValue ? statsPayoutAvailableValue.getAttribute('data-cents') : 0,
        statsPaidOutValue ? statsPaidOutValue.getAttribute('data-cents') : 0
    );

    if (statsPeriodTrigger && statsPeriodMenu) {
        statsPeriodTrigger.addEventListener('click', function(e) {
            e.stopPropagation();
            statsPeriodDropdown.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (statsPeriodDropdown && !statsPeriodDropdown.contains(event.target)) {
                statsPeriodDropdown.classList.remove('active');
            }
        });

        // Handle period selection
        const periodItems = statsPeriodMenu.querySelectorAll('.stats-period-item');
        periodItems.forEach(item => {
            item.addEventListener('click', async function() {
                // Remove active from all
                periodItems.forEach(i => i.classList.remove('active'));
                // Add active to clicked
                this.classList.add('active');
                // Update label
                const label = statsPeriodTrigger.querySelector('.period-label');
                label.textContent = this.textContent;
                // Close dropdown
                statsPeriodDropdown.classList.remove('active');
                const period = this.getAttribute('data-period') || 'this_week';
                try {
                    const response = await fetch(`${DASHBOARD_FINANCIAL_STATS_URL}?period=${encodeURIComponent(period)}`, {
                        headers: { 'Accept': 'application/json' }
                    });
                    const data = await response.json();
                    if (data && data.success) {
                        setStatsValues(
                            data.confirmed_cents || 0,
                            data.completed_pending_cents || 0,
                            data.payout_available_cents || 0,
                            data.paid_out_cents || 0
                        );
                    }
                } catch (e) {
                    // keep existing displayed values on fetch failure
                }
            });
        });
    }
});

// Invite Client Modal
function openInviteClientModal() {
    document.getElementById('inviteClientModal').classList.add('active');
    document.getElementById('clientEmailInput').focus();
}

function closeInviteClientModal() {
    document.getElementById('inviteClientModal').classList.remove('active');
    document.getElementById('inviteClientForm').reset();
    const messageDiv = document.getElementById('inviteClientMessage');
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}

// Handle invite client form submission
document.addEventListener('DOMContentLoaded', function() {
    const inviteForm = document.getElementById('inviteClientForm');
    if (inviteForm) {
        inviteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('clientEmailInput').value.trim();
            const submitBtn = document.getElementById('inviteClientSubmit');
            const messageDiv = document.getElementById('inviteClientMessage');
            
            if (!email) {
                if (messageDiv) {
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'invite-message error';
                    messageDiv.textContent = 'Please enter an email address.';
                }
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "general:dashboard_mentor:invite_client" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.className = 'invite-message success';
                        messageDiv.textContent = data.message;
                    }
                    // Don't close modal, keep it open to show success message
                } else {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.className = 'invite-message error';
                        messageDiv.textContent = data.error || 'An error occurred. Please try again.';
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Invitation';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (messageDiv) {
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'invite-message error';
                    messageDiv.textContent = 'An error occurred. Please try again.';
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Invitation';
            });
        });
    }
    
    // Close modal on overlay click
    const inviteModal = document.getElementById('inviteClientModal');
    if (inviteModal) {
        inviteModal.addEventListener('click', function(e) {
            if (e.target === inviteModal) {
                closeInviteClientModal();
            }
        });
    }
});

// Close Invite Client modal on Escape
document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    const inviteModal = document.getElementById('inviteClientModal');
    if (!inviteModal) return;
    if (inviteModal.classList.contains('active')) {
        e.preventDefault();
        closeInviteClientModal();
    }
});
</script>

<!-- Invite Client Modal -->
<div id="inviteClientModal" class="modal-overlay modal-overlay-blur">
    <div class="modal-content" style="max-width: 500px;">
        <button type="button" class="modal-close" onclick="closeInviteClientModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-header">
            <h3 class="modal-title">Invite Client</h3>
            <p class="modal-subtitle">Enter the email address of the client you want to invite.</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
            <p style="margin: 0; font-size: 0.9rem; color: #065f46; line-height: 1.5;">
                <strong>What happens when you invite:</strong><br>
                • The user will be added to your client list immediately<br>
                • An unverified account will be created for them<br>
                • They will receive an invitation email<br>
                • They can complete registration via a special link
            </p>
        </div>
        
        <form id="inviteClientForm">
            {% csrf_token %}
            <div style="margin-bottom: 20px;">
                <label for="clientEmailInput" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--dash-text-main);">Email Address</label>
                <input 
                    type="email" 
                    id="clientEmailInput" 
                    name="email" 
                    required 
                    placeholder="client@example.com"
                    style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                >
            </div>
            
            <div id="inviteClientMessage" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 8px;"></div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeInviteClientModal()" style="padding: 10px 20px; background: transparent; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; color: var(--dash-text-main);">
                    Cancel
                </button>
                <button type="submit" id="inviteClientSubmit" style="padding: 10px 20px; background: var(--dash-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Send Invitation
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.invite-message {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    line-height: 1.5;
}

.invite-message.success {
    background: rgba(16, 185, 129, 0.1);
    color: #065f46;
    border-left: 3px solid #10b981;
}

.invite-message.error {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
    border-left: 3px solid #ef4444;
}
</style>

{# New mentor calendar popup (Sessions + Availability) #}
{% include "dashboard_mentor/calendar_mentor/calendar.html" %}

<script>
(function() {
  // Function to refresh dashboard upcoming sessions
  window.refreshDashboardUpcomingSessions = async function() {
    const container = document.getElementById('dashboardUpcomingSessions');
    if (!container) return;
    const mentorTz = container.getAttribute('data-mentor-timezone') || 'UTC';
    
    try {
      const response = await fetch('{% url "general:dashboard_mentor:get_dashboard_upcoming_sessions" %}', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      const data = await response.json();
      
      if (data.success) {
        container.innerHTML = '';
        
        if (data.sessions && data.sessions.length > 0) {
          const fmtDate = new Intl.DateTimeFormat('en-US', { timeZone: mentorTz, day: 'numeric', month: 'short' });
          const fmtTime = new Intl.DateTimeFormat('en-US', { timeZone: mentorTz, hour: 'numeric', minute: '2-digit', hour12: true });
          data.sessions.forEach(session => {
            const startDate = new Date(session.start_datetime);
            const endDate = new Date(session.end_datetime);
            
            const day = fmtDate.formatToParts(startDate).find(p => p.type === 'day').value;
            const month = fmtDate.formatToParts(startDate).find(p => p.type === 'month').value;
            const startTime = fmtTime.format(startDate);
            const endTime = fmtTime.format(endDate);
            
            const statusClass = session.status === 'confirmed' ? 'confirmed' : 'tbc';
            const statusText = session.status === 'confirmed' ? 'Confirmed' : 'Invited';
            const statusStyle = session.status === 'confirmed' 
              ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;'
              : 'background: rgba(251, 191, 36, 0.1); color: #f59e0b;';
            
            const firstSessionTag = session.is_first_session ? '<span class="first-session-tag">1st</span>' : '';
            const startMs = startDate.getTime();
            const endMs = endDate.getTime();
            const now = Date.now();
            const isOngoing = session.status === 'confirmed' && startMs <= now && now <= endMs;
            const ongoingClass = isOngoing ? ' session-item--ongoing' : '';
            const liveBadge = isOngoing ? '<span class="live-pulse-badge"><span class="live-dot"></span>LIVE</span>' : '';
            const startIso = typeof session.start_datetime === 'string' ? session.start_datetime : (session.start_datetime && session.start_datetime.toISOString ? session.start_datetime.toISOString() : startDate.toISOString());
            const endIso = typeof session.end_datetime === 'string' ? session.end_datetime : (session.end_datetime && session.end_datetime.toISOString ? session.end_datetime.toISOString() : endDate.toISOString());
            const sessionHTML = `
              <div class="session-item status-${session.status}${ongoingClass}" data-session-id="${session.id}" data-clickable-session data-start="${startIso}" data-end="${endIso}">
                <div class="session-left">
                  <div class="session-date">
                    <span class="date-day">${day}</span>
                    <span class="date-month">${month}</span>
                  </div>
                  <div class="session-info">
                    <h4 class="session-title">Session with ${session.client_name} ${firstSessionTag} ${liveBadge}</h4>
                    <div class="session-meta-row">
                      <span class="session-time">
                        <i class="far fa-clock"></i> ${startTime} - ${endTime}
                      </span>
                      <span class="conf-tag ${statusClass}" style="${statusStyle}">
                        ${statusText}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="session-right">
                  <div class="dropdown">
                    <button class="session-action-btn" onclick="toggleDropdown(this)">
                      <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
                      <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal(${session.id});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
                      <button type="button" class="dropdown-item" onclick="if (typeof openSessionSettingsForSessionId === 'function') openSessionSettingsForSessionId(${session.id});"><i class="fas fa-edit"></i><span>Edit Session</span></button>
                      <button type="button" class="dropdown-item delete-item last-item" onclick="if (typeof openCancelSessionModal === 'function') openCancelSessionModal(${session.id});"><i class="fas fa-trash"></i><span>Delete</span></button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            container.insertAdjacentHTML('beforeend', sessionHTML);
          });
          
          // Add "View all" link if there are more sessions
          if (data.has_more_sessions) {
            const viewAllHTML = `
              <div class="session-item session-item-view-all" style="border-left: none; padding: 16px; text-align: center;">
                <a href="{% url 'general:dashboard_mentor:my_sessions' %}" class="btn-link" style="color: var(--dash-text-muted); font-weight: 500;">View all upcoming sessions</a>
              </div>
            `;
            container.insertAdjacentHTML('beforeend', viewAllHTML);
          }
        } else {
          // No sessions
          container.innerHTML = `
            <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
              <p>No upcoming sessions</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Error refreshing dashboard upcoming sessions:', error);
    }
  };
})();

// Mark session rows that are currently ongoing (confirmed and now between start and end)
function markOngoingSessionRows(container) {
  if (!container) return;
  var now = Date.now();
  container.querySelectorAll('.session-item[data-clickable-session][data-start][data-end]').forEach(function(row) {
    var start = new Date(row.getAttribute('data-start')).getTime();
    var end = new Date(row.getAttribute('data-end')).getTime();
    var confirmed = row.classList.contains('status-confirmed');
    var isOngoing = confirmed && start <= now && now <= end;
    
    if (isOngoing) {
      row.classList.add('session-item--ongoing');
      var title = row.querySelector('.session-title');
      if (title && !title.querySelector('.live-pulse-badge')) {
        title.insertAdjacentHTML('beforeend', '<span class="live-pulse-badge"><span class="live-dot"></span>LIVE</span>');
      }
    } else {
      row.classList.remove('session-item--ongoing');
      var badge = row.querySelector('.live-pulse-badge');
      if (badge) badge.remove();
    }
  });
}

// Click on session row: if ongoing open session detail, else open session settings
(function() {
  var container = document.getElementById('dashboardUpcomingSessions');
  if (!container) return;
  markOngoingSessionRows(container);
  document.addEventListener('DOMContentLoaded', function() { markOngoingSessionRows(container); });
  container.addEventListener('click', function(e) {
    var row = e.target.closest('.session-item[data-clickable-session]');
    if (!row) return;
    if (e.target.closest('.session-right')) return;
    var sessionId = row.getAttribute('data-session-id');
    if (!sessionId) return;
    var sid = parseInt(sessionId, 10);
    var startAttr = row.getAttribute('data-start');
    var endAttr = row.getAttribute('data-end');
    var isOngoing = false;
    if (startAttr && endAttr && row.classList.contains('status-confirmed')) {
      var now = Date.now();
      var start = new Date(startAttr).getTime();
      var end = new Date(endAttr).getTime();
      isOngoing = start <= now && now <= end;
    }
    if (isOngoing && typeof openSessionDetailModal === 'function') {
      openSessionDetailModal(sid);
    } else if (typeof openSessionSettingsForSessionId === 'function') {
      openSessionSettingsForSessionId(sid);
    }
  });
})();
</script>

<style>
  /* Make entire session row clickable */
  .session-item[data-clickable-session] {
    cursor: pointer;
  }
  
  .session-item[data-clickable-session] .session-right {
    cursor: default;
  }

  /* Remove all padding from flex-scroll-card */
  .dashboard-card.flex-scroll-card {
    padding: 0;
  }

  /* Add top, left, and right padding to card-header in flex-scroll-card */
  .dashboard-card.flex-scroll-card .card-header {
    padding-top: 24px;
    padding-left: 24px;
    padding-right: 24px;
    padding-bottom: 0;
  }

  /* Add padding to sessions scrollable content */
  .session-timeline-container.scrollable-content {
    padding-left: 32px;
    padding-right: 32px;
    padding-bottom: 32px;
  }

  /* Adjust timeline line position to account for padding */
  .session-timeline-container.scrollable-content::before {
    left: 31px; /* Adjusted to align with dots */
    bottom: 32px; /* Stop before padding-bottom */
  }

  /* Active Backlog Task Styles for Dashboard */
  .active-backlog-task-item {
    display: flex;
    flex-direction: column;
    background: #fafafa;
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0;
    margin-bottom: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .active-backlog-task-item:hover {
    background: #ffffff;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-bottom-color: #d1d5db;
  }

  .active-backlog-task-header {
    display: flex;
    align-items: stretch;
    border-bottom: 1px solid #f3f4f6;
  }

  .active-backlog-task-content {
    flex: 1;
    padding: 16px;
    min-width: 0;
    cursor: pointer;
    height: auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    overflow: hidden;
  }

  .active-backlog-task-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
  }

  .active-backlog-task-title-text {
    flex: 1;
    min-width: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .active-backlog-task-deadline {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: #6b7280;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .active-backlog-task-deadline.overdue {
    color: #ef4444;
  }

  .active-backlog-task-description {
    font-size: 0.8rem;
    color: #4b5563;
    line-height: 1.5;
    margin-bottom: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    flex-shrink: 0;
  }

  .priority-tag {
    flex: 0 0 auto;
    padding: 6px 8px;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid transparent;
  }

  .priority-tag.priority-low {
    background-color: #f3f4f6;
    color: #6b7280;
    border-color: #e5e7eb;
  }

  .priority-tag.priority-medium {
    background-color: #dbeafe;
    color: #1e40af;
    border-color: #bfdbfe;
  }

  .priority-tag.priority-high {
    background-color: #fef3c7;
    color: #92400e;
    border-color: #fde68a;
  }

  .priority-tag.priority-urgent {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
  }

  .active-backlog-done-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #a7f3d0;
    background: #ecfdf5;
    color: #047857;
    min-width: 180px;
    width: 180px;
    box-sizing: border-box;
    white-space: nowrap;
  }

  .active-backlog-done-btn:hover {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }

  /* Scrollbar styling for dashboard backlog */
  #dashboardBacklogList::-webkit-scrollbar {
    width: 8px;
  }

  #dashboardBacklogList::-webkit-scrollbar-track {
    background: transparent;
  }

  #dashboardBacklogList::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }

  #dashboardBacklogList::-webkit-scrollbar-thumb:hover {
    background-color: rgba(0, 0, 0, 0.3);
  }

  /* Backlog Sort Buttons */
  .backlog-sort-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .backlog-sort-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    width: 32px;
    height: 32px;
  }

  .backlog-sort-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    color: #374151;
  }

  .backlog-sort-btn.active {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }

  .backlog-sort-btn i {
    font-size: 0.75rem;
  }

  /* Remove min-width from btn-fixed-width */
  .btn-fixed-width {
    min-width: 0;
  }
</style>

<!-- Include Create Project Modal -->
{% include "general/modals/create_project_modal.html" %}

<!-- Include Create Active Backlog Task Modal -->
{% include 'dashboard_mentor/popups/create_active_backlog_task_modal.html' %}

<script>
// Dashboard backlog state
let dashboardBacklogTasks = [];
let dashboardBacklogSort = null; // 'priority', 'date', or null

// Load dashboard backlog tasks (only todo tasks)
function loadDashboardBacklog() {
    const container = document.getElementById('dashboardBacklogList');
    if (!container) return;
    
    fetch('{% url "general:dashboard_mentor:get_mentor_backlog_tasks_api" %}?filter=todo', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            dashboardBacklogTasks = data.tasks || [];
            // Reset sort when loading new data
            dashboardBacklogSort = null;
            document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
            applyDashboardBacklogSort();
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0;">Error loading tasks</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading backlog:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                <p style="margin: 0;">Error loading tasks</p>
            </div>
        `;
    });
}

// Toggle backlog sort
function toggleBacklogSort(sortType) {
    const btn = document.querySelector(`.backlog-sort-btn[data-sort="${sortType}"]`);
    if (!btn) return;
    
    // If clicking the same button, toggle it off
    if (dashboardBacklogSort === sortType) {
        dashboardBacklogSort = null;
        btn.classList.remove('active');
    } else {
        // Remove active from all buttons
        document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
        // Set new sort
        dashboardBacklogSort = sortType;
        btn.classList.add('active');
    }
    
    // Apply sort
    applyDashboardBacklogSort();
}

// Apply sorting to dashboard backlog tasks
function applyDashboardBacklogSort() {
    let sortedTasks = [...dashboardBacklogTasks];
    
    if (dashboardBacklogSort === 'priority') {
        // Sort by priority: urgent > high > medium > low
        const priorityOrder = { 'urgent': 4, 'high': 3, 'medium': 2, 'low': 1 };
        sortedTasks.sort((a, b) => {
            const aPriority = priorityOrder[a.priority || 'medium'] || 2;
            const bPriority = priorityOrder[b.priority || 'medium'] || 2;
            return bPriority - aPriority; // Highest priority first
        });
    } else if (dashboardBacklogSort === 'date') {
        // Sort by deadline: earliest first (null deadlines go to end)
        sortedTasks.sort((a, b) => {
            if (!a.deadline && !b.deadline) return 0;
            if (!a.deadline) return 1; // No deadline goes to end
            if (!b.deadline) return -1; // No deadline goes to end
            const dateA = new Date(a.deadline);
            const dateB = new Date(b.deadline);
            return dateA - dateB; // Earliest first
        });
    }
    // If dashboardBacklogSort is null, use original order
    
    renderDashboardBacklog(sortedTasks);
}

// Render dashboard backlog tasks using same styling as backlog page
function renderDashboardBacklog(tasks) {
    const container = document.getElementById('dashboardBacklogList');
    if (!container) return;
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 32px 16px; color: #9ca3af; font-size: 0.85rem;">
                <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.2;"></i>
                <p style="margin: 0; font-weight: 500;">No tasks to do</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column;">';
    tasks.forEach(task => {
        const priority = task.priority || 'medium';
        const priorityLabel = priority.charAt(0).toUpperCase() + priority.slice(1);
        const priorityClass = `priority-${priority}`;
        
        // Format deadline date and check if overdue
        let deadlineHtml = '';
        if (task.deadline) {
            const deadlineDate = new Date(task.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            deadlineDate.setHours(0, 0, 0, 0);
            const isOverdue = deadlineDate < today && !task.completed;
            
            const formattedDate = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const overdueClass = isOverdue ? 'overdue' : '';
            
            deadlineHtml = `
                <div class="active-backlog-task-deadline ${overdueClass}">
                    <i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i>
                    <span>${formattedDate}</span>
                </div>
            `;
        }
        
        const descriptionHtml = task.description ? `
            <div class="active-backlog-task-description" style="margin-bottom: 8px;">${escapeHtml(task.description)}</div>
        ` : '';
        
        const escapedTitle = (task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        const escapedDescription = (task.description || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        
        html += `
            <div class="active-backlog-task-item" data-task-id="${task.id}" data-priority="${priority}">
                <div class="active-backlog-task-header" style="border-bottom: none;">
                    <div class="active-backlog-task-content" onclick="editDashboardTask(${task.id}, '${escapedTitle}', '${escapedDescription}', '${task.deadline || ''}', '${task.priority || 'medium'}', ${task.client_id || 'null'}, event)">
                        <div class="active-backlog-task-title-row">
                            <div class="active-backlog-task-title-text">${escapeHtml(task.title)}</div>
                            ${deadlineHtml}
                        </div>
                        ${descriptionHtml}
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <span class="priority-tag ${priorityClass}">${priorityLabel}</span>
                            <div class="active-backlog-done-btn" 
                                 onclick="toggleDashboardTask(${task.id}, ${task.client_id || 'null'}, event)">
                                <i class="fas fa-check"></i> Mark Done
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Edit task from dashboard
function editDashboardTask(taskId, title, description, deadline, priority, clientId, event) {
    event.stopPropagation();
    if (typeof window.openCreateActiveBacklogTaskModal === 'function') {
        window.openCreateActiveBacklogTaskModal(taskId, title, description, deadline, priority, null, null, clientId);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Dashboard task management functions
function toggleDashboardTask(taskId, clientId, event) {
    event.stopPropagation();
    
    const completeBtn = event.target.closest('.active-backlog-done-btn');
    if (!completeBtn) return;
    
    const newCompleted = true; // Always mark as completed when clicking "Mark Done"
    
    // Determine endpoint - use client active backlog endpoint if clientId exists
    let endpoint;
    if (clientId && clientId !== 'null') {
        endpoint = `/dashboard/mentor/clients/${clientId}/active-backlog/tasks/${taskId}/toggle-complete/`;
    } else {
        // Fallback to mentor backlog endpoint
        endpoint = `{% url "general:dashboard_mentor:toggle_mentor_backlog_task_complete" 0 %}`.replace('0', taskId);
    }
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ completed: newCompleted })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload backlog to show updated list
            loadDashboardBacklog();
        } else {
            console.error('Failed to toggle task:', data.error);
            alert('Failed to update task: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error toggling task:', error);
        alert('An error occurred while updating the task.');
    });
}

function deleteDashboardTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    fetch(`{% url "general:dashboard_mentor:delete_mentor_backlog_task" 0 %}`.replace('0', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload backlog to show updated list
            loadDashboardBacklog();
        } else {
            console.error('Failed to delete task:', data.error);
            alert('Failed to delete task: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting task:', error);
        alert('An error occurred while deleting the task.');
    });
}

// Load backlog on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardBacklog();
});
</script>
{% endblock %}
