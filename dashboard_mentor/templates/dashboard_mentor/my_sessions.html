{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Upcoming sessions{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
  <div class="dashboard-card flex-scroll-card">
    <div class="card-header" style="align-items: center;">
      <h3 class="card-title">Upcoming sessions</h3>
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <button
          type="button"
          class="manage-availability-btn"
          data-open-mentor-calendar
        >
          <i class="fas fa-calendar-alt"></i>
          <span>Manage Session and Availability slots</span>
        </button>
        <a href="{% url 'general:dashboard_mentor:session_history' %}" class="session-history-btn">
          <i class="fas fa-history"></i>
          <span>Session History</span>
        </a>
      </div>
    </div>

    <div class="session-timeline-container scrollable-content" id="sessionsContainer" data-mentor-timezone="{{ mentor_timezone }}">
      {% if initial_sessions %}
        {% for session in initial_sessions %}
          <div class="session-item status-{{ session.status }}" data-session-id="{{ session.id }}" data-clickable-session data-start="{{ session.start_datetime|date:'c' }}" data-end="{{ session.end_datetime|date:'c' }}">
            <div class="session-left">
              <div class="session-date">
                <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
              </div>
              <div class="session-info">
                <h4 class="session-title">Session with {{ session.client_name }}{% if session.is_first_session %} <span class="first-session-tag">1st</span>{% endif %}</h4>
                <div class="session-meta-row">
                  <span class="session-time">
                    <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                  </span>
                  <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                    {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="session-right">
              <div class="dropdown">
                <button class="session-action-btn" onclick="toggleDropdown(this)">
                  <i class="fas fa-ellipsis-h"></i>
                </button>
                <div class="dropdown-menu">
                  <a href="#" class="dropdown-item" onclick="if (typeof openSessionDetailModal === 'function') { openSessionDetailModal({{ session.id }}); } return false;">View Details</a>
                  <button type="button" class="dropdown-item" onclick="if (typeof openSessionSettingsForSessionId === 'function') openSessionSettingsForSessionId({{ session.id }});">Edit Session</button>
                  <button type="button" class="dropdown-item" onclick="if (typeof openCancelSessionModal === 'function') openCancelSessionModal({{ session.id }});">Delete</button>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
          <p>No upcoming sessions</p>
        </div>
      {% endif %}
      
      <style>
        .first-session-tag {
          display: inline-block;
          background: #ef4444;
          color: #ffffff;
          font-size: 10px;
          font-weight: 700;
          padding: 2px 5px;
          border-radius: 3px;
          margin-left: 6px;
          line-height: 1.2;
          vertical-align: middle;
        }
      </style>
      
      <!-- Loading indicator for infinite scroll -->
      <div id="sessionsLoading" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
        <i class="fas fa-spinner fa-spin"></i> Loading more sessions...
      </div>
      
      <!-- End of list indicator -->
      <div id="sessionsEnd" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
        <p>No more sessions to load</p>
      </div>
    </div>
  </div>
</div>
                    
{% include "dashboard_mentor/calendar_mentor/calendar.html" %}

<style>
    .session-item[data-clickable-session] .session-left { cursor: pointer; }
    .manage-availability-btn {
        background: var(--dash-primary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        max-width: 300px;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .session-history-btn {
        background: #f1f5f9;
        color: var(--dash-text-main);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-weight: 500;
        padding: 10px 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: background 0.2s, border-color 0.2s;
    }
    .session-history-btn:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
        color: var(--dash-text-main);
    }
</style>

<script>
(function() {
  // Start at page 1 since initial load is page 1
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;
  const perPage = 10;
  const sessionsContainer = document.getElementById('sessionsContainer');
  const loadingIndicator = document.getElementById('sessionsLoading');
  const endIndicator = document.getElementById('sessionsEnd');
  
  if (!sessionsContainer) return;
  
  // Function to refresh the entire my-sessions page
  window.refreshMySessionsPage = async function() {
    if (!sessionsContainer) return;
    
    // Reset state
    currentPage = 1;
    hasMore = true;
    isLoading = false;
    
    // Clear existing sessions (keep loading and end indicators)
    const existingSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
    existingSessions.forEach(session => session.remove());
    
    // Hide indicators
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    if (endIndicator) endIndicator.style.display = 'none';
    
    // Load page 1
    try {
      isLoading = true;
      if (loadingIndicator) loadingIndicator.style.display = 'block';
      
      const response = await fetch(`{% url 'general:dashboard_mentor:get_sessions_paginated' %}?page=1&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        if (loadingIndicator) {
          sessionsContainer.insertBefore(fragment, loadingIndicator);
        } else {
          sessionsContainer.appendChild(fragment);
        }
        
        hasMore = data.has_next;
        
        if (!hasMore && endIndicator) {
          endIndicator.style.display = 'block';
        }
      } else {
        // No sessions
        hasMore = false;
        if (endIndicator) endIndicator.style.display = 'block';
      }
    } catch (error) {
      console.error('Error refreshing my-sessions page:', error);
      hasMore = false;
    } finally {
      isLoading = false;
      if (loadingIndicator) loadingIndicator.style.display = 'none';
    }
  };
  
  // Check if there are initial sessions to determine if we should load more
  const initialSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
  // If we have no initial sessions, there's nothing to load
  if (initialSessions.length === 0) {
    hasMore = false;
    if (endIndicator) endIndicator.style.display = 'block';
  } else if (initialSessions.length < perPage) {
    // If we have fewer than perPage, likely no more pages
    // But we'll still try to load page 2 to be sure
    hasMore = true;
  }
  
  // Make formatSessionHTML accessible to refreshMySessionsPage
  function formatSessionHTML(session) {
    const startDate = new Date(session.start_datetime);
    const endDate = new Date(session.end_datetime);
    
    const day = startDate.getDate();
    const month = startDate.toLocaleDateString('en-US', { month: 'short' });
    const startTime = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    
    const statusClass = session.status === 'confirmed' ? 'confirmed' : 'tbc';
    const statusText = session.status === 'confirmed' ? 'Confirmed' : 'Invited';
    const statusStyle = session.status === 'confirmed' 
      ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;'
      : 'background: rgba(251, 191, 36, 0.1); color: #f59e0b;';
    
    const firstSessionTag = session.is_first_session ? '<span class="first-session-tag">1st</span>' : '';
    const startMs = startDate.getTime();
    const endMs = endDate.getTime();
    const now = Date.now();
    const isOngoing = session.status === 'confirmed' && startMs <= now && now <= endMs;
    const ongoingClass = isOngoing ? ' session-item--ongoing' : '';
    const liveBadge = isOngoing ? '<span class="live-pulse-badge"><span class="live-dot"></span>LIVE</span>' : '';
    const startIso = typeof session.start_datetime === 'string' ? session.start_datetime : (session.start_datetime && session.start_datetime.toISOString ? session.start_datetime.toISOString() : startDate.toISOString());
    const endIso = typeof session.end_datetime === 'string' ? session.end_datetime : (session.end_datetime && session.end_datetime.toISOString ? session.end_datetime.toISOString() : endDate.toISOString());
    return `
      <div class="session-item status-${session.status}${ongoingClass}" data-session-id="${session.id}" data-clickable-session data-start="${startIso}" data-end="${endIso}">
        <div class="session-left">
          <div class="session-date">
            <span class="date-day">${day}</span>
            <span class="date-month">${month}</span>
          </div>
          <div class="session-info">
            <h4 class="session-title">Session with ${session.client_name} ${firstSessionTag} ${liveBadge}</h4>
            <div class="session-meta-row">
              <span class="session-time">
                <i class="far fa-clock"></i> ${startTime} - ${endTime}
              </span>
              <span class="conf-tag ${statusClass}" style="${statusStyle}">
                ${statusText}
              </span>
            </div>
          </div>
        </div>
        
        <div class="session-right">
          <div class="dropdown">
            <button class="session-action-btn" onclick="toggleDropdown(this)">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" onclick="if (typeof openSessionDetailModal === 'function') { openSessionDetailModal(${session.id}); } return false;">View Details</a>
              <button type="button" class="dropdown-item" onclick="if (typeof openSessionSettingsForSessionId === 'function') openSessionSettingsForSessionId(${session.id});">Edit Session</button>
              <button type="button" class="dropdown-item" onclick="if (typeof openCancelSessionModal === 'function') openCancelSessionModal(${session.id});">Delete</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  async function loadMoreSessions() {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    loadingIndicator.style.display = 'block';
    
    try {
      const response = await fetch(`{% url 'general:dashboard_mentor:get_sessions_paginated' %}?page=${currentPage + 1}&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || '',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        loadingIndicator.parentNode.insertBefore(fragment, loadingIndicator);
        
        currentPage++;
        hasMore = data.has_next;
        
        if (!hasMore) {
          loadingIndicator.style.display = 'none';
          endIndicator.style.display = 'block';
        }
      } else {
        hasMore = false;
        loadingIndicator.style.display = 'none';
        if (currentPage === 1 && data.sessions.length === 0) {
          // No sessions at all
        } else {
          endIndicator.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('Error loading more sessions:', error);
      hasMore = false;
      loadingIndicator.style.display = 'none';
    } finally {
      isLoading = false;
    }
  }
  
  // Mark session rows that are currently ongoing (confirmed and now between start and end)
  function markOngoingSessionRows(cont) {
    if (!cont) return;
    var now = Date.now();
    cont.querySelectorAll('.session-item[data-clickable-session][data-start][data-end]').forEach(function(row) {
      var start = new Date(row.getAttribute('data-start')).getTime();
      var end = new Date(row.getAttribute('data-end')).getTime();
      var confirmed = row.classList.contains('status-confirmed');
      var isOngoing = confirmed && start <= now && now <= end;
      
      if (isOngoing) {
        row.classList.add('session-item--ongoing');
        var title = row.querySelector('.session-title');
        if (title && !title.querySelector('.live-pulse-badge')) {
          title.insertAdjacentHTML('beforeend', '<span class="live-pulse-badge"><span class="live-dot"></span>LIVE</span>');
        }
      } else {
        row.classList.remove('session-item--ongoing');
        var badge = row.querySelector('.live-pulse-badge');
        if (badge) badge.remove();
      }
    });
  }
  markOngoingSessionRows(sessionsContainer);
  document.addEventListener('DOMContentLoaded', function() { markOngoingSessionRows(sessionsContainer); });

  // Click on session row: if ongoing open session detail, else open session settings
  sessionsContainer.addEventListener('click', function(e) {
    var row = e.target.closest('.session-item[data-clickable-session]');
    if (!row) return;
    if (e.target.closest('.session-right')) return;
    var sessionId = row.getAttribute('data-session-id');
    if (!sessionId) return;
    var sid = parseInt(sessionId, 10);
    var startAttr = row.getAttribute('data-start');
    var endAttr = row.getAttribute('data-end');
    var isOngoing = false;
    if (startAttr && endAttr && row.classList.contains('status-confirmed')) {
      var now = Date.now();
      var start = new Date(startAttr).getTime();
      var end = new Date(endAttr).getTime();
      isOngoing = start <= now && now <= end;
    }
    if (isOngoing && typeof openSessionDetailModal === 'function') {
      openSessionDetailModal(sid);
    } else if (typeof openSessionSettingsForSessionId === 'function') {
      openSessionSettingsForSessionId(sid);
    }
  });
  
  // Infinite scroll handler
  let scrollTimeout;
  sessionsContainer.addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
      const scrollTop = sessionsContainer.scrollTop;
      const scrollHeight = sessionsContainer.scrollHeight;
      const clientHeight = sessionsContainer.clientHeight;
      
      // Load more when user is 200px from bottom
      if (scrollHeight - scrollTop - clientHeight < 200) {
        loadMoreSessions();
      }
    }, 100);
  });
  
  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();

// Open session detail modal when redirected from session detail URL (?openSession=ID)
(function() {
  var params = new URLSearchParams(window.location.search);
  var openSession = params.get('openSession');
  if (openSession && /^\d+$/.test(openSession) && typeof openSessionDetailModal === 'function') {
    openSessionDetailModal(parseInt(openSession, 10));
    try { history.replaceState({}, document.title, window.location.pathname); } catch (e) {}
  }
})();
</script>
{% endblock %}

