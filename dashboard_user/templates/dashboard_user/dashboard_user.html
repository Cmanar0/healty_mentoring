{% extends "dashboard_user/base.html" %}
{% load static %}

{% block page_title %}User Dashboard{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <!-- PART 1: Actionable Items -->
    <div class="dashboard-part">
        <div class="dashboard-main-flex">
            
            <!-- Left Column (2/3) -->
            <div class="dashboard-col-left">
                <!-- Wallet and Coins Cards -->
                <div class="dashboard-stats-split">
                    <!-- Wallet Card -->
                    <div class="dashboard-card stats-card-half wallet-card">
                        <div class="card-header">
                            <h3 class="card-title">Wallet</h3>
                            <button type="button" class="btn-wallet-topup" onclick="openWalletTopUpModal(); return false;" aria-label="Top up wallet">
                                <i class="fas fa-plus"></i> Top up
                            </button>
                        </div>
                        <div class="credit-coins-content">
                            <div class="credit-coins-value">
                                <span class="currency-symbol">$</span>
                                <span class="credit-coins-amount" id="dashboardWalletAmount">{{ user_credit|floatformat:2 }}</span>
                            </div>
                            <p class="credit-coins-description">USD balance for sessions</p>
                        </div>
                    </div>

                    <!-- Coins Card -->
                    <div class="dashboard-card stats-card-half">
                        <div class="card-header">
                            <h3 class="card-title">Coins</h3>
                        </div>
                        <div class="credit-coins-content">
                            <div class="credit-coins-value">
                                <span class="credit-coins-amount">{{ user_coins }}</span>
                            </div>
                            <p class="credit-coins-description">Virtual currency for communities</p>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Sessions Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card">
                    <div class="card-header" style="align-items: flex-start;">
                        <h3 class="card-title">Upcoming Sessions</h3>
                        <div style="display: flex; gap: 16px; align-items: center; white-space: nowrap;">
                            <a href="/dashboard/user/my-sessions/" class="btn-link" style="color: var(--dash-text-muted);">View All Sessions</a>
                        </div>
                    </div>
                    
                    <div class="session-timeline-container scrollable-content" id="dashboardUpcomingSessions">
                        {% if upcoming_sessions %}
                            {% for session in upcoming_sessions %}
                                <div class="session-item status-{{ session.status }}" data-clickable-session data-session-id="{{ session.id }}" {% if session.status == 'invited' %}data-invitation-id="{{ session.invitation_id|default:'' }}" data-session-price="{{ session.session_price|default:0 }}" data-mentor-id="{{ session.mentor_user_id|default:'' }}" data-mentor-name="{{ session.mentor_name|default:'' }}" data-session-date="{{ session.start_datetime|date:'Y-m-d' }}" data-session-start="{{ session.start_datetime|date:'g:i A' }}" data-session-end="{{ session.end_datetime|date:'g:i A' }}"{% endif %}>
                                    <div class="session-left">
                                        <div class="session-date">
                                            <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                                            <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
                                        </div>
                                        <div class="session-info">
                                            <h4 class="session-title">Session with {{ session.mentor_name }}</h4>
                                            <div class="session-meta-row">
                                                <span class="session-time">
                                                    <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                                                </span>
                                                <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                                                    {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="session-right">
                                        <div class="dropdown">
                                            <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
                                                {% if session.status == 'confirmed' %}
                                                <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal({{ session.id }});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
                                                {% endif %}
                                                <button type="button" class="dropdown-item {% if session.status != 'confirmed' %}first-item {% endif %}delete-item last-item" onclick="if (typeof openUserCancelSessionModal === 'function') openUserCancelSessionModal({{ session.id }});"><i class="fas fa-times-circle"></i><span>Cancel session</span></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            {% if has_more_sessions %}
                                <div class="session-item session-item-view-all" style="border-left: none; padding: 16px; text-align: center;">
                                    <a href="/dashboard/user/my-sessions/" class="btn-link" style="color: var(--dash-text-muted); font-weight: 500;">View all upcoming sessions</a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
                                <p>No upcoming sessions</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column (1/3) -->
            <div class="dashboard-col-right">
                <!-- Manage Section -->
                <div class="create-new-section" id="createNewSection">
                    <h3 class="create-new-title">Manage</h3>
                    <div class="create-new-grid">
                        <button type="button" onclick="openMentorSelectModal(); return false;" class="create-new-btn btn-session" style="border: none; cursor: pointer; width: 100%; text-decoration: none;">
                            <div class="create-icon"><i class="fas fa-calendar-plus"></i></div>
                            <span class="create-label">Sessions</span>
                        </button>
                        <a href="#" class="create-new-btn btn-invite">
                            <div class="create-icon"><i class="fas fa-user-plus"></i></div>
                            <span class="create-label">Invite</span>
                        </a>
                        <a href="{% url 'general:dashboard_user:projects_list' %}" class="create-new-btn btn-project">
                            <div class="create-icon"><i class="fas fa-project-diagram"></i></div>
                            <span class="create-label">Projects</span>
                        </a>
                        <a href="#" class="create-new-btn btn-network">
                            <div class="create-icon"><i class="fas fa-users"></i></div>
                            <span class="create-label">Network</span>
                        </a>
                        <a href="#" class="create-new-btn btn-blog">
                            <div class="create-icon"><i class="fas fa-pen-nib"></i></div>
                            <span class="create-label">Blog</span>
                        </a>
                    </div>
                </div>

                <!-- Your Backlog Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card" id="backlogCard" style="max-height: 530px; display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3 class="card-title">Your backlog</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="backlog-sort-buttons" style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 0.8rem; color: #6b7280; font-weight: 500;">Sort by:</span>
                                <button class="backlog-sort-btn" data-sort="priority" onclick="toggleBacklogSort('priority')" title="Sort by priority">
                                    <i class="fas fa-sort-amount-down"></i>
                                </button>
                                <button class="backlog-sort-btn" data-sort="date" onclick="toggleBacklogSort('date')" title="Sort by date">
                                    <i class="fas fa-calendar-alt"></i>
                                </button>
                            </div>
                            <a href="{% url 'general:dashboard_user:active_backlog' %}" class="btn-link btn-fixed-width">View All</a>
                        </div>
                    </div>

                    <div class="scrollable-content" id="dashboardBacklogList" style="flex: 1; min-height: 0; overflow-y: auto;">
                        <!-- Tasks will be loaded dynamically via JavaScript -->
                        <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                            <i class="fas fa-spinner fa-spin"></i> Loading tasks...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Projects Section -->
    <div class="dashboard-part">
        {% if user_projects %}
            <h3 class="projects-section-title">Your Projects</h3>
            <div class="projects-grid-dashboard">
                {% for project in user_projects %}
                    <a href="{% url 'general:dashboard_user:project_detail' project.id %}" class="project-card-dashboard">
                        <div class="project-card-icon">
                            {% if project.template and project.template.icon %}
                                <i class="{{ project.template.icon }}"></i>
                            {% else %}
                                <i class="fas fa-cube"></i>
                            {% endif %}
                        </div>
                        <div class="project-card-content">
                            <h3 class="project-card-title">{{ project.title }}</h3>
                            {% if project.description %}
                                <p class="project-card-description">{{ project.description|truncatewords:15 }}</p>
                            {% endif %}
                            <div class="project-card-meta">
                                {% if project.supervised_by %}
                                    <span class="project-card-mentor">
                                        <i class="fas fa-user-tie"></i>
                                        {{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}
                                    </span>
                                {% endif %}
                                <span class="project-card-date">{{ project.created_at|date:"M d, Y" }}</span>
                            </div>
                        </div>
                        <div class="project-card-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="create-first-project-section">
                <button type="button" onclick="openCreateProjectModal()" class="btn-create-first-project">
                    <i class="fas fa-plus-circle"></i>
                    <span>Create Your First Project</span>
                </button>
            </div>
        {% endif %}
    </div>
</div>

{% include 'dashboard_user/projects/modals/create_project_modal.html' %}

<style>
/* Remove all padding from flex-scroll-card */
.dashboard-card.flex-scroll-card {
    padding: 0;
}

/* Add top, left, and right padding to card-header in flex-scroll-card */
.dashboard-card.flex-scroll-card .card-header {
    padding-top: 24px;
    padding-left: 24px;
    padding-right: 24px;
    padding-bottom: 0;
}

/* Add padding to sessions scrollable content */
.session-timeline-container.scrollable-content {
    padding-left: 32px;
    padding-right: 32px;
    padding-bottom: 32px;
}

/* Adjust timeline line position to account for padding */
.session-timeline-container.scrollable-content::before {
    left: 31px; /* Adjusted to align with dots */
    bottom: 32px; /* Stop before padding-bottom */
}

/* Make entire session row clickable */
.session-item[data-clickable-session] {
    cursor: pointer;
}

.session-item[data-clickable-session] .session-right {
    cursor: default;
}

.dashboard-stats-split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

@media (max-width: 768px) {
    .dashboard-stats-split {
        grid-template-columns: 1fr;
    }
}

.stats-card-half {
    min-height: auto;
}

.wallet-card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}
.btn-wallet-topup {
    padding: 6px 12px;
    font-size: 0.8125rem;
    font-weight: 600;
    color: #0d9488;
    background: rgba(13, 148, 136, 0.1);
    border: 1px solid rgba(13, 148, 136, 0.3);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.btn-wallet-topup:hover {
    background: rgba(13, 148, 136, 0.2);
    color: #0f766e;
}
.btn-wallet-topup i {
    margin-right: 4px;
}

.credit-coins-content {
    padding-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.credit-coins-value {
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.currency-symbol {
    font-size: 1.5rem;
    font-weight: 600;
    color: #111827;
}

.credit-coins-amount {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    line-height: 1;
}

.credit-coins-description {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
}

/* Use mentor dashboard button styling from dashboard.css, but override networking and invite button colors */
.btn-network {
    background: #f59e0b;
}

.btn-network:hover {
    background: #d97706;
}

.btn-invite {
    background: #10b981;
}

.btn-invite:hover {
    background: #059669;
}

/* When sidebar is open (not collapsed), make buttons smaller to fit in parent column */
.dashboard-sidebar:not(.collapsed) ~ .dashboard-main .create-new-grid {
    gap: 6px;
}

.dashboard-sidebar:not(.collapsed) ~ .dashboard-main .create-new-btn {
    padding: 8px 4px;
}

.dashboard-sidebar:not(.collapsed) ~ .dashboard-main .create-icon {
    font-size: 16px;
    margin-bottom: 4px;
}

.dashboard-sidebar:not(.collapsed) ~ .dashboard-main .create-label {
    font-size: 10px;
}

/* Projects Section */
.projects-section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dash-text-main);
    margin: 0 0 16px 0;
}

.projects-grid-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}

.project-card-dashboard {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 24px;
    display: flex;
    align-items: flex-start;
    gap: 16px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
    position: relative;
}

.project-card-dashboard:hover {
    border-color: #d1d5db;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.project-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #64748b;
    border: 1px solid #e2e8f0;
    flex-shrink: 0;
}

.project-card-content {
    flex: 1;
    min-width: 0;
}

.project-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.project-card-description {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 12px 0;
    line-height: 1.5;
}

.project-card-meta {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.8rem;
    color: #9ca3af;
}

.project-card-mentor {
    display: flex;
    align-items: center;
    gap: 6px;
}

.project-card-mentor i {
    font-size: 0.75rem;
}

.project-card-arrow {
    color: #d1d5db;
    font-size: 1rem;
    flex-shrink: 0;
    transition: color 0.2s, transform 0.2s;
}

.project-card-dashboard:hover .project-card-arrow {
    color: #64748b;
    transform: translateX(4px);
}

.create-first-project-section {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 80px 24px;
}

.btn-create-first-project {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 20px 40px;
    font-size: 1.125rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-create-first-project:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    transform: translateY(-2px);
}

.btn-create-first-project i {
    font-size: 1.5rem;
}

@media (max-width: 768px) {
    .projects-grid-dashboard {
        grid-template-columns: 1fr;
    }
    
    .create-first-project-section {
        padding: 60px 24px;
    }
    
    .btn-create-first-project {
        padding: 16px 32px;
        font-size: 1rem;
    }
}

/* Active Backlog Task Card Styles */
.active-backlog-task-item {
    display: flex;
    flex-direction: column;
    background: #fafafa;
    border-bottom: 1px solid #e5e7eb;
    border-radius: 0;
    margin-bottom: 0;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.active-backlog-task-item:hover {
    background: #ffffff;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-bottom-color: #d1d5db;
}

.active-backlog-task-item.fade-out {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
}

.active-backlog-task-header {
    display: flex;
    align-items: stretch;
    border-bottom: 1px solid #f3f4f6;
}

.active-backlog-task-content {
    flex: 1;
    padding: 16px;
    min-width: 0;
    cursor: pointer;
    height: auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    overflow: hidden;
}

.active-backlog-task-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
}

.active-backlog-task-title-text {
    flex: 1;
    min-width: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
}

.active-backlog-task-deadline {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
    color: #6b7280;
    white-space: nowrap;
    flex-shrink: 0;
}

.active-backlog-task-deadline.overdue {
    color: #ef4444;
}

.active-backlog-task-description {
    font-size: 0.8rem;
    color: #4b5563;
    line-height: 1.5;
    margin-bottom: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    line-clamp: 3;
    -webkit-box-orient: vertical;
    flex-shrink: 0;
}

.priority-tag {
    flex: 0 0 auto;
    padding: 6px 8px;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid transparent;
}

.priority-tag.priority-low {
    background-color: #f3f4f6;
    color: #6b7280;
    border-color: #e5e7eb;
}

.priority-tag.priority-medium {
    background-color: #dbeafe;
    color: #1e40af;
    border-color: #bfdbfe;
}

.priority-tag.priority-high {
    background-color: #fef3c7;
    color: #92400e;
    border-color: #fde68a;
}

.priority-tag.priority-urgent {
    background-color: #fee2e2;
    color: #991b1b;
    border-color: #fecaca;
}

.active-backlog-done-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #a7f3d0;
    background: #ecfdf5;
    color: #047857;
    min-width: 180px;
    width: 180px;
    box-sizing: border-box;
    white-space: nowrap;
}

.active-backlog-done-btn:hover {
    background: #10b981;
    border-color: #10b981;
    color: white;
}

.active-backlog-task-activate {
    display: flex;
    align-items: stretch;
    justify-content: center;
    flex-shrink: 0;
    width: 0;
    border-right: none;
    background: #f3f4f6;
    overflow: hidden;
    transition: width 0.3s ease, border-right 0.3s ease;
}

.active-backlog-task-item:hover .active-backlog-task-activate {
    width: 55px;
    border-right: 1px solid #e5e7eb;
}

.active-backlog-task-activate.hidden {
    display: none;
}

.active-backlog-task-activate-btn {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 0;
    transition: all 0.2s;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    position: relative;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1;
}

.active-backlog-task-item:hover .active-backlog-task-activate-btn {
    opacity: 1;
}

.active-backlog-task-activate-btn:hover {
    background: #fee2e2;
    color: #ef4444;
    border-radius: 0;
}

.active-backlog-task-activate-btn .deactivate-popover {
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    background: #111827;
    color: white;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s ease-in-out;
    z-index: 1001;
    visibility: hidden;
}

.active-backlog-task-activate-btn .deactivate-popover::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: #111827;
}

.active-backlog-task-activate-btn:hover .deactivate-popover {
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
}

.active-backlog-task-activate {
    overflow: visible;
}

.deactivate-icon-stack {
    position: relative;
    display: inline-flex;
    align-items: center;
    margin-right: 10px;
    justify-content: center;
}

.active-backlog-task-content.has-no-activate-btn {
    background: transparent;
    transition: background 0.2s;
}

.active-backlog-task-content.has-no-activate-btn:hover {
    background: transparent;
}

.active-backlog-task-source-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    align-items: center;
}

.active-backlog-task-source-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #64748b;
    margin-right: 2px;
}

.active-backlog-task-source-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.7rem;
    color: #475569;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.active-backlog-task-source-tag:hover {
    background: #e2e8f0;
    border-color: #cbd5e1;
    color: #334155;
    text-decoration: none;
}

.active-backlog-task-source-tag i {
    font-size: 0.65rem;
    opacity: 0.7;
}

.active-backlog-task-item.fade-out {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.4s ease, transform 0.4s ease;
}

/* Backlog Sort Buttons */
.backlog-sort-buttons {
    display: flex;
    gap: 8px;
    align-items: center;
}

.backlog-sort-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    width: 32px;
    height: 32px;
}

.backlog-sort-btn:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    color: #374151;
}

.backlog-sort-btn.active {
    background: #10b981;
    border-color: #10b981;
    color: white;
}

.backlog-sort-btn i {
    font-size: 0.75rem;
}

/* Remove min-width from btn-fixed-width */
.btn-fixed-width {
    min-width: 0;
}
</style>

<script>
let dashboardBacklogTasks = []; // Store tasks for sorting
let dashboardBacklogSort = null; // 'priority', 'date', or null

// Load dashboard backlog tasks (only todo tasks)
function loadDashboardBacklog() {
    const container = document.getElementById('dashboardBacklogList');
    if (!container) return;
    
    fetch('{% url "general:dashboard_user:get_user_active_backlog_api" %}?filter=todo', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            dashboardBacklogTasks = data.tasks || [];
            dashboardBacklogSort = null;
            document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
            applyDashboardBacklogSort();
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0;">Error loading tasks</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading backlog:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 16px; color: var(--dash-text-muted);">
                <i class="fas fa-exclamation-triangle" style="font-size: 1rem; margin-bottom: 8px; opacity: 0.3;"></i>
                <p style="margin: 0;">Error loading tasks</p>
            </div>
        `;
    });
}

// Toggle backlog sort
function toggleBacklogSort(sortType) {
    const btn = document.querySelector(`.backlog-sort-btn[data-sort="${sortType}"]`);
    if (!btn) return;
    
    // If clicking the same button, toggle it off
    if (dashboardBacklogSort === sortType) {
        dashboardBacklogSort = null;
        btn.classList.remove('active');
    } else {
        // Remove active from all buttons
        document.querySelectorAll('.backlog-sort-btn').forEach(b => b.classList.remove('active'));
        // Set new sort
        dashboardBacklogSort = sortType;
        btn.classList.add('active');
    }
    
    // Apply sort
    applyDashboardBacklogSort();
}

// Apply sorting to dashboard backlog tasks
function applyDashboardBacklogSort() {
    let sortedTasks = [...dashboardBacklogTasks];
    
    if (dashboardBacklogSort === 'priority') {
        // Sort by priority: urgent > high > medium > low
        const priorityOrder = { 'urgent': 4, 'high': 3, 'medium': 2, 'low': 1 };
        sortedTasks.sort((a, b) => {
            const aPriority = priorityOrder[a.priority || 'medium'] || 2;
            const bPriority = priorityOrder[b.priority || 'medium'] || 2;
            return bPriority - aPriority; // Highest priority first
        });
    } else if (dashboardBacklogSort === 'date') {
        // Sort by deadline: earliest first (null deadlines go to end)
        sortedTasks.sort((a, b) => {
            if (!a.deadline && !b.deadline) return 0;
            if (!a.deadline) return 1; // No deadline goes to end
            if (!b.deadline) return -1; // No deadline goes to end
            const dateA = new Date(a.deadline);
            const dateB = new Date(b.deadline);
            return dateA - dateB; // Earliest first
        });
    }
    // If dashboardBacklogSort is null, use original order
    
    renderDashboardBacklog(sortedTasks);
}

// Render dashboard backlog tasks using same styling as backlog page
function renderDashboardBacklog(tasks) {
    const container = document.getElementById('dashboardBacklogList');
    if (!container) return;
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 32px 16px; color: #9ca3af; font-size: 0.85rem;">
                <i class="fas fa-clipboard-list" style="font-size: 2rem; margin-bottom: 12px; opacity: 0.2;"></i>
                <p style="margin: 0; font-weight: 500;">No tasks to do</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: flex; flex-direction: column;">';
    tasks.forEach(task => {
        const priority = task.priority || 'medium';
        const priorityLabel = priority.charAt(0).toUpperCase() + priority.slice(1);
        const priorityClass = `priority-${priority}`;
        
        // Format deadline date and check if overdue
        let deadlineHtml = '';
        if (task.deadline) {
            const deadlineDate = new Date(task.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            deadlineDate.setHours(0, 0, 0, 0);
            const isOverdue = deadlineDate < today && !task.completed;
            
            const formattedDate = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const overdueClass = isOverdue ? 'overdue' : '';
            
            deadlineHtml = `
                <div class="active-backlog-task-deadline ${overdueClass}">
                    <i class="fas fa-calendar-alt" style="font-size: 0.7rem;"></i>
                    <span>${formattedDate}</span>
                </div>
            `;
        }
        
        const descriptionHtml = task.description ? `
            <div class="active-backlog-task-description" style="margin-bottom: 8px;">${escapeHtml(task.description)}</div>
        ` : '';
        
        const escapedTitle = (task.title || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        const escapedDescription = (task.description || '').replace(/'/g, "\\'").replace(/\n/g, ' ');
        
        const hasStage = task.has_stage || false;
        
        const deactivateIcon = `
            <div class="deactivate-icon-stack">
                <i class="fas fa-list" style="font-size: 0.7rem; position: absolute; left: 2px;"></i>
                <i class="fas fa-chevron-left" style="font-size: 0.5rem; position: absolute; left: -8px;"></i>
            </div>
            <span class="deactivate-popover">Deactivate</span>
        `;

        // Project/stage source row as clickable tags
        let sourceRowHtml = '';
        if (task.has_stage && task.project_id) {
            const projectUrl = `/dashboard/user/projects/${task.project_id}/`;
            const stageUrl = task.stage_id ? `/dashboard/user/projects/${task.project_id}/?open_stage=${task.stage_id}` : projectUrl;
            
            sourceRowHtml = '<div class="active-backlog-task-source-row">';
            if (task.project_title) {
                sourceRowHtml += '<span class="active-backlog-task-source-label">Project:</span>';
                sourceRowHtml += `<a href="${projectUrl}" class="active-backlog-task-source-tag" onclick="event.stopPropagation();">
                    <i class="fas fa-project-diagram"></i>
                    <span>${escapeHtml(task.project_title)}</span>
                </a>`;
            }
            if (task.stage_title && task.stage_id) {
                sourceRowHtml += '<span class="active-backlog-task-source-label">Stage:</span>';
                sourceRowHtml += `<a href="${stageUrl}" class="active-backlog-task-source-tag" onclick="event.stopPropagation();">
                    <i class="fas fa-layer-group"></i>
                    <span>${escapeHtml(task.stage_title)}</span>
                </a>`;
            }
            sourceRowHtml += '</div>';
        }
        
        html += `
            <div class="active-backlog-task-item" 
                 data-task-id="${task.id}" 
                 data-has-stage="${hasStage}"
                 data-stage-id="${task.stage_id || ''}"
                 data-project-id="${task.project_id || ''}"
                 data-priority="${priority}">
                <div class="active-backlog-task-header" style="border-bottom: none;">
                    <div class="active-backlog-task-activate ${hasStage ? '' : 'hidden'}">
                        <button class="active-backlog-task-activate-btn" 
                                data-task-id="${task.id}"
                                data-stage-id="${task.stage_id || ''}"
                                data-project-id="${task.project_id || ''}"
                                onmouseover="updateDashboardActiveBacklogActivateButton(this, true)"
                                onmouseout="updateDashboardActiveBacklogActivateButton(this, false)"
                                onclick="deactivateDashboardTask(${task.id}, event)">
                            ${deactivateIcon}
                        </button>
                    </div>
                    <div class="active-backlog-task-content ${hasStage ? '' : 'has-no-activate-btn'}" onclick="editDashboardTask(${task.id}, '${escapedTitle}', '${escapedDescription}', '${task.deadline || ''}', '${task.priority || 'medium'}', event)">
                        <div class="active-backlog-task-title-row">
                            <div class="active-backlog-task-title-text">${escapeHtml(task.title)}</div>
                            ${deadlineHtml}
                        </div>
                        ${sourceRowHtml}
                        ${descriptionHtml}
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                            <span class="priority-tag ${priorityClass}">${priorityLabel}</span>
                            <div class="active-backlog-done-btn" 
                                 onclick="toggleDashboardTask(${task.id}, event)">
                                <i class="fas fa-check"></i> Mark Done
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

// Edit task from dashboard
function editDashboardTask(taskId, title, description, deadline, priority, event) {
    event.stopPropagation();
    if (typeof window.openCreateActiveBacklogTaskModal === 'function') {
        window.openCreateActiveBacklogTaskModal(taskId, title, description, deadline, priority);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Dashboard task management functions
function toggleDashboardTask(taskId, event) {
    event.stopPropagation();
    
    const completeBtn = event.target.closest('.active-backlog-done-btn');
    if (!completeBtn) return;
    
    const newCompleted = true; // Always mark as completed when clicking "Mark Done"
    
    const endpoint = `{% url "general:dashboard_user:toggle_active_backlog_task_complete" 0 %}`.replace('0', taskId);
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ completed: newCompleted })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload backlog to show updated list
            loadDashboardBacklog();
        } else {
            console.error('Failed to toggle task:', data.error);
            alert('Failed to update task: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error toggling task:', error);
        alert('An error occurred while updating the task.');
    });
}

// Update active backlog activate button on hover (dashboard)
function updateDashboardActiveBacklogActivateButton(button, isHover) {
    const stack = button.querySelector('.deactivate-icon-stack');
    if (!stack) return;
    
    if (isHover) {
        button.style.color = '#ef4444'; // Red on hover
    } else {
        button.style.color = '#9ca3af'; // Grey by default
    }
}

// Deactivate stage-linked task from dashboard
let pendingDeactivateDashboardTaskId = null;
let pendingDeactivateDashboardButton = null;

function deactivateDashboardTask(taskId, event) {
    event.stopPropagation();
    
    const taskItem = event.target.closest('.active-backlog-task-item');
    const stageId = taskItem ? taskItem.dataset.stageId : null;
    const projectId = taskItem ? taskItem.dataset.projectId : null;

    if (!stageId || !projectId) {
        alert('Cannot deactivate task created directly in active backlog');
        return;
    }
    
    const button = event.target.closest('.active-backlog-task-activate-btn');
    if (!button) return;

    // Store task info for confirmation
    pendingDeactivateDashboardTaskId = taskId;
    pendingDeactivateDashboardButton = button;

    // Open confirmation modal
    openDeactivateDashboardTaskModal();
}

// Open deactivate task confirmation modal (dashboard)
function openDeactivateDashboardTaskModal() {
    const overlay = document.getElementById('deactivateTaskModalOverlay');
    const errorEl = document.getElementById('deactivateTaskModalError');
    if (overlay) {
        if (errorEl) errorEl.style.display = 'none';
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');
    }
}

// Close deactivate task confirmation modal (dashboard)
function closeDeactivateDashboardTaskModal() {
    const overlay = document.getElementById('deactivateTaskModalOverlay');
    const errorEl = document.getElementById('deactivateTaskModalError');
    if (overlay) {
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');
    }
    if (errorEl) errorEl.style.display = 'none';
    pendingDeactivateDashboardTaskId = null;
    pendingDeactivateDashboardButton = null;
}

// Confirm deactivate task (dashboard)
function confirmDeactivateDashboardTask() {
    if (!pendingDeactivateDashboardTaskId || !pendingDeactivateDashboardButton) return;

    const taskId = pendingDeactivateDashboardTaskId;
    const button = pendingDeactivateDashboardButton;
    const errorEl = document.getElementById('deactivateTaskModalError');
    const confirmBtn = document.getElementById('deactivateTaskConfirmBtn');

    if (confirmBtn) confirmBtn.disabled = true;
    if (errorEl) errorEl.style.display = 'none';

    const endpoint = `{% url "general:dashboard_user:deactivate_active_backlog_task" 0 %}`.replace('0', taskId);
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (confirmBtn) confirmBtn.disabled = false;
        if (data.success) {
            closeDeactivateDashboardTaskModal();
            // Remove task from active backlog with fade-out animation
            const taskItem = button.closest('.active-backlog-task-item');
            if (taskItem) {
                taskItem.classList.add('fade-out');
                setTimeout(() => {
                    taskItem.remove();
                    // Reload backlog to show updated list
                    loadDashboardBacklog();
                }, 400);
            }
        } else {
            console.error('Failed to deactivate task:', data.error);
            if (errorEl) {
                errorEl.textContent = data.error || 'Failed to deactivate task';
                errorEl.style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Error deactivating task:', error);
        if (confirmBtn) confirmBtn.disabled = false;
        if (errorEl) {
            errorEl.textContent = 'An error occurred while deactivating the task.';
            errorEl.style.display = 'block';
        }
    });
}

function deleteDashboardTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }
    
    fetch(`{% url "general:dashboard_user:delete_active_backlog_task" 0 %}`.replace('0', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload backlog to show updated list
            loadDashboardBacklog();
        } else {
            console.error('Failed to delete task:', data.error);
            alert('Failed to delete task: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting task:', error);
        alert('An error occurred while deleting the task.');
    });
}

function openCreateProjectModal() {
    const modal = document.getElementById('createProjectModal');
    if (modal) {
        modal.style.display = 'flex';
    }
}

// Make session rows clickable (entire row, not just text)
// NOTE: This handler is replaced by the more complete handler below that checks status
// Keeping this commented out to avoid conflicts
/*
(function() {
    const container = document.getElementById('dashboardUpcomingSessions');
    if (container) {
        container.addEventListener('click', function(e) {
            const row = e.target.closest('.session-item[data-clickable-session]');
            if (!row) return;
            // Don't trigger if clicking on dropdown menu
            if (e.target.closest('.session-right')) return;
            const sessionId = row.getAttribute('data-session-id');
            if (sessionId && typeof openSessionDetailModal === 'function') {
                openSessionDetailModal(parseInt(sessionId, 10));
            }
        });
    }
})();
*/

// Load backlog on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardBacklog();
    attachMentorSelectHandlers();
});

// Mentor Selection Modal Functions - Define in global scope
window.openMentorSelectModal = function() {
    console.log('openMentorSelectModal called');
    const modal = document.getElementById('mentorSelectModal');
    console.log('Modal element:', modal);
    if (modal) {
        // Use both display: flex and active class to ensure visibility
        modal.style.display = 'flex';
        modal.classList.add('active');
        modal.style.opacity = '1';
        modal.style.visibility = 'visible';
        document.body.style.overflow = 'hidden';
        console.log('Modal should be visible now');
    } else {
        console.error('Modal element not found!');
        // Try to find it after a short delay in case DOM isn't ready
        setTimeout(function() {
            const modalRetry = document.getElementById('mentorSelectModal');
            if (modalRetry) {
                modalRetry.style.display = 'flex';
                modalRetry.classList.add('active');
                modalRetry.style.opacity = '1';
                modalRetry.style.visibility = 'visible';
                document.body.style.overflow = 'hidden';
                console.log('Modal found on retry');
            } else {
                console.error('Modal still not found after retry');
            }
        }, 100);
    }
};

// Also define as regular function for backwards compatibility
function openMentorSelectModal() {
    window.openMentorSelectModal();
}

window.closeMentorSelectModal = function() {
    const modal = document.getElementById('mentorSelectModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
        document.body.style.overflow = '';
    }
};

// Also define as regular function for backwards compatibility
function closeMentorSelectModal() {
    window.closeMentorSelectModal();
}

function attachMentorSelectHandlers() {
    // Make mentor list items clickable
    const mentorItems = document.querySelectorAll('.mentor-select-item');
    mentorItems.forEach(item => {
        item.addEventListener('click', function() {
            const mentorUserId = this.getAttribute('data-mentor-user-id');
            if (mentorUserId) {
                loadBookingModalForMentor(parseInt(mentorUserId));
            }
        });
    });
    
    // Close modal when clicking outside
    const modal = document.getElementById('mentorSelectModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeMentorSelectModal();
            }
        });
    }
}

function loadBookingModalForMentor(mentorUserId) {
    const container = document.getElementById('bookingModalContainer');
    if (!container || !mentorUserId) return;

    // Always clean up completely to avoid conflicts
    const existingBookingScripts = document.querySelectorAll('script[data-booking-modal]');
    existingBookingScripts.forEach(script => script.remove());
    
    const existingModal = document.getElementById('bookingModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Clean up Stripe Elements if they exist
    if (typeof window.cardNumberElement !== 'undefined' && window.cardNumberElement) {
        try { window.cardNumberElement.unmount(); } catch(e) {}
        window.cardNumberElement = null;
    }
    if (typeof window.cardExpiryElement !== 'undefined' && window.cardExpiryElement) {
        try { window.cardExpiryElement.unmount(); } catch(e) {}
        window.cardExpiryElement = null;
    }
    if (typeof window.cardCvcElement !== 'undefined' && window.cardCvcElement) {
        try { window.cardCvcElement.unmount(); } catch(e) {}
        window.cardCvcElement = null;
    }
    
    // Reset initialization flags so script can be re-executed
    window.bookingModalInitialized = undefined;
    window._bookingModalVarsInitialized = undefined;
    
    // Clear container completely
    container.innerHTML = '';
    
    // Reset container to hidden state
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.width = '0';
    container.style.height = '0';
    container.style.overflow = 'hidden';
    container.style.zIndex = '-1';

    fetch(`/dashboard/user/booking-modal/${mentorUserId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success || !data.html) {
            console.error('Failed to load booking modal:', data.error);
            alert(data.error || 'Unable to open booking modal.');
            return;
        }

        container.innerHTML = data.html;
        // Reset container styles to allow modal to display properly
        container.style.position = 'fixed';
        container.style.top = '0';
        container.style.left = '0';
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.overflow = 'visible';
        container.style.zIndex = '10000';

        // Mark that we're opening from dashboard (before scripts execute)
        window.bookingModalFromDashboard = true;
        
        // Ensure Stripe.js is loaded before processing scripts
        function ensureStripeLoaded(callback) {
            // First check if Stripe.js is already available (most common case)
            if (typeof window.Stripe === 'function') {
                console.log('Stripe.js already available globally');
                callback();
                return;
            }
            
            // Check if Stripe script is already on the page (but exclude scripts inside the container - they haven't executed yet)
            const allStripeScripts = document.querySelectorAll('script[src*="stripe.com"]');
            const existingStripeScript = Array.from(allStripeScripts).find(script => {
                // Exclude scripts that are inside the container (they haven't executed yet)
                return !container.contains(script);
            });
            
            if (existingStripeScript) {
                console.log('Stripe script tag found on page (outside container), waiting for it to initialize...');
                let waitCount = 0;
                const maxWait = 10; // Reduced to 10 (500ms max) - scripts should load quickly
                const waitForStripe = setInterval(() => {
                    waitCount++;
                    // Check if Stripe.js is now available
                    if (typeof window.Stripe === 'function') {
                        console.log('Stripe.js initialized after', waitCount * 50, 'ms');
                        clearInterval(waitForStripe);
                        callback();
                    } else if (waitCount >= maxWait) {
                        // After 500ms, load a new script (existing one might be stuck)
                        console.warn('Stripe.js not initializing from existing script after', maxWait * 50, 'ms, loading new one...');
                        clearInterval(waitForStripe);
                        loadStripeScript(callback);
                    }
                }, 50); // Check every 50ms for faster detection
            } else {
                console.log('No Stripe script found (or only in container), loading it now...');
                loadStripeScript(callback);
            }
        }
        
        function loadStripeScript(callback) {
            // Check one more time if Stripe.js became available while we were waiting
            if (typeof window.Stripe === 'function') {
                console.log('Stripe.js became available while preparing to load script');
                callback();
                return;
            }
            
            const stripeScript = document.createElement('script');
            stripeScript.src = 'https://js.stripe.com/v3/';
            stripeScript.onload = function() {
                console.log('Stripe script tag loaded, waiting for initialization...');
                let initCount = 0;
                const maxInitWait = 10; // Reduced to 10 (500ms max) - Stripe.js initializes quickly
                const waitInit = setInterval(() => {
                    initCount++;
                    if (typeof window.Stripe === 'function') {
                        console.log('Stripe.js initialized after', initCount * 50, 'ms');
                        clearInterval(waitInit);
                        callback();
                    } else if (initCount >= maxInitWait) {
                        console.error('Stripe.js failed to initialize after', maxInitWait * 50, 'ms');
                        clearInterval(waitInit);
                        callback(); // Continue anyway
                    }
                }, 50); // Check every 50ms
            };
            stripeScript.onerror = function() {
                console.error('Failed to load Stripe.js script');
                callback(); // Continue anyway
            };
            document.head.appendChild(stripeScript);
        }
        
        // Execute scripts sequentially to ensure proper initialization
        // Get scripts fresh each time to avoid stale references
        // Exclude data script tags (json_script creates script tags with type="application/json")
        function getScripts() {
            const allScripts = Array.from(container.querySelectorAll('script'));
            console.log('All scripts found:', allScripts.length);
            allScripts.forEach((script, idx) => {
                console.log(`Script ${idx}:`, {
                    src: script.src || 'inline',
                    type: script.type,
                    id: script.id,
                    isDataScript: script.type === 'application/json' || 
                                 script.id === 'one-time-slots-data' || 
                                 script.id === 'recurring-slots-data' || 
                                 script.id === 'mentor-session-length'
                });
            });
            
            return allScripts.filter(script => {
                // Keep data script tags (they have type="application/json" or specific IDs)
                const isDataScript = script.type === 'application/json' || 
                                    script.id === 'one-time-slots-data' || 
                                    script.id === 'recurring-slots-data' || 
                                    script.id === 'mentor-session-length';
                return !isDataScript; // Exclude data scripts from execution list
            });
        }
        
        let scriptIndex = 0;
        let initialScripts = [];
        
        // First ensure Stripe.js is loaded, then get scripts and execute
        ensureStripeLoaded(() => {
            initialScripts = getScripts();
            console.log('Found', initialScripts.length, 'executable scripts (excluding data scripts)');
            executeNextScript();
        });
        
        function executeNextScript() {
            const scripts = getScripts(); // Get fresh list
            console.log('executeNextScript called, scriptIndex:', scriptIndex, 'remaining scripts:', scripts.length);
            
            if (scriptIndex >= initialScripts.length || scripts.length === 0) {
                console.log('All scripts executed, opening modal');
                // All scripts loaded, now open modal
                closeMentorSelectModal();
                
                // Hook into closeBookingModal to clean up when modal closes
                const originalCloseBookingModal = window.closeBookingModal;
                if (typeof originalCloseBookingModal === 'function') {
                    window.closeBookingModal = function() {
                        originalCloseBookingModal.apply(this, arguments);
                        // Clean up after a short delay to allow modal close animation
                        setTimeout(() => {
                            const container = document.getElementById('bookingModalContainer');
                            if (container) {
                                // Remove booking modal scripts
                                const bookingScripts = document.querySelectorAll('script[data-booking-modal]');
                                bookingScripts.forEach(script => script.remove());
                                
                                // Clean up Stripe Elements
                                if (typeof window.cardNumberElement !== 'undefined' && window.cardNumberElement) {
                                    try { window.cardNumberElement.unmount(); } catch(e) {}
                                    window.cardNumberElement = null;
                                }
                                if (typeof window.cardExpiryElement !== 'undefined' && window.cardExpiryElement) {
                                    try { window.cardExpiryElement.unmount(); } catch(e) {}
                                    window.cardExpiryElement = null;
                                }
                                if (typeof window.cardCvcElement !== 'undefined' && window.cardCvcElement) {
                                    try { window.cardCvcElement.unmount(); } catch(e) {}
                                    window.cardCvcElement = null;
                                }
                                
                                // Clear container (this will remove data scripts too, which is fine on cleanup)
                                container.innerHTML = '';
                                // Reset to hidden state
                                container.style.position = 'fixed';
                                container.style.top = '0';
                                container.style.left = '0';
                                container.style.width = '0';
                                container.style.height = '0';
                                container.style.overflow = 'hidden';
                                container.style.zIndex = '-1';
                                window.bookingModalFromDashboard = false;
                                
                                // Reset initialization flags so script can be re-executed
                                window.bookingModalInitialized = undefined;
                                window._bookingModalVarsInitialized = undefined;
                            }
                        }, 300);
                    };
                }
                
                // Wait for functions to be available, then reinitialize and open modal
                function tryOpenModal(retryCount = 0) {
                    const maxRetries = 10; // 500ms max wait (reduced from 2 seconds)
                    console.log('Attempting to initialize and open booking modal (attempt', retryCount + 1, ')');
                    console.log('initBookingModal exists:', typeof window.initBookingModal === 'function');
                    console.log('openBookingModal exists:', typeof window.openBookingModal === 'function');
                    console.log('Stripe.js loaded:', typeof window.Stripe === 'function');
                    
                    // Check if data scripts exist
                    const oneTimeData = document.getElementById('one-time-slots-data');
                    const recurringData = document.getElementById('recurring-slots-data');
                    const sessionLengthEl = document.getElementById('mentor-session-length');
                    console.log('Data scripts check:', {
                        oneTimeData: oneTimeData ? 'found' : 'NOT FOUND',
                        recurringData: recurringData ? 'found' : 'NOT FOUND',
                        sessionLengthEl: sessionLengthEl ? 'found' : 'NOT FOUND'
                    });
                    
                    // Check if both functions are available
                    if (typeof window.initBookingModal === 'function' && typeof window.openBookingModal === 'function') {
                        // Reinitialize DOM elements
                        try {
                            window.initBookingModal();
                            console.log('initBookingModal called successfully');
                        } catch (e) {
                            console.error('Error calling initBookingModal:', e);
                        }
                        
                        // Open the modal
                        try {
                            window.openBookingModal();
                            console.log('openBookingModal called successfully');
                        } catch (e) {
                            console.error('Error calling openBookingModal:', e);
                        }
                    } else if (retryCount < maxRetries) {
                        // Functions not ready yet, retry after 50ms (reduced from 100ms)
                        setTimeout(() => tryOpenModal(retryCount + 1), 50);
                    } else {
                        console.error('openBookingModal or initBookingModal function not found after', maxRetries, 'retries');
                    }
                }
                
                // Start trying immediately (Stripe is already loaded)
                tryOpenModal();
                return;
            }
            
            // Use initialScripts array for indexing, but check if script still exists
            const oldScript = initialScripts[scriptIndex];
            if (!oldScript || !oldScript.parentNode) {
                // Script was already removed, skip it
                scriptIndex++;
                setTimeout(executeNextScript, 0);
                return;
            }
            
            // Double-check this isn't a data script (shouldn't happen due to filter, but be safe)
            const isDataScript = oldScript.type === 'application/json' || 
                                oldScript.id === 'one-time-slots-data' || 
                                oldScript.id === 'recurring-slots-data' || 
                                oldScript.id === 'mentor-session-length';
            if (isDataScript) {
                // Skip data scripts - they should not be executed
                scriptIndex++;
                setTimeout(executeNextScript, 0);
                return;
            }
            
            scriptIndex++;
            
            if (oldScript.src) {
                // For external scripts (like Stripe), check if already loaded
                const isStripeScript = oldScript.src.includes('stripe.com');
                console.log('Processing external script:', oldScript.src, 'isStripeScript:', isStripeScript);
                
                // For Stripe, if it's already available, skip loading the script tag
                if (isStripeScript) {
                    if (typeof window.Stripe === 'function') {
                        console.log('Stripe.js already available globally, skipping script tag from modal');
                        oldScript.remove();
                        setTimeout(executeNextScript, 50);
                        return;
                    } else {
                        console.log('Stripe.js not available yet, but we should have loaded it already');
                        // Stripe should be loaded by ensureStripeLoaded, but if not, skip this script tag
                        // and continue - Stripe mounting will handle retries
                        oldScript.remove();
                        setTimeout(executeNextScript, 50);
                        return;
                    }
                }
                
                const existingScript = document.querySelector(`script[src="${oldScript.src}"]`);
                
                if (existingScript) {
                    // Already loaded, but for Stripe.js, verify it's actually available
                    if (isStripeScript) {
                        if (typeof window.Stripe === 'function') {
                            console.log('Stripe.js already loaded and available - using existing');
                            setTimeout(executeNextScript, 50);
                        } else {
                            console.log('Stripe script tag exists on page but Stripe.js not available yet');
                            console.log('Script tag src:', existingScript.src);
                            console.log('Script tag onload:', existingScript.onload);
                            // Wait a bit for Stripe to initialize
                            let checkCount = 0;
                            const checkStripe = setInterval(() => {
                                checkCount++;
                                if (typeof window.Stripe === 'function') {
                                    console.log('Stripe.js now available after', checkCount * 100, 'ms');
                                    clearInterval(checkStripe);
                                    executeNextScript();
                                } else if (checkCount >= 30) {
                                    console.error('Stripe.js still not available after 3 seconds');
                                    console.error('Trying to reload Stripe script...');
                                    clearInterval(checkStripe);
                                    // Try to reload the script
                                    const newStripeScript = document.createElement('script');
                                    newStripeScript.src = 'https://js.stripe.com/v3/';
                                    newStripeScript.onload = function() {
                                        console.log('Stripe script reloaded');
                                        setTimeout(() => {
                                            if (typeof window.Stripe === 'function') {
                                                console.log('Stripe.js available after reload');
                                                executeNextScript();
                                            } else {
                                                console.error('Stripe.js still not available after reload');
                                                executeNextScript();
                                            }
                                        }, 200);
                                    };
                                    newStripeScript.onerror = function() {
                                        console.error('Failed to reload Stripe script');
                                        executeNextScript();
                                    };
                                    document.head.appendChild(newStripeScript);
                                }
                            }, 100);
                        }
                    } else {
                        console.log('External script already loaded:', oldScript.src);
                        setTimeout(executeNextScript, 50);
                    }
                    return;
                }
                
                const newScript = document.createElement('script');
                newScript.setAttribute('data-booking-modal', 'true');
                newScript.src = oldScript.src;
                newScript.onload = function() {
                    console.log('External script loaded:', oldScript.src);
                    // For Stripe.js, verify it's available and wait a bit more
                    if (isStripeScript) {
                        console.log('Stripe script tag loaded, waiting for Stripe.js to initialize...');
                        // Wait for Stripe to be available
                        let stripeCheckCount = 0;
                        const checkStripe = setInterval(() => {
                            stripeCheckCount++;
                            if (typeof window.Stripe === 'function') {
                                console.log('Stripe.js is now available after', stripeCheckCount * 100, 'ms');
                                clearInterval(checkStripe);
                                setTimeout(executeNextScript, 100);
                            } else if (stripeCheckCount >= 30) {
                                // Give up after 3 seconds
                                console.error('Stripe.js not available after loading script tag after', stripeCheckCount * 100, 'ms');
                                console.error('window.Stripe type:', typeof window.Stripe);
                                console.error('window.Stripe value:', window.Stripe);
                                clearInterval(checkStripe);
                                executeNextScript();
                            }
                        }, 100);
                    } else {
                        executeNextScript();
                    }
                };
                newScript.onerror = function() {
                    console.error('Error loading external script:', oldScript.src);
                    executeNextScript(); // Continue even on error
                };
                document.body.appendChild(newScript);
            } else {
                // For inline scripts, check if already executed
                const scriptContent = oldScript.textContent || '';
                console.log('Processing inline script', scriptIndex, 'length:', scriptContent.length);
                
                // Check if this is the main booking modal script (contains initBookingModal)
                const isMainScript = scriptContent.includes('function initBookingModal');
                
                if (isMainScript && typeof window.initBookingModal === 'function') {
                    // Main script already executed - skip script execution but remove from container
                    oldScript.remove();
                    console.log('Booking modal script already loaded, skipping re-execution');
                    // Still need to reconnect DOM elements - will be done in initBookingModal call after all scripts
                    // Execute next script immediately
                    setTimeout(executeNextScript, 0);
                    return;
                }
                
                // Remove the script tag from container first to avoid double execution
                oldScript.remove();
                
                try {
                    // Create and append script - this executes in global scope
                    // Using appendChild ensures functions are in global scope
                    const newScript = document.createElement('script');
                    newScript.setAttribute('data-booking-modal', 'true');
                    newScript.textContent = scriptContent;
                    
                    // Append to body - this will execute the script in global scope
                    document.body.appendChild(newScript);
                    console.log('Script', scriptIndex, 'executed successfully');
                } catch (e) {
                    console.error('Error executing script', scriptIndex, ':', e);
                }
                
                // Execute next script immediately (inline scripts execute synchronously)
                setTimeout(executeNextScript, 0);
            }
        }
    })
    .catch(error => {
        console.error('Error loading booking modal:', error);
        alert('An error occurred while loading the booking modal.');
    });
}
</script>

<!-- Mentor Selection Modal -->
<div id="mentorSelectModal" class="modal-overlay mentor-select-modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
            <h2>Select a Mentor</h2>
            <button type="button" class="modal-close" onclick="closeMentorSelectModal()">&times;</button>
        </div>
        <div class="modal-body">
            {% if mentor_relationships %}
                <div class="mentor-select-list">
                    {% for relationship in mentor_relationships %}
                        <div class="mentor-select-item" data-mentor-user-id="{{ relationship.mentor.user.id }}" style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: background-color 0.2s;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                {% if relationship.mentor.profile_picture %}
                                    <img src="{{ relationship.mentor.profile_picture.url }}" alt="{{ relationship.mentor.first_name }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                    <div style="width: 50px; height: 50px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #6b7280;">
                                        {{ relationship.mentor.first_name|first }}{{ relationship.mentor.last_name|first }}
                                    </div>
                                {% endif %}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1.1rem; color: #111827;">
                                        {{ relationship.mentor.first_name }} {{ relationship.mentor.last_name }}
                                    </div>
                                    {% if relationship.mentor.mentor_type %}
                                        <div style="color: #6b7280; font-size: 0.9rem;">{{ relationship.mentor.mentor_type }}</div>
                                    {% endif %}
                                </div>
                                <i class="fas fa-chevron-right" style="color: #9ca3af;"></i>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>You don't have any mentors yet.</p>
                </div>
            {% endif %}
            
            <div style="margin-top: 24px; display: flex; gap: 12px; flex-direction: column;">
                <a href="/mentors/" class="btn btn-primary" style="text-align: center; padding: 12px; text-decoration: none; display: block;">
                    <i class="fas fa-search"></i> Find a New Mentor
                </a>
                <a href="/dashboard/user/my-sessions/" class="btn btn-secondary" style="text-align: center; padding: 12px; text-decoration: none; display: block;">
                    <i class="fas fa-calendar"></i> Go to My Sessions
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal Container (hidden by default) -->
<div id="bookingModalContainer" style="position: fixed; width: 0; height: 0; overflow: hidden; z-index: -1;"></div>

<style>
/* Override dashboard.css modal styles for mentor selection modal */
.mentor-select-modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
    display: none !important; /* Start hidden, will be set to flex by JS */
    align-items: center !important;
    justify-content: center !important;
    z-index: 10000 !important; /* Higher z-index to ensure it's on top */
    opacity: 1 !important; /* Override dashboard.css opacity */
    visibility: visible !important; /* Override dashboard.css visibility */
    transition: opacity 0.3s ease !important;
}

.mentor-select-modal-overlay.active,
.mentor-select-modal-overlay[style*="display: flex"] {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    width: 90%;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: #111827;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: #6b7280;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
}

.modal-close:hover {
    color: #111827;
}

.modal-body {
    padding: 24px;
}

.mentor-select-item {
    transition: all 0.2s ease;
}

.mentor-select-item:hover {
    background-color: #f9fafb;
    border-color: #3b82f6;
    transform: translateX(4px);
}

.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover {
    background: #e5e7eb;
}
</style>

<!-- Deactivate Task Confirmation Modal -->
<div id="deactivateTaskModalOverlay" class="session-detail-modal-overlay" aria-hidden="true" style="display: none;">
    <div class="session-detail-modal-backdrop" data-deactivate-task-close></div>
    <div class="session-detail-modal" role="dialog" aria-modal="true" aria-labelledby="deactivateTaskModalTitle" style="max-width: 420px;">
        <header class="session-detail-modal-header">
            <h2 id="deactivateTaskModalTitle" class="session-detail-modal-title">Deactivate Task</h2>
            <button type="button" class="session-detail-modal-close" data-deactivate-task-close aria-label="Close">&times;</button>
        </header>
        <div class="session-detail-modal-body">
            <p id="deactivateTaskModalMessage" style="margin: 0 0 1.25rem; color: var(--dash-text, #334155);">
                Are you sure you want to deactivate this task? It will be removed from your active backlog but remain in the project stage.
            </p>
            <div id="deactivateTaskModalError" style="display: none; color: var(--dash-error, #dc2626); margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn btn-outline" data-deactivate-task-close>Cancel</button>
                <button type="button" id="deactivateTaskConfirmBtn" class="btn btn-primary" style="background: #ef4444; border-color: #ef4444;">Deactivate</button>
            </div>
        </div>
    </div>
</div>

<style>
/* Deactivate Task Modal Styles */
.session-detail-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(8px);
}

.session-detail-modal-backdrop {
    position: absolute;
    inset: 0;
}

.session-detail-modal {
    position: relative;
    width: 80vw;
    max-width: 420px;
    max-height: 90vh;
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.session-detail-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.session-detail-modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 800;
    color: #0f172a;
}

.session-detail-modal-close {
    border-radius: 50%;
    border: none;
    background: #f1f5f9;
    cursor: pointer;
    width: 40px;
    height: 40px;
    color: #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.session-detail-modal-close:hover {
    background: #fee2e2;
    color: #ef4444;
    transform: rotate(90deg);
}

.session-detail-modal-body {
    padding: 32px;
    overflow-y: auto;
    flex: 1;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    text-decoration: none;
    white-space: nowrap;
}

.btn-outline {
    background: transparent;
    border: 1px solid #e2e8f0;
    color: #64748b;
}

.btn-outline:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #334155;
}

.btn-primary {
    background: var(--dash-primary, #10b981);
    color: white;
}

.btn-primary:hover {
    background: var(--dash-primary-hover, #059669);
}
</style>

{% include 'dashboard_user/popups/create_active_backlog_task_modal.html' %}
{% include 'dashboard_user/popups/wallet_topup_modal.html' %}
{% include 'dashboard_user/popups/payment_confirmation_modal.html' %}
{% include 'dashboard_user/popups/accept_invitation_modal.html' %}

<script src="https://js.stripe.com/v3/"></script>
<script>
// Initialize deactivate task modal event listeners (dashboard)
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('deactivateTaskModalOverlay');
    const confirmBtn = document.getElementById('deactivateTaskConfirmBtn');
    
    // Close on backdrop click
    if (overlay) {
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay || e.target.classList.contains('session-detail-modal-backdrop')) {
                closeDeactivateDashboardTaskModal();
            }
        });
    }

    // Close on close button click
    document.querySelectorAll('[data-deactivate-task-close]').forEach(el => {
        el.addEventListener('click', closeDeactivateDashboardTaskModal);
    });

    // Confirm button
    if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmDeactivateDashboardTask);
    }

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && overlay && overlay.style.display === 'flex') {
            closeDeactivateDashboardTaskModal();
        }
    });
});

// Accept/Decline invitation modal functionality for invited sessions
(function() {
  var walletBalanceCents = {{ wallet_balance_cents|default:0 }};
  var stripePk = '{{ stripe_publishable_key|default:""|escapejs }}';
  var createAcceptPiUrl = '{% url "general:dashboard_user:create_accept_session_payment_intent" %}';
  var acceptInvitationUrl = '{% url "general:dashboard_user:session_management" %}';
  var declineInvitationUrl = '{% url "general:dashboard_user:session_management" %}';
  var acceptModalOverlay = null;
  var acceptFormRef = null;
  var acceptPriceCents = 0;
  var acceptInvitationId = null;
  var acceptStripeInstance = null;
  var acceptCardNumber = null;
  var acceptCardExpiry = null;
  var acceptCardCvc = null;
  var acceptSelectedMethod = 'card';

  function getCsrfToken() {
    var input = document.querySelector('[name=csrfmiddlewaretoken]');
    if (input) return input.value;
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
      var c = cookies[i].trim();
      if (c.indexOf('csrftoken=') === 0) return decodeURIComponent(c.substring('csrftoken='.length));
    }
    return '';
  }

  function openAcceptInvitationModal(invitationId, sessionPriceDollars, sessionDetails) {
    acceptInvitationId = invitationId;
    acceptPriceCents = Math.round(parseFloat(sessionPriceDollars) * 100) || 0;
    acceptModalOverlay = document.getElementById('acceptInvitationModalOverlay');
    var freeSection = document.getElementById('acceptInvitationFreeSection');
    var paidSection = document.getElementById('acceptInvitationPaidSection');
    if (!acceptModalOverlay) return;
    
    // Populate session details if provided (for both free and paid sections)
    if (sessionDetails) {
      // Paid section elements
      var mentorNameEl = document.getElementById('acceptInvitationMentorName');
      var mentorLinkEl = document.getElementById('acceptInvitationMentorLink');
      var sessionDateEl = document.getElementById('acceptInvitationSessionDate');
      var sessionTimeEl = document.getElementById('acceptInvitationSessionTime');
      
      // Free section elements
      var mentorNameElFree = document.getElementById('acceptInvitationMentorNameFree');
      var mentorLinkElFree = document.getElementById('acceptInvitationMentorLinkFree');
      var sessionDateElFree = document.getElementById('acceptInvitationSessionDateFree');
      var sessionTimeElFree = document.getElementById('acceptInvitationSessionTimeFree');
      
      function populateDetails(mentorNameEl, mentorLinkEl, sessionDateEl, sessionTimeEl) {
        if (mentorNameEl) {
          if (sessionDetails.mentorName && sessionDetails.mentorName !== '' && sessionDetails.mentorName.trim() !== '') {
            mentorNameEl.textContent = sessionDetails.mentorName;
          } else {
            mentorNameEl.textContent = '';
          }
        }
        if (mentorLinkEl) {
          if (sessionDetails.mentorId && sessionDetails.mentorId !== '' && sessionDetails.mentorId !== 'null') {
            mentorLinkEl.href = '/mentor/' + sessionDetails.mentorId + '/';
          } else {
            mentorLinkEl.href = '#';
            mentorLinkEl.style.pointerEvents = 'none';
            mentorLinkEl.style.opacity = '0.6';
          }
        }
        if (sessionDateEl && sessionDetails.sessionDate) {
          // Format date: YYYY-MM-DD to readable format
          try {
            // Handle different date formats
            var dateStr = sessionDetails.sessionDate;
            var dateObj;
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
              // YYYY-MM-DD format
              dateObj = new Date(dateStr + 'T00:00:00');
            } else {
              // Try parsing as-is
              dateObj = new Date(dateStr);
            }
            if (!isNaN(dateObj.getTime())) {
              var options = { year: 'numeric', month: 'long', day: 'numeric' };
              sessionDateEl.textContent = dateObj.toLocaleDateString('en-US', options);
            } else {
              sessionDateEl.textContent = sessionDetails.sessionDate || '';
            }
          } catch(e) {
            sessionDateEl.textContent = sessionDetails.sessionDate || '';
          }
        } else if (sessionDateEl) {
          sessionDateEl.textContent = '';
        }
        if (sessionTimeEl && sessionDetails.sessionStart && sessionDetails.sessionEnd) {
          sessionTimeEl.textContent = sessionDetails.sessionStart + ' - ' + sessionDetails.sessionEnd;
        } else if (sessionTimeEl) {
          sessionTimeEl.textContent = '';
        }
        // Also handle missing mentor name
        if (mentorNameEl && !sessionDetails.mentorName) {
          mentorNameEl.textContent = '';
        }
      }
      
      populateDetails(mentorNameEl, mentorLinkEl, sessionDateEl, sessionTimeEl);
      populateDetails(mentorNameElFree, mentorLinkElFree, sessionDateElFree, sessionTimeElFree);
    }
    
    // Show/hide footer actions
    var freeActions = document.getElementById('acceptInvitationFreeActions');
    var paidActions = document.getElementById('acceptInvitationPaidActions');
    
    // Update header title
    var headerTitle = document.getElementById('acceptInvitationHeaderTitle');
    if (headerTitle) {
      if (acceptPriceCents <= 0) {
        headerTitle.innerHTML = '<i class="fas fa-check-circle"></i> Accept invitation';
      } else {
        headerTitle.innerHTML = '<i class="fas fa-envelope-open-text"></i> Accept Invitation';
      }
    }
    
    if (acceptPriceCents <= 0) {
      freeSection.style.display = 'block';
      paidSection.style.display = 'none';
      if (freeActions) freeActions.style.display = 'flex';
      if (paidActions) paidActions.style.display = 'none';
      acceptModalOverlay.style.display = 'flex';
      return;
    }
    freeSection.style.display = 'none';
    paidSection.style.display = 'block';
    if (freeActions) freeActions.style.display = 'none';
    if (paidActions) paidActions.style.display = 'flex';
    // Update price display in left column
    var amountTextEl = document.getElementById('acceptInvitationAmountText');
    if (amountTextEl) {
      amountTextEl.textContent = '$' + (acceptPriceCents / 100).toFixed(2);
    }
    // Update pay button amount
    var payAmountEl = document.getElementById('acceptInvitationPayAmount');
    if (payAmountEl) {
      payAmountEl.textContent = '$' + (acceptPriceCents / 100).toFixed(2);
    }
    var walletOption = document.getElementById('acceptPayWithWalletOption');
    var cardOption = document.getElementById('acceptPayWithCardOption');
    var cardSection = document.getElementById('acceptInvitationCardSection');
    var insufficientNote = document.getElementById('acceptInvitationInsufficientNote');
    var walletLabel = document.getElementById('acceptWalletAmountLabel');
    var canWallet = walletBalanceCents >= acceptPriceCents;
    
    // Always show wallet option if user is authenticated
    if (walletOption) {
      walletOption.style.display = 'flex';
      // Always show current wallet balance (similar to booking modal)
      if (walletLabel) {
        const walletBalance = (walletBalanceCents / 100).toFixed(2);
        walletLabel.textContent = ' ($' + walletBalance + ' available)';
      }
    }
    
    // Show insufficient note only when wallet is selected AND funds are insufficient
    if (insufficientNote) {
      insufficientNote.style.display = 'none'; // Hidden by default, shown only when wallet selected and insufficient
    }
    
    // Default to card if insufficient wallet balance, otherwise default to wallet
    if (canWallet) {
      acceptSelectedMethod = 'wallet';
      document.getElementById('acceptPaymentMethodWallet').checked = true;
      document.getElementById('acceptPaymentMethodCard').checked = false;
      cardSection.style.display = 'none';
      unmountAcceptCard();
    } else {
      acceptSelectedMethod = 'card';
      document.getElementById('acceptPaymentMethodCard').checked = true;
      document.getElementById('acceptPaymentMethodWallet').checked = false;
      if (cardSection) {
        cardSection.style.display = 'block';
        if (stripePk && typeof window.Stripe === 'function') mountAcceptCard();
      }
    }
    var payBtn = document.getElementById('acceptInvitationPayBtn');
    if (payBtn) payBtn.disabled = false;
    acceptModalOverlay.style.display = 'flex';
  }

  window.closeAcceptInvitationModal = function() {
    var overlay = document.getElementById('acceptInvitationModalOverlay');
    if (overlay) overlay.style.display = 'none';
    unmountAcceptCard();
    acceptFormRef = null;
  };

  function mountAcceptCard() {
    if (!stripePk || !window.Stripe || acceptCardNumber) return;
    var numEl = document.getElementById('acceptInvitationCardNumberContainer');
    var expEl = document.getElementById('acceptInvitationCardExpiryContainer');
    var cvcEl = document.getElementById('acceptInvitationCardCvcContainer');
    if (!numEl || !expEl || !cvcEl) return;
    try {
      acceptStripeInstance = window.Stripe(stripePk);
      var elements = acceptStripeInstance.elements();
      var style = { style: { base: { fontSize: '16px' } } };
      acceptCardNumber = elements.create('cardNumber', style);
      acceptCardExpiry = elements.create('cardExpiry', style);
      acceptCardCvc = elements.create('cardCvc', style);
      acceptCardNumber.mount('#acceptInvitationCardNumberContainer');
      acceptCardExpiry.mount('#acceptInvitationCardExpiryContainer');
      acceptCardCvc.mount('#acceptInvitationCardCvcContainer');
      var errEl = document.getElementById('acceptInvitationCardError');
      var errText = document.getElementById('acceptInvitationCardErrorText');
      function onChange(e) {
        if (errEl && errText) {
          errText.textContent = e.error ? (e.error.message || '') : '';
          errEl.style.display = e.error ? 'flex' : 'none';
        }
      }
      acceptCardNumber.on('change', onChange);
      acceptCardExpiry.on('change', onChange);
      acceptCardCvc.on('change', onChange);
    } catch (e) { console.error('Accept modal Stripe mount error', e); }
  }

  function unmountAcceptCard() {
    if (acceptCardNumber) { try { acceptCardNumber.unmount(); } catch (x) {} acceptCardNumber = null; }
    if (acceptCardExpiry) { try { acceptCardExpiry.unmount(); } catch (x) {} acceptCardExpiry = null; }
    if (acceptCardCvc) { try { acceptCardCvc.unmount(); } catch (x) {} acceptCardCvc = null; }
  }

  function submitAcceptInvitation(extraData) {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = acceptInvitationUrl;
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCsrfToken();
    form.appendChild(csrfInput);
    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'confirm_invitation';
    form.appendChild(actionInput);
    var invIdInput = document.createElement('input');
    invIdInput.type = 'hidden';
    invIdInput.name = 'invitation_id';
    invIdInput.value = acceptInvitationId;
    form.appendChild(invIdInput);
    if (extraData) {
      for (var k in extraData) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = extraData[k];
        form.appendChild(input);
      }
    }
    document.body.appendChild(form);
    form.submit();
  }

  function submitDeclineInvitation() {
    // Use fetch to submit decline, then reload current page instead of redirecting
    var formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('action', 'decline_invitation');
    formData.append('invitation_id', acceptInvitationId);
    
    fetch('{% url "general:dashboard_user:session_management" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': getCsrfToken()
      }
    }).then(function(response) {
      if (response.ok) {
        // Reload current page instead of redirecting
        window.location.reload();
      } else {
        // If error, still reload to show any error messages
        window.location.reload();
      }
    }).catch(function(error) {
      console.error('Error declining invitation:', error);
      // Reload anyway
      window.location.reload();
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    acceptModalOverlay = document.getElementById('acceptInvitationModalOverlay');
    if (acceptModalOverlay) {
      acceptModalOverlay.addEventListener('click', function(e) {
        if (e.target === acceptModalOverlay) closeAcceptInvitationModal();
      });
      
      // Close modal on Escape key (only if wallet topup modal is not open)
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // Check if wallet topup modal is open first (it has higher z-index)
          var walletOverlay = document.getElementById('walletTopUpModalOverlay');
          if (walletOverlay && walletOverlay.style.display === 'flex') {
            // Wallet topup modal will handle its own Escape key, don't close Accept Invitation
            return;
          }
          // Only close Accept Invitation if it's open and wallet topup is not
          if (acceptModalOverlay && acceptModalOverlay.style.display === 'flex') {
            closeAcceptInvitationModal();
          }
        }
      });
    }

    // Handle clicks on invited sessions
    var container = document.getElementById('dashboardUpcomingSessions');
    if (container) {
      container.addEventListener('click', function(e) {
        var row = e.target.closest('.session-item[data-clickable-session]');
        if (!row) return;
        // Don't trigger if clicking on dropdown menu
        if (e.target.closest('.session-right')) return;
        // Check status from class list
        var isInvited = row.classList.contains('status-invited');
        var isConfirmed = row.classList.contains('status-confirmed');
        
        if (isInvited) {
          e.preventDefault();
          e.stopPropagation();
          var invitationId = row.getAttribute('data-invitation-id');
          var sessionPrice = row.getAttribute('data-session-price') || '0';
          var mentorId = row.getAttribute('data-mentor-id');
          var mentorName = row.getAttribute('data-mentor-name');
          var sessionDate = row.getAttribute('data-session-date');
          var sessionStart = row.getAttribute('data-session-start');
          var sessionEnd = row.getAttribute('data-session-end');
          if (invitationId) {
            openAcceptInvitationModal(invitationId, sessionPrice, {
              mentorId: mentorId,
              mentorName: mentorName,
              sessionDate: sessionDate,
              sessionStart: sessionStart,
              sessionEnd: sessionEnd
            });
          }
        } else if (isConfirmed) {
          // Only open detail modal for confirmed sessions
          var sessionId = row.getAttribute('data-session-id');
          if (sessionId && typeof openSessionDetailModal === 'function') {
            openSessionDetailModal(parseInt(sessionId, 10));
          }
        }
        // For any other status, do nothing
      });
    }

    // Modal button handlers
    var confirmFreeBtn = document.getElementById('acceptInvitationConfirmFreeBtn');
    if (confirmFreeBtn) {
      confirmFreeBtn.addEventListener('click', function() {
        submitAcceptInvitation(null);
        closeAcceptInvitationModal();
        setTimeout(function() {
          window.location.reload();
        }, 500);
      });
    }

    var originalSectionType = null; // 'free' or 'paid'

    function showDeclineConfirmation() {
      var freeSection = document.getElementById('acceptInvitationFreeSection');
      var paidSection = document.getElementById('acceptInvitationPaidSection');
      var declineSection = document.getElementById('acceptInvitationDeclineSection');
      var freeActions = document.getElementById('acceptInvitationFreeActions');
      var paidActions = document.getElementById('acceptInvitationPaidActions');
      var declineActions = document.getElementById('acceptInvitationDeclineActions');
      
      // Store which section was originally shown
      if (freeSection && freeSection.style.display !== 'none') {
        originalSectionType = 'free';
      } else if (paidSection && paidSection.style.display !== 'none') {
        originalSectionType = 'paid';
      }
      
      if (freeSection) freeSection.style.display = 'none';
      if (paidSection) paidSection.style.display = 'none';
      if (declineSection) declineSection.style.display = 'block';
      if (freeActions) freeActions.style.display = 'none';
      if (paidActions) paidActions.style.display = 'none';
      if (declineActions) declineActions.style.display = 'flex';
    }

    function hideDeclineConfirmation() {
      var freeSection = document.getElementById('acceptInvitationFreeSection');
      var paidSection = document.getElementById('acceptInvitationPaidSection');
      var declineSection = document.getElementById('acceptInvitationDeclineSection');
      var freeActions = document.getElementById('acceptInvitationFreeActions');
      var paidActions = document.getElementById('acceptInvitationPaidActions');
      var declineActions = document.getElementById('acceptInvitationDeclineActions');
      
      if (declineSection) declineSection.style.display = 'none';
      if (declineActions) declineActions.style.display = 'none';
      
      // Restore the original section
      if (originalSectionType === 'free') {
        if (freeSection) freeSection.style.display = 'block';
        if (paidSection) paidSection.style.display = 'none';
        if (freeActions) freeActions.style.display = 'flex';
        if (paidActions) paidActions.style.display = 'none';
      } else if (originalSectionType === 'paid') {
        if (freeSection) freeSection.style.display = 'none';
        if (paidSection) paidSection.style.display = 'block';
        if (freeActions) freeActions.style.display = 'none';
        if (paidActions) paidActions.style.display = 'flex';
      }
      originalSectionType = null;
    }

    var declineBtn = document.getElementById('acceptInvitationDeclineBtn');
    if (declineBtn) {
      declineBtn.addEventListener('click', function() {
        showDeclineConfirmation();
      });
    }

    var declineBtnPaid = document.getElementById('acceptInvitationDeclineBtnPaid');
    if (declineBtnPaid) {
      declineBtnPaid.addEventListener('click', function() {
        showDeclineConfirmation();
      });
    }

    var declineCancelBtn = document.getElementById('acceptInvitationDeclineCancelBtn');
    if (declineCancelBtn) {
      declineCancelBtn.addEventListener('click', function() {
        hideDeclineConfirmation();
      });
    }

    var declineConfirmBtn = document.getElementById('acceptInvitationDeclineConfirmBtn');
    if (declineConfirmBtn) {
      declineConfirmBtn.addEventListener('click', function() {
        closeAcceptInvitationModal();
        submitDeclineInvitation();
        // submitDeclineInvitation will reload the current page
      });
    }

    var payBtn = document.getElementById('acceptInvitationPayBtn');
    if (payBtn) {
      payBtn.addEventListener('click', function() {
        if (acceptSelectedMethod === 'wallet') {
          // Check if wallet has sufficient balance
          var canWallet = walletBalanceCents >= acceptPriceCents;
          if (!canWallet) {
            // Show toast notification
            if (typeof showNotification !== 'undefined') {
              showNotification('Insufficient wallet balance. Please top up your wallet or pay with card.', 'error');
            } else {
              alert('Insufficient wallet balance. Please top up your wallet or pay with card.');
            }
            
            // Show and highlight the insufficient balance message
            var insufficientNote = document.getElementById('acceptInvitationInsufficientNote');
            if (insufficientNote) {
              insufficientNote.style.display = 'block';
              // Blinking animation
              var blinkCount = 0;
              var blinkInterval = setInterval(function() {
                insufficientNote.style.backgroundColor = blinkCount % 2 === 0 ? '#fef2f2' : '#fee2e2';
                blinkCount++;
                if (blinkCount >= 6) {
                  clearInterval(blinkInterval);
                  insufficientNote.style.backgroundColor = '';
                }
              }, 200);
            }
            return; // Don't close modal or submit
          }
          submitAcceptInvitation({ use_wallet: '1' });
          closeAcceptInvitationModal();
          return;
        }
        payBtn.disabled = true;
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        var errEl = document.getElementById('acceptInvitationCardError');
        var errText = document.getElementById('acceptInvitationCardErrorText');
        if (errText) errText.textContent = '';
        if (errEl) errEl.style.display = 'none';
        fetch(createAcceptPiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
          body: JSON.stringify({ invitation_id: acceptInvitationId, attempt_id: (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : 'a' + Date.now() })
        }).then(function(r) { return r.json(); }).then(function(data) {
          if (!data.success || !data.client_secret) {
            if (errText) errText.textContent = data.error || 'Could not start payment.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
            return;
          }
          if (!acceptStripeInstance || !acceptCardNumber) {
            if (errText) errText.textContent = 'Card form not ready.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
            return;
          }
          acceptStripeInstance.confirmCardPayment(data.client_secret, {
            payment_method: { card: acceptCardNumber }
          }).then(function(result) {
            if (result.error) {
              if (errText) errText.textContent = result.error.message || 'Payment failed.';
              if (errEl) errEl.style.display = 'flex';
              payBtn.disabled = false;
              payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
              return;
            }
            if (result.paymentIntent && result.paymentIntent.status === 'succeeded') {
              closeAcceptInvitationModal();
              submitAcceptInvitation({ payment_intent_id: result.paymentIntent.id });
              if (typeof showPaymentConfirmationModal === 'function') {
                showPaymentConfirmationModal('Session paid successfully. Your invitation has been accepted.');
              }
              // Reload page after successful payment
              setTimeout(function() {
                window.location.reload();
              }, 1500);
            }
          }).catch(function() {
            if (errText) errText.textContent = 'Payment could not be completed.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
          });
        }).catch(function() {
          if (errText) errText.textContent = 'Could not start payment. Try again.';
          if (errEl) errEl.style.display = 'flex';
          payBtn.disabled = false;
          payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
        });
      });
    }

    document.querySelectorAll('input[name="accept_payment_method"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        acceptSelectedMethod = this.value;
        var cardSection = document.getElementById('acceptInvitationCardSection');
        var insufficientNote = document.getElementById('acceptInvitationInsufficientNote');
        var canWallet = walletBalanceCents >= acceptPriceCents;
        
        if (acceptSelectedMethod === 'wallet') {
          cardSection.style.display = 'none';
          unmountAcceptCard();
          // Show insufficient note only if wallet is selected AND insufficient
          if (insufficientNote) {
            insufficientNote.style.display = canWallet ? 'none' : 'block';
          }
        } else {
          cardSection.style.display = 'block';
          if (insufficientNote) insufficientNote.style.display = 'none';
          if (stripePk && typeof window.Stripe === 'function') mountAcceptCard();
        }
      });
    });
  });
})();
</script>
{% endblock %}
