{% extends "dashboard_mentor/base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_title %}{{ project.title }} | Roadmap{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
<style>
    /* Layout Grid */
    .roadmap-container {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 32px;
        align-items: start;
        margin-bottom: 120px; /* Extra space for dropdown menus */
    }
    
    @media (max-width: 1024px) {
        .roadmap-container {
            grid-template-columns: 1fr;
        }
    }

    .nav-btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    .nav-btn-back:hover { color: #1e293b; }

    /* Primary Content Area */
    .roadmap-list-section {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: visible; /* Changed from hidden to allow dropdowns to show */
    }

    .roadmap-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }

    .roadmap-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .roadmap-header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    /* List Items (High Density) */
    .stage-row {
        display: flex;
        align-items: stretch;
        gap: 0;
        padding: 0;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.15s ease;
        position: relative;
        background: white;
    }

    .stage-row:last-child {
        border-bottom: none;
    }

    .stage-row:hover {
        background: #f8fafc;
    }
    
    /* Drag Grip Section */
    .stage-drag-section {
        padding: 16px 0px 16px 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        cursor: grab;
    }
    
    .stage-row:hover .stage-drag-section .drag-grip {
        opacity: 0.5;
        color: #94a3b8;
    }
    
    .stage-drag-section:active {
        cursor: grabbing;
    }

    /* Drag Handle */
    .drag-grip {
        cursor: grab;
        color: #e5e7eb;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        opacity: 0; /* Hidden by default for clean look */
        user-select: none;
        -webkit-user-select: none;
    }
    .drag-grip:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    .drag-grip:active {
        cursor: grabbing;
    }
    
    /* Stage Main Wrapper (clickable area for stage detail) */
    .stage-main-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        cursor: pointer;
        transition: background 0.15s ease;
        min-width: 0; /* Allows text truncation */
    }
    
    .stage-main-wrapper:hover {
        background: rgba(248, 250, 252, 0.5);
    }
    
    /* Row Actions Section */
    .row-actions-section {
        padding: 16px 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .stage-row:hover .row-actions-section .row-actions,
    .stage-row .row-actions-section .row-actions.has-active-dropdown {
        opacity: 1;
    }
    
    /* Sortable styles */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6;
    }
    
    .sortable-drag {
        opacity: 0.8;
    }

    /* Stage Info */
    .stage-main {
        flex: 1;
        min-width: 0; /* Allows text truncation */
    }

    .stage-title-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stage-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stage-meta {
        font-size: 0.8rem;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Stage Progress Section */
    .stage-progress-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 180px;
        flex-shrink: 0;
    }

    .stage-progress-bar-container {
        width: 100%;
        max-width: 200px;
    }

    .stage-progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .stage-progress-bar {
        height: 6px;
        background: #f3f4f6;
        border-radius: 3px;
        overflow: hidden;
    }

    .stage-progress-fill {
        height: 100%;
        transition: width 0.3s;
    }

    .stage-tasks-count {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: #6b7280;
    }

    .stage-tasks-count i {
        font-size: 0.85rem;
        color: #9ca3af;
    }

    .stage-tasks-count.no-tasks {
        color: #93c5fd; /* Light blue */
    }

    .stage-tasks-count.no-tasks i {
        color: #93c5fd; /* Light blue */
    }

    /* Status Indicators */
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }
    .status-dot.completed { background-color: #10b981; box-shadow: 0 0 0 2px #d1fae5; }
    .status-dot.pending { background-color: #fbbf24; }
    .status-dot.draft { background-color: #9ca3af; border: 1px dashed #6b7280; background: transparent; }

    /* Actions */
    .row-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
        position: relative;
        flex-shrink: 0;
    }
    
    /* Keep row actions visible when dropdown is active */
    .stage-row .row-actions.has-active-dropdown,
    .stage-row:hover .row-actions {
        opacity: 1;
    }
    
    .action-icon-btn {
        padding: 6px;
        border-radius: 6px;
        color: #64748b;
        border: none;
        background: transparent;
        cursor: pointer;
    }
    .action-icon-btn:hover {
        background: #f1f5f9;
        color: #1f2937;
    }
    .action-icon-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Stage Dropdown Menu */
    .stage-dropdown-container {
        position: relative;
        z-index: 10; /* Ensure dropdown container is above other elements */
    }

    .stage-dropdown-trigger {
        padding: 0;
        width: 32px; /* Slightly bigger */
        height: 32px;
        border-radius: 50%; /* Make it circular */
        color: #64748b;
        border: none;
        background: transparent;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .stage-dropdown-trigger i {
        font-size: 1rem; /* Slightly bigger icon */
    }

    .stage-dropdown-trigger:hover {
        background: #f1f5f9;
        color: #1f2937;
    }

    .stage-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        bottom: auto;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        min-width: 180px;
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
    }

    .stage-dropdown-menu.dropdown-up {
        top: auto;
        bottom: calc(100% + 8px);
        transform: translateY(10px);
    }

    .stage-dropdown-container.active .stage-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .stage-dropdown-container.active .stage-dropdown-menu.dropdown-up {
        transform: translateY(0);
    }

    .stage-dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #1e293b;
        text-decoration: none;
        transition: background 0.2s ease;
        border: none;
        background: transparent;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
    }

    .stage-dropdown-item.first-item {
        border-radius: 12px 12px 0 0;
    }

    .stage-dropdown-item.last-item {
        border-radius: 0 0 12px 12px;
    }

    .stage-dropdown-item:hover {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .stage-dropdown-item.first-item:hover {
        border-radius: 12px 12px 0 0;
    }

    .stage-dropdown-item.last-item:hover {
        border-radius: 0 0 12px 12px;
    }

    .stage-dropdown-item i {
        width: 20px;
        text-align: center;
        color: #94a3b8;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .stage-dropdown-item:hover i {
        color: #10b981;
    }

    .stage-dropdown-item.delete-item:hover {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .stage-dropdown-item.delete-item:hover i {
        color: #ef4444;
    }

    /* Sidebar */
    .project-sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .project-meta-card {
        background: #1e293b;
        color: white;
        border-radius: 12px;
        padding: 24px;
        position: relative;
        overflow: hidden;
    }
    
    .meta-bg-icon {
        position: absolute;
        bottom: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.05;
        transform: rotate(-15deg);
    }

    .project-title-lg {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .project-owner-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
    }

    /* Stats Grid */
    .mini-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .stat-box {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .stat-val { font-size: 1.25rem; font-weight: 700; color: #111827; }
    .stat-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Floating Action Button (Optional usage) */
    .fab-create {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.875rem;
        height: 40px;
        white-space: nowrap;
        transition: background 0.2s;
    }
    .fab-create:hover { background: #2563eb; }

    /* AI Button styling is now global in dashboard.css */
</style>
{% endblock %}

{% block dashboard_content %}
{% include 'general/modals/create_stage_modal.html' %}
{% include 'dashboard_user/projects/modals/manage_modules_modal.html' %}

<div class="dashboard-content-container" style="max-width: 1200px; margin: 0 auto;">
    
        <!-- Top Nav -->
        <div style="margin-bottom: 24px;">
            <div style="display: flex; align-items: center;">
                <a href="{% url 'general:dashboard_mentor:projects_list' %}" class="nav-btn-back">
                    Projects
                </a>
                <span style="margin: 0 8px; color: #cbd5e1;">/</span>
                <span style="color: #1e293b; font-weight: 600;">{{ project.title }}</span>
            </div>
        </div>

    <div class="roadmap-container">
        <!-- Main List -->
        <main>
            <!-- Project Name, Description, and Progress -->
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px; display: grid; grid-template-columns: 1fr auto; gap: 24px; align-items: center;">
                <!-- Project Info -->
                <div>
                    <h1 style="font-size: 1.75rem; font-weight: 700; color: #111827; margin: 0 0 12px 0;">{{ project.title }}</h1>
                    {% if project.description %}
                        <p style="font-size: 0.95rem; color: #64748b; line-height: 1.6; margin: 0;">{{ project.description }}</p>
                    {% else %}
                        <p style="font-size: 0.95rem; color: #9ca3af; font-style: italic; margin: 0;">No description provided</p>
                    {% endif %}
                </div>
                
                <!-- Project Completion Circle -->
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <div class="profile-completion-circle" style="position: relative; width: 100px; height: 100px;">
                        <svg width="100" height="100" viewBox="0 0 120 120" style="transform: scale(0.83);">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="projectProgressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#10b981"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: #111827; font-size: 1.1rem;">
                            <span id="projectCompletionText">0%</span>
                        </div>
                    </div>
                    <p style="margin: 8px 0 0; font-size: 0.8rem; color: #6b7280; text-align: center;">
                        Completed
                    </p>
                </div>
            </div>
            {% if not project.questionnaire_completed %}
                <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1rem; color: #92400e;">Setup Required</h3>
                    <p style="margin: 0 0 16px 0; color: #b45309; font-size: 0.875rem;">Project details missing. Complete the questionnaire to unlock stage management.</p>
                    {% include "mentoring/partials/questionnaire_form.html" with questions=questions answers=answers %}
                </div>
            {% endif %}

            <!-- Waterfall Chart -->
            <div id="waterfallChartContainer" style="display: none; background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0 0 20px 0;">
                    <i class="fas fa-chart-line" style="color: #10b981; margin-right: 8px;"></i>
                    Project Timeline
                </h3>
                <div id="waterfallChart" style="min-height: 200px; position: relative;">
                    <!-- Chart will be rendered here by JavaScript -->
                </div>
            </div>

            <div class="roadmap-list-section">
                <div class="roadmap-header">
                    <h2>
                        <i class="fas fa-layer-group" style="color: #9ca3af; font-size: 1rem;"></i>
                        Roadmap Stages
                        <span id="stagesCount" style="font-size: 0.8rem; color: #6b7280; font-weight: 500; margin-left: 8px;">
                            0 Stages
                        </span>
                    </h2>
                    <div class="roadmap-header-actions">
                        <button onclick="generateStagesAI()" id="generateStagesBtn" class="btn-ai-magic" title="Auto-Generate Stages with AI">
                            <i class="fas fa-wand-magic-sparkles"></i> AI Generate
                        </button>
                        <button onclick="openCreateStageModal()" class="fab-create">
                            <i class="fas fa-plus"></i> New Stage
                        </button>
                    </div>
                </div>
                
                <div id="stagesList">
                    <div style="padding: 48px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>Loading stages...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Info -->
        <aside class="project-sidebar">
            <div class="project-meta-card">
                <div style="position: relative; z-index: 2;">
                    <!-- Owner Section -->
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 8px;">Owner</div>
                        <div class="project-owner-row">
                            {% if project.project_owner %}
                                <div class="owner-avatar">
                                    {{ project.project_owner.first_name|make_list|first|default:"U" }}
                                </div>
                                <div>
                                    <a href="{% url 'general:dashboard_mentor:client_detail' project.project_owner.id %}" style="text-decoration: none; color: inherit;">
                                        <div style="font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                                            {{ project.project_owner.first_name }} {{ project.project_owner.last_name }}
                                        </div>
                                    </a>
                                    <div style="font-size: 0.8rem; opacity: 0.7;">Client</div>
                                </div>
                            {% else %}
                                <div style="color: #fca5a5; font-size: 0.9rem;">
                                    <i class="fas fa-exclamation-triangle"></i> Unassigned
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Modules Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7;">Modules</div>
                            <button onclick="openManageModulesModal()" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                <i class="fas fa-cog" style="margin-right: 4px;"></i> Manage
                            </button>
                        </div>
                        {% if active_modules %}
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            {% for module_instance in active_modules %}
                                <a href="{% url 'general:dashboard_user:module_detail' project.id module_instance.id %}" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 6px; text-decoration: none; color: white; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                    {% if module_instance.module.icon %}
                                        <i class="{{ module_instance.module.icon }}" style="font-size: 0.9rem;"></i>
                                    {% endif %}
                                    <span style="font-size: 0.85rem; font-weight: 500;">{{ module_instance.module.name }}</span>
                                </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem; font-style: italic; padding: 8px 0;">
                            No modules added yet
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mini-stats">
                <div class="stat-box">
                    <div class="stat-val">{{ active_modules.count|default:"0" }}</div>
                    <div class="stat-label">Modules</div>
                </div>
                <!-- Add more stats here like Days Remaining or Completion % -->
                 <div class="stat-box">
                    <div class="stat-val" style="color: #10b981;">Active</div>
                    <div class="stat-label">Status</div>
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    console.log('Stages script block loaded');
    const PROJECT_ID = parseInt('{{ project.id }}');
    const STAGE_DETAIL_URL = '{% url "general:dashboard_mentor:stage_detail" project.id 0 %}'.replace('/0/', '/');
    let sortableInstance = null;
    
    console.log('PROJECT_ID:', PROJECT_ID);
    console.log('STAGE_DETAIL_URL:', STAGE_DETAIL_URL);
    
    // Render waterfall chart
    function renderWaterfallChart(stages) {
        const container = document.getElementById('waterfallChartContainer');
        const chartEl = document.getElementById('waterfallChart');
        
        // Store reference for drag handlers
        window.waterfallChartEl = chartEl;
        
        if (!container || !chartEl) return;
        
        if (!stages || stages.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        // Filter stages with dates
        const stagesWithDates = stages.filter(s => s.start_date && s.end_date);
        
        if (stagesWithDates.length === 0) {
            chartEl.innerHTML = `
                <div style="text-align: center; padding: 32px; color: #9ca3af;">
                    <i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 8px; opacity: 0.3;"></i>
                    <p style="margin: 0; font-size: 0.875rem;">Add start and end dates to stages to view timeline</p>
                </div>
            `;
            return;
        }
        
        // Calculate date range
        const dates = stagesWithDates.flatMap(s => [new Date(s.start_date), new Date(s.end_date)]);
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
        const totalMonths = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30));
        const totalYears = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 365));
        
        // Determine time unit and interval
        let timeUnit, interval, unitLabel;
        if (totalYears >= 2) {
            timeUnit = 'year';
            interval = Math.max(1, Math.floor(totalYears / 10));
            unitLabel = 'Years';
        } else if (totalMonths >= 2) {
            timeUnit = 'month';
            interval = Math.max(1, Math.floor(totalMonths / 10));
            unitLabel = 'Months';
        } else {
            timeUnit = 'day';
            interval = Math.max(1, Math.floor(totalDays / 10));
            unitLabel = 'Days';
        }
        
        // Generate axis labels
        const axisLabels = [];
        const numLabels = 6; // Show 6 labels on the axis
        for (let i = 0; i <= numLabels; i++) {
            const progress = i / numLabels;
            let labelDate = new Date(minDate.getTime() + (maxDate - minDate) * progress);
            let labelText;
            
            if (timeUnit === 'year') {
                labelText = labelDate.getFullYear().toString();
            } else if (timeUnit === 'month') {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            } else {
                labelText = labelDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            axisLabels.push({
                position: progress * 100,
                label: labelText
            });
        }
        
        const chartHeight = 80 + (stagesWithDates.length * 50);
        chartEl.style.height = chartHeight + 'px';
        
        let chartHtml = `
            <div class="waterfall-chart-inner" style="position: relative; height: ${chartHeight}px; padding: 20px 0 60px 0;">
                <!-- Timeline axis -->
                <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; border-top: 2px solid #e5e7eb;">
                    ${axisLabels.map(label => `
                        <div style="position: absolute; left: ${label.position}%; transform: translateX(-50%); top: 8px;">
                            <div style="width: 2px; height: 8px; background: #9ca3af; margin: 0 auto;"></div>
                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px; white-space: nowrap;">${label.label}</div>
                        </div>
                    `).join('')}
                    <div style="position: absolute; top: -20px; left: 0; font-size: 0.7rem; color: #9ca3af; font-weight: 500;">${unitLabel}</div>
                </div>
        `;
        
        stagesWithDates.forEach((stage, index) => {
            const startDate = new Date(stage.start_date);
            const endDate = new Date(stage.end_date);
            const daysFromStart = Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const leftPercent = (daysFromStart / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            const top = 20 + (index * 50);
            const color = stage.is_completed ? '#10b981' : '#3b82f6';
            
            chartHtml += `
                <div 
                    class="waterfall-stage-bar" 
                    data-stage-id="${stage.id}"
                    data-start-date="${stage.start_date}"
                    data-end-date="${stage.end_date}"
                    style="position: absolute; top: ${top}px; left: ${leftPercent}%; width: ${widthPercent}%; height: 30px; background: ${color}; border-radius: 4px; display: flex; align-items: center; padding: 0 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move;" 
                    title="${stage.title}"
                >
                    <div class="waterfall-resize-handle waterfall-resize-left" style="position: absolute; left: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); border-radius: 4px 0 0 4px;"></div>
                    <span style="font-size: 0.75rem; color: white; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; text-align: center; pointer-events: none;">${stage.title}</span>
                    <div class="waterfall-resize-handle waterfall-resize-right" style="position: absolute; right: 0; top: 0; bottom: 0; width: 8px; cursor: ew-resize; background: rgba(255,255,255,0.3); border-radius: 0 4px 4px 0;"></div>
                </div>
            `;
        });
        
        chartHtml += '</div>';
        chartEl.innerHTML = chartHtml;
        
        // Initialize drag handlers for waterfall bars
        // Pass all stages (not just those with dates) for reordering
        initWaterfallDragHandlers(stages, minDate, maxDate, totalDays);
    }
    
    // Initialize drag handlers for waterfall chart bars
    function initWaterfallDragHandlers(stages, minDate, maxDate, totalDays) {
        const chartEl = window.waterfallChartEl;
        if (!chartEl) return;
        
        const bars = chartEl.querySelectorAll('.waterfall-stage-bar');
        let isDragging = false;
        let dragType = null; // 'move', 'resize-left', 'resize-right', 'reorder'
        let currentBar = null;
        let startX = 0;
        let startY = 0;
        let startLeft = 0;
        let startTop = 0;
        let startWidth = 0;
        let startDate = null;
        let endDate = null;
        let startIndex = 0;
        let handleMouseMove = null;
        let handleMouseUp = null;
        let dragThreshold = 5; // pixels to move before determining drag direction
        
        bars.forEach((bar, index) => {
            const resizeLeft = bar.querySelector('.waterfall-resize-left');
            const resizeRight = bar.querySelector('.waterfall-resize-right');
            
            // Move entire bar (can be horizontal or vertical)
            bar.addEventListener('mousedown', function(e) {
                if (e.target === resizeLeft || e.target === resizeRight) return;
                isDragging = true;
                dragType = null; // Will be determined after threshold
                currentBar = bar;
                startX = e.clientX;
                startY = e.clientY;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startTop = rect.top - chartRect.top;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                startIndex = index;
                bar.style.cursor = 'grabbing';
                bar.style.zIndex = '1000';
                bar.style.opacity = '0.7';
                e.preventDefault();
            });
            
            // Resize left edge
            resizeLeft.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragType = 'resize-left';
                currentBar = bar;
                startX = e.clientX;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                e.stopPropagation();
                e.preventDefault();
            });
            
            // Resize right edge
            resizeRight.addEventListener('mousedown', function(e) {
                isDragging = true;
                dragType = 'resize-right';
                currentBar = bar;
                startX = e.clientX;
                const rect = bar.getBoundingClientRect();
                const chartRect = chartEl.getBoundingClientRect();
                startLeft = ((rect.left - chartRect.left) / chartRect.width) * 100;
                startWidth = (rect.width / chartRect.width) * 100;
                startDate = new Date(bar.dataset.startDate);
                endDate = new Date(bar.dataset.endDate);
                e.stopPropagation();
                e.preventDefault();
            });
        });
        
        // Create or update date popover
        let datePopover = null;
        function showDatePopover(x, y, dateStr, label) {
            if (!datePopover) {
                datePopover = document.createElement('div');
                datePopover.id = 'waterfallDatePopover';
                datePopover.style.cssText = 'position: fixed; background: #1e293b; color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; z-index: 10001; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); white-space: nowrap; display: none;';
                document.body.appendChild(datePopover);
            }
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            datePopover.textContent = `${label}: ${formattedDate}`;
            datePopover.style.display = 'block';
            
            // Position popover above the cursor/bar edge
            // First get the popover width to center it properly
            const popoverWidth = datePopover.offsetWidth || 150; // fallback width
            datePopover.style.left = (x - popoverWidth / 2) + 'px';
            datePopover.style.top = (y - 40) + 'px';
        }
        
        function hideDatePopover() {
            if (datePopover) {
                datePopover.style.display = 'none';
            }
        }
        
        // Create placeholder indicator for reordering
        let placeholderLine = null;
        function showReorderPlaceholder(y) {
            // Find the inner chart container where bars are positioned
            const chartInner = chartEl.querySelector('.waterfall-chart-inner');
            if (!chartInner) return;
            
            if (!placeholderLine) {
                placeholderLine = document.createElement('div');
                placeholderLine.id = 'waterfallReorderPlaceholder';
                placeholderLine.style.cssText = 'position: absolute; left: 0; right: 0; height: 2px; background: #cbd5e1; z-index: 999; pointer-events: none;';
                chartInner.appendChild(placeholderLine);
            }
            // y is already relative to the inner container (accounts for 20px top padding)
            placeholderLine.style.top = y + 'px';
            placeholderLine.style.display = 'block';
        }
        
        function hideReorderPlaceholder() {
            if (placeholderLine) {
                placeholderLine.style.display = 'none';
            }
        }
        
        // Mouse move handler
        handleMouseMove = function(e) {
            if (!isDragging || !currentBar) return;
            
            const chartRect = chartEl.getBoundingClientRect();
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const deltaPercent = (deltaX / chartRect.width) * 100;
            
            // Determine drag type if not yet determined
            if (!dragType) {
                const absDeltaX = Math.abs(deltaX);
                const absDeltaY = Math.abs(deltaY);
                
                if (absDeltaX < dragThreshold && absDeltaY < dragThreshold) {
                    return; // Wait for threshold
                }
                
                // Determine primary direction
                if (absDeltaY > absDeltaX) {
                    dragType = 'reorder';
                    hideDatePopover();
                } else {
                    dragType = 'move';
                }
            }
            
            if (dragType === 'reorder') {
                // Vertical reordering
                const currentY = e.clientY - chartRect.top;
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentY - 20) / barSpacing)));
                
                // Only show placeholder if order would actually change
                if (newIndex !== startIndex) {
                    // Determine if dragging up or down from original position
                    const isDraggingDown = newIndex > startIndex;
                    
                    // Show placeholder at target position
                    // If dragging down, show line below the target bar; if dragging up, show above
                    let targetY;
                    if (isDraggingDown) {
                        // Show line below the target bar (at the bottom of the bar + a bit)
                        targetY = 20 + (newIndex * barSpacing) + barHeight + 2;
                    } else {
                        // Show line above the target bar (at the top of the bar)
                        targetY = 20 + (newIndex * barSpacing);
                    }
                    showReorderPlaceholder(targetY);
                } else {
                    // Hide placeholder if order wouldn't change
                    hideReorderPlaceholder();
                }
                
                // Update visual position
                currentBar.style.top = (currentY - barHeight / 2) + 'px';
                currentBar.style.left = startLeft + '%';
                currentBar.style.width = startWidth + '%';
            } else if (dragType === 'move') {
                // Move entire bar horizontally
                const newLeft = Math.max(0, Math.min(100 - startWidth, startLeft + deltaPercent));
                const newStartDate = new Date(minDate.getTime() + ((newLeft / 100) * totalDays) * 24 * 60 * 60 * 1000);
                const duration = (endDate - startDate) / (1000 * 60 * 60 * 24);
                const newEndDate = new Date(newStartDate.getTime() + duration * 24 * 60 * 60 * 1000);
                
                currentBar.style.left = newLeft + '%';
                currentBar.dataset.startDate = newStartDate.toISOString().split('T')[0];
                currentBar.dataset.endDate = newEndDate.toISOString().split('T')[0];
                
                // Show popover for both dates
                const barRect = currentBar.getBoundingClientRect();
                showDatePopover(e.clientX, barRect.top, newStartDate.toISOString().split('T')[0], 'Start');
            } else if (dragType === 'resize-left') {
                // Resize from left
                const newLeft = Math.max(0, Math.min(startLeft + startWidth - 1, startLeft + deltaPercent));
                const newWidth = startWidth - (newLeft - startLeft);
                const newStartDate = new Date(minDate.getTime() + ((newLeft / 100) * totalDays) * 24 * 60 * 60 * 1000);
                
                if (newWidth > 0 && newStartDate < endDate) {
                    currentBar.style.left = newLeft + '%';
                    currentBar.style.width = newWidth + '%';
                    currentBar.dataset.startDate = newStartDate.toISOString().split('T')[0];
                    
                    // Show popover for start date at the left edge
                    showDatePopover(e.clientX, e.clientY, newStartDate.toISOString().split('T')[0], 'Start');
                }
            } else if (dragType === 'resize-right') {
                // Resize from right
                const newWidth = Math.max(1, Math.min(100 - startLeft, startWidth + deltaPercent));
                const newEndDate = new Date(minDate.getTime() + ((startLeft + newWidth) / 100) * totalDays * 24 * 60 * 60 * 1000);
                
                if (newEndDate > startDate) {
                    currentBar.style.width = newWidth + '%';
                    currentBar.dataset.endDate = newEndDate.toISOString().split('T')[0];
                    
                    // Show popover for end date at the right edge
                    showDatePopover(e.clientX, e.clientY, newEndDate.toISOString().split('T')[0], 'End');
                }
            }
        };
        
        // Mouse up handler - save changes
        handleMouseUp = function(e) {
            if (!isDragging || !currentBar) return;
            
            // Hide placeholders
            hideDatePopover();
            hideReorderPlaceholder();
            
            const stageId = currentBar.dataset.stageId;
            
            if (dragType === 'reorder') {
                // Handle reordering
                const chartRect = chartEl.getBoundingClientRect();
                const barHeight = 30;
                const barSpacing = 50;
                const allBars = Array.from(chartEl.querySelectorAll('.waterfall-stage-bar'));
                
                // Use the bar's current visual position to determine new index
                const currentBarTop = parseFloat(currentBar.style.top) || startTop;
                const newIndex = Math.max(0, Math.min(allBars.length - 1, Math.round((currentBarTop - 20 + barHeight / 2) / barSpacing)));
                
                if (newIndex !== startIndex) {
                    // Calculate new orders
                    const baseOrder = PROJECT_ID * 1000;
                    const orders = [];
                    
                    // Get all bars except the one being dragged, sorted by their original order
                    const otherBars = allBars.filter(bar => bar !== currentBar);
                    
                    // Sort other bars by their data-order attribute (original order)
                    otherBars.sort((a, b) => {
                        const aOrder = parseFloat(a.dataset.order) || 0;
                        const bOrder = parseFloat(b.dataset.order) || 0;
                        return aOrder - bOrder;
                    });
                    
                    // Insert current bar at new position
                    otherBars.splice(newIndex, 0, currentBar);
                    
                    // Calculate orders
                    otherBars.forEach((bar, index) => {
                        orders.push({
                            stage_id: parseInt(bar.dataset.stageId),
                            order: baseOrder + index + 1
                        });
                    });
                    
                    // Update database
                    fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/reorder/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Stage order updated', 'success');
                            }
                            // Reload stages to update everything
                            loadStages();
                        } else {
                            console.error('Failed to reorder stages:', data.error);
                            if (typeof showNotification !== 'undefined') {
                                showNotification('Failed to reorder stages', 'error');
                            }
                            loadStages();
                        }
                    })
                    .catch(error => {
                        console.error('Error reordering stages:', error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Error reordering stages', 'error');
                        }
                        loadStages();
                    });
                } else {
                    // No change, just restore
                    loadStages();
                }
            } else {
                // Handle date updates
                const oldStartDate = startDate.toISOString().split('T')[0];
                const oldEndDate = endDate.toISOString().split('T')[0];
                const newStartDate = currentBar.dataset.startDate;
                const newEndDate = currentBar.dataset.endDate;
                
                // Format dates for notification
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                };
                
                // Determine what changed
                let notificationMessage = '';
                if (dragType === 'resize-left' && newStartDate !== oldStartDate) {
                    notificationMessage = `Start date updated to ${formatDate(newStartDate)}`;
                } else if (dragType === 'resize-right' && newEndDate !== oldEndDate) {
                    notificationMessage = `End date updated to ${formatDate(newEndDate)}`;
                } else if (dragType === 'move' && (newStartDate !== oldStartDate || newEndDate !== oldEndDate)) {
                    notificationMessage = `Stage dates updated: ${formatDate(newStartDate)} - ${formatDate(newEndDate)}`;
                }
                
                // Update database
                fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/${stageId}/update-dates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        start_date: newStartDate,
                        end_date: newEndDate
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show notification
                        if (notificationMessage && typeof showNotification !== 'undefined') {
                            showNotification(notificationMessage, 'success');
                        }
                        // Reload stages to update everything
                        loadStages();
                    } else {
                        console.error('Failed to update stage dates:', data.error);
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Failed to update stage dates', 'error');
                        }
                        // Reload to restore correct state
                        loadStages();
                    }
                })
                .catch(error => {
                    console.error('Error updating stage dates:', error);
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Error updating stage dates', 'error');
                    }
                    loadStages();
                });
            }
            
            // Reset
            isDragging = false;
            dragType = null;
            if (currentBar) {
                currentBar.style.cursor = 'move';
                currentBar.style.zIndex = '';
                currentBar.style.opacity = '';
            }
            currentBar = null;
            
            // Remove event listeners
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }
    
    // Render project completion progress circle
    function renderProjectProgress(stages) {
        const progressCircle = document.getElementById('projectProgressCircle');
        const completionText = document.getElementById('projectCompletionText');
        
        if (!progressCircle || !completionText) return;
        
        if (!stages || stages.length === 0) {
            completionText.textContent = '0%';
            progressCircle.style.strokeDashoffset = '326.73';
            progressCircle.style.stroke = '#e5e7eb';
            return;
        }
        
        // Calculate completion based on tasks across all stages
        let totalTasks = 0;
        let completedTasks = 0;
        
        stages.forEach(stage => {
            const stageTotal = stage.tasks_total || 0;
            const stageCompleted = stage.tasks_completed || 0;
            totalTasks += stageTotal;
            completedTasks += stageCompleted;
        });
        
        // Calculate percentage
        const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        function getProgressColor(pct) {
            if (pct >= 90) return '#059669'; // Dark green
            if (pct >= 70) return '#10b981'; // Green
            if (pct >= 40) return '#f59e0b'; // Orange
            return '#ef4444'; // Red
        }
        
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        completionText.textContent = percentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }
    
    // Render stages from API data
    function renderStages(stages) {
        console.log('renderStages called with:', stages);
        const container = document.getElementById('stagesList');
        const countEl = document.getElementById('stagesCount');
        
        if (!container) {
            console.error('stagesList container not found!');
            return;
        }
        
        if (!countEl) {
            console.error('stagesCount element not found!');
        }
        
        // Render charts and progress
        renderWaterfallChart(stages);
        renderProjectProgress(stages);
        
        if (!stages || stages.length === 0) {
            console.log('No stages to render');
            container.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #9ca3af;">
                    <i class="fas fa-stream" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>No stages defined yet.</p>
                </div>
            `;
            if (countEl) {
                countEl.textContent = '0 Stages';
            }
            return;
        }
        
        console.log(`Rendering ${stages.length} stages`);
        if (countEl) {
            countEl.textContent = `${stages.length} Stage${stages.length !== 1 ? 's' : ''}`;
        }
        
        container.innerHTML = stages.map(stage => {
            let statusDot = '';
            let titleClass = '';
            let titleText = stage.title;
            
            if (stage.is_completed) {
                statusDot = '<span class="status-dot completed" title="Completed"></span>';
                titleClass = 'style="text-decoration: line-through; color: #6b7280;"';
            } else {
                statusDot = '<span class="status-dot pending" title="In Progress"></span>';
            }
            
            // Calculate progress based on tasks
            const totalTasks = stage.tasks_total || 0;
            const completedTasks = stage.tasks_completed || 0;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : (stage.is_completed ? 100 : 0);
            const progressColor = progress === 100 ? '#10b981' : (progress > 0 ? '#3b82f6' : '#e5e7eb');
            
            // Format dates for display
            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };
            
            const startDateDisplay = stage.start_date ? formatDate(stage.start_date) : null;
            const endDateDisplay = stage.end_date ? formatDate(stage.end_date) : null;
            
            let dateRangeHtml = '';
            if (startDateDisplay && endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> ${startDateDisplay} - ${endDateDisplay}</div>`;
            } else if (startDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Starts ${startDateDisplay}</div>`;
            } else if (endDateDisplay) {
                dateRangeHtml = `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Ends ${endDateDisplay}</div>`;
            }
            
            return `
                <div class="stage-row" data-stage-id="${stage.id}">
                    <div class="stage-drag-section">
                        <div class="drag-grip">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                    </div>
                    <div class="stage-main-wrapper" onclick="window.location.href='${STAGE_DETAIL_URL}${stage.id}/';">
                        <div class="stage-main">
                            <div class="stage-title-meta">
                                <div class="stage-title">
                                    ${statusDot}
                                    <span ${titleClass}>${titleText}</span>
                                </div>
                                ${dateRangeHtml}
                            </div>
                        </div>
                        <div class="stage-progress-section">
                            <div class="stage-progress-bar-container">
                                <div class="stage-progress-label">
                                    <span>Progress</span>
                                    <span style="font-weight: 500;">${progress}%</span>
                                </div>
                                <div class="stage-progress-bar">
                                    <div class="stage-progress-fill" style="width: ${progress}%; background: ${progressColor};"></div>
                                </div>
                            </div>
                            <div class="stage-tasks-count ${totalTasks === 0 ? 'no-tasks' : ''}">
                                ${totalTasks === 0 
                                    ? '<span style="color: #93c5fd;">no tasks yet</span>'
                                    : `<i class="fas fa-tasks"></i><span>${completedTasks}/${totalTasks}</span>`
                                }
                            </div>
                        </div>
                    </div>
                    <div class="row-actions-section" onclick="event.stopPropagation();">
                        <div class="row-actions" id="rowActions_${stage.id}">
                            <div class="stage-dropdown-container" id="stageDropdown_${stage.id}">
                                <button class="stage-dropdown-trigger" onclick="toggleStageDropdown(${stage.id}, event)">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="stage-dropdown-menu" onclick="event.stopPropagation();">
                                    <button class="stage-dropdown-item first-item" onclick="editStage(${stage.id}); event.stopPropagation();">
                                        <i class="fas fa-edit"></i>
                                        <span>Edit</span>
                                    </button>
                                    <button class="stage-dropdown-item delete-item last-item" onclick="deleteStage(${stage.id}); event.stopPropagation();">
                                        <i class="fas fa-trash"></i>
                                        <span>Delete</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Initialize SortableJS after rendering
        initSortable();
    }
    
    // Initialize SortableJS
    function initSortable() {
        const el = document.getElementById('stagesList');
        if (!el) return;
        
        // Destroy existing instance if any
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        // Wait for Sortable to be loaded
        if (typeof Sortable === 'undefined') {
            setTimeout(initSortable, 100);
            return;
        }
        
        sortableInstance = new Sortable(el, {
            animation: 150,
            handle: '.stage-drag-section',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            forceFallback: false,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            onStart: function(evt) {
                evt.item.style.opacity = '0.5';
            },
            onEnd: function(evt) {
                evt.item.style.opacity = '1';
                
                if (evt.newIndex === evt.oldIndex) return;
                
                const orders = [];
                const baseOrder = PROJECT_ID * 1000;
                
                el.querySelectorAll('.stage-row').forEach((row, index) => {
                    orders.push({
                        stage_id: parseInt(row.dataset.stageId),
                        order: baseOrder + index + 1
                    });
                });
                
                fetch('{% url "general:dashboard_mentor:reorder_stages" project.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ orders: orders })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to reorder stages:', data.error);
                        // Reload stages to restore correct order
                        loadStages();
                    } else {
                        // Re-render waterfall chart after successful reorder
                        loadStages();
                    }
                })
                .catch(error => {
                    console.error('Error reordering stages:', error);
                    loadStages();
                });
            }
        });
    }
    
    // Load stages from API
    function loadStages() {
        const apiUrl = '{% url "general:dashboard_mentor:get_stages_api" project.id %}';
        console.log('Fetching stages from:', apiUrl);
        
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('API Error Response:', text);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Stages API response:', data);
                if (data && data.success) {
                    renderStages(data.stages || []);
                } else {
                    console.error('Failed to load stages:', data?.error || 'Unknown error');
                    const errorMsg = data?.error || 'Unknown error';
                    document.getElementById('stagesList').innerHTML = `
                        <div style="padding: 48px; text-align: center; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                            <p>Error loading stages: ${errorMsg}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching stages:', error);
                document.getElementById('stagesList').innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Network error: ${error.message}</p>
                        <p style="font-size: 0.8rem; margin-top: 8px; color: #6b7280;">URL: ${apiUrl}</p>
                        <p style="font-size: 0.8rem; margin-top: 4px;">Please check the browser console (F12) for details.</p>
                    </div>
                `;
            });
    }
    
    // Initialize immediately - script runs after DOM is ready
    console.log('Script execution started');
    console.log('Document ready state:', document.readyState);
    
    // Try calling immediately
    try {
        console.log('Attempting to call loadStages()');
        loadStages();
    } catch (error) {
        console.error('Error calling loadStages:', error);
        // Fallback to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - calling loadStages()');
            loadStages();
        });
    }

    // Modal Helpers
    window.openCreateStageModal = function() {
        const modal = document.getElementById('createStageModal');
        if(modal) { modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('active'),10); }
    };
    
    window.generateStagesAI = function() {
        const btn = document.getElementById('generateStagesBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Generating...';
        btn.disabled = true;
        btn.style.opacity = '0.7';
        
        fetch('{% url "general:dashboard_mentor:generate_stages_ai" project.id %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadStages();
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('A network error occurred. Please try again.');
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    };
    
    window.deleteStage = function(id) {
        if(confirm('Delete stage?')) {
            fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/${id}/delete/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(() => loadStages());
        }
    };

    // Toggle stage dropdown menu
    window.toggleStageDropdown = function(stageId, event) {
        event.stopPropagation();
        const container = document.getElementById(`stageDropdown_${stageId}`);
        if (!container) return;
        
        const menu = container.querySelector('.stage-dropdown-menu');
        if (!menu) return;
        
        const isCurrentlyActive = container.classList.contains('active');
        
        // Close all other dropdowns first
        document.querySelectorAll('.stage-dropdown-container').forEach(dropdown => {
            if (dropdown !== container) {
                dropdown.classList.remove('active');
                const otherMenu = dropdown.querySelector('.stage-dropdown-menu');
                if (otherMenu) {
                    otherMenu.classList.remove('dropdown-up');
                }
            }
        });
        
        // If clicking the same dropdown, toggle it off
        if (isCurrentlyActive) {
            container.classList.remove('active');
            menu.classList.remove('dropdown-up');
            // Remove has-active-dropdown class from row actions
            const rowActions = container.closest('.row-actions');
            if (rowActions) {
                rowActions.classList.remove('has-active-dropdown');
            }
            return;
        }
        
        // Get trigger button position relative to viewport
        const trigger = container.querySelector('.stage-dropdown-trigger');
        if (!trigger) return;
        
        const triggerRect = trigger.getBoundingClientRect();
        const menuHeight = 100; // Approximate height of dropdown menu (2 items)
        const spaceBelow = window.innerHeight - triggerRect.bottom;
        const spaceAbove = triggerRect.top;
        
        // Check if it's the last stage row
        const stageRow = container.closest('.stage-row');
        const isLastRow = stageRow && !stageRow.nextElementSibling;
        
        // Determine if dropdown should appear above
        if (spaceBelow < menuHeight + 8 || isLastRow) {
            // Show above if not enough space below or it's the last row
            menu.classList.add('dropdown-up');
        } else {
            // Show below
            menu.classList.remove('dropdown-up');
        }
        
        // Open the dropdown
        container.classList.add('active');
        
        // Keep row actions visible when dropdown is active
        const rowActions = document.getElementById(`rowActions_${stageId}`);
        if (rowActions) {
            rowActions.classList.add('has-active-dropdown');
        }
    };

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        // Don't close if clicking inside a dropdown container (trigger or menu)
        if (event.target.closest('.stage-dropdown-container')) {
            return;
        }
        
        // Close all dropdowns
        document.querySelectorAll('.stage-dropdown-container').forEach(dropdown => {
            dropdown.classList.remove('active');
            const menu = dropdown.querySelector('.stage-dropdown-menu');
            if (menu) {
                menu.classList.remove('dropdown-up');
            }
            // Remove has-active-dropdown class from row actions
            const rowActions = dropdown.closest('.row-actions');
            if (rowActions) {
                rowActions.classList.remove('has-active-dropdown');
            }
        });
    });

    // Edit stage - open modal with stage data
    window.editStage = function(stageId) {
        // Close dropdown
        const container = document.getElementById(`stageDropdown_${stageId}`);
        if (container) {
            container.classList.remove('active');
        }
        
        // Fetch stage data
        fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/api/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.success) {
                const stage = data.stages.find(s => s.id === stageId);
                if (stage) {
                    // Open modal with stage data
                    if (typeof openCreateStageModalForEdit !== 'undefined') {
                        openCreateStageModalForEdit(stage);
                    } else {
                        // Fallback: open modal and populate manually
                        openCreateStageModal();
                        setTimeout(() => {
                            document.getElementById('stageTitleInput').value = stage.title;
                            document.getElementById('stageDescriptionInput').value = stage.description || '';
                            if (stage.start_date) {
                                document.getElementById('stageStartDateInput').value = stage.start_date;
                            }
                            if (stage.end_date) {
                                document.getElementById('stageEndDateInput').value = stage.end_date;
                            }
                            document.getElementById('editingStageId').value = stageId;
                            document.getElementById('createStageModalTitle').textContent = 'Edit Stage';
                            document.getElementById('createStageBtn').textContent = 'Update Stage';
                        }, 100);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching stage data:', error);
            alert('Failed to load stage data. Please try again.');
        });
    };
</script>
{% endblock %}
