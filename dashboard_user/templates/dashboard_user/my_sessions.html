{% extends "dashboard_user/base.html" %}
{% load static %}

{% block page_title %}My Sessions{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="my-sessions-header">
    <h1 class="dashboard-page-title">My Sessions</h1>
        <a href="{% url 'general:dashboard_user:session_management' %}" class="btn btn-primary" style="position: relative;">
            <i class="fas fa-inbox"></i>
            <span>Session Invitations & Changes</span>
            {% if pending_sessions_count > 0 %}
            <span class="btn-badge">{{ pending_sessions_count }}</span>
            {% endif %}
        </a>
    </div>

    <div class="dashboard-card flex-scroll-card">
        <div class="card-header" style="align-items: center;">
            <h3 class="card-title">Upcoming sessions</h3>
        </div>

        <div class="session-timeline-container scrollable-content" id="sessionsContainer" data-user-timezone="{{ user_timezone }}">
            {% if initial_sessions %}
                {% for session in initial_sessions %}
                    <div class="session-item status-{{ session.status }}" data-clickable-session data-session-id="{{ session.id }}">
                        <div class="session-left" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal({{ session.id }});" style="cursor: pointer;">
                            <div class="session-date">
                                <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                                <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
                            </div>
                            <div class="session-info">
                                <h4 class="session-title">Session with {{ session.mentor_name }}</h4>
                                <div class="session-meta-row">
                                    <span class="session-time">
                                        <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                                    </span>
                                    <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                                        {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="session-right">
                            <div class="dropdown">
                                <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
                                    <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal({{ session.id }});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
                                    <button type="button" class="dropdown-item delete-item last-item" onclick="if (typeof openUserCancelSessionModal === 'function') openUserCancelSessionModal({{ session.id }});"><i class="fas fa-times-circle"></i><span>Cancel session</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
                    <p>No upcoming sessions</p>
                <a href="{% url 'web:mentors' %}" class="btn btn-primary" style="margin-top: 16px;">Find a Mentor</a>
                </div>
            {% endif %}
            
            <!-- Loading indicator for infinite scroll -->
            <div id="sessionsLoading" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading more sessions...
            </div>
            
            <!-- End of list indicator -->
            <div id="sessionsEnd" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
                <p>No more sessions to load</p>
            </div>
        </div>
    </div>
</div>

<style>
.my-sessions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
}

.my-sessions-header .dashboard-page-title {
    margin: 0;
    flex: 1;
}

.my-sessions-header .btn {
    display: inline-flex;
    align-items: center;
    border-radius: 8px;
    gap: 8px;
    white-space: nowrap;
}

/* Button Badge for Session Management */
.btn-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 768px) {
    .my-sessions-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .my-sessions-header .btn {
        width: 100%;
        justify-content: center;
    }
}

/* Cancel session modal (same pattern as mentor) */
.session-detail-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(8px);
}
.session-detail-modal-backdrop { position: absolute; inset: 0; }
.session-detail-modal {
    position: relative;
    width: 80vw;
    max-width: 420px;
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}
.session-detail-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.session-detail-modal-title { margin: 0; font-size: 1.25rem; font-weight: 800; color: #0f172a; }
.session-detail-modal-close {
    border: none;
    background: #f1f5f9;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    color: #64748b;
    font-size: 1.1rem;
}
.session-detail-modal-close:hover { background: #fee2e2; color: #ef4444; }
.session-detail-modal-body { padding: 32px; overflow-y: auto; }
</style>

<script>
(function() {
  // Start at page 1 since initial load is page 1
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;
  const perPage = 10;
  const sessionsContainer = document.getElementById('sessionsContainer');
  const loadingIndicator = document.getElementById('sessionsLoading');
  const endIndicator = document.getElementById('sessionsEnd');
  
  if (!sessionsContainer) return;
  
  // Function to refresh the entire my-sessions page
  window.refreshMySessionsPage = async function() {
    if (!sessionsContainer) return;
    
    // Reset state
    currentPage = 1;
    hasMore = true;
    isLoading = false;
    
    // Clear existing sessions (keep loading and end indicators)
    const existingSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
    existingSessions.forEach(session => session.remove());
    
    // Hide indicators
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    if (endIndicator) endIndicator.style.display = 'none';
    
    // Load page 1
    try {
      isLoading = true;
      if (loadingIndicator) loadingIndicator.style.display = 'block';
      
      const response = await fetch(`{% url 'general:dashboard_user:get_sessions_paginated' %}?page=1&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        if (loadingIndicator) {
          sessionsContainer.insertBefore(fragment, loadingIndicator);
        } else {
          sessionsContainer.appendChild(fragment);
        }
        
        hasMore = data.has_next;
        
        if (!hasMore && endIndicator) {
          endIndicator.style.display = 'block';
        }
      } else {
        // No sessions
        hasMore = false;
        if (endIndicator) endIndicator.style.display = 'block';
      }
    } catch (error) {
      console.error('Error refreshing my-sessions page:', error);
      hasMore = false;
    } finally {
      isLoading = false;
      if (loadingIndicator) loadingIndicator.style.display = 'none';
    }
  };
  
  // Check if there are initial sessions to determine if we should load more
  const initialSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
  // If we have no initial sessions, there's nothing to load
  if (initialSessions.length === 0) {
    hasMore = false;
    if (endIndicator) endIndicator.style.display = 'block';
  } else if (initialSessions.length < perPage) {
    // If we have fewer than perPage, likely no more pages
    // But we'll still try to load page 2 to be sure
    hasMore = true;
  }
  
  // User's selected timezone from profile (used so paginated sessions match initial server-rendered times)
  const userTimezone = sessionsContainer.getAttribute('data-user-timezone') || Intl.DateTimeFormat().resolvedOptions().timeZone;

  // Make formatSessionHTML accessible to refreshMySessionsPage
  function formatSessionHTML(session) {
    const startDate = new Date(session.start_datetime);
    const endDate = new Date(session.end_datetime);
    const tzOpt = { timeZone: userTimezone };

    const day = new Intl.DateTimeFormat('en-US', { ...tzOpt, day: 'numeric' }).format(startDate);
    const month = new Intl.DateTimeFormat('en-US', { ...tzOpt, month: 'short' }).format(startDate);
    const startTime = new Intl.DateTimeFormat('en-US', { ...tzOpt, hour: 'numeric', minute: '2-digit', hour12: true }).format(startDate);
    const endTime = new Intl.DateTimeFormat('en-US', { ...tzOpt, hour: 'numeric', minute: '2-digit', hour12: true }).format(endDate);
    
    const statusClass = session.status === 'confirmed' ? 'confirmed' : 'tbc';
    const statusText = session.status === 'confirmed' ? 'Confirmed' : 'Invited';
    const statusStyle = session.status === 'confirmed' 
      ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;'
      : 'background: rgba(251, 191, 36, 0.1); color: #f59e0b;';
    
    return `
      <div class="session-item status-${session.status}" data-clickable-session data-session-id="${session.id}">
        <div class="session-left" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal(${session.id});" style="cursor: pointer;">
          <div class="session-date">
            <span class="date-day">${day}</span>
            <span class="date-month">${month}</span>
          </div>
          <div class="session-info">
            <h4 class="session-title">Session with ${escapeHtml(session.mentor_name)}</h4>
            <div class="session-meta-row">
              <span class="session-time">
                <i class="far fa-clock"></i> ${startTime} - ${endTime}
              </span>
              <span class="conf-tag ${statusClass}" style="${statusStyle}">
                ${statusText}
              </span>
            </div>
          </div>
        </div>
        
        <div class="session-right">
          <div class="dropdown">
            <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
              <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal(${session.id});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
              <button type="button" class="dropdown-item delete-item last-item" onclick="if (typeof openUserCancelSessionModal === 'function') openUserCancelSessionModal(${session.id});"><i class="fas fa-times-circle"></i><span>Cancel session</span></button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  async function loadMoreSessions() {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    loadingIndicator.style.display = 'block';
    
    try {
      const response = await fetch(`{% url 'general:dashboard_user:get_sessions_paginated' %}?page=${currentPage + 1}&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || '',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        loadingIndicator.parentNode.insertBefore(fragment, loadingIndicator);
        
        currentPage++;
        hasMore = data.has_next;
        
        if (!hasMore) {
          loadingIndicator.style.display = 'none';
          endIndicator.style.display = 'block';
        }
      } else {
        hasMore = false;
        loadingIndicator.style.display = 'none';
        if (currentPage === 1 && data.sessions.length === 0) {
          // No sessions at all
        } else {
          endIndicator.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('Error loading more sessions:', error);
      hasMore = false;
      loadingIndicator.style.display = 'none';
    } finally {
      isLoading = false;
    }
  }
  
  // Infinite scroll handler
  let scrollTimeout;
  sessionsContainer.addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
      const scrollTop = sessionsContainer.scrollTop;
      const scrollHeight = sessionsContainer.scrollHeight;
      const clientHeight = sessionsContainer.clientHeight;
      
      // Load more when user is 200px from bottom
      if (scrollHeight - scrollTop - clientHeight < 200) {
        loadMoreSessions();
      }
    }, 100);
  });
  
  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>
{% endblock %}
