{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Reviews Management{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container" style="max-width: 1200px;">
  <div style="margin-bottom: 24px;">
    <a href="{% url 'general:dashboard_mentor:profile' %}" class="btn btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
      <i class="fas fa-arrow-left"></i> Back to Profile
    </a>
  </div>

  <div class="dashboard-card">
    <h1 class="card-title" style="margin-bottom: 24px;">Client Reviews</h1>
    
    {% if reviews %}
      <div style="display: flex; flex-direction: column; gap: 24px;">
        {% for review in reviews %}
          <div style="padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb;">
            <!-- Review Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                  <div style="width: 48px; height: 48px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280; font-weight: 600; flex-shrink: 0;">
                    {{ review.client.first_name|first }}{{ review.client.last_name|first }}
                  </div>
                  <div>
                    <div style="font-weight: 600; font-size: 1.1rem; color: var(--dash-text-main);">
                      {{ review.client.first_name }} {{ review.client.last_name }}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--dash-text-muted);">
                      {% if review.published_at %}
                        Published {{ review.published_at|date:"F d, Y" }}
                      {% else %}
                        Draft
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                <div style="color: #fbbf24; font-size: 1.2rem;">
                  {% for i in "12345"|make_list %}
                    {% if forloop.counter <= review.rating %}
                      <i class="fas fa-star"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <span style="font-weight: 600; color: var(--dash-text-main);">{{ review.rating }}/5</span>
              </div>
            </div>

            <!-- Review Text -->
            <div style="padding: 16px; background: white; border-radius: 8px; margin-bottom: 16px; color: var(--dash-text-main); line-height: 1.6;">
              {{ review.text }}
            </div>

            <!-- Reply Section -->
            <div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">
              <h3 style="font-size: 0.95rem; font-weight: 600; margin-bottom: 12px; color: var(--dash-text-main);">Your Reply</h3>
              {% if review.reply %}
                <div style="padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 12px;">
                  <div style="color: var(--dash-text-main); line-height: 1.6; margin-bottom: 8px;">
                    {{ review.reply.text }}
                  </div>
                  <div style="font-size: 0.85rem; color: var(--dash-text-muted);">
                    Last updated: {{ review.reply.updated_at|date:"F d, Y g:i A" }}
                  </div>
                </div>
              {% endif %}
              <textarea id="replyText{{ review.id }}" rows="4" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: inherit; font-size: 0.95rem; resize: vertical;" placeholder="Write your reply to this review...">{% if review.reply %}{{ review.reply.text }}{% endif %}</textarea>
              <button onclick="saveReply({{ review.id }})" class="btn btn-primary" style="margin-top: 12px;">
                <i class="fas fa-save"></i> {% if review.reply %}Update Reply{% else %}Save Reply{% endif %}
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if page_obj.has_other_pages %}
        <div style="margin-top: 32px; display: flex; justify-content: center; align-items: center; gap: 8px;">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary" style="text-decoration: none;">
              <i class="fas fa-chevron-left"></i> Previous
            </a>
          {% endif %}
          
          <span style="color: var(--dash-text-muted); font-weight: 600;">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
          
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary" style="text-decoration: none;">
              Next <i class="fas fa-chevron-right"></i>
            </a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <div style="text-align: center; padding: 80px 20px; color: var(--dash-text-muted);">
        <i class="fas fa-star" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
        <p style="font-size: 1.2rem; margin: 0;">No reviews yet</p>
        <p style="margin-top: 8px; font-size: 0.95rem;">Reviews from your clients will appear here.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
function saveReply(reviewId) {
  const textarea = document.getElementById('replyText' + reviewId);
  const text = textarea.value.trim();
  
  if (!text) {
    alert('Please enter a reply');
    return;
  }
  
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch(`/dashboard/mentor/reviews/${reviewId}/reply/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({ text: text })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('Reply saved successfully!');
      window.location.reload();
    } else {
      alert(data.error || 'An error occurred');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('An error occurred. Please try again.');
  });
}
</script>
{% endblock %}
