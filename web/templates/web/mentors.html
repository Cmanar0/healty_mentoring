{% extends "base.html" %}
{% block title %}Find Your Mentor — Healthy Mentoring{% endblock %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/landing.css' %}">
<!-- Flag Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.0.0/css/flag-icons.min.css">
{% endblock %}

{% block content %}
<!-- Mentors Page Header -->
<section class="mentors-page-header">
  <div class="container text-center">
    <h1>Browse Mentors</h1>
    <p>Connect with world-class experts to accelerate your growth.</p>
  </div>
</section>

<!-- Search Section (Reused & Adapted) -->
<section id="search" class="search-section-new mentors-page-search">
  <div class="search-header">
    <div class="search-bar-container">
      <div class="search-bar" style="position: relative;">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search for mentors by name..." autocomplete="off" value="{{ current_filters.q }}">
        <button class="clear-btn" id="clearBtn" style="display: none;">
          <i class="fas fa-times"></i>
        </button>
        <button class="search-btn">Search</button>
        <!-- Mentor suggestions dropdown -->
        <div class="autocomplete-suggestions" id="mentorSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; display: none;"></div>
      </div>
    </div>
  </div>
  
  <div class="search-filters">
    <div class="filter-group filter-group-compact">
      <label><i class="fas fa-tag"></i> Category</label>
      <div class="autocomplete-container" style="position: relative;">
        <input type="text" id="categoryInput" class="form-input autocomplete-input" placeholder="Type to search categories..." autocomplete="off" value="{% if current_filters.category %}{% for cat in predefined_categories %}{% if cat.id == current_filters.category %}{{ cat.name }}{% endif %}{% endfor %}{% endif %}">
        <div class="autocomplete-suggestions" id="categorySuggestions"></div>
        <input type="hidden" id="categoryValue" value="{{ current_filters.category }}">
      </div>
    </div>
    
    <div class="filter-group price-slider-group">
      <label class="price-label">
        <span><i class="fas fa-dollar-sign" style="margin-right: 5px;"></i> Session Price</span>
        <span class="price-value" id="priceValue">$0 - ${{ max_price|default:200 }}</span>
      </label>
      <div class="price-slider-wrapper">
        <input type="range" min="{{ min_price|default:0 }}" max="{{ max_price|default:200 }}" value="{% if current_filters.price %}{{ current_filters.price }}{% else %}{{ max_price|default:200 }}{% endif %}" class="price-slider" id="priceSlider">
      </div>
    </div>
    
    <div class="filter-group filter-group-compact">
      <label><i class="fas fa-globe"></i> Language</label>
      <div class="autocomplete-container" style="position: relative;">
        <input type="text" id="languageInput" class="form-input autocomplete-input" placeholder="Type to search languages..." autocomplete="off" value="{% if current_filters.language %}{% for lang in predefined_languages %}{% if lang.id == current_filters.language %}{{ lang.name }}{% endif %}{% endfor %}{% endif %}">
        <div class="autocomplete-suggestions" id="languageSuggestions"></div>
        <input type="hidden" id="languageValue" value="{{ current_filters.language }}">
      </div>
    </div>
    
    <div class="filter-group filter-group-compact">
      <label>
        <i class="fas fa-gift"></i> First Session Free
        <span class="info-icon-popover-trigger" data-popover="firstSessionFreePopover">
          <i class="fas fa-info-circle" style="color: var(--text-light); font-size: 0.85rem; margin-left: 4px; cursor: help;"></i>
        </span>
        <div class="info-popover" id="firstSessionFreePopover" style="display: none;">
          Show only mentors offering free first session
        </div>
      </label>
      <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
        <div class="toggle-wrapper">
          <label class="toggle-switch">
            <input type="checkbox" id="firstSessionFree" {% if current_filters.first_session_free %}checked{% endif %}>
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-status-text" id="firstSessionStatusText">
            {% if current_filters.first_session_free %}Enabled{% else %}Disabled{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="mentors-container list-view" id="mentorsContainer">
    {% if mentors %}
      {% for mentor in mentors %}
      <div class="mentor-card" data-aos="fade-up" data-mentor-id="{{ mentor.user.id }}" onclick="handleMentorCardClick(event, '{% url 'web:mentor_profile_detail' mentor.user.id %}')" onauxclick="handleMentorCardClick(event, '{% url 'web:mentor_profile_detail' mentor.user.id %}')" style="cursor: pointer;">
        <div class="mentor-header-content">
          <div class="mentor-avatar {% if mentor.video_introduction_url %}video-trigger{% endif %}" {% if mentor.video_introduction_url %}onclick="event.stopPropagation(); openVideoModal('{{ mentor.video_introduction_url }}')"{% endif %}>
            {% if mentor.profile_picture %}
              <img src="{{ mentor.profile_picture.url }}" alt="{{ mentor.first_name }} {{ mentor.last_name }}">
            {% else %}
              <img src="https://i.pravatar.cc/150?img={{ mentor.user.id }}" alt="{{ mentor.first_name }} {{ mentor.last_name }}">
            {% endif %}
            {% if mentor.video_introduction_url %}
            <div class="mentor-avatar-overlay">
              <i class="fas fa-play"></i>
            </div>
            {% endif %}
          </div>
          <div class="mentor-title">
            <h4>{{ mentor.first_name }} {{ mentor.last_name }}</h4>
            <p class="mentor-specialty">{{ mentor.mentor_type|default:"Mentor" }}</p>
          </div>
        </div>
        
        <div class="mentor-details">
          {% if mentor.quote %}
            <p class="mentor-motto">"{{ mentor.quote }}"</p>
          {% endif %}
          {% if mentor.bio %}
            <div class="mentor-bio">{{ mentor.bio|safe|linebreaks|truncatewords:30 }}</div>
          {% endif %}
          {% if mentor.tags %}
            <div class="mentor-tags">
              {% for tag in mentor.tags|slice:":5" %}
                <span class="mentor-tag">{{ tag }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </div>
        
        <div class="mentor-footer">
          <div class="mentor-pricing-info">
            <p class="mentor-standard-session-label">Standard session</p>
            {% if mentor.price_per_hour %}
              <p class="mentor-price-length">
                ${{ mentor.price_per_hour|floatformat:0 }}
                {% if mentor.session_length %}
                  <span class="mentor-price-separator">/</span>
                  <span class="mentor-length-value">{{ mentor.session_length }} min</span>
                {% endif %}
              </p>
            {% else %}
              <p class="mentor-price-length">
                Contact<span> for pricing</span>
                {% if mentor.session_length %}
                  <span class="mentor-price-separator"> • </span>
                  <span class="mentor-length-value">{{ mentor.session_length }} min</span>
                {% endif %}
              </p>
            {% endif %}
          </div>
          <a href="{% url 'web:mentor_profile_detail' mentor.user.id %}" class="btn-mentor" onclick="event.stopPropagation()">
            {% if mentor.first_session_free %}
              {% if mentor.first_session_length %}
                <span class="btn-mentor-badge">{{ mentor.first_session_length }} min</span>
              {% endif %}
            {% endif %}
            {% if mentor.first_session_free %}
              First One Free
            {% else %}
              View Profile
            {% endif %}
          </a>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
        <p style="font-size: 1.1rem; color: var(--text-light);">No mentors found matching your criteria.</p>
        <p style="font-size: 0.9rem; color: var(--text-light); margin-top: 8px;">Try adjusting your filters.</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Loading indicator for infinite scroll -->
  <div id="mentorsLoading" style="display: none; text-align: center; padding: 40px 20px;">
    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p style="margin-top: 16px; color: var(--text-light);">Loading more mentors...</p>
  </div>
  
  <!-- No more mentors message -->
  <div id="mentorsEnd" style="display: none; text-align: center; padding: 40px 20px;">
    <p style="color: var(--text-light);">No more mentors to load.</p>
  </div>
  
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</section>

<!-- Footer -->
<footer class="site-footer">
  <div class="container">
    <div class="footer-grid">
      <div class="footer-brand">
        <h3>Healthy Mentoring</h3>
        <p>A data-driven platform with a holistic approach—real human connection, powered by AI.</p>
        <div class="social-links">
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-linkedin"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-links">
        <h4>Platform</h4>
        <a href="{% url 'web:mentors' %}">Mentors</a>
        <a href="/#business-lab">Business Lab</a>
        <a href="#">Pricing</a>
      </div>
      <div class="footer-links">
        <h4>Company</h4>
        <a href="#">About</a>
        <a href="#">Careers</a>
        <a href="#" id="contact-link">Contact</a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; {% now "Y" %} Healthy Mentoring. All rights reserved.</p>
    </div>
  </div>
</footer>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/landing.js' %}"></script>
<script src="{% static 'js/search-interactions.js' %}"></script>

<!-- Predefined data for filters -->
{{ predefined_categories|json_script:"predefinedCategoriesData" }}
{{ predefined_languages|json_script:"predefinedLanguagesData" }}
{{ current_page|json_script:"currentPageData" }}
{{ has_next|json_script:"hasNextData" }}

<script src="{% static 'js/mentors-search.js' %}"></script>
<script data-search-url="{% url 'web:mentor_search_suggestions' %}" data-load-more-url="{% url 'web:mentors_load_more' %}">
  // URLs are set via data attributes on this script tag
</script>

<!-- Video Modal Include -->
{% include 'dashboard_user/popups/video_modal.html' %}

<script>
// Handle mentor card clicks - support middle mouse button for new tab
function handleMentorCardClick(event, url) {
    // Middle mouse button (button === 1) or auxclick event opens in new tab
    if (event.button === 1 || event.type === 'auxclick') {
        event.preventDefault();
        event.stopPropagation();
        window.open(url, '_blank');
        return false;
    }
    // Ctrl+Click or Cmd+Click opens in new tab
    if (event.ctrlKey || event.metaKey) {
        event.preventDefault();
        event.stopPropagation();
        window.open(url, '_blank');
        return false;
    }
    // Left click - normal navigation
    if (event.button === 0 || event.type === 'click') {
        window.location.href = url;
    }
}

// Video modal functions (if not already defined)
if (typeof openVideoModal === 'undefined') {
    function extractVideoID(url) {
        if (!url) return null;
        // YouTube
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        if (match && match[2].length === 11) {
            return { type: 'youtube', id: match[2] };
        }
        // Vimeo
        const vimeoReg = /vimeo\.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)/;
        const vimeoMatch = url.match(vimeoReg);
        if (vimeoMatch) {
             return { type: 'vimeo', id: vimeoMatch[1] };
        }
        return null;
    }

    function openVideoModal(videoUrl) {
        const videoModal = document.getElementById('videoModal');
        const videoIframe = document.getElementById('videoIframe');
        
        if (!videoModal || !videoIframe) return;
        
        const videoData = extractVideoID(videoUrl);
        if (videoData) {
            if (videoData.type === 'youtube') {
                videoIframe.src = `https://www.youtube-nocookie.com/embed/${videoData.id}?autoplay=1&rel=0`;
            } else if (videoData.type === 'vimeo') {
                videoIframe.src = `https://player.vimeo.com/video/${videoData.id}?autoplay=1`;
            }
            videoModal.classList.add('open');
            document.body.style.overflow = 'hidden';
        } else {
            alert('Invalid video URL');
        }
    }

    function closeVideoModal() {
        const videoModal = document.getElementById('videoModal');
        const videoIframe = document.getElementById('videoIframe');
        if (!videoModal) return;
        videoModal.classList.remove('open');
        document.body.style.overflow = '';
        setTimeout(() => {
            if (videoIframe) videoIframe.src = '';
        }, 300);
    }

    // Close on click outside
    document.addEventListener('click', (e) => {
        const videoModal = document.getElementById('videoModal');
        if (videoModal && e.target === videoModal) closeVideoModal();
    });
    
    // Close on ESC
    document.addEventListener('keydown', function(event) {
        const videoModal = document.getElementById('videoModal');
        if (event.key === "Escape" && videoModal && videoModal.classList.contains('open')) {
             closeVideoModal();
        }
    });
}
</script>
{% endblock %}
