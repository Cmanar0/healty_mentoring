{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Mentor Dashboard{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <!-- PART 1: Actionable Items -->
    <div class="dashboard-part">
        <div class="dashboard-main-flex">
            
            <!-- Left Column (2/3) -->
            <div class="dashboard-col-left">
                <!-- Stats Card -->
                <div class="dashboard-card stats-card-compact" id="statsCard">
                    <div class="card-header">
                        <h3 class="card-title">Stats</h3>
                        <div class="stats-period-dropdown">
                            <button class="stats-period-trigger" id="statsPeriodTrigger">
                                <span class="period-label">This Week</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="stats-period-menu" id="statsPeriodMenu">
                                <button class="stats-period-item">Today</button>
                                <button class="stats-period-item active">This Week</button>
                                <button class="stats-period-item">This Month</button>
                                <button class="stats-period-item">Last Month</button>
                                <button class="stats-period-item">All Time</button>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid-compact">
                        <!-- Priority Stats -->
                        <div class="stat-card-compact primary">
                            <div class="stat-card-compact-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                            <div class="stat-card-compact-content">
                                <span class="stat-card-compact-label">Earned</span>
                                <span class="stat-card-compact-value">€1,250</span>
                                <span class="stat-card-compact-change positive">+12%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card-compact secondary">
                            <div class="stat-card-compact-icon">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div class="stat-card-compact-content">
                                <span class="stat-card-compact-label">Sessions</span>
                                <span class="stat-card-compact-value">14</span>
                                <span class="stat-card-compact-change neutral">2 upcoming</span>
                            </div>
                        </div>

                        <!-- Compact Stats -->
                        <div class="stat-mini">
                            <div class="stat-mini-icon blue">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-mini-content">
                                <span class="stat-mini-value">8</span>
                                <span class="stat-mini-label">Active Clients</span>
                            </div>
                        </div>

                        <div class="stat-mini">
                            <div class="stat-mini-icon green">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="stat-mini-content">
                                <span class="stat-mini-value">3</span>
                                <span class="stat-mini-label">New Clients</span>
                            </div>
                        </div>

                        <div class="stat-mini">
                            <div class="stat-mini-icon purple">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="stat-mini-content">
                                <span class="stat-mini-value">2</span>
                                <span class="stat-mini-label">Blog Posts</span>
                            </div>
                        </div>

                        <div class="stat-mini">
                            <div class="stat-mini-icon orange">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-mini-content">
                                <span class="stat-mini-value">640</span>
                                <span class="stat-mini-label">ProfileViews</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Sessions Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card">
                    <div class="card-header" style="align-items: flex-start;">
                        <h3 class="card-title">Upcoming Sessions</h3>
                        <div style="display: flex; gap: 16px; align-items: center; white-space: nowrap;">
                            <button class="btn-link" data-open-mentor-calendar data-mentor-calendar-initial-mode="sessions" style="background: none; border: none; padding: 0; cursor: pointer; font-family: inherit; font-size: inherit;">View Calendar</button>
                            <a href="http://localhost:8000/dashboard/mentor/my-sessions/" class="btn-link" style="color: var(--dash-text-muted);">View All Sessions</a>
                        </div>
                    </div>
                    
                    <style>
                      .first-session-tag {
                        display: inline-block;
                        background: #ef4444;
                        color: #ffffff;
                        font-size: 10px;
                        font-weight: 700;
                        padding: 2px 5px;
                        border-radius: 3px;
                        margin-left: 6px;
                        line-height: 1.2;
                        vertical-align: middle;
                      }
                    </style>
                    
                    <div class="session-timeline-container scrollable-content" id="dashboardUpcomingSessions">
                        {% if upcoming_sessions %}
                            {% for session in upcoming_sessions %}
                                <div class="session-item status-{{ session.status }}">
                                    <div class="session-left">
                                        <div class="session-date">
                                            <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                                            <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
                                        </div>
                                        <div class="session-info">
                                            <h4 class="session-title">Session with {{ session.client_name }}{% if session.is_first_session %} <span class="first-session-tag">1st</span>{% endif %}</h4>
                                            <div class="session-meta-row">
                                                <span class="session-time">
                                                    <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                                                </span>
                                                <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                                                    {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="session-right">
                                        <div class="dropdown">
                                            <button class="session-action-btn" onclick="toggleDropdown(this)">
                                                <i class="fas fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-menu">
                                                <button class="dropdown-item">View Details</button>
                                                <button class="dropdown-item">Edit Session</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            
                            {% if has_more_sessions %}
                                <div class="session-item session-item-view-all" style="border-left: none; padding: 16px; text-align: center;">
                                    <a href="http://localhost:8000/dashboard/mentor/my-sessions/" class="btn-link" style="color: var(--dash-text-muted); font-weight: 500;">View all upcoming sessions</a>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
                                <p>No upcoming sessions</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column (1/3) -->
            <div class="dashboard-col-right">
                <!-- Create New Section -->
                <div class="create-new-section" id="createNewSection">
                    <h3 class="create-new-title">Create new</h3>
                    <div class="create-new-grid">
                        <button class="create-new-btn btn-session" data-open-mentor-calendar data-mentor-calendar-initial-mode="sessions">
                            <div class="create-icon"><i class="fas fa-calendar-plus"></i></div>
                            <span class="create-label">Session</span>
                        </button>
                        <button class="create-new-btn btn-user" onclick="openInviteClientModal()">
                            <div class="create-icon"><i class="fas fa-user-plus"></i></div>
                            <span class="create-label">User</span>
                        </button>
                        <button class="create-new-btn btn-project" onclick="openCreateProjectModal()">
                            <div class="create-icon"><i class="fas fa-project-diagram"></i></div>
                            <span class="create-label">Project</span>
                        </button>
                        <button class="create-new-btn btn-marketing">
                            <div class="create-icon"><i class="fas fa-bullhorn"></i></div>
                            <span class="create-label">Marketing</span>
                        </button>
                        <a href="{% url 'general:dashboard_mentor:blog_create' %}" class="create-new-btn btn-blog">
                            <div class="create-icon"><i class="fas fa-pen-nib"></i></div>
                            <span class="create-label">Blog Post</span>
                        </a>
                    </div>
                </div>

                <!-- Your Backlog Card (Scrollable) -->
                <div class="dashboard-card flex-scroll-card" id="backlogCard">
                    <div class="card-header">
                        <h3 class="card-title">Your backlog</h3>
                        <a href="#" class="btn-link btn-fixed-width">View All</a>
                    </div>

                    <div class="scrollable-content">
                        <div class="task-row">
                            <div class="status-circle orange"></div>
                            <div class="task-info">
                                <span class="task-name">Review session notes for Anna</span>
                                <span class="task-status-text">Before next call</span>
                            </div>
                            <div class="completion-circle" onclick="toggleTask(this)">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="dropdown">
                                <button class="action-btn ghost" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item">Open Notes</button>
                                    <button class="dropdown-item">Reschedule</button>
                                </div>
                            </div>
                        </div>

                        <div class="task-row">
                            <div class="status-circle red"></div>
                            <div class="task-info">
                                <span class="task-name">Confirm agenda with Michael</span>
                                <span class="task-status-text">Overdue</span>
                            </div>
                            <div class="completion-circle" onclick="toggleTask(this)">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="dropdown">
                                <button class="action-btn ghost" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item">Send Reminder</button>
                                    <button class="dropdown-item" style="color: var(--status-red);">
                                        Mark as Not Relevant
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="task-row">
                            <div class="status-circle green"></div>
                            <div class="task-info">
                                <span class="task-name">Prepare feedback for Leadership Program</span>
                                <span class="task-status-text">Due this week</span>
                            </div>
                            <div class="completion-circle" onclick="toggleTask(this)">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="dropdown">
                                <button class="action-btn ghost" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item">View Details</button>
                                </div>
                            </div>
        </div>

                        <!-- Extra tasks to fill height -->
                        <div class="task-row">
                            <div class="status-circle blue"></div>
                            <div class="task-info">
                                <span class="task-name">Update mentorship profile</span>
                                <span class="task-status-text">Profile visibility</span>
                            </div>
                            <div class="completion-circle" onclick="toggleTask(this)">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="dropdown">
                                <button class="action-btn ghost" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <button class="dropdown-item">Edit Profile</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- PART 2: Education & Platform Usage -->
    <div class="dashboard-part">
        <div class="dashboard-grid">
            <!-- Promotion Education (Col 6) -->
            <div class="dashboard-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title">Get more clients with Healthy Mentoring</h3>
                </div>
                <div class="education-content">
                    <p>
                        Use your profile and content to position yourself for the right mentees.
                    </p>
                    <ul class="education-list">
                        <li>Keep your bio and expertise areas up to date.</li>
                        <li>Tag your profile with the topics you really want to work on.</li>
                        <li>Publish short blog posts to share your perspective and build trust.</li>
                        <li>Offer a limited number of free intro sessions to new clients.</li>
                    </ul>
                    <button class="btn btn-outline btn-sm" type="button">
                        Learn how to optimise your profile
                    </button>
                </div>
        </div>
        
            <!-- Platform Education (Col 6) -->
            <div class="dashboard-card col-span-6">
                <div class="card-header">
                    <h3 class="card-title">Master our tools to provide the best value to your clients</h3>
                </div>
                <div class="education-content">
                    <p>
                        Understanding our tools will make you more efficient and professional.
                    </p>
                    <ul class="education-list">
                        <li>Use sessions to track goals, notes and agreed action items.</li>
                        <li>Group projects by client to see their full journey in one place.</li>
                        <li>Review your stats regularly to adjust capacity and pricing.</li>
                        <li>Turn on notifications so you never miss an upcoming session.</li>
                    </ul>
                    <button class="btn btn-outline btn-sm" type="button">
                        View mentor guide
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page-specific JS: stats dropdown -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Stats Period Dropdown
    const statsPeriodTrigger = document.getElementById('statsPeriodTrigger');
    const statsPeriodMenu = document.getElementById('statsPeriodMenu');
    const statsPeriodDropdown = document.querySelector('.stats-period-dropdown');

    if (statsPeriodTrigger && statsPeriodMenu) {
        statsPeriodTrigger.addEventListener('click', function(e) {
            e.stopPropagation();
            statsPeriodDropdown.classList.toggle('active');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (statsPeriodDropdown && !statsPeriodDropdown.contains(event.target)) {
                statsPeriodDropdown.classList.remove('active');
            }
        });

        // Handle period selection
        const periodItems = statsPeriodMenu.querySelectorAll('.stats-period-item');
        periodItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active from all
                periodItems.forEach(i => i.classList.remove('active'));
                // Add active to clicked
                this.classList.add('active');
                // Update label
                const label = statsPeriodTrigger.querySelector('.period-label');
                label.textContent = this.textContent;
                // Close dropdown
                statsPeriodDropdown.classList.remove('active');
            });
        });
    }
});

// Invite Client Modal
function openInviteClientModal() {
    document.getElementById('inviteClientModal').classList.add('active');
    document.getElementById('clientEmailInput').focus();
}

function closeInviteClientModal() {
    document.getElementById('inviteClientModal').classList.remove('active');
    document.getElementById('inviteClientForm').reset();
    const messageDiv = document.getElementById('inviteClientMessage');
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}

// Handle invite client form submission
document.addEventListener('DOMContentLoaded', function() {
    const inviteForm = document.getElementById('inviteClientForm');
    if (inviteForm) {
        inviteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('clientEmailInput').value.trim();
            const submitBtn = document.getElementById('inviteClientSubmit');
            const messageDiv = document.getElementById('inviteClientMessage');
            
            if (!email) {
                if (messageDiv) {
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'invite-message error';
                    messageDiv.textContent = 'Please enter an email address.';
                }
                return;
            }
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('{% url "general:dashboard_mentor:invite_client" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.className = 'invite-message success';
                        messageDiv.textContent = data.message;
                    }
                    // Don't close modal, keep it open to show success message
                } else {
                    if (messageDiv) {
                        messageDiv.style.display = 'block';
                        messageDiv.className = 'invite-message error';
                        messageDiv.textContent = data.error || 'An error occurred. Please try again.';
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Send Invitation';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (messageDiv) {
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'invite-message error';
                    messageDiv.textContent = 'An error occurred. Please try again.';
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Invitation';
            });
        });
    }
    
    // Close modal on overlay click
    const inviteModal = document.getElementById('inviteClientModal');
    if (inviteModal) {
        inviteModal.addEventListener('click', function(e) {
            if (e.target === inviteModal) {
                closeInviteClientModal();
            }
        });
    }
});

// Close Invite Client modal on Escape
document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    const inviteModal = document.getElementById('inviteClientModal');
    if (!inviteModal) return;
    if (inviteModal.classList.contains('active')) {
        e.preventDefault();
        closeInviteClientModal();
    }
});
</script>

<!-- Invite Client Modal -->
<div id="inviteClientModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <button type="button" class="modal-close" onclick="closeInviteClientModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="modal-header">
            <h3 class="modal-title">Invite Client</h3>
            <p class="modal-subtitle">Enter the email address of the client you want to invite.</p>
        </div>
        
        <div style="margin-bottom: 20px; padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
            <p style="margin: 0; font-size: 0.9rem; color: #065f46; line-height: 1.5;">
                <strong>What happens when you invite:</strong><br>
                • The user will be added to your client list immediately<br>
                • An unverified account will be created for them<br>
                • They will receive an invitation email<br>
                • They can complete registration via a special link
            </p>
        </div>
        
        <form id="inviteClientForm">
            {% csrf_token %}
            <div style="margin-bottom: 20px;">
                <label for="clientEmailInput" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--dash-text-main);">Email Address</label>
                <input 
                    type="email" 
                    id="clientEmailInput" 
                    name="email" 
                    required 
                    placeholder="client@example.com"
                    style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;"
                >
            </div>
            
            <div id="inviteClientMessage" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 8px;"></div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeInviteClientModal()" style="padding: 10px 20px; background: transparent; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; color: var(--dash-text-main);">
                    Cancel
                </button>
                <button type="submit" id="inviteClientSubmit" style="padding: 10px 20px; background: var(--dash-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Send Invitation
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.invite-message {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    line-height: 1.5;
}

.invite-message.success {
    background: rgba(16, 185, 129, 0.1);
    color: #065f46;
    border-left: 3px solid #10b981;
}

.invite-message.error {
    background: rgba(239, 68, 68, 0.1);
    color: #991b1b;
    border-left: 3px solid #ef4444;
}
</style>

{# New mentor calendar popup (Sessions + Availability) #}
{% include "dashboard_mentor/calendar_mentor/calendar.html" %}

<script>
(function() {
  // Function to refresh dashboard upcoming sessions
  window.refreshDashboardUpcomingSessions = async function() {
    const container = document.getElementById('dashboardUpcomingSessions');
    if (!container) return;
    
    try {
      const response = await fetch('{% url "general:dashboard_mentor:get_dashboard_upcoming_sessions" %}', {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Clear existing content
        container.innerHTML = '';
        
        if (data.sessions && data.sessions.length > 0) {
          // Render sessions
          data.sessions.forEach(session => {
            const startDate = new Date(session.start_datetime);
            const endDate = new Date(session.end_datetime);
            
            const day = startDate.getDate();
            const month = startDate.toLocaleDateString('en-US', { month: 'short' });
            const startTime = startDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const endTime = endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            
            const statusClass = session.status === 'confirmed' ? 'confirmed' : 'tbc';
            const statusText = session.status === 'confirmed' ? 'Confirmed' : 'Invited';
            const statusStyle = session.status === 'confirmed' 
              ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;'
              : 'background: rgba(251, 191, 36, 0.1); color: #f59e0b;';
            
            const firstSessionTag = session.is_first_session ? '<span class="first-session-tag">1st</span>' : '';
            
            const sessionHTML = `
              <div class="session-item status-${session.status}">
                <div class="session-left">
                  <div class="session-date">
                    <span class="date-day">${day}</span>
                    <span class="date-month">${month}</span>
                  </div>
                  <div class="session-info">
                    <h4 class="session-title">Session with ${session.client_name} ${firstSessionTag}</h4>
                    <div class="session-meta-row">
                      <span class="session-time">
                        <i class="far fa-clock"></i> ${startTime} - ${endTime}
                      </span>
                      <span class="conf-tag ${statusClass}" style="${statusStyle}">
                        ${statusText}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="session-right">
                  <div class="dropdown">
                    <button class="session-action-btn" onclick="toggleDropdown(this)">
                      <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <div class="dropdown-menu">
                      <button class="dropdown-item">View Details</button>
                      <button class="dropdown-item">Edit Session</button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            
            container.insertAdjacentHTML('beforeend', sessionHTML);
          });
          
          // Add "View all" link if there are more sessions
          if (data.has_more_sessions) {
            const viewAllHTML = `
              <div class="session-item session-item-view-all" style="border-left: none; padding: 16px; text-align: center;">
                <a href="http://localhost:8000/dashboard/mentor/my-sessions/" class="btn-link" style="color: var(--dash-text-muted); font-weight: 500;">View all upcoming sessions</a>
              </div>
            `;
            container.insertAdjacentHTML('beforeend', viewAllHTML);
          }
        } else {
          // No sessions
          container.innerHTML = `
            <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
              <p>No upcoming sessions</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Error refreshing dashboard upcoming sessions:', error);
    }
  };
})();
</script>

<!-- Include Create Project Modal -->
{% include "general/modals/create_project_modal.html" %}
{% endblock %}
