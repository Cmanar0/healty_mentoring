{% extends "base.html" %}
{% load static %}

{% block title %}{% block page_title %}Mentor Dashboard{% endblock %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/notifications.css' %}">
<!-- Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<!-- Flag Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.0.0/css/flag-icons.min.css">
{% endblock %}

{% block navbar %}
<header class="dashboard-header">
  <nav class="dashboard-top-nav">
    <div class="dashboard-nav-left">
      <button class="hamburger-toggle" id="hamburgerToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="{% url 'web:landing' %}" class="dashboard-logo-link">
        <img src="{% static 'images/logo.png' %}" alt="logo" class="logo">
      </a>
    </div>
    <div class="dashboard-top-actions">
      {% if user.is_authenticated and user.profile.first_name and user.profile.last_name %}
        {% if user.profile.role == 'mentor' %}
        <div class="navbar-ai-coins" id="navbarAiCoins" title="AI Coins">
          <i class="fas fa-coins"></i>
          <span class="navbar-ai-coins-value">{{ mentor_ai_coins|default:0 }}</span>
        </div>
        {% endif %}
        <div class="dashboard-top-actions-group" style="display: none !important;">
          <!-- Timezone Test Button (for testing only - only shown in DEBUG mode) -->
          {% if debug %}
          <div class="timezone-test-dropdown">
            <button class="timezone-test-btn" id="timezoneTestBtn" aria-label="Test Timezone Checker" title="Test Timezone Checker">
              <i class="fas fa-globe"></i>
            </button>
            <div class="timezone-test-menu" id="timezoneTestMenu" style="display: none !important;">
              <div class="timezone-test-header">
                <h4>Test Timezone Checker</h4>
                <p>Select a test timezone to simulate mismatch</p>
              </div>
              <div class="timezone-test-options">
                <button class="timezone-test-option" data-timezone="Europe/London">Europe/London</button>
                <button class="timezone-test-option" data-timezone="America/New_York">America/New_York</button>
                <button class="timezone-test-option" data-timezone="Asia/Tokyo">Asia/Tokyo</button>
                <button class="timezone-test-option" data-timezone="Australia/Sydney">Australia/Sydney</button>
                <button class="timezone-test-option" data-timezone="Europe/Berlin">Europe/Berlin</button>
                <button class="timezone-test-option" data-timezone="America/Los_Angeles">America/Los_Angeles</button>
              </div>
              <div class="timezone-test-footer">
                <button class="timezone-test-reset" id="timezoneTestReset">Reset to Actual</button>
              </div>
            </div>
          </div>
          {% endif %}
          <!-- Notification Bell -->
          {% include "general/notifications/dropdown_snippet.html" %}
        </div>
          <div class="user-profile-dropdown">
          <button class="user-profile-trigger" id="userProfileTrigger" style="display: none !important;">
            <span class="user-name">{{ user.profile.first_name }} {{ user.profile.last_name }}</span>
            {# Inline sizing prevents flash-of-huge-avatar before CSS loads #}
            <div class="user-avatar" style="width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;">
              {% if user.profile.profile_picture %}
                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.first_name }}" width="36" height="36" style="width:36px;height:36px;object-fit:cover;border-radius:50%;display:block;">
              {% else %}
                <div class="avatar-placeholder">
                  <i class="fas fa-user"></i>
                </div>
              {% endif %}
            </div>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu" style="display: none !important;">
            <a href="/dashboard/mentor/account/" class="dropdown-item">
              <i class="fas fa-user"></i>
              <span>Account</span>
            </a>
            <a href="#" class="dropdown-item">
              <i class="fas fa-crown"></i>
              <span>Subscriptions</span>
            </a>
            <a href="/dashboard/mentor/settings/" class="dropdown-item">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <a href="/dashboard/mentor/billing/" class="dropdown-item">
              <i class="fas fa-credit-card"></i>
              <span>Billing</span>
            </a>
            <a href="/dashboard/mentor/support/" class="dropdown-item">
              <i class="fas fa-headset"></i>
              <span>Support</span>
            </a>
            <div class="dropdown-divider"></div>
            <form action="{% url 'accounts:logout' %}" method="post" class="dropdown-item-form">
          {% csrf_token %}
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </button>
        </form>
          </div>
        </div>
        </div>
      {% endif %}
    </div>
  </nav>
</header>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
  <!-- Left Sidebar -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <nav class="sidebar-nav">
      <ul class="sidebar-menu">
        <li>
          <a href="/dashboard/mentor/" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" title="Dashboard">
            <i class="fas fa-home"></i>
            <span class="sidebar-text">Dashboard</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/mentor/my-sessions/" class="sidebar-link {% if request.resolver_match.url_name == 'my_sessions' %}active{% endif %}" title="Sessions">
            <i class="fas fa-calendar"></i>
            <span class="sidebar-text">Sessions</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:mentor_backlog' %}" class="sidebar-link {% if request.resolver_match.url_name == 'mentor_backlog' %}active{% endif %}" title="Backlog">
            <i class="fas fa-clipboard-list"></i>
            <span class="sidebar-text">Backlog</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:clients_list' %}" class="sidebar-link {% if request.resolver_match.url_name == 'clients_list' %}active{% endif %}" title="Clients">
            <i class="fas fa-user-tie"></i>
            <span class="sidebar-text">Clients</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:projects_list' %}" class="sidebar-link {% if request.resolver_match.url_name == 'projects_list' %}active{% endif %}" title="Projects">
            <i class="fas fa-project-diagram"></i>
            <span class="sidebar-text">Projects</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:templates_list' %}" class="sidebar-link {% if request.resolver_match.url_name == 'templates_list' %}active{% endif %}" title="Templates">
            <i class="fas fa-layer-group"></i>
            <span class="sidebar-text">Templates</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link" title="Education">
            <i class="fas fa-graduation-cap"></i>
            <span class="sidebar-text">Education</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link" title="Tips">
            <i class="fas fa-lightbulb"></i>
            <span class="sidebar-text">Tips</span>
          </a>
        </li>
        <li class="your-section-divider"></li>
        <li>
          <a href="/dashboard/mentor/profile/" class="sidebar-link sidebar-link-your" title="Your Profile">
            <i class="fas fa-id-badge"></i>
            <span class="sidebar-text">Your Profile</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link sidebar-link-your" title="Your Community">
            <i class="fas fa-users"></i>
            <span class="sidebar-text">Your Community</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link sidebar-link-your" title="Your Marketing">
            <i class="fas fa-bullhorn"></i>
            <span class="sidebar-text">Your Marketing</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link sidebar-link-your" title="Your Courses">
            <i class="fas fa-book-open"></i>
            <span class="sidebar-text">Your Courses</span>
          </a>
        </li>
        <li>
          <a href="#" class="sidebar-link sidebar-link-your" title="Your Earnings">
            <i class="fas fa-euro-sign"></i>
            <span class="sidebar-text">Your Earnings</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:statistics' %}" class="sidebar-link sidebar-link-your" title="Your Statistics">
            <i class="fas fa-chart-line"></i>
            <span class="sidebar-text">Your Statistics</span>
          </a>
        </li>
        <li>
          <a href="{% url 'general:dashboard_mentor:blog_list' %}" class="sidebar-link sidebar-link-your {% if request.resolver_match.url_name == 'blog_list' or request.resolver_match.url_name == 'blog_create' or request.resolver_match.url_name == 'blog_edit' %}active{% endif %}" title="Your Blog">
            <i class="fas fa-pen-nib"></i>
            <span class="sidebar-text">Your Blog</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main" id="dashboardMain">
    {% block dashboard_content %}{% endblock %}
  </main>
</div>

<!-- Tutorial Manual Overlay -->
<div id="tutorialOverlay" class="tutorial-overlay" style="display: none;">
  <div class="tutorial-bubble" id="tutorialBubble">
    <button type="button" class="tutorial-close" id="tutorialClose">
      <i class="fas fa-times"></i>
    </button>
    <h3 class="tutorial-title" id="tutorialTitle"></h3>
    <p class="tutorial-text" id="tutorialText"></p>
  </div>
</div>

<!-- Manuals Data (JSON) -->
{{ user.profile.manuals|json_script:"manualsData" }}

<!-- User Profile Data (for timezone checking) -->
<script id="userProfileData" type="application/json">
{% if user.mentor_profile %}
{
    "detected_timezone": "{{ user.mentor_profile.detected_timezone|default_if_none:'' }}",
    "selected_timezone": "{{ user.mentor_profile.selected_timezone|default_if_none:'' }}",
    "confirmed_timezone_mismatch": {{ user.mentor_profile.confirmed_timezone_mismatch|yesno:"true,false" }},
    "session_length": {{ user.mentor_profile.session_length|default:60 }},
    "price_per_hour": {{ user.mentor_profile.price_per_hour|default_if_none:"null" }}
}
{% elif user.profile %}
{
    "detected_timezone": "{{ user.profile.detected_timezone|default_if_none:'' }}",
    "selected_timezone": "{{ user.profile.selected_timezone|default_if_none:'' }}",
    "confirmed_timezone_mismatch": {{ user.profile.confirmed_timezone_mismatch|yesno:"true,false" }},
    "session_length": 60,
    "price_per_hour": null
}
{% else %}
{
    "detected_timezone": "",
    "selected_timezone": "",
    "confirmed_timezone_mismatch": false,
    "session_length": 60,
    "price_per_hour": null
}
{% endif %}
</script>

{% include "general/modals/timezone_correction_modal.html" %}
{% include "general/modals/timezone_mismatch_modal.html" %}
{% endblock %}

{% block scripts %}
<script src="{% static 'js/notifications.js' %}"></script>
<!-- Cropper.js JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="{% static 'js/timezone-checker.js' %}"></script>
{{ block.super }}
<style>
:root {
  --primary: #10b981;
  --text-dark: #1e293b;
  --text-light: #94a3b8;
}

/* Hamburger hover - green bars, no background */
.hamburger-toggle:hover {
  background: transparent;
}

.hamburger-toggle:hover span {
  background: var(--primary);
}

/* User Profile Dropdown */
.user-profile-dropdown {
  position: relative;
  z-index: 10000;
}

.user-profile-trigger {
  display: flex;
  align-items: center;
  gap: 12px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  transition: none;
}

.user-profile-trigger:hover {
  background: transparent;
}

.user-profile-trigger:hover .user-name {
  color: var(--primary);
}

.user-name {
  font-weight: 500;
  color: var(--text-dark);
  font-size: 0.95rem;
  transition: color 0.2s ease;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 2px solid black;
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
  font-size: 0.9rem;
}

.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 200px;
  padding: 0;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 10000;
  display: block;
  pointer-events: none;
}

.user-profile-dropdown.active .user-dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.dropdown-item,
.dropdown-item-form {
  display: block;
  width: 100%;
  text-align: left;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: var(--text-dark);
  text-decoration: none;
  transition: background 0.2s ease;
  border: none;
  background: transparent;
  width: 100%;
  cursor: pointer;
  font-size: 0.95rem;
}

/* First button - rounded top corners */
.dropdown-item:first-child {
  border-radius: 12px 12px 0 0;
}

.dropdown-item:hover {
  background: rgba(16, 185, 129, 0.1);
  color: var(--primary);
}

/* First button hover - maintain top rounded corners */
.dropdown-item:first-child:hover {
  border-radius: 12px 12px 0 0;
}

.dropdown-item i {
  width: 20px;
  text-align: center;
  color: var(--text-light);
}

.dropdown-item:hover i {
  color: var(--primary);
}

.dropdown-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
}

.logout-item {
  margin-top: 0;
  border-radius: 0 0 12px 12px;
}

.logout-item:hover {
  border-radius: 0 0 12px 12px;
}

.logout-item i {
  color: #ef4444;
}

.logout-item:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

.logout-item:hover i {
  color: #ef4444;
}
.dashboard-top-actions  {
  display: flex;
}
/* Navbar AI Coins (mentor only, left of bell) */
.navbar-ai-coins {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 8px;
  color: #92400e;
  font-size: 0.9rem;
  font-weight: 600;
  margin-right: 8px;
}
.navbar-ai-coins i {
  color: #ca8a04;
}
.navbar-ai-coins-value {
  line-height: 1;
}

/* Dashboard Top Actions Group */
.dashboard-top-actions-group {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Timezone Test Button (for testing only) */
.timezone-test-dropdown {
  position: relative;
}

.timezone-test-btn {
  position: relative;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--text-dark);
  font-size: 1rem;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.timezone-test-btn:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--primary);
}

.timezone-test-btn i {
  display: block;
}

.timezone-test-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 240px;
  padding: 0;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
  display: block;
  pointer-events: none;
}

.timezone-test-dropdown.active .timezone-test-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.timezone-test-header {
  padding: 16px;
  border-bottom: 1px solid var(--dash-border);
}

.timezone-test-header h4 {
  margin: 0 0 4px 0;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-dark);
}

.timezone-test-header p {
  margin: 0;
  font-size: 0.85rem;
  color: var(--text-light);
}

.timezone-test-options {
  padding: 8px 0;
  max-height: 300px;
  overflow-y: auto;
}

.timezone-test-option {
  display: block;
  width: 100%;
  padding: 10px 16px;
  background: white;
  border: none;
  text-align: left;
  cursor: pointer;
  font-size: 0.9rem;
  color: var(--text-dark);
  transition: background 0.2s;
}

.timezone-test-option:hover {
  background: rgba(16, 185, 129, 0.1);
  color: var(--primary);
}

.timezone-test-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--dash-border);
}

.timezone-test-reset {
  width: 100%;
  padding: 8px 16px;
  background: transparent;
  border: 1px solid var(--dash-border);
  border-radius: 8px;
  color: var(--text-dark);
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.timezone-test-reset:hover {
  background: #f8fafc;
  border-color: var(--primary);
  color: var(--primary);
}

/* Notification Bell */
.notification-dropdown {
  position: relative;
}

.notification-bell {
  position: relative;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--text-dark);
  font-size: 1.2rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
}

.notification-bell:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--primary);
}

.notification-bell i {
  display: block;
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
}

.notification-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  width: 380px;
  max-width: 90vw;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  height: 500px;
  pointer-events: none;
}

.notification-dropdown.active .notification-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.notification-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.notification-menu-header h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-dark);
}

.mark-all-read-btn {
  background: transparent;
  border: none;
  color: var(--primary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.mark-all-read-btn:hover {
  background: rgba(16, 185, 129, 0.1);
}

.notification-list {
  flex: 1;
  overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
  width: 6px;
}

.notification-list::-webkit-scrollbar-track {
  background: transparent;
}

.notification-list::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
}

.notification-item {
  display: flex;
  gap: 12px;
  padding: 12px 20px;
  transition: background 0.2s ease;
  cursor: pointer;
  border-left: 3px solid transparent;
}

.notification-item:hover {
  background: rgba(0, 0, 0, 0.03);
}

.notification-item.unread {
  background: rgba(16, 185, 129, 0.05);
  border-left-color: var(--primary);
}

.notification-item.unread:hover {
  background: rgba(16, 185, 129, 0.08);
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(16, 185, 129, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: var(--primary);
  font-size: 0.9rem;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-title {
  margin: 0 0 4px 0;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-dark);
  line-height: 1.4;
}

.notification-time {
  margin: 0;
  font-size: 0.8rem;
  color: var(--text-light);
}

.notification-footer {
  padding: 12px 20px;
  border-top: 1px solid rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  text-decoration: none;
  cursor: pointer;
  transition: background 0.2s ease;
  color: inherit;
}

.notification-footer:hover {
  background: rgba(16, 185, 129, 0.05);
}

.view-all-notifications {
  color: var(--primary);
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  transition: color 0.2s ease;
}

.notification-footer:hover .view-all-notifications {
  color: var(--dash-primary-hover);
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const hamburgerToggle = document.getElementById('hamburgerToggle');
  const sidebar = document.getElementById('dashboardSidebar');
  const dashboardLayout = document.querySelector('.dashboard-layout');

  if (hamburgerToggle && sidebar && dashboardLayout) {
    // Check if sidebar should start collapsed (from localStorage)
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      hamburgerToggle.classList.add('active');
    }

    hamburgerToggle.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      hamburgerToggle.classList.toggle('active');
      
      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      
      // Recalculate roadmap container height if function exists (for project detail pages)
      setTimeout(() => {
        if (typeof setRoadmapContainerMaxHeight === 'function') {
          setRoadmapContainerMaxHeight();
        }
      }, 300); // Wait for sidebar transition to complete
    });

    // Close sidebar when clicking outside on mobile
    if (window.innerWidth <= 768) {
      document.addEventListener('click', function(event) {
        if (!sidebar.contains(event.target) && !hamburgerToggle.contains(event.target)) {
          sidebar.classList.remove('open');
          hamburgerToggle.classList.remove('active');
        }
      });
    }
  }

  // Notification Bell Dropdown
  const notificationBell = document.getElementById('notificationBell');
  const notificationMenu = document.getElementById('notificationMenu');
  const notificationDropdown = document.querySelector('.notification-dropdown');
  const dashboardTopActionsGroup = document.querySelector('.dashboard-top-actions-group');

  // Remove inline display:none immediately so CSS can control visibility (prevents flash)
  if (dashboardTopActionsGroup) {
    dashboardTopActionsGroup.style.display = '';
  }

  if (notificationBell && notificationMenu) {
    // Remove inline display:none immediately so CSS can control visibility (prevents flash)
    notificationMenu.style.display = '';
    
    notificationBell.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationDropdown.classList.toggle('active');
      // Close user profile dropdown if open
      if (userProfileDropdown) {
        userProfileDropdown.classList.remove('active');
      }
    });

    // Mark all as read button - handle form submission
    const markAllReadForm = document.querySelector('.mark-all-read-form');
    if (markAllReadForm) {
      markAllReadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload the page to refresh notifications
            window.location.reload();
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });
    }
  }

  // Timezone Test Dropdown
  const timezoneTestBtn = document.getElementById('timezoneTestBtn');
  const timezoneTestMenu = document.getElementById('timezoneTestMenu');
  const timezoneTestDropdown = document.querySelector('.timezone-test-dropdown');
  const timezoneTestOptions = document.querySelectorAll('.timezone-test-option');
  const timezoneTestReset = document.getElementById('timezoneTestReset');

  if (timezoneTestBtn && timezoneTestMenu) {
    // Remove inline display:none immediately so CSS can control visibility (prevents flash)
    timezoneTestMenu.style.display = '';
    
    timezoneTestBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      timezoneTestDropdown.classList.toggle('active');
      // Close other dropdowns
      if (notificationDropdown) notificationDropdown.classList.remove('active');
      if (userProfileDropdown) userProfileDropdown.classList.remove('active');
      
      // Log current timezone status
      const userProfileData = document.getElementById('userProfileData');
      const savedTimezone = userProfileData ? JSON.parse(userProfileData.textContent).time_zone : 'Not found';
      const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const testTimezone = sessionStorage.getItem('TEST_TIMEZONE') || window.TEST_TIMEZONE || null;
      
      console.log('ðŸŒ === TIMEZONE STATUS ===');
      console.log('ðŸ“Œ Saved timezone:', savedTimezone || '(not set)');
      console.log('ðŸ” Detected timezone:', detectedTimezone);
      console.log('ðŸ§ª Test timezone:', testTimezone || '(none - using detected)');
      console.log('ðŸ“Š Will use for check:', testTimezone || detectedTimezone);
      console.log('========================');
    });

    // Handle timezone option clicks
    timezoneTestOptions.forEach(option => {
      option.addEventListener('click', function() {
        const testTimezone = this.getAttribute('data-timezone');
        console.log('[Timezone Test] Setting test timezone:', testTimezone);
        
        // Set test timezone in sessionStorage (survives page reload)
        sessionStorage.setItem('TEST_TIMEZONE', testTimezone);
        window.TEST_TIMEZONE = testTimezone; // Also set in window for immediate use
        
        // Close dropdown
        timezoneTestDropdown.classList.remove('active');
        
        // Reload page to trigger timezone check with test timezone
        console.log('[Timezone Test] Reloading page to show modal...');
        window.location.reload();
      });
    });

    // Reset button
    if (timezoneTestReset) {
      timezoneTestReset.addEventListener('click', function() {
        sessionStorage.removeItem('TEST_TIMEZONE');
        delete window.TEST_TIMEZONE;
        console.log('[Timezone Test] Reset - using actual detected timezone and clearing confirmed mismatch');
        
        // Get detected timezone
        let detectedTz;
        try {
          detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (e) {
          console.error('[Timezone Test] Could not detect timezone:', e);
          timezoneTestDropdown.classList.remove('active');
          window.location.reload();
          return;
        }
        
        // Clear confirmed_timezone_mismatch and set selected to detected via AJAX
        fetch('/dashboard/update-timezone/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            action: 'use_detected',
            detected_timezone: detectedTz
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('[Timezone Test] Confirmed mismatch cleared, selected timezone set to detected');
          }
          timezoneTestDropdown.classList.remove('active');
          window.location.reload();
        })
        .catch(error => {
          console.error('[Timezone Test] Error clearing mismatch:', error);
          timezoneTestDropdown.classList.remove('active');
          window.location.reload();
        });
      });
    }
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  }

  // User Profile Dropdown
  const userProfileTrigger = document.getElementById('userProfileTrigger');
  const userDropdownMenu = document.getElementById('userDropdownMenu');
  const userProfileDropdown = document.querySelector('.user-profile-dropdown');

  if (userProfileTrigger && userDropdownMenu) {
    // Remove inline display:none immediately so CSS can control visibility (prevents flash)
    userDropdownMenu.style.display = '';
    userProfileTrigger.style.display = '';
    
    userProfileTrigger.addEventListener('click', function(e) {
      e.stopPropagation();
      userProfileDropdown.classList.toggle('active');
      // Close notification dropdown if open
      if (notificationDropdown) {
        notificationDropdown.classList.remove('active');
      }
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (userProfileDropdown && !userProfileDropdown.contains(event.target)) {
      userProfileDropdown.classList.remove('active');
    }
    if (notificationDropdown && !notificationDropdown.contains(event.target)) {
      notificationDropdown.classList.remove('active');
    }
    if (timezoneTestDropdown && !timezoneTestDropdown.contains(event.target)) {
      timezoneTestDropdown.classList.remove('active');
    }
  });

  // Helper function to check timezone status (available in console)
  window.checkTimezone = function() {
    const userProfileData = document.getElementById('userProfileData');
    const savedTimezone = userProfileData ? JSON.parse(userProfileData.textContent).time_zone : 'Not found';
    const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const testTimezone = sessionStorage.getItem('TEST_TIMEZONE') || window.TEST_TIMEZONE || null;
    
    console.log('ðŸŒ === TIMEZONE STATUS ===');
    console.log('ðŸ“Œ Saved timezone:', savedTimezone || '(not set)');
    console.log('ðŸ” Detected timezone:', detectedTimezone);
    console.log('ðŸ§ª Test timezone:', testTimezone || '(none - using detected)');
    console.log('ðŸ“Š Will use for check:', testTimezone || detectedTimezone);
    console.log('ðŸ’¾ sessionStorage.TEST_TIMEZONE:', sessionStorage.getItem('TEST_TIMEZONE') || '(not set)');
    console.log('ðŸªŸ window.TEST_TIMEZONE:', window.TEST_TIMEZONE || '(not set)');
    console.log('========================');
    
    return {
      saved: savedTimezone,
      detected: detectedTimezone,
      test: testTimezone,
      willUse: testTimezone || detectedTimezone
    };
  };
  
  console.log('ðŸ’¡ Tip: Type checkTimezone() in console to see current timezone status');

  // Tutorial Manual System
  let manuals = [];
  let currentManualIndex = 0;
  
  try {
    const manualsDataElement = document.getElementById('manualsData');
    if (manualsDataElement) {
      manuals = JSON.parse(manualsDataElement.textContent);
      // Filter out displayed manuals
      manuals = manuals.filter(m => !m.displayed);
      console.log('Loaded manuals:', manuals);
    }
  } catch (error) {
    console.error('Error parsing manuals data:', error);
  }

  function showTutorialManual(manual) {
    console.log('Showing tutorial manual:', manual);
    const overlay = document.getElementById('tutorialOverlay');
    const bubble = document.getElementById('tutorialBubble');
    const title = document.getElementById('tutorialTitle');
    const text = document.getElementById('tutorialText');
    
    if (!overlay || !bubble || !title || !text) {
      console.error('Tutorial elements not found');
      return;
    }

    // Find target element by ID (manual.id now refers to DOM element ID)
    let targetElement = document.getElementById(manual.id);
    
    if (!targetElement) {
      console.warn('Target element not found for ID:', manual.id);
      console.warn('Skipping this manual (will try again next time)');
      // Skip this manual and show next one WITHOUT marking as displayed
      // This way it won't be removed if the element doesn't exist yet
      currentManualIndex++;
      if (currentManualIndex < manuals.length) {
        setTimeout(() => {
          showTutorialManual(manuals[currentManualIndex]);
        }, 300);
      }
      return;
    }
    
    console.log('Target element found:', targetElement);

    // Add highlight class to target element to prevent blur
    targetElement.classList.add('tutorial-highlight');

    // Set content
    title.textContent = manual.title;
    text.textContent = manual.text;

    // Show overlay
    overlay.style.display = 'block';
    setTimeout(() => {
      overlay.classList.add('active');
    }, 10);

    // Position bubble using coordinates from manual.position
    positionBubbleByCoordinates(targetElement, bubble, manual.position);
  }

  function positionBubbleByCoordinates(targetElement, bubble, position) {
    const rect = targetElement.getBoundingClientRect();
    const bubbleRect = bubble.getBoundingClientRect();
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;

    let top, left;

    // position can be an object with x, y offsets or a string like "top", "bottom", etc.
    if (typeof position === 'object' && position.x !== undefined && position.y !== undefined) {
      // Use coordinates relative to target element
      top = rect.top + scrollY + position.y;
      left = rect.left + scrollX + position.x;
    } else if (typeof position === 'string') {
      // Fallback to string-based positioning for backward compatibility
      switch(position) {
        case 'top':
          top = rect.top + scrollY - bubbleRect.height - 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
          break;
        case 'bottom':
          top = rect.bottom + scrollY + 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
          break;
        case 'left':
          top = rect.top + scrollY + (rect.height / 2) - (bubbleRect.height / 2);
          left = rect.left + scrollX - bubbleRect.width - 16;
          break;
        case 'right':
          top = rect.top + scrollY + (rect.height / 2) - (bubbleRect.height / 2);
          left = rect.right + scrollX + 16;
          break;
        default:
          top = rect.bottom + scrollY + 16;
          left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
      }
    } else {
      // Default: bottom center
      top = rect.bottom + scrollY + 16;
      left = rect.left + scrollX + (rect.width / 2) - (bubbleRect.width / 2);
    }

    // Keep bubble within viewport
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;

    if (left < 20) left = 20;
    if (left + bubbleRect.width > viewportWidth - 20) {
      left = viewportWidth - bubbleRect.width - 20;
    }
    if (top < 20) top = 20;
    if (top + bubbleRect.height > viewportHeight - 20) {
      top = viewportHeight - bubbleRect.height - 20;
    }

    bubble.style.top = top + 'px';
    bubble.style.left = left + 'px';
  }

  function closeTutorial() {
    const overlay = document.getElementById('tutorialOverlay');
    overlay.classList.remove('active');
    
    // Remove highlight class from all elements
    document.querySelectorAll('.tutorial-highlight').forEach(el => {
      el.classList.remove('tutorial-highlight');
    });
    
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);

    // Mark current manual as displayed
    if (manuals[currentManualIndex]) {
      markManualAsDisplayed(manuals[currentManualIndex].id);
    }
  }

  function markManualAsDisplayed(manualId) {
    fetch('{% url "general:mark_manual_displayed" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ manual_id: manualId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show next manual if available
        currentManualIndex++;
        if (currentManualIndex < manuals.length) {
          setTimeout(() => {
            showTutorialManual(manuals[currentManualIndex]);
          }, 300);
        }
      }
    })
    .catch(error => {
      console.error('Error marking manual as displayed:', error);
    });
  }

  // Initialize tutorial on page load
  function initTutorial() {
    if (manuals && manuals.length > 0) {
      console.log('Initializing tutorial with', manuals.length, 'manuals');
      // Wait for page to fully load and DOM to be ready
      setTimeout(() => {
        showTutorialManual(manuals[0]);
      }, 1000);
    } else {
      console.log('No manuals to display');
    }
  }

  // Wait for DOM to be fully loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTutorial);
  } else {
    // DOM is already loaded
    window.addEventListener('load', initTutorial);
  }

  // Close tutorial handlers
  const tutorialClose = document.getElementById('tutorialClose');
  const tutorialOverlay = document.getElementById('tutorialOverlay');

  if (tutorialClose) {
    tutorialClose.addEventListener('click', closeTutorial);
  }

  if (tutorialOverlay) {
    tutorialOverlay.addEventListener('click', function(e) {
      if (e.target === tutorialOverlay) {
        closeTutorial();
      }
    });
  }

  // Notification Modal Functions (for dropdown snippet)
  window.openNotificationModal = function(notificationId) {
    const modal = document.getElementById('notificationModal');
    const content = document.getElementById('notificationModalContent');
    
    if (!modal || !content) {
      console.error('Notification modal elements not found');
      return;
    }
    
    // Show loading state
    content.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i></div>';
    modal.classList.add('active');
    
    // Fetch notification details
    const url = `/dashboard/mentor/notifications/${notificationId}/modal/`;
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.text())
    .then(html => {
      content.innerHTML = html;
      // Close dropdown
      if (notificationDropdown) {
        notificationDropdown.classList.remove('active');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading notification</div>';
    });
  };
  
  window.closeNotificationModal = function() {
    const modal = document.getElementById('notificationModal');
    if (modal) {
      modal.classList.remove('active');
      // Reload the page to refresh notifications
      window.location.reload();
    }
  };
  
  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('notificationModal');
      if (modal && modal.classList.contains('active')) {
        window.closeNotificationModal();
      }
    }
  });
  
  // Close modal when clicking on overlay
  const notificationModal = document.getElementById('notificationModal');
  if (notificationModal) {
    notificationModal.addEventListener('click', function(e) {
      if (e.target === notificationModal) {
        window.closeNotificationModal();
      }
    });
  }
  
  // Check for collisions on page load and handle accordingly
  (function() {
    // Only check if user is a mentor
    const userProfileDataEl = document.getElementById('userProfileData');
    if (!userProfileDataEl) return;
    
    const currentPath = window.location.pathname;
    const isOnMySessionsPage = currentPath.includes('/my-sessions/');
    
    try {
      const userProfileData = JSON.parse(userProfileDataEl.textContent);
      const sessionLength = userProfileData.session_length;
      
      // Only check if session_length exists
      if (!sessionLength) return;
      
      // Check for collisions via API
      fetch('{% url "general:dashboard_mentor:check_availability_collisions" %}')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.has_collisions) {
            if (isOnMySessionsPage) {
              // We're already on my_sessions page - open new calendar and collision popups directly
              setTimeout(() => {
                if (typeof window.setOpenedFromSessionLengthChange === 'function') {
                  window.setOpenedFromSessionLengthChange(true);
                }

                if (window.MentorCalendar && typeof window.MentorCalendar.open === 'function') {
                  // Open in Availability mode
                  const trigger = document.querySelector('[data-open-mentor-calendar]') || null;
                  if (trigger && trigger.dataset) trigger.dataset.mentorCalendarInitialMode = 'availability';
                  window.MentorCalendar.open(trigger);

                  // After calendar opens, open collision popup in locked mode (only if collisions still exist)
                  setTimeout(() => {
                    try {
                      if (typeof window.getCalendarCollisions === 'function') {
                        const collisions = window.getCalendarCollisions() || [];
                        if (Array.isArray(collisions) && collisions.length === 0) {
                          if (typeof window.setOpenedFromSessionLengthChange === 'function') {
                            window.setOpenedFromSessionLengthChange(false);
                          }
                          return;
                        }
                      }
                    } catch (e) {}

                    if (typeof window.openCollisionResolutionPopup === 'function') {
                      window.openCollisionResolutionPopup(true);
                    }
                  }, 1500);
                } else {
                  // Calendar not loaded yet, use URL parameter approach
                  if (!window.location.search.includes('open_calendar=true')) {
                    window.location.href = window.location.pathname + '?open_calendar=true';
                  }
                }
              }, 500);
            } else {
              // Not on my_sessions page - redirect to my_sessions page
              // The my_sessions page will handle opening calendar and collision popups
              window.location.href = '{% url "general:dashboard_mentor:my_sessions" %}?open_calendar=true';
            }
          }
        })
        .catch(error => {
          console.error('Error checking for collisions:', error);
        });
    } catch (e) {
      console.error('Error parsing user profile data:', e);
    }
  })();
});
</script>
{% block extra_js %}{% endblock %}
{% endblock %}
