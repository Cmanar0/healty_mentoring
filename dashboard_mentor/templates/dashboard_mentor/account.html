{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}My Account{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="dashboard-grid">
        <!-- Profile Card -->
        <div class="dashboard-card col-span-4">
            <div class="card-header">
                <h3 class="card-title">Your Profile</h3>
            </div>
            <div style="text-align: center; padding: 10px 0 20px;">
                <div class="profile-avatar-large">
                    {% if user.profile.profile_picture %}
                        <img src="{{ user.profile.profile_picture.url }}" alt="Profile">
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <h3 style="margin: 0 0 4px; color: var(--dash-text-main);">{{ user.profile.first_name }} {{ user.profile.last_name }}</h3>
                {% with tag_list=user.profile.tags.all %}
                    {% if tag_list %}
                        <p style="margin: 0; color: var(--dash-text-muted); font-size: 0.9rem;">
                            {% for tag in tag_list %}
                                {{ tag.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </p>
                    {% else %}
                        <p style="margin: 0; color: var(--dash-text-muted);">Mentor</p>
                    {% endif %}
                {% endwith %}

                <!-- Profile completion circle (SVG) -->
                <div style="margin-top: 24px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div class="profile-completion-circle">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="progressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="var(--dash-primary)"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage">
                            <span id="completionText">{{ profile_completion|default:0 }}%</span>
                        </div>
                    </div>
                    <p style="margin: 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                        Profile completeness
                    </p>
                </div>

                <div style="margin: 24px 16px 0 0;">
                    <a href="/dashboard/mentor/profile/" class="btn btn-outline btn-sm">Update Profile</a>
                </div>
            </div>
        </div>

        <!-- Account Card -->
        <div class="dashboard-card col-span-8">
            <div class="card-header">
                <h3 class="card-title">Account</h3>
            </div>
            
            <form method="post" style="display: flex; flex-direction: column; gap: 24px;">
                {% csrf_token %}
                
                <!-- Name Section -->
                <div class="account-form-section">
                    <div class="form-section-header">
                        <h4>Name</h4>
                        <button type="submit" name="action" value="update_name" class="btn btn-primary btn-sm">Save</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                        <div>
                            <label>First Name</label>
                            <input type="text" name="first_name" value="{{ user.profile.first_name }}" class="form-input">
                        </div>
                        <div>
                            <label>Last Name</label>
                            <input type="text" name="last_name" value="{{ user.profile.last_name }}" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Email Section -->
                <div class="account-form-section">
                    <div class="form-section-header">
                        <h4>Email</h4>
                        <button type="submit" name="action" value="update_email" class="btn btn-primary btn-sm">Save</button>
                    </div>
                    <div style="margin-top: 12px;">
                        <label>Your email</label>
                        <input type="email" name="email" value="{{ user.email }}" class="form-input">
                    </div>
                </div>

                <!-- Change Password Section -->
                <div class="account-form-section">
                    <div class="form-section-header">
                        <h4>Change password</h4>
                        <button type="button" id="showPasswordFieldsBtn" class="btn btn-outline btn-sm">Create new password</button>
                    </div>
                    <div id="passwordFields" style="display: none; margin-top: 12px; display: flex; flex-direction: column; gap: 16px;">
                        <div>
                            <label>New password</label>
                            <input type="password" name="new_password" class="form-input">
                        </div>
                        <div>
                            <label>New password again</label>
                            <input type="password" name="new_password_again" class="form-input">
                        </div>
                        <div>
                            <button type="submit" name="action" value="update_password" class="btn btn-primary">Update Password</button>
                        </div>
                    </div>
                </div>

                <!-- Delete Account Section -->
                <div class="account-form-section" style="border-color: #fee2e2;">
                    <div class="form-section-header">
                        <h4 style="color: #dc2626;">Delete Account</h4>
                    </div>
                    <p style="margin: 12px 0 16px; color: var(--dash-text-muted); font-size: 0.9rem;">
                        Once you delete your account, there is no going back. Please be certain.
                    </p>
                    <button type="button" class="btn btn-danger btn-sm">
                        Delete Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Profile completion circle animation
    const progressCircle = document.getElementById('progressCircle');
    const completionText = document.getElementById('completionText');
    
    if (progressCircle && completionText) {
        const percentage = parseInt('{{ profile_completion|default:0 }}', 10) || 0;
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }
    
    // Password fields toggle
    const btn = document.getElementById('showPasswordFieldsBtn');
    const fields = document.getElementById('passwordFields');
    if (btn && fields) {
        btn.addEventListener('click', function() {
            if (fields.style.display === 'none' || fields.style.display === '') {
                fields.style.display = 'flex';
                btn.textContent = 'Cancel';
                btn.classList.remove('btn-outline');
                btn.classList.add('btn-secondary');
            } else {
                fields.style.display = 'none';
                btn.textContent = 'Create new password';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-outline');
            }
        });
    }
});
</script>
{% endblock %}
