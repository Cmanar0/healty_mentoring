{% extends "dashboard_mentor/base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_title %}{{ project.title }} | Roadmap{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
<style>
    /* Layout Grid */
    .roadmap-container {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 32px;
        align-items: start;
    }
    
    @media (max-width: 1024px) {
        .roadmap-container {
            grid-template-columns: 1fr;
        }
    }

    .nav-btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    .nav-btn-back:hover { color: #1e293b; }

    /* Primary Content Area */
    .roadmap-list-section {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .roadmap-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }

    .roadmap-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* List Items (High Density) */
    .stage-row {
        display: grid;
        grid-template-columns: 40px 1fr auto auto;
        gap: 16px;
        padding: 12px 24px;
        border-bottom: 1px solid #f3f4f6;
        align-items: center;
        transition: background 0.15s ease;
        position: relative;
        background: white;
    }

    .stage-row:last-child {
        border-bottom: none;
    }

    .stage-row:hover {
        background: #f8fafc;
    }
    
    .stage-row:hover .drag-grip {
        opacity: 1;
        color: #94a3b8;
    }
    
    .stage-row:hover .row-actions {
        opacity: 1;
    }

    /* Drag Handle */
    .drag-grip {
        cursor: grab;
        color: #e5e7eb;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        opacity: 0; /* Hidden by default for clean look */
        user-select: none;
        -webkit-user-select: none;
    }
    .drag-grip:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    .drag-grip:active {
        cursor: grabbing;
    }
    .stage-row:hover .drag-grip {
        opacity: 0.5;
    }
    
    /* Sortable styles */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6;
    }
    
    .sortable-drag {
        opacity: 0.8;
    }

    /* Stage Info */
    .stage-main {
        display: flex;
        flex-direction: column; 
    }

    .stage-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: #1f2937;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stage-meta {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Status Indicators */
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }
    .status-dot.completed { background-color: #10b981; box-shadow: 0 0 0 2px #d1fae5; }
    .status-dot.pending { background-color: #fbbf24; }
    .status-dot.draft { background-color: #9ca3af; border: 1px dashed #6b7280; background: transparent; }

    /* Actions */
    .row-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .action-icon-btn {
        padding: 6px;
        border-radius: 6px;
        color: #64748b;
        border: none;
        background: transparent;
        cursor: pointer;
    }
    .action-icon-btn:hover {
        background: #f1f5f9;
        color: #1f2937;
    }
    .action-icon-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Sidebar */
    .project-sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .project-meta-card {
        background: #1e293b;
        color: white;
        border-radius: 12px;
        padding: 24px;
        position: relative;
        overflow: hidden;
    }
    
    .meta-bg-icon {
        position: absolute;
        bottom: -20px;
        right: -20px;
        font-size: 8rem;
        opacity: 0.05;
        transform: rotate(-15deg);
    }

    .project-title-lg {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .project-owner-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .owner-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
    }

    /* Stats Grid */
    .mini-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .stat-box {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }
    .stat-val { font-size: 1.25rem; font-weight: 700; color: #111827; }
    .stat-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

    /* Floating Action Button (Optional usage) */
    .fab-create {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        transition: background 0.2s;
    }
    .fab-create:hover { background: #2563eb; }

    /* Cool AI Button Styling */
    .btn-ai-magic {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .btn-ai-magic::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }
    
    .btn-ai-magic:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
    }
    
    .btn-ai-magic:hover::before {
        left: 100%;
    }

    .btn-ai-magic i {
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block dashboard_content %}
{% include 'general/modals/create_stage_modal.html' %}

<div class="dashboard-content-container" style="max-width: 1200px; margin: 0 auto;">
    
    <!-- Top Nav -->
    <div style="margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center;">
            <a href="{% url 'general:dashboard_mentor:projects_list' %}" class="nav-btn-back">
                Projects
            </a>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span style="color: #1e293b; font-weight: 600;">{{ project.title }}</span>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="generateStagesAI()" id="generateStagesBtn" class="btn-ai-magic" title="Auto-Generate Stages with AI">
                <i class="fas fa-sparkles"></i> AI Generate
            </button>
            <button onclick="openCreateStageModal()" class="fab-create">
                <i class="fas fa-plus"></i> New Stage
            </button>
        </div>
    </div>

    <div class="roadmap-container">
        <!-- Main List -->
        <main>
            {% if not project.questionnaire_completed %}
                <div style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1rem; color: #92400e;">Setup Required</h3>
                    <p style="margin: 0 0 16px 0; color: #b45309; font-size: 0.875rem;">Project details missing. Complete the questionnaire to unlock stage management.</p>
                    {% include "mentoring/partials/questionnaire_form.html" with questions=questions answers=answers %}
                </div>
            {% endif %}

            <div class="roadmap-list-section">
                <div class="roadmap-header">
                    <h2>
                        <i class="fas fa-layer-group" style="color: #9ca3af; font-size: 1rem;"></i>
                        Roadmap Stages
                    </h2>
                    <span id="stagesCount" style="font-size: 0.8rem; color: #6b7280; font-weight: 500;">
                        0 Stages
                    </span>
                </div>
                
                <div id="stagesList">
                    <div style="padding: 48px; text-align: center; color: #9ca3af;">
                        <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>Loading stages...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar Info -->
        <aside class="project-sidebar">
            <div class="project-meta-card">
                <i class="fas fa-paper-plane meta-bg-icon"></i>
                <div style="position: relative; z-index: 2;">
                    <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 8px;">Current Project</div>
                    <h1 class="project-title-lg">{{ project.title }}</h1>
                    
                    {% if project.template %}
                    <div style="display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 6px; font-size: 0.8rem;">
                        <i class="{{ project.template.icon|default:'fas fa-cube' }}"></i>
                        {{ project.template.name }}
                    </div>
                    {% endif %}

                    <div class="project-owner-row">
                        {% if project.project_owner %}
                            <div class="owner-avatar">
                                {{ project.project_owner.first_name|make_list|first|default:"U" }}
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; font-weight: 600;">
                                    {{ project.project_owner.first_name }} {{ project.project_owner.last_name }}
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.7;">Client</div>
                            </div>
                        {% else %}
                            <div style="color: #fca5a5; font-size: 0.9rem;">
                                <i class="fas fa-exclamation-triangle"></i> Unassigned
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="mini-stats">
                <div class="stat-box">
                    <div class="stat-val">{{ active_modules.count|default:"0" }}</div>
                    <div class="stat-label">Modules</div>
                </div>
                <!-- Add more stats here like Days Remaining or Completion % -->
                 <div class="stat-box">
                    <div class="stat-val" style="color: #10b981;">Active</div>
                    <div class="stat-label">Status</div>
                </div>
            </div>
            
            {% if project.description %}
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;">
                <h4 style="margin: 0 0 8px 0; font-size: 0.85rem; color: #1f2937;">Description</h4>
                <p style="font-size: 0.85rem; color: #64748b; line-height: 1.5; margin: 0;">
                    {{ project.description|truncatechars:200 }}
                </p>
            </div>
            {% endif %}
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    console.log('Stages script block loaded');
    const PROJECT_ID = parseInt('{{ project.id }}');
    const STAGE_DETAIL_URL = '{% url "general:dashboard_mentor:stage_detail" project.id 0 %}'.replace('/0/', '/');
    let sortableInstance = null;
    
    console.log('PROJECT_ID:', PROJECT_ID);
    console.log('STAGE_DETAIL_URL:', STAGE_DETAIL_URL);
    
    // Render stages from API data
    function renderStages(stages) {
        console.log('renderStages called with:', stages);
        const container = document.getElementById('stagesList');
        const countEl = document.getElementById('stagesCount');
        
        if (!container) {
            console.error('stagesList container not found!');
            return;
        }
        
        if (!countEl) {
            console.error('stagesCount element not found!');
        }
        
        if (!stages || stages.length === 0) {
            console.log('No stages to render');
            container.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #9ca3af;">
                    <i class="fas fa-stream" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>No stages defined yet.</p>
                </div>
            `;
            if (countEl) {
                countEl.textContent = '0 Stages';
            }
            return;
        }
        
        console.log(`Rendering ${stages.length} stages`);
        if (countEl) {
            countEl.textContent = `${stages.length} Stage${stages.length !== 1 ? 's' : ''}`;
        }
        
        container.innerHTML = stages.map(stage => {
            let statusDot = '';
            let titleClass = '';
            let titleText = stage.title;
            
            if (stage.is_completed) {
                statusDot = '<span class="status-dot completed" title="Completed"></span>';
                titleClass = 'style="text-decoration: line-through; color: #6b7280;"';
            } else if (stage.is_pending_confirmation) {
                statusDot = '<span class="status-dot draft" title="Draft"></span>';
                titleText = `${stage.title} <span style="font-size: 0.7em; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">Draft</span>`;
                titleClass = 'style="color: #4b5563;"';
            } else {
                statusDot = '<span class="status-dot pending" title="In Progress"></span>';
            }
            
            const targetDateHtml = stage.target_date_display 
                ? `<div class="stage-meta"><i class="far fa-calendar-alt" style="margin-right: 4px;"></i> Due ${stage.target_date_display}</div>`
                : '';
            
            const notesCountHtml = stage.notes_count > 0
                ? `<div style="font-size: 0.8rem; color: #9ca3af;"><i class="far fa-comment" style="margin-right: 4px;"></i> ${stage.notes_count}</div>`
                : '<div style="font-size: 0.8rem; color: #9ca3af;"></div>';
            
            const confirmBtn = stage.is_pending_confirmation
                ? `<button class="action-icon-btn" onclick="confirmStage(${stage.id})" style="color: #10b981;" title="Confirm"><i class="fas fa-check"></i></button>`
                : '';
            
            return `
                <div class="stage-row" data-stage-id="${stage.id}">
                    <div class="drag-grip">
                        <i class="fas fa-grip-lines"></i>
                    </div>
                    <div class="stage-main" onclick="window.location.href='${STAGE_DETAIL_URL}${stage.id}/';" style="cursor: pointer;">
                        <div class="stage-title">
                            ${statusDot}
                            <span ${titleClass}>${titleText}</span>
                        </div>
                        ${targetDateHtml}
                    </div>
                    ${notesCountHtml}
                    <div class="row-actions" onclick="event.stopPropagation();">
                        ${confirmBtn}
                        <button class="action-icon-btn delete" onclick="deleteStage(${stage.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="action-icon-btn" style="color: #3b82f6;" onclick="window.location.href='${STAGE_DETAIL_URL}${stage.id}/';">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        // Initialize SortableJS after rendering
        initSortable();
    }
    
    // Initialize SortableJS
    function initSortable() {
        const el = document.getElementById('stagesList');
        if (!el) return;
        
        // Destroy existing instance if any
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        
        // Wait for Sortable to be loaded
        if (typeof Sortable === 'undefined') {
            setTimeout(initSortable, 100);
            return;
        }
        
        sortableInstance = new Sortable(el, {
            animation: 150,
            handle: '.drag-grip',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            forceFallback: false,
            fallbackOnBody: true,
            swapThreshold: 0.65,
            onStart: function(evt) {
                evt.item.style.opacity = '0.5';
            },
            onEnd: function(evt) {
                evt.item.style.opacity = '1';
                
                if (evt.newIndex === evt.oldIndex) return;
                
                const orders = [];
                const baseOrder = PROJECT_ID * 1000;
                
                el.querySelectorAll('.stage-row').forEach((row, index) => {
                    orders.push({
                        stage_id: parseInt(row.dataset.stageId),
                        order: baseOrder + index + 1
                    });
                });
                
                fetch('{% url "general:dashboard_mentor:reorder_stages" project.id %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ orders: orders })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        console.error('Failed to reorder stages:', data.error);
                        // Reload stages to restore correct order
                        loadStages();
                    }
                })
                .catch(error => {
                    console.error('Error reordering stages:', error);
                    loadStages();
                });
            }
        });
    }
    
    // Load stages from API
    function loadStages() {
        const apiUrl = '{% url "general:dashboard_mentor:get_stages_api" project.id %}';
        console.log('Fetching stages from:', apiUrl);
        
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('API Error Response:', text);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Stages API response:', data);
                if (data && data.success) {
                    renderStages(data.stages || []);
                } else {
                    console.error('Failed to load stages:', data?.error || 'Unknown error');
                    const errorMsg = data?.error || 'Unknown error';
                    document.getElementById('stagesList').innerHTML = `
                        <div style="padding: 48px; text-align: center; color: #ef4444;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                            <p>Error loading stages: ${errorMsg}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching stages:', error);
                document.getElementById('stagesList').innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Network error: ${error.message}</p>
                        <p style="font-size: 0.8rem; margin-top: 8px; color: #6b7280;">URL: ${apiUrl}</p>
                        <p style="font-size: 0.8rem; margin-top: 4px;">Please check the browser console (F12) for details.</p>
                    </div>
                `;
            });
    }
    
    // Initialize immediately - script runs after DOM is ready
    console.log('Script execution started');
    console.log('Document ready state:', document.readyState);
    
    // Try calling immediately
    try {
        console.log('Attempting to call loadStages()');
        loadStages();
    } catch (error) {
        console.error('Error calling loadStages:', error);
        // Fallback to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded - calling loadStages()');
            loadStages();
        });
    }

    // Modal Helpers
    window.openCreateStageModal = function() {
        const modal = document.getElementById('createStageModal');
        if(modal) { modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('active'),10); }
    };
    
    window.generateStagesAI = function() {
        const btn = document.getElementById('generateStagesBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Generating...';
        btn.disabled = true;
        btn.style.opacity = '0.7';
        
        fetch('{% url "general:dashboard_mentor:generate_stages_ai" project.id %}', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadStages();
            } else {
                alert('Error: ' + (data.error || 'Unknown error occurred'));
            }
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('A network error occurred. Please try again.');
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    };
    
    window.confirmStage = function(id) {
        if(confirm('Confirm this stage?')) {
            fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/${id}/confirm/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(() => loadStages());
        }
    };
    
    window.deleteStage = function(id) {
        if(confirm('Delete stage?')) {
            fetch(`/dashboard/mentor/projects/${PROJECT_ID}/stages/${id}/delete/`, {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}
            }).then(() => loadStages());
        }
    };
</script>
{% endblock %}
