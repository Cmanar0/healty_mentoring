{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set New Password - Healthy Mentoring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
</head>
<body>
  <!-- Auth Container -->
  <div class="auth-container">
    <div class="auth-card">
      <!-- Logo and Header -->
      <div class="auth-header-wrapper">
        <a href="{% url 'web:landing' %}" class="auth-logo">
          <img src="{% static 'images/logo.png' %}" alt="Healthy Mentoring">
        </a>
        <div class="auth-header-text">
          <h2>Set New Password</h2>
          <p class="subtitle">Please enter your new password below</p>
        </div>
      </div>

      {% if not validlink %}
      <div class="form-errors" style="background-color: #fef2f2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 1.2rem; margin-top: 2px; flex-shrink: 0;"></i>
          <div style="flex: 1;">
            <p style="color: #991b1b; font-weight: 600; margin: 0 0 8px 0;">Invalid or Expired Reset Link</p>
            <p style="color: #7f1d1d; margin: 0 0 12px 0; line-height: 1.5;">
              {% if error_message %}
                {{ error_message }}
              {% else %}
                The password reset link is invalid or has expired. Password reset links can only be used once and expire after 24 hours.
              {% endif %}
            </p>
            <a href="{% url 'accounts:password_reset' %}" class="btn-resend-verification" style="display: inline-block; background-color: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; text-decoration: none;">
              <i class="fas fa-redo" style="margin-right: 6px;"></i>
              Request New Reset Link
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      {% if form.errors %}
      <div class="form-errors">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <div style="display: flex; align-items: flex-start; gap: 8px; margin-bottom: 8px;">
              <i class="fas fa-exclamation-circle" style="color: #ef4444; margin-top: 2px;"></i>
              <span>{{ error }}</span>
            </div>
          {% endfor %}
        {% endfor %}
      </div>
      {% endif %}

      {% if validlink %}
      <form method="post" class="auth-form" id="passwordResetConfirmForm">
        {% csrf_token %}
        
        <!-- New Password -->
        <div class="form-group">
          <label for="id_new_password1">New Password</label>
          <div class="input-wrapper">
            <input type="password" name="new_password1" id="id_new_password1" required placeholder="Enter your new password" autocomplete="new-password">
            <button type="button" class="password-toggle-btn" onclick="togglePassword('id_new_password1', this)">
              <i class="fas fa-eye"></i>
            </button>
            <button type="button" class="input-clear-btn" onclick="clearInput('id_new_password1')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% if form.new_password1.errors %}
          <ul class="errorlist">
            {% for error in form.new_password1.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
          {% if form.new_password1.help_text %}
          <p class="help-text">{{ form.new_password1.help_text }}</p>
          {% endif %}
        </div>

        <!-- Confirm Password -->
        <div class="form-group">
          <label for="id_new_password2">Confirm New Password</label>
          <div class="input-wrapper">
            <input type="password" name="new_password2" id="id_new_password2" required placeholder="Confirm your new password" autocomplete="new-password">
            <button type="button" class="password-toggle-btn" onclick="togglePassword('id_new_password2', this)">
              <i class="fas fa-eye"></i>
            </button>
            <button type="button" class="input-clear-btn" onclick="clearInput('id_new_password2')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% if form.new_password2.errors %}
          <ul class="errorlist">
            {% for error in form.new_password2.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
          <div id="password-match-error" style="color: #ef4444; font-size: 0.8rem; margin-top: 4px; display: none;">Passwords do not match</div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn-submit" id="changePasswordBtn" style="margin-top: 10px;">
          <span class="btn-text">Change Password</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Changing...
          </span>
        </button>
      </form>
      {% endif %}
      
      <!-- Success Modal -->
      <div id="successModal" class="success-modal-overlay" style="display: none;">
        <div class="success-modal-content">
          <div class="success-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3>Password Changed Successfully!</h3>
          <p>Your password has been updated. Redirecting to login...</p>
        </div>
      </div>
      
      <script>
        // Password matching validation
        const p1 = document.getElementById('id_new_password1');
        const p2 = document.getElementById('id_new_password2');
        const passwordMatchError = document.getElementById('password-match-error');
        const changePasswordBtn = document.getElementById('changePasswordBtn');

        function validatePasswordMatch() {
          if (p1.value && p2.value) {
            if (p1.value !== p2.value) {
              passwordMatchError.style.display = 'block';
              p2.style.borderColor = '#ef4444';
              changePasswordBtn.disabled = true;
              changePasswordBtn.style.opacity = '0.6';
              changePasswordBtn.style.cursor = 'not-allowed';
            } else {
              passwordMatchError.style.display = 'none';
              p2.style.borderColor = '';
              changePasswordBtn.disabled = false;
              changePasswordBtn.style.opacity = '1';
              changePasswordBtn.style.cursor = 'pointer';
            }
          } else {
            passwordMatchError.style.display = 'none';
            p2.style.borderColor = '';
          }
        }


        // Clear input function
        function clearInput(inputId) {
          const input = document.getElementById(inputId);
          if (input) {
            input.value = '';
            input.focus();
            updateClearButton(inputId);
            if (inputId === 'id_new_password1' || inputId === 'id_new_password2') {
              validatePasswordMatch();
            }
          }
        }

        // Update clear button visibility
        function updateClearButton(inputId) {
          const input = document.getElementById(inputId);
          const wrapper = input.closest('.input-wrapper');
          const clearBtn = wrapper.querySelector('.input-clear-btn');
          if (clearBtn) {
            if (input.value && input.value.trim() !== '') {
              clearBtn.classList.add('show');
            } else {
              clearBtn.classList.remove('show');
            }
          }
        }

        // Initialize clear buttons visibility
        p1.addEventListener('input', function() {
          updateClearButton('id_new_password1');
          validatePasswordMatch();
        });
        p2.addEventListener('input', function() {
          updateClearButton('id_new_password2');
          validatePasswordMatch();
        });

        // Initial check
        updateClearButton('id_new_password1');
        updateClearButton('id_new_password2');

        // Toggle password visibility
        function togglePassword(inputId, btn) {
          const input = document.getElementById(inputId);
          const icon = btn.querySelector('i');
          if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
          } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
          }
        }

        // Add form submit handler for loading state and validation
        document.getElementById('passwordResetConfirmForm').addEventListener('submit', function(e) {
          // Frontend validation
          if (p1.value !== p2.value) {
            e.preventDefault();
            passwordMatchError.style.display = 'block';
            p2.style.borderColor = '#ef4444';
            return false;
          }

          const btn = document.getElementById('changePasswordBtn');
          if (btn) {
            btn.disabled = true;
            btn.style.opacity = '0.6';
            btn.style.cursor = 'not-allowed';
            btn.querySelector('.btn-text').style.display = 'none';
            btn.querySelector('.btn-loading').style.display = 'inline';
          }
        });
      </script>
      
      <style>
        .success-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        }
        .success-modal-content {
          background: white;
          padding: 40px;
          border-radius: 16px;
          text-align: center;
          max-width: 400px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .success-icon {
          font-size: 64px;
          color: #10b981;
          margin-bottom: 20px;
        }
        .success-modal-content h3 {
          margin: 0 0 12px 0;
          color: #111827;
          font-size: 24px;
        }
        .success-modal-content p {
          margin: 0;
          color: #6b7280;
        }
      </style>

      <!-- Links -->
      <div class="auth-links">
        <p><a href="{% url 'accounts:login' %}">Return to Login</a></p>
      </div>
    </div>
  </div>
</body>
</html>
