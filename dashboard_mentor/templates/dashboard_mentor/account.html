{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}My Account{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="dashboard-grid">
        <!-- Profile Card -->
        <div class="dashboard-card col-span-4">
            <div class="card-header">
                <h3 class="card-title">Your Profile</h3>
            </div>
            <div style="text-align: center; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                <div class="profile-section-wrapper">
                    <div class="profile-avatar-large">
                        {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Profile">
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <h3 style="margin: 0 0 4px; color: var(--dash-text-main);">{{ user.profile.first_name }} {{ user.profile.last_name }}</h3>
                    {% with tag_list=user.profile.tags.all %}
                        {% if tag_list %}
                            <p style="margin: 0; color: var(--dash-text-muted); font-size: 0.9rem;">
                                {% for tag in tag_list %}
                                    {{ tag.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                        {% else %}
                            <p style="margin: 0; color: var(--dash-text-muted);">Mentor</p>
                        {% endif %}
                    {% endwith %}

                    <!-- Profile Completion Circles -->
                    <div style="margin-top: 24px; display: flex; justify-content: center; gap: 32px;">
                        <!-- Profile Completeness Circle -->
                        <div style="text-align: center; position: relative;">
                            <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="accountCompletenessPopover">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <!-- Background circle -->
                                    <circle
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="#e5e7eb"
                                        stroke-width="8"
                                    />
                                    <!-- Progress circle -->
                                    <circle
                                        id="progressCircle"
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="var(--dash-primary)"
                                        stroke-width="8"
                                        stroke-linecap="round"
                                        stroke-dasharray="326.73"
                                        stroke-dashoffset="326.73"
                                        transform="rotate(-90 60 60)"
                                        style="transition: stroke-dashoffset 0.3s ease;"
                                    />
                                </svg>
                                <div class="completion-percentage">
                                    <span id="completionText">{{ profile_completion|default:0 }}%</span>
                                </div>
                            </div>
                            <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                                Profile completeness
                            </p>
                            <!-- Popover -->
                            <div class="completion-popover" id="accountCompletenessPopover">
                                <div class="popover-header">
                                    <strong>Missing Fields</strong>
                                </div>
                                <div class="popover-content">
                                    {% if missing_fields %}
                                        <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                            {% for field in missing_fields %}
                                                <li style="margin-bottom: 6px;">{{ field }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p style="margin: 0; color: var(--dash-primary);">✓ All fields completed!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Profile Content Circle -->
                        <div style="text-align: center; position: relative;">
                            <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="accountContentPopover">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <!-- Background circle -->
                                    <circle
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="#e5e7eb"
                                        stroke-width="8"
                                    />
                                    <!-- Progress circle -->
                                    <circle
                                        id="accountContentCircle"
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="var(--dash-primary)"
                                        stroke-width="8"
                                        stroke-linecap="round"
                                        stroke-dasharray="326.73"
                                        stroke-dashoffset="326.73"
                                        transform="rotate(-90 60 60)"
                                        style="transition: stroke-dashoffset 0.3s ease;"
                                    />
                                </svg>
                                <div class="completion-percentage">
                                    <span id="accountContentText">0%</span>
                                </div>
                            </div>
                            <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                                Profile content
                            </p>
                            <!-- Popover -->
                            <div class="completion-popover" id="accountContentPopover">
                                <div class="popover-header">
                                    <strong>Missing Content</strong>
                                </div>
                                <div class="popover-content">
                                    {% if content_missing %}
                                        <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                            {% for item in content_missing %}
                                                <li style="margin-bottom: 6px;">{{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p style="margin: 0; color: var(--dash-primary);">✓ All content completed!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 24px 16px 0 0;">
                        <a href="/dashboard/mentor/profile/" class="btn btn-outline" style="margin-left: 16px; width: 100%;">Update Profile</a>
                    </div>
                </div>

                <!-- Boost Promotion Box -->
                <div class="boost-promo-box">
                    <div class="boost-promo-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4 class="boost-promo-title">Boost your visibility</h4>
                    <p class="boost-promo-stats">
                        Your profile was viewed <strong>{{ profile_views|default:47 }} times</strong> last month
                    </p>
                    <p class="boost-promo-text">
                        Stand out from the crowd! Complete your profile to 100% and activate Boost to appear at the top of search results.
                    </p>
                    <a href="#" class="btn-boost">
                        <i class="fas fa-star"></i>
                        <span>Get Boost</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Account Card -->
        <div class="dashboard-card col-span-8">
            <div class="card-header">
                <h3 class="card-title">Account</h3>
            </div>
            
            <div class="account-form-container">
                <!-- Account Settings Group -->
                <div class="account-settings-group">
                    
                    <!-- Email Section (First) -->
                    <div class="account-section">
                        <div class="email-row-layout">
                            <div class="email-label-group">
                                <h4><i class="fas fa-envelope"></i> Email</h4>
                                <span class="field-value">{{ user.email }}</span>
                            </div>
                            <button type="button" class="btn-change-email btn-fixed-width-email" onclick="openEmailModal()">Change email</button>
                        </div>
                    </div>

                    <!-- Subscriptions Section -->
                    <div class="account-section">
                        <div class="subscription-row-layout">
                            <div class="subscription-label-group">
                                <h4><i class="fas fa-crown"></i> Subscriptions</h4>
                                <span class="field-value">Free Plan</span>
                            </div>
                            <a href="#" class="btn-view-subscriptions" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>View all Subscriptions</span>
                                <i class="fas fa-arrow-right" style="font-size: 0.85rem;"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Name and Password Grid (Two Columns) -->
                    <div class="account-section ">
                        <div class="name-password-grid">
                            <!-- Left Column: Name -->
                            <form method="post" class="name-column" id="nameForm">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_name">
                                <div class="column-header">
                                    <h4><i class="fas fa-user"></i> Name</h4>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <label>First Name</label>
                                        <input type="text" name="first_name" value="{{ user.profile.first_name }}" class="form-input" id="firstNameInput">
                                    </div>
                                    <div>
                                        <label>Last Name</label>
                                        <input type="text" name="last_name" value="{{ user.profile.last_name }}" class="form-input" id="lastNameInput">
                                    </div>
                                    <div>
                                        <button type="submit" id="nameSaveBtn" class="btn btn-primary btn-sm btn-fixed-height" disabled>Save</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Right Column: Password -->
                            <form method="post" class="password-column" id="passwordForm">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_password">
                                <div class="column-header">
                                    <h4><i class="fas fa-lock"></i> Password</h4>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <label>New password</label>
                                        <input type="password" name="new_password" id="newPasswordInput" class="form-input password-input" autocomplete="new-password">
                                        <span class="password-error" id="passwordError" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 4px;"></span>
                                    </div>
                                    <div>
                                        <label>New password again</label>
                                        <input type="password" name="new_password_again" id="newPasswordAgainInput" class="form-input password-input" autocomplete="new-password">
                                        <span class="password-error" id="passwordMatchError" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 4px;"></span>
                                    </div>
                                    <div>
                                        <button type="submit" id="passwordSaveBtn" class="btn btn-primary btn-sm btn-fixed-height" disabled>Update Password</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Billing Information Section -->
                    <div class="account-section" style="margin-bottom: 24px;">
                        <div class="billing-status-card {% if billing_filled %}billing-filled{% else %}billing-empty{% endif %}">
                            <div class="billing-status-content">
                                <div class="billing-status-icon {% if billing_filled %}billing-icon-filled{% else %}billing-icon-empty{% endif %}">
                                    <i class="fas {% if billing_filled %}fa-check{% else %}fa-exclamation{% endif %}"></i>
                                </div>
                                <div>
                                    <h4 class="billing-status-title">
                                        Billing Information
                                    </h4>
                                    <p class="billing-status-text">
                                        {% if billing_filled %}
                                            Your billing information is complete
                                        {% else %}
                                            Complete your billing information to receive payments
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% if not billing_filled %}
                                <a href="/dashboard/mentor/billing/" class="btn btn-primary btn-sm">
                                    Set Up Billing
                                </a>
                            {% else %}
                                <a href="/dashboard/mentor/billing/" class="btn btn-outline btn-sm">
                                    Update Billing
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Delete Account Group -->
                <div class="account-delete-group">
                    <form method="post" class="account-section account-section-danger">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_account">
                        <div class="account-section-header">
                            <h4 style="color: #dc2626;"><i class="fas fa-trash-alt"></i> Delete Account</h4>
                        </div>
                        <p style="margin: 12px 0 16px; color: var(--dash-text-muted); font-size: 0.9rem;">
                            Once you delete your account, there is no going back. Please be certain.
                        </p>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-fixed-height">
                            Delete Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
      </div>
</div>

<!-- Email Verification Modal -->
<div id="emailModal" class="modal-overlay">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeEmailModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Step 1: New Email Input -->
        <div id="emailStep1">
            <div class="modal-header">
                <h3 class="modal-title">Change Email Address</h3>
                <p class="modal-subtitle">Enter your new email address. We'll send you a verification code.</p>
            </div>
            <form id="emailFormStep1" onsubmit="handleEmailStep1(event)">
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Email Address</label>
                    <input type="email" id="newEmailInput" class="form-input" placeholder="name@example.com" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary btn-full">Send Verification Code</button>
                    <button type="button" class="btn btn-outline" onclick="closeEmailModal()">Cancel</button>
                </div>
            </form>
      </div>

        <!-- Step 2: Verification Code -->
        <div id="emailStep2" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Verify Email</h3>
                <p class="modal-subtitle">Enter the 6-digit code sent to <strong id="confirmEmailDisplay"></strong></p>
      </div>
            <form id="emailFormStep2" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email">
                <input type="hidden" name="email" id="finalEmailInput">
                
                <div class="verification-input-group">
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
      </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary btn-full">Verify & Update Email</button>
                    <button type="button" class="btn btn-outline" onclick="backToStep1()">Back</button>
                </div>
    </form>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to get color based on percentage
    function getProgressColor(percentage) {
        if (percentage >= 90) {
            return '#059669'; // Dark green - Excellent (90-100%)
        } else if (percentage >= 70) {
            return '#10b981'; // Green - Good (70-89%)
        } else if (percentage >= 40) {
            return '#f59e0b'; // Orange - Needs improvement (40-69%)
        } else {
            return '#ef4444'; // Red - Low (0-39%)
        }
    }

    // Profile completion circle animation
    const progressCircle = document.getElementById('progressCircle');
    const completionText = document.getElementById('completionText');
    
    if (progressCircle && completionText) {
        const percentage = parseInt('{{ profile_completion|default:0 }}', 10) || 0;
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }

    // Profile Content Circle
    const accountContentCircle = document.getElementById('accountContentCircle');
    const accountContentText = document.getElementById('accountContentText');
    
    if (accountContentCircle && accountContentText) {
        // Calculate profile content percentage (same as backend)
        const blogPosts = 2;
        const blogPostsTotal = 5;
        const marketingContent = 2; // quiz + manual checked
        const marketingContentTotal = 7;
        const reviews = 0; // Mockup data
        const reviewsTotal = 3;
        
        const blogPercentage = (blogPosts / blogPostsTotal) * 100;
        const marketingPercentage = (marketingContent / marketingContentTotal) * 100;
        const reviewsPercentage = (reviews / reviewsTotal) * 100;
        const contentPercentage = Math.round((blogPercentage + marketingPercentage + reviewsPercentage) / 3);
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (contentPercentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(contentPercentage);
        accountContentCircle.style.stroke = color;
        
        // Update text
        accountContentText.textContent = contentPercentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            accountContentCircle.style.strokeDashoffset = offset;
        }, 200);
}

    // Popover functionality with smart positioning
    const popoverTriggers = document.querySelectorAll('.completion-popover-trigger');
    popoverTriggers.forEach(trigger => {
        const popoverId = trigger.getAttribute('data-popover');
        const popover = document.getElementById(popoverId);
        
        if (popover) {
            trigger.addEventListener('mouseenter', function() {
                popover.style.display = 'block';
                
                // Calculate position
                const triggerRect = trigger.getBoundingClientRect();
                const popoverRect = popover.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Check if there's enough space above
                const spaceAbove = triggerRect.top;
                const spaceBelow = viewportHeight - triggerRect.bottom;
                const popoverHeight = popoverRect.height || 200; // Estimate if not yet rendered
                
                // Position popover above or below based on available space
                if (spaceAbove >= popoverHeight + 20 || spaceAbove > spaceBelow) {
                    // Position above
                    popover.style.bottom = 'calc(100% + 12px)';
                    popover.style.top = 'auto';
                    popover.classList.remove('popover-below');
                    popover.classList.add('popover-above');
                } else {
                    // Position below
                    popover.style.top = 'calc(100% + 12px)';
                    popover.style.bottom = 'auto';
                    popover.classList.remove('popover-above');
                    popover.classList.add('popover-below');
}

                // Ensure popover stays within viewport horizontally
                setTimeout(() => {
                    const finalPopoverRect = popover.getBoundingClientRect();
                    if (finalPopoverRect.left < 10) {
                        popover.style.left = '10px';
                        popover.style.transform = 'translateX(0)';
                    } else if (finalPopoverRect.right > viewportWidth - 10) {
                        popover.style.left = 'auto';
                        popover.style.right = '10px';
                        popover.style.transform = 'translateX(0)';
                    }
                    
                    popover.classList.add('active');
                }, 10);
            });
            
            trigger.addEventListener('mouseleave', function() {
                popover.classList.remove('active');
                setTimeout(() => {
                    popover.style.display = 'none';
                }, 200);
            });
        }
    });

    // Name Section Dirty Checking
    const nameForm = document.getElementById('nameForm');
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const nameSaveBtn = document.getElementById('nameSaveBtn');
    
    if (nameForm && firstNameInput && lastNameInput && nameSaveBtn) {
        const originalFirstName = firstNameInput.value.trim();
        const originalLastName = lastNameInput.value.trim();
        
        // Ensure button starts as disabled
        nameSaveBtn.disabled = true;
        nameSaveBtn.classList.add('btn-disabled');
        
        function checkNameChanges() {
            const currentFirstName = firstNameInput.value.trim();
            const currentLastName = lastNameInput.value.trim();
            const isChanged = currentFirstName !== originalFirstName || currentLastName !== originalLastName;
            
            nameSaveBtn.disabled = !isChanged;
            if (isChanged) {
                nameSaveBtn.classList.remove('btn-disabled');
            } else {
                nameSaveBtn.classList.add('btn-disabled');
            }
        }
        
        firstNameInput.addEventListener('input', checkNameChanges);
        lastNameInput.addEventListener('input', checkNameChanges);
        
        // Initial check
        checkNameChanges();
}

    // Password Validation with meaningful feedback
    const passwordForm = document.getElementById('passwordForm');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const newPasswordAgainInput = document.getElementById('newPasswordAgainInput');
    const passwordSaveBtn = document.getElementById('passwordSaveBtn');
    const passwordError = document.getElementById('passwordError');
    const passwordMatchError = document.getElementById('passwordMatchError');

    if (passwordForm && newPasswordInput && newPasswordAgainInput && passwordSaveBtn) {
        function validatePassword() {
            const p1 = newPasswordInput.value.trim();
            const p2 = newPasswordAgainInput.value.trim();
            
            // Reset errors
            passwordError.style.display = 'none';
            passwordMatchError.style.display = 'none';
            newPasswordInput.style.borderColor = '';
            newPasswordAgainInput.style.borderColor = '';
            
            let isValid = false;
            
            // Check if both fields have values
            if (p1.length === 0 && p2.length === 0) {
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // Validate first password
            if (p1.length < 8) {
                passwordError.textContent = 'Password must be at least 8 characters';
                passwordError.style.display = 'block';
                newPasswordInput.style.borderColor = '#dc2626';
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // Check if passwords match
            if (p1 !== p2) {
                passwordMatchError.textContent = 'Passwords do not match';
                passwordMatchError.style.display = 'block';
                newPasswordAgainInput.style.borderColor = '#dc2626';
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // All validations passed
            isValid = true;
            passwordSaveBtn.disabled = false;
            passwordSaveBtn.classList.remove('btn-disabled');
        }

        newPasswordInput.addEventListener('input', validatePassword);
        newPasswordAgainInput.addEventListener('input', validatePassword);
        
        // Initial validation
        validatePassword();
    }

    // Modal Logic
    const modal = document.getElementById('emailModal');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Close on outside click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }

    // Verification code input handling
    const digits = document.querySelectorAll('.verification-digit');
    digits.forEach((digit, idx) => {
        digit.addEventListener('input', function(e) {
            if (this.value.length === 1) {
                if (idx < digits.length - 1) digits[idx + 1].focus();
            }
        });
        
        digit.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 0) {
                if (idx > 0) digits[idx - 1].focus();
            }
        });
    });
});

function openEmailModal() {
    document.getElementById('emailModal').classList.add('active');
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    document.getElementById('newEmailInput').value = '';
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('active');
}

function handleEmailStep1(e) {
    e.preventDefault();
    const email = document.getElementById('newEmailInput').value;
    if (email) {
        document.getElementById('emailStep1').style.display = 'none';
        document.getElementById('emailStep2').style.display = 'block';
        document.getElementById('confirmEmailDisplay').textContent = email;
        document.getElementById('finalEmailInput').value = email;
        // Focus first digit
        setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
  }
}

function backToStep1() {
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
}
</script>
{% endblock %}
