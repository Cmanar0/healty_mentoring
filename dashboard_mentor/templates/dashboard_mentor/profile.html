{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Your Profile{% endblock %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="dashboard-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
        <!-- Main Profile Card (2/3 width) -->
        <div class="dashboard-card profile-card-compact" style="padding: 0; overflow: hidden;">
            
            <!-- Cover Image Section -->
            <div class="profile-cover-section">
                <!-- Action Buttons Overlay -->
                <div class="cover-actions-overlay">
                    <a href="{% url 'web:mentor_profile_detail' user.id %}" class="btn btn-sm btn-glass" target="_blank">
                        <i class="fas fa-eye"></i> Preview
                    </a>
                    <a href="/dashboard/mentor/account/" class="btn btn-sm btn-glass">
                        <i class="fas fa-user-circle"></i> My Account
                    </a>
                </div>

                <form method="post" enctype="multipart/form-data" id="coverImageForm" style="margin: 0; height: 100%;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_cover_image">
                    <label for="coverImageInput" class="profile-cover-upload">
                        {% if user.profile.cover_image %}
                            <img src="{{ user.profile.cover_image.url }}" alt="Cover" id="coverImagePreview" class="cover-image-preview">
                        {% else %}
                            <div class="cover-image-placeholder">
                                <i class="fas fa-image"></i>
                                <span>Add Cover Photo</span>
                            </div>
                        {% endif %}
                        <div class="cover-overlay">
                            <i class="fas fa-camera"></i>
                            <span>Change Cover</span>
                        </div>
                        <input type="file" name="cover_image" id="coverImageInput" accept="image/*" style="display: none;">
                    </label>
                </form>
            </div>

            <!-- Profile Header (Avatar + Info) -->
            <div class="profile-header-compact">
                <div class="profile-avatar-wrapper">
                    <form method="post" enctype="multipart/form-data" id="pictureForm" style="margin: 0;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_picture">
                        <label for="profilePictureInput" class="profile-avatar-compact profile-avatar-hover">
                            {% if user.profile.profile_picture %}
                                <img src="{{ user.profile.profile_picture.url }}" alt="Profile" id="profileImagePreview">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                            {% endif %}
                            <div class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                            <input type="file" name="profile_picture" id="profilePictureInput" accept="image/*" style="display: none;">
                        </label>
                    </form>
                </div>
                
                <div class="profile-header-info">
                    <div class="profile-name-row">
                        <h2 class="profile-name">{{ user.profile.first_name }} {{ user.profile.last_name }}</h2>
                        {% if user.profile.is_verified %}
                            <span class="verified-badge" title="Verified Mentor"><i class="fas fa-check-circle"></i></span>
                        {% endif %}
                    </div>
                    {% if user.profile.mentor_type %}
                        <p class="profile-title">
                            {% if user.profile.mentor_type == 'life_coach' %}Life Coach
                            {% elif user.profile.mentor_type == 'career_coach' %}Career Coach
                            {% elif user.profile.mentor_type == 'business_coach' %}Business Coach
                            {% elif user.profile.mentor_type == 'health_coach' %}Health Coach
                            {% elif user.profile.mentor_type == 'other' %}Other
                            {% else %}{{ user.profile.mentor_type|title }}
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Messages -->
            {% if messages %}
            <div id="django-messages" style="display: none;">
                {% for message in messages %}
                <div data-message="{{ message|escape }}" data-tags="{{ message.tags|default:'info' }}"></div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Main Form Content -->
            <div class="profile-content-wrapper" style="padding: 0 24px 24px 24px;">
                <form method="post" id="profileForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_profile">
                    
                    <div class="form-grid">
                    <!-- First Name -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-user"></i> First Name</label>
                        <input type="text" name="first_name" value="{{ user.profile.first_name }}" class="form-input" placeholder="First Name">
                    </div>

                    <!-- Last Name -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" name="last_name" value="{{ user.profile.last_name }}" class="form-input" placeholder="Last Name">
                    </div>

                    <!-- Email -->
                    <div class="compact-form-group form-grid-full">
                        <div class="account-section" style="padding: 0; border-bottom: none;">
                            <div class="email-row-layout">
                                <div class="email-label-group">
                                    <h4><i class="fas fa-envelope"></i> Email</h4>
                                    <span class="field-value">
                                        {{ user.email }}
                                        {% if user.is_email_verified %}
                                        <span class="email-verified-badge completion-popover-trigger" data-popover="emailVerifiedPopover">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        {% endif %}
                                    </span>
                                </div>
                                <!-- Email Verified Popover - positioned relative to badge -->
                                {% if user.is_email_verified %}
                                <div class="completion-popover" id="emailVerifiedPopover">
                                    <div class="popover-content">
                                        <p style="margin: 0; color: var(--dash-primary);">✓ Email is verified</p>
                                    </div>
                                </div>
                                {% endif %}
                                <button type="button" class="btn-change-email btn-fixed-width-email" onclick="openEmailModal()">Change email</button>
                            </div>
                        </div>
                    </div>

                    <!-- Mentor Type -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-user-tie"></i> Mentor Type</label>
                        <div class="autocomplete-container">
                            <input type="text" name="mentor_type" id="mentorTypeInput" 
                                   value="{{ user.profile.mentor_type|default:'' }}" 
                                   class="form-input autocomplete-input" 
                                   placeholder="Type or select a mentor type"
                                   autocomplete="off">
                            <div class="autocomplete-suggestions" id="mentorTypeSuggestions"></div>
                        </div>
                        {{ mentor_types|json_script:"mentorTypesData" }}
                    </div>
                    {{ mentor_types|json_script:"mentorTypesData" }}

                    <!-- Time Zone (Redesigned) -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-clock"></i> Time Zone</label>
                        
                        <div class="timezone-settings-card">
                            <!-- Header / Input Area -->
                            <div class="timezone-card-body">
                                <div class="autocomplete-container" style="position: relative;">
                                    <input type="text" name="time_zone" id="timezoneInput" value="{{ user.profile.selected_timezone|default:'' }}" class="form-input autocomplete-input timezone-main-input" placeholder="Search for your timezone..." autocomplete="off">
                                    <input type="hidden" id="timezoneValue" name="time_zone" value="{{ user.profile.selected_timezone|default:'' }}">
                                    <div class="autocomplete-suggestions" id="timezoneSuggestions"></div>
                                </div>
                                
                                <!-- Live Clock & Status -->
                                <div class="timezone-status-row">
                                    <!-- Current Time (Left) -->
                                    <div id="timezoneInfo" class="timezone-live-clock" style="display: none;">
                                        <i class="far fa-clock"></i>
                                        <span id="timezoneCurrentTime">--:--</span>
                                        <span id="timezoneCurrentDate" class="timezone-date-small"></span>
                                    </div>

                                    <!-- Detection Status (Right) -->
                                    <div class="timezone-detection-status">
                                        <!-- Match State -->
                                        <div id="timezoneMatchBadge" class="status-badge status-match" style="display: none;">
                                            <i class="fas fa-check-circle"></i> Matches your location
                                        </div>
                                        
                                        <!-- Mismatch State -->
                                        <div id="timezoneMismatchBadge" class="status-badge status-mismatch" style="display: none;">
                                            <span class="mismatch-text">Detected: <span id="detectedTimezoneName"></span></span>
                                            <button type="button" id="useDetectedTimezoneBtn" class="btn-update-timezone">
                                                Update
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden detected timezone for logic -->
                        <input type="hidden" id="detectedTimezoneValue" value="{{ user.profile.detected_timezone|default:'' }}">
                        {{ common_timezones|json_script:"timezonesData" }}
                    </div>

                    <!-- Expertise (Tags) -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-tags"></i> Expertise (Tags)</label>
                        <div class="autocomplete-container" style="position: relative; margin-bottom: 0;">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input type="text" id="tagInput" class="form-input autocomplete-input" placeholder="Type to search tags..." style="flex: 1; padding: 12px 16px; font-size: 0.95rem; margin-bottom: 0;" autocomplete="off">
                                <button type="button" id="addTagBtn" class="btn btn-outline btn-sm" style="white-space: nowrap; width: auto; height: 43px;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="autocomplete-suggestions" id="tagSuggestions"></div>
                        </div>
                        <div id="tagsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; min-height: 20px;">
                            {% for tag in user.profile.tags %}
                                <div class="tag-item" data-tag-name="{{ tag }}">
                                    <span class="tag-text">{{ tag }}</span>
                                    <button type="button" class="remove-tag-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="tags_data" id="tagsData" value="">
                        {{ predefined_tags|json_script:"predefinedTagsData" }}
                    </div>

                    <!-- Bio -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-align-left"></i> Bio</label>
                        <div id="bioEditor" class="quill-editor-wrapper"></div>
                        <textarea name="bio" id="bioTextarea" style="display: none;">{{ user.profile.bio|default:'' }}</textarea>
                    </div>

                    <!-- Quote -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-quote-left"></i> Quote</label>
                        <input type="text" name="quote" value="{{ user.profile.quote|default:'' }}" class="form-input" placeholder="Your favorite quote or motto...">
                    </div>

                    <!-- Qualifications -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-certificate"></i> Qualifications</label>
                        <div id="qualificationInputSection" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input type="text" id="qualificationTitle" class="form-input" placeholder="Title" style="flex: 1; padding: 12px 16px; font-size: 0.95rem;">
                                <input type="text" id="qualificationSubtitle" class="form-input" placeholder="Subtitle" style="flex: 1; padding: 12px 16px; font-size: 0.95rem;">
                            </div>
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <select id="qualificationType" class="form-input" style="flex: 1; padding: 12px 16px; font-size: 0.95rem;">
                                    {% for qtype in qualification_types %}
                                        <option value="{{ qtype.id }}">{{ qtype.name }}</option>
                                    {% endfor %}
                                </select>
                                <textarea id="qualificationDescription" class="form-input" placeholder="Description (max 450 characters)" rows="3" maxlength="450" style="flex: 2; padding: 12px 16px; font-size: 0.95rem; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="button" id="addQualificationBtn" class="btn btn-outline btn-sm" style="white-space: nowrap; height: 43px; display: inline-flex; align-items: center; justify-content: center; gap: 6px;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                                <button type="button" id="updateQualificationBtn" class="btn btn-primary btn-sm" style="white-space: nowrap; height: 43px; display: none; align-items: center; justify-content: center; gap: 6px;">
                                    <i class="fas fa-check"></i> Update
                                </button>
                                <button type="button" id="cancelQualificationBtn" class="btn btn-outline btn-sm" style="white-space: nowrap; height: 43px; display: none; align-items: center; justify-content: center; gap: 6px;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>
                        <div id="qualificationsList" style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">
                            {% for qual in user.profile.qualifications %}
                                <div class="qualification-item" data-title="{{ qual.title }}" data-subtitle="{{ qual.subtitle|default:'' }}" data-description="{{ qual.description|default:'' }}" data-type="{{ qual.type|default:'certificate' }}" draggable="true">
                                    <div class="qualification-item-content" style="display: flex; flex-direction: column; padding: 12px; background: var(--dash-bg); border: 1px solid var(--dash-border); border-radius: 8px; cursor: move;">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                                {% for qtype in qualification_types %}
                                                    {% if qtype.id == qual.type %}
                                                        <i class="fas {{ qtype.icon }}" style="color: var(--dash-primary); font-size: 1.1rem;"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <div style="font-weight: 600; color: var(--dash-text-main); flex: 1;">{{ qual.title }}</div>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <button type="button" class="edit-qualification-btn" data-index="{{ forloop.counter0 }}">
                                                    <i class="fas fa-pen"></i>
                                                </button>
                                                <button type="button" class="remove-qualification-btn">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <div style="flex: 1;">
                                                {% if qual.subtitle %}
                                                    <div style="font-size: 0.9rem; color: var(--dash-text-main); margin-bottom: 4px;">{{ qual.subtitle }}</div>
                                                {% endif %}
                                                {% if qual.description %}
                                                    <div style="font-size: 0.85rem; color: var(--dash-text-muted);">{{ qual.description }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="qualification-drag-handle" style="display: flex; align-items: center; justify-content: center; padding: 8px; cursor: move; color: var(--dash-text-muted);">
                                                <i class="fas fa-grip-vertical"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="qualifications_data" id="qualificationsData" value="">
                    </div>

                    <!-- Languages -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-language"></i> Languages</label>
                        <div class="autocomplete-container" style="position: relative; margin-bottom: 0;">
                            <input type="text" id="languageInput" class="form-input autocomplete-input" placeholder="Type to search languages..." style="width: 100%; padding: 12px 16px; font-size: 0.95rem; margin-bottom: 0;" autocomplete="off">
                            <div class="autocomplete-suggestions" id="languageSuggestions"></div>
                        </div>
                        <div id="languagesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; min-height: 20px;">
                            {% for lang_id in user.profile.languages %}
                                {% for lang in predefined_languages %}
                                    {% if lang.id == lang_id %}
                                        <div class="tag-item" data-lang-id="{{ lang.id }}">
                                            <span class="tag-text">{% if lang.flag_code %}<span class="fi fi-{{ lang.flag_code|lower }}" style="margin-right: 6px; vertical-align: middle;"></span>{% else %}{{ lang.flag }} {% endif %}{{ lang.name }}</span>
                                            <button type="button" class="remove-tag-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                        <input type="hidden" name="languages_data" id="languagesData" value="">
                        {{ predefined_languages|json_script:"predefinedLanguagesData" }}
                    </div>

                    <!-- Categories -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-folder"></i> Categories</label>
                        <div class="autocomplete-container" style="position: relative; margin-bottom: 0;">
                            <input type="text" id="categoryInput" class="form-input autocomplete-input" placeholder="Type to search categories..." style="width: 100%; padding: 12px 16px; font-size: 0.95rem; margin-bottom: 0;" autocomplete="off">
                            <div class="autocomplete-suggestions" id="categorySuggestions"></div>
                        </div>
                        <div id="categoriesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; min-height: 20px;">
                            {% for cat_id in user.profile.categories %}
                                {% for cat in predefined_categories %}
                                    {% if cat.id == cat_id %}
                                        <div class="tag-item" data-cat-id="{{ cat.id }}">
                                            <span class="tag-text">{{ cat.name }}</span>
                                            <button type="button" class="remove-tag-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                        <input type="hidden" name="categories_data" id="categoriesData" value="">
                        {{ predefined_categories|json_script:"predefinedCategoriesData" }}
                        {{ qualification_types|json_script:"qualificationTypesData" }}
                    </div>

                    <!-- Price per Hour, Earnings, and View Subscriptions (Redesigned) -->
                    <div class="pricing-section-container">
                        <div class="pricing-header">
                            <h4 class="pricing-title">
                                <i class="fas fa-coins" style="color: var(--dash-primary);"></i> Pricing & Earnings
                            </h4>
                            <p class="pricing-subtitle">Set your hourly rate and see what you'll earn.</p>
                        </div>

                        <div class="pricing-calculator-row">
                            <!-- Price Input -->
                            <div class="pricing-input-wrapper">
                                <label class="pricing-label">Price per Hour</label>
                                <div class="pricing-input-group">
                                    <span class="pricing-currency-symbol">$</span>
                                    <input type="number" name="price_per_hour" id="pricePerHour" step="1" min="0" value="{{ user.profile.price_per_hour|default:'' }}" class="pricing-input" placeholder="0">
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="pricing-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>

                            <!-- Earnings Display -->
                            <div class="pricing-input-wrapper">
                                <label class="pricing-label">You'll Earn <span style="font-weight: 400; text-transform: none; font-size: 0.75rem;">(after 3% fees)</span></label>
                                <div id="earningsDisplay" class="pricing-result-box">
                                    $0.00
                                </div>
                            </div>
                        </div>

                        <!-- Subscription Promo Card -->
                        <div class="subscription-promo-card">
                            <div class="promo-content">
                                <h5 class="promo-title">
                                    Keep 100% of your earnings
                                    <span class="promo-badge">Premium</span>
                                </h5>
                                <p class="promo-text">
                                    With our <strong>FREE plan</strong>, you don't pay any monthly subscription, but we take a 3% fee from each session to cover payment provider fees and keep our infrastructure running. Choose any <strong>subscription plan</strong> to avoid the 3% fee entirely and keep 100% of your earnings.
                                </p>
                            </div>
                            <div class="promo-action">
                                <button type="button" class="btn btn-primary" onclick="window.location.href='/dashboard/mentor/account/'">
                                    View Subscriptions
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Session Settings (Redesigned) -->
                    <div class="session-settings-container">
                        <div class="session-settings-header">
                            <h4 class="session-settings-title">
                                <i class="fas fa-sliders-h" style="color: var(--dash-primary);"></i> Session Configuration
                            </h4>
                        </div>
                        
                        <div class="session-settings-grid">
                            <!-- Standard Session Length -->
                            <div class="session-setting-item">
                                <label class="setting-label">
                                    <i class="fas fa-clock"></i> Session Length
                                </label>
                                <p class="setting-description">Set the standard duration for your paid mentoring sessions.</p>
                                <div class="pricing-input-group">
                                    <input type="number" name="session_length" id="sessionLength" step="1" min="1" value="{{ user.profile.session_length|default:'' }}" class="pricing-input" placeholder="60" style="padding-left: 16px; padding-right: 50px;">
                                    <span style="position: absolute; right: 16px; color: var(--dash-text-muted); pointer-events: none; font-size: 0.9rem;">minutes</span>
                                </div>
                            </div>

                            <!-- First Session Free Offer -->
                            <div class="session-setting-item">
                                <label class="setting-label">
                                    <i class="fas fa-gift"></i> First Session Free
                                </label>
                                
                                <div class="session-free-header-row">
                                    <p class="setting-description">Attract more clients by offering a free introductory session.</p>
                                    
                                    <div class="toggle-wrapper">
                                        <label class="toggle-switch">
                                            <input type="checkbox" name="first_session_free" id="firstSessionFree" {% if user.profile.first_session_free %}checked{% endif %}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span class="toggle-status-text" id="firstSessionStatusText">
                                            {% if user.profile.first_session_free %}Enabled{% else %}Disabled{% endif %}
                                        </span>
                                    </div>
                                </div>

                                <div id="firstSessionLengthWrapper" class="free-session-input-container {% if user.profile.first_session_free %}visible{% endif %}">
                                    <div class="pricing-input-group">
                                        <input type="number" name="first_session_length" id="firstSessionLength" step="1" min="1" value="{{ user.profile.first_session_length|default:'' }}" class="pricing-input" placeholder="30" style="padding-left: 16px; padding-right: 50px;">
                                        <span style="position: absolute; right: 16px; color: var(--dash-text-muted); pointer-events: none; font-size: 0.9rem;">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Instagram, LinkedIn, and Personal Website -->
                    <div class="compact-form-group form-grid-full">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                            <div class="compact-form-group">
                                <label><i class="fab fa-instagram"></i> Instagram</label>
                                <input type="text" name="instagram_name" value="{{ user.profile.instagram_name|default:'' }}" class="form-input" placeholder="@username">
                            </div>
                            <div class="compact-form-group">
                                <label><i class="fab fa-linkedin"></i> LinkedIn</label>
                                <input type="text" name="linkedin_name" value="{{ user.profile.linkedin_name|default:'' }}" class="form-input" placeholder="LinkedIn username">
                            </div>
                            <div class="compact-form-group">
                                <label><i class="fas fa-globe"></i> Personal Website</label>
                                <input type="url" name="personal_website" value="{{ user.profile.personal_website|default:'' }}" class="form-input" placeholder="https://example.com">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Save Button Bar -->
                <div class="profile-save-bar">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
            </div>
        </div>

        <!-- Profile Credibility Card (1/3 width) -->
        <div class="dashboard-card" style="height: fit-content;">
            <div class="card-header">
                <h3 class="card-title">Profile Credibility</h3>
            </div>
            
            <!-- Profile Completion Circles -->
            <div style="display: flex; justify-content: center; gap: 32px; padding: 20px 0;">
                <!-- Profile Completeness Circle -->
                <div style="text-align: center; position: relative;">
                    <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="completenessPopover">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="profileProgressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="var(--dash-primary)"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage">
                            <span id="profileCompletionText">{{ profile_completion|default:0 }}%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                        Profile completeness
                    </p>
                    <!-- Popover -->
                    <div class="completion-popover" id="completenessPopover">
                        <div class="popover-header">
                            <strong>Missing Fields</strong>
                        </div>
                        <div class="popover-content">
                            {% if missing_fields %}
                                <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                    {% for field in missing_fields %}
                                        <li style="margin-bottom: 6px;">{{ field }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p style="margin: 0; color: var(--dash-primary);">✓ All fields completed!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Profile Content Circle -->
                <div style="text-align: center; position: relative;">
                    <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="contentPopover">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="profileContentCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="var(--dash-primary)"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage">
                            <span id="profileContentText">0%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                        Profile content
                    </p>
                    <!-- Popover -->
                    <div class="completion-popover" id="contentPopover">
                        <div class="popover-header">
                            <strong>Missing Content</strong>
                        </div>
                        <div class="popover-content">
                            {% if content_missing %}
                                <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                    {% for item in content_missing %}
                                        <li style="margin-bottom: 6px;">{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p style="margin: 0; color: var(--dash-primary);">✓ All content completed!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog Activity -->
            <div style="padding: 40px 24px; border-top: 1px solid var(--dash-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main); display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-pen-nib" style="color: var(--dash-primary);"></i> Blog Activity
                    </h4>
                    <span style="font-size: 0.85rem; color: var(--dash-text-muted);">2/5</span>
                </div>
                <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--dash-primary); height: 100%; width: 40%; border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin: 8px 0 16px; font-size: 0.8rem; color: var(--dash-text-muted); line-height: 1.4;">
                    Write blog posts to increase your credibility and attract more clients.
                </p>
                <a href="#" class="btn btn-primary btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    <i class="fas fa-plus"></i> Create a blog post
                </a>
            </div>

            <!-- Marketing Content -->
            <div style="padding: 20px 24px ; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-bullhorn" style="color: var(--dash-primary);"></i> Marketing Content
                </h4>
                <p style="margin: 0 0 20px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Use our tools to quickly and easily create your own quizzes, workshops, and more to share on social media. Engage with your audience and create connections that can turn into new clients.
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox checked">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Create your quiz</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox checked">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Create your manual</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your workshop</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your challenge</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your webinar</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your e-book</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your template</span>
                    </div>
                </div>
                
                <a href="#" class="btn btn-primary btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    <i class="fas fa-plus"></i> Create Marketing Content
                </a>
            </div>

            <!-- Your Community -->
            <div style="padding: 20px 24px; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-users" style="color: var(--dash-primary);"></i> Your Community
                </h4>
                <p style="margin: 0 0 16px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Build a following! Use your marketing content to attract new people and create a vibrant community. Engaging with your community makes it easier to turn followers into loyal clients.
                </p>
                <a href="#" class="btn btn-outline btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    Grow your Community
                </a>
            </div>

            <!-- Your Courses -->
            <div style="padding: 20px 24px; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-graduation-cap" style="color: var(--dash-primary);"></i> Your Courses
                </h4>
                <p style="margin: 0 0 16px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Unlock a new revenue stream! Create online courses to share your expertise and generate additional income alongside your mentoring sessions.
                </p>
                <a href="#" class="btn btn-outline btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    Create Course
                </a>
            </div>
            <div style="padding: 20px 24px; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main); display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-star" style="color: var(--dash-primary);"></i> Clients Reviews
                </h4>
                <p style="margin: 0 0 20px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Build trust and credibility with client reviews. Aim for at least three reviews to showcase your expertise and help potential clients make informed decisions.
                </p>
                
                <!-- Reviews Progress Bar -->
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 0.85rem; color: var(--dash-text-muted);">Reviews</span>
                        <span style="font-size: 0.85rem; font-weight: 600; color: var(--dash-text-main);">
                            <span id="reviewsCount">3</span>/3
                        </span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--dash-border); border-radius: 4px; overflow: hidden;">
                        <div id="reviewsProgressBar" style="height: 100%; background: var(--dash-primary); border-radius: 4px; transition: width 0.3s ease; width: 100%;"></div>
                    </div>
                </div>

                <!-- Static Reviews List -->
                <div class="reviews-list" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                    <!-- Review 1 -->
                    <div class="review-item" style="display: flex; gap: 12px; align-items: start;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af; flex-shrink: 0;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; font-size: 0.9rem; color: var(--dash-text-main);">Sarah Jenkins</span>
                                <div style="color: #fbbf24; font-size: 0.8rem;">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.4;">
                                "Great session! Really helped me clarify my career goals."
                            </p>
                        </div>
                    </div>
                    
                    <!-- Review 2 -->
                    <div class="review-item" style="display: flex; gap: 12px; align-items: start;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af; flex-shrink: 0;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; font-size: 0.9rem; color: var(--dash-text-main);">Mike Ross</span>
                                <div style="color: #fbbf24; font-size: 0.8rem;">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.4;">
                                "Very knowledgeable and easy to talk to. Highly recommended."
                            </p>
                        </div>
                    </div>

                    <!-- Review 3 -->
                    <div class="review-item" style="display: flex; gap: 12px; align-items: start;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #9ca3af; flex-shrink: 0;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; font-size: 0.9rem; color: var(--dash-text-main);">Emily Chen</span>
                                <div style="color: #fbbf24; font-size: 0.8rem;">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.4;">
                                "The best mentor I've had so far. Thank you!"
                            </p>
                        </div>
                    </div>
                </div>

                <a href="#" class="btn btn-outline btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    Manage reviews
                </a>
            </div>

            <!-- Boost Promotion Box -->
            <div style="padding: 24px; border-top: 1px solid var(--dash-border);">
                <div class="boost-promo-box" style="margin: 0;">
                    <div class="boost-promo-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4 class="boost-promo-title">Boost your visibility</h4>
                    <p class="boost-promo-stats">
                        Your profile was viewed <strong>{{ profile_views|default:47 }} times</strong> last month
                    </p>
                    <p class="boost-promo-text">
                        Stand out from the crowd! Complete your profile to 100% and activate Boost to appear at the top of search results.
                    </p>
                    <a href="#" class="btn-boost">
                        <i class="fas fa-star"></i>
                        <span>Get Boost</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Verification Modal -->
<div id="emailModal" class="modal-overlay">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeEmailModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Step 1: New Email Input -->
        <div id="emailStep1">
            <div class="modal-header">
                <h3 class="modal-title">Change Email Address</h3>
                <p class="modal-subtitle">Enter your new email address. We'll send you a verification code.</p>
                <!-- Button to show verification code input if user already has code -->
                <div style="margin-top: 16px; display: flex; justify-content: center; align-items: center;">
                    <button type="button" class="btn btn-outline btn-no-green-hover" id="showCodeInputBtn" onclick="showCodeInput()" style="display: none; width: auto; padding: 8px 16px; font-size: 0.9rem;">
                        I already have the verification code
                    </button>
                </div>
            </div>
            <!-- Error message for Step 1 -->
            <div id="emailStep1Error" class="email-error-message" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <span id="emailStep1ErrorText" style="color: #ef4444; font-size: 0.9rem;"></span>
                </div>
            </div>
            <form id="emailFormStep1" onsubmit="handleEmailStep1(event)">
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Email Address</label>
                    <input type="email" id="newEmailInput" class="form-input" placeholder="name@example.com" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="sendVerificationCodeBtn" class="btn btn-primary btn-full">
                        <span class="btn-text">Send Verification Code</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Sending...
                        </span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="closeEmailModal()" id="cancelEmailBtn">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Step 2: Verification Code -->
        <div id="emailStep2" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Verify Email</h3>
                <p class="modal-subtitle">Enter the 6-digit code sent to <strong id="confirmEmailDisplay"></strong></p>
            </div>
            <!-- Error message for Step 2 -->
            <div id="emailStep2Error" class="email-error-message" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <span id="emailStep2ErrorText" style="color: #ef4444; font-size: 0.9rem;"></span>
                </div>
            </div>
            <form id="emailFormStep2" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email">
                <input type="hidden" name="email" id="finalEmailInput">
                
                <div class="verification-input-group">
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                </div>

                <div class="modal-actions">
                    <button type="submit" id="verifyEmailBtn" class="btn btn-primary btn-full">
                        <span class="btn-text">Verify & Update Email</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Processing...
                        </span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="backToStep1()" id="backToStep1Btn">Back</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profileImagePreview');
            const icon = document.getElementById('profileImageIcon');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (icon) {
                icon.style.display = 'none';
            }
            // If preview doesn't exist, create it
            if (!preview && icon) {
                const img = document.createElement('img');
                img.id = 'profileImagePreview';
                img.src = e.target.result;
                img.alt = 'Profile';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                icon.parentElement.appendChild(img);
                icon.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Function to detect image brightness and adjust button styles
function detectCoverImageBrightness(imageElement, callback) {
    if (!imageElement || !imageElement.complete) {
        // Wait for image to load
        imageElement.onload = function() {
            detectCoverImageBrightness(imageElement, callback);
        };
        return;
    }
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = Math.min(imageElement.width, 200); // Sample size for performance
    canvas.height = Math.min(imageElement.height, 200);
    
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
    
    try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let brightnessSum = 0;
        let pixelCount = 0;
        
        // Sample pixels (every 4th pixel for performance)
        for (let i = 0; i < data.length; i += 16) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            // Calculate perceived brightness using luminance formula
            const brightness = (r * 0.299 + g * 0.587 + b * 0.114) / 255;
            brightnessSum += brightness;
            pixelCount++;
        }
        
        const averageBrightness = brightnessSum / pixelCount;
        callback(averageBrightness);
    } catch (e) {
        console.error('Error detecting brightness:', e);
        // Default to dark if error
        callback(0.5);
    }
}

// Function to apply button styles based on brightness
function applyCoverButtonStyles(brightness) {
    const overlay = document.querySelector('.cover-actions-overlay');
    const coverSection = document.querySelector('.profile-cover-section');
    const coverUpload = document.querySelector('.profile-cover-upload');
    
    // Remove existing classes
    if (overlay) {
        overlay.classList.remove('light-image', 'dark-image');
    }
    if (coverSection) {
        coverSection.classList.remove('light-image', 'dark-image');
    }
    if (coverUpload) {
        coverUpload.classList.remove('light-image', 'dark-image');
    }
    
    // Threshold: if brightness > 0.5, image is light (use dark buttons)
    // if brightness <= 0.5, image is dark (use light buttons)
    if (brightness > 0.5) {
        if (overlay) overlay.classList.add('light-image');
        if (coverSection) coverSection.classList.add('light-image');
        if (coverUpload) coverUpload.classList.add('light-image');
    } else {
        if (overlay) overlay.classList.add('dark-image');
        if (coverSection) coverSection.classList.add('dark-image');
        if (coverUpload) coverUpload.classList.add('dark-image');
    }
}

function previewCoverImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('coverImagePreview');
            const placeholder = document.querySelector('.cover-image-placeholder');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                // Detect brightness of new image
                detectCoverImageBrightness(preview, applyCoverButtonStyles);
            } else {
                // Create preview if it doesn't exist
                const coverUpload = document.querySelector('.profile-cover-upload');
                if (coverUpload && placeholder) {
                    const img = document.createElement('img');
                    img.id = 'coverImagePreview';
                    img.src = e.target.result;
                    img.alt = 'Cover';
                    img.className = 'cover-image-preview';
                    coverUpload.insertBefore(img, placeholder);
                    placeholder.style.display = 'none';
                    // Detect brightness of new image
                    detectCoverImageBrightness(img, applyCoverButtonStyles);
                }
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Notification function is now in notifications.js

// Function to get color based on percentage
function getProgressColor(percentage) {
    if (percentage >= 90) {
        return '#059669'; // Dark green - Excellent (90-100%)
    } else if (percentage >= 70) {
        return '#10b981'; // Green - Good (70-89%)
    } else if (percentage >= 40) {
        return '#f59e0b'; // Orange - Needs improvement (40-69%)
    } else {
        return '#ef4444'; // Red - Low (0-39%)
    }
}

// Calculate earnings after 3% fees
function calculateEarnings() {
    const pricePerHourInput = document.getElementById('pricePerHour');
    const earningsDisplay = document.getElementById('earningsDisplay');
    if (pricePerHourInput && earningsDisplay) {
        const pricePerHour = parseFloat(pricePerHourInput.value) || 0;
        const earnings = pricePerHour * 0.97; // 3% fee = 97% of price
        earningsDisplay.textContent = '$' + earnings.toFixed(2);
    }
}

// Timezone Management
function initializeTimezoneSelector() {
    // Timezone Management (Redesigned)
    const timezoneInput = document.getElementById('timezoneInput');
    const timezoneValue = document.getElementById('timezoneValue');
    const timezoneSuggestions = document.getElementById('timezoneSuggestions');
    
    // New Elements
    const timezoneInfo = document.getElementById('timezoneInfo');
    const timezoneCurrentTime = document.getElementById('timezoneCurrentTime');
    const timezoneCurrentDate = document.getElementById('timezoneCurrentDate');
    
    const timezoneMatchBadge = document.getElementById('timezoneMatchBadge');
    const timezoneMismatchBadge = document.getElementById('timezoneMismatchBadge');
    const detectedTimezoneName = document.getElementById('detectedTimezoneName');
    const useDetectedTimezoneBtn = document.getElementById('useDetectedTimezoneBtn');
    const detectedTimezoneValue = document.getElementById('detectedTimezoneValue');
    
    const timezonesData = document.getElementById('timezonesData');
    
    if (!timezoneInput || !timezoneValue || !timezoneSuggestions || !timezonesData) return;
    
    const timezones = JSON.parse(timezonesData.textContent);
    let selectedTimezone = null;
    let timezoneUpdateInterval = null;
    let initialTimezoneValue = timezoneValue.value;
    
    // Get detected timezone from hidden input (populated by backend or JS)
    let detectedTimezone = detectedTimezoneValue ? detectedTimezoneValue.value : null;
    
    // If not in backend, try browser detection
    if (!detectedTimezone) {
        try {
            detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        } catch (e) {
            console.log('Could not detect timezone');
        }
    }
    
    // Initialize selected timezone
    if (timezoneValue.value && timezoneValue.value.trim() !== '') {
        const currentTz = timezones.find(tz => tz.id === timezoneValue.value);
        if (currentTz) {
            selectedTimezone = currentTz;
            // Don't overwrite input value if it's already set correctly, just ensure object is linked
            if (timezoneInput.value === '') {
                 timezoneInput.value = currentTz.name + ' (' + (currentTz.offset || '') + ')';
            }
            updateTimezoneDisplay();
            checkTimezoneMismatch();
        }
    }
    
    function checkTimezoneMismatch() {
        if (!detectedTimezone || !selectedTimezone) return;
        
        // Hide both first
        if (timezoneMatchBadge) timezoneMatchBadge.style.display = 'none';
        if (timezoneMismatchBadge) timezoneMismatchBadge.style.display = 'none';
        
        if (selectedTimezone.id === detectedTimezone) {
            // Match
            if (timezoneMatchBadge) timezoneMatchBadge.style.display = 'inline-flex';
        } else {
            // Mismatch
            if (timezoneMismatchBadge) {
                timezoneMismatchBadge.style.display = 'inline-flex';
                if (detectedTimezoneName) {
                    // Try to find nice name for detected timezone
                    const detectedObj = timezones.find(tz => tz.id === detectedTimezone);
                    detectedTimezoneName.textContent = detectedObj ? detectedObj.name : detectedTimezone;
                }
            }
        }
    }
    
    function updateTimezoneDisplay() {
        if (!selectedTimezone || !timezoneInfo) return;
        
        try {
            const now = new Date();
            
            // Date formatter (weekday, month, day)
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: selectedTimezone.id,
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            
            // Time formatter (hour, minute, second)
            const timeFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: selectedTimezone.id,
                hour: '2-digit',
                minute: '2-digit',
                // second: '2-digit', // Removed seconds for cleaner look
                hour12: true
            });
            
            const formattedDate = dateFormatter.format(now);
            const formattedTime = timeFormatter.format(now);
            
            if (timezoneCurrentDate) timezoneCurrentDate.textContent = formattedDate;
            if (timezoneCurrentTime) timezoneCurrentTime.textContent = formattedTime;
            
            timezoneInfo.style.display = 'flex';
            
            // Check for mismatch
            checkTimezoneMismatch();
        } catch (e) {
            timezoneInfo.style.display = 'none';
        }
    }
    
    // Check mismatch on page load
    setTimeout(function() {
        checkTimezoneMismatch();
    }, 100);
    
    // Button to use detected timezone
    if (useDetectedTimezoneBtn && detectedTimezone) {
        useDetectedTimezoneBtn.addEventListener('click', function() {
            const detectedTzObj = timezones.find(tz => tz.id === detectedTimezone);
            if (detectedTzObj) {
                selectedTimezone = detectedTzObj;
                timezoneInput.value = detectedTzObj.name + ' (' + (detectedTzObj.offset || '') + ')';
                timezoneValue.value = detectedTzObj.id;
                updateTimezoneDisplay();
                
                // Show notification
                if (typeof showNotification !== 'undefined') {
                    showNotification('Updated to detected timezone. Don\'t forget to save.', 'note');
                }
            }
        });
    }
    
    // Update time display every minute (seconds removed, so minute update is enough)
    if (timezoneUpdateInterval) clearInterval(timezoneUpdateInterval);
    timezoneUpdateInterval = setInterval(updateTimezoneDisplay, 10000); // 10s is responsive enough
    
    function filterTimezoneSuggestions(query) {
        const lowerQuery = query.toLowerCase();
        return timezones.filter(tz => 
            tz.name.toLowerCase().includes(lowerQuery) ||
            tz.region.toLowerCase().includes(lowerQuery) ||
            tz.id.toLowerCase().includes(lowerQuery) ||
            tz.offset.toLowerCase().includes(lowerQuery)
        );
    }
    
    function displayTimezoneSuggestions(suggestions) {
        if (suggestions.length === 0) {
            timezoneSuggestions.style.display = 'none';
            return;
        }
        
        // Group by region
        const grouped = {};
        suggestions.forEach(tz => {
            if (!grouped[tz.region]) {
                grouped[tz.region] = [];
            }
            grouped[tz.region].push(tz);
        });
        
        timezoneSuggestions.innerHTML = '';
        
        Object.keys(grouped).sort().forEach(region => {
            const regionHeader = document.createElement('div');
            regionHeader.className = 'timezone-region-header';
            regionHeader.textContent = region;
            timezoneSuggestions.appendChild(regionHeader);
            
            grouped[region].forEach((tz, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item timezone-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <div style="font-weight: 500; color: var(--dash-text-main);">${tz.name}</div>
                            <div style="font-size: 0.85rem; color: var(--dash-text-muted);">${tz.id}</div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--dash-text-muted);">${tz.offset}</div>
                    </div>
                `;
                item.addEventListener('click', function() {
                    selectedTimezone = tz;
                    timezoneInput.value = tz.name + ' (' + (tz.offset || '') + ')';
                    timezoneValue.value = tz.id;
                    timezoneSuggestions.style.display = 'none';
                    updateTimezoneDisplay();
                    if (timezoneUpdateInterval) {
                        clearInterval(timezoneUpdateInterval);
                    }
                    timezoneUpdateInterval = setInterval(updateTimezoneDisplay, 1000);
                    
                    // Show notification if timezone changed
                    if (timezoneValue.value !== initialTimezoneValue && typeof showNotification !== 'undefined') {
                        showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                    }
                });
                timezoneSuggestions.appendChild(item);
            });
        });
        
        timezoneSuggestions.style.display = 'block';
        timezoneSuggestions.style.maxHeight = '400px';
        timezoneSuggestions.style.overflowY = 'auto';
    }
    
    let timezoneDebounceTimer;
    
    timezoneInput.addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length > 0) {
            displayTimezoneSuggestions(filterTimezoneSuggestions(query));
        } else {
            displayTimezoneSuggestions(timezones);
        }
    });
    
    timezoneInput.addEventListener('input', function() {
        clearTimeout(timezoneDebounceTimer);
        const query = this.value.trim();
        timezoneDebounceTimer = setTimeout(() => {
            if (query.length > 0) {
                displayTimezoneSuggestions(filterTimezoneSuggestions(query));
            } else {
                displayTimezoneSuggestions(timezones);
            }
        }, 200);
    });
    
    // Close suggestions when clicking outside
    document.addEventListener('click', function(event) {
        if (!timezoneInput.contains(event.target) && !timezoneSuggestions.contains(event.target)) {
            timezoneSuggestions.style.display = 'none';
        }
    });
    
    // Clear interval on page unload
    window.addEventListener('beforeunload', function() {
        if (timezoneUpdateInterval) {
            clearInterval(timezoneUpdateInterval);
        }
    });
}

// Profile completion circle animation
document.addEventListener('DOMContentLoaded', function() {
    // Initialize timezone selector
    initializeTimezoneSelector();
    
    // Initialize earnings display
    const pricePerHourInput = document.getElementById('pricePerHour');
    if (pricePerHourInput) {
        calculateEarnings(); // Initial calculation
        pricePerHourInput.addEventListener('input', calculateEarnings);
        pricePerHourInput.addEventListener('change', calculateEarnings);
    }
    
    // Handle first session free toggle
    const firstSessionFreeCheckbox = document.getElementById('firstSessionFree');
    const firstSessionLengthWrapper = document.getElementById('firstSessionLengthWrapper');
    const firstSessionStatusText = document.getElementById('firstSessionStatusText');
    const firstSessionLengthInput = document.getElementById('firstSessionLength');
    
    // Function to set default value if checkbox is checked and input is empty
    function ensureFirstSessionLengthValue() {
        if (firstSessionFreeCheckbox && firstSessionFreeCheckbox.checked && firstSessionLengthInput) {
            if (!firstSessionLengthInput.value || firstSessionLengthInput.value.trim() === '') {
                firstSessionLengthInput.value = '30';
            }
        }
    }
    
    if (firstSessionFreeCheckbox && firstSessionLengthWrapper) {
        // Set default value on page load if checkbox is checked
        ensureFirstSessionLengthValue();
        
        firstSessionFreeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                firstSessionLengthWrapper.classList.add('visible');
                if (firstSessionStatusText) firstSessionStatusText.textContent = 'Enabled';
                // Set default value if input is empty
                ensureFirstSessionLengthValue();
            } else {
                firstSessionLengthWrapper.classList.remove('visible');
                if (firstSessionStatusText) firstSessionStatusText.textContent = 'Disabled';
                
                // Clear the value when unchecked after a delay
                setTimeout(() => {
                    if (firstSessionLengthInput) {
                        firstSessionLengthInput.value = '';
                    }
                }, 300);
            }
        });
    }
    
    // Form validation - prevent submission if checkbox is checked but input is empty
    const profileFormElement = document.getElementById('profileForm');
    if (profileFormElement) {
        profileFormElement.addEventListener('submit', function(e) {
            if (firstSessionFreeCheckbox && firstSessionFreeCheckbox.checked && firstSessionLengthInput) {
                if (!firstSessionLengthInput.value || firstSessionLengthInput.value.trim() === '' || parseInt(firstSessionLengthInput.value) < 1) {
                    e.preventDefault();
                    showNotification('Please enter a valid duration for the free session (minimum 1 minute).', 'error');
                    firstSessionLengthInput.focus();
                    return false;
                }
            }
        });
    }
    
    // Profile Completeness Circle
    const progressCircle = document.getElementById('profileProgressCircle');
    const completionText = document.getElementById('profileCompletionText');
    
    if (progressCircle && completionText) {
        const percentage = parseInt('{{ profile_completion|default:0 }}', 10) || 0;
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }

    // Profile Content Circle
    const contentCircle = document.getElementById('profileContentCircle');
    const contentText = document.getElementById('profileContentText');
    
    if (contentCircle && contentText) {
        // Calculate profile content percentage
        // Blog posts: 2 out of 5 = 40%
        // Marketing content: 2 out of 7 = ~28.6%
        // Average: (40 + 28.6) / 2 = ~34.3%
        const blogPosts = 2;
        const blogPostsTotal = 5;
        const marketingContent = 2; // quiz + manual checked
        const marketingContentTotal = 7;
        const reviews = 0; // Mockup data
        const reviewsTotal = 3;
        
        const blogPercentage = (blogPosts / blogPostsTotal) * 100;
        const marketingPercentage = (marketingContent / marketingContentTotal) * 100;
        const reviewsPercentage = (reviews / reviewsTotal) * 100;
        const contentPercentage = Math.round((blogPercentage + marketingPercentage + reviewsPercentage) / 3);
        
        // Update reviews display
        const reviewsCountEl = document.getElementById('reviewsCount');
        const reviewsProgressBar = document.getElementById('reviewsProgressBar');
        if (reviewsCountEl) reviewsCountEl.textContent = reviews;
        if (reviewsProgressBar) {
            const reviewsWidth = Math.min((reviews / reviewsTotal) * 100, 100);
            reviewsProgressBar.style.width = reviewsWidth + '%';
        }
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (contentPercentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(contentPercentage);
        contentCircle.style.stroke = color;
        
        // Update text
        contentText.textContent = contentPercentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            contentCircle.style.strokeDashoffset = offset;
        }, 200);
    }

    // Qualifications Management
    const qualificationTitle = document.getElementById('qualificationTitle');
    const qualificationSubtitle = document.getElementById('qualificationSubtitle');
    const qualificationDescription = document.getElementById('qualificationDescription');
    const qualificationType = document.getElementById('qualificationType');
    const addQualificationBtn = document.getElementById('addQualificationBtn');
    const qualificationsList = document.getElementById('qualificationsList');
    const qualificationsData = document.getElementById('qualificationsData');
    let qualificationsArray = [];

    // Qualification types mapping for icons
    const qualificationTypesDataEl = document.getElementById('qualificationTypesData');
    const qualificationTypes = {};
    if (qualificationTypesDataEl) {
        const qualificationTypesData = JSON.parse(qualificationTypesDataEl.textContent);
        qualificationTypesData.forEach(function(qtype) {
            qualificationTypes[qtype.id] = qtype.icon;
        });
    }

    // Load existing qualifications
    document.querySelectorAll('.qualification-item').forEach(item => {
        const title = item.getAttribute('data-title');
        const subtitle = item.getAttribute('data-subtitle');
        const description = item.getAttribute('data-description');
        const type = item.getAttribute('data-type') || 'certificate';
        qualificationsArray.push({ title: title, subtitle: subtitle, description: description, type: type });
    });

    function updateQualificationsData() {
        qualificationsData.value = JSON.stringify(qualificationsArray);
    }

    function resetQualificationInputs() {
        qualificationTitle.value = '';
        qualificationSubtitle.value = '';
        qualificationDescription.value = '';
        qualificationType.value = 'certificate';
        editingQualificationIndex = null;
        addQualificationBtn.style.display = 'inline-flex';
        addQualificationBtn.style.alignItems = 'center';
        addQualificationBtn.style.justifyContent = 'center';
        updateQualificationBtn.style.display = 'none';
        cancelQualificationBtn.style.display = 'none';
    }

    function renderQualificationsList() {
        qualificationsList.innerHTML = '';
        qualificationsArray.forEach((qual, index) => {
            const item = document.createElement('div');
            item.className = 'qualification-item';
            item.setAttribute('draggable', 'true');
            item.setAttribute('data-title', qual.title || '');
            item.setAttribute('data-subtitle', qual.subtitle || '');
            item.setAttribute('data-description', qual.description || '');
            item.setAttribute('data-type', qual.type || 'certificate');
            const icon = qualificationTypes[qual.type || 'certificate'] || 'fa-certificate';
            item.innerHTML = `
                <div class="qualification-item-content" style="display: flex; flex-direction: column; padding: 12px; background: var(--dash-bg); border: 1px solid var(--dash-border); border-radius: 8px; cursor: move;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                            <i class="fas ${icon}" style="color: var(--dash-primary); font-size: 1.1rem;"></i>
                            <div style="font-weight: 600; color: var(--dash-text-main); flex: 1;">${qual.title}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button type="button" class="edit-qualification-btn" data-index="${index}">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button type="button" class="remove-qualification-btn" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="flex: 1;">
                            ${qual.subtitle ? `<div style="font-size: 0.9rem; color: var(--dash-text-main); margin-bottom: 4px;">${qual.subtitle}</div>` : ''}
                            ${qual.description ? `<div style="font-size: 0.85rem; color: var(--dash-text-muted);">${qual.description}</div>` : ''}
                        </div>
                        <div class="qualification-drag-handle" style="display: flex; align-items: center; justify-content: center; padding: 8px; cursor: move; color: var(--dash-text-muted);">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                    </div>
                </div>
            `;
            qualificationsList.appendChild(item);
        });
        updateQualificationsData();
        initializeSortable();
    }

    if (addQualificationBtn && qualificationTitle && qualificationSubtitle && qualificationDescription && qualificationType) {
        addQualificationBtn.addEventListener('click', function() {
            const title = qualificationTitle.value.trim();
            const subtitle = qualificationSubtitle.value.trim();
            const description = qualificationDescription.value.trim();
            const type = qualificationType.value || 'certificate';
            
            if (title) {
                qualificationsArray.push({ title: title, subtitle: subtitle, description: description, type: type });
                resetQualificationInputs();
                renderQualificationsList();
                showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
            }
        });

        // Allow Enter key to add qualification
        qualificationTitle.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addQualificationBtn.click();
            }
        });

        qualificationSubtitle.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addQualificationBtn.click();
            }
        });
    }

    // Initialize Sortable for drag and drop
    let sortableInstance = null;
    function initializeSortable() {
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        if (qualificationsList && typeof Sortable !== 'undefined') {
            sortableInstance = new Sortable(qualificationsList, {
                animation: 150,
                handle: '.qualification-item-content, .qualification-drag-handle',
                ghostClass: 'qualification-ghost',
                chosenClass: 'qualification-chosen',
                dragClass: 'qualification-drag',
                onEnd: function(evt) {
                    // Update array order based on new DOM order
                    const newOrder = [];
                    qualificationsList.querySelectorAll('.qualification-item').forEach((item, index) => {
                        const title = item.getAttribute('data-title');
                        const subtitle = item.getAttribute('data-subtitle') || '';
                        const description = item.getAttribute('data-description') || '';
                        // Find the qualification in the array by matching all three fields
                        const qualIndex = qualificationsArray.findIndex(q => 
                            q.title === title && 
                            (q.subtitle || '') === subtitle && 
                            (q.description || '') === description
                        );
                        if (qualIndex !== -1) {
                            newOrder.push(qualificationsArray[qualIndex]);
                        }
                        // Update data-index attributes for edit/remove buttons
                        const editBtn = item.querySelector('.edit-qualification-btn');
                        const removeBtn = item.querySelector('.remove-qualification-btn');
                        if (editBtn) editBtn.setAttribute('data-index', index);
                        if (removeBtn) removeBtn.setAttribute('data-index', index);
                    });
                    // Only update if we found all items (prevent data loss)
                    if (newOrder.length === qualificationsArray.length) {
                        qualificationsArray = newOrder;
                        updateQualificationsData();
                        showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                    }
                    // Don't re-render, just update the order - this prevents issues with Sortable
                }
            });
        }
    }

    // Step 2 Form Submission (Verify OTP)
    const emailFormStep2 = document.getElementById('emailFormStep2');
    const verifyEmailBtn = document.getElementById('verifyEmailBtn');
    const backToStep1Btn = document.getElementById('backToStep1Btn');
    
    function enableEmailButtons() {
        if (verifyEmailBtn) {
            verifyEmailBtn.disabled = false;
            verifyEmailBtn.style.opacity = '1';
            verifyEmailBtn.style.cursor = 'pointer';
            verifyEmailBtn.querySelector('.btn-text').style.display = 'inline';
            verifyEmailBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (backToStep1Btn) {
            backToStep1Btn.disabled = false;
        }
    }
    
    function disableEmailButtons() {
        if (verifyEmailBtn) {
            verifyEmailBtn.disabled = true;
            verifyEmailBtn.style.opacity = '0.6';
            verifyEmailBtn.style.cursor = 'not-allowed';
            verifyEmailBtn.querySelector('.btn-text').style.display = 'none';
            verifyEmailBtn.querySelector('.btn-loading').style.display = 'inline';
        }
        if (backToStep1Btn) {
            backToStep1Btn.disabled = true;
        }
    }
    
    if (emailFormStep2) {
        emailFormStep2.addEventListener('submit', function(e) {
            e.preventDefault();
            hideEmailErrors();
            
            // Disable button and show loading
            disableEmailButtons();
            
            // Collect OTP
            let otp = '';
            document.querySelectorAll('.verification-digit').forEach(input => {
                otp += input.value;
            });
            
            if (otp.length !== 6) {
                showEmailError(2, 'Please enter the full 6-digit code');
                enableEmailButtons();
                return;
            }
            
            // Send request
            fetch('{% url "accounts:verify_email_change" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ otp: otp })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Email updated successfully!', 'success');
                    } else {
                        alert('Email updated successfully!');
                    }
                    closeEmailModal();
                    setTimeout(() => location.reload(), 500);
                } else {
                    showEmailError(2, data.error || 'Verification failed. Please check your code and try again.');
                    // Clear verification inputs on error
                    document.querySelectorAll('.verification-digit').forEach(input => input.value = '');
                    setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
                    enableEmailButtons();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showEmailError(2, 'An error occurred. Please try again.');
                enableEmailButtons();
            });
        });
    }

    // Verification code input handling - Enhanced with copy-paste, arrow keys, and number-only
    const digits = document.querySelectorAll('.verification-digit');
    
    // Function to handle paste event
    function handlePaste(e) {
        e.preventDefault();
        const pastedData = (e.clipboardData || window.clipboardData).getData('text');
        // Extract only digits from pasted content
        const digitsOnly = pastedData.replace(/\D/g, '').slice(0, 6);
        
        if (digitsOnly.length > 0) {
            // First, clear all inputs
            digits.forEach(input => {
                input.value = '';
            });
            
            // Focus on the first input
            if (digits.length > 0) {
                digits[0].focus();
            }
            
            // Then fill inputs with pasted digits
            digits.forEach((input, idx) => {
                if (idx < digitsOnly.length) {
                    input.value = digitsOnly[idx];
                }
            });
            
            // Focus the next empty input or the last one
            const nextEmptyIdx = Math.min(digitsOnly.length, digits.length - 1);
            digits[nextEmptyIdx].focus();
        }
    }
    
    digits.forEach((digit, idx) => {
        // Handle paste on each input
        digit.addEventListener('paste', handlePaste);
        
        // Only allow numbers
        digit.addEventListener('input', function(e) {
            // Remove any non-digit characters
            this.value = this.value.replace(/\D/g, '');
            
            // Limit to single digit
            if (this.value.length > 1) {
                this.value = this.value.slice(0, 1);
            }
            
            // If we have a digit, move to next
            if (this.value.length === 1) {
                if (idx < digits.length - 1) {
                    digits[idx + 1].focus();
                }
            }
        });
        
        // Handle keydown for navigation
        digit.addEventListener('keydown', function(e) {
            // Arrow Right or Tab: move to next input
            if (e.key === 'ArrowRight' || (e.key === 'Tab' && !e.shiftKey)) {
                e.preventDefault();
                if (idx < digits.length - 1) {
                    digits[idx + 1].focus();
                }
            }
            // Arrow Left or Shift+Tab: move to previous input
            else if (e.key === 'ArrowLeft' || (e.key === 'Tab' && e.shiftKey)) {
                e.preventDefault();
                if (idx > 0) {
                    digits[idx - 1].focus();
                }
            }
            // Backspace: clear current and move to previous
            else if (e.key === 'Backspace') {
                if (this.value.length === 0 && idx > 0) {
                    e.preventDefault();
                    digits[idx - 1].focus();
                    digits[idx - 1].value = '';
                }
            }
            // Prevent non-numeric characters (except navigation keys)
            else if (!['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(e.key)) {
                // Allow Ctrl/Cmd combinations (for copy/paste/select all)
                if (!(e.ctrlKey || e.metaKey)) {
                    // Check if it's a number
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                }
            }
        });
    });


    // Initialize sortable on page load (will be called after SortableJS loads)
    if (qualificationsList) {
        // Load SortableJS
        const sortableScript = document.createElement('script');
        sortableScript.src = 'https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js';
        sortableScript.onload = function() {
            initializeSortable();
        };
        document.head.appendChild(sortableScript);
    }

    // Update qualification button
    if (updateQualificationBtn) {
        updateQualificationBtn.addEventListener('click', function() {
            if (editingQualificationIndex !== null && qualificationsArray[editingQualificationIndex]) {
                const title = qualificationTitle.value.trim();
                const subtitle = qualificationSubtitle.value.trim();
                const description = qualificationDescription.value.trim();
                const type = qualificationType.value || 'certificate';
                
                if (title) {
                    qualificationsArray[editingQualificationIndex] = { title: title, subtitle: subtitle, description: description, type: type };
                    resetQualificationInputs();
                    renderQualificationsList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            }
        });
    }

    // Cancel qualification edit button
    if (cancelQualificationBtn) {
        cancelQualificationBtn.addEventListener('click', function() {
            resetQualificationInputs();
        });
    }

    // Edit qualification
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-qualification-btn')) {
            e.stopPropagation();
            const btn = e.target.closest('.edit-qualification-btn');
            const index = parseInt(btn.getAttribute('data-index'));
            if (!isNaN(index) && qualificationsArray[index]) {
                const qual = qualificationsArray[index];
                qualificationTitle.value = qual.title || '';
                qualificationSubtitle.value = qual.subtitle || '';
                qualificationDescription.value = qual.description || '';
                qualificationType.value = qual.type || 'certificate';
                
                editingQualificationIndex = index;
                addQualificationBtn.style.display = 'none';
                updateQualificationBtn.style.display = 'inline-flex';
                updateQualificationBtn.style.alignItems = 'center';
                updateQualificationBtn.style.justifyContent = 'center';
                cancelQualificationBtn.style.display = 'inline-flex';
                cancelQualificationBtn.style.alignItems = 'center';
                cancelQualificationBtn.style.justifyContent = 'center';
                
                // Scroll to input fields
                qualificationTitle.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                qualificationTitle.focus();
            }
        }
    });

    // Remove qualification
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-qualification-btn')) {
            e.stopPropagation();
            const btn = e.target.closest('.remove-qualification-btn');
            const index = parseInt(btn.getAttribute('data-index'));
            if (!isNaN(index)) {
                qualificationsArray.splice(index, 1);
                renderQualificationsList();
                showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
            } else {
                // Fallback for existing qualifications loaded from template
                const item = btn.closest('.qualification-item');
                const title = item.getAttribute('data-title');
                const subtitle = item.getAttribute('data-subtitle');
                const description = item.getAttribute('data-description');
                qualificationsArray = qualificationsArray.filter(qual => 
                    !(qual.title === title && qual.subtitle === subtitle && qual.description === description)
                );
                item.remove();
                updateQualificationsData();
                showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                if (typeof Sortable !== 'undefined') {
                    initializeSortable(); // Reinitialize after removal
                }
            }
        }
    });

    // Tags management
    const tagInput = document.getElementById('tagInput');
    const addTagBtn = document.getElementById('addTagBtn');
    const tagsList = document.getElementById('tagsList');
    const tagsData = document.getElementById('tagsData');
    const tagSuggestions = document.getElementById('tagSuggestions');
    const predefinedTagsData = document.getElementById('predefinedTagsData');
    const predefinedTags = predefinedTagsData ? JSON.parse(predefinedTagsData.textContent) : [];
    let tagsArray = [];
    let tagDebounceTimer;

    // Initialize tags array from existing tags
    const existingTags = tagsList.querySelectorAll('.tag-item');
    existingTags.forEach(tagItem => {
        const tagName = tagItem.getAttribute('data-tag-name');
        if (tagName && !tagsArray.includes(tagName)) {
            tagsArray.push(tagName);
        }
        // Add event listener to existing remove button
        const removeBtn = tagItem.querySelector('.remove-tag-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const index = tagsArray.indexOf(tagName);
                if (index > -1) {
                    tagsArray.splice(index, 1);
                    renderTagsList();
                    updateTagsData();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
        }
    });

    function updateTagsData() {
        tagsData.value = JSON.stringify(tagsArray);
    }

    function renderTagsList() {
        tagsList.innerHTML = '';
        tagsArray.forEach(tagName => {
            const tagItem = document.createElement('div');
            tagItem.className = 'tag-item';
            tagItem.setAttribute('data-tag-name', tagName);
            
            const tagText = document.createElement('span');
            tagText.className = 'tag-text';
            tagText.textContent = tagName;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-tag-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', function() {
                const index = tagsArray.indexOf(tagName);
                if (index > -1) {
                    tagsArray.splice(index, 1);
                    renderTagsList();
                    updateTagsData();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
            
            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsList.appendChild(tagItem);
        });
        updateTagsData();
    }

    function filterTagSuggestions(query) {
        const filtered = predefinedTags.filter(tag => 
            tag.toLowerCase().includes(query.toLowerCase()) && !tagsArray.includes(tag)
        );
        displayTagSuggestions(filtered);
    }

    function displayTagSuggestions(suggestions) {
        if (suggestions.length === 0) {
            tagSuggestions.style.display = 'none';
            return;
        }

        tagSuggestions.innerHTML = '';
        // Show all suggestions (no limit) - make it scrollable
        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1) item.classList.add('last-item');
            item.textContent = suggestion;
            item.addEventListener('click', function() {
                if (!tagsArray.includes(suggestion)) {
                    tagsArray.push(suggestion);
                    tagInput.value = '';
                    tagSuggestions.style.display = 'none';
                    renderTagsList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
            tagSuggestions.appendChild(item);
        });

        tagSuggestions.style.display = 'block';
        tagSuggestions.style.maxHeight = '300px';
        tagSuggestions.style.overflowY = 'auto';
    }

    if (addTagBtn && tagInput && tagSuggestions) {
        // Show suggestions on focus
        tagInput.addEventListener('focus', function() {
            if (this.value.trim()) {
                filterTagSuggestions(this.value.trim());
            }
        });

        // Filter suggestions as user types
        tagInput.addEventListener('input', function() {
            clearTimeout(tagDebounceTimer);
            const query = this.value.trim();
            
            tagDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterTagSuggestions(query);
                } else {
                    // Show all suggestions when input is empty (no limit)
                    displayTagSuggestions(predefinedTags.filter(tag => !tagsArray.includes(tag)));
                }
            }, 200);
        });

        addTagBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const tagName = tagInput.value.trim();
            
            if (!tagName) return;
            
            // Find matching predefined tag (case-insensitive) to use exact capitalization
            const matchingTag = predefinedTags.find(tag => tag.toLowerCase() === tagName.toLowerCase());
            
            // Use the exact predefined tag name if found, otherwise use the typed name
            const tagToAdd = matchingTag || tagName;
            
            if (!tagsArray.includes(tagToAdd)) {
                tagsArray.push(tagToAdd);
                tagInput.value = '';
                tagSuggestions.style.display = 'none';
                renderTagsList();
                showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
            } else {
                tagInput.value = '';
                tagSuggestions.style.display = 'none';
            }
        });

        // Allow Enter key to add tag
        tagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                addTagBtn.click();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!tagInput.contains(event.target) && !tagSuggestions.contains(event.target) && !addTagBtn.contains(event.target)) {
                tagSuggestions.style.display = 'none';
            }
        });
    }

    // Initialize tags data on page load
    updateTagsData();

    // Helper function to render flag icon or emoji fallback
    function renderFlag(item) {
        // For nationalities: use id as flag_code (they are the same)
        // For languages: use flag_code if available, otherwise use id
        const flagCode = item.flag_code || item.id;
        if (flagCode) {
            // Use flag-icon-css if flag_code/id is available
            return `<span class="fi fi-${flagCode.toLowerCase()}" style="margin-right: 6px; vertical-align: middle;"></span>`;
        } else if (item.flag) {
            // Fallback to emoji
            return item.flag + ' ';
        }
        return '';
    }

    // Languages management
    const languageInput = document.getElementById('languageInput');
    const languagesList = document.getElementById('languagesList');
    const languagesData = document.getElementById('languagesData');
    const languageSuggestions = document.getElementById('languageSuggestions');
    const predefinedLanguagesData = document.getElementById('predefinedLanguagesData');
    const predefinedLanguages = predefinedLanguagesData ? JSON.parse(predefinedLanguagesData.textContent) : [];
    let languagesArray = [];
    let languageDebounceTimer;

    // Initialize languages array from existing languages
    const existingLanguages = languagesList.querySelectorAll('.tag-item');
    existingLanguages.forEach(langItem => {
        const langId = langItem.getAttribute('data-lang-id');
        if (langId && !languagesArray.includes(langId)) {
            languagesArray.push(langId);
        }
        // Add event listener to existing remove button
        const removeBtn = langItem.querySelector('.remove-tag-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const index = languagesArray.indexOf(langId);
                if (index > -1) {
                    languagesArray.splice(index, 1);
                    renderLanguagesList();
                    updateLanguagesData();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
        }
    });

    function updateLanguagesData() {
        languagesData.value = JSON.stringify(languagesArray);
    }

    function renderLanguagesList() {
        languagesList.innerHTML = '';
        languagesArray.forEach(langId => {
            const lang = predefinedLanguages.find(l => l.id === langId);
            if (lang) {
                const langItem = document.createElement('div');
                langItem.className = 'tag-item';
                langItem.setAttribute('data-lang-id', langId);
                
                const langText = document.createElement('span');
                langText.className = 'tag-text';
                langText.innerHTML = renderFlag(lang) + lang.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    const index = languagesArray.indexOf(langId);
                    if (index > -1) {
                        languagesArray.splice(index, 1);
                        renderLanguagesList();
                        updateLanguagesData();
                        showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                    }
                });
                
                langItem.appendChild(langText);
                langItem.appendChild(removeBtn);
                languagesList.appendChild(langItem);
            }
        });
        updateLanguagesData();
    }

    function filterLanguageSuggestions(query) {
        const filtered = predefinedLanguages.filter(lang => 
            lang.name.toLowerCase().includes(query.toLowerCase()) && !languagesArray.includes(lang.id)
        );
        displayLanguageSuggestions(filtered);
    }

    function displayLanguageSuggestions(suggestions) {
        if (suggestions.length === 0) {
            languageSuggestions.style.display = 'none';
            return;
        }

        languageSuggestions.innerHTML = '';
        // Show all suggestions (no limit) - make it scrollable
        suggestions.forEach((lang, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1) item.classList.add('last-item');
            item.innerHTML = renderFlag(lang) + lang.name;
            item.addEventListener('click', function() {
                if (!languagesArray.includes(lang.id)) {
                    languagesArray.push(lang.id);
                    languageInput.value = '';
                    languageSuggestions.style.display = 'none';
                    renderLanguagesList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
            languageSuggestions.appendChild(item);
        });

        languageSuggestions.style.display = 'block';
        languageSuggestions.style.maxHeight = '300px';
        languageSuggestions.style.overflowY = 'auto';
    }

    if (languageInput && languageSuggestions) {
        languageInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length > 0) {
                filterLanguageSuggestions(query);
            } else {
                // Show all suggestions when focused and empty (no limit)
                displayLanguageSuggestions(predefinedLanguages.filter(lang => !languagesArray.includes(lang.id)));
            }
        });

        languageInput.addEventListener('input', function() {
            clearTimeout(languageDebounceTimer);
            const query = this.value.trim();
            
            languageDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterLanguageSuggestions(query);
                } else {
                    // Show all available suggestions when input is empty (no limit)
                    displayLanguageSuggestions(predefinedLanguages.filter(lang => !languagesArray.includes(lang.id)));
                }
            }, 200);
        });

        languageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const query = languageInput.value.trim();
                const lang = predefinedLanguages.find(l => l.name.toLowerCase() === query.toLowerCase());
                
                if (lang && !languagesArray.includes(lang.id)) {
                    languagesArray.push(lang.id);
                    languageInput.value = '';
                    languageSuggestions.style.display = 'none';
                    renderLanguagesList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                } else if (query && !lang) {
                    showNotification('Please select a language from the suggestions.', 'error');
                    if (query.length > 0) {
                        filterLanguageSuggestions(query);
                    }
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!languageInput.contains(event.target) && !languageSuggestions.contains(event.target)) {
                languageSuggestions.style.display = 'none';
            }
        });
    }

    updateLanguagesData();

    // Categories management
    const categoryInput = document.getElementById('categoryInput');
    const categoriesList = document.getElementById('categoriesList');
    const categoriesData = document.getElementById('categoriesData');
    const categorySuggestions = document.getElementById('categorySuggestions');
    const predefinedCategoriesData = document.getElementById('predefinedCategoriesData');
    const predefinedCategories = predefinedCategoriesData ? JSON.parse(predefinedCategoriesData.textContent) : [];
    let categoriesArray = [];
    let categoryDebounceTimer;
    
    // Debug: Check if categories data is loaded
    if (!predefinedCategoriesData || predefinedCategories.length === 0) {
        console.warn('No predefined categories data found or empty array');
    }

    // Initialize categories array from existing categories
    const existingCategories = categoriesList.querySelectorAll('.tag-item');
    existingCategories.forEach(catItem => {
        const catId = catItem.getAttribute('data-cat-id');
        if (catId && !categoriesArray.includes(catId)) {
            categoriesArray.push(catId);
        }
        // Add event listener to existing remove button
        const removeBtn = catItem.querySelector('.remove-tag-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                const index = categoriesArray.indexOf(catId);
                if (index > -1) {
                    categoriesArray.splice(index, 1);
                    renderCategoriesList();
                    updateCategoriesData();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
        }
    });

    function updateCategoriesData() {
        categoriesData.value = JSON.stringify(categoriesArray);
    }

    function renderCategoriesList() {
        categoriesList.innerHTML = '';
        categoriesArray.forEach(catId => {
            const cat = predefinedCategories.find(c => c.id === catId);
            if (cat) {
                const catItem = document.createElement('div');
                catItem.className = 'tag-item';
                catItem.setAttribute('data-cat-id', catId);
                
                const catText = document.createElement('span');
                catText.className = 'tag-text';
                catText.textContent = cat.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    const index = categoriesArray.indexOf(catId);
                    if (index > -1) {
                        categoriesArray.splice(index, 1);
                        renderCategoriesList();
                        updateCategoriesData();
                        showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                    }
                });
                
                catItem.appendChild(catText);
                catItem.appendChild(removeBtn);
                categoriesList.appendChild(catItem);
            }
        });
        updateCategoriesData();
    }

    function filterCategorySuggestions(query) {
        const filtered = predefinedCategories.filter(cat => 
            cat.name.toLowerCase().includes(query.toLowerCase()) && !categoriesArray.includes(cat.id)
        );
        displayCategorySuggestions(filtered);
    }

    function displayCategorySuggestions(suggestions) {
        if (suggestions.length === 0) {
            categorySuggestions.style.display = 'none';
            return;
        }

        categorySuggestions.innerHTML = '';
        // Show all suggestions (no limit) - make it scrollable
        suggestions.forEach((cat, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1) item.classList.add('last-item');
            item.textContent = cat.name;
            item.addEventListener('click', function() {
                if (!categoriesArray.includes(cat.id)) {
                    categoriesArray.push(cat.id);
                    categoryInput.value = '';
                    categorySuggestions.style.display = 'none';
                    renderCategoriesList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                }
            });
            categorySuggestions.appendChild(item);
        });

        categorySuggestions.style.display = 'block';
        categorySuggestions.style.maxHeight = '300px';
        categorySuggestions.style.overflowY = 'auto';
    }

    if (categoryInput && categorySuggestions) {
        categoryInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length > 0) {
                filterCategorySuggestions(query);
            } else {
                // Show all suggestions when focused and empty (no limit)
                displayCategorySuggestions(predefinedCategories.filter(cat => !categoriesArray.includes(cat.id)));
            }
        });

        categoryInput.addEventListener('input', function() {
            clearTimeout(categoryDebounceTimer);
            const query = this.value.trim();
            
            categoryDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterCategorySuggestions(query);
                } else {
                    // Show all available suggestions when input is empty (no limit)
                    displayCategorySuggestions(predefinedCategories.filter(cat => !categoriesArray.includes(cat.id)));
                }
            }, 200);
        });

        categoryInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const query = categoryInput.value.trim();
                const cat = predefinedCategories.find(c => c.name.toLowerCase() === query.toLowerCase());
                
                if (cat && !categoriesArray.includes(cat.id)) {
                    categoriesArray.push(cat.id);
                    categoryInput.value = '';
                    categorySuggestions.style.display = 'none';
                    renderCategoriesList();
                    showNotification('Don\'t forget to save your profile to apply the changes.', 'note');
                } else if (query && !cat) {
                    showNotification('Please select a category from the suggestions.', 'error');
                    if (query.length > 0) {
                        filterCategorySuggestions(query);
                    }
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!categoryInput.contains(event.target) && !categorySuggestions.contains(event.target)) {
                categorySuggestions.style.display = 'none';
            }
        });
    }

    updateCategoriesData();

    // Update credentials data on form submit
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            // Ensure first session length has a value if checkbox is checked
            const firstSessionFreeCheckbox = document.getElementById('firstSessionFree');
            const firstSessionLengthInput = document.getElementById('firstSessionLength');
            if (firstSessionFreeCheckbox && firstSessionFreeCheckbox.checked && firstSessionLengthInput) {
                if (!firstSessionLengthInput.value || firstSessionLengthInput.value.trim() === '' || parseInt(firstSessionLengthInput.value) < 1) {
                    // Set default value if empty
                    if (!firstSessionLengthInput.value || firstSessionLengthInput.value.trim() === '') {
                        firstSessionLengthInput.value = '30';
                    } else {
                        // If value exists but is invalid, prevent submission
                        e.preventDefault();
                        showNotification('Please enter a valid duration for the free session (minimum 1 minute).', 'error');
                        firstSessionLengthInput.focus();
                        return false;
                    }
                }
            }
            
            updateQualificationsData();
            updateTagsData();
            updateLanguagesData();
            updateCategoriesData();
            
            // Update bio textarea with Quill content
            if (window.bioQuill) {
                document.getElementById('bioTextarea').value = window.bioQuill.root.innerHTML;
            }
        });
    }

    // Initialize Quill editor for Bio
    const bioTextarea = document.getElementById('bioTextarea');
    const bioEditor = document.getElementById('bioEditor');
    if (bioTextarea && bioEditor) {
        // Load Quill from CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
        script.onload = function() {
            window.bioQuill = new Quill('#bioEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['link'],
                        ['clean']
                    ]
                }
            });
            
            // Set initial content
            if (bioTextarea.value) {
                window.bioQuill.root.innerHTML = bioTextarea.value;
            }
            
            // Update textarea on text change
            window.bioQuill.on('text-change', function() {
                bioTextarea.value = window.bioQuill.root.innerHTML;
            });
        };
        document.head.appendChild(script);
    }

    // Autocomplete for Mentor Type
    const mentorTypeInput = document.getElementById('mentorTypeInput');
    const mentorTypeSuggestions = document.getElementById('mentorTypeSuggestions');
    const mentorTypesData = document.getElementById('mentorTypesData');
    const mentorTypes = mentorTypesData ? JSON.parse(mentorTypesData.textContent) : [];
    let debounceTimer;

    if (mentorTypeInput && mentorTypeSuggestions) {
        // Show suggestions on focus if input has value
        mentorTypeInput.addEventListener('focus', function() {
            if (this.value.trim()) {
                filterSuggestions(this.value.trim());
            } else {
                showAllSuggestions();
            }
        });

        // Filter suggestions as user types
        mentorTypeInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();
            
            debounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterSuggestions(query);
                } else {
                    showAllSuggestions();
                }
            }, 200);
        });

        // Handle suggestion selection
        mentorTypeSuggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('suggestion-item')) {
                mentorTypeInput.value = e.target.textContent.trim();
                mentorTypeSuggestions.style.display = 'none';
                mentorTypeInput.focus();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!mentorTypeInput.contains(event.target) && !mentorTypeSuggestions.contains(event.target)) {
                mentorTypeSuggestions.style.display = 'none';
            }
        });

        function filterSuggestions(query) {
            const filtered = mentorTypes.filter(type => 
                type.toLowerCase().includes(query.toLowerCase())
            );
            displaySuggestions(filtered);
        }

        function showAllSuggestions() {
            displaySuggestions(mentorTypes); // Show all mentor types
        }

        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                mentorTypeSuggestions.style.display = 'none';
                return;
            }

            mentorTypeSuggestions.innerHTML = '';
            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                if (index === 0) item.classList.add('first-item');
                if (index === suggestions.length - 1) item.classList.add('last-item');
                item.textContent = suggestion;
                mentorTypeSuggestions.appendChild(item);
            });

            mentorTypeSuggestions.style.display = 'block';
            mentorTypeSuggestions.style.maxHeight = '300px';
            mentorTypeSuggestions.style.overflowY = 'auto';
        }
    }

    // Popover functionality with smart positioning
    const popoverTriggers = document.querySelectorAll('.completion-popover-trigger');
    popoverTriggers.forEach(trigger => {
        const popoverId = trigger.getAttribute('data-popover');
        const popover = document.getElementById(popoverId);
        
        if (popover) {
            // Ensure popover is positioned relative to trigger's parent (email-label-group)
            // The popover should be a sibling of the email-label-group, not moved around
            const emailLabelGroup = trigger.closest('.email-label-group');
            if (emailLabelGroup && popover.parentElement !== emailLabelGroup.parentElement) {
                // Move popover to be next to email-label-group
                emailLabelGroup.parentElement.insertBefore(popover, emailLabelGroup.nextSibling);
            }
            
            trigger.addEventListener('mouseenter', function() {
                popover.style.display = 'block';
                
                // Calculate position relative to trigger badge using fixed positioning
                const triggerRect = trigger.getBoundingClientRect();
                const popoverRect = popover.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Check if there's enough space above
                const spaceAbove = triggerRect.top;
                const spaceBelow = viewportHeight - triggerRect.bottom;
                const popoverHeight = popoverRect.height || 200; // Estimate if not yet rendered
                
                // Reset positioning
                popover.style.position = 'fixed';
                popover.style.left = '';
                popover.style.right = '';
                popover.style.top = '';
                popover.style.bottom = '';
                popover.style.transform = '';
                
                // Calculate horizontal position relative to trigger
                const triggerCenterX = triggerRect.left + triggerRect.width / 2;
                const popoverWidth = popoverRect.width || 250;
                
                // For Profile completeness and Profile content popovers, always position below
                const alwaysBelowPopovers = ['completenessPopover', 'contentPopover'];
                const shouldAlwaysBelow = alwaysBelowPopovers.includes(popoverId);
                
                // Position popover above or below based on available space
                // But always below for completeness and content popovers
                if (!shouldAlwaysBelow && (spaceAbove >= popoverHeight + 20 || spaceAbove > spaceBelow)) {
                    // Position above
                    popover.style.bottom = `${window.innerHeight - triggerRect.top + 12}px`;
                    popover.style.top = 'auto';
                    popover.style.left = `${triggerCenterX}px`;
                    popover.style.transform = 'translateX(-50%)';
                    popover.classList.remove('popover-below');
                    popover.classList.add('popover-above');
                } else {
                    // Position below
                    popover.style.top = `${triggerRect.bottom + 12}px`;
                    popover.style.bottom = 'auto';
                    popover.style.left = `${triggerCenterX}px`;
                    popover.style.transform = 'translateX(-50%)';
                    popover.classList.remove('popover-above');
                    popover.classList.add('popover-below');
                }

                // Ensure popover stays within viewport horizontally
                setTimeout(() => {
                    const finalPopoverRect = popover.getBoundingClientRect();
                    if (finalPopoverRect.left < 10) {
                        popover.style.left = '10px';
                        popover.style.transform = 'translateX(0)';
                    } else if (finalPopoverRect.right > viewportWidth - 10) {
                        popover.style.left = 'auto';
                        popover.style.right = '10px';
                        popover.style.transform = 'translateX(0)';
                    }
                    
                    popover.classList.add('active');
                }, 10);
            });
            
            trigger.addEventListener('mouseleave', function() {
                popover.classList.remove('active');
                setTimeout(() => {
                    popover.style.display = 'none';
                }, 200);
            });
        }
    });

    // Modal Logic
    const modal = document.getElementById('emailModal');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Close on outside click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }

    // Verification code input handling (already handled earlier)
});

function openEmailModal() {
    document.getElementById('emailModal').classList.add('active');
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    document.getElementById('newEmailInput').value = '';
    // Hide errors
    hideEmailErrors();
    // Hide/show code input button based on session
    checkPendingEmailChange();
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('active');
    hideEmailErrors();
}

function hideEmailErrors() {
    const step1Error = document.getElementById('emailStep1Error');
    const step2Error = document.getElementById('emailStep2Error');
    if (step1Error) step1Error.style.display = 'none';
    if (step2Error) step2Error.style.display = 'none';
}

function showEmailError(step, message) {
    hideEmailErrors();
    if (step === 1) {
        const errorDiv = document.getElementById('emailStep1Error');
        const errorText = document.getElementById('emailStep1ErrorText');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    } else if (step === 2) {
        const errorDiv = document.getElementById('emailStep2Error');
        const errorText = document.getElementById('emailStep2ErrorText');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    }
}

function showCodeInput() {
    // Check if there's a pending email change in session
    fetch('{% url "accounts:check_pending_email_change" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.has_pending && data.email) {
            document.getElementById('emailStep1').style.display = 'none';
            document.getElementById('emailStep2').style.display = 'block';
            document.getElementById('confirmEmailDisplay').textContent = data.email;
            document.getElementById('finalEmailInput').value = data.email;
            hideEmailErrors();
            setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
        } else {
            showEmailError(1, 'No pending email change found. Please enter your email and request a new code.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showEmailError(1, 'Unable to check for pending email change. Please request a new code.');
    });
}

function checkPendingEmailChange() {
    // Check if there's a pending email change to show the "I already have code" button
    fetch('{% url "accounts:check_pending_email_change" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        const showCodeBtn = document.getElementById('showCodeInputBtn');
        if (showCodeBtn) {
            if (data.has_pending) {
                showCodeBtn.style.display = 'block';
            } else {
                showCodeBtn.style.display = 'none';
            }
        }
    })
    .catch(error => {
        console.error('Error checking pending email change:', error);
    });
}

function handleEmailStep1(e) {
    e.preventDefault();
    hideEmailErrors();
    const email = document.getElementById('newEmailInput').value.trim();
    if (!email) {
        showEmailError(1, 'Please enter an email address');
        return;
    }
    
    // Disable button and show loading
    const sendBtn = document.getElementById('sendVerificationCodeBtn');
    const cancelBtn = document.getElementById('cancelEmailBtn');
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.6';
        sendBtn.style.cursor = 'not-allowed';
        sendBtn.querySelector('.btn-text').style.display = 'none';
        sendBtn.querySelector('.btn-loading').style.display = 'inline';
    }
    if (cancelBtn) {
        cancelBtn.disabled = true;
    }
    
    // Send request to initiate email change
    fetch('{% url "accounts:initiate_email_change" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ new_email: email })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable button
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            sendBtn.style.cursor = 'pointer';
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (cancelBtn) {
            cancelBtn.disabled = false;
        }
        
        if (data.success) {
            document.getElementById('emailStep1').style.display = 'none';
            document.getElementById('emailStep2').style.display = 'block';
            document.getElementById('confirmEmailDisplay').textContent = email;
            document.getElementById('finalEmailInput').value = email;
            hideEmailErrors();
            // Clear verification inputs
            document.querySelectorAll('.verification-digit').forEach(input => input.value = '');
            // Focus first digit
            setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
        } else {
            showEmailError(1, data.error || 'Failed to send verification code');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showEmailError(1, 'An error occurred. Please try again.');
        // Re-enable button on error
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            sendBtn.style.cursor = 'pointer';
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (cancelBtn) {
            cancelBtn.disabled = false;
        }
    });
}

function backToStep1() {
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    hideEmailErrors();
}

// Convert Django messages to notifications
document.addEventListener('DOMContentLoaded', function() {
    var messagesContainer = document.getElementById('django-messages');
    if (messagesContainer) {
        var messageDivs = messagesContainer.querySelectorAll('div[data-message]');
        messageDivs.forEach(function(div) {
            var messageText = div.getAttribute('data-message');
            var tags = div.getAttribute('data-tags') || 'info';
            var type = 'note';
            if (tags === 'success') {
                type = 'success';
            } else if (tags === 'error') {
                type = 'error';
            } else if (tags === 'warning') {
                type = 'warning';
            }
            showNotification(messageText, type);
        });
    }
    
    // Detect cover image brightness on page load
    const coverImage = document.getElementById('coverImagePreview');
    if (coverImage) {
        detectCoverImageBrightness(coverImage, applyCoverButtonStyles);
    } else {
        // If no cover image, default to dark-image style (for placeholder gradient)
        applyCoverButtonStyles(0.3); // Dark gradient
    }
});

// CropperJS instance
let cropper = null;
let currentInputType = null; // 'profile' or 'cover'
let currentFormId = null;
let currentFileInput = null;

// Show image with CropperJS
function showImagePreview(file, inputType, formId, fileInput) {
    if (!file) return;
    
    // Check if CropperJS is loaded
    if (typeof Cropper === 'undefined') {
        alert('Image cropper library not loaded. Please refresh the page.');
        return;
    }
    
    currentInputType = inputType;
    currentFormId = formId;
    currentFileInput = fileInput;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const modal = document.getElementById('imagePreviewModal');
        const img = document.getElementById('previewImage');
        const title = document.getElementById('previewTitle');
        
        if (modal && img && title) {
            // Set image source
            img.src = e.target.result;
            title.innerHTML = inputType === 'profile' ? '<i class="fas fa-user-circle"></i> Crop Profile Picture' : '<i class="fas fa-image"></i> Crop Cover Photo';
            
            // Show modal with flex and fade-in
            modal.style.display = 'flex';
            // Small delay to allow display:flex to apply before adding active class for transition
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
            
            // Add circular class for profile picture
            if (inputType === 'profile') {
                document.querySelector('.cropper-modal-card').classList.add('cropper-circle-view');
            } else {
                document.querySelector('.cropper-modal-card').classList.remove('cropper-circle-view');
            }
            
            // Wait for image to load, then initialize CropperJS
            img.onload = function() {
                // Destroy previous cropper if exists
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                // Initialize CropperJS with locked aspect ratios
                // Profile: 1:1 (square), Cover: 3:1 (wide horizontal ratio)
                const aspectRatio = inputType === 'profile' ? 1 : 3/1;
                cropper = new Cropper(img, {
                    aspectRatio: aspectRatio,
                    viewMode: 1, // Restrict crop box within canvas
                    autoCropArea: 1,
                    responsive: true,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: false, // Lock aspect ratio - user can't resize to custom ratio
                    toggleDragModeOnDblclick: false,
                    dragMode: 'move', // Allow dragging the image when zoomed
                    zoomable: true, // Enable zoom
                    scalable: false, // Disable scaling (we only want zoom)
                    rotatable: false, // Disable rotation
                });
            };
            
            // If image already loaded
            if (img.complete) {
                img.onload();
            }
        }
    };
    reader.readAsDataURL(file);
}

function closeImagePreview() {
    const modal = document.getElementById('imagePreviewModal');
    if (modal) {
        modal.classList.remove('active');
        // Wait for transition to finish before hiding
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    
    // Destroy cropper
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    
    // Reset file input so the same file can be selected again
    if (currentFileInput) {
        currentFileInput.value = '';
    }
    
    // Reset variables
    currentInputType = null;
    currentFormId = null;
    currentFileInput = null;
}

// Zoom functions
function zoomIn() {
    if (cropper) {
        cropper.zoom(0.1); // Zoom in by 10%
    }
}

function zoomOut() {
    if (cropper) {
        cropper.zoom(-0.1); // Zoom out by 10%
    }
}

function resetZoom() {
    if (cropper) {
        cropper.reset(); // Reset zoom and position
    }
}

// Save cropped image
function saveCroppedImage() {
    if (!cropper || !currentFileInput || !currentFormId) {
        alert('Error: Missing cropper or form data');
        return;
    }
    
    // Get cropped canvas with proper dimensions
    // Profile: 400x400 (square), Cover: 1920x640 (3:1 wide ratio)
    const canvas = cropper.getCroppedCanvas({
        width: currentInputType === 'profile' ? 400 : 1920,
        height: currentInputType === 'profile' ? 400 : 640,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high',
    });
    
    // Convert to blob
    canvas.toBlob(function(blob) {
        if (!blob) {
            alert('Error creating cropped image');
            return;
        }
        
        // Create a new File object from the blob
        const fileName = currentFileInput.files[0].name;
        const croppedFile = new File([blob], fileName, { type: 'image/jpeg' });
        
        // Update the file input with the cropped file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(croppedFile);
        currentFileInput.files = dataTransfer.files;
        
        // Submit the form
        const form = document.getElementById(currentFormId);
        if (form) {
            form.submit();
        } else {
            alert('Form not found');
        }
        
        // Close modal
        closeImagePreview();
    }, 'image/jpeg', 0.9);
}

// Handle profile picture and cover image selection
document.addEventListener('DOMContentLoaded', function() {
    // Check if CropperJS is loaded
    if (typeof Cropper === 'undefined') {
        console.error('CropperJS library not loaded. Make sure it is included in the base template.');
    }
    
    // Handle profile picture selection
    const profilePicInput = document.getElementById('profilePictureInput');
    if (profilePicInput) {
        profilePicInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                showImagePreview(e.target.files[0], 'profile', 'pictureForm', e.target);
            }
        });
    }
    
    // Handle cover image selection
    const coverImgInput = document.getElementById('coverImageInput');
    if (coverImgInput) {
        coverImgInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                showImagePreview(e.target.files[0], 'cover', 'coverImageForm', e.target);
            }
        });
    }
    
    // Close modal when clicking outside
    const modal = document.getElementById('imagePreviewModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeImagePreview();
            }
        });
    }
});
</script>

<!-- Premium Image Preview Modal -->
<div id="imagePreviewModal" class="cropper-modal-backdrop">
    <div class="cropper-modal-card">
        <div class="cropper-header">
            <h3 id="previewTitle"><i class="fas fa-crop-alt"></i> Preview Image</h3>
            <button type="button" class="cropper-close-btn" onclick="closeImagePreview()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cropper-body">
            <img id="previewImage" src="" alt="Preview">
        </div>
        
        <div class="cropper-footer">
            <div class="cropper-toolbar">
                <button type="button" class="cropper-tool-btn" onclick="zoomOut()" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button type="button" class="cropper-tool-btn" onclick="zoomIn()" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button type="button" class="cropper-tool-btn" onclick="resetZoom()" title="Reset View">
                    <i class="fas fa-undo"></i>
                </button>
            </div>
            
            <div class="cropper-actions">
                <button type="button" class="btn-cropper-cancel" onclick="closeImagePreview()">Cancel</button>
                <button type="button" class="btn-cropper-save" onclick="saveCroppedImage()">
                    <i class="fas fa-check"></i> Crop & Save
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

