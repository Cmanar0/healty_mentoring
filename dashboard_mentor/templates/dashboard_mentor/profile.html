{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Your Profile{% endblock %}

{% block extra_css %}
{{ block.super }}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="dashboard-grid" style="display: grid; grid-template-columns: 1fr 380px; gap: 24px;">
        <!-- Main Profile Card -->
        <div class="dashboard-card profile-card-compact">
            <!-- Compact Header with Profile Picture -->
            <div class="profile-header-compact">
                <form method="post" enctype="multipart/form-data" id="pictureForm" style="margin: 0;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_picture">
                    <label for="profilePictureInput" class="profile-avatar-compact profile-avatar-hover">
                        {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Profile" id="profileImagePreview">
                        {% else %}
                            <i class="fas fa-user" id="profileImageIcon"></i>
                        {% endif %}
                        <div class="avatar-overlay">
                            <i class="fas {% if user.profile.profile_picture %}fa-camera{% else %}fa-plus{% endif %}"></i>
                        </div>
                        <input type="file" name="profile_picture" id="profilePictureInput" accept="image/*" style="display: none;" onchange="document.getElementById('pictureForm').submit()">
                    </label>
                </form>
                <div class="profile-header-info">
                    <h2>{{ user.profile.first_name }} {{ user.profile.last_name }}</h2>
                    {% if user.profile.mentor_type %}
                        <p style="color: var(--dash-text-muted); margin: 0;">
                            {% if user.profile.mentor_type == 'life_coach' %}Life Coach
                            {% elif user.profile.mentor_type == 'career_coach' %}Career Coach
                            {% elif user.profile.mentor_type == 'business_coach' %}Business Coach
                            {% elif user.profile.mentor_type == 'health_coach' %}Health Coach
                            {% elif user.profile.mentor_type == 'other' %}Other
                            {% else %}{{ user.profile.mentor_type|title }}
                            {% endif %}
                        </p>
                    {% endif %}
                </div>
                <div class="profile-header-actions">
                    <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
                        <a href="/dashboard/mentor/account/" class="btn btn-outline btn-sm" style="display: inline-flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user-circle"></i> My account
                        </a>
                        <a href="{% url 'web:mentor_profile_detail' user.id %}" class="btn btn-outline btn-sm" style="display: inline-flex; align-items: center; gap: 8px;" target="_blank">
                            <i class="fas fa-eye"></i> Profile Preview
                        </a>
                    </div>
                </div>
            </div>

            <!-- Compact Form Grid -->
            <form method="post" id="profileForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_profile">
                
                <div class="form-grid">
                    <!-- First Name -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-user"></i> First Name</label>
                        <input type="text" name="first_name" value="{{ user.profile.first_name }}" class="form-input" placeholder="First Name">
                    </div>

                    <!-- Last Name -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" name="last_name" value="{{ user.profile.last_name }}" class="form-input" placeholder="Last Name">
                    </div>

                    <!-- Email -->
                    <div class="compact-form-group form-grid-full">
                        <div class="account-section" style="padding: 0; border-bottom: none;">
                            <div class="email-row-layout">
                                <div class="email-label-group">
                                    <h4><i class="fas fa-envelope"></i> Email</h4>
                                    <span class="field-value">{{ user.email }}</span>
                                </div>
                                <button type="button" class="btn-change-email btn-fixed-width-email" onclick="openEmailModal()">Change email</button>
                            </div>
                        </div>
                    </div>

                    <!-- Mentor Type -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-user-tie"></i> Mentor Type</label>
                        <div class="autocomplete-container">
                            <input type="text" name="mentor_type" id="mentorTypeInput" 
                                   value="{{ user.profile.mentor_type|default:'' }}" 
                                   class="form-input autocomplete-input" 
                                   placeholder="Type or select a mentor type"
                                   autocomplete="off">
                            <div class="autocomplete-suggestions" id="mentorTypeSuggestions"></div>
                        </div>
                        {{ mentor_types|json_script:"mentorTypesData" }}
                    </div>
                    {{ mentor_types|json_script:"mentorTypesData" }}

                    <!-- Time Zone -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-clock"></i> Time Zone</label>
                        <input type="text" name="time_zone" value="{{ user.profile.time_zone|default:'' }}" class="form-input" placeholder="e.g., UTC, America/New_York">
                    </div>

                    <!-- Expertise (Tags) -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-tags"></i> Expertise (Tags)</label>
                        <div id="tagsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 20px;">
                            {% for tag in user.profile.tags %}
                                <div class="tag-item" data-tag-name="{{ tag }}">
                                    <span class="tag-text">{{ tag }}</span>
                                    <button type="button" class="remove-tag-btn">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="autocomplete-container" style="position: relative;">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input type="text" id="tagInput" class="form-input autocomplete-input" placeholder="Type to search tags..." style="flex: 1; padding: 12px 16px; font-size: 0.95rem;" autocomplete="off">
                                <button type="button" id="addTagBtn" class="btn btn-outline btn-sm" style="white-space: nowrap; width: auto; height: 43px;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="autocomplete-suggestions" id="tagSuggestions"></div>
                        </div>
                        <input type="hidden" name="tags_data" id="tagsData" value="">
                        {{ predefined_tags|json_script:"predefinedTagsData" }}
                    </div>

                    <!-- Bio -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-align-left"></i> Bio</label>
                        <div id="bioEditor" style="min-height: 200px;"></div>
                        <textarea name="bio" id="bioTextarea" style="display: none;">{{ user.profile.bio|default:'' }}</textarea>
                    </div>

                    <!-- Quote -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-quote-left"></i> Quote</label>
                        <input type="text" name="quote" value="{{ user.profile.quote|default:'' }}" class="form-input" placeholder="Your favorite quote or motto...">
                    </div>

                    <!-- Qualifications -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-certificate"></i> Qualifications</label>
                        <div id="qualificationsList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                            {% for qual in user.profile.qualifications.all %}
                                <div class="qualification-item" data-title="{{ qual.title }}" data-subtitle="{{ qual.subtitle|default:'' }}" data-description="{{ qual.description|default:'' }}">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--dash-bg); border: 1px solid var(--dash-border); border-radius: 8px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: var(--dash-text-main); margin-bottom: 4px;">{{ qual.title }}</div>
                                            {% if qual.subtitle %}
                                                <div style="font-size: 0.9rem; color: var(--dash-text-main); margin-bottom: 4px;">{{ qual.subtitle }}</div>
                                            {% endif %}
                                            {% if qual.description %}
                                                <div style="font-size: 0.85rem; color: var(--dash-text-muted);">{{ qual.description }}</div>
                                            {% endif %}
                                        </div>
                                        <button type="button" class="remove-qualification-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; gap: 8px; align-items: stretch;">
                                <input type="text" id="qualificationTitle" class="form-input" placeholder="Title" style="flex: 1; padding: 12px 16px; font-size: 0.95rem;">
                                <input type="text" id="qualificationSubtitle" class="form-input" placeholder="Subtitle" style="flex: 1; padding: 12px 16px; font-size: 0.95rem;">
                            </div>
                            <textarea id="qualificationDescription" class="form-input" placeholder="Description (max 450 characters)" rows="3" maxlength="450" style="width: 100%; padding: 12px 16px; font-size: 0.95rem; resize: vertical;"></textarea>
                            <button type="button" id="addQualificationBtn" class="btn btn-outline btn-sm" style="white-space: nowrap; width: auto; height: 43px; align-self: flex-start;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <input type="hidden" name="qualifications_data" id="qualificationsData" value="">
                    </div>

                    <!-- Languages -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-language"></i> Languages</label>
                        <div id="languagesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 20px;">
                            {% for lang_id in user.profile.languages %}
                                {% for lang in predefined_languages %}
                                    {% if lang.id == lang_id %}
                                        <div class="tag-item" data-lang-id="{{ lang.id }}">
                                            <span class="tag-text">{{ lang.name }}</span>
                                            <button type="button" class="remove-tag-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                        <div class="autocomplete-container" style="position: relative;">
                            <input type="text" id="languageInput" class="form-input autocomplete-input" placeholder="Type to search languages..." style="width: 100%; padding: 12px 16px; font-size: 0.95rem;" autocomplete="off">
                            <div class="autocomplete-suggestions" id="languageSuggestions"></div>
                        </div>
                        <input type="hidden" name="languages_data" id="languagesData" value="">
                        {{ predefined_languages|json_script:"predefinedLanguagesData" }}
                    </div>

                    <!-- Categories -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-folder"></i> Categories</label>
                        <div id="categoriesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; min-height: 20px;">
                            {% for cat_id in user.profile.categories %}
                                {% for cat in predefined_categories %}
                                    {% if cat.id == cat_id %}
                                        <div class="tag-item" data-cat-id="{{ cat.id }}">
                                            <span class="tag-text">{{ cat.name }}</span>
                                            <button type="button" class="remove-tag-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                        <div class="autocomplete-container" style="position: relative;">
                            <input type="text" id="categoryInput" class="form-input autocomplete-input" placeholder="Type to search categories..." style="width: 100%; padding: 12px 16px; font-size: 0.95rem;" autocomplete="off">
                            <div class="autocomplete-suggestions" id="categorySuggestions"></div>
                        </div>
                        <input type="hidden" name="categories_data" id="categoriesData" value="">
                        {{ predefined_categories|json_script:"predefinedCategoriesData" }}
                    </div>

                    <!-- Price per Hour -->
                    <div class="compact-form-group">
                        <label><i class="fas fa-dollar-sign"></i> Price per Hour</label>
                        <input type="number" name="price_per_hour" step="0.01" min="0" value="{{ user.profile.price_per_hour|default:'' }}" class="form-input" placeholder="0.00">
                    </div>

                    <!-- Price per Hour and Nationality -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="compact-form-group">
                            <label><i class="fas fa-dollar-sign"></i> Price per Hour</label>
                            <div style="position: relative;">
                                <input type="number" name="price_per_hour" id="pricePerHour" step="1" min="0" value="{{ user.profile.price_per_hour|default:'' }}" class="form-input" placeholder="0" style="padding-right: 30px;">
                                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--dash-text-muted); pointer-events: none;">$</span>
                            </div>
                        </div>
                        <div class="compact-form-group">
                            <label><i class="fas fa-flag"></i> Nationality</label>
                            <input type="text" name="nationality" value="{{ user.profile.nationality|default:'' }}" class="form-input" placeholder="e.g., American, British">
                        </div>
                    </div>

                    <!-- Instagram and LinkedIn -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="compact-form-group">
                            <label><i class="fab fa-instagram"></i> Instagram</label>
                            <input type="text" name="instagram_name" value="{{ user.profile.instagram_name|default:'' }}" class="form-input" placeholder="@username">
                        </div>
                        <div class="compact-form-group">
                            <label><i class="fab fa-linkedin"></i> LinkedIn</label>
                            <input type="text" name="linkedin_name" value="{{ user.profile.linkedin_name|default:'' }}" class="form-input" placeholder="LinkedIn username">
                        </div>
                    </div>

                    <!-- Personal Website -->
                    <div class="compact-form-group form-grid-full">
                        <label><i class="fas fa-globe"></i> Personal Website</label>
                        <input type="url" name="personal_website" value="{{ user.profile.personal_website|default:'' }}" class="form-input" placeholder="https://example.com">
                    </div>

                </div>

                <!-- Save Button Bar -->
                <div class="profile-save-bar">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>

        <!-- Tracking Card -->
        <div class="dashboard-card" style="height: fit-content;">
            <div class="card-header">
                <h3 class="card-title">Profile Credibility</h3>
            </div>
            
            <!-- Profile Completion Circles -->
            <div style="display: flex; justify-content: center; gap: 32px; padding: 20px 0;">
                <!-- Profile Completeness Circle -->
                <div style="text-align: center; position: relative;">
                    <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="completenessPopover">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="profileProgressCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="var(--dash-primary)"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage">
                            <span id="profileCompletionText">{{ profile_completion|default:0 }}%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                        Profile completeness
                    </p>
                    <!-- Popover -->
                    <div class="completion-popover" id="completenessPopover">
                        <div class="popover-header">
                            <strong>Missing Fields</strong>
                        </div>
                        <div class="popover-content">
                            {% if missing_fields %}
                                <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                    {% for field in missing_fields %}
                                        <li style="margin-bottom: 6px;">{{ field }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p style="margin: 0; color: var(--dash-primary);">✓ All fields completed!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Profile Content Circle -->
                <div style="text-align: center; position: relative;">
                    <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="contentPopover">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <!-- Background circle -->
                            <circle
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="#e5e7eb"
                                stroke-width="8"
                            />
                            <!-- Progress circle -->
                            <circle
                                id="profileContentCircle"
                                cx="60"
                                cy="60"
                                r="52"
                                fill="none"
                                stroke="var(--dash-primary)"
                                stroke-width="8"
                                stroke-linecap="round"
                                stroke-dasharray="326.73"
                                stroke-dashoffset="326.73"
                                transform="rotate(-90 60 60)"
                                style="transition: stroke-dashoffset 0.3s ease;"
                            />
                        </svg>
                        <div class="completion-percentage">
                            <span id="profileContentText">0%</span>
                        </div>
                    </div>
                    <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                        Profile content
                    </p>
                    <!-- Popover -->
                    <div class="completion-popover" id="contentPopover">
                        <div class="popover-header">
                            <strong>Missing Content</strong>
                        </div>
                        <div class="popover-content">
                            {% if content_missing %}
                                <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                    {% for item in content_missing %}
                                        <li style="margin-bottom: 6px;">{{ item }}</li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p style="margin: 0; color: var(--dash-primary);">✓ All content completed!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blog Activity -->
            <div style="padding: 40px 24px; border-top: 1px solid var(--dash-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h4 style="margin: 0; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main);">
                        Blog Activity
                    </h4>
                    <span style="font-size: 0.85rem; color: var(--dash-text-muted);">2/5</span>
                </div>
                <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--dash-primary); height: 100%; width: 40%; border-radius: 4px; transition: width 0.3s ease;"></div>
                </div>
                <p style="margin: 8px 0 16px; font-size: 0.8rem; color: var(--dash-text-muted); line-height: 1.4;">
                    Write blog posts to increase your credibility and attract more clients.
                </p>
                <a href="#" class="btn btn-primary btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    <i class="fas fa-plus"></i> Create a blog post
                </a>
            </div>

            <!-- Marketing Content -->
            <div style="padding: 20px 24px ; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main);">
                    Marketing Content
                </h4>
                <p style="margin: 0 0 20px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Use our tools to quickly and easily create your own quizzes, workshops, and more to share on social media. Engage with your audience and create connections that can turn into new clients.
                </p>
                
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox checked">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Create your quiz</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox checked">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Create your manual</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your workshop</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your challenge</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your webinar</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your e-book</span>
                    </div>
                    <div class="marketing-checkbox-item">
                        <div class="custom-checkbox">
                        </div>
                        <span>Create your template</span>
                    </div>
                </div>
                
                <a href="#" class="btn btn-primary btn-sm" style="width: 100%; text-align: center; display: inline-block;">
                    <i class="fas fa-plus"></i> Create Marketing Content
                </a>
            </div>

            <!-- Clients Reviews -->
            <div style="padding: 20px 24px; border-top: 1px solid var(--dash-border);">
                <h4 style="margin: 0 0 12px; font-size: 0.95rem; font-weight: 600; color: var(--dash-text-main);">
                    Clients Reviews
                </h4>
                <p style="margin: 0 0 20px; font-size: 0.85rem; color: var(--dash-text-muted); line-height: 1.5;">
                    Build trust and credibility with client reviews. Aim for at least three reviews to showcase your expertise and help potential clients make informed decisions.
                </p>
                
                <!-- Reviews Progress Bar -->
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 0.85rem; color: var(--dash-text-muted);">Reviews</span>
                        <span style="font-size: 0.85rem; font-weight: 600; color: var(--dash-text-main);">
                            <span id="reviewsCount">0</span>/3
                        </span>
                    </div>
                    <div style="width: 100%; height: 8px; background: var(--dash-border); border-radius: 4px; overflow: hidden;">
                        <div id="reviewsProgressBar" style="height: 100%; background: var(--dash-primary); border-radius: 4px; transition: width 0.3s ease; width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Verification Modal -->
<div id="emailModal" class="modal-overlay">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeEmailModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Step 1: New Email Input -->
        <div id="emailStep1">
            <div class="modal-header">
                <h3 class="modal-title">Change Email Address</h3>
                <p class="modal-subtitle">Enter your new email address. We'll send you a verification code.</p>
            </div>
            <form id="emailFormStep1" onsubmit="handleEmailStep1(event)">
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Email Address</label>
                    <input type="email" id="newEmailInput" class="form-input" placeholder="name@example.com" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary btn-full">Send Verification Code</button>
                    <button type="button" class="btn btn-outline" onclick="closeEmailModal()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Step 2: Verification Code -->
        <div id="emailStep2" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Verify Email</h3>
                <p class="modal-subtitle">Enter the 6-digit code sent to <strong id="confirmEmailDisplay"></strong></p>
            </div>
            <form id="emailFormStep2" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email">
                <input type="hidden" name="email" id="finalEmailInput">
                
                <div class="verification-input-group">
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary btn-full">Verify & Update Email</button>
                    <button type="button" class="btn btn-outline" onclick="backToStep1()">Back</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('profileImagePreview');
            const icon = document.getElementById('profileImageIcon');
            if (preview) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            if (icon) {
                icon.style.display = 'none';
            }
            // If preview doesn't exist, create it
            if (!preview && icon) {
                const img = document.createElement('img');
                img.id = 'profileImagePreview';
                img.src = e.target.result;
                img.alt = 'Profile';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '50%';
                icon.parentElement.appendChild(img);
                icon.style.display = 'none';
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Function to get color based on percentage
function getProgressColor(percentage) {
    if (percentage >= 90) {
        return '#059669'; // Dark green - Excellent (90-100%)
    } else if (percentage >= 70) {
        return '#10b981'; // Green - Good (70-89%)
    } else if (percentage >= 40) {
        return '#f59e0b'; // Orange - Needs improvement (40-69%)
    } else {
        return '#ef4444'; // Red - Low (0-39%)
    }
}

// Profile completion circle animation
document.addEventListener('DOMContentLoaded', function() {
    // Profile Completeness Circle
    const progressCircle = document.getElementById('profileProgressCircle');
    const completionText = document.getElementById('profileCompletionText');
    
    if (progressCircle && completionText) {
        const percentage = parseInt('{{ profile_completion|default:0 }}', 10) || 0;
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }

    // Profile Content Circle
    const contentCircle = document.getElementById('profileContentCircle');
    const contentText = document.getElementById('profileContentText');
    
    if (contentCircle && contentText) {
        // Calculate profile content percentage
        // Blog posts: 2 out of 5 = 40%
        // Marketing content: 2 out of 7 = ~28.6%
        // Average: (40 + 28.6) / 2 = ~34.3%
        const blogPosts = 2;
        const blogPostsTotal = 5;
        const marketingContent = 2; // quiz + manual checked
        const marketingContentTotal = 7;
        const reviews = 0; // Mockup data
        const reviewsTotal = 3;
        
        const blogPercentage = (blogPosts / blogPostsTotal) * 100;
        const marketingPercentage = (marketingContent / marketingContentTotal) * 100;
        const reviewsPercentage = (reviews / reviewsTotal) * 100;
        const contentPercentage = Math.round((blogPercentage + marketingPercentage + reviewsPercentage) / 3);
        
        // Update reviews display
        const reviewsCountEl = document.getElementById('reviewsCount');
        const reviewsProgressBar = document.getElementById('reviewsProgressBar');
        if (reviewsCountEl) reviewsCountEl.textContent = reviews;
        if (reviewsProgressBar) {
            const reviewsWidth = Math.min((reviews / reviewsTotal) * 100, 100);
            reviewsProgressBar.style.width = reviewsWidth + '%';
        }
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (contentPercentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(contentPercentage);
        contentCircle.style.stroke = color;
        
        // Update text
        contentText.textContent = contentPercentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            contentCircle.style.strokeDashoffset = offset;
        }, 200);
    }

    // Qualifications Management
    const qualificationTitle = document.getElementById('qualificationTitle');
    const qualificationSubtitle = document.getElementById('qualificationSubtitle');
    const qualificationDescription = document.getElementById('qualificationDescription');
    const addQualificationBtn = document.getElementById('addQualificationBtn');
    const qualificationsList = document.getElementById('qualificationsList');
    const qualificationsData = document.getElementById('qualificationsData');
    let qualificationsArray = [];

    // Load existing qualifications
    document.querySelectorAll('.qualification-item').forEach(item => {
        const title = item.getAttribute('data-title');
        const subtitle = item.getAttribute('data-subtitle');
        const description = item.getAttribute('data-description');
        qualificationsArray.push({ title: title, subtitle: subtitle, description: description });
    });

    function updateQualificationsData() {
        qualificationsData.value = JSON.stringify(qualificationsArray);
    }

    function renderQualificationsList() {
        qualificationsList.innerHTML = '';
        qualificationsArray.forEach((qual, index) => {
            const item = document.createElement('div');
            item.className = 'qualification-item';
            item.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--dash-bg); border: 1px solid var(--dash-border); border-radius: 8px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--dash-text-main); margin-bottom: 4px;">${qual.title}</div>
                        ${qual.subtitle ? `<div style="font-size: 0.9rem; color: var(--dash-text-main); margin-bottom: 4px;">${qual.subtitle}</div>` : ''}
                        ${qual.description ? `<div style="font-size: 0.85rem; color: var(--dash-text-muted);">${qual.description}</div>` : ''}
                    </div>
                    <button type="button" class="remove-qualification-btn" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            qualificationsList.appendChild(item);
        });
        updateQualificationsData();
    }

    if (addQualificationBtn && qualificationTitle && qualificationSubtitle && qualificationDescription) {
        addQualificationBtn.addEventListener('click', function() {
            const title = qualificationTitle.value.trim();
            const subtitle = qualificationSubtitle.value.trim();
            const description = qualificationDescription.value.trim();
            
            if (title) {
                qualificationsArray.push({ title: title, subtitle: subtitle, description: description });
                qualificationTitle.value = '';
                qualificationSubtitle.value = '';
                qualificationDescription.value = '';
                renderQualificationsList();
            }
        });

        // Allow Enter key to add qualification
        qualificationTitle.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addQualificationBtn.click();
            }
        });

        qualificationSubtitle.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addQualificationBtn.click();
            }
        });
    }

    // Remove qualification
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-qualification-btn')) {
            const btn = e.target.closest('.remove-qualification-btn');
            const index = parseInt(btn.getAttribute('data-index'));
            if (!isNaN(index)) {
                qualificationsArray.splice(index, 1);
                renderQualificationsList();
            } else {
                // Fallback for existing qualifications loaded from template
                const item = btn.closest('.qualification-item');
                const title = item.getAttribute('data-title');
                const subtitle = item.getAttribute('data-subtitle');
                const description = item.getAttribute('data-description');
                qualificationsArray = qualificationsArray.filter(qual => 
                    !(qual.title === title && qual.subtitle === subtitle && qual.description === description)
                );
                item.remove();
                updateQualificationsData();
            }
        }
    });

    // Tags management
    const tagInput = document.getElementById('tagInput');
    const addTagBtn = document.getElementById('addTagBtn');
    const tagsList = document.getElementById('tagsList');
    const tagsData = document.getElementById('tagsData');
    const tagSuggestions = document.getElementById('tagSuggestions');
    const predefinedTagsData = document.getElementById('predefinedTagsData');
    const predefinedTags = predefinedTagsData ? JSON.parse(predefinedTagsData.textContent) : [];
    let tagsArray = [];
    let tagDebounceTimer;

    // Initialize tags array from existing tags
    const existingTags = tagsList.querySelectorAll('.tag-item');
    existingTags.forEach(tagItem => {
        const tagName = tagItem.getAttribute('data-tag-name');
        if (tagName && !tagsArray.includes(tagName)) {
            tagsArray.push(tagName);
        }
    });

    function updateTagsData() {
        tagsData.value = JSON.stringify(tagsArray);
    }

    function renderTagsList() {
        tagsList.innerHTML = '';
        tagsArray.forEach(tagName => {
            const tagItem = document.createElement('div');
            tagItem.className = 'tag-item';
            tagItem.setAttribute('data-tag-name', tagName);
            
            const tagText = document.createElement('span');
            tagText.className = 'tag-text';
            tagText.textContent = tagName;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-tag-btn';
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener('click', function() {
                const index = tagsArray.indexOf(tagName);
                if (index > -1) {
                    tagsArray.splice(index, 1);
                    renderTagsList();
                    updateTagsData();
                }
            });
            
            tagItem.appendChild(tagText);
            tagItem.appendChild(removeBtn);
            tagsList.appendChild(tagItem);
        });
        updateTagsData();
    }

    function filterTagSuggestions(query) {
        const filtered = predefinedTags.filter(tag => 
            tag.toLowerCase().includes(query.toLowerCase()) && !tagsArray.includes(tag)
        );
        displayTagSuggestions(filtered);
    }

    function displayTagSuggestions(suggestions) {
        if (suggestions.length === 0) {
            tagSuggestions.style.display = 'none';
            return;
        }

        tagSuggestions.innerHTML = '';
        suggestions.slice(0, 10).forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1 || index === 9) item.classList.add('last-item');
            item.textContent = suggestion;
            item.addEventListener('click', function() {
                if (!tagsArray.includes(suggestion)) {
                    tagsArray.push(suggestion);
                    tagInput.value = '';
                    tagSuggestions.style.display = 'none';
                    renderTagsList();
                }
            });
            tagSuggestions.appendChild(item);
        });

        tagSuggestions.style.display = 'block';
    }

    if (addTagBtn && tagInput && tagSuggestions) {
        // Show suggestions on focus
        tagInput.addEventListener('focus', function() {
            if (this.value.trim()) {
                filterTagSuggestions(this.value.trim());
            }
        });

        // Filter suggestions as user types
        tagInput.addEventListener('input', function() {
            clearTimeout(tagDebounceTimer);
            const query = this.value.trim();
            
            tagDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterTagSuggestions(query);
                } else {
                    tagSuggestions.style.display = 'none';
                }
            }, 200);
        });

        addTagBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const tagName = tagInput.value.trim();
            
            if (!tagName) return;
            
            // Find matching predefined tag (case-insensitive) to use exact capitalization
            const matchingTag = predefinedTags.find(tag => tag.toLowerCase() === tagName.toLowerCase());
            
            // Use the exact predefined tag name if found, otherwise use the typed name
            const tagToAdd = matchingTag || tagName;
            
            if (!tagsArray.includes(tagToAdd)) {
                tagsArray.push(tagToAdd);
                tagInput.value = '';
                tagSuggestions.style.display = 'none';
                renderTagsList();
            } else {
                tagInput.value = '';
                tagSuggestions.style.display = 'none';
            }
        });

        // Allow Enter key to add tag
        tagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                addTagBtn.click();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!tagInput.contains(event.target) && !tagSuggestions.contains(event.target) && !addTagBtn.contains(event.target)) {
                tagSuggestions.style.display = 'none';
            }
        });
    }

    // Initialize tags data on page load
    updateTagsData();

    // Languages management
    const languageInput = document.getElementById('languageInput');
    const languagesList = document.getElementById('languagesList');
    const languagesData = document.getElementById('languagesData');
    const languageSuggestions = document.getElementById('languageSuggestions');
    const predefinedLanguagesData = document.getElementById('predefinedLanguagesData');
    const predefinedLanguages = predefinedLanguagesData ? JSON.parse(predefinedLanguagesData.textContent) : [];
    let languagesArray = [];
    let languageDebounceTimer;

    // Initialize languages array from existing languages
    const existingLanguages = languagesList.querySelectorAll('.tag-item');
    existingLanguages.forEach(langItem => {
        const langId = langItem.getAttribute('data-lang-id');
        if (langId && !languagesArray.includes(langId)) {
            languagesArray.push(langId);
        }
    });

    function updateLanguagesData() {
        languagesData.value = JSON.stringify(languagesArray);
    }

    function renderLanguagesList() {
        languagesList.innerHTML = '';
        languagesArray.forEach(langId => {
            const lang = predefinedLanguages.find(l => l.id === langId);
            if (lang) {
                const langItem = document.createElement('div');
                langItem.className = 'tag-item';
                langItem.setAttribute('data-lang-id', langId);
                
                const langText = document.createElement('span');
                langText.className = 'tag-text';
                langText.textContent = lang.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    const index = languagesArray.indexOf(langId);
                    if (index > -1) {
                        languagesArray.splice(index, 1);
                        renderLanguagesList();
                        updateLanguagesData();
                    }
                });
                
                langItem.appendChild(langText);
                langItem.appendChild(removeBtn);
                languagesList.appendChild(langItem);
            }
        });
        updateLanguagesData();
    }

    function filterLanguageSuggestions(query) {
        const filtered = predefinedLanguages.filter(lang => 
            lang.name.toLowerCase().includes(query.toLowerCase()) && !languagesArray.includes(lang.id)
        );
        displayLanguageSuggestions(filtered);
    }

    function displayLanguageSuggestions(suggestions) {
        if (suggestions.length === 0) {
            languageSuggestions.style.display = 'none';
            return;
        }

        languageSuggestions.innerHTML = '';
        suggestions.slice(0, 10).forEach((lang, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1 || index === 9) item.classList.add('last-item');
            item.textContent = lang.name;
            item.addEventListener('click', function() {
                if (!languagesArray.includes(lang.id)) {
                    languagesArray.push(lang.id);
                    languageInput.value = '';
                    languageSuggestions.style.display = 'none';
                    renderLanguagesList();
                }
            });
            languageSuggestions.appendChild(item);
        });

        languageSuggestions.style.display = 'block';
    }

    if (languageInput && languageSuggestions) {
        languageInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length > 0) {
                filterLanguageSuggestions(query);
            } else {
                // Show all suggestions when focused and empty
                displayLanguageSuggestions(predefinedLanguages.filter(lang => !languagesArray.includes(lang.id)).slice(0, 10));
            }
        });

        languageInput.addEventListener('input', function() {
            clearTimeout(languageDebounceTimer);
            const query = this.value.trim();
            
            languageDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterLanguageSuggestions(query);
                } else {
                    // Show all available suggestions when input is empty
                    displayLanguageSuggestions(predefinedLanguages.filter(lang => !languagesArray.includes(lang.id)).slice(0, 10));
                }
            }, 200);
        });

        languageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const query = languageInput.value.trim();
                const lang = predefinedLanguages.find(l => l.name.toLowerCase() === query.toLowerCase());
                
                if (lang && !languagesArray.includes(lang.id)) {
                    languagesArray.push(lang.id);
                    languageInput.value = '';
                    languageSuggestions.style.display = 'none';
                    renderLanguagesList();
                } else if (query && !lang) {
                    showNotification('Please select a language from the suggestions.', 'error');
                    if (query.length > 0) {
                        filterLanguageSuggestions(query);
                    }
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!languageInput.contains(event.target) && !languageSuggestions.contains(event.target)) {
                languageSuggestions.style.display = 'none';
            }
        });
    }

    updateLanguagesData();

    // Categories management
    const categoryInput = document.getElementById('categoryInput');
    const categoriesList = document.getElementById('categoriesList');
    const categoriesData = document.getElementById('categoriesData');
    const categorySuggestions = document.getElementById('categorySuggestions');
    const predefinedCategoriesData = document.getElementById('predefinedCategoriesData');
    const predefinedCategories = predefinedCategoriesData ? JSON.parse(predefinedCategoriesData.textContent) : [];
    let categoriesArray = [];
    let categoryDebounceTimer;
    
    // Debug: Check if categories data is loaded
    if (!predefinedCategoriesData || predefinedCategories.length === 0) {
        console.warn('No predefined categories data found or empty array');
    }

    // Initialize categories array from existing categories
    const existingCategories = categoriesList.querySelectorAll('.tag-item');
    existingCategories.forEach(catItem => {
        const catId = catItem.getAttribute('data-cat-id');
        if (catId && !categoriesArray.includes(catId)) {
            categoriesArray.push(catId);
        }
    });

    function updateCategoriesData() {
        categoriesData.value = JSON.stringify(categoriesArray);
    }

    function renderCategoriesList() {
        categoriesList.innerHTML = '';
        categoriesArray.forEach(catId => {
            const cat = predefinedCategories.find(c => c.id === catId);
            if (cat) {
                const catItem = document.createElement('div');
                catItem.className = 'tag-item';
                catItem.setAttribute('data-cat-id', catId);
                
                const catText = document.createElement('span');
                catText.className = 'tag-text';
                catText.textContent = cat.name;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    const index = categoriesArray.indexOf(catId);
                    if (index > -1) {
                        categoriesArray.splice(index, 1);
                        renderCategoriesList();
                        updateCategoriesData();
                    }
                });
                
                catItem.appendChild(catText);
                catItem.appendChild(removeBtn);
                categoriesList.appendChild(catItem);
            }
        });
        updateCategoriesData();
    }

    function filterCategorySuggestions(query) {
        const filtered = predefinedCategories.filter(cat => 
            cat.name.toLowerCase().includes(query.toLowerCase()) && !categoriesArray.includes(cat.id)
        );
        displayCategorySuggestions(filtered);
    }

    function displayCategorySuggestions(suggestions) {
        if (suggestions.length === 0) {
            categorySuggestions.style.display = 'none';
            return;
        }

        categorySuggestions.innerHTML = '';
        suggestions.slice(0, 10).forEach((cat, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('first-item');
            if (index === suggestions.length - 1 || index === 9) item.classList.add('last-item');
            item.textContent = cat.name;
            item.addEventListener('click', function() {
                if (!categoriesArray.includes(cat.id)) {
                    categoriesArray.push(cat.id);
                    categoryInput.value = '';
                    categorySuggestions.style.display = 'none';
                    renderCategoriesList();
                }
            });
            categorySuggestions.appendChild(item);
        });

        categorySuggestions.style.display = 'block';
    }

    if (categoryInput && categorySuggestions) {
        categoryInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length > 0) {
                filterCategorySuggestions(query);
            } else {
                // Show all suggestions when focused and empty
                displayCategorySuggestions(predefinedCategories.filter(cat => !categoriesArray.includes(cat.id)).slice(0, 10));
            }
        });

        categoryInput.addEventListener('input', function() {
            clearTimeout(categoryDebounceTimer);
            const query = this.value.trim();
            
            categoryDebounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterCategorySuggestions(query);
                } else {
                    // Show all available suggestions when input is empty
                    displayCategorySuggestions(predefinedCategories.filter(cat => !categoriesArray.includes(cat.id)).slice(0, 10));
                }
            }, 200);
        });

        categoryInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                const query = categoryInput.value.trim();
                const cat = predefinedCategories.find(c => c.name.toLowerCase() === query.toLowerCase());
                
                if (cat && !categoriesArray.includes(cat.id)) {
                    categoriesArray.push(cat.id);
                    categoryInput.value = '';
                    categorySuggestions.style.display = 'none';
                    renderCategoriesList();
                } else if (query && !cat) {
                    showNotification('Please select a category from the suggestions.', 'error');
                    if (query.length > 0) {
                        filterCategorySuggestions(query);
                    }
                }
            }
        });

        document.addEventListener('click', function(event) {
            if (!categoryInput.contains(event.target) && !categorySuggestions.contains(event.target)) {
                categorySuggestions.style.display = 'none';
            }
        });
    }

    updateCategoriesData();

    // Update credentials data on form submit
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function() {
            updateQualificationsData();
            updateTagsData();
            updateLanguagesData();
            updateCategoriesData();
            
            // Update bio textarea with Quill content
            if (window.bioQuill) {
                document.getElementById('bioTextarea').value = window.bioQuill.root.innerHTML;
            }
        });
    }

    // Initialize Quill editor for Bio
    const bioTextarea = document.getElementById('bioTextarea');
    const bioEditor = document.getElementById('bioEditor');
    if (bioTextarea && bioEditor) {
        // Load Quill from CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
        script.onload = function() {
            window.bioQuill = new Quill('#bioEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'color': [] }, { 'background': [] }],
                        ['link'],
                        ['clean']
                    ]
                }
            });
            
            // Set initial content
            if (bioTextarea.value) {
                window.bioQuill.root.innerHTML = bioTextarea.value;
            }
            
            // Update textarea on text change
            window.bioQuill.on('text-change', function() {
                bioTextarea.value = window.bioQuill.root.innerHTML;
            });
        };
        document.head.appendChild(script);
    }

    // Autocomplete for Mentor Type
    const mentorTypeInput = document.getElementById('mentorTypeInput');
    const mentorTypeSuggestions = document.getElementById('mentorTypeSuggestions');
    const mentorTypesData = document.getElementById('mentorTypesData');
    const mentorTypes = mentorTypesData ? JSON.parse(mentorTypesData.textContent) : [];
    let debounceTimer;

    if (mentorTypeInput && mentorTypeSuggestions) {
        // Show suggestions on focus if input has value
        mentorTypeInput.addEventListener('focus', function() {
            if (this.value.trim()) {
                filterSuggestions(this.value.trim());
            } else {
                showAllSuggestions();
            }
        });

        // Filter suggestions as user types
        mentorTypeInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();
            
            debounceTimer = setTimeout(() => {
                if (query.length > 0) {
                    filterSuggestions(query);
                } else {
                    showAllSuggestions();
                }
            }, 200);
        });

        // Handle suggestion selection
        mentorTypeSuggestions.addEventListener('click', function(e) {
            if (e.target.classList.contains('suggestion-item')) {
                mentorTypeInput.value = e.target.textContent.trim();
                mentorTypeSuggestions.style.display = 'none';
                mentorTypeInput.focus();
            }
        });

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!mentorTypeInput.contains(event.target) && !mentorTypeSuggestions.contains(event.target)) {
                mentorTypeSuggestions.style.display = 'none';
            }
        });

        function filterSuggestions(query) {
            const filtered = mentorTypes.filter(type => 
                type.toLowerCase().includes(query.toLowerCase())
            );
            displaySuggestions(filtered);
        }

        function showAllSuggestions() {
            displaySuggestions(mentorTypes.slice(0, 10)); // Show first 10
        }

        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                mentorTypeSuggestions.style.display = 'none';
                return;
            }

            mentorTypeSuggestions.innerHTML = '';
            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                if (index === 0) item.classList.add('first-item');
                if (index === suggestions.length - 1) item.classList.add('last-item');
                item.textContent = suggestion;
                mentorTypeSuggestions.appendChild(item);
            });

            mentorTypeSuggestions.style.display = 'block';
        }
    }

    // Popover functionality
    const popoverTriggers = document.querySelectorAll('.completion-popover-trigger');
    popoverTriggers.forEach(trigger => {
        const popoverId = trigger.getAttribute('data-popover');
        const popover = document.getElementById(popoverId);
        
        if (popover) {
            trigger.addEventListener('mouseenter', function() {
                popover.style.display = 'block';
                setTimeout(() => {
                    popover.classList.add('active');
                }, 10);
            });
            
            trigger.addEventListener('mouseleave', function() {
                popover.classList.remove('active');
                setTimeout(() => {
                    popover.style.display = 'none';
                }, 200);
            });
        }
    });

    // Modal Logic
    const modal = document.getElementById('emailModal');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Close on outside click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }

    // Verification code input handling
    const digits = document.querySelectorAll('.verification-digit');
    digits.forEach((digit, idx) => {
        digit.addEventListener('input', function(e) {
            if (this.value.length === 1) {
                if (idx < digits.length - 1) digits[idx + 1].focus();
            }
        });
        
        digit.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value.length === 0) {
                if (idx > 0) digits[idx - 1].focus();
            }
        });
    });
});

function openEmailModal() {
    document.getElementById('emailModal').classList.add('active');
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    document.getElementById('newEmailInput').value = '';
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('active');
}

function handleEmailStep1(e) {
    e.preventDefault();
    const email = document.getElementById('newEmailInput').value;
    if (email) {
        document.getElementById('emailStep1').style.display = 'none';
        document.getElementById('emailStep2').style.display = 'block';
        document.getElementById('confirmEmailDisplay').textContent = email;
        document.getElementById('finalEmailInput').value = email;
        // Focus first digit
        setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
    }
}

function backToStep1() {
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
}
</script>
{% endblock %}

