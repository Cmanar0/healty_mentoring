{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Healthy Mentoring</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
</head>
<body>
  <!-- Auth Container -->
  <div class="auth-container">
    <div class="auth-card">
      <!-- Logo and Header -->
      <div class="auth-header-wrapper">
        <a href="{% url 'web:landing' %}" class="auth-logo">
          <img src="{% static 'images/logo.png' %}" alt="Healthy Mentoring">
        </a>
        <div class="auth-header-text">
          <h2>Welcome Back</h2>
          <p class="subtitle">Login to continue your journey</p>
        </div>
      </div>

      {% if email_not_verified %}
      <div class="form-errors email-not-verified-error" style="background-color: #fef2f2; border-left: 4px solid #ef4444; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
        <div style="display: flex; align-items: flex-start; gap: 12px;">
          <i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 1.2rem; margin-top: 2px;"></i>
          <div style="flex: 1;">
            <p style="color: #991b1b; font-weight: 600; margin: 0 0 8px 0;">Email Not Verified</p>
            <p style="color: #7f1d1d; margin: 0 0 12px 0; line-height: 1.5;">Please verify your email address before logging in. Check your inbox for the verification email.</p>
            <button type="button" id="resendVerificationBtn" class="btn-resend-verification" style="background-color: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s;">
              <i class="fas fa-paper-plane" style="margin-right: 6px;"></i>
              Resend Verification Email
            </button>
            <p id="resendMessage" style="margin: 8px 0 0 0; color: #059669; font-size: 0.9rem; display: none;"></p>
          </div>
        </div>
      </div>
      {% endif %}

      {% if form.non_field_errors and not email_not_verified %}
      <div class="form-errors">
        {{ form.non_field_errors }}
      </div>
      {% endif %}

      <form method="post" class="auth-form">
        {% csrf_token %}
        
        <!-- Email -->
        <div class="form-group">
          <label for="id_username">Email Address</label>
          <div class="input-wrapper">
            <input type="email" name="username" id="id_username" value="{{ form.username.value|default:'' }}" required placeholder="your@email.com" autocomplete="email">
            <button type="button" class="input-clear-btn" onclick="clearInput('id_username')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% if form.username.errors %}
          <ul class="errorlist">
            {% for error in form.username.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        <!-- Password -->
        <div class="form-group">
          <label for="id_password">Password</label>
          <div class="input-wrapper">
            <input type="password" name="password" id="id_password" required placeholder="Enter your password" autocomplete="current-password">
            <button type="button" class="password-toggle-btn" onclick="togglePassword('id_password', this)">
              <i class="fas fa-eye"></i>
            </button>
            <button type="button" class="input-clear-btn" onclick="clearInput('id_password')">
              <i class="fas fa-times"></i>
            </button>
          </div>
          {% if form.password.errors %}
          <ul class="errorlist">
            {% for error in form.password.errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn-submit" style="margin-top: 10px;">Login</button>
      </form>

      <!-- Links -->
      <div class="auth-links">
        <p><a href="{% url 'accounts:password_reset' %}">Forgot password?</a></p>
        <p>Don't have an account? <a href="{% url 'accounts:register' %}">Register</a></p>
      </div>
    </div>
  </div>

  {% if email_not_verified %}
  <script>
    // Function to get CSRF token from cookie or form
    function getCsrfToken() {
      // Try to get from cookie first
      const name = 'csrftoken';
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      // Fallback to template variable
      return cookieValue || '{{ csrf_token }}';
    }

    document.getElementById('resendVerificationBtn').addEventListener('click', function() {
      const btn = this;
      const messageDiv = document.getElementById('resendMessage');
      const userEmail = '{{ user_email|escapejs }}';
      
      // Disable button
      btn.disabled = true;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>Sending...';
      
      // Get CSRF token
      const csrfToken = getCsrfToken();
      
      // Send AJAX request
      fetch('{% url "accounts:resend_verification_email" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ email: userEmail })
      })
      .then(response => {
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          // If not JSON, it's probably an error page
          return response.text().then(text => {
            throw new Error('Server returned non-JSON response. This might be a CSRF error.');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          messageDiv.textContent = 'Verification email sent! Please check your inbox.';
          messageDiv.style.color = '#059669';
          messageDiv.style.display = 'block';
          btn.innerHTML = '<i class="fas fa-check" style="margin-right: 6px;"></i>Email Sent';
        } else {
          messageDiv.textContent = data.error || 'Failed to send email. Please try again later.';
          messageDiv.style.color = '#ef4444';
          messageDiv.style.display = 'block';
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
          btn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Resend Verification Email';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        messageDiv.textContent = 'An error occurred. Please refresh the page and try again.';
        messageDiv.style.color = '#ef4444';
        messageDiv.style.display = 'block';
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 6px;"></i>Resend Verification Email';
      });
    });
  </script>
  {% endif %}
  
  <script>
    // Clear input function
    function clearInput(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        input.value = '';
        input.focus();
        updateClearButton(inputId);
      }
    }

    // Toggle password visibility
    function togglePassword(inputId, btn) {
      const input = document.getElementById(inputId);
      const icon = btn.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }

    // Update clear button visibility
    function updateClearButton(inputId) {
      const input = document.getElementById(inputId);
      if (input) {
        const wrapper = input.closest('.input-wrapper');
        const clearBtn = wrapper ? wrapper.querySelector('.input-clear-btn') : null;
        if (clearBtn) {
          if (input.value && input.value.trim() !== '') {
            clearBtn.classList.add('show');
          } else {
            clearBtn.classList.remove('show');
          }
        }
      }
    }

    // Initialize clear buttons
    document.addEventListener('DOMContentLoaded', function() {
      const usernameInput = document.getElementById('id_username');
      const passwordInput = document.getElementById('id_password');
      
      if (usernameInput) {
        usernameInput.addEventListener('input', function() {
          updateClearButton('id_username');
        });
        updateClearButton('id_username');
      }
      
      if (passwordInput) {
        passwordInput.addEventListener('input', function() {
          updateClearButton('id_password');
        });
        updateClearButton('id_password');
      }
    });
  </script>
</body>
</html>
