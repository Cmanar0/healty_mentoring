{% extends "dashboard_user/base.html" %}
{% load static %}
{% load custom_filters %}

{% block page_title %}{{ project.title }}{% endblock %}

{% block dashboard_content %}
<div class="dash-user-project-detail-page">
  <div class="dash-user-project-detail-header">
    <a href="{% url 'general:dashboard_user:projects_list' %}" class="dash-user-back-link">
      <i class="fas fa-arrow-left"></i> Back to Projects
    </a>
    <h1>{{ project.title }}</h1>
  </div>

  <div class="dash-user-project-detail-content">
    <!-- Project Info Card -->
    <div class="dash-user-project-info-card">
      <div class="dash-user-project-info-header">
        <h2>Project Information</h2>
        {% if project.template %}
          <span class="dash-user-project-badge">{{ project.template.name }}</span>
        {% endif %}
      </div>
      
      {% if project.description %}
        <div class="dash-user-project-info-section">
          <h3>Description</h3>
          <p>{{ project.description }}</p>
        </div>
      {% endif %}

      <div class="dash-user-project-info-grid">
        {% if project.template %}
          <div class="dash-user-project-info-item">
            <span class="dash-user-project-info-label">Template:</span>
            <span class="dash-user-project-info-value">{{ project.template.name }}</span>
          </div>
        {% endif %}
        
        {% if project.supervised_by %}
          <div class="dash-user-project-info-item">
            <span class="dash-user-project-info-label">Mentor:</span>
            <span class="dash-user-project-info-value">
              {{ project.supervised_by.first_name }} {{ project.supervised_by.last_name }}
            </span>
          </div>
        {% endif %}
        
        <div class="dash-user-project-info-item">
          <span class="dash-user-project-info-label">Status:</span>
          <span class="dash-user-project-info-value dash-user-status-{{ project.assignment_status }}">
            {{ project.get_assignment_status_display }}
          </span>
        </div>
        
        <div class="dash-user-project-info-item">
          <span class="dash-user-project-info-label">Created:</span>
          <span class="dash-user-project-info-value">{{ project.created_at|date:"M d, Y" }}</span>
        </div>
        
        {% if project.target_completion_date %}
          <div class="dash-user-project-info-item">
            <span class="dash-user-project-info-label">Target Completion:</span>
            <span class="dash-user-project-info-value">{{ project.target_completion_date|date:"M d, Y" }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Questionnaire Section -->
    {% if questions %}
      <div class="dash-user-project-section">
        <h2>Project Questionnaire</h2>
        
        {% if not project.questionnaire_completed %}
          <form id="questionnaireForm" class="dash-user-questionnaire-form">
            {% csrf_token %}
            {% for question in questions %}
              <div class="dash-user-question-item">
                <label class="dash-user-question-label">
                  {{ question.question_text }}
                  {% if question.is_required %}
                    <span class="dash-user-required">*</span>
                  {% endif %}
                </label>
                {% if question.help_text %}
                  <p class="dash-user-question-help">{{ question.help_text }}</p>
                {% endif %}
                
                {% if question.question_type == 'textarea' %}
                  <textarea 
                    name="question_{{ question.id }}" 
                    id="question_{{ question.id }}"
                    class="dash-user-question-input"
                    rows="4"
                    {% if question.is_required %}required{% endif %}
                  >{{ answers|get_item:question.id|default:'' }}</textarea>
                {% elif question.question_type == 'date' %}
                  <input 
                    type="date" 
                    name="question_{{ question.id }}" 
                    id="question_{{ question.id }}"
                    class="dash-user-question-input"
                    value="{{ answers|get_item:question.id|default:'' }}"
                    {% if question.is_required %}required{% endif %}
                  >
                {% elif question.question_type == 'number' %}
                  <input 
                    type="number" 
                    name="question_{{ question.id }}" 
                    id="question_{{ question.id }}"
                    class="dash-user-question-input"
                    value="{{ answers|get_item:question.id|default:'' }}"
                    {% if question.is_required %}required{% endif %}
                  >
                {% elif question.question_type == 'select' %}
                  <select 
                    name="question_{{ question.id }}" 
                    id="question_{{ question.id }}"
                    class="dash-user-question-input"
                    {% if question.is_required %}required{% endif %}
                  >
                    <option value="">Select an option</option>
                    {% for option in question.options %}
                      <option value="{{ option }}" {% if answers|get_item:question.id == option %}selected{% endif %}>
                        {{ option }}
                      </option>
                    {% endfor %}
                  </select>
                {% else %}
                  <input 
                    type="text" 
                    name="question_{{ question.id }}" 
                    id="question_{{ question.id }}"
                    class="dash-user-question-input"
                    value="{{ answers|get_item:question.id|default:'' }}"
                    {% if question.is_required %}required{% endif %}
                  >
                {% endif %}
                <div class="dash-user-question-error" id="error_{{ question.id }}"></div>
              </div>
            {% endfor %}
            
            <div class="dash-user-questionnaire-actions">
              <button type="submit" class="dash-user-btn-submit">
                <i class="fas fa-check"></i> Submit Questionnaire
              </button>
            </div>
          </form>
        {% else %}
          <div class="dash-user-questionnaire-completed">
            <div class="dash-user-questionnaire-completed-badge">
              <i class="fas fa-check-circle"></i> 
              <span>Project Definition Complete</span>
              {% if project.questionnaire_completed_at %}
                <span class="dash-user-questionnaire-date">Completed on {{ project.questionnaire_completed_at|date:"M d, Y" }}</span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    {% endif %}

    <!-- Modules Section -->
    {% if active_modules %}
      <div class="dash-user-project-section">
        <h2>Active Modules</h2>
        <div class="dash-user-modules-grid">
          {% for module_instance in active_modules %}
            <div class="dash-user-module-card" style="border-left: 4px solid {{ module_instance.module.color|default:'#10b981' }};">
              <div class="dash-user-module-header">
                {% if module_instance.module.icon %}
                  <i class="{{ module_instance.module.icon }}" style="color: {{ module_instance.module.color|default:'#10b981' }};"></i>
                {% endif %}
                <h3 class="dash-user-module-name">{{ module_instance.module.name }}</h3>
              </div>
              <p class="dash-user-module-description">{{ module_instance.module.description }}</p>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Stages Section -->
    {% if project.questionnaire_completed %}
      <div class="dash-user-project-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0;">Project Stages</h2>
          {% if is_supervisor %}
            <button class="dash-user-btn-create-stage" onclick="openCreateStageModal()">
              <i class="fas fa-plus"></i> Create Stage
            </button>
          {% endif %}
        </div>
        
        {% if stages %}
          <div class="dash-user-stages-list">
            {% for stage in stages %}
              <div class="dash-user-stage-card">
                <div class="dash-user-stage-header">
                  <div class="dash-user-stage-number">{{ forloop.counter }}</div>
                  <div class="dash-user-stage-content">
                    <h3 class="dash-user-stage-title">{{ stage.title }}</h3>
                    {% if stage.description %}
                      <p class="dash-user-stage-description">{{ stage.description }}</p>
                    {% endif %}
                  </div>
                  <div class="dash-user-stage-status">
                    {% if stage.is_completed %}
                      <span class="dash-user-stage-completed">
                        <i class="fas fa-check-circle"></i> Completed
                      </span>
                    {% else %}
                      <span class="dash-user-stage-pending">Pending</span>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="dash-user-project-placeholder">
            {% if is_supervisor %}
              No stages created yet. Click "Create Stage" to get started.
            {% else %}
              No stages created yet.
            {% endif %}
          </p>
        {% endif %}
      </div>
    {% else %}
      <div class="dash-user-project-section">
        <h2>Project Stages</h2>
        <p class="dash-user-project-placeholder">Complete the project questionnaire to create stages.</p>
      </div>
    {% endif %}
  </div>
</div>

<style>
.dash-user-project-detail-page {
  padding: 32px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
}

.dash-user-project-detail-header {
  margin-bottom: 32px;
}

.dash-user-back-link {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  color: #6b7280;
  text-decoration: none;
  font-size: 0.875rem;
  margin-bottom: 16px;
  transition: color 0.2s;
}

.dash-user-back-link:hover {
  color: #10b981;
}

.dash-user-project-detail-header h1 {
  font-size: 2rem;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.dash-user-project-detail-content {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.dash-user-project-info-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 24px;
}

.dash-user-project-info-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e5e7eb;
}

.dash-user-project-info-header h2 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.dash-user-project-badge {
  background: #10b981;
  color: #ffffff;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 500;
}

.dash-user-project-info-section {
  margin-bottom: 24px;
}

.dash-user-project-info-section h3 {
  font-size: 1rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.dash-user-project-info-section p {
  color: #6b7280;
  line-height: 1.6;
}

.dash-user-project-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.dash-user-project-info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.dash-user-project-info-label {
  font-size: 0.75rem;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dash-user-project-info-value {
  font-size: 0.875rem;
  color: #374151;
  font-weight: 500;
}

.dash-user-status-pending {
  color: #f59e0b;
}

.dash-user-status-assigned {
  color: #3b82f6;
}

.dash-user-status-accepted {
  color: #10b981;
}

.dash-user-project-section {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 24px;
}

.dash-user-project-section h2 {
  font-size: 1.25rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 16px;
}

.dash-user-project-placeholder {
  color: #9ca3af;
  font-style: italic;
  padding: 32px;
  text-align: center;
}

.dash-user-questionnaire-form {
  margin-top: 16px;
}

.dash-user-question-item {
  margin-bottom: 24px;
}

.dash-user-question-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.dash-user-required {
  color: #ef4444;
}

.dash-user-question-help {
  font-size: 0.75rem;
  color: #6b7280;
  margin-bottom: 8px;
  font-style: italic;
}

.dash-user-question-input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 0.875rem;
  font-family: inherit;
  transition: border-color 0.2s;
}

.dash-user-question-input:focus {
  outline: none;
  border-color: #10b981;
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.dash-user-question-error {
  color: #ef4444;
  font-size: 0.75rem;
  margin-top: 4px;
  display: none;
}

.dash-user-question-error.show {
  display: block;
}

.dash-user-questionnaire-actions {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
}

.dash-user-btn-submit {
  background: #10b981;
  color: #ffffff;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.dash-user-btn-submit:hover {
  background: #059669;
}

.dash-user-btn-submit:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.dash-user-questionnaire-completed {
  margin-top: 16px;
}

.dash-user-questionnaire-completed-badge {
  background: #d1fae5;
  color: #065f46;
  padding: 12px 16px;
  border-radius: 8px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}

.dash-user-questionnaire-date {
  font-size: 0.875rem;
  opacity: 0.8;
  margin-left: 8px;
}

.dash-user-questionnaire-answers {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.dash-user-answer-item {
  padding-bottom: 24px;
  border-bottom: 1px solid #e5e7eb;
}

.dash-user-answer-item:last-child {
  border-bottom: none;
}

.dash-user-answer-question {
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.dash-user-answer-text {
  color: #6b7280;
  line-height: 1.6;
  white-space: pre-wrap;
}

.dash-user-modules-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.dash-user-module-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s;
}

.dash-user-module-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.dash-user-module-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.dash-user-module-header i {
  font-size: 1.25rem;
}

.dash-user-module-name {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.dash-user-module-description {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.5;
}

.dash-user-btn-create-stage {
  background: #10b981;
  color: #ffffff;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 0.875rem;
}

.dash-user-btn-create-stage:hover {
  background: #059669;
}

.dash-user-stages-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 16px;
}

.dash-user-stage-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  transition: all 0.2s;
}

.dash-user-stage-card:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.dash-user-stage-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.dash-user-stage-number {
  width: 32px;
  height: 32px;
  background: #10b981;
  color: #ffffff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  flex-shrink: 0;
}

.dash-user-stage-content {
  flex: 1;
  min-width: 0;
}

.dash-user-stage-title {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin: 0 0 8px 0;
}

.dash-user-stage-description {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
  line-height: 1.5;
}

.dash-user-stage-status {
  flex-shrink: 0;
}

.dash-user-stage-completed {
  color: #10b981;
  font-weight: 500;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.dash-user-stage-pending {
  color: #f59e0b;
  font-weight: 500;
  font-size: 0.875rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('questionnaireForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      
      // Collect answers
      const answers = {};
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(input => {
        if (input.name && input.name.startsWith('question_')) {
          const questionId = input.name.replace('question_', '');
          answers[questionId] = input.value.trim();
        }
      });
      
      // Clear previous errors
      document.querySelectorAll('.dash-user-question-error').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
      });
      
      fetch('{% url "general:dashboard_user:submit_questionnaire" project.id %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answers: answers })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = data.redirect_url || window.location.href;
        } else {
          // Show errors
          if (data.errors) {
            Object.keys(data.errors).forEach(questionId => {
              const errorEl = document.getElementById('error_' + questionId);
              if (errorEl) {
                errorEl.textContent = data.errors[questionId];
                errorEl.classList.add('show');
              }
            });
          }
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Questionnaire';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting the questionnaire.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Questionnaire';
      });
    });
  }
  
  window.openCreateStageModal = function() {
    const modal = document.getElementById('createStageModal');
    if(modal) { modal.style.display = 'flex'; setTimeout(()=>modal.classList.add('active'),10); }
  };
});
</script>

{% include 'dashboard_user/projects/modals/create_stage_modal.html' %}
{% endblock %}
