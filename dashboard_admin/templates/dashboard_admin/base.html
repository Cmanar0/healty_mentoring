{% extends "base.html" %}
{% load static %}

{% block title %}{% block page_title %}Admin Dashboard{% endblock %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/notifications.css' %}">
{% endblock %}

{% block navbar %}
<header class="dashboard-header">
  <nav class="dashboard-top-nav">
    <div class="dashboard-nav-left">
      <button class="hamburger-toggle" id="hamburgerToggle" aria-label="Toggle menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="{% url 'web:landing' %}" class="dashboard-logo-link">
        <img src="{% static 'images/logo.png' %}" alt="logo" class="logo">
      </a>
    </div>
    <div class="dashboard-top-actions">
      {% if user.is_authenticated and user.profile.first_name and user.profile.last_name %}
        <div class="dashboard-top-actions-group" style="display: none !important;">
          <!-- Notification Bell -->
          {% include "general/notifications/dropdown_snippet_admin.html" %}
        </div>
          <div class="user-profile-dropdown">
          <button class="user-profile-trigger" id="userProfileTrigger" style="display: none !important;">
            <span class="user-name">{{ user.profile.first_name }} {{ user.profile.last_name }}</span>
            <div class="user-avatar" style="width:36px;height:36px;border-radius:50%;overflow:hidden;flex-shrink:0;">
              {% if user.profile.profile_picture %}
                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.profile.first_name }}" width="36" height="36" style="width:36px;height:36px;object-fit:cover;border-radius:50%;display:block;">
              {% else %}
                <div class="avatar-placeholder">
                  <i class="fas fa-user"></i>
                </div>
              {% endif %}
            </div>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu" style="display: none !important;">
            <form action="{% url 'accounts:logout' %}" method="post" class="dropdown-item-form">
          {% csrf_token %}
              <button type="submit" class="dropdown-item logout-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
              </button>
        </form>
          </div>
        </div>
        </div>
      {% endif %}
    </div>
  </nav>
</header>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
  <!-- Left Sidebar -->
  <aside class="dashboard-sidebar" id="dashboardSidebar">
    <nav class="sidebar-nav">
      <ul class="sidebar-menu">
        <li>
          <a href="/dashboard/admin/" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" title="Home">
            <i class="fas fa-home"></i>
            <span class="sidebar-text">Home</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/admin/notifications/" class="sidebar-link {% if request.resolver_match.url_name == 'notifications' %}active{% endif %}" title="Notifications">
            <i class="fas fa-bell"></i>
            <span class="sidebar-text">Notifications</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/admin/blog/" class="sidebar-link {% if request.resolver_match.url_name == 'blog' %}active{% endif %}" title="Blog">
            <i class="fas fa-blog"></i>
            <span class="sidebar-text">Blog</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/admin/tickets/" class="sidebar-link {% if request.resolver_match.url_name == 'tickets' or request.resolver_match.url_name == 'ticket_detail' %}active{% endif %}" title="Tickets">
            <i class="fas fa-ticket-alt sidebar-icon-with-badge">
              {% if unresolved_tickets_count > 0 %}
                <span class="sidebar-badge">{{ unresolved_tickets_count }}</span>
              {% endif %}
            </i>
            <span class="sidebar-text">Tickets</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/admin/statistics/" class="sidebar-link {% if request.resolver_match.url_name == 'statistics' %}active{% endif %}" title="Statistics">
            <i class="fas fa-chart-bar"></i>
            <span class="sidebar-text">Statistics</span>
          </a>
        </li>
        <li>
          <a href="/dashboard/admin/billing/" class="sidebar-link {% if request.resolver_match.url_name == 'billing' %}active{% endif %}" title="Billing">
            <i class="fas fa-credit-card"></i>
            <span class="sidebar-text">Billing</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main" id="dashboardMain">
    {% block dashboard_content %}{% endblock %}
  </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/notifications.js' %}"></script>
{{ block.super }}
<style>
:root {
  --primary: #10b981;
  --text-dark: #1e293b;
  --text-light: #94a3b8;
}

/* Hamburger hover - green bars, no background */
.hamburger-toggle:hover {
  background: transparent;
}

.hamburger-toggle:hover span {
  background: var(--primary);
}

/* User Profile Dropdown */
.user-profile-dropdown {
  position: relative;
}

.user-profile-trigger {
  display: flex;
  align-items: center;
  gap: 12px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 8px;
  transition: none;
}

.user-profile-trigger:hover {
  background: transparent;
}

.user-profile-trigger:hover .user-name {
  color: var(--primary);
}

.user-name {
  font-weight: 500;
  color: var(--text-dark);
  font-size: 0.95rem;
  transition: color 0.2s ease;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 2px solid var(--primary);
}

.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
  font-size: 0.9rem;
}

.user-dropdown-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  min-width: 200px;
  padding: 0;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
  display: block;
  pointer-events: none;
}

.user-profile-dropdown.active .user-dropdown-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.dropdown-item,
.dropdown-item-form {
  display: block;
  width: 100%;
  text-align: left;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  color: var(--text-dark);
  text-decoration: none;
  transition: background 0.2s ease;
  border: none;
  background: transparent;
  width: 100%;
  cursor: pointer;
  font-size: 0.95rem;
}

.dropdown-item:hover {
  background: rgba(16, 185, 129, 0.1);
  color: var(--primary);
}

.dropdown-item i {
  width: 20px;
  text-align: center;
  color: var(--text-light);
}

.dropdown-item:hover i {
  color: var(--primary);
}

.dropdown-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
}

.logout-item {
  margin-top: 0;
  border-radius: 0 0 12px 12px;
}

.logout-item:hover {
  border-radius: 0 0 12px 12px;
}

.logout-item i {
  color: #ef4444;
}

.logout-item:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
}

.logout-item:hover i {
  color: #ef4444;
}

.dashboard-top-actions {
  display: flex;
}

/* Dashboard Top Actions Group */
.dashboard-top-actions-group {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Notification Bell */
.notification-dropdown {
  position: relative;
}

.notification-bell {
  position: relative;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  color: var(--text-dark);
  font-size: 1.2rem;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  flex-shrink: 0;
}

.notification-bell:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--primary);
}

.notification-bell i {
  display: block;
}

.notification-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
}

.notification-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  width: 380px;
  max-width: 90vw;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1001;
  display: flex;
  flex-direction: column;
  height: 500px;
  pointer-events: none;
}

.notification-dropdown.active .notification-menu {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.notification-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.notification-menu-header h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-dark);
}

.mark-all-read-btn {
  background: transparent;
  border: none;
  color: var(--primary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background 0.2s ease;
}

.mark-all-read-btn:hover {
  background: rgba(16, 185, 129, 0.1);
}

.notification-list {
  flex: 1;
  overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
  width: 6px;
}

.notification-list::-webkit-scrollbar-track {
  background: transparent;
}

.notification-list::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
}

.notification-item {
  display: flex;
  gap: 12px;
  padding: 12px 20px;
  transition: background 0.2s ease;
  cursor: pointer;
  border-left: 3px solid transparent;
}

.notification-item:hover {
  background: rgba(0, 0, 0, 0.03);
}

.notification-item.unread {
  background: rgba(16, 185, 129, 0.05);
  border-left-color: var(--primary);
}

.notification-item.unread:hover {
  background: rgba(16, 185, 129, 0.08);
}

.notification-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: rgba(16, 185, 129, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  color: var(--primary);
  font-size: 0.9rem;
}

.notification-content {
  flex: 1;
  min-width: 0;
}

.notification-title {
  margin: 0 0 4px 0;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--text-dark);
  line-height: 1.4;
}

.notification-time {
  margin: 0;
  font-size: 0.8rem;
  color: var(--text-light);
}

.notification-footer {
  padding: 12px 20px;
  border-top: 1px solid rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.view-all-notifications {
  color: var(--primary);
  text-decoration: none;
  font-size: 0.9rem;
  font-weight: 500;
  transition: color 0.2s ease;
}

.view-all-notifications:hover {
  color: var(--dash-primary-hover);
  text-decoration: underline;
}

/* Sidebar Badge */
.sidebar-link {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Sidebar Badge for Tickets */
.sidebar-icon-with-badge {
  position: relative;
  display: inline-block;
}

.sidebar-badge {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
  transform: translate(50%, -50%);
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const hamburgerToggle = document.getElementById('hamburgerToggle');
  const sidebar = document.getElementById('dashboardSidebar');
  const dashboardLayout = document.querySelector('.dashboard-layout');

  if (hamburgerToggle && sidebar && dashboardLayout) {
    // Check if sidebar should start collapsed (from localStorage)
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
      hamburgerToggle.classList.add('active');
    }

    hamburgerToggle.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      hamburgerToggle.classList.toggle('active');
      
      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });

    // Close sidebar when clicking outside on mobile
    if (window.innerWidth <= 768) {
      document.addEventListener('click', function(event) {
        if (!sidebar.contains(event.target) && !hamburgerToggle.contains(event.target)) {
          sidebar.classList.remove('open');
          hamburgerToggle.classList.remove('active');
        }
      });
    }
  }

  // Notification Bell Dropdown
  const notificationBell = document.getElementById('notificationBell');
  const notificationMenu = document.getElementById('notificationMenu');
  const notificationDropdown = document.querySelector('.notification-dropdown');
  const dashboardTopActionsGroup = document.querySelector('.dashboard-top-actions-group');

  // Remove inline display:none immediately so CSS can control visibility (prevents flash)
  if (dashboardTopActionsGroup) {
    dashboardTopActionsGroup.style.display = '';
  }

  if (notificationBell && notificationMenu) {
    // Remove inline display:none immediately so CSS can control visibility (prevents flash)
    notificationMenu.style.display = '';
    
    notificationBell.addEventListener('click', function(e) {
      e.stopPropagation();
      notificationDropdown.classList.toggle('active');
      // Close user profile dropdown if open
      if (userProfileDropdown) {
        userProfileDropdown.classList.remove('active');
      }
    });

    // Mark all as read button - handle form submission
    const markAllReadForm = document.querySelector('.mark-all-read-form');
    if (markAllReadForm) {
      markAllReadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const formData = new FormData(this);
        
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload the page to refresh notifications
            window.location.reload();
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      });
    }
  }

  // User Profile Dropdown
  const userProfileTrigger = document.getElementById('userProfileTrigger');
  const userDropdownMenu = document.getElementById('userDropdownMenu');
  const userProfileDropdown = document.querySelector('.user-profile-dropdown');

  if (userProfileTrigger && userDropdownMenu) {
    // Remove inline display:none immediately so CSS can control visibility (prevents flash)
    userDropdownMenu.style.display = '';
    userProfileTrigger.style.display = '';
    
    userProfileTrigger.addEventListener('click', function(e) {
      e.stopPropagation();
      userProfileDropdown.classList.toggle('active');
      // Close notification dropdown if open
      if (notificationDropdown) {
        notificationDropdown.classList.remove('active');
      }
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (userProfileDropdown && !userProfileDropdown.contains(event.target)) {
      userProfileDropdown.classList.remove('active');
    }
    if (notificationDropdown && !notificationDropdown.contains(event.target)) {
      notificationDropdown.classList.remove('active');
    }
  });
  
  // Notification Modal Functions (for dropdown snippet)
  window.openNotificationModal = function(notificationId) {
    const modal = document.getElementById('notificationModal');
    const content = document.getElementById('notificationModalContent');
    
    if (!modal || !content) {
      console.error('Notification modal elements not found', { modal: !!modal, content: !!content });
      return;
    }
    
    // Show loading state
    content.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top: 16px;">Loading...</p></div>';
    
    // Show modal - use both class and style to ensure it displays
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    
    // Fetch notification details
    const url = `/dashboard/admin/notifications/${notificationId}/modal/`;
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.text();
      })
      .then(html => {
        content.innerHTML = html;
        // Close dropdown when modal opens
        if (notificationDropdown) {
          notificationDropdown.classList.remove('active');
        }
      })
      .catch(error => {
        console.error('Error loading notification:', error);
        content.innerHTML = '<div style="text-align: center; padding: 40px;"><p style="color: #ef4444;">Error loading notification</p></div>';
      });
  };
  
  window.closeNotificationModal = function() {
    const modal = document.getElementById('notificationModal');
    if (modal) {
      modal.style.display = 'none';
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      // Reload the page to refresh notifications
      window.location.reload();
    }
  };
  
  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('notificationModal');
      if (modal && (modal.style.display === 'flex' || modal.style.display === '')) {
        window.closeNotificationModal();
      }
    }
  });
  
  // Close modal when clicking outside - initialize after DOM is ready
  setTimeout(function() {
    const modal = document.getElementById('notificationModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal || e.target.classList.contains('modal-overlay')) {
          window.closeNotificationModal();
        }
      });
    }
  }, 100);
});
</script>
<style>
  /* Notification Modal Styles */
  #notificationModal,
  #notificationModal.modal-overlay {
    display: none !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
    z-index: 10000 !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  /* When modal is shown via JavaScript */
  #notificationModal[style*="display: flex"],
  #notificationModal.modal-overlay[style*="display: flex"] {
    display: flex !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  #notificationModal .modal-content {
    background: white;
    border-radius: 12px;
    max-width: 600px;
    min-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }
  
  #notificationModal .modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(15, 23, 42, 0.1);
    border: 1px solid rgba(15, 23, 42, 0.1);
    color: #64748b;
    font-size: 1rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 20;
    padding: 0;
  }
  
  #notificationModal .modal-close:hover {
    background: #ef4444;
    border-color: #ef4444;
    color: white;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
  }
</style>
{% endblock %}

