{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}My Account{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="dashboard-grid">
        <!-- Profile Card -->
        <div class="dashboard-card col-span-4">
            <div class="card-header">
                <h3 class="card-title">Your Profile</h3>
            </div>
            <div style="text-align: center; padding: 24px; display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                <div class="profile-section-wrapper">
                    <div class="profile-avatar-large">
                        {% if user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="Profile">
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <h3 style="margin: 0 0 4px; color: var(--dash-text-main);">{{ user.profile.first_name }} {{ user.profile.last_name }}</h3>
                    {% with tag_list=user.profile.tags.all %}
                        {% if tag_list %}
                            <p style="margin: 0; color: var(--dash-text-muted); font-size: 0.9rem;">
                                {% for tag in tag_list %}
                                    {{ tag.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </p>
                        {% else %}
                            <p style="margin: 0; color: var(--dash-text-muted);">Mentor</p>
                        {% endif %}
                    {% endwith %}

                    <!-- Profile Completion Circles -->
                    <div style="margin-top: 24px; display: flex; justify-content: center; gap: 32px;">
                        <!-- Profile Completeness Circle -->
                        <div style="text-align: center; position: relative;">
                            <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="accountCompletenessPopover">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <!-- Background circle -->
                                    <circle
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="#e5e7eb"
                                        stroke-width="8"
                                    />
                                    <!-- Progress circle -->
                                    <circle
                                        id="progressCircle"
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="var(--dash-primary)"
                                        stroke-width="8"
                                        stroke-linecap="round"
                                        stroke-dasharray="326.73"
                                        stroke-dashoffset="326.73"
                                        transform="rotate(-90 60 60)"
                                        style="transition: stroke-dashoffset 0.3s ease;"
                                    />
                                </svg>
                                <div class="completion-percentage">
                                    <span id="completionText">{{ profile_completion|default:0 }}%</span>
                                </div>
                            </div>
                            <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                                Profile completeness
                            </p>
                            <!-- Popover -->
                            <div class="completion-popover" id="accountCompletenessPopover">
                                <div class="popover-header">
                                    <strong>Missing Fields</strong>
                                </div>
                                <div class="popover-content">
                                    {% if missing_fields %}
                                        <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                            {% for field in missing_fields %}
                                                <li style="margin-bottom: 6px;">{{ field }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p style="margin: 0; color: var(--dash-primary);">✓ All fields completed!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Profile Content Circle -->
                        <div style="text-align: center; position: relative;">
                            <div class="profile-completion-circle completion-popover-trigger" style="margin: 0 auto; cursor: help;" data-popover="accountContentPopover">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <!-- Background circle -->
                                    <circle
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="#e5e7eb"
                                        stroke-width="8"
                                    />
                                    <!-- Progress circle -->
                                    <circle
                                        id="accountContentCircle"
                                        cx="60"
                                        cy="60"
                                        r="52"
                                        fill="none"
                                        stroke="var(--dash-primary)"
                                        stroke-width="8"
                                        stroke-linecap="round"
                                        stroke-dasharray="326.73"
                                        stroke-dashoffset="326.73"
                                        transform="rotate(-90 60 60)"
                                        style="transition: stroke-dashoffset 0.3s ease;"
                                    />
                                </svg>
                                <div class="completion-percentage">
                                    <span id="accountContentText">0%</span>
                                </div>
                            </div>
                            <p style="margin: 12px 0 0; font-size: 0.85rem; color: var(--dash-text-muted);">
                                Profile content
                            </p>
                            <!-- Popover -->
                            <div class="completion-popover" id="accountContentPopover">
                                <div class="popover-header">
                                    <strong>Missing Content</strong>
                                </div>
                                <div class="popover-content">
                                    {% if content_missing %}
                                        <ul style="margin: 0; padding-left: 20px; text-align: left;">
                                            {% for item in content_missing %}
                                                <li style="margin-bottom: 6px;">{{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p style="margin: 0; color: var(--dash-primary);">✓ All content completed!</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 24px 16px 0 0;">
                        <a href="/dashboard/mentor/profile/" class="btn btn-outline" style="margin-left: 16px; width: 100%;">Update Profile</a>
                    </div>
                </div>

                <!-- Boost Promotion Box -->
                <div class="boost-promo-box">
                    <div class="boost-promo-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4 class="boost-promo-title">Boost your visibility</h4>
                    <p class="boost-promo-stats">
                        Your profile was viewed <strong>{{ profile_views|default:47 }} times</strong> last month
                    </p>
                    <p class="boost-promo-text">
                        Stand out from the crowd! Complete your profile to 100% and activate Boost to appear at the top of search results.
                    </p>
                    <a href="#" class="btn-boost">
                        <i class="fas fa-star"></i>
                        <span>Get Boost</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Account Card -->
        <div class="dashboard-card col-span-8">
            <div class="card-header">
                <h3 class="card-title">Account</h3>
            </div>
            
            <div class="account-form-container">
                <!-- Account Settings Group -->
                <div class="account-settings-group">
                    
                    <!-- Email Section (First) -->
                    <div class="account-section">
                        <div class="email-row-layout">
                            <div class="email-label-group">
                                <h4><i class="fas fa-envelope"></i> Email</h4>
                                <span class="field-value">
                                    {{ user.email }}
                                    {% if user.is_email_verified %}
                                    <span class="email-verified-badge completion-popover-trigger" data-popover="emailVerifiedPopover">
                                        <i class="fas fa-check-circle"></i>
                                    </span>
                                    {% endif %}
                                </span>
                            </div>
                            <!-- Email Verified Popover - positioned relative to badge -->
                            {% if user.is_email_verified %}
                            <div class="completion-popover" id="emailVerifiedPopover">
                                <div class="popover-content">
                                    <p style="margin: 0; color: var(--dash-primary);">✓ Email is verified</p>
                                </div>
                            </div>
                            {% endif %}
                            <button type="button" class="btn-change-email btn-fixed-width-email" onclick="openEmailModal()">Change email</button>
                        </div>
                    </div>

                    <!-- Subscriptions Section -->
                    <div class="account-section">
                        <div class="subscription-row-layout">
                            <div class="subscription-label-group">
                                <h4><i class="fas fa-crown"></i> Subscriptions</h4>
                                <span class="field-value">Free Plan</span>
                            </div>
                            <a href="#" class="btn-view-subscriptions" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span>View all Subscriptions</span>
                                <i class="fas fa-arrow-right" style="font-size: 0.85rem;"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Name and Password Grid (Two Columns) -->
                    <div class="account-section ">
                        <div class="name-password-grid">
                            <!-- Left Column: Name -->
                            <form method="post" class="name-column" id="nameForm">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_name">
                                <div class="column-header">
                                    <h4><i class="fas fa-user"></i> Name</h4>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <label>First Name</label>
                                        <input type="text" name="first_name" value="{{ user.profile.first_name }}" class="form-input" id="firstNameInput">
                                    </div>
                                    <div>
                                        <label>Last Name</label>
                                        <input type="text" name="last_name" value="{{ user.profile.last_name }}" class="form-input" id="lastNameInput">
                                    </div>
                                    <div>
                                        <button type="submit" id="nameSaveBtn" class="btn btn-primary btn-sm btn-fixed-height" disabled>Save</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Right Column: Password -->
                            <form method="post" class="password-column" id="passwordForm">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_password">
                                <div class="column-header">
                                    <h4><i class="fas fa-lock"></i> Password</h4>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <label>New password</label>
                                        <input type="password" name="new_password" id="newPasswordInput" class="form-input password-input" autocomplete="new-password">
                                        <span class="password-error" id="passwordError" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 4px;"></span>
                                    </div>
                                    <div>
                                        <label>New password again</label>
                                        <input type="password" name="new_password_again" id="newPasswordAgainInput" class="form-input password-input" autocomplete="new-password">
                                        <span class="password-error" id="passwordMatchError" style="display: none; color: #dc2626; font-size: 0.85rem; margin-top: 4px;"></span>
                                    </div>
                                    <div>
                                        <button type="submit" id="passwordSaveBtn" class="btn btn-primary btn-sm btn-fixed-height" disabled>Update Password</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Billing Information Section -->
                    <div class="account-section" style="margin-bottom: 24px;">
                        <div class="billing-status-card {% if billing_filled %}billing-filled{% else %}billing-empty{% endif %}">
                            <div class="billing-status-content">
                                <div class="billing-status-icon {% if billing_filled %}billing-icon-filled{% else %}billing-icon-empty{% endif %}">
                                    <i class="fas {% if billing_filled %}fa-check{% else %}fa-exclamation{% endif %}"></i>
                                </div>
                                <div>
                                    <h4 class="billing-status-title">
                                        Billing Information
                                    </h4>
                                    <p class="billing-status-text">
                                        {% if billing_filled %}
                                            Your billing information is complete
                                        {% else %}
                                            Complete your billing information to receive payments
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% if not billing_filled %}
                                <a href="/dashboard/mentor/billing/" class="btn btn-primary btn-sm">
                                    Set Up Billing
                                </a>
                            {% else %}
                                <a href="/dashboard/mentor/billing/" class="btn btn-outline btn-sm">
                                    Update Billing
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Delete Account Group -->
                <div class="account-delete-group">
                    <form method="post" class="account-section account-section-danger">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_account">
                        <div class="account-section-header">
                            <h4 style="color: #dc2626;"><i class="fas fa-trash-alt"></i> Delete Account</h4>
                        </div>
                        <p style="margin: 12px 0 16px; color: var(--dash-text-muted); font-size: 0.9rem;">
                            Once you delete your account, there is no going back. Please be certain.
                        </p>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-fixed-height">
                            Delete Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
      </div>
</div>

<!-- Email Verification Modal -->
<div id="emailModal" class="modal-overlay">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeEmailModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Step 1: New Email Input -->
        <div id="emailStep1">
            <div class="modal-header">
                <h3 class="modal-title">Change Email Address</h3>
                <p class="modal-subtitle">Enter your new email address. We'll send you a verification code.</p>
                <!-- Button to show verification code input if user already has code -->
                <div style="margin-top: 16px; display: flex; justify-content: center; align-items: center;">
                    <button type="button" class="btn btn-outline btn-no-green-hover" id="showCodeInputBtn" onclick="showCodeInput()" style="display: none; width: auto; padding: 8px 16px; font-size: 0.9rem;">
                        I already have the verification code
                    </button>
                </div>
            </div>
            <!-- Error message for Step 1 -->
            <div id="emailStep1Error" class="email-error-message" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <span id="emailStep1ErrorText" style="color: #ef4444; font-size: 0.9rem;"></span>
                </div>
            </div>
            <form id="emailFormStep1" onsubmit="handleEmailStep1(event)">
                <div style="margin-bottom: 24px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">New Email Address</label>
                    <input type="email" id="newEmailInput" class="form-input" placeholder="name@example.com" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" id="sendVerificationCodeBtn" class="btn btn-primary btn-full">
                        <span class="btn-text">Send Verification Code</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Sending...
                        </span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="closeEmailModal()" id="cancelEmailBtn">Cancel</button>
                </div>
            </form>
      </div>

        <!-- Step 2: Verification Code -->
        <div id="emailStep2" style="display: none;">
            <div class="modal-header">
                <h3 class="modal-title">Verify Email</h3>
                <p class="modal-subtitle">Enter the 6-digit code sent to <strong id="confirmEmailDisplay"></strong></p>
      </div>
            <!-- Error message for Step 2 -->
            <div id="emailStep2Error" class="email-error-message" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-circle" style="color: #ef4444;"></i>
                    <span id="emailStep2ErrorText" style="color: #ef4444; font-size: 0.9rem;"></span>
                </div>
            </div>
            <form id="emailFormStep2" method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_email">
                <input type="hidden" name="email" id="finalEmailInput">
                
                <div class="verification-input-group">
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
                    <input type="text" class="verification-digit" maxlength="1" pattern="[0-9]" required>
      </div>

                <div class="modal-actions">
                    <button type="submit" id="verifyEmailBtn" class="btn btn-primary btn-full">
                        <span class="btn-text">Verify & Update Email</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Processing...
                        </span>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="backToStep1()" id="backToStep1Btn">Back</button>
                </div>
    </form>
  </div>
</div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to get color based on percentage
    function getProgressColor(percentage) {
        if (percentage >= 90) {
            return '#059669'; // Dark green - Excellent (90-100%)
        } else if (percentage >= 70) {
            return '#10b981'; // Green - Good (70-89%)
        } else if (percentage >= 40) {
            return '#f59e0b'; // Orange - Needs improvement (40-69%)
        } else {
            return '#ef4444'; // Red - Low (0-39%)
        }
    }

    // Profile completion circle animation
    const progressCircle = document.getElementById('progressCircle');
    const completionText = document.getElementById('completionText');
    
    if (progressCircle && completionText) {
        const percentage = parseInt('{{ profile_completion|default:0 }}', 10) || 0;
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (percentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(percentage);
        progressCircle.style.stroke = color;
        
        // Animate the circle
        setTimeout(() => {
            progressCircle.style.strokeDashoffset = offset;
        }, 100);
    }

    // Profile Content Circle
    const accountContentCircle = document.getElementById('accountContentCircle');
    const accountContentText = document.getElementById('accountContentText');
    
    if (accountContentCircle && accountContentText) {
        // Calculate profile content percentage (same as backend)
        const blogPosts = 2;
        const blogPostsTotal = 5;
        const marketingContent = 2; // quiz + manual checked
        const marketingContentTotal = 7;
        const reviews = 0; // Mockup data
        const reviewsTotal = 3;
        
        const blogPercentage = (blogPosts / blogPostsTotal) * 100;
        const marketingPercentage = (marketingContent / marketingContentTotal) * 100;
        const reviewsPercentage = (reviews / reviewsTotal) * 100;
        const contentPercentage = Math.round((blogPercentage + marketingPercentage + reviewsPercentage) / 3);
        
        const circumference = 326.73; // 2 * PI * radius (52)
        const offset = circumference - (contentPercentage / 100) * circumference;
        
        // Set color based on percentage
        const color = getProgressColor(contentPercentage);
        accountContentCircle.style.stroke = color;
        
        // Update text
        accountContentText.textContent = contentPercentage + '%';
        
        // Animate the circle
        setTimeout(() => {
            accountContentCircle.style.strokeDashoffset = offset;
        }, 200);
    }

    // Popover functionality with smart positioning
    const popoverTriggers = document.querySelectorAll('.completion-popover-trigger');
    popoverTriggers.forEach(trigger => {
        const popoverId = trigger.getAttribute('data-popover');
        const popover = document.getElementById(popoverId);
        
        if (popover) {
            // Ensure popover is positioned relative to trigger's parent (email-label-group)
            // The popover should be a sibling of the email-label-group, not moved around
            const emailLabelGroup = trigger.closest('.email-label-group');
            if (emailLabelGroup && popover.parentElement !== emailLabelGroup.parentElement) {
                // Move popover to be next to email-label-group
                emailLabelGroup.parentElement.insertBefore(popover, emailLabelGroup.nextSibling);
            }
            
            trigger.addEventListener('mouseenter', function() {
                popover.style.display = 'block';
                
                // Calculate position relative to trigger badge using fixed positioning
                const triggerRect = trigger.getBoundingClientRect();
                const popoverRect = popover.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                
                // Check if there's enough space above
                const spaceAbove = triggerRect.top;
                const spaceBelow = viewportHeight - triggerRect.bottom;
                const popoverHeight = popoverRect.height || 200; // Estimate if not yet rendered
                
                // Reset positioning
                popover.style.position = 'fixed';
                popover.style.left = '';
                popover.style.right = '';
                popover.style.top = '';
                popover.style.bottom = '';
                popover.style.transform = '';
                
                // Calculate horizontal position relative to trigger
                const triggerCenterX = triggerRect.left + triggerRect.width / 2;
                const popoverWidth = popoverRect.width || 250;
                
                // Position popover above or below based on available space
                if (spaceAbove >= popoverHeight + 20 || spaceAbove > spaceBelow) {
                    // Position above
                    popover.style.bottom = `${window.innerHeight - triggerRect.top + 12}px`;
                    popover.style.top = 'auto';
                    popover.style.left = `${triggerCenterX}px`;
                    popover.style.transform = 'translateX(-50%)';
                    popover.classList.remove('popover-below');
                    popover.classList.add('popover-above');
                } else {
                    // Position below
                    popover.style.top = `${triggerRect.bottom + 12}px`;
                    popover.style.bottom = 'auto';
                    popover.style.left = `${triggerCenterX}px`;
                    popover.style.transform = 'translateX(-50%)';
                    popover.classList.remove('popover-above');
                    popover.classList.add('popover-below');
                }

                // Ensure popover stays within viewport horizontally
                setTimeout(() => {
                    const finalPopoverRect = popover.getBoundingClientRect();
                    if (finalPopoverRect.left < 10) {
                        popover.style.left = '10px';
                        popover.style.transform = 'translateX(0)';
                    } else if (finalPopoverRect.right > viewportWidth - 10) {
                        popover.style.left = 'auto';
                        popover.style.right = '10px';
                        popover.style.transform = 'translateX(0)';
                    }
                    
                    popover.classList.add('active');
                }, 10);
            });
            
            trigger.addEventListener('mouseleave', function() {
                popover.classList.remove('active');
                setTimeout(() => {
                    popover.style.display = 'none';
                }, 200);
            });
        }
    });

    // Name Section Dirty Checking
    const nameForm = document.getElementById('nameForm');
    const firstNameInput = document.getElementById('firstNameInput');
    const lastNameInput = document.getElementById('lastNameInput');
    const nameSaveBtn = document.getElementById('nameSaveBtn');
    
    if (nameForm && firstNameInput && lastNameInput && nameSaveBtn) {
        const originalFirstName = firstNameInput.value.trim();
        const originalLastName = lastNameInput.value.trim();
        
        // Ensure button starts as disabled
        nameSaveBtn.disabled = true;
        nameSaveBtn.classList.add('btn-disabled');
        
        function checkNameChanges() {
            const currentFirstName = firstNameInput.value.trim();
            const currentLastName = lastNameInput.value.trim();
            const isChanged = currentFirstName !== originalFirstName || currentLastName !== originalLastName;
            
            nameSaveBtn.disabled = !isChanged;
            if (isChanged) {
                nameSaveBtn.classList.remove('btn-disabled');
            } else {
                nameSaveBtn.classList.add('btn-disabled');
            }
        }
        
        firstNameInput.addEventListener('input', checkNameChanges);
        lastNameInput.addEventListener('input', checkNameChanges);
        
        // Initial check
        checkNameChanges();
    }

    // Password Validation with meaningful feedback
    const passwordForm = document.getElementById('passwordForm');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const newPasswordAgainInput = document.getElementById('newPasswordAgainInput');
    const passwordSaveBtn = document.getElementById('passwordSaveBtn');
    const passwordError = document.getElementById('passwordError');
    const passwordMatchError = document.getElementById('passwordMatchError');

    if (passwordForm && newPasswordInput && newPasswordAgainInput && passwordSaveBtn) {
        function validatePassword() {
            const p1 = newPasswordInput.value.trim();
            const p2 = newPasswordAgainInput.value.trim();
            
            // Reset errors
            passwordError.style.display = 'none';
            passwordMatchError.style.display = 'none';
            newPasswordInput.style.borderColor = '';
            newPasswordAgainInput.style.borderColor = '';
            
            let isValid = false;
            
            // Check if both fields have values
            if (p1.length === 0 && p2.length === 0) {
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // Validate first password
            if (p1.length < 8) {
                passwordError.textContent = 'Password must be at least 8 characters';
                passwordError.style.display = 'block';
                newPasswordInput.style.borderColor = '#dc2626';
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // Check if passwords match
            if (p1 !== p2) {
                passwordMatchError.textContent = 'Passwords do not match';
                passwordMatchError.style.display = 'block';
                newPasswordAgainInput.style.borderColor = '#dc2626';
                passwordSaveBtn.disabled = true;
                passwordSaveBtn.classList.add('btn-disabled');
                return;
            }
            
            // All validations passed
            isValid = true;
            passwordSaveBtn.disabled = false;
            passwordSaveBtn.classList.remove('btn-disabled');
        }

        newPasswordInput.addEventListener('input', validatePassword);
        newPasswordAgainInput.addEventListener('input', validatePassword);
        
        // Initial validation
        validatePassword();
    }

    // Modal Logic
    const modal = document.getElementById('emailModal');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Close on outside click
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeEmailModal();
            }
        });
    }

    // Verification code input handling - Enhanced with copy-paste, arrow keys, and number-only
    const digits = document.querySelectorAll('.verification-digit');
    
    // Function to handle paste event
    function handlePaste(e) {
        e.preventDefault();
        const pastedData = (e.clipboardData || window.clipboardData).getData('text');
        // Extract only digits from pasted content
        const digitsOnly = pastedData.replace(/\D/g, '').slice(0, 6);
        
        if (digitsOnly.length > 0) {
            // First, clear all inputs
            digits.forEach(input => {
                input.value = '';
            });
            
            // Focus on the first input
            if (digits.length > 0) {
                digits[0].focus();
            }
            
            // Then fill inputs with pasted digits
            digits.forEach((input, idx) => {
                if (idx < digitsOnly.length) {
                    input.value = digitsOnly[idx];
                }
            });
            
            // Focus the next empty input or the last one
            const nextEmptyIdx = Math.min(digitsOnly.length, digits.length - 1);
            digits[nextEmptyIdx].focus();
        }
    }
    
    digits.forEach((digit, idx) => {
        // Handle paste on each input
        digit.addEventListener('paste', handlePaste);
        
        // Only allow numbers
        digit.addEventListener('input', function(e) {
            // Remove any non-digit characters
            this.value = this.value.replace(/\D/g, '');
            
            // Limit to single digit
            if (this.value.length > 1) {
                this.value = this.value.slice(0, 1);
            }
            
            // If we have a digit, move to next
            if (this.value.length === 1) {
                if (idx < digits.length - 1) {
                    digits[idx + 1].focus();
                }
            }
        });
        
        // Handle keydown for navigation
        digit.addEventListener('keydown', function(e) {
            // Arrow Right or Tab: move to next input
            if (e.key === 'ArrowRight' || (e.key === 'Tab' && !e.shiftKey)) {
                e.preventDefault();
                if (idx < digits.length - 1) {
                    digits[idx + 1].focus();
                }
            }
            // Arrow Left or Shift+Tab: move to previous input
            else if (e.key === 'ArrowLeft' || (e.key === 'Tab' && e.shiftKey)) {
                e.preventDefault();
                if (idx > 0) {
                    digits[idx - 1].focus();
                }
            }
            // Backspace: clear current and move to previous
            else if (e.key === 'Backspace') {
                if (this.value.length === 0 && idx > 0) {
                    e.preventDefault();
                    digits[idx - 1].focus();
                    digits[idx - 1].value = '';
                }
            }
            // Prevent non-numeric characters (except navigation keys)
            else if (!['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(e.key)) {
                // Allow Ctrl/Cmd combinations (for copy/paste/select all)
                if (!(e.ctrlKey || e.metaKey)) {
                    // Check if it's a number
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                }
            }
        });
    });
    
    // Step 2 Form Submission (Verify OTP)
    const emailFormStep2 = document.getElementById('emailFormStep2');
    const verifyEmailBtn = document.getElementById('verifyEmailBtn');
    const backToStep1Btn = document.getElementById('backToStep1Btn');
    
    function enableEmailButtons() {
        if (verifyEmailBtn) {
            verifyEmailBtn.disabled = false;
            verifyEmailBtn.style.opacity = '1';
            verifyEmailBtn.style.cursor = 'pointer';
            verifyEmailBtn.querySelector('.btn-text').style.display = 'inline';
            verifyEmailBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (backToStep1Btn) {
            backToStep1Btn.disabled = false;
        }
    }
    
    function disableEmailButtons() {
        if (verifyEmailBtn) {
            verifyEmailBtn.disabled = true;
            verifyEmailBtn.style.opacity = '0.6';
            verifyEmailBtn.style.cursor = 'not-allowed';
            verifyEmailBtn.querySelector('.btn-text').style.display = 'none';
            verifyEmailBtn.querySelector('.btn-loading').style.display = 'inline';
        }
        if (backToStep1Btn) {
            backToStep1Btn.disabled = true;
        }
    }
    
    if (emailFormStep2) {
        emailFormStep2.addEventListener('submit', function(e) {
            e.preventDefault();
            hideEmailErrors();
            
            // Disable button and show loading
            disableEmailButtons();
            
            // Collect OTP
            let otp = '';
            document.querySelectorAll('.verification-digit').forEach(input => {
                otp += input.value;
            });
            
            if (otp.length !== 6) {
                showEmailError(2, 'Please enter the full 6-digit code');
                enableEmailButtons();
                return;
            }
            
            // Send request
            fetch('{% url "accounts:verify_email_change" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ otp: otp })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Email updated successfully!', 'success');
                    } else {
                        alert('Email updated successfully!');
                    }
                    closeEmailModal();
                    setTimeout(() => location.reload(), 500);
                } else {
                    showEmailError(2, data.error || 'Verification failed. Please check your code and try again.');
                    // Clear verification inputs on error
                    document.querySelectorAll('.verification-digit').forEach(input => input.value = '');
                    setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
                    enableEmailButtons();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showEmailError(2, 'An error occurred. Please try again.');
                enableEmailButtons();
            });
        });
    }
});

function openEmailModal() {
    document.getElementById('emailModal').classList.add('active');
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    document.getElementById('newEmailInput').value = '';
    // Hide errors
    hideEmailErrors();
    // Hide/show code input button based on session
    checkPendingEmailChange();
}

function closeEmailModal() {
    document.getElementById('emailModal').classList.remove('active');
    hideEmailErrors();
}

function hideEmailErrors() {
    const step1Error = document.getElementById('emailStep1Error');
    const step2Error = document.getElementById('emailStep2Error');
    if (step1Error) step1Error.style.display = 'none';
    if (step2Error) step2Error.style.display = 'none';
}

function showEmailError(step, message) {
    hideEmailErrors();
    if (step === 1) {
        const errorDiv = document.getElementById('emailStep1Error');
        const errorText = document.getElementById('emailStep1ErrorText');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    } else if (step === 2) {
        const errorDiv = document.getElementById('emailStep2Error');
        const errorText = document.getElementById('emailStep2ErrorText');
        if (errorDiv && errorText) {
            errorText.textContent = message;
            errorDiv.style.display = 'block';
        }
    }
}

function showCodeInput() {
    // Check if there's a pending email change in session
    fetch('{% url "accounts:check_pending_email_change" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.has_pending && data.email) {
            document.getElementById('emailStep1').style.display = 'none';
            document.getElementById('emailStep2').style.display = 'block';
            document.getElementById('confirmEmailDisplay').textContent = data.email;
            document.getElementById('finalEmailInput').value = data.email;
            hideEmailErrors();
            setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
        } else {
            showEmailError(1, 'No pending email change found. Please enter your email and request a new code.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showEmailError(1, 'Unable to check for pending email change. Please request a new code.');
    });
}

function checkPendingEmailChange() {
    // Check if there's a pending email change to show the "I already have code" button
    fetch('{% url "accounts:check_pending_email_change" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        const showCodeBtn = document.getElementById('showCodeInputBtn');
        if (showCodeBtn) {
            if (data.has_pending) {
                showCodeBtn.style.display = 'block';
            } else {
                showCodeBtn.style.display = 'none';
            }
        }
    })
    .catch(error => {
        console.error('Error checking pending email change:', error);
    });
}

function handleEmailStep1(e) {
    e.preventDefault();
    hideEmailErrors();
    const email = document.getElementById('newEmailInput').value.trim();
    if (!email) {
        showEmailError(1, 'Please enter an email address');
        return;
    }
    
    // Disable button and show loading
    const sendBtn = document.getElementById('sendVerificationCodeBtn');
    const cancelBtn = document.getElementById('cancelEmailBtn');
    if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.6';
        sendBtn.style.cursor = 'not-allowed';
        sendBtn.querySelector('.btn-text').style.display = 'none';
        sendBtn.querySelector('.btn-loading').style.display = 'inline';
    }
    if (cancelBtn) {
        cancelBtn.disabled = true;
    }
    
    // Send request to initiate email change
    fetch('{% url "accounts:initiate_email_change" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ new_email: email })
    })
    .then(response => response.json())
    .then(data => {
        // Re-enable button
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            sendBtn.style.cursor = 'pointer';
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (cancelBtn) {
            cancelBtn.disabled = false;
        }
        
        if (data.success) {
            document.getElementById('emailStep1').style.display = 'none';
            document.getElementById('emailStep2').style.display = 'block';
            document.getElementById('confirmEmailDisplay').textContent = email;
            document.getElementById('finalEmailInput').value = email;
            hideEmailErrors();
            // Clear verification inputs
            document.querySelectorAll('.verification-digit').forEach(input => input.value = '');
            // Focus first digit
            setTimeout(() => document.querySelector('.verification-digit').focus(), 100);
        } else {
            showEmailError(1, data.error || 'Failed to send verification code');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showEmailError(1, 'An error occurred. Please try again.');
        // Re-enable button on error
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            sendBtn.style.cursor = 'pointer';
            sendBtn.querySelector('.btn-text').style.display = 'inline';
            sendBtn.querySelector('.btn-loading').style.display = 'none';
        }
        if (cancelBtn) {
            cancelBtn.disabled = false;
        }
    });
}

function backToStep1() {
    document.getElementById('emailStep1').style.display = 'block';
    document.getElementById('emailStep2').style.display = 'none';
    hideEmailErrors();
}
</script>
{% endblock %}
