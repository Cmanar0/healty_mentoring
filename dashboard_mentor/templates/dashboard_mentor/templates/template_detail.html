{% extends "dashboard_mentor/base.html" %}
{% load static %}

{% block page_title %}Template: {{ template.name }}{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.css">
<style>
    .template-detail-container {
        max-width: 1000px;
        margin: 0 auto;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #64748b;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 24px;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: #111827;
    }

    /* Template Profile Header */
    .template-profile-card {
        background: white;
        border-radius: 24px;
        padding: 40px;
        border: 1px solid #e5e7eb;
        display: flex;
        gap: 32px;
        margin-bottom: 40px;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    .template-profile-icon {
        width: 100px;
        height: 100px;
        border-radius: 20px;
        background: #111827;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        flex-shrink: 0;
    }

    .template-profile-info {
        flex: 1;
    }

    .template-profile-name {
        font-size: 2rem;
        font-weight: 800;
        color: #111827;
        margin-bottom: 8px;
        letter-spacing: -0.03em;
    }

    .template-profile-desc {
        color: #64748b;
        font-size: 1.1rem;
        line-height: 1.6;
    }

    /* Questions Section */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }

    .section-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-add-question {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.875rem;
        height: 40px;
        white-space: nowrap;
        transition: background 0.2s;
    }

    .btn-add-question:hover {
        background: #2563eb;
    }

    .btn-ai-generate {
        background: linear-gradient(135deg, #2563eb 0%, #7c3aed 50%, #ec4899 100%) !important;
        color: white !important;
        border: none !important;
        padding: 10px 18px !important;
        border-radius: 8px !important;
        font-weight: 600 !important;
        cursor: pointer;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 8px !important;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4) !important;
        font-size: 0.875rem !important;
        height: 40px !important;
        white-space: nowrap !important;
    }

    .btn-ai-generate::before {
        content: '';
        position: absolute;
        top: 0; left: -100%;
        width: 100%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: 0.5s;
    }

    .btn-ai-generate:hover:not(:disabled) {
        background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 50%, #db2777 100%) !important;
        box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6) !important;
        transform: none !important;
    }

    .btn-ai-generate:hover::before {
        left: 100%;
    }

    .btn-ai-generate:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-ai-generate i {
        font-size: 0.9em !important;
        display: inline-block !important;
    }

    .questions-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .question-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        border: 1px solid #e5e7eb;
        display: flex;
        gap: 20px;
        transition: all 0.2s;
        cursor: move;
        position: relative;
    }

    .question-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .question-card.sortable-ghost {
        opacity: 0.4;
    }

    .question-card.sortable-drag {
        opacity: 0.8;
    }

    .question-drag-handle {
        position: absolute;
        left: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: #cbd5e1;
        cursor: grab;
        font-size: 1.2rem;
        padding: 8px;
    }

    .question-drag-handle:active {
        cursor: grabbing;
    }

    .question-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f1f5f9;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
        margin-left: 24px;
    }

    .question-content {
        flex: 1;
    }

    .question-text {
        font-weight: 600;
        color: #111827;
        font-size: 1.1rem;
        margin-bottom: 8px;
    }

    .question-meta {
        display: flex;
        gap: 16px;
        align-items: center;
        font-size: 0.85rem;
        color: #94a3b8;
        flex-wrap: wrap;
    }

    .question-badge {
        background: #f8fafc;
        color: #64748b;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .target-date-badge-card {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
        border: 1px solid #fbbf24;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .target-date-badge-card i {
        font-size: 0.7rem;
        color: #f59e0b;
    }

    .question-actions {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-question-action {
        background: none;
        border: none;
        color: #64748b;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .btn-question-action:hover {
        background: #f1f5f9;
        color: #111827;
    }

    .btn-question-action.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* AI Generation Empty State */
    .empty-state-ai {
        background: white;
        border: 2px dashed #e2e8f0;
        border-radius: 24px;
        padding: 64px 32px;
        text-align: center;
    }

    .ai-icon-large {
        font-size: 3rem;
        color: #6366f1;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 12px;
    }

    .empty-state-text {
        color: #64748b;
        max-width: 500px;
        margin: 0 auto 32px;
        line-height: 1.6;
    }

    .loading-pulse {
        display: inline-block;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-container {
        background: white;
        border-radius: 16px 16px 16px 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 900px;
        width: 90%;
        max-height: 90vh;
        overflow: visible;
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        position: relative;
        z-index: 10000;
    }

    .modal-overlay.active .modal-container {
        transform: scale(1);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 0;
        position: relative;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }

    .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(15, 23, 42, 0.1);
        border: 1px solid rgba(15, 23, 42, 0.1);
        color: #64748b;
        font-size: 1rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-close:hover {
        background: #ef4444;
        border-color: #ef4444;
        color: white;
        transform: rotate(90deg) scale(1.1);
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        overflow-x: visible;
        flex: 1;
        min-height: 0;
        position: relative;
    }

    .modal-body-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .modal-body-left,
    .modal-body-right {
        display: flex;
        flex-direction: column;
    }

    @media (max-width: 768px) {
        .modal-body-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        margin-bottom: 20px;
        overflow: visible;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #475569;
        margin-bottom: 8px;
        font-size: 0.875rem;
    }

    .form-input,
    .form-select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.95rem;
        color: #1e293b;
        transition: all 0.2s;
        box-sizing: border-box;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 80px;
    }

    .form-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-checkbox input {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 20px 24px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        position: relative;
        z-index: 1;
        border-radius: 0 0 16px 16px;
    }

    /* Ensure dropdown appears above footer */
    .modal-body-right {
        position: relative;
        z-index: 2;
    }

    .btn-cancel,
    .btn-confirm {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
        border: none;
    }

    .btn-cancel {
        background: white;
        color: #64748b;
        border: 1px solid #e2e8f0;
        min-width: 100px;
    }

    .btn-cancel:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .btn-confirm {
        background: #111827;
        color: white;
        width: auto;
    }

    .btn-confirm:hover {
        background: #000;
    }

    /* Custom Dropdown Styles */
    .custom-dropdown-container {
        position: relative;
        width: 100%;
    }

    .custom-dropdown-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 10px 16px;
        background: white;
        border: 1px solid var(--dash-border, #e2e8f0);
        border-radius: 8px;
        color: var(--dash-text-main, #1e293b);
        font-size: 0.95rem;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .custom-dropdown-trigger:hover {
        border-color: var(--dash-primary, #10b981);
    }

    .custom-dropdown-trigger i {
        color: var(--dash-text-light, #94a3b8);
        font-size: 0.85rem;
        transition: transform 0.2s ease;
    }

    .custom-dropdown-container.active .custom-dropdown-trigger i {
        transform: rotate(180deg);
    }

    .custom-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 0;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 10005;
        min-width: 100%;
    }

    .custom-dropdown-container.active .custom-dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: var(--dash-text-main, #1e293b);
        text-decoration: none;
        transition: background 0.2s ease;
        border: none;
        background: transparent;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 400;
        text-align: left;
    }

    .dropdown-item.first-item {
        border-radius: 12px 12px 0 0;
    }

    .dropdown-item.last-item {
        border-radius: 0 0 12px 12px;
    }

    .dropdown-item:hover:not(:disabled) {
        background: #f1f5f9;
        color: #1e293b;
    }

    .dropdown-item:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .dropdown-item.first-item:hover:not(:disabled) {
        border-radius: 12px 12px 0 0;
    }

    .dropdown-item.last-item:hover:not(:disabled) {
        border-radius: 0 0 12px 12px;
    }

    /* Special styling for Date option */
    .dropdown-item-date {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 3px solid #f59e0b;
        font-weight: 600;
    }

    .dropdown-item-date:not(:disabled):hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
    }

    .dropdown-item-date i {
        color: #f59e0b;
        width: 20px;
        text-align: center;
        font-size: 1.1rem;
    }

    .target-date-exists {
        font-size: 0.85rem;
        color: #dc2626;
        font-weight: 400;
        font-style: italic;
    }

    /* Target Date Badge */
    .target-date-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #fbbf24;
        border-radius: 8px;
        color: #92400e;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .target-date-badge i {
        color: #f59e0b;
        font-size: 1rem;
    }

    /* Target Date Checkbox */
    .target-date-checkbox {
        padding: 16px;
        background: #fef3c7;
        border: 1px solid #fbbf24;
        border-radius: 8px;
        margin-top: 8px;
    }

    .target-date-checkbox input[type="checkbox"] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
        accent-color: #f59e0b;
    }

    .target-date-checkbox label {
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer;
    }

    .target-date-checkbox label strong {
        color: #92400e;
        font-size: 0.95rem;
    }

    .checkbox-help {
        font-size: 0.85rem;
        color: #b45309;
        font-weight: 400;
    }

    .options-input-group {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .options-input-group input {
        flex: 1;
    }

    .options-list {
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #f8fafc;
        border-radius: 6px;
    }

    .option-item span {
        flex: 1;
    }

    .btn-remove-option {
        background: #fee2e2;
        color: #dc2626;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container template-detail-container">
    <a href="{% url 'general:dashboard_mentor:templates_list' %}" class="back-link">
        <i class="fas fa-arrow-left"></i> Back to Templates
    </a>

    <div class="template-profile-card">
        <div class="template-profile-icon">
            <i class="{{ template.icon|default:'fas fa-layer-group' }}"></i>
        </div>
        <div class="template-profile-info">
            <div class="template-profile-name">{{ template.name }}</div>
            <p class="template-profile-desc">{{ template.description|default:"No description provided." }}</p>
        </div>
    </div>

    <div id="questionsSection">
        <div id="targetDateWarning" class="target-date-warning" style="display: none; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 16px; margin-bottom: 24px; align-items: center; gap: 12px;">
            <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 1.25rem;"></i>
            <div style="flex: 1;">
                <strong style="color: #92400e; display: block; margin-bottom: 4px;">No target date question set</strong>
                <span style="color: #b45309; font-size: 0.9rem;">This template doesn't have a date question marked as the project target completion date. Consider adding one to help track project timelines.</span>
            </div>
        </div>
        <div class="section-header">
            <h2 class="section-title">Onboarding Questionnaire</h2>
            <div class="section-actions">
                <button id="generateAiBtn" class="btn-ai-generate" onclick="generateAiQuestions()">
                    <i class="fas fa-wand-magic-sparkles"></i> Generate with AI
                </button>
                <button class="btn-add-question" onclick="openQuestionModal()">
                    <i class="fas fa-plus"></i> Add Question
                </button>
            </div>
        </div>

        <div id="questionsContainer" class="questions-list">
            <div style="padding: 48px; text-align: center; color: #9ca3af;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                <p>Loading questions...</p>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal-overlay" style="display: none; z-index: 10001;" onclick="if(event.target === this) closeDeleteConfirmModal()">
    <div class="modal-container" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Delete Question</h3>
        </div>
        <button class="modal-close" onclick="closeDeleteConfirmModal()">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-body">
            <p>Are you sure you want to delete this question? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeDeleteConfirmModal()">Cancel</button>
            <button type="button" class="btn-confirm" id="confirmDeleteBtn" style="background: #ef4444;">Delete</button>
        </div>
    </div>
</div>

<!-- Question Modal -->
<div id="questionModal" class="modal-overlay" onclick="if(event.target === this) closeQuestionModal()">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="questionModalTitle">Add Question</h3>
        </div>
        <button class="modal-close" onclick="closeQuestionModal()">
            <i class="fas fa-times"></i>
        </button>
        <form id="questionForm" onsubmit="saveQuestion(event)">
            <div class="modal-body">
                <div class="modal-body-grid">
                    <div class="modal-body-left">
                        <div class="form-group">
                            <label class="form-label">Question Text *</label>
                            <textarea name="question_text" id="questionTextInput" class="form-input" rows="3" required placeholder="Enter your question..."></textarea>
                        </div>

                        <div class="form-group" id="optionsGroup" style="display: none;">
                            <label class="form-label">Options</label>
                            <div class="options-input-group">
                                <input type="text" id="newOptionInput" class="form-input" placeholder="Enter option...">
                                <button type="button" class="btn-confirm" onclick="addOption()" style="padding: 10px 16px;">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="optionsList" class="options-list"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Help Text</label>
                            <input type="text" name="help_text" id="helpTextInput" class="form-input" placeholder="Optional help text for users...">
                        </div>

                        <div class="form-group">
                            <div class="form-checkbox">
                                <input type="checkbox" name="is_required" id="isRequiredInput" checked>
                                <label for="isRequiredInput">Required field</label>
                            </div>
                        </div>
                    </div>

                    <div class="modal-body-right">
                        <div class="form-group">
                            <label class="form-label">Question Type *</label>
                            <div class="custom-dropdown-container" id="questionTypeDropdownContainer">
                                <button type="button" class="custom-dropdown-trigger" id="questionTypeTrigger">
                                    <span class="dropdown-selected-text" id="questionTypeSelected">Select question type</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <input type="hidden" name="question_type" id="questionTypeInput" value="" required>
                                <div class="custom-dropdown-menu" id="questionTypeMenu">
                                    <button type="button" class="dropdown-item first-item" data-value="text">
                                        <span>Text</span>
                                    </button>
                                    <button type="button" class="dropdown-item" data-value="textarea">
                                        <span>Long Text</span>
                                    </button>
                                    <button type="button" class="dropdown-item" data-value="number">
                                        <span>Number</span>
                                    </button>
                                    <button type="button" class="dropdown-item dropdown-item-date" data-value="date" id="dateOptionBtn" {% if has_target_date_question %}disabled{% endif %}>
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Date{% if has_target_date_question %} <span class="target-date-exists">(Target date already exists)</span>{% endif %}</span>
                                    </button>
                                    <button type="button" class="dropdown-item" data-value="select">
                                        <span>Select</span>
                                    </button>
                                    <button type="button" class="dropdown-item last-item" data-value="multiselect">
                                        <span>Multiple Select</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" id="targetDateCheckboxGroup" style="display: none;">
                            <div class="form-checkbox target-date-checkbox">
                                <input type="checkbox" name="is_target_date" id="isTargetDateInput">
                                <label for="isTargetDateInput">
                                    <strong>Use as project target completion date</strong>
                                    <span class="checkbox-help">This date will automatically set the project's target completion date when answered</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeQuestionModal()">Cancel</button>
                <button type="submit" class="btn-confirm" id="questionSubmitBtn">Add Question</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    const templateId = {{ template.id }};
    let editingQuestionId = null;
    let questionOptions = [];
    let hasTargetDateQuestion = false;
    let sortableInstance = null;
    let deleteQuestionId = null;

    // Initialize custom dropdown for question type
    document.addEventListener('DOMContentLoaded', function() {
        const trigger = document.getElementById('questionTypeTrigger');
        const menu = document.getElementById('questionTypeMenu');
        const hiddenInput = document.getElementById('questionTypeInput');
        const selectedText = document.getElementById('questionTypeSelected');
        const container = document.getElementById('questionTypeDropdownContainer');

        if (trigger && menu) {
            // Toggle dropdown
            trigger.addEventListener('click', function(e) {
                e.stopPropagation();
                container.classList.toggle('active');
            });

            // Handle item selection
            const dropdownItems = menu.querySelectorAll('.dropdown-item');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    const value = this.getAttribute('data-value');
                    const text = this.querySelector('span').textContent.replace(/\s*\(.*?\)\s*/g, '').trim();
                    
                    hiddenInput.value = value;
                    selectedText.textContent = text;
                    
                    // Update active state
                    dropdownItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close dropdown
                    container.classList.remove('active');
                    
                    // Handle type-specific UI updates
                    toggleOptionsInput();
                    toggleTargetDateUI();
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (container && !container.contains(event.target)) {
                    container.classList.remove('active');
                }
            });
        }
    });

    function toggleTargetDateUI() {
        const questionType = document.getElementById('questionTypeInput').value;
        const targetDateCheckboxGroup = document.getElementById('targetDateCheckboxGroup');
        const isTargetDateInput = document.getElementById('isTargetDateInput');
        
        if (questionType === 'date') {
            if (!hasTargetDateQuestion || editingQuestionId) {
                // Show checkbox if no target date exists, or if editing (might be the existing one)
                targetDateCheckboxGroup.style.display = 'block';
            } else {
                // Hide checkbox if target date already exists and we're creating new
                targetDateCheckboxGroup.style.display = 'none';
                isTargetDateInput.checked = false;
            }
        } else {
            targetDateCheckboxGroup.style.display = 'none';
            isTargetDateInput.checked = false;
        }
    }

    // Load questions on page load
    function loadQuestions() {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = `
            <div style="padding: 48px; text-align: center; color: #9ca3af;">
                <i class="fas fa-circle-notch fa-spin" style="font-size: 24px; margin-bottom: 12px; opacity: 0.5;"></i>
                <p>Loading questions...</p>
            </div>
        `;

        fetch(`/dashboard/mentor/templates/${templateId}/questions/api/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                hasTargetDateQuestion = data.has_target_date_question;
                renderQuestions(data.questions);
                updateTargetDateWarning();
            } else {
                container.innerHTML = `
                    <div style="padding: 48px; text-align: center; color: #ef4444;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 12px;"></i>
                        <p>Error loading questions: ${data.error || 'Unknown error'}</p>
                        <button onclick="loadQuestions()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading questions:', error);
            container.innerHTML = `
                <div style="padding: 48px; text-align: center; color: #ef4444;">
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 12px;"></i>
                    <p>Error loading questions. ${error.message || 'Please refresh the page.'}</p>
                    <button onclick="loadQuestions()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                </div>
            `;
        });
    }

    function renderQuestions(questions) {
        const container = document.getElementById('questionsContainer');
        
        if (!questions || questions.length === 0) {
            container.innerHTML = `
                <div class="empty-state-ai">
                    <div class="ai-icon-large">
                        <i class="fas fa-wand-sparkles"></i>
                    </div>
                    <h3 class="empty-state-title">No questions yet</h3>
                    <p class="empty-state-text">
                        Every great project starts with the right questions. Create questions manually or let our AI help you craft a 
                        powerful onboarding experience for your clients tailored to this specific template.
                    </p>
                </div>
            `;
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            return;
        }

        container.innerHTML = questions.map((question, index) => `
            <div class="question-card" data-question-id="${question.id}" data-order="${question.order}">
                <div class="question-drag-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="question-number">${index + 1}</div>
                <div class="question-content">
                    <div class="question-text">${escapeHtml(question.question_text)}</div>
                    <div class="question-meta">
                        <span class="question-badge">${escapeHtml(question.question_type_display)}</span>
                        ${question.is_target_date ? `
                        <span class="question-badge target-date-badge-card">
                            <i class="fas fa-calendar-check"></i> Target Date
                        </span>
                        ` : ''}
                        ${question.is_required ? '<span>Required</span>' : ''}
                        ${question.help_text ? `<span><i class="fas fa-info-circle"></i> ${escapeHtml(question.help_text.substring(0, 50))}${question.help_text.length > 50 ? '...' : ''}</span>` : ''}
                        ${question.options && question.options.length > 0 ? `<span><i class="fas fa-list"></i> ${question.options.length} options</span>` : ''}
                    </div>
                </div>
                <div class="question-actions">
                    <button class="btn-question-action" onclick="editQuestion(${question.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-question-action delete" onclick="openDeleteConfirmModal(${question.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Initialize Sortable
        if (sortableInstance) {
            sortableInstance.destroy();
        }
        sortableInstance = Sortable.create(container, {
            handle: '.question-drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            onEnd: function(evt) {
                reorderQuestions();
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateTargetDateWarning() {
        const warning = document.getElementById('targetDateWarning');
        const container = document.getElementById('questionsContainer');
        const hasQuestions = container.querySelectorAll('.question-card').length > 0;
        
        if (!hasTargetDateQuestion && hasQuestions) {
            warning.style.display = 'flex';
        } else {
            warning.style.display = 'none';
        }
    }

    // Load questions on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadQuestions();
    });

    function reorderQuestions() {
        const questions = Array.from(document.querySelectorAll('.question-card'));
        const orders = questions.map((card, index) => ({
            id: parseInt(card.dataset.questionId),
            order: index + 1
        }));

        console.log('Reordering questions:', orders);

        fetch(`/dashboard/mentor/templates/${templateId}/questions/reorder/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orders: orders })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Reorder response:', data);
            if (data.success) {
                // Reload questions to get updated order from server
                loadQuestions();
                if (typeof showNotification !== 'undefined') {
                    showNotification('Questions reordered successfully', 'success');
                }
            } else {
                console.error('Failed to reorder questions:', data.error);
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to save question order. Please try again.', 'error');
                } else {
                    alert(data.error || 'Failed to save question order. Please try again.');
                }
                // Reload to restore original order
                loadQuestions();
            }
        })
        .catch(error => {
            console.error('Error reordering questions:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while saving the order. Please try again.', 'error');
            } else {
                alert('An error occurred while saving the order. Please try again.');
            }
            // Reload questions to restore original order
            loadQuestions();
        });
    }

    function openQuestionModal(questionId = null) {
        editingQuestionId = questionId;
        const modal = document.getElementById('questionModal');
        const form = document.getElementById('questionForm');
        
        // Reset form
        form.reset();
        questionOptions = [];
        document.getElementById('optionsList').innerHTML = '';
        document.getElementById('optionsGroup').style.display = 'none';
        document.getElementById('targetDateCheckboxGroup').style.display = 'none';
        document.getElementById('isTargetDateInput').checked = false;
        
        // Reset dropdown
        document.getElementById('questionTypeSelected').textContent = 'Select question type';
        document.getElementById('questionTypeInput').value = '';
        document.querySelectorAll('#questionTypeMenu .dropdown-item').forEach(item => {
            item.classList.remove('active');
        });
        
        if (questionId) {
            // Load question data for editing
            document.getElementById('questionModalTitle').textContent = 'Edit Question';
            document.getElementById('questionSubmitBtn').textContent = 'Update Question';
            
            // Fetch question data (we'll need to get it from the DOM or make an API call)
            const questionCard = document.querySelector(`[data-question-id="${questionId}"]`);
            if (questionCard) {
                // For now, we'll need to make an API call to get full question data
                // This is a simplified version - you might want to add an API endpoint
                fetch(`/dashboard/mentor/questions/${questionId}/update/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.question) {
                        populateQuestionForm(data.question);
                    }
                })
                .catch(error => {
                    console.error('Error loading question:', error);
                });
            }
        } else {
            document.getElementById('questionModalTitle').textContent = 'Add Question';
            document.getElementById('questionSubmitBtn').textContent = 'Add Question';
        }
        
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function populateQuestionForm(question) {
        document.getElementById('questionTextInput').value = question.question_text || '';
        
        // Set question type in dropdown
        const questionType = question.question_type || 'text';
        document.getElementById('questionTypeInput').value = questionType;
        
        // Update dropdown display
        const dropdownItems = document.querySelectorAll('#questionTypeMenu .dropdown-item');
        const selectedText = document.getElementById('questionTypeSelected');
        dropdownItems.forEach(item => {
            if (item.getAttribute('data-value') === questionType) {
                const text = item.querySelector('span').textContent.replace(/\s*\(.*?\)\s*/g, '').trim();
                selectedText.textContent = text;
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        document.getElementById('helpTextInput').value = question.help_text || '';
        document.getElementById('isRequiredInput').checked = question.is_required !== false;
        document.getElementById('isTargetDateInput').checked = question.is_target_date === true;
        
        if (question.options && question.options.length > 0) {
            questionOptions = question.options;
            renderOptions();
            document.getElementById('optionsGroup').style.display = 'block';
        }
        
        toggleOptionsInput();
    }

    function closeQuestionModal() {
        const modal = document.getElementById('questionModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            editingQuestionId = null;
        }, 300);
    }

    function toggleOptionsInput() {
        const questionType = document.getElementById('questionTypeInput').value;
        const optionsGroup = document.getElementById('optionsGroup');
        
        if (questionType === 'select' || questionType === 'multiselect') {
            optionsGroup.style.display = 'block';
        } else {
            optionsGroup.style.display = 'none';
            questionOptions = [];
            document.getElementById('optionsList').innerHTML = '';
        }
        
        // Also toggle target date UI
        toggleTargetDateUI();
    }

    function addOption() {
        const input = document.getElementById('newOptionInput');
        const value = input.value.trim();
        
        if (value && !questionOptions.includes(value)) {
            questionOptions.push(value);
            renderOptions();
            input.value = '';
        }
    }

    function removeOption(index) {
        questionOptions.splice(index, 1);
        renderOptions();
    }

    function renderOptions() {
        const container = document.getElementById('optionsList');
        container.innerHTML = questionOptions.map((option, index) => `
            <div class="option-item">
                <span>${option}</span>
                <button type="button" class="btn-remove-option" onclick="removeOption(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    function saveQuestion(event) {
        event.preventDefault();
        
        const formData = {
            question_text: document.getElementById('questionTextInput').value.trim(),
            question_type: document.getElementById('questionTypeInput').value,
            help_text: document.getElementById('helpTextInput').value.trim(),
            is_required: document.getElementById('isRequiredInput').checked,
            is_target_date: document.getElementById('isTargetDateInput').checked,
            options: questionOptions
        };

        if (!formData.question_text) {
            alert('Question text is required');
            return;
        }

        const url = editingQuestionId 
            ? `/dashboard/mentor/questions/${editingQuestionId}/update/`
            : `/dashboard/mentor/templates/${templateId}/questions/create/`;
        
        const method = editingQuestionId ? 'POST' : 'POST';
        const submitBtn = document.getElementById('questionSubmitBtn');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = editingQuestionId ? 'Updating...' : 'Adding...';

        fetch(url, {
            method: method,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeQuestionModal();
                loadQuestions(); // Reload questions via AJAX
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to save question', 'error');
                } else {
                    alert(data.error || 'Failed to save question');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the question.');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    }

    function editQuestion(questionId) {
        // We need to fetch the question data first
        // For now, let's get it from the server
        fetch(`/dashboard/mentor/questions/${questionId}/update/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Failed to load question');
        })
        .then(data => {
            if (data.success && data.question) {
                openQuestionModal(questionId);
                setTimeout(() => populateQuestionForm(data.question), 100);
            } else {
                alert('Failed to load question data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Fallback: open modal and try to populate from DOM
            openQuestionModal(questionId);
        });
    }

    function openDeleteConfirmModal(questionId) {
        deleteQuestionId = questionId;
        const modal = document.getElementById('deleteConfirmModal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }

    function closeDeleteConfirmModal() {
        const modal = document.getElementById('deleteConfirmModal');
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            deleteQuestionId = null;
        }, 300);
    }

    function confirmDeleteQuestion() {
        if (!deleteQuestionId) return;

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.textContent;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Deleting...';

        fetch(`/dashboard/mentor/questions/${deleteQuestionId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeDeleteConfirmModal();
                loadQuestions(); // Reload questions to update UI
            } else {
                if (typeof showNotification !== 'undefined') {
                    showNotification(data.error || 'Failed to delete question', 'error');
                } else {
                    alert(data.error || 'Failed to delete question');
                }
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('An error occurred while deleting the question.', 'error');
            } else {
                alert('An error occurred while deleting the question.');
            }
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
        });
    }

    // Attach confirm delete handler
    document.addEventListener('DOMContentLoaded', function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', confirmDeleteQuestion);
        }
    });

    function updateQuestionNumbers() {
        const questions = document.querySelectorAll('.question-card');
        questions.forEach((card, index) => {
            card.querySelector('.question-number').textContent = index + 1;
        });
    }

    function generateAiQuestions() {
        const btnLarge = document.getElementById('generateAiLarge');
        const btnSmall = document.getElementById('generateAiBtn');
        const container = document.getElementById('questionsContainer');
        const emptyState = document.querySelector('.empty-state-ai');

        // UI Feedback
        if (btnLarge) {
            btnLarge.disabled = true;
            btnLarge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="loading-pulse">Generating...</span>';
        }
        if (btnSmall) {
            btnSmall.disabled = true;
            btnSmall.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        }

        fetch(`/dashboard/mentor/templates/${templateId}/questions/generate-ai/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove empty state if it exists
                if (emptyState) {
                    emptyState.remove();
                }

                // Reload questions via AJAX
                loadQuestions();
            } else {
                alert(data.error || 'Failed to generate questions');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating questions.');
        })
        .finally(() => {
            if (btnLarge) {
                btnLarge.disabled = false;
                btnLarge.innerHTML = '<i class="fas fa-wand-sparkles"></i> Generate with AI';
            }
            if (btnSmall) {
                btnSmall.disabled = false;
                btnSmall.innerHTML = '<i class="fas fa-wand-sparkles"></i> AI Generate';
            }
        });
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('questionModal');
        if (modal && e.target === modal) {
            closeQuestionModal();
        }
    });

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const questionModal = document.getElementById('questionModal');
            const deleteModal = document.getElementById('deleteConfirmModal');
            if (questionModal && questionModal.classList.contains('active')) {
                closeQuestionModal();
            } else if (deleteModal && deleteModal.classList.contains('active')) {
                closeDeleteConfirmModal();
            }
        }
    });
</script>
{% endblock %}
