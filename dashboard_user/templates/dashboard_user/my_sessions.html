{% extends "dashboard_user/base.html" %}
{% load static %}

{% block page_title %}My Sessions{% endblock %}

{% block dashboard_content %}
<div class="dashboard-content-container">
    <div class="my-sessions-header">
    <h1 class="dashboard-page-title">My Sessions</h1>
        <a href="{% url 'general:dashboard_user:session_management' %}" class="btn btn-primary" style="position: relative;">
            <i class="fas fa-inbox"></i>
            <span>Session Invitations & Changes</span>
            {% if pending_sessions_count > 0 %}
            <span class="btn-badge">{{ pending_sessions_count }}</span>
            {% endif %}
        </a>
    </div>

    <div class="dashboard-card flex-scroll-card">
        <div class="card-header" style="align-items: center;">
            <h3 class="card-title">Upcoming sessions</h3>
        </div>

        <div class="session-timeline-container scrollable-content" id="sessionsContainer" data-user-timezone="{{ user_timezone }}">
            {% if initial_sessions %}
                {% for session in initial_sessions %}
                    <div class="session-item status-{{ session.status }}" data-clickable-session data-session-id="{{ session.id }}" {% if session.status == 'invited' %}data-invitation-id="{{ session.invitation_id|default:'' }}" data-session-price="{{ session.session_price|default:0 }}" data-mentor-id="{{ session.mentor_user_id|default:'' }}" data-mentor-name="{{ session.mentor_name|default:'' }}" data-session-date="{{ session.start_datetime|date:'Y-m-d' }}" data-session-start="{{ session.start_datetime|date:'g:i A' }}" data-session-end="{{ session.end_datetime|date:'g:i A' }}"{% endif %}>
                        <div class="session-left">
                            <div class="session-date">
                                <span class="date-day">{{ session.start_datetime|date:"d" }}</span>
                                <span class="date-month">{{ session.start_datetime|date:"M" }}</span>
                            </div>
                            <div class="session-info">
                                <h4 class="session-title">Session with {{ session.mentor_name }}</h4>
                                <div class="session-meta-row">
                                    <span class="session-time">
                                        <i class="far fa-clock"></i> {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                                    </span>
                                    <span class="conf-tag {% if session.status == 'confirmed' %}confirmed{% else %}tbc{% endif %}" style="{% if session.status == 'confirmed' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;{% elif session.status == 'invited' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;{% endif %}">
                                        {% if session.status == 'confirmed' %}Confirmed{% else %}Invited{% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="session-right">
                            <div class="dropdown">
                                <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
                                    {% if session.status == 'confirmed' %}
                                    <button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal({{ session.id }});"><i class="fas fa-info-circle"></i><span>View Details</span></button>
                                    {% endif %}
                                    <button type="button" class="dropdown-item {% if session.status != 'confirmed' %}first-item {% endif %}delete-item last-item" onclick="if (typeof openUserCancelSessionModal === 'function') openUserCancelSessionModal({{ session.id }});"><i class="fas fa-times-circle"></i><span>Cancel session</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="session-item" style="border-left: none; padding: 16px; text-align: center; color: var(--dash-text-muted);">
                    <p>No upcoming sessions</p>
                <a href="{% url 'web:mentors' %}" class="btn btn-primary" style="margin-top: 16px;">Find a Mentor</a>
                </div>
            {% endif %}
            
            <!-- Loading indicator for infinite scroll -->
            <div id="sessionsLoading" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
                <i class="fas fa-spinner fa-spin"></i> Loading more sessions...
            </div>
            
            <!-- End of list indicator -->
            <div id="sessionsEnd" style="display: none; padding: 20px; text-align: center; color: var(--dash-text-muted);">
                <p>No more sessions to load</p>
            </div>
        </div>
    </div>
</div>

<style>
.my-sessions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    gap: 16px;
}

.my-sessions-header .dashboard-page-title {
    margin: 0;
    flex: 1;
}

.my-sessions-header .btn {
    display: inline-flex;
    align-items: center;
    border-radius: 8px;
    gap: 8px;
    white-space: nowrap;
}

/* Button Badge for Session Management */
.btn-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background: #ef4444;
  color: white;
  font-size: 0.7rem;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  line-height: 1.4;
  z-index: 2;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 768px) {
    .my-sessions-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .my-sessions-header .btn {
        width: 100%;
        justify-content: center;
    }
}

/* Cancel session modal (same pattern as mentor) */
.session-detail-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(8px);
}
.session-detail-modal-backdrop { position: absolute; inset: 0; }
.session-detail-modal {
    position: relative;
    width: 80vw;
    max-width: 420px;
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}
.session-detail-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}
.session-detail-modal-title { margin: 0; font-size: 1.25rem; font-weight: 800; color: #0f172a; }
.session-detail-modal-close {
    border-radius: 50%;
    border: none;
    background: #f1f5f9;
    cursor: pointer;
    width: 40px;
    height: 40px;
    color: #64748b;
    font-size: 1.1rem;
}
.session-detail-modal-close:hover { background: #fee2e2; color: #ef4444; }
.session-detail-modal-body { padding: 32px; overflow-y: auto; }

/* Make entire session row clickable */
.session-item[data-clickable-session] {
    cursor: pointer;
}

.session-item[data-clickable-session] .session-right {
    cursor: default;
}
</style>

<script>
(function() {
  // Make session rows clickable (entire row, not just text)
  const container = document.getElementById('sessionsContainer');
  if (container) {
      container.addEventListener('click', function(e) {
          const row = e.target.closest('.session-item[data-clickable-session]');
          if (!row) return;
          // Don't trigger if clicking on dropdown menu
          if (e.target.closest('.session-right')) return;
          // Check status from class list
          const isInvited = row.classList.contains('status-invited');
          const isConfirmed = row.classList.contains('status-confirmed');
          
          if (isInvited) {
            e.preventDefault();
            e.stopPropagation();
            const invitationId = row.getAttribute('data-invitation-id');
            const sessionPrice = row.getAttribute('data-session-price') || '0';
            const mentorId = row.getAttribute('data-mentor-id');
            const mentorName = row.getAttribute('data-mentor-name');
            const sessionDate = row.getAttribute('data-session-date');
            const sessionStart = row.getAttribute('data-session-start');
            const sessionEnd = row.getAttribute('data-session-end');
            if (invitationId && typeof window.openAcceptInvitationModalFromSession === 'function') {
              window.openAcceptInvitationModalFromSession(invitationId, sessionPrice, {
                mentorId: mentorId,
                mentorName: mentorName,
                sessionDate: sessionDate,
                sessionStart: sessionStart,
                sessionEnd: sessionEnd
              });
            }
          } else if (isConfirmed) {
            // Only open detail modal for confirmed sessions
            const sessionId = row.getAttribute('data-session-id');
            if (sessionId && typeof openSessionDetailModal === 'function') {
                openSessionDetailModal(parseInt(sessionId, 10));
            }
          }
          // For any other status, do nothing
      });
  }

  // Start at page 1 since initial load is page 1
  let currentPage = 1;
  let isLoading = false;
  let hasMore = true;
  const perPage = 10;
  const sessionsContainer = document.getElementById('sessionsContainer');
  const loadingIndicator = document.getElementById('sessionsLoading');
  const endIndicator = document.getElementById('sessionsEnd');
  
  if (!sessionsContainer) return;
  
  // Function to refresh the entire my-sessions page
  window.refreshMySessionsPage = async function() {
    if (!sessionsContainer) return;
    
    // Reset state
    currentPage = 1;
    hasMore = true;
    isLoading = false;
    
    // Clear existing sessions (keep loading and end indicators)
    const existingSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
    existingSessions.forEach(session => session.remove());
    
    // Hide indicators
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    if (endIndicator) endIndicator.style.display = 'none';
    
    // Load page 1
    try {
      isLoading = true;
      if (loadingIndicator) loadingIndicator.style.display = 'block';
      
      const response = await fetch(`{% url 'general:dashboard_user:get_sessions_paginated' %}?page=1&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        if (loadingIndicator) {
          sessionsContainer.insertBefore(fragment, loadingIndicator);
        } else {
          sessionsContainer.appendChild(fragment);
        }
        
        hasMore = data.has_next;
        
        if (!hasMore && endIndicator) {
          endIndicator.style.display = 'block';
        }
      } else {
        // No sessions
        hasMore = false;
        if (endIndicator) endIndicator.style.display = 'block';
      }
    } catch (error) {
      console.error('Error refreshing my-sessions page:', error);
      hasMore = false;
    } finally {
      isLoading = false;
      if (loadingIndicator) loadingIndicator.style.display = 'none';
    }
  };
  
  // Check if there are initial sessions to determine if we should load more
  const initialSessions = sessionsContainer.querySelectorAll('.session-item:not(#sessionsLoading):not(#sessionsEnd)');
  // If we have no initial sessions, there's nothing to load
  if (initialSessions.length === 0) {
    hasMore = false;
    if (endIndicator) endIndicator.style.display = 'block';
  } else if (initialSessions.length < perPage) {
    // If we have fewer than perPage, likely no more pages
    // But we'll still try to load page 2 to be sure
    hasMore = true;
  }
  
  // User's selected timezone from profile (used so paginated sessions match initial server-rendered times)
  const userTimezone = sessionsContainer.getAttribute('data-user-timezone') || Intl.DateTimeFormat().resolvedOptions().timeZone;

  // Make formatSessionHTML accessible to refreshMySessionsPage
  function formatSessionHTML(session) {
    const startDate = new Date(session.start_datetime);
    const endDate = new Date(session.end_datetime);
    const tzOpt = { timeZone: userTimezone };

    const day = new Intl.DateTimeFormat('en-US', { ...tzOpt, day: 'numeric' }).format(startDate);
    const month = new Intl.DateTimeFormat('en-US', { ...tzOpt, month: 'short' }).format(startDate);
    const startTime = new Intl.DateTimeFormat('en-US', { ...tzOpt, hour: 'numeric', minute: '2-digit', hour12: true }).format(startDate);
    const endTime = new Intl.DateTimeFormat('en-US', { ...tzOpt, hour: 'numeric', minute: '2-digit', hour12: true }).format(endDate);
    
    const statusClass = session.status === 'confirmed' ? 'confirmed' : 'tbc';
    const statusText = session.status === 'confirmed' ? 'Confirmed' : 'Invited';
    const statusStyle = session.status === 'confirmed' 
      ? 'background: rgba(34, 197, 94, 0.1); color: #16a34a;'
      : 'background: rgba(251, 191, 36, 0.1); color: #f59e0b;';
    
    const invitationId = session.invitation_id || '';
    const sessionPrice = session.session_price || 0;
    const mentorId = session.mentor_user_id || '';
    const mentorName = session.mentor_name || '';
    const sessionDateStr = new Intl.DateTimeFormat('en-US', { ...tzOpt, year: 'numeric', month: '2-digit', day: '2-digit' }).format(startDate);
    const sessionDate = sessionDateStr.split('/').reverse().join('-'); // Convert MM/DD/YYYY to YYYY-MM-DD
    
    const invitationAttrs = session.status === 'invited' && invitationId 
      ? `data-invitation-id="${invitationId}" data-session-price="${sessionPrice}" data-mentor-id="${mentorId}" data-mentor-name="${escapeHtml(mentorName)}" data-session-date="${sessionDate}" data-session-start="${startTime}" data-session-end="${endTime}"` 
      : '';
    
    // Only show "View Details" for confirmed sessions
    const viewDetailsBtn = session.status === 'confirmed' 
      ? `<button type="button" class="dropdown-item first-item" onclick="if (typeof openSessionDetailModal === 'function') openSessionDetailModal(${session.id});"><i class="fas fa-info-circle"></i><span>View Details</span></button>`
      : '';
    
    return `
      <div class="session-item status-${session.status}" data-clickable-session data-session-id="${session.id}" ${invitationAttrs}>
        <div class="session-left" style="cursor: ${session.status === 'confirmed' ? 'pointer' : 'pointer'};">
          <div class="session-date">
            <span class="date-day">${day}</span>
            <span class="date-month">${month}</span>
          </div>
          <div class="session-info">
            <h4 class="session-title">Session with ${escapeHtml(session.mentor_name)}</h4>
            <div class="session-meta-row">
              <span class="session-time">
                <i class="far fa-clock"></i> ${startTime} - ${endTime}
              </span>
              <span class="conf-tag ${statusClass}" style="${statusStyle}">
                ${statusText}
              </span>
            </div>
          </div>
        </div>
        
        <div class="session-right">
          <div class="dropdown">
            <button class="session-action-btn" type="button" onclick="toggleDropdown(this)">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="dropdown-menu session-row-actions-menu" onclick="event.stopPropagation();">
              ${viewDetailsBtn}
              <button type="button" class="dropdown-item ${session.status === 'confirmed' ? '' : 'first-item '}delete-item last-item" onclick="if (typeof openUserCancelSessionModal === 'function') openUserCancelSessionModal(${session.id});"><i class="fas fa-times-circle"></i><span>Cancel session</span></button>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  async function loadMoreSessions() {
    if (isLoading || !hasMore) return;
    
    isLoading = true;
    loadingIndicator.style.display = 'block';
    
    try {
      const response = await fetch(`{% url 'general:dashboard_user:get_sessions_paginated' %}?page=${currentPage + 1}&per_page=${perPage}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || '',
        },
      });
      
      const data = await response.json();
      
      if (data.success && data.sessions.length > 0) {
        // Insert sessions before loading indicator
        const fragment = document.createDocumentFragment();
        data.sessions.forEach(session => {
          const div = document.createElement('div');
          div.innerHTML = formatSessionHTML(session);
          fragment.appendChild(div.firstElementChild);
        });
        
        loadingIndicator.parentNode.insertBefore(fragment, loadingIndicator);
        
        currentPage++;
        hasMore = data.has_next;
        
        if (!hasMore) {
          loadingIndicator.style.display = 'none';
          endIndicator.style.display = 'block';
        }
      } else {
        hasMore = false;
        loadingIndicator.style.display = 'none';
        if (currentPage === 1 && data.sessions.length === 0) {
          // No sessions at all
        } else {
          endIndicator.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('Error loading more sessions:', error);
      hasMore = false;
      loadingIndicator.style.display = 'none';
    } finally {
      isLoading = false;
    }
  }
  
  // Infinite scroll handler
  let scrollTimeout;
  sessionsContainer.addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
      const scrollTop = sessionsContainer.scrollTop;
      const scrollHeight = sessionsContainer.scrollHeight;
      const clientHeight = sessionsContainer.clientHeight;
      
      // Load more when user is 200px from bottom
      if (scrollHeight - scrollTop - clientHeight < 200) {
        loadMoreSessions();
      }
    }, 100);
  });
  
  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
})();
</script>

{% include 'dashboard_user/popups/accept_invitation_modal.html' %}

<script src="https://js.stripe.com/v3/"></script>
<script>
// Accept/Decline invitation modal functionality for invited sessions (my-sessions page)
(function() {
  var walletBalanceCents = {{ wallet_balance_cents|default:0 }};
  var stripePk = '{{ stripe_publishable_key|default:""|escapejs }}';
  var createAcceptPiUrl = '{% url "general:dashboard_user:create_accept_session_payment_intent" %}';
  var acceptInvitationUrl = '{% url "general:dashboard_user:session_management" %}';
  var declineInvitationUrl = '{% url "general:dashboard_user:session_management" %}';
  var acceptModalOverlay = null;
  var acceptPriceCents = 0;
  var acceptInvitationId = null;
  var acceptStripeInstance = null;
  var acceptCardNumber = null;
  var acceptCardExpiry = null;
  var acceptCardCvc = null;
  var acceptSelectedMethod = 'card';

  function getCsrfToken() {
    var input = document.querySelector('[name=csrfmiddlewaretoken]');
    if (input) return input.value;
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
      var c = cookies[i].trim();
      if (c.indexOf('csrftoken=') === 0) return decodeURIComponent(c.substring('csrftoken='.length));
    }
    return '';
  }

  function openAcceptInvitationModal(invitationId, sessionPriceDollars, sessionDetails) {
    acceptInvitationId = invitationId;
    acceptPriceCents = Math.round(parseFloat(sessionPriceDollars) * 100) || 0;
    acceptModalOverlay = document.getElementById('acceptInvitationModalOverlay');
    var freeSection = document.getElementById('acceptInvitationFreeSection');
    var paidSection = document.getElementById('acceptInvitationPaidSection');
    if (!acceptModalOverlay) return;
    
    // Populate session details if provided (for both free and paid sections)
    if (sessionDetails) {
      // Paid section elements
      var mentorNameEl = document.getElementById('acceptInvitationMentorName');
      var mentorLinkEl = document.getElementById('acceptInvitationMentorLink');
      var sessionDateEl = document.getElementById('acceptInvitationSessionDate');
      var sessionTimeEl = document.getElementById('acceptInvitationSessionTime');
      
      // Free section elements
      var mentorNameElFree = document.getElementById('acceptInvitationMentorNameFree');
      var mentorLinkElFree = document.getElementById('acceptInvitationMentorLinkFree');
      var sessionDateElFree = document.getElementById('acceptInvitationSessionDateFree');
      var sessionTimeElFree = document.getElementById('acceptInvitationSessionTimeFree');
      
      function populateDetails(mentorNameEl, mentorLinkEl, sessionDateEl, sessionTimeEl) {
        if (mentorNameEl) {
          if (sessionDetails.mentorName && sessionDetails.mentorName !== '—' && sessionDetails.mentorName.trim() !== '') {
            mentorNameEl.textContent = sessionDetails.mentorName;
          } else {
            mentorNameEl.textContent = '—';
          }
        }
        if (mentorLinkEl) {
          if (sessionDetails.mentorId && sessionDetails.mentorId !== '' && sessionDetails.mentorId !== 'null') {
            mentorLinkEl.href = '/mentor/' + sessionDetails.mentorId + '/';
          } else {
            mentorLinkEl.href = '#';
            mentorLinkEl.style.pointerEvents = 'none';
            mentorLinkEl.style.opacity = '0.6';
          }
        }
        if (sessionDateEl && sessionDetails.sessionDate) {
          // Format date: YYYY-MM-DD to readable format
          try {
            // Handle different date formats
            var dateStr = sessionDetails.sessionDate;
            var dateObj;
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
              // YYYY-MM-DD format
              dateObj = new Date(dateStr + 'T00:00:00');
            } else {
              // Try parsing as-is
              dateObj = new Date(dateStr);
            }
            if (!isNaN(dateObj.getTime())) {
              var options = { year: 'numeric', month: 'long', day: 'numeric' };
              sessionDateEl.textContent = dateObj.toLocaleDateString('en-US', options);
            } else {
              sessionDateEl.textContent = sessionDetails.sessionDate || '—';
            }
          } catch(e) {
            sessionDateEl.textContent = sessionDetails.sessionDate || '—';
          }
        } else if (sessionDateEl) {
          sessionDateEl.textContent = '—';
        }
        if (sessionTimeEl && sessionDetails.sessionStart && sessionDetails.sessionEnd) {
          sessionTimeEl.textContent = sessionDetails.sessionStart + ' - ' + sessionDetails.sessionEnd;
        } else if (sessionTimeEl) {
          sessionTimeEl.textContent = '—';
        }
        // Also handle missing mentor name
        if (mentorNameEl && !sessionDetails.mentorName) {
          mentorNameEl.textContent = '—';
        }
      }
      
      populateDetails(mentorNameEl, mentorLinkEl, sessionDateEl, sessionTimeEl);
      populateDetails(mentorNameElFree, mentorLinkElFree, sessionDateElFree, sessionTimeElFree);
    }
    
    // Show/hide footer actions
    var freeActions = document.getElementById('acceptInvitationFreeActions');
    var paidActions = document.getElementById('acceptInvitationPaidActions');
    
    // Update header title
    var headerTitle = document.getElementById('acceptInvitationHeaderTitle');
    if (headerTitle) {
      if (acceptPriceCents <= 0) {
        headerTitle.innerHTML = '<i class="fas fa-check-circle"></i> Accept invitation';
      } else {
        headerTitle.innerHTML = '<i class="fas fa-envelope-open-text"></i> Accept Invitation';
      }
    }
    
    if (acceptPriceCents <= 0) {
      freeSection.style.display = 'block';
      paidSection.style.display = 'none';
      if (freeActions) freeActions.style.display = 'flex';
      if (paidActions) paidActions.style.display = 'none';
      acceptModalOverlay.style.display = 'flex';
      return;
    }
    freeSection.style.display = 'none';
    paidSection.style.display = 'block';
    if (freeActions) freeActions.style.display = 'none';
    if (paidActions) paidActions.style.display = 'flex';
    // Update price display in left column
    var amountTextEl = document.getElementById('acceptInvitationAmountText');
    if (amountTextEl) {
      amountTextEl.textContent = '$' + (acceptPriceCents / 100).toFixed(2);
    }
    // Update pay button amount
    var payAmountEl = document.getElementById('acceptInvitationPayAmount');
    if (payAmountEl) {
      payAmountEl.textContent = '$' + (acceptPriceCents / 100).toFixed(2);
    }
    var walletOption = document.getElementById('acceptPayWithWalletOption');
    var cardOption = document.getElementById('acceptPayWithCardOption');
    var cardSection = document.getElementById('acceptInvitationCardSection');
    var insufficientNote = document.getElementById('acceptInvitationInsufficientNote');
    var walletLabel = document.getElementById('acceptWalletAmountLabel');
    var canWallet = walletBalanceCents >= acceptPriceCents;
    
    // Always show wallet option if user is authenticated
    if (walletOption) {
      walletOption.style.display = 'flex';
      // Always show current wallet balance (similar to booking modal)
      if (walletLabel) {
        const walletBalance = (walletBalanceCents / 100).toFixed(2);
        walletLabel.textContent = ' ($' + walletBalance + ' available)';
      }
    }
    
    // Show insufficient note only when wallet is selected AND funds are insufficient
    if (insufficientNote) {
      insufficientNote.style.display = 'none'; // Hidden by default, shown only when wallet selected and insufficient
    }
    
    // Default to card if insufficient wallet balance, otherwise default to wallet
    if (canWallet) {
      acceptSelectedMethod = 'wallet';
      document.getElementById('acceptPaymentMethodWallet').checked = true;
      document.getElementById('acceptPaymentMethodCard').checked = false;
      cardSection.style.display = 'none';
      unmountAcceptCard();
    } else {
      acceptSelectedMethod = 'card';
      document.getElementById('acceptPaymentMethodCard').checked = true;
      document.getElementById('acceptPaymentMethodWallet').checked = false;
      if (cardSection) {
        cardSection.style.display = 'block';
        if (stripePk && typeof window.Stripe === 'function') mountAcceptCard();
      }
    }
    var payBtn = document.getElementById('acceptInvitationPayBtn');
    if (payBtn) payBtn.disabled = false;
    acceptModalOverlay.style.display = 'flex';
  }

  window.openAcceptInvitationModalFromSession = openAcceptInvitationModal;

  window.closeAcceptInvitationModal = function() {
    var overlay = document.getElementById('acceptInvitationModalOverlay');
    if (overlay) overlay.style.display = 'none';
    unmountAcceptCard();
  };

  function mountAcceptCard() {
    if (!stripePk || !window.Stripe || acceptCardNumber) return;
    var numEl = document.getElementById('acceptInvitationCardNumberContainer');
    var expEl = document.getElementById('acceptInvitationCardExpiryContainer');
    var cvcEl = document.getElementById('acceptInvitationCardCvcContainer');
    if (!numEl || !expEl || !cvcEl) return;
    try {
      acceptStripeInstance = window.Stripe(stripePk);
      var elements = acceptStripeInstance.elements();
      var style = { style: { base: { fontSize: '16px' } } };
      acceptCardNumber = elements.create('cardNumber', style);
      acceptCardExpiry = elements.create('cardExpiry', style);
      acceptCardCvc = elements.create('cardCvc', style);
      acceptCardNumber.mount('#acceptInvitationCardNumberContainer');
      acceptCardExpiry.mount('#acceptInvitationCardExpiryContainer');
      acceptCardCvc.mount('#acceptInvitationCardCvcContainer');
      var errEl = document.getElementById('acceptInvitationCardError');
      var errText = document.getElementById('acceptInvitationCardErrorText');
      function onChange(e) {
        if (errEl && errText) {
          errText.textContent = e.error ? (e.error.message || '') : '';
          errEl.style.display = e.error ? 'flex' : 'none';
        }
      }
      acceptCardNumber.on('change', onChange);
      acceptCardExpiry.on('change', onChange);
      acceptCardCvc.on('change', onChange);
    } catch (e) { console.error('Accept modal Stripe mount error', e); }
  }

  function unmountAcceptCard() {
    if (acceptCardNumber) { try { acceptCardNumber.unmount(); } catch (x) {} acceptCardNumber = null; }
    if (acceptCardExpiry) { try { acceptCardExpiry.unmount(); } catch (x) {} acceptCardExpiry = null; }
    if (acceptCardCvc) { try { acceptCardCvc.unmount(); } catch (x) {} acceptCardCvc = null; }
  }

  function submitAcceptInvitation(extraData) {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = acceptInvitationUrl;
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCsrfToken();
    form.appendChild(csrfInput);
    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'confirm_invitation';
    form.appendChild(actionInput);
    var invIdInput = document.createElement('input');
    invIdInput.type = 'hidden';
    invIdInput.name = 'invitation_id';
    invIdInput.value = acceptInvitationId;
    form.appendChild(invIdInput);
    if (extraData) {
      for (var k in extraData) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = extraData[k];
        form.appendChild(input);
      }
    }
    document.body.appendChild(form);
    form.submit();
  }

  function submitDeclineInvitation() {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = declineInvitationUrl;
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCsrfToken();
    form.appendChild(csrfInput);
    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'decline_invitation';
    form.appendChild(actionInput);
    var invIdInput = document.createElement('input');
    invIdInput.type = 'hidden';
    invIdInput.name = 'invitation_id';
    invIdInput.value = acceptInvitationId;
    form.appendChild(invIdInput);
    document.body.appendChild(form);
    form.submit();
  }

  document.addEventListener('DOMContentLoaded', function() {
    acceptModalOverlay = document.getElementById('acceptInvitationModalOverlay');
    if (acceptModalOverlay) {
      acceptModalOverlay.addEventListener('click', function(e) {
        if (e.target === acceptModalOverlay) window.closeAcceptInvitationModal();
      });
      
      // Close modal on Escape key (only if wallet topup modal is not open)
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          // Check if wallet topup modal is open first (it has higher z-index)
          var walletOverlay = document.getElementById('walletTopUpModalOverlay');
          if (walletOverlay && walletOverlay.style.display === 'flex') {
            // Wallet topup modal will handle its own Escape key, don't close Accept Invitation
            return;
          }
          // Only close Accept Invitation if it's open and wallet topup is not
          if (acceptModalOverlay && acceptModalOverlay.style.display === 'flex') {
            window.closeAcceptInvitationModal();
          }
        }
      });
    }

    // Modal button handlers
    var confirmFreeBtn = document.getElementById('acceptInvitationConfirmFreeBtn');
    if (confirmFreeBtn) {
      confirmFreeBtn.addEventListener('click', function() {
        submitAcceptInvitation(null);
        window.closeAcceptInvitationModal();
        setTimeout(function() {
          window.location.reload();
        }, 500);
      });
    }

    var declineBtn = document.getElementById('acceptInvitationDeclineBtn');
    if (declineBtn) {
      declineBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to decline this invitation?')) {
          submitDeclineInvitation();
          window.closeAcceptInvitationModal();
          setTimeout(function() {
            window.location.reload();
          }, 500);
        }
      });
    }

    var declineBtnPaid = document.getElementById('acceptInvitationDeclineBtnPaid');
    if (declineBtnPaid) {
      declineBtnPaid.addEventListener('click', function() {
        if (confirm('Are you sure you want to decline this invitation?')) {
          submitDeclineInvitation();
          window.closeAcceptInvitationModal();
          setTimeout(function() {
            window.location.reload();
          }, 500);
        }
      });
    }

    var payBtn = document.getElementById('acceptInvitationPayBtn');
    if (payBtn) {
      payBtn.addEventListener('click', function() {
        if (acceptSelectedMethod === 'wallet') {
          submitAcceptInvitation({ use_wallet: '1' });
          window.closeAcceptInvitationModal();
          setTimeout(function() {
            window.location.reload();
          }, 500);
          return;
        }
        payBtn.disabled = true;
        payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        var errEl = document.getElementById('acceptInvitationCardError');
        var errText = document.getElementById('acceptInvitationCardErrorText');
        if (errText) errText.textContent = '';
        if (errEl) errEl.style.display = 'none';
        fetch(createAcceptPiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
          body: JSON.stringify({ invitation_id: acceptInvitationId, attempt_id: (window.crypto && window.crypto.randomUUID) ? window.crypto.randomUUID() : 'a' + Date.now() })
        }).then(function(r) { return r.json(); }).then(function(data) {
          if (!data.success || !data.client_secret) {
            if (errText) errText.textContent = data.error || 'Could not start payment.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
            return;
          }
          if (!acceptStripeInstance || !acceptCardNumber) {
            if (errText) errText.textContent = 'Card form not ready.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
            return;
          }
          acceptStripeInstance.confirmCardPayment(data.client_secret, {
            payment_method: { card: acceptCardNumber }
          }).then(function(result) {
            if (result.error) {
              if (errText) errText.textContent = result.error.message || 'Payment failed.';
              if (errEl) errEl.style.display = 'flex';
              payBtn.disabled = false;
              payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
              return;
            }
            if (result.paymentIntent && result.paymentIntent.status === 'succeeded') {
              window.closeAcceptInvitationModal();
              submitAcceptInvitation({ payment_intent_id: result.paymentIntent.id });
              if (typeof showPaymentConfirmationModal === 'function') {
                showPaymentConfirmationModal('Session paid successfully. Your invitation has been accepted.');
              }
              // Reload page after successful payment
              setTimeout(function() {
                window.location.reload();
              }, 1500);
            }
          }).catch(function() {
            if (errText) errText.textContent = 'Payment could not be completed.';
            if (errEl) errEl.style.display = 'flex';
            payBtn.disabled = false;
            payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
          });
        }).catch(function() {
          if (errText) errText.textContent = 'Could not start payment. Try again.';
          if (errEl) errEl.style.display = 'flex';
          payBtn.disabled = false;
          payBtn.innerHTML = '<span id="acceptInvitationPayBtnText">Accept & Pay <span id="acceptInvitationPayAmount">$' + (acceptPriceCents/100).toFixed(2) + '</span></span>';
        });
      });
    }

    document.querySelectorAll('input[name="accept_payment_method"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        acceptSelectedMethod = this.value;
        var cardSection = document.getElementById('acceptInvitationCardSection');
        var insufficientNote = document.getElementById('acceptInvitationInsufficientNote');
        var canWallet = walletBalanceCents >= acceptPriceCents;
        
        if (acceptSelectedMethod === 'wallet') {
          cardSection.style.display = 'none';
          unmountAcceptCard();
          // Show insufficient note only if wallet is selected AND insufficient
          if (insufficientNote) {
            insufficientNote.style.display = canWallet ? 'none' : 'block';
          }
        } else {
          cardSection.style.display = 'block';
          if (insufficientNote) insufficientNote.style.display = 'none';
          if (stripePk && typeof window.Stripe === 'function') mountAcceptCard();
        }
      });
    });
  });
})();
</script>
{% endblock %}
