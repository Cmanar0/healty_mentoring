<style>
/* Enhanced Mismatch Modal Styles */
.timezone-mismatch-modal-content {
    max-width: 1000px;
    width: 95%;
}

.timezone-mismatch-alert {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid #3b82f6;
    border-radius: 8px;
    margin-bottom: 24px;
}

.timezone-mismatch-alert-icon {
    color: #3b82f6;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.timezone-mismatch-alert-text {
    flex: 1;
    color: var(--dash-text-main);
    font-size: 0.95rem;
    line-height: 1.5;
}

.timezone-mismatch-alert-text strong {
    color: #1e40af;
    font-weight: 600;
}

.timezone-mismatch-comparison-enhanced {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 24px;
    align-items: stretch;
    margin: 32px 0;
}

.timezone-mismatch-card {
    display: flex;
    flex-direction: column;
    padding: 32px;
    background: white;
    border-radius: 16px;
    border: 2px solid var(--dash-border);
    transition: all 0.3s ease;
    position: relative;
}

.timezone-mismatch-card.detected {
    border-color: var(--dash-primary);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
}

.timezone-mismatch-card.selected {
    border-color: #64748b;
    background: white;
}

.timezone-mismatch-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--dash-border);
}

.timezone-mismatch-card-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--dash-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.timezone-mismatch-card-title i {
    font-size: 1rem;
}

.timezone-mismatch-card.detected .timezone-mismatch-card-title {
    color: var(--dash-primary);
}

.timezone-mismatch-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.timezone-mismatch-badge.new {
    background: rgba(16, 185, 129, 0.15);
    color: var(--dash-primary);
}

.timezone-mismatch-badge.current {
    background: rgba(100, 116, 139, 0.15);
    color: #64748b;
}

.timezone-mismatch-card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    text-align: center;
    gap: 16px;
}

.timezone-mismatch-name {
    font-size: 1.25rem;
    color: var(--dash-text-main);
    font-weight: 700;
    margin-bottom: 8px;
}

.timezone-mismatch-offset {
    font-size: 0.9rem;
    color: var(--dash-text-muted);
    font-weight: 500;
    margin-bottom: 16px;
}

.timezone-mismatch-time-display {
    padding: 20px;
    background: var(--dash-bg);
    border-radius: 12px;
    margin: 12px 0;
}

.timezone-mismatch-date-display {
    font-size: 0.9rem;
    color: var(--dash-text-main);
    font-weight: 500;
    margin-bottom: 8px;
}

.timezone-mismatch-time-display-value {
    font-size: 2rem;
    color: var(--dash-primary);
    font-weight: 700;
    font-family: 'Courier New', monospace;
    line-height: 1.2;
}

.timezone-mismatch-card-footer {
    margin-top: auto;
    padding-top: 20px;
}

.timezone-mismatch-divider-enhanced {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: var(--dash-text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: relative;
}

.timezone-mismatch-divider-enhanced::before,
.timezone-mismatch-divider-enhanced::after {
    content: '';
    position: absolute;
    width: 1px;
    height: 40px;
    background: var(--dash-border);
}

.timezone-mismatch-divider-enhanced::before {
    top: -20px;
}

.timezone-mismatch-divider-enhanced::after {
    bottom: -20px;
}

/* Expandable Different Timezone Section */
.timezone-mismatch-expandable {
    margin-top: 32px;
    padding-top: 32px;
    border-top: 2px solid var(--dash-border);
}

.timezone-mismatch-expand-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: var(--dash-bg);
    border: 2px dashed var(--dash-border);
    border-radius: 12px;
    color: var(--dash-text-main);
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.timezone-mismatch-expand-toggle:hover {
    background: var(--dash-bg-light);
    border-color: var(--dash-primary);
    color: var(--dash-primary);
}

.timezone-mismatch-expand-toggle i {
    transition: transform 0.3s ease;
}

.timezone-mismatch-expandable.expanded .timezone-mismatch-expand-toggle i {
    transform: rotate(180deg);
}

.timezone-mismatch-expandable-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    padding: 0;
}

.timezone-mismatch-expandable.expanded .timezone-mismatch-expandable-content {
    max-height: 800px;
    padding: 24px 0;
}

.timezone-mismatch-time-selection {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 24px;
}

.timezone-mismatch-time-input-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.timezone-mismatch-time-input-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--dash-text-main);
    display: flex;
    align-items: center;
    gap: 6px;
}

.timezone-mismatch-time-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.timezone-mismatch-time-input-wrapper i {
    position: absolute;
    left: 16px;
    color: var(--dash-text-muted);
    font-size: 1rem;
    z-index: 1;
}

.timezone-mismatch-time-input {
    width: 100%;
    padding: 14px 16px 14px 48px;
    border: 2px solid var(--dash-border);
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Courier New', monospace;
    transition: all 0.2s ease;
}

.timezone-mismatch-time-input:focus {
    outline: none;
    border-color: var(--dash-primary);
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.timezone-mismatch-timezone-list {
    max-height: 400px;
    overflow-y: auto;
    border: 2px solid var(--dash-border);
    border-radius: 12px;
    background: white;
}

.timezone-mismatch-timezone-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-bottom: 1px solid var(--dash-border);
    cursor: pointer;
    transition: all 0.2s ease;
}

.timezone-mismatch-timezone-item:last-child {
    border-bottom: none;
}

.timezone-mismatch-timezone-item:hover {
    background: var(--dash-bg);
}

.timezone-mismatch-timezone-item.selected {
    background: rgba(16, 185, 129, 0.1);
    border-left: 4px solid var(--dash-primary);
}

.timezone-mismatch-timezone-item input[type="radio"] {
    margin-right: 12px;
    cursor: pointer;
}

.timezone-mismatch-timezone-item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.timezone-mismatch-timezone-item-name {
    font-weight: 600;
    color: var(--dash-text-main);
    font-size: 0.95rem;
}

.timezone-mismatch-timezone-item-id {
    font-size: 0.8rem;
    color: var(--dash-text-muted);
    font-family: 'Courier New', monospace;
}

.timezone-mismatch-timezone-item-offset {
    font-size: 0.85rem;
    color: var(--dash-text-muted);
    font-weight: 500;
}

.timezone-mismatch-placeholder {
    padding: 40px 20px;
    text-align: center;
    color: var(--dash-text-muted);
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .timezone-mismatch-comparison-enhanced {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .timezone-mismatch-divider-enhanced {
        display: none;
    }
    
    .timezone-mismatch-time-selection {
        grid-template-columns: 1fr;
    }
    
    .timezone-mismatch-modal-content {
        width: 98%;
        max-height: 95vh;
    }
}
</style>

<!-- Timezone Mismatch Modal -->
<div id="timezoneMismatchModal" class="timezone-modal-overlay" style="display: none;">
    <div class="timezone-modal-content timezone-mismatch-modal-content">
        <div class="timezone-modal-header">
            <div>
                <h3 class="timezone-modal-title">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 8px;"></i>
                    Timezone Mismatch Detected
                </h3>
            </div>
            <button type="button" class="timezone-modal-close" id="timezoneMismatchModalClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="timezone-modal-body">
            <!-- Alert Message -->
            <div class="timezone-mismatch-alert">
                <i class="fas fa-info-circle timezone-mismatch-alert-icon"></i>
                <div class="timezone-mismatch-alert-text">
                    We detected a different timezone at your location. Your <strong>selected timezone</strong> doesn't match your <strong>detected timezone</strong>. Please choose which one to use.
                </div>
            </div>

            <!-- Two Column Comparison -->
            <div class="timezone-mismatch-comparison-enhanced">
                <!-- Detected Column -->
                <div class="timezone-mismatch-card detected">
                    <div class="timezone-mismatch-card-header">
                        <div class="timezone-mismatch-card-title">
                            <i class="fas fa-map-marker-alt"></i>
                            Detected Location
                        </div>
                        <span class="timezone-mismatch-badge new">New</span>
                    </div>
                    <div class="timezone-mismatch-card-body">
                        <div class="timezone-mismatch-name" id="timezoneMismatchDetectedName">--</div>
                        <div class="timezone-mismatch-offset" id="timezoneMismatchDetectedOffset">--</div>
                        <div class="timezone-mismatch-time-display">
                            <div class="timezone-mismatch-date-display" id="timezoneMismatchDetectedDate">--</div>
                            <div class="timezone-mismatch-time-display-value" id="timezoneMismatchDetectedTime">--</div>
                        </div>
                    </div>
                    <div class="timezone-mismatch-card-footer">
                        <button type="button" class="btn btn-primary btn-timezone-action" id="timezoneMismatchUseDetectedBtn">
                            <i class="fas fa-check"></i> Use Detected Timezone
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="timezone-mismatch-divider-enhanced">OR</div>

                <!-- Selected Column -->
                <div class="timezone-mismatch-card selected">
                    <div class="timezone-mismatch-card-header">
                        <div class="timezone-mismatch-card-title">
                            <i class="fas fa-user-clock"></i>
                            Your Current Setting
                        </div>
                        <span class="timezone-mismatch-badge current">Current</span>
                    </div>
                    <div class="timezone-mismatch-card-body">
                        <div class="timezone-mismatch-name" id="timezoneMismatchSelectedName">--</div>
                        <div class="timezone-mismatch-offset" id="timezoneMismatchSelectedOffset">--</div>
                        <div class="timezone-mismatch-time-display">
                            <div class="timezone-mismatch-date-display" id="timezoneMismatchSelectedDate">--</div>
                            <div class="timezone-mismatch-time-display-value" id="timezoneMismatchSelectedTime">--</div>
                        </div>
                    </div>
                    <div class="timezone-mismatch-card-footer">
                        <button type="button" class="btn btn-outline btn-timezone-action" id="timezoneMismatchUseSelectedBtn">
                            <i class="fas fa-lock"></i> Keep Current Timezone
                        </button>
                    </div>
                </div>
            </div>

            <!-- Expandable Different Timezone Section -->
            <div class="timezone-mismatch-expandable" id="timezoneMismatchExpandable">
                <button type="button" class="timezone-mismatch-expand-toggle" id="timezoneMismatchExpandToggle">
                    <i class="fas fa-chevron-down"></i>
                    <span>Choose a Different Timezone</span>
                </button>
                <div class="timezone-mismatch-expandable-content">
                    <p style="text-align: center; color: var(--dash-text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                        Enter your current local time to find matching timezones
                    </p>
                    <div class="timezone-mismatch-time-selection">
                        <!-- Time Input -->
                        <div class="timezone-mismatch-time-input-section">
                            <label class="timezone-mismatch-time-input-label">
                                <i class="far fa-clock"></i>
                                What is your current time?
                            </label>
                            <div class="timezone-mismatch-time-input-wrapper">
                                <i class="far fa-clock"></i>
                                <input 
                                    type="time" 
                                    id="timezoneMismatchTimeInput" 
                                    class="timezone-mismatch-time-input"
                                >
                            </div>
                        </div>
                        <!-- Timezone List -->
                        <div class="timezone-mismatch-time-input-section">
                            <label class="timezone-mismatch-time-input-label">
                                <i class="fas fa-globe"></i>
                                Matching Timezones
                            </label>
                            <div class="timezone-mismatch-timezone-list" id="timezoneMismatchTimezoneList">
                                <div class="timezone-mismatch-placeholder">
                                    Enter your current time to see matching timezones...
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            id="timezoneMismatchUseDifferentBtn"
                            disabled
                            style="min-width: 200px;"
                        >
                            <i class="fas fa-check"></i> Use Selected Timezone
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Helper functions
    function getCurrentTimezoneOffset(ianaId) {
        try {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en', {
                timeZone: ianaId,
                timeZoneName: 'longOffset'
            });
            const parts = formatter.formatToParts(now);
            const offsetPart = parts.find(p => p.type === 'timeZoneName');
            
            if (offsetPart && offsetPart.value) {
                const offsetMatch = offsetPart.value.match(/GMT([+-])(\d{1,2})(:?(\d{2}))?/);
                if (offsetMatch) {
                    const sign = offsetMatch[1];
                    const hours = parseInt(offsetMatch[2]) || 0;
                    const minutes = offsetMatch[4] ? parseInt(offsetMatch[4]) : 0;
                    
                    if (minutes === 0) {
                        return 'UTC' + sign + String(hours).padStart(2, '0');
                    } else {
                        return 'UTC' + sign + String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
                    }
                }
            }
            return 'UTC+0';
        } catch (e) {
            return 'UTC+0';
        }
    }
    
    function formatTimezoneName(id) {
        try {
            const parts = id.split('/');
            const city = parts[parts.length - 1] || id;
            return city.replace(/_/g, ' ');
        } catch (e) {
            return id;
        }
    }
    
    function formatTime(date, timezone) {
        try {
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
            return formatter.format(date);
        } catch (e) {
            return 'Unable to format time';
        }
    }
    
    function formatDate(date, timezone) {
        try {
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            return formatter.format(date);
        } catch (e) {
            return 'Unable to format date';
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function getTimezoneList() {
        if (window.TIMEZONE_OPTIONS && window.TIMEZONE_OPTIONS.length > 0) {
            return window.TIMEZONE_OPTIONS;
        }
        try {
            if (typeof Intl.supportedValuesOf === 'function') {
                const ids = Intl.supportedValuesOf('timeZone');
                return ids.map(id => ({
                    id,
                    name: formatTimezoneName(id),
                    offset: getCurrentTimezoneOffset(id)
                }));
            }
        } catch (e) {}
        return [];
    }
    
    function findTimezonesByOffset(offsetMinutes) {
        const timezones = getTimezoneList();
        const matching = [];
        const now = new Date();
        
        timezones.forEach(tz => {
            try {
                const formatter = new Intl.DateTimeFormat('en', {
                    timeZone: tz.id,
                    timeZoneName: 'longOffset'
                });
                const parts = formatter.formatToParts(now);
                const offsetPart = parts.find(p => p.type === 'timeZoneName');
                
                if (offsetPart && offsetPart.value) {
                    const match = offsetPart.value.match(/GMT([+-])(\d{1,2})(:?(\d{2}))?/);
                    if (match) {
                        const sign = match[1] === '+' ? 1 : -1;
                        const hours = parseInt(match[2]) || 0;
                        const minutes = match[4] ? parseInt(match[4]) : 0;
                        const tzOffsetMinutes = sign * (hours * 60 + minutes);
                        
                        if (Math.abs(tzOffsetMinutes - offsetMinutes) < 30) {
                            matching.push(tz);
                        }
                    }
                }
            } catch (e) {}
        });
        
        matching.sort((a, b) => {
            const nameA = (a.name || a.id).toLowerCase();
            const nameB = (b.name || b.id).toLowerCase();
            return nameA.localeCompare(nameB);
        });
        
        return matching;
    }
    
    let currentSelectedTz = null;
    let originalSelectedTz = null;
    let detectedTz = null;
    let differentSelectedTz = null;
    
    // Update timezone list based on time input
    function updateTimezoneListFromTime() {
        const timeInput = document.getElementById('timezoneMismatchTimeInput');
        const tzList = document.getElementById('timezoneMismatchTimezoneList');
        const useDifferentBtn = document.getElementById('timezoneMismatchUseDifferentBtn');
        
        if (!timeInput || !tzList) return;
        
        const timeValue = timeInput.value;
        if (!timeValue) {
            tzList.innerHTML = '<div class="timezone-mismatch-placeholder">Enter your current time to see matching timezones...</div>';
            useDifferentBtn.disabled = true;
            differentSelectedTz = null;
            return;
        }
        
        const [hours24, minutes] = timeValue.split(':').map(Number);
        if (isNaN(hours24) || isNaN(minutes)) return;
        
        const now = new Date();
        const utcHours = now.getUTCHours();
        const utcMinutes = now.getUTCMinutes();
        
        const userTimeMinutes = hours24 * 60 + minutes;
        const utcTimeMinutes = utcHours * 60 + utcMinutes;
        let offsetMinutes = userTimeMinutes - utcTimeMinutes;
        
        while (offsetMinutes > 12 * 60) offsetMinutes -= 24 * 60;
        while (offsetMinutes < -12 * 60) offsetMinutes += 24 * 60;
        
        const matchingTimezones = findTimezonesByOffset(offsetMinutes);
        
        if (matchingTimezones.length > 0) {
            tzList.innerHTML = '';
            matchingTimezones.forEach((tz, index) => {
                const tzItem = document.createElement('div');
                tzItem.className = 'timezone-mismatch-timezone-item';
                tzItem.innerHTML = `
                    <input type="radio" name="timezoneMismatchDifferent" value="${tz.id}" id="tzMismatchDiff${index}">
                    <div class="timezone-mismatch-timezone-item-content">
                        <div class="timezone-mismatch-timezone-item-name">${tz.name || tz.id}</div>
                        <div class="timezone-mismatch-timezone-item-id">${tz.id}</div>
                    </div>
                    <div class="timezone-mismatch-timezone-item-offset">${tz.offset || ''}</div>
                `;
                
                tzItem.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    document.querySelectorAll('.timezone-mismatch-timezone-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    differentSelectedTz = radio.value;
                    useDifferentBtn.disabled = false;
                });
                
                tzList.appendChild(tzItem);
            });
        } else {
            tzList.innerHTML = '<div class="timezone-mismatch-placeholder">No matching timezones found for this time.</div>';
            useDifferentBtn.disabled = true;
            differentSelectedTz = null;
        }
    }
    
    // Open mismatch modal
    window.openTimezoneMismatchModal = function(detectedTimezone, selectedTimezone) {
        const modal = document.getElementById('timezoneMismatchModal');
        if (!modal) {
            console.error('Timezone mismatch modal not found');
            return;
        }
        
        detectedTz = detectedTimezone;
        originalSelectedTz = selectedTimezone;
        currentSelectedTz = selectedTimezone;
        differentSelectedTz = null;
        
        const timezones = getTimezoneList();
        const detectedTzObj = timezones.find(tz => tz.id === detectedTimezone);
        const selectedTzObj = timezones.find(tz => tz.id === selectedTimezone);
        
        let detectedTzName = formatTimezoneName(detectedTimezone);
        let selectedTzName = formatTimezoneName(selectedTimezone);
        
        if (detectedTzObj) {
            detectedTzName = detectedTzObj.name || detectedTzName;
        }
        if (selectedTzObj) {
            selectedTzName = selectedTzObj.name || selectedTzName;
        }
        
        const now = new Date();
        const detectedTime = formatTime(now, detectedTimezone);
        const detectedDate = formatDate(now, detectedTimezone);
        const selectedTime = formatTime(now, selectedTimezone);
        const selectedDate = formatDate(now, selectedTimezone);
        
        // Update UI
        document.getElementById('timezoneMismatchDetectedName').textContent = detectedTzName;
        document.getElementById('timezoneMismatchDetectedOffset').textContent = getCurrentTimezoneOffset(detectedTimezone);
        document.getElementById('timezoneMismatchDetectedDate').textContent = detectedDate;
        document.getElementById('timezoneMismatchDetectedTime').textContent = detectedTime;
        
        document.getElementById('timezoneMismatchSelectedName').textContent = selectedTzName;
        document.getElementById('timezoneMismatchSelectedOffset').textContent = getCurrentTimezoneOffset(selectedTimezone);
        document.getElementById('timezoneMismatchSelectedDate').textContent = selectedDate;
        document.getElementById('timezoneMismatchSelectedTime').textContent = selectedTime;
        
        // Reset expandable section
        const expandable = document.getElementById('timezoneMismatchExpandable');
        expandable.classList.remove('expanded');
        document.getElementById('timezoneMismatchTimeInput').value = '';
        document.getElementById('timezoneMismatchTimezoneList').innerHTML = '<div class="timezone-mismatch-placeholder">Enter your current time to see matching timezones...</div>';
        document.getElementById('timezoneMismatchUseDifferentBtn').disabled = true;
        
        // Show modal
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);
    };
    
    // Close mismatch modal
    window.closeTimezoneMismatchModal = function() {
        const modal = document.getElementById('timezoneMismatchModal');
        if (modal) {
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
    };
    
    // Update to detected timezone
    function updateToDetectedTimezone() {
        const button = document.getElementById('timezoneMismatchUseDetectedBtn');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        }
        
        window.closeTimezoneMismatchModal();
        
        fetch('/dashboard/update-timezone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'use_detected',
                detected_timezone: detectedTz
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                setTimeout(() => window.location.reload(), 100);
            }
        })
        .catch(error => console.error('[Timezone Mismatch Modal] Error:', error));
    }
    
    // Update selected timezone
    function updateSelectedTimezone() {
        const button = document.getElementById('timezoneMismatchUseSelectedBtn');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        }
        
        const confirmedMismatch = currentSelectedTz !== detectedTz;
        
        fetch('/dashboard/update-timezone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'update_selected',
                selected_timezone: currentSelectedTz,
                confirmed_mismatch: confirmedMismatch
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.closeTimezoneMismatchModal();
                setTimeout(() => window.location.reload(), 100);
            } else {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-lock"></i> Keep Current Timezone';
                }
            }
        })
        .catch(error => {
            console.error('[Timezone Mismatch Modal] Error:', error);
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-lock"></i> Keep Current Timezone';
            }
        });
    }
    
    // Update to different timezone
    function updateToDifferentTimezone() {
        if (!differentSelectedTz) return;
        
        const button = document.getElementById('timezoneMismatchUseDifferentBtn');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        }
        
        const confirmedMismatch = differentSelectedTz !== detectedTz;
        
        fetch('/dashboard/update-timezone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'update_selected',
                selected_timezone: differentSelectedTz,
                confirmed_mismatch: confirmedMismatch
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.closeTimezoneMismatchModal();
                setTimeout(() => window.location.reload(), 100);
            } else {
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-check"></i> Use Selected Timezone';
                }
            }
        })
        .catch(error => {
            console.error('[Timezone Mismatch Modal] Error:', error);
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i> Use Selected Timezone';
            }
        });
    }
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('timezoneMismatchModal');
        const closeBtn = document.getElementById('timezoneMismatchModalClose');
        const useDetectedBtn = document.getElementById('timezoneMismatchUseDetectedBtn');
        const useSelectedBtn = document.getElementById('timezoneMismatchUseSelectedBtn');
        const expandToggle = document.getElementById('timezoneMismatchExpandToggle');
        const timeInput = document.getElementById('timezoneMismatchTimeInput');
        const useDifferentBtn = document.getElementById('timezoneMismatchUseDifferentBtn');
        
        // Close button
        if (closeBtn) {
            closeBtn.addEventListener('click', updateToDetectedTimezone);
        }
        
        // Overlay click
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    updateToDetectedTimezone();
                }
            });
        }
        
        // Use detected button
        if (useDetectedBtn) {
            useDetectedBtn.addEventListener('click', updateToDetectedTimezone);
        }
        
        // Use selected button
        if (useSelectedBtn) {
            useSelectedBtn.addEventListener('click', updateSelectedTimezone);
        }
        
        // Expand toggle
        if (expandToggle) {
            expandToggle.addEventListener('click', function() {
                const expandable = document.getElementById('timezoneMismatchExpandable');
                expandable.classList.toggle('expanded');
            });
        }
        
        // Time input
        if (timeInput) {
            timeInput.addEventListener('input', updateTimezoneListFromTime);
            timeInput.addEventListener('change', updateTimezoneListFromTime);
        }
        
        // Use different button
        if (useDifferentBtn) {
            useDifferentBtn.addEventListener('click', updateToDifferentTimezone);
        }
    });
})();
</script>
