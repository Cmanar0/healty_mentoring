<style>
/* Ensure modal overlay is on top of everything */
#standaloneTimezoneModal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 10002 !important;
    background: rgba(15, 23, 42, 0.6) !important;
    backdrop-filter: blur(4px) !important;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

/* Standalone Timezone Correction Modal Styles */
.standalone-tc-modal-standard,
#standaloneTimezoneModal .booking-modal-container {
    max-width: 920px !important;
    height: 600px !important;
    padding: 0 !important;
    overflow: hidden !important;
    background: white !important;
    border-radius: 20px !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
    position: relative !important;
    width: 90% !important;
}
.standalone-tc-grid {
    display: grid;
    grid-template-columns: 360px 1fr;
    height: 100%;
}
.standalone-tc-sidebar {
    background: #f8fafc;
    border-right: 1px solid #e2e8f0;
    padding: 32px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    height: 100%;
    box-sizing: border-box;
}
.standalone-tc-main {
    padding: 40px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
}
.standalone-tc-header {
    margin-bottom: 32px;
}
.standalone-tc-form-body {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.standalone-tc-placeholder-text {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #94a3b8;
    font-size: 0.95rem;
    line-height: 1.5;
    text-align: center;
    padding: 0 20px;
}
.standalone-tc-preview-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: transparent;
    padding: 0;
    border-radius: 0;
    border: none;
    overflow: hidden;
}
.standalone-tc-preview-header {
    font-size: 0.75rem;
    font-weight: 700;
    color: #475569;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.standalone-tc-options-list {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-y: auto;
    padding: 8px;
    margin-right: -4px;
    min-height: 0;
}
.standalone-tc-option-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 0;
    width: 100%;
    box-sizing: border-box;
}
.standalone-tc-option-item:hover {
    border-color: #cbd5e1;
    background: #f8fafc;
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
}
.standalone-tc-option-item.selected {
    background: #eff6ff;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}
.standalone-tc-option-radio {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
    accent-color: #3b82f6;
}
.standalone-tc-option-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}
.standalone-tc-option-name {
    font-size: 0.95rem;
    font-weight: 700;
    color: #1e293b;
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}
.standalone-tc-option-id {
    font-size: 0.75rem;
    color: #64748b;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    word-wrap: break-word;
    overflow-wrap: break-word;
}
.standalone-tc-option-offset {
    font-size: 0.85rem;
    font-weight: 600;
    color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
}
.standalone-tc-modal-standard .standalone-tc-modal-title {
    font-size: 1.75rem;
    color: #1e293b;
    margin-bottom: 8px;
    font-weight: 800;
    letter-spacing: -0.025em;
}
.standalone-tc-time-correction-desc {
    color: #64748b;
    margin-bottom: 28px;
    font-size: 0.95rem;
    line-height: 1.6;
}

/* Dynamic Selection Info Styles */
.standalone-tc-selected-tz-info {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 20px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    margin-top: 24px;
    margin-bottom: 24px;
    transition: all 0.3s ease;
}
.standalone-tc-selected-tz-info.has-selection {
    background: #f0f9ff;
    border-color: #bae6fd;
}
.standalone-tc-selected-tz-icon {
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #3b82f6;
    font-size: 1.25rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.standalone-tc-selected-tz-details {
    flex: 1;
}
.standalone-tc-selected-tz-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
}
.standalone-tc-selected-tz-value {
    font-size: 1rem;
    font-weight: 700;
    color: #1e293b;
}

/* Close button - matching original but with custom class */
.standalone-tc-close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(15, 23, 42, 0.1);
    border: 1px solid rgba(15, 23, 42, 0.1);
    color: #64748b;
    font-size: 1rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 20;
}
.standalone-tc-close-btn:hover {
    background: #ef4444;
    border-color: #ef4444;
    color: white;
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
}

/* Time input styles - matching original but with custom classes */
.standalone-tc-time-input-container {
    display: flex;
    flex-direction: column;
}
.standalone-tc-time-input-label {
    display: block;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 10px;
    font-size: 0.95rem;
}
.standalone-tc-required-asterisk {
    color: #ef4444;
}
.standalone-tc-time-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}
.standalone-tc-modern-time-input {
    width: 100%;
    padding: 14px 16px 14px 44px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
    box-sizing: border-box;
    transition: all 0.2s;
    background: #f8fafc;
}
.standalone-tc-modern-time-input:focus {
    outline: none;
    border-color: #3b82f6;
    background: white;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}
.standalone-tc-modern-time-input:hover {
    border-color: #cbd5e1;
    background: #f1f5f9;
}
.standalone-tc-input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.1rem;
    pointer-events: none;
    z-index: 1;
}
.standalone-tc-time-input-helper {
    font-size: 0.8rem;
    color: #94a3b8;
    margin-top: 8px;
    font-style: italic;
}

/* Detection Status Badges */
.standalone-tc-detection-status {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    margin-top: 16px;
    margin-bottom: 8px;
}
.standalone-tc-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.3s ease;
}
.standalone-tc-status-match {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
}
.standalone-tc-status-mismatch {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
    padding-right: 4px;
}
.standalone-tc-mismatch-text {
    margin-right: 8px;
}
.standalone-tc-btn-update-timezone {
    background: #2563eb;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}
.standalone-tc-btn-update-timezone:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
}
.time-correction-desc {
    font-size: 0.95rem;
    color: #64748b;
    line-height: 1.6;
    margin-top: 8px;
}
.standalone-tc-time-correction-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 8px;
}
.standalone-tc-btn-cancel-correction {
    padding: 12px 24px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    color: #64748b;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.standalone-tc-btn-cancel-correction:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    color: #1e293b;
}
.standalone-tc-btn-confirm-correction {
    padding: 12px 24px;
    background: #3b82f6;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 0.95rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
}
.standalone-tc-btn-confirm-correction:hover:not(:disabled) {
    background: #2563eb;
    box-shadow: 0 6px 10px -1px rgba(59, 130, 246, 0.4);
    transform: translateY(-1px);
}
.standalone-tc-btn-confirm-correction:disabled {
    background: #94a3b8;
    opacity: 0.6;
    cursor: not-allowed;
    box-shadow: none;
}
</style>

<!-- Standalone Timezone Correction Modal -->
<div id="standaloneTimezoneModal" class="booking-modal-overlay" style="display: none; z-index: 10002; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease;">
    <div class="booking-modal-container standalone-tc-modal-standard">
        <button class="standalone-tc-close-btn" onclick="closeStandaloneTimezoneModal()"><i class="fas fa-times"></i></button>
        
        <div class="standalone-tc-grid">
            <!-- Left Column: Matching Results -->
            <div class="standalone-tc-sidebar">
                <div id="standaloneTimezonePreview" class="standalone-tc-preview-section">
                    <div class="standalone-tc-preview-header">
                        <i class="fas fa-search-location"></i>
                        <span>Matching Timezone(s)</span>
                    </div>
                    <div id="standaloneTimezoneList" class="standalone-tc-options-list">
                        <div class="standalone-tc-placeholder-text">
                            Enter your current local time on the right to find matching timezones...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls & Actions -->
            <div class="standalone-tc-main">
                <div class="standalone-tc-header">
                    <h2 class="standalone-tc-modal-title">Correct Your Time</h2>
                    <p class="standalone-tc-time-correction-desc">
                        What time is it for you right now? We'll set your timezone accordingly to ensure your sessions start exactly when you expect.
                    </p>
                </div>
                
                <div class="standalone-tc-form-body">
                    <!-- Time Input -->
                    <div class="standalone-tc-time-input-container">
                        <label class="standalone-tc-time-input-label">
                            What is Your Current Time? <span class="standalone-tc-required-asterisk">*</span>
                        </label>
                        <div class="standalone-tc-time-input-wrapper">
                            <i class="far fa-clock standalone-tc-input-icon"></i>
                            <input 
                                type="time" 
                                id="standaloneCorrectTimeInput" 
                                class="standalone-tc-modern-time-input" 
                                required 
                            >
                        </div>
                        <p class="standalone-tc-time-input-helper">
                            Set this to match your current local time.
                        </p>
                    </div>

                    <!-- Selected Info -->
                    <div id="standaloneSelectedTzInfo" class="standalone-tc-selected-tz-info">
                        <div class="standalone-tc-selected-tz-icon">
                            <i class="fas fa-globe-americas"></i>
                        </div>
                        <div class="standalone-tc-selected-tz-details">
                            <div class="standalone-tc-selected-tz-label">Selected Timezone</div>
                            <div id="standaloneSelectedTzName" class="standalone-tc-selected-tz-value">Please select...</div>
                        </div>
                    </div>

                    <!-- Detection Status -->
                    <div class="standalone-tc-detection-status">
                        <!-- Match State -->
                        <div id="standaloneTimezoneMatchBadge" class="standalone-tc-status-badge standalone-tc-status-match" style="display: none;">
                            <i class="fas fa-check-circle"></i> Matches your location
                        </div>
                        
                        <!-- Mismatch State -->
                        <div id="standaloneTimezoneMismatchBadge" class="standalone-tc-status-badge standalone-tc-status-mismatch" style="display: none;">
                            <span class="standalone-tc-mismatch-text">Detected: <span id="standaloneDetectedTimezoneName"></span></span>
                            <button type="button" id="standaloneUseDetectedTimezoneBtn" class="standalone-tc-btn-update-timezone">
                                Update
                            </button>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="standalone-tc-time-correction-actions">
                        <button 
                            type="button"
                            onclick="closeStandaloneTimezoneModal()"
                            class="standalone-tc-btn-cancel-correction"
                        >
                            Cancel
                        </button>
                        <button 
                            type="button"
                            id="standaloneConfirmTimezoneBtn"
                            onclick="saveStandaloneTimezone()"
                            class="standalone-tc-btn-confirm-correction"
                            disabled
                        >
                            Save Timezone
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let standaloneSelectedTimezone = null;
    let standaloneCurrentTimezone = null;
    let standaloneDetectedTimezone = null;
    let standaloneSaveCallback = null;

    // Helper functions (same as booking modal version)
    if (typeof window.formatTimezoneName !== 'function') {
        window.formatTimezoneName = function(id) {
            try {
                const parts = id.split('/');
                const city = parts[parts.length - 1] || id;
                return city.replace(/_/g, ' ');
            } catch (e) {
                return id;
            }
        }
    }
    
    if (typeof window.deriveRegion !== 'function') {
        window.deriveRegion = function(id) {
            try {
                const parts = id.split('/');
                return parts.length > 1 ? parts[0].replace(/_/g, ' ') : 'Other';
            } catch (e) {
                return 'Other';
            }
        }
    }
    
    if (typeof window.getCurrentTimezoneOffset !== 'function') {
        window.getCurrentTimezoneOffset = function(ianaId) {
            try {
                const now = new Date();
                const formatter = new Intl.DateTimeFormat('en', {
                    timeZone: ianaId,
                    timeZoneName: 'longOffset'
                });
                const parts = formatter.formatToParts(now);
                const offsetPart = parts.find(p => p.type === 'timeZoneName');
                if (offsetPart && offsetPart.value) {
                    const match = offsetPart.value.match(/GMT([+-]\d{1,2})(:?(\d{2}))?/);
                    if (match) {
                        const sign = match[1].startsWith('-') ? '-' : '+';
                        const hours = match[1].replace('+', '').replace('-', '');
                        const minutes = match[3] ? match[3] : '00';
                        return `UTC${sign}${hours.padStart(2, '0')}${minutes !== '00' ? ':' + minutes : ''}`;
                    }
                }
            } catch (e) {
                console.warn('Could not get timezone offset for', ianaId, e);
            }
            return 'UTC+00';
        }
    }
    
    if (typeof window.buildTimezoneList !== 'function') {
        window.buildTimezoneList = function() {
            if (window.TIMEZONE_OPTIONS && window.TIMEZONE_OPTIONS.length) {
                return window.TIMEZONE_OPTIONS.map(tz => ({
                    ...tz,
                    offset: getCurrentTimezoneOffset(tz.id)
                }));
            }
            let ids = [];
            try {
                if (typeof Intl.supportedValuesOf === 'function') {
                    ids = Intl.supportedValuesOf('timeZone');
                }
            } catch (e) {
                console.warn('Intl.supportedValuesOf unavailable', e);
            }
            if (!ids || ids.length === 0) {
                ids = ['UTC', 'America/New_York', 'Europe/London', 'Asia/Tokyo', 'Australia/Sydney'];
            }
            return ids.map(id => ({
                id,
                name: formatTimezoneName(id),
                region: deriveRegion(id),
                offset: getCurrentTimezoneOffset(id)
            }));
        }
    }
    
    if (typeof window.findTimezonesByOffset !== 'function') {
        window.findTimezonesByOffset = function(offsetMinutes) {
            const timezones = buildTimezoneList();
            if (timezones.length === 0) return [];
            
            const now = new Date();
            const matching = [];
            
            timezones.forEach(tz => {
                try {
                    const formatter = new Intl.DateTimeFormat('en', {
                        timeZone: tz.id,
                        timeZoneName: 'longOffset'
                    });
                    const parts = formatter.formatToParts(now);
                    const offsetPart = parts.find(p => p.type === 'timeZoneName');
                    
                    if (offsetPart && offsetPart.value) {
                        const match = offsetPart.value.match(/GMT([+-])(\d{1,2})(:?(\d{2}))?/);
                        if (match) {
                            const sign = match[1] === '+' ? 1 : -1;
                            const hours = parseInt(match[2]) || 0;
                            const minutes = match[4] ? parseInt(match[4]) : 0;
                            const tzOffsetMinutes = sign * (hours * 60 + minutes);
                            
                            if (Math.abs(tzOffsetMinutes - offsetMinutes) < 30) {
                                matching.push(tz);
                            }
                        }
                    }
                } catch (e) {}
            });
            
            matching.sort((a, b) => {
                const nameA = (a.name || a.id).toLowerCase();
                const nameB = (b.name || b.id).toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            return matching;
        }
    }

    // Main modal functions
    window.openStandaloneTimezoneModal = function(currentTimezone, detectedTimezone, callback) {
        const modal = document.getElementById('standaloneTimezoneModal');
        if (!modal) {
            console.error('Standalone timezone modal not found');
            return;
        }
        
        standaloneCurrentTimezone = currentTimezone || null;
        standaloneDetectedTimezone = detectedTimezone || null;
        standaloneSaveCallback = callback || null;
        standaloneSelectedTimezone = null;
        
        // Update detection status badges
        updateStandaloneDetectionStatus();
        
        // Get current time in the provided timezone (or browser default)
        const now = new Date();
        let hours24, minutes;
        
        const tzToUse = currentTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
        
        try {
            const formatter = new Intl.DateTimeFormat('en', {
                timeZone: tzToUse,
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            const parts = formatter.formatToParts(now);
            const hourPart = parts.find(p => p.type === 'hour');
            const minutePart = parts.find(p => p.type === 'minute');
            hours24 = hourPart ? parseInt(hourPart.value) : now.getHours();
            minutes = minutePart ? parseInt(minutePart.value) : now.getMinutes();
        } catch (e) {
            hours24 = now.getHours();
            minutes = now.getMinutes();
        }
        
        const timeInput = document.getElementById('standaloneCorrectTimeInput');
        if (timeInput) {
            timeInput.value = `${String(hours24).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        // Reset UI state
        const confirmBtn = document.getElementById('standaloneConfirmTimezoneBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = 'Save Timezone';
        }
        
        // Reset selection info
        const nameEl = document.getElementById('standaloneSelectedTzName');
        const infoContainer = document.getElementById('standaloneSelectedTzInfo');
        if (nameEl && infoContainer) {
            nameEl.textContent = 'Please select...';
            infoContainer.classList.remove('has-selection');
        }
        
        // Show modal - ensure it's on top
        modal.style.display = 'flex';
        modal.style.zIndex = '10002';
        setTimeout(() => {
            modal.style.opacity = '1';
        }, 10);
        
        // Update preview
        if (timeInput) {
            // Remove existing listeners by cloning
            const oldInput = timeInput;
            const newTimeInput = oldInput.cloneNode(true);
            oldInput.parentNode.replaceChild(newTimeInput, oldInput);
            
            // Add event listeners
            newTimeInput.addEventListener('input', updateStandaloneTimezonePreview);
            newTimeInput.addEventListener('change', updateStandaloneTimezonePreview);
            
            // Trigger preview update
            setTimeout(() => {
                updateStandaloneTimezonePreview();
            }, 200);
        }
    };
    
    window.closeStandaloneTimezoneModal = function() {
        const modal = document.getElementById('standaloneTimezoneModal');
        if (modal) {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 200);
        }
    };
    
    // Update detection status badges
    function updateStandaloneDetectionStatus() {
        const matchBadge = document.getElementById('standaloneTimezoneMatchBadge');
        const mismatchBadge = document.getElementById('standaloneTimezoneMismatchBadge');
        const detectedNameEl = document.getElementById('standaloneDetectedTimezoneName');
        
        // Hide both badges initially
        if (matchBadge) matchBadge.style.display = 'none';
        if (mismatchBadge) mismatchBadge.style.display = 'none';
        
        // Only show if we have both selected and detected timezones
        if (!standaloneSelectedTimezone || !standaloneDetectedTimezone) {
            return;
        }
        
        if (standaloneSelectedTimezone === standaloneDetectedTimezone) {
            // Match
            if (matchBadge) matchBadge.style.display = 'inline-flex';
        } else {
            // Mismatch
            if (mismatchBadge) {
                mismatchBadge.style.display = 'inline-flex';
                if (detectedNameEl) {
                    // Format detected timezone name
                    detectedNameEl.textContent = formatTimezoneName(standaloneDetectedTimezone);
                }
            }
        }
    }
    
    // Handle "Update" button to use detected timezone
    document.addEventListener('DOMContentLoaded', function() {
        const updateBtn = document.getElementById('standaloneUseDetectedTimezoneBtn');
        if (updateBtn) {
            updateBtn.addEventListener('click', function() {
                if (!standaloneDetectedTimezone) return;
                
                // Find the detected timezone in the current list
                const timezones = buildTimezoneList();
                const detectedTz = timezones.find(tz => tz.id === standaloneDetectedTimezone);
                
                if (detectedTz) {
                    // Set as selected
                    standaloneSelectedTimezone = detectedTz.id;
                    
                    // Update UI
                    const nameEl = document.getElementById('standaloneSelectedTzName');
                    const infoContainer = document.getElementById('standaloneSelectedTzInfo');
                    if (nameEl && infoContainer) {
                        nameEl.textContent = detectedTz.name || detectedTz.id;
                        infoContainer.classList.add('has-selection');
                    }
                    
                    // Update radio buttons
                    const radioButtons = document.querySelectorAll('input[name="standaloneTimezoneSelection"]');
                    radioButtons.forEach(radio => {
                        if (radio.value === detectedTz.id) {
                            radio.checked = true;
                            // Update item styling
                            const item = radio.closest('.standalone-tc-option-item');
                            if (item) {
                                document.querySelectorAll('.standalone-tc-option-item').forEach(i => i.classList.remove('selected'));
                                item.classList.add('selected');
                            }
                        }
                    });
                    
                    // Enable save button
                    const confirmBtn = document.getElementById('standaloneConfirmTimezoneBtn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                    }
                    
                    // Update detection status
                    updateStandaloneDetectionStatus();
                }
            });
        }
    });
    
    function updateStandaloneTimezonePreview() {
        const timeInput = document.getElementById('standaloneCorrectTimeInput');
        const tzList = document.getElementById('standaloneTimezoneList');
        const confirmBtn = document.getElementById('standaloneConfirmTimezoneBtn');
        
        if (!timeInput || !tzList || !confirmBtn) {
            return;
        }
        
        const timeValue = timeInput.value;
        
        if (!timeValue) {
            tzList.innerHTML = `<div class="standalone-tc-placeholder-text">Enter your current local time on the right to find matching timezones...</div>`;
            confirmBtn.disabled = true;
            standaloneSelectedTimezone = null;
            return;
        }
        
        // Parse user's entered time
        const [hours24, minutes] = timeValue.split(':').map(Number);
        
        if (isNaN(hours24) || isNaN(minutes)) {
            console.log('Invalid time format:', timeValue);
            return;
        }
        
        // Get current UTC time
        const now = new Date();
        const utcHours = now.getUTCHours();
        const utcMinutes = now.getUTCMinutes();
        
        // Calculate offset in minutes
        const userTimeMinutes = hours24 * 60 + minutes;
        const utcTimeMinutes = utcHours * 60 + utcMinutes;
        let offsetMinutes = userTimeMinutes - utcTimeMinutes;
        
        // Normalize to -12 to +12 hours range
        while (offsetMinutes > 12 * 60) offsetMinutes -= 24 * 60;
        while (offsetMinutes < -12 * 60) offsetMinutes += 24 * 60;
        
        // Find matching timezones
        const matchingTimezones = findTimezonesByOffset(offsetMinutes);
        
        if (matchingTimezones.length > 0) {
            tzList.innerHTML = '';
            confirmBtn.innerHTML = 'Save Timezone';
            
            // Find preselected index
            let preselectedIndex = 0;
            if (standaloneCurrentTimezone) {
                const foundIndex = matchingTimezones.findIndex(tz => tz.id === standaloneCurrentTimezone);
                if (foundIndex !== -1) {
                    preselectedIndex = foundIndex;
                }
            }
            
            // Show timezone options
            matchingTimezones.forEach((tz, index) => {
                const isSelected = index === preselectedIndex;
                const tzItem = document.createElement('div');
                tzItem.className = 'standalone-tc-option-item' + (isSelected ? ' selected' : '');
                tzItem.innerHTML = `
                    <input type="radio" name="standaloneTimezoneSelection" value="${tz.id}" id="standaloneTcOption${index}" ${isSelected ? 'checked' : ''} class="standalone-tc-option-radio">
                    <div class="standalone-tc-option-content">
                        <div class="standalone-tc-option-name">${tz.name || tz.id}</div>
                        <div class="standalone-tc-option-id">${tz.id}</div>
                    </div>
                    <div class="standalone-tc-option-offset">${tz.offset || ''}</div>
                `;
                
                // Add click handler
                tzItem.addEventListener('click', function(e) {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        // Update all items styling
                        tzList.querySelectorAll('.standalone-tc-option-item').forEach(item => {
                            if (item.querySelector('input[type="radio"]:checked')) {
                                item.classList.add('selected');
                            } else {
                                item.classList.remove('selected');
                            }
                        });
                        standaloneSelectedTimezone = radio.value;
                        confirmBtn.innerHTML = 'Save Timezone';
                        
                        // Update dynamic selection info
                        const nameEl = document.getElementById('standaloneSelectedTzName');
                        const infoContainer = document.getElementById('standaloneSelectedTzInfo');
                        if (nameEl && infoContainer) {
                            nameEl.textContent = tz.name || tz.id;
                            infoContainer.classList.add('has-selection');
                        }
                        
                        // Update detection status
                        updateStandaloneDetectionStatus();
                    }
                });
                
                // Set initial selected
                if (isSelected) {
                    standaloneSelectedTimezone = tz.id;
                    const nameEl = document.getElementById('standaloneSelectedTzName');
                    const infoContainer = document.getElementById('standaloneSelectedTzInfo');
                    if (nameEl && infoContainer) {
                        nameEl.textContent = tz.name || tz.id;
                        infoContainer.classList.add('has-selection');
                    }
                    // Update detection status when timezone is selected
                    updateStandaloneDetectionStatus();
                }
                
                tzList.appendChild(tzItem);
            });
            
            // Scroll to preselected
            if (preselectedIndex >= 0 && preselectedIndex < matchingTimezones.length) {
                const selectedItem = tzList.children[preselectedIndex];
                if (selectedItem) {
                    setTimeout(() => {
                        selectedItem.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center',
                            inline: 'nearest'
                        });
                    }, 100);
                }
            }
            
            confirmBtn.disabled = false;
        } else {
            tzList.innerHTML = `<div class="standalone-tc-placeholder-text">No matching timezones found for this time. Try adjusting the minutes.</div>`;
            confirmBtn.disabled = true;
            standaloneSelectedTimezone = null;
            
            // Reset selection info
            const nameEl = document.getElementById('standaloneSelectedTzName');
            const infoContainer = document.getElementById('standaloneSelectedTzInfo');
            if (nameEl && infoContainer) {
                nameEl.textContent = 'Please select...';
                infoContainer.classList.remove('has-selection');
            }
        }
    }
    
    window.saveStandaloneTimezone = function() {
        const confirmBtn = document.getElementById('standaloneConfirmTimezoneBtn');
        
        if (!standaloneSelectedTimezone) {
            alert('Please select a timezone from the list');
            return;
        }
        
        // Disable button
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        }
        
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Save to database
        fetch('/dashboard/update-timezone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                action: 'update_selected',
                selected_timezone: standaloneSelectedTimezone,
                confirmed_mismatch: false
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                closeStandaloneTimezoneModal();
                
                // Call callback if provided
                if (standaloneSaveCallback && typeof standaloneSaveCallback === 'function') {
                    standaloneSaveCallback(standaloneSelectedTimezone);
                }
                
                // Reload page to show updated timezone
                setTimeout(() => {
                    window.location.reload();
                }, 300);
            } else {
                alert('Error saving timezone: ' + (data.error || 'Unknown error'));
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Save Timezone';
                }
            }
        })
        .catch(error => {
            console.error('Error saving timezone:', error);
            alert('Error saving timezone. Please try again.');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Save Timezone';
            }
        });
    };
    
    // Handle ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('standaloneTimezoneModal');
            if (modal && window.getComputedStyle(modal).display !== 'none') {
                closeStandaloneTimezoneModal();
            }
        }
    });
})();
</script>

